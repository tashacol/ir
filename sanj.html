<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استعلام گواهی</title>
    <!-- Excel Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        /* ========== Fonts & Variables ========== */
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');

        :root {
            --primary-color: #0d6efd;
            --primary-light: #e7f1ff;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --card-bg-color: #ffffff;
            --text-color: #212529;
            --border-color: #dee2e6;
            --shadow: 0 8px 25px rgba(0, 0, 0, 0.07);
        }

        /* ========== Global Styles ========== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            direction: rtl;
            background-color: var(--background-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        /* ========== Main Container ========== */
        .main-container {
            width: 100%;
            max-width: 450px;
            background-color: var(--card-bg-color);
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: all 0.4s ease-in-out;
        }

        /* ========== Search Section ========== */
        .search-container {
            padding: 30px;
            text-align: center;
        }

        .search-container h1 {
            font-size: 1.7rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 10px;
        }

        .search-container p {
            font-size: 0.95rem;
            color: var(--secondary-color);
            margin-bottom: 25px;
        }

        #nationalIdInput {
            width: 100%;
            padding: 15px;
            font-size: 1rem;
            font-family: 'Vazirmatn', sans-serif;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            text-align: center;
            letter-spacing: 2px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        #nationalIdInput:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        #searchButton {
            width: 100%;
            padding: 15px;
            margin-top: 15px;
            font-size: 1.1rem;
            font-weight: 500;
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            position: relative; /* Needed for the loader */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 54px; /* Fixed height for consistency */
        }
        
        #searchButton:hover:not(:disabled) {
            background-color: #0b5ed7;
            transform: translateY(-2px);
        }

        #searchButton:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }

        /* ========== Button Loader ========== */
        .btn-loader {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.4);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none; /* Hidden by default */
        }

        #searchButton.loading .btn-text {
            display: none;
        }

        #searchButton.loading .btn-loader {
            display: block;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        /* ========== Error Message ========== */
        #errorMsg {
            color: #dc3545;
            font-size: 0.9rem;
            margin-top: 15px;
            display: none;
            min-height: 20px;
        }

        /* ========== Result Section ========== */
        .result-container {
            padding: 30px;
            display: none; /* Initially hidden */
        }
        
        .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-icon {
            width: 80px;
            height: 80px;
            background-color: var(--primary-light);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto 15px auto;
        }
        
        .profile-icon svg {
            width: 40px;
            height: 40px;
            color: var(--primary-color);
        }

        .profile-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-color);
        }
        
        .profile-subtext {
            font-size: 1rem;
            color: var(--secondary-color);
        }

        .info-grid {
            display: grid;
            gap: 15px;
        }

        .info-item {
            display: flex;
            align-items: center;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .info-item .icon {
            color: var(--primary-color);
            margin-left: 15px;
            flex-shrink: 0;
        }
        
        .info-item .icon svg {
            width: 24px;
            height: 24px;
        }
        
        .info-item .text-content .label {
            font-size: 0.85rem;
            color: var(--secondary-color);
            display: block;
        }

        .info-item .text-content .value {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-color);
        }

    </style>
</head>
<body>

    <div class="main-container">

        <!-- Search Form -->
        <div class="search-container" id="search-container">
            <h1>استعلام گواهی</h1>
            <p>برای مشاهده اطلاعات دوره، کد ملی خود را وارد کنید.</p>
            <input type="tel" id="nationalIdInput" placeholder="کد ملی خود را وارد کنید" maxlength="10" />
            <button id="searchButton">
                <span class="btn-text">استعلام</span>
                <div class="btn-loader"></div>
            </button>
            <div id="errorMsg"></div>
        </div>

        <!-- Result Display -->
        <div class="result-container" id="result-container">
            <div class="profile-header">
                <div class="profile-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4.176 9.032a.5.5 0 0 1 .292.643l-1.5 4A.5.5 0 0 1 2.5 14H2a.5.5 0 0 1 0-1h.5a.5.5 0 0 1 .455-.274L3.553 9.5H2a.5.5 0 0 1 0-1h1.5a.5.5 0 0 1 .176.032Z"/>
                        <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/>
                        <path d="M2.5 8.5a.5.5 0 0 1 0-1H1v-1h1.5a.5.5 0 0 1 0 1H1v1z"/>
                    </svg>
                </div>
                <h2 id="profileName" class="profile-name"></h2>
                <p id="profileNationalId" class="profile-subtext"></p>
            </div>

            <div class="info-grid">
                <div class="info-item">
                    <div class="icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M10.854 7.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 9.793l2.646-2.647a.5.5 0 0 1 .708 0z"/><path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4z"/></svg>
                    </div>
                    <div class="text-content">
                        <span class="label">نام دوره</span>
                        <span id="courseName" class="value"></span>
                    </div>
                </div>
                <div class="info-item">
                    <div class="icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4M1 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/></svg>
                    </div>
                    <div class="text-content">
                        <span class="label">شناسه دوره</span>
                        <span id="courseId" class="value"></span>
                    </div>
                </div>
                <div class="info-item">
                    <div class="icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M4 .5a.5.5 0 0 0-1 0V1H2a2 2 0 0 0-2 2v1h16V3a2 2 0 0 0-2-2h-1V.5a.5.5 0 0 0-1 0V1H4zM16 14V5H0v9a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2m-3.5-7h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5"/></svg>
                    </div>
                    <div class="text-content">
                        <span class="label">تاریخ شروع</span>
                        <span id="startDate" class="value"></span>
                    </div>
                </div>
                <div class="info-item">
                    <div class="icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M10.854 7.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 9.793l2.646-2.647a.5.5 0 0 1 .708 0"/><path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5M1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4z"/></svg>
                    </div>
                    <div class="text-content">
                        <span class="label">تاریخ اتمام</span>
                        <span id="endDate" class="value"></span>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- DOM Elements ---
        const searchContainer = document.getElementById('search-container');
        const resultContainer = document.getElementById('result-container');
        const input = document.getElementById('nationalIdInput');
        const btn = document.getElementById('searchButton');
        const errorMsg = document.getElementById('errorMsg');

        // --- Result Fields ---
        const profileName = document.getElementById('profileName');
        const profileNationalId = document.getElementById('profileNationalId');
        const courseName = document.getElementById('courseName');
        const courseId = document.getElementById('courseId');
        const startDate = document.getElementById('startDate');
        const endDate = document.getElementById('endDate');

        // --- Config ---
        const url = 'https://docs.google.com/spreadsheets/d/1c0g7deSI0y-QP4nQNux-l07_cumu3A6Gy0OolnhZWdU/export?format=xlsx';
        let excelData = null; // To cache data after first successful fetch

        // --- Functions ---
        const showLoader = (isLoading) => {
            btn.disabled = isLoading;
            btn.classList.toggle('loading', isLoading);
        };
        
        const showError = (message) => {
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
        };

        const hideError = () => {
            errorMsg.style.display = 'none';
        };

        const displayResults = (row) => {
            // --- Column Mapping (Assumed) ---
            // A -> 0: نام کامل
            // B -> 1: نام دوره
            // C -> 2: شناسه دوره
            // D -> 3: تاریخ شروع
            // E -> 4: کد ملی
            // F -> 5: تاریخ اتمام
            profileName.textContent = row[0] || 'نامشخص';
            profileNationalId.textContent = `کد ملی: ${input.value}`;
            courseName.textContent = row[1] || 'نامشخص';
            courseId.textContent = row[2] || 'نامشخص';
            startDate.textContent = row[3] || 'نامشخص';
            endDate.textContent = row[5] || 'نامشخص'; // Assuming End Date is in Column F

            searchContainer.style.display = 'none';
            resultContainer.style.display = 'block';
        };

        const handleSearch = async () => {
            hideError();
            const nationalId = input.value.trim();

            // 1. Validation
            if (!nationalId) {
                showError('لطفا کد ملی خود را وارد کنید.');
                return;
            }
            if (!/^\d{10}$/.test(nationalId)) {
                showError('کد ملی باید یک عدد ۱۰ رقمی باشد.');
                return;
            }
            
            showLoader(true);

            try {
                // 2. Fetch data if not already cached
                if (!excelData) {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Network response was not ok.');
                    const buffer = await response.arrayBuffer();
                    const workbook = XLSX.read(buffer, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    excelData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                }

                // 3. Search for the user
                // Normalize search term (remove leading zero)
                let searchTerm = nationalId.startsWith('0') ? nationalId.substring(1) : nationalId;
                
                let foundRow = null;
                for (const row of excelData) {
                    // Column E for National ID is at index 4
                    let cellValue = row[4] ? String(row[4]).trim() : '';
                    
                    // Normalize cell value (remove leading zero)
                    let normalizedCellValue = cellValue.startsWith('0') ? cellValue.substring(1) : cellValue;

                    if (normalizedCellValue === searchTerm) {
                        foundRow = row;
                        break;
                    }
                }

                // 4. Display result or error
                if (foundRow) {
                    displayResults(foundRow);
                } else {
                    showError('اطلاعاتی با این کد ملی یافت نشد.');
                }

            } catch (err) {
                console.error("Error during search:", err);
                showError('خطا در ارتباط با سرور. لطفا اتصال اینترنت خود را بررسی کنید.');
                excelData = null; // Clear cache on error to allow retry
            } finally {
                showLoader(false);
            }
        };

        // --- Event Listeners ---
        btn.addEventListener('click', handleSearch);

        input.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent form submission if it's inside a form
                btn.click();
            }
        });
        
        // Allow only numbers in input
        input.addEventListener('input', () => {
            input.value = input.value.replace(/[^0-9]/g, '');
        });

    </script>
</body>
</html>
