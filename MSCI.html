<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل مدیریت نشریه</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700;800&display=swap');
        
        :root {
            --primary: #1e3a8a;
            --primary-light: #dbeafe; 
            --primary-dark: #172554;
            --secondary: #334155;
            --secondary-light: #f1f5f9;
            --accent: #ca8a04;
            --text-dark: #0f172a; 
            --text-light: #64748b; 
            --bg-main: #e2e8f0;
            --bg-card: #ffffff; 
            --border-color: #cbd5e1; 
            --success: #15803d;
            --danger: #b91c1c; 
            --warning: #b45309; 
            --info: #0369a1;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            --radius-lg: 8px;
            --radius-md: 6px; 
            --transition: 0.3s ease;
        }
        
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--bg-main); color: var(--text-dark); margin: 0; font-size: 14.5px; overflow-x: hidden; line-height: 1.7; }
        .hidden { display: none !important; }
        
        .card { background: var(--bg-card); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); margin-bottom: 25px; overflow: hidden; }
        .card-header { padding: 18px 25px; border-bottom: 2px solid var(--primary); background: var(--secondary-light); display: flex; justify-content: space-between; align-items: center; }
        .card-header h3 { margin: 0; color: var(--primary-dark); font-size: 1.15rem; }
        .card-body { padding: 25px; }
        
        h1,h2,h3,h4 { font-weight: 800; margin: 0 0 16px 0; color: var(--primary-dark); letter-spacing: -0.5px; }
        h1 { font-size: 1.6rem; padding-bottom: 10px; border-bottom: 2px solid var(--border-color); margin-bottom: 25px; } 
        h2 { font-size: 1.4rem; } 
        h3 { font-size: 1.2rem; }
        
        input, select, textarea {
            width: 100%; box-sizing: border-box; padding: 12px 15px; border: 1px solid var(--border-color);
            border-radius: var(--radius-md); font-size: 0.95rem; font-family: inherit; transition: var(--transition); background-color: #f8fafc; color: var(--text-dark);
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: none; background-color: #fff; box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1); }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--secondary); font-size: 0.9rem; }
        .form-group { margin-bottom: 1.5rem; }
        
        button {
            font-family: inherit; padding: 10px 20px; border: none; border-radius: var(--radius-md); font-size: 0.95rem; font-weight: 600;
            cursor: pointer; transition: var(--transition); display: inline-flex; align-items: center; justify-content: center; gap: 8px; position: relative; background-color: var(--primary); color: white; text-decoration: none;
        }
        button:hover:not(:disabled) { background-color: var(--primary-dark); transform: translateY(-1px); box-shadow: var(--shadow-sm); }
        button:disabled { background-color: #cbd5e1; cursor: not-allowed; transform: none; box-shadow: none; color: #94a3b8; }
        .btn-success { background-color: var(--success); } .btn-success:hover { background-color: #166534; }
        .btn-danger { background-color: var(--danger); } .btn-danger:hover { background-color: #991b1b; }
        .btn-warning { background-color: var(--warning); } .btn-warning:hover { background-color: #92400e; }
        .btn-secondary { background-color: var(--secondary); } .btn-secondary:hover { background-color: #1e293b; }
        .btn-light { background-color: #f8fafc; color: var(--secondary); border: 1px solid var(--border-color); } .btn-light:hover { background-color: #e2e8f0; color: var(--primary-dark); }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
        
        .btn-loading { color: transparent !important; pointer-events: none; }
        .btn-loading .btn-text, .btn-loading .fas, .btn-loading .fa-solid { opacity: 0; }
        .btn-loading::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.5); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        
        #main-app { display: flex; min-height: 100vh; flex-direction: row; }
        #sidebar { width: 260px; background: var(--primary-dark); color: white; display: flex; flex-direction: column; flex-shrink: 0; z-index: 50; transition: var(--transition); box-shadow: var(--shadow); }
        #sidebar-header { padding: 25px 20px; background: rgba(0,0,0,0.2); text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        #sidebar-header h2 { color: white; margin: 0; font-size: 1.3rem; }
        #main-nav { flex-grow: 1; padding: 15px 0; overflow-y: auto; }
        #main-nav button { background: transparent; width: 100%; justify-content: flex-start; padding: 15px 25px; margin: 0; color: #cbd5e1; font-size: 0.95rem; border-radius: 0; border-right: 4px solid transparent; transition: var(--transition); font-weight: 500; }
        #main-nav button:hover { background: rgba(255,255,255,0.05); color: white; }
        #main-nav button.active { background: rgba(255,255,255,0.1); color: white; border-right-color: var(--accent); font-weight: 700; }
        #main-nav button i { width: 25px; text-align: center; font-size: 1.1rem; }
        
        /* طراحی جدید: نوار بالایی و محتوای اصلی */
        #main-wrapper { flex-grow: 1; display: flex; flex-direction: column; width: calc(100% - 260px); }
        #top-bar { display: flex; justify-content: flex-end; align-items: center; padding: 15px 35px; background: var(--bg-card); border-bottom: 1px solid var(--border-color); box-shadow: var(--shadow-sm); z-index: 40; }
        
        /* منوی کاربری (دستور 3) */
        .user-menu-container { position: relative; }
        #user-menu-btn { background: var(--secondary-light); color: var(--primary-dark); border: 1px solid var(--border-color); padding: 8px 20px; border-radius: 20px; font-weight: 700; box-shadow: none; }
        #user-menu-btn:hover { background: #e2e8f0; }
        #user-dropdown { position: absolute; top: calc(100% + 10px); left: 0; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); min-width: 200px; display: flex; flex-direction: column; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: var(--transition); z-index: 1000; overflow: hidden; }
        #user-dropdown.show { opacity: 1; visibility: visible; transform: translateY(0); }
        #user-dropdown button { background: none; border-radius: 0; color: var(--secondary); justify-content: flex-start; padding: 12px 20px; border-bottom: 1px solid var(--secondary-light); }
        #user-dropdown button:hover { background: var(--secondary-light); color: var(--primary-dark); padding-right: 25px; }
        #user-dropdown button.text-danger { color: var(--danger); border-bottom: none; }
        #user-dropdown button.text-danger:hover { background: #fee2e2; color: #991b1b; }

        #main-content { padding: 35px; overflow-y: auto; flex-grow: 1; }
        
        .loader-wrapper { display: flex; justify-content: center; align-items: center; padding: 60px; flex-direction: column; gap: 15px; }
        .loader { width: 50px; height: 50px; border: 4px solid var(--border-color); border-bottom-color: var(--primary); border-radius: 50%; display: inline-block; box-sizing: border-box; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .table-wrapper { overflow-x: auto; width: 100%; border: 1px solid var(--border-color); border-radius: var(--radius-md); }
        table { width: 100%; border-collapse: collapse; min-width: 700px; background: #fff; }
        th, td { padding: 15px 18px; text-align: right; border-bottom: 1px solid var(--border-color); vertical-align: middle; font-size: 0.95rem; }
        th { background: #f8fafc; font-weight: 700; color: var(--secondary); white-space: nowrap; border-bottom: 2px solid var(--border-color); }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f1f5f9; }
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; display: inline-block; letter-spacing: 0.5px; box-shadow: var(--shadow-sm); }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.75); z-index: 1000; display: flex; align-items: flex-start; justify-content: center; padding: 5vh 20px; backdrop-filter: blur(4px); animation: fadeIn 0.3s; overflow-y: auto; }
        .modal-box { background: var(--bg-card); border-radius: var(--radius-lg); width: 100%; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; margin: auto; animation: zoomIn 0.3s; border: 1px solid var(--border-color); }
        .modal-lg { max-width: 950px; } .modal-md { max-width: 650px; }
        .modal-header { padding: 20px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); background: #f8fafc; border-radius: var(--radius-lg) var(--radius-lg) 0 0; }
        .modal-header h3 { margin: 0; color: var(--primary-dark); }
        .modal-body { overflow-y: auto; flex-grow: 1; padding: 30px 25px; }
        .modal-footer { padding: 20px 25px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px; background: #f8fafc; border-radius: 0 0 var(--radius-lg) var(--radius-lg); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.95); } to { transform: scale(1); } }

        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .stat-card { padding: 25px; text-align: center; border-right: 5px solid var(--primary); background: #fff; display: flex; flex-direction: column; justify-content: center; margin-bottom: 0; }
        .stat-card h4 { color: var(--secondary); font-size: 1.05rem; margin-bottom: 15px; }
        .stat-card .count { font-size: 2.8rem; font-weight: 800; color: var(--text-dark); margin: 0; line-height: 1; }
        
        .tab-nav { display:flex; border-bottom: 2px solid var(--border-color); margin-bottom: 25px; overflow-x: auto; scrollbar-width: thin; scrollbar-color: var(--border-color) transparent; padding-bottom: 2px; }
        .tab-nav::-webkit-scrollbar { height: 6px; display: block; }
        .tab-nav::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        .tab-nav button { background: none; color: var(--text-light); border-radius: 0; padding: 12px 25px; border-bottom: 3px solid transparent; white-space: nowrap; font-size: 1rem; margin-bottom: -2px; }
        .tab-nav button:hover { color: var(--primary); background: rgba(0,0,0,0.02); }
        .tab-nav button.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 800; background: #fff; }
        
        #toast-container { position: fixed; bottom: 25px; left: 25px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background-color: var(--secondary); color: white; padding: 16px 24px; border-radius: var(--radius-md); box-shadow: var(--shadow-lg); opacity: 0; transform: translateY(20px); animation: toast-in 0.4s forwards; font-weight: 500; min-width: 300px; display: flex; align-items: center; gap: 12px; }
        .toast.success { background-color: var(--success); border-right: 4px solid #064e3b; }
        .toast.error { background-color: var(--danger); border-right: 4px solid #7f1d1d; }
        .toast.info { background-color: var(--info); border-right: 4px solid #0c4a6e; }
        @keyframes toast-in { to { opacity: 1; transform: translateY(0); } }

        #article-modal-tabs { display: flex; border-bottom: 1px solid var(--border-color); overflow-x: auto; background: #f8fafc; border-radius: var(--radius-md) var(--radius-md) 0 0; }
        #article-modal-tabs button { background: none; color: var(--secondary); border: none; padding: 15px 25px; cursor: pointer; border-bottom: 3px solid transparent; white-space: nowrap; font-weight: 600; }
        #article-modal-tabs button:hover { background: #e2e8f0; }
        #article-modal-tabs button.active { color: var(--primary); border-bottom-color: var(--primary); background: #fff; }
        .tab-content { padding-top: 25px; }
        
        .history-timeline { list-style: none; padding: 0; margin: 0; }
        .timeline-item { display: flex; gap: 20px; padding: 15px 0; border-bottom: 1px dashed var(--border-color); }
        .timeline-item:last-child { border-bottom: none; }
        .timeline-icon { flex-shrink: 0; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .timeline-content { flex-grow: 1; }
        .timeline-header { display: flex; justify-content: space-between; font-weight: 800; margin-bottom: 8px; align-items: center; flex-wrap: wrap; color: var(--secondary); }
        .timeline-details { font-size: 0.95rem; color: var(--text-light); word-break: break-word; line-height: 1.8; background: #f8fafc; padding: 10px 15px; border-radius: var(--radius-md); margin-top: 8px !important; border: 1px solid #e2e8f0; }
        
        .issue-list-item { display: flex; justify-content: space-between; align-items: center; padding: 18px; border: 1px solid var(--border-color); border-radius: var(--radius-md); margin-bottom: 12px; background: #fff; flex-wrap: wrap; gap: 15px; box-shadow: var(--shadow-sm); }
        .issue-list-item button { background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 5px; box-shadow: none; }
        .issue-list-item button.delete-btn { color: var(--danger); } .issue-list-item button.delete-btn:hover { color: #7f1d1d; background: #fee2e2; }
        .issue-list-item button.view-btn { color: var(--info); margin-left: 10px; } .issue-list-item button.view-btn:hover { color: #0c4a6e; background: #e0f2fe; }
        .issue-list-item button:disabled { color: #cbd5e1; cursor: not-allowed; background: none; }
        
        #drop-area { border: 2px dashed var(--primary); border-radius: var(--radius-lg); padding: 40px; text-align: center; color: var(--secondary); cursor: pointer; background: #f8fafc; transition: var(--transition); }
        #drop-area:hover, #drop-area.highlight { background-color: var(--primary-light); border-color: var(--primary-dark); }
        #file-info { margin-top: 15px; font-weight: 700; color: var(--primary-dark); text-align: center; }
        
        .content-accordion details { border: 1px solid var(--border-color); margin-bottom: 12px; border-radius: var(--radius-md); overflow: hidden; background: #fff; }
        .content-accordion summary { background: var(--secondary-light); padding: 16px 20px; cursor: pointer; list-style: none; font-weight: 800; color: var(--secondary); transition: background 0.2s; }
        .content-accordion summary:hover { background: #e2e8f0; color: var(--primary-dark); }
        .content-accordion summary::-webkit-details-marker { display:none; }
        .content-accordion .content-panel { padding: 25px; white-space: pre-wrap; line-height: 2.2; font-size: 1rem; border-top: 1px solid var(--border-color); color: var(--text-dark); text-align: justify; }

        .category-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: #fff; border: 1px solid var(--border-color); border-radius: var(--radius-md); margin-bottom: 10px; box-shadow: var(--shadow-sm); transition: var(--transition); }
        .category-item:hover { border-color: var(--primary); box-shadow: var(--shadow); }
        .category-item-text { font-weight: 600; font-size: 1.05rem; color: var(--secondary); }
        .category-actions button { padding: 8px 12px; margin-right: 5px; }

        /* اصلاح ریشه‌ای فواصل و درهم‌رفتگی متون در PDF (دستور 6) */
        #pdf-render-container { padding: 25mm 20mm; } /* دستور 5: فاصله بالا و پایین استاندارد */
        #pdf-render-container * { 
            letter-spacing: normal !important; 
            word-spacing: normal !important; 
            text-align: right !important; /* جلوگیری از جاستیفای که باعث پارگی کلمات در html2canvas می‌شود */
            text-justify: none !important;
            font-family: 'Vazirmatn', sans-serif !important;
        }

        @media (max-width: 992px) {
            #main-app { flex-direction: column; }
            #sidebar { width: 100%; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); z-index: 100; position: sticky; top: 0; }
            #sidebar-header { display: none; }
            
            #main-nav { display: flex; flex-direction: row; gap: 0; overflow-x: auto; white-space: nowrap; padding: 0; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.3) transparent; padding-bottom: 4px; }
            #main-nav::-webkit-scrollbar { height: 4px; display: block; }
            #main-nav::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }
            
            #main-nav button { width: auto; padding: 15px 20px; border-right: none; border-bottom: 4px solid transparent; flex-shrink: 0; }
            #main-nav button.active { border-right: none; border-bottom-color: var(--accent); background: rgba(255,255,255,0.1); }
            
            #main-wrapper { width: 100%; }
            #top-bar { padding: 15px; }
            #main-content { padding: 20px 15px; }
            
            .stat-grid { grid-template-columns: 1fr 1fr; gap: 15px; }
            .card-header { padding: 15px; flex-direction: column; gap: 10px; align-items: flex-start; }
            .card-body { padding: 15px; }
            
            .modal-overlay { padding: 2vh 10px; }
            .modal-box { margin: auto; }
            .modal-header, .modal-footer { padding: 15px; }
            .modal-body { padding: 15px; }
            
            .table-wrapper { border: none; box-shadow: none; }
            .pub-grid { grid-template-columns: 1fr !important; }
        }
        
        @media (max-width: 576px) {
            .stat-grid { grid-template-columns: 1fr; }
            h1 { font-size: 1.35rem; }
            .tab-nav button { padding: 10px 15px; font-size: 0.9rem; }
            .timeline-item { flex-direction: column; gap: 10px; }
            .timeline-icon { width: 35px; height: 35px; font-size: 1rem; }
        }
    </style>
</head>
<body>

<div id="login-page">
    <div class="card" style="max-width: 420px; margin: 8vh auto; border-top: 5px solid var(--primary); box-shadow: var(--shadow-lg);">
        <div class="card-body" style="padding: 40px 30px;">
            <div style="text-align:center; margin-bottom: 2.5rem;">
                <div style="width: 80px; height: 80px; background: var(--primary-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                    <i class="fas fa-shield-alt fa-3x" style="color: var(--primary);"></i>
                </div>
                <h2 style="color: var(--primary-dark); margin-bottom: 5px;">پورتال مدیریت نشریه</h2>
                <p style="color: var(--text-light); font-size: 0.95rem;">جهت دسترسی، اطلاعات کاربری خود را وارد نمایید</p>
            </div>
            <form id="login-form">
                <div class="form-group"><label for="username">شناسه کاربری</label><input type="text" id="username" dir="ltr" style="text-align: left;" required></div>
                <div class="form-group"><label for="password">گذرواژه</label><input type="password" id="password" dir="ltr" style="text-align: left;" required></div>
                <button type="submit" id="login-btn" style="width: 100%; padding: 14px; font-size: 1.05rem; margin-top: 10px;"><span class="btn-text">ورود به پنل کاربری</span></button>
                <p id="login-error" style="color:var(--danger); text-align: center; height: 1em; margin-top: 1.5em; font-weight: 600;"></p>
            </form>
        </div>
    </div>
</div>

<div id="main-app" class="hidden">
    <aside id="sidebar">
        <div id="sidebar-header">
            <h2><i class="fas fa-landmark"></i> تعالی نوجوان</h2>
            <div style="font-size: 0.8rem; color: #cbd5e1; margin-top: 5px;">پنل مدیریت ارشد</div>
        </div>
        <nav id="main-nav">
            <button data-view="dashboard" class="active"><i class="fas fa-tachometer-alt fa-fw"></i><span class="nav-text"> داشبورد</span></button>
            <button data-view="articles"><i class="fas fa-file-signature fa-fw"></i><span class="nav-text"> مدیریت مقالات</span></button>
            <button data-view="categories"><i class="fas fa-tags fa-fw"></i><span class="nav-text"> حوزه‌های پژوهش</span></button>
            <button data-view="publications"><i class="fas fa-newspaper fa-fw"></i><span class="nav-text"> امور انتشارات</span></button>
            <button data-view="users"><i class="fas fa-users-cog fa-fw"></i><span class="nav-text"> مدیریت کاربران</span></button>
            <button data-view="logs"><i class="fas fa-clipboard-list fa-fw"></i><span class="nav-text"> گزارش وقایع</span></button>
        </nav>
    </aside>
    
    <!-- دربرگیرنده جدید برای نوار بالایی و محتوا (دستور 3) -->
    <div id="main-wrapper">
        <header id="top-bar">
            <div class="user-menu-container">
                <button id="user-menu-btn">
                    <i class="fas fa-user-shield"></i> <span id="display-admin-name">مدیر سیستم</span> <i class="fas fa-angle-down" style="font-size:0.8rem; margin-right:5px;"></i>
                </button>
                <div id="user-dropdown">
                    <button onclick="showChangePasswordModal()"><i class="fas fa-key fa-fw"></i> تغییر رمز عبور</button>
                    <button class="text-danger" onclick="handleLogout()"><i class="fas fa-power-off fa-fw"></i> خروج از سیستم</button>
                </div>
            </div>
        </header>
        
        <main id="main-content"><!-- Views will be rendered here --></main>
    </div>
</div>

<div id="modal-container"></div>
<div id="toast-container"></div>

<!-- لایه تمام‌صفحه برای جلوگیری از هنگ و اطلاع‌رسانی حین ساخت PDF (دستور 1) -->
<div id="download-overlay" class="hidden" style="position:fixed;inset:0;background:rgba(15,23,42,0.85);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;color:white;backdrop-filter:blur(5px);">
    <div class="loader" style="border-color:rgba(255,255,255,0.2); border-bottom-color:#fff; width:65px; height:65px; border-width:5px; margin-bottom:25px;"></div>
    <h2 style="color:white; margin:0; font-size:1.5rem;">در حال آماده‌سازی و دانلود فایل PDF...</h2>
    <p style="color:#cbd5e1; margin-top:15px; font-size:1.05rem;">لطفا چند لحظه منتظر بمانید (فرآیند ساخت سند ممکن است صفحه را متوقف کند)</p>
</div>

<!-- کانتینر مخفی برای رندر کردن محتوای PDF -->
<div id="pdf-render-container" style="position: fixed; left: -9999px; top: -9999px; background: white; color: black; font-family: 'Vazirmatn', sans-serif; direction: rtl; width: 210mm; box-sizing: border-box;"></div>

<script>
    // ==========================================================
    // == پنل مدیریت نشریه - JavaScript (نسخه نهایی و کاملاً پایدار)
    // ==========================================================

    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxqsfCE7G7gbMANi-CqxBlIVPQHzIZt54IDQAY-f3PhC46kt5kBvLo1bpp4Xk3KscASvg/exec'; 

    const appState = {
        currentUser: null,
        isDataLoaded: false,
        isLoadingData: false,
        pendingView: null,
        data: { articles: [], users: {researchers:[], professors:[]}, publications: {issues:[], readyArticles:[]}, logs: [], categories: [] }
    };
    
    const articlesLimits = { '6': 10, '5': 10, '10': 10, 'other': 10 };
    let currentArticlesList = [];
    let visiblePastIssuesCount = 10;
    
    let visibleLogsCount = 20;
    let currentLogsList = [];
    
    // متغیرهای تاریخچه درون مودال مقاله (دستور 1 بخش تاریخچه)
    let currentModalHistoryList = [];
    let visibleModalHistoryCount = 20;

    const LOG_ACTIONS = {
        'LOGIN_SUCCESS': { title: 'ورود موفق', icon: 'fa-right-to-bracket', color: 'var(--success)' },
        'LOGIN_FAIL': { title: 'ورود ناموفق', icon: 'fa-user-clock', color: 'var(--warning)' },
        'DRAFT_CREATE_SUCCESS': { title: 'ایجاد پیش‌نویس جدید', icon: 'fa-file-medical', color: 'var(--info)' },
        'DRAFT_SAVE_SUCCESS': { title: 'ذخیره پیش‌نویس', icon: 'fa-floppy-disk', color: 'var(--text-light)' },
        'SUBMIT_ARTICLE_SUCCESS': { title: 'ارسال برای استاد', icon: 'fa-file-circle-plus', color: 'var(--primary)' },
        'SUBMIT_DRAFT_SUCCESS': { title: 'ارسال پیش‌نویس برای استاد', icon: 'fa-paper-plane', color: 'var(--primary)' },
        'UPDATE_DETAILS_SUCCESS': { title: 'ویرایش اطلاعات کلی', icon: 'fa-pen-to-square', color: 'var(--info)' },
        'ABSTRACT_UPDATE_SUCCESS': { title: 'ویرایش چکیده', icon: 'fa-file-lines', color: 'var(--info)' },
        'INTRODUCTION_UPDATE_SUCCESS': { title: 'ویرایش مقدمه', icon: 'fa-file-lines', color: 'var(--info)' },
        'BODY_UPDATE_SUCCESS': { title: 'ویرایش بدنه', icon: 'fa-file-lines', color: 'var(--info)' },
        'CONCLUSION_UPDATE_SUCCESS': { title: 'ویرایش نتیجه‌گیری', icon: 'fa-file-lines', color: 'var(--info)' },
        'REFERENCES_UPDATE_SUCCESS': { title: 'ویرایش منابع', icon: 'fa-file-lines', color: 'var(--info)' },
        'UPDATE_SECTION_SUCCESS': { title: 'ویرایش محتوای مقاله', icon: 'fa-file-lines', color: 'var(--info)' },
        'SUBMIT_REVISIONS_SUCCESS': { title: 'ارسال ویرایشات برای استاد', icon: 'fa-file-pen', color: 'var(--primary)' },
        'REVISION_NOTE_ADD_SUCCESS': { title: 'افزودن یادداشت برای استاد', icon: 'fa-note-sticky', color: 'var(--info)' },
        'SEND_FINAL_REVIEW_SUCCESS': { title: 'ارسال برای بررسی نهایی', icon: 'fa-user-check', color: 'var(--primary-dark)' },
        'DELETE_ARTICLE_SUCCESS': { title: 'حذف مقاله', icon: 'fa-trash', color: 'var(--danger)' },
        'ARTICLE_WITHDRAW_REQUEST': { title: 'درخواست انصراف از مقاله', icon: 'fa-user-minus', color: 'var(--warning)' },
        'SUGGESTED_TITLE_TAKEN': { title: 'انتخاب عنوان پیشنهادی', icon: 'fa-lightbulb', color: 'var(--success)' },
        'SUGGESTED_TITLE_RELEASED': { title: 'آزادسازی عنوان', icon: 'fa-lightbulb', color: 'var(--info)' },
        'PROFILE_UPDATE_SUCCESS': { title: 'بروزرسانی پروفایل', icon: 'fa-address-card', color: 'var(--info)' },
        'PASSWORD_CHANGE_SUCCESS': { title: 'تغییر موفق رمز عبور', icon: 'fa-key', color: 'var(--success)' },
        'PASSWORD_CHANGE_FAIL': { title: 'تلاش ناموفق برای تغییر رمز', icon: 'fa-key', color: 'var(--warning)' },
        'FEEDBACK_VIEWED_BY_RESEARCHER': { title: 'مشاهده بازخورد استاد', icon: 'fa-eye', color: 'var(--info)' },
        'ATTACHMENT_UPLOAD_SUCCESS': { title: 'بارگذاری فایل ضمیمه', icon: 'fa-paperclip', color: 'var(--info)' },
        'ATTACHMENT_DELETE_SUCCESS': { title: 'حذف فایل ضمیمه', icon: 'fa-unlink', color: 'var(--info)' },
        'COAUTHOR_ADD_REQUEST': { title: 'درخواست افزودن همکار', icon: 'fa-user-plus', color: 'var(--primary)' },
        'COAUTHOR_REMOVE_SUCCESS': { title: 'حذف همکار نویسنده', icon: 'fa-user-minus', color: 'var(--info)' },
        'SESSION_TIMEOUT_LOGOUT': { title: 'خروج خودکار', icon: 'fa-clock', color: 'var(--text-light)' },
        'SUPPORT_TICKET_CREATE_SUCCESS': { title: 'ثبت تیکت پشتیبانی', icon: 'fa-life-ring', color: 'var(--primary)' },
        'NOTIFICATION_READ': { title: 'مشاهده اعلان', icon: 'fa-bell', color: 'var(--info)' },
        'NOTIFICATION_DELETE_ALL': { title: 'حذف همه اعلان‌ها', icon: 'fa-trash-can', color: 'var(--info)' },
        'ARTICLE_CLONE_SUCCESS': { title: 'ایجاد کپی از مقاله', icon: 'fa-clone', color: 'var(--info)' },
        'FORM_VALIDATION_FAIL': { title: 'خطای اعتبارسنجی فرم', icon: 'fa-triangle-exclamation', color: 'var(--warning)' },
        'ARTICLE_PRINT_VIEW': { title: 'مشاهده نسخه چاپی', icon: 'fa-print', color: 'var(--info)' },
        'FINAL_DECISION_VIEWED': { title: 'مشاهده تصمیم نهایی', icon: 'fa-gavel', color: 'var(--primary-dark)' },
        'ARTICLE_HISTORY_VIEW': { title: 'مشاهده تاریخچه مقاله', icon: 'fa-history', color: 'var(--info)' },
        'SUPERVISOR_CHANGE_REQUEST': { title: 'درخواست تغییر استاد', icon: 'fa-user-tag', color: 'var(--primary)' },
        'KEYWORDS_UPDATE_SUCCESS': { title: 'ویرایش کلیدواژه‌ها', icon: 'fa-tags', color: 'var(--info)' },
        'TITLE_UPDATE_SUCCESS': { title: 'ویرایش عنوان مقاله', icon: 'fa-heading', color: 'var(--info)' },
        'AFFILIATION_UPDATE_SUCCESS': { title: 'ویرایش وابستگی سازمانی', icon: 'fa-building-columns', color: 'var(--info)' },
        'VERSION_RESTORE_REQUEST': { title: 'درخواست بازیابی نسخه', icon: 'fa-clock-rotate-left', color: 'var(--warning)' },
        'MESSAGE_SEND_TO_SUPERVISOR': { title: 'ارسال پیام به استاد', icon: 'fa-paper-plane', color: 'var(--primary)' },
        'MESSAGE_VIEW_FROM_SUPERVISOR': { title: 'مشاهده پیام از استاد', icon: 'fa-envelope-open', color: 'var(--info)' },
        'FILE_UPLOAD_FORMAT_ERROR': { title: 'خطای فرمت فایل', icon: 'fa-file-circle-exclamation', color: 'var(--danger)' },
        'FILE_UPLOAD_SIZE_EXCEEDED': { title: 'خطای حجم فایل', icon: 'fa-file-arrow-up', color: 'var(--danger)' },
        'SUBMISSION_CANCEL_SUCCESS': { title: 'لغو ارسال مقاله', icon: 'fa-file-circle-xmark', color: 'var(--warning)' },
        'ACCOUNT_DEACTIVATION_REQUEST': { title: 'درخواست غیرفعال‌سازی حساب', icon: 'fa-user-lock', color: 'var(--danger)' },
        'PASSWORD_RESET_REQUEST': { title: 'درخواست بازیابی رمز', icon: 'fa-unlock-keyhole', color: 'var(--primary)' },
        'TWO_FACTOR_AUTH_SETUP': { title: 'فعال‌سازی تایید دو مرحله‌ای', icon: 'fa-shield-halved', color: 'var(--success)' },
        'API_TOKEN_REGENERATE': { title: 'تولید مجدد توکن API', icon: 'fa-key', color: 'var(--info)' },
        'PROF_LOGIN_SUCCESS': { title: 'ورود موفق استاد', icon: 'fa-user-tie', color: 'var(--success)' },
        'PROF_LOGIN_FAIL': { title: 'ورود ناموفق استاد', icon: 'fa-user-tie', color: 'var(--warning)' },
        'GUIDANCE_ACCEPTED': { title: 'پذیرش راهنمایی', icon: 'fa-handshake', color: 'var(--success)' },
        'GUIDANCE_REJECTED': { title: 'عدم پذیرش راهنمایی', icon: 'fa-handshake-slash', color: 'var(--danger)' },
        'ARTICLE_OPEN_FOR_REVIEW': { title: 'باز کردن مقاله برای بازبینی', icon: 'fa-folder-open', color: 'var(--info)' },
        'SENT_FOR_REVISION': { title: 'ارجاع برای ویرایش (توسط استاد)', icon: 'fa-user-edit', color: 'var(--warning)' },
        'REVISION_FEEDBACK_UPDATED': { title: 'ویرایش بازخورد استاد', icon: 'fa-comment-dots', color: 'var(--info)' },
        'FEEDBACK_SAVE_DRAFT': { title: 'ذخیره پیش‌نویس بازخورد', icon: 'fa-floppy-disk', color: 'var(--text-light)' },
        'APPROVED_FOR_JOURNAL': { title: 'تایید نهایی توسط استاد', icon: 'fa-user-graduate', color: 'var(--success)' },
        'SUPERVISION_CANCELLED': { title: 'انصراف استاد از راهنمایی', icon: 'fa-user-slash', color: 'var(--danger)' },
        'CAPACITY_UPDATE_SUCCESS': { title: 'تغییر ظرفیت پذیرش', icon: 'fa-users-line', color: 'var(--info)' },
        'AVAILABILITY_SET_AWAY': { title: 'تنظیم وضعیت به "غیرفعال"', icon: 'fa-toggle-off', color: 'var(--text-light)' },
        'AVAILABILITY_SET_ACTIVE': { title: 'تنظیم وضعیت به "فعال"', icon: 'fa-toggle-on', color: 'var(--success)' },
        'TITLE_SUGGESTED': { title: 'افزودن عنوان پیشنهادی', icon: 'fa-plus', color: 'var(--info)' },
        'SUGGESTED_TITLE_EDIT_SUCCESS': { title: 'ویرایش عنوان پیشنهادی', icon: 'fa-pen', color: 'var(--info)' },
        'SUGGESTED_TITLE_DELETE_SUCCESS': { title: 'حذف عنوان پیشنهادی', icon: 'fa-trash', color: 'var(--danger)' },
        'MESSAGE_SEND_TO_RESEARCHER': { title: 'ارسال پیام به محقق', icon: 'fa-paper-plane', color: 'var(--primary)' },
        'MESSAGE_VIEW_FROM_RESEARCHER': { title: 'مشاهده پیام از محقق', icon: 'fa-envelope-open', color: 'var(--info)' },
        'REVISION_NOTE_VIEWED': { title: 'مشاهده توضیحات محقق', icon: 'fa-eye', color: 'var(--info)' },
        'ARTICLE_HISTORY_VIEWED': { title: 'مشاهده تاریخچه مقاله', icon: 'fa-history', color: 'var(--info)' },
        'DASHBOARD_FILTER_APPLY': { title: 'اعمال فیلتر در داشبورد', icon: 'fa-filter', color: 'var(--info)' },
        'ARTICLE_SEARCH_PERFORMED': { title: 'انجام جستجو در مقالات', icon: 'fa-search', color: 'var(--info)' },
        'ARTICLE_ESCALATE_TO_ADMIN': { title: 'ارجاع مورد به مدیر', icon: 'fa-flag', color: 'var(--warning)' },
        'SUPERVISION_TRANSFER_REQUEST': { title: 'درخواست انتقال راهنمایی', icon: 'fa-right-left', color: 'var(--primary)' },
        'PASSWORD_CHANGE_SUCCESS_PROF': { title: 'تغییر موفق رمز عبور (استاد)', icon: 'fa-key', color: 'var(--success)' },
        'NOTIFICATION_MARK_AS_READ': { title: 'خواندن اعلان', icon: 'fa-bell-slash', color: 'var(--info)' },
        'BATCH_ACTION_REJECT_SUCCESS': { title: 'رد گروهی درخواست‌ها', icon: 'fa-folder-minus', color: 'var(--danger)' },
        'REPORT_GENERATE_OWN_STATS': { title: 'تولید گزارش عملکرد شخصی', icon: 'fa-chart-pie', color: 'var(--info)' },
        'ARTICLE_METADATA_VIEW': { title: 'مشاهده فراداده مقاله', icon: 'fa-info-circle', color: 'var(--info)' },
        'ARTICLE_CONTENT_DOWNLOAD': { title: 'دانلود محتوای مقاله', icon: 'fa-file-download', color: 'var(--info)' },
        'QUICK_REPLY_SENT': { title: 'ارسال پاسخ سریع', icon: 'fa-reply-all', color: 'var(--primary)' },
        'DEADLINE_SET_FOR_REVISION': { title: 'تعیین مهلت ویرایش', icon: 'fa-calendar-day', color: 'var(--warning)' },
        'DEADLINE_EXTENSION_GRANTED': { title: 'تمدید مهلت ویرایش', icon: 'fa-calendar-plus', color: 'var(--success)' },
        'PLAGIARISM_CHECK_INITIATED': { title: 'درخواست بررسی سرقت ادبی', icon: 'fa-search-dollar', color: 'var(--primary)' },
        'PLAGIARISM_REPORT_VIEWED': { title: 'مشاهده گزارش سرقت ادبی', icon: 'fa-file-contract', color: 'var(--info)' },
        'ANNOTATION_ADD_SUCCESS': { title: 'افزودن یادداشت روی متن', icon: 'fa-highlighter', color: 'var(--info)' },
        'VERSION_COMPARE_VIEW': { title: 'مشاهده تفاوت نسخه‌ها', icon: 'fa-code-compare', color: 'var(--info)' },
        'ARTICLE_TAG_ADD': { title: 'افزودن برچسب به مقاله', icon: 'fa-tag', color: 'var(--info)' },
        'ARTICLE_TAG_REMOVE': { title: 'حذف برچسب از مقاله', icon: 'fa-tags', color: 'var(--info)' },
        'SIMILAR_ARTICLES_SEARCH': { title: 'جستجوی مقالات مشابه', icon: 'fa-copy', color: 'var(--info)' },
        'GUIDANCE_COMPLETE_MANUAL': { title: 'تکمیل دستی فرآیند راهنمایی', icon: 'fa-check-circle', color: 'var(--success)' },
        'LOGOUT_SUCCESS': { title: 'خروج موفق از سیستم', icon: 'fa-sign-out-alt', color: 'var(--info)' },
        'TWO_FACTOR_DISABLE_REQUEST': { title: 'درخواست غیرفعال‌سازی تایید دو مرحله‌ای', icon: 'fa-shield-slash', color: 'var(--warning)' },
        'EXPORT_OWN_ARTICLES_LIST': { title: 'دریافت خروجی مقالات', icon: 'fa-file-export', color: 'var(--info)' },
        'HELP_DOCUMENTATION_VIEW': { title: 'مشاهده راهنمای پنل', icon: 'fa-question-circle', color: 'var(--info)' },
        'MESSAGE_ARCHIVE_SUCCESS': { title: 'بایگانی کردن پیام', icon: 'fa-box-archive', color: 'var(--info)' },
        'DECISION_SAVE_FAIL': { title: 'خطای ثبت تصمیم', icon: 'fa-triangle-exclamation', color: 'var(--danger)' },
        'REMINDER_SET_FOR_RESEARCHER': { title: 'تنظیم یادآور برای محقق', icon: 'fa-bell', color: 'var(--primary)' },
        'COMMUNICATION_LOG_VIEW': { title: 'مشاهده لاگ ارتباطات', icon: 'fa-comments', color: 'var(--info)' },
        'ADMIN_LOGIN_SUCCESS': { title: 'ورود موفق مدیر', icon: 'fa-user-shield', color: 'var(--success)' },
        'ADMIN_LOGIN_FAIL': { title: 'ورود ناموفق مدیر', icon: 'fa-user-shield', color: 'var(--danger)' },
        'JOURNAL_ACCEPTED': { title: 'پذیرش نهایی مقاله', icon: 'fa-award', color: 'var(--success)' },
        'JOURNAL_REJECTED': { title: 'رد نهایی مقاله', icon: 'fa-ban', color: 'var(--danger)' },
        'SENT_FOR_FINAL_REVISION': { title: 'ارسال برای ویرایش نهایی', icon: 'fa-circle-exclamation', color: 'var(--warning)' },
        'ARTICLE_ASSIGNED_TO_ISSUE': { title: 'تخصیص به شماره نشر', icon: 'fa-calendar-check', color: 'var(--info)' },
        'ARTICLE_REMOVE_FROM_ISSUE': { title: 'حذف از شماره نشر', icon: 'fa-calendar-minus', color: 'var(--warning)' },
        'ISSUE_CREATED': { title: 'ایجاد شماره نشر جدید', icon: 'fa-newspaper', color: 'var(--primary)' },
        'ISSUE_UPDATED': { title: 'ویرایش شماره نشر', icon: 'fa-edit', color: 'var(--info)' },
        'ISSUE_DELETED': { title: 'حذف شماره نشر', icon: 'fa-trash-can', color: 'var(--danger)' },
        'ISSUE_PUBLISHED_FLAG': { title: 'علامت‌گذاری "منتشر شده"', icon: 'fa-check-double', color: 'var(--success)' },
        'USER_CREATED': { title: 'ایجاد کاربر جدید', icon: 'fa-user-plus', color: 'var(--success)' },
        'USER_UPDATED': { title: 'ویرایش اطلاعات کاربر', icon: 'fa-user-pen', color: 'var(--info)' },
        'USER_DELETED': { title: 'حذف کاربر', icon: 'fa-user-times', color: 'var(--danger)' },
        'USER_SUSPENDED': { title: 'معلق کردن کاربر', icon: 'fa-user-lock', color: 'var(--warning)' },
        'USER_ACTIVATED': { title: 'فعال‌سازی کاربر', icon: 'fa-user-check', color: 'var(--success)' },
        'USER_ROLE_CHANGED': { title: 'تغییر نقش کاربر', icon: 'fa-user-gear', color: 'var(--info)' },
        'USER_BULK_IMPORT_SUCCESS': { title: 'افزودن گروهی کاربران', icon: 'fa-users', color: 'var(--success)' },
        'PASSWORD_RESET_FOR_USER': { title: 'بازنشانی رمز عبور کاربر', icon: 'fa-key', color: 'var(--warning)' },
        'SYSTEM_SETTINGS_UPDATED': { title: 'تغییر تنظیمات سیستم', icon: 'fa-cogs', color: 'var(--info)' },
        'LOG_EXPORT_SUCCESS': { title: 'دریافت خروجی لاگ‌ها', icon: 'fa-file-csv', color: 'var(--info)' },
        'DATA_EXPORT_ARTICLES_SUCCESS': { title: 'دریافت خروجی مقالات', icon: 'fa-file-excel', color: 'var(--info)' },
        'DATA_EXPORT_USERS_SUCCESS': { title: 'دریافت خروجی کاربران', icon: 'fa-file-excel', color: 'var(--info)' },
        'ARTICLE_STATUS_OVERRIDE': { title: 'تغییر دستی وضعیت مقاله', icon: 'fa-bolt', color: 'var(--danger)' },
        'SUPERVISOR_CHANGE_MANUAL': { title: 'تغییر دستی استاد راهنما', icon: 'fa-user-edit', color: 'var(--warning)' },
        'ARTICLE_METADATA_EDIT_ADMIN': { title: 'ویرایش اطلاعات مقاله (توسط مدیر)', icon: 'fa-edit', color: 'var(--warning)' },
        'ARTICLE_DELETE_BY_ADMIN': { title: 'حذف مقاله (توسط مدیر)', icon: 'fa-trash-alt', color: 'var(--danger)' },
        'CATEGORY_CREATE_SUCCESS': { title: 'ایجاد حیطه دانشی جدید', icon: 'fa-folder-plus', color: 'var(--info)' },
        'CATEGORY_DELETE_SUCCESS': { title: 'حذف حیطه دانشی', icon: 'fa-folder-minus', color: 'var(--danger)' },
        'CATEGORY_EDIT_SUCCESS': { title: 'ویرایش حیطه دانشی', icon: 'fa-folder-open', color: 'var(--info)' },
        'ADMIN_PASSWORD_CHANGED': { title: 'تغییر رمز عبور مدیر', icon: 'fa-key', color: 'var(--success)' },
        'default': { title: 'اقدام نامشخص', icon: 'fa-question-circle', color: 'var(--text-light)'}
    };

    document.addEventListener('DOMContentLoaded', () => {
        appState.currentUser = JSON.parse(localStorage.getItem('journalAdmin'));
        if (appState.currentUser) {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('display-admin-name').textContent = appState.currentUser.username;
            initBackgroundLoad('dashboard');
        }
        
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.querySelectorAll('#main-nav button').forEach(btn => btn.addEventListener('click', () => navigateTo(btn.dataset.view)));
        
        // کنترل منوی بازشوی کاربری (دستور 3)
        const userMenuBtn = document.getElementById('user-menu-btn');
        const userDropdown = document.getElementById('user-dropdown');
        if(userMenuBtn && userDropdown) {
            userMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                userDropdown.classList.toggle('show');
            });
            document.addEventListener('click', (e) => {
                if (!userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                    userDropdown.classList.remove('show');
                }
            });
        }
    });

    async function initBackgroundLoad(targetView) {
        if (!appState.isDataLoaded && !appState.isLoadingData) {
            appState.isLoadingData = true;
            if (targetView) navigateTo(targetView);
            showToast('در حال دریافت اطلاعات پایه سیستم...', 'info');

            const response = await callApi('getAllData');
            if (response && response.status === 'success') {
                appState.data = response.data;
                appState.isDataLoaded = true;
                showToast('اطلاعات با موفقیت همگام‌سازی شد.', 'success');
                
                const activeBtn = document.querySelector('#main-nav button.active');
                if (activeBtn) navigateTo(activeBtn.dataset.view);
                else if (appState.pendingView || targetView) navigateTo(appState.pendingView || targetView);
                appState.pendingView = null;
            } else {
                showToast('خطا در دریافت اطلاعات پس‌زمینه.', 'error');
            }
            appState.isLoadingData = false;
        }
    }

    async function callApi(action, params = {}, button = null) {
        if (button) button.classList.add('btn-loading');
        try {
            const payload = { action, params, adminUsername: appState.currentUser?.username };
            const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`خطای شبکه: ${response.statusText}`);
            const data = await response.json();
            if (data.status === 'error') throw new Error(data.message);
            return data;
        } catch (error) {
            showToast(error.message, 'error');
            return null;
        } finally {
            if (button) button.classList.remove('btn-loading');
        }
    }

    async function handleLogin(e) {
        e.preventDefault();
        const button = document.getElementById('login-btn');
        const loginError = document.getElementById('login-error');
        loginError.textContent = '';
        const response = await callApi('adminLogin', { username: document.getElementById('username').value, password: document.getElementById('password').value }, button);
        if (response?.status === 'success') {
            appState.currentUser = response.user;
            localStorage.setItem('journalAdmin', JSON.stringify(appState.currentUser));
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('display-admin-name').textContent = appState.currentUser.username;
            initBackgroundLoad('dashboard'); 
        } else {
             loginError.textContent = 'نام کاربری یا رمز عبور اشتباه است.';
        }
    }

    function handleLogout() { localStorage.removeItem('journalAdmin'); window.location.reload(); }
    
    // منوی تغییر رمز عبور (دستور 2)
    function showChangePasswordModal() {
        document.getElementById('user-dropdown').classList.remove('show');
        const content = `
            <div class="form-group"><label>رمز عبور فعلی</label><input type="password" id="old-pass" dir="ltr" style="text-align:left;"></div>
            <div class="form-group"><label>رمز عبور جدید</label><input type="password" id="new-pass" dir="ltr" style="text-align:left;"></div>
            <div class="form-group"><label>تکرار رمز عبور جدید</label><input type="password" id="confirm-new-pass" dir="ltr" style="text-align:left;"></div>
        `;
        showModal('تغییر رمز عبور مدیریت', content, 'modal-md');
        document.getElementById('main-modal-footer').innerHTML = `<button class="btn-light" onclick="closeModal('main-modal')">انصراف</button><button class="btn-primary" onclick="handleChangePassword(this)"><i class="fas fa-save"></i> ذخیره رمز عبور</button>`;
    }

    async function handleChangePassword(btn) {
        const oldPass = document.getElementById('old-pass').value;
        const newPass = document.getElementById('new-pass').value;
        const confirmPass = document.getElementById('confirm-new-pass').value;
        if(!oldPass || !newPass || !confirmPass) return showToast('تکمیل تمام فیلدها الزامی است', 'error');
        if(newPass !== confirmPass) return showToast('رمز عبور جدید و تکرار آن یکسان نیستند', 'error');
        
        const res = await callApi('changeAdminPassword', { oldPass, newPass }, btn);
        if(res && res.status === 'success') {
            showToast('رمز عبور با موفقیت تغییر یافت. لطفاً مجدداً وارد شوید.', 'success');
            setTimeout(handleLogout, 2000);
        }
    }

    function navigateTo(view) {
        document.querySelectorAll('#main-nav button').forEach(btn => btn.classList.toggle('active', btn.dataset.view === view));
        
        if (!appState.isDataLoaded) {
             appState.pendingView = view;
             document.getElementById('main-content').innerHTML = `<div class="loader-wrapper"><div class="loader"></div><p style="color:var(--primary-dark); font-weight:800; font-size:1.1rem; margin-top:10px;">در حال آماده‌سازی داده‌ها...</p></div>`;
             if (!appState.isLoadingData) initBackgroundLoad();
             return;
        }
        
        switch (view) {
            case 'dashboard': renderDashboardView(); break;
            case 'articles': renderArticlesViewInit(); break;
            case 'categories': renderCategoriesView(); break;
            case 'publications': renderPublicationsView(); break;
            case 'users': renderUsersView(); break;
            case 'logs': renderLogsView(); break;
        }
    }
    
    function renderDashboardView() {
        const articles = appState.data.articles;
        const stats = {
            pending: articles.filter(a => String(a.status) === '6').length,
            accepted: articles.filter(a => String(a.status) === '5').length,
            rejected: articles.filter(a => String(a.status) === '0').length,
            total: articles.length
        };
        document.getElementById('main-content').innerHTML = `
            <h1>داشبورد سیستم</h1>
            <div class="stat-grid">
                <div class="card stat-card" style="border-right-color: var(--warning);"><h4>منتظر تصمیم نشریه</h4><p class="count">${stats.pending}</p></div>
                <div class="card stat-card" style="border-right-color: var(--success);"><h4>تایید شده برای نشر</h4><p class="count">${stats.accepted}</p></div>
                <div class="card stat-card" style="border-right-color: var(--danger);"><h4>رد شده نهایی</h4><p class="count">${stats.rejected}</p></div>
                <div class="card stat-card" style="border-right-color: var(--info);"><h4>کل مقالات ثبت شده</h4><p class="count">${stats.total}</p></div>
            </div>`;
    }
    
    function renderArticlesViewInit() {
        currentArticlesList = [...appState.data.articles];
        articlesLimits['6'] = 10; articlesLimits['5'] = 10; articlesLimits['10'] = 10; articlesLimits['other'] = 10;
        
        const count6 = currentArticlesList.filter(a => String(a.status) === '6').length;
        const count5 = currentArticlesList.filter(a => String(a.status) === '5').length;
        const count10 = currentArticlesList.filter(a => String(a.status) === '10').length;
        const countOther = currentArticlesList.length - (count6 + count5 + count10);

        document.getElementById('main-content').innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px;">
                <h1 style="border:none; margin:0; padding:0;">مدیریت جامع مقالات</h1>
                <button class="btn-light" onclick="handleExportExcel()"><i class="fas fa-file-excel" style="color:var(--success)"></i> خروجی اکسل کامل</button>
            </div>
            
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-body" style="display:flex; gap:10px; background:var(--secondary-light); border-bottom:1px solid var(--border-color); padding: 15px 25px;">
                    <input type="text" id="server-search-input" placeholder="جستجوی عنوان در کل مقالات سرور..." style="flex-grow:1; border-color:var(--border-color);">
                    <button class="btn-primary" id="server-search-btn" onclick="executeServerSearch()"><i class="fas fa-search"></i> جستجو</button>
                </div>
            </div>

            <div class="card">
                <div class="tab-nav" style="background:#f8fafc; padding:0 15px; border-bottom: 1px solid var(--border-color); margin-bottom: 0;">
                    <button class="active" onclick="switchArticleListTab('6', this)">منتظر بررسی شما <span style="background:var(--warning);color:#fff;padding:2px 8px;border-radius:12px;font-size:0.8rem;margin-right:5px;">${count6}</span></button>
                    <button onclick="switchArticleListTab('5', this)">تایید شده <span style="background:var(--success);color:#fff;padding:2px 8px;border-radius:12px;font-size:0.8rem;margin-right:5px;">${count5}</span></button>
                    <button onclick="switchArticleListTab('10', this)">نیازمند ویرایش مجدد <span style="background:var(--info);color:#fff;padding:2px 8px;border-radius:12px;font-size:0.8rem;margin-right:5px;">${count10}</span></button>
                    <button onclick="switchArticleListTab('other', this)">سایر وضعیت‌ها <span style="background:var(--secondary);color:#fff;padding:2px 8px;border-radius:12px;font-size:0.8rem;margin-right:5px;">${countOther}</span></button>
                </div>
                <div id="articles-list-container" style="padding: 0;"></div>
            </div>`;
            
        renderArticlesTableByTab('6');
        
        document.getElementById('server-search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') executeServerSearch();
        });
    }

    function switchArticleListTab(tabId, clickedBtn) {
        document.querySelectorAll('.tab-nav button').forEach(btn => btn.classList.remove('active'));
        clickedBtn.classList.add('active');
        renderArticlesTableByTab(tabId);
    }

    function renderArticlesTableByTab(tabId) {
        const container = document.getElementById('articles-list-container');
        let list = [];
        if (tabId === '6') list = currentArticlesList.filter(a => String(a.status) === '6');
        else if (tabId === '5') list = currentArticlesList.filter(a => String(a.status) === '5');
        else if (tabId === '10') list = currentArticlesList.filter(a => String(a.status) === '10');
        else list = currentArticlesList.filter(a => !['6','5','10'].includes(String(a.status)));
        
        const limit = articlesLimits[tabId];
        const listToShow = list.slice(0, limit);

        let html = `
            <div class="table-wrapper" style="border:none; border-radius:0;"><table>
                <thead><tr><th>شناسه</th><th>عنوان مقاله</th><th>محقق</th><th>استاد راهنما</th><th>وضعیت</th><th>عملیات</th></tr></thead>
                <tbody>
                    ${listToShow.map(a => `
                        <tr>
                            <td><strong>${a.articleId}</strong></td>
                            <td style="max-width:300px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${a.title}">${a.title}</td>
                            <td>${a.researcherName}</td><td>${a.supervisorName}</td>
                            <td>${getStatusBadge(a.status)}</td>
                            <td class="actions-cell"><button class="btn-light btn-sm" onclick="showArticleDetailsModal('${a.articleId}')"><i class="fas fa-folder-open"></i> پرونده</button></td>
                        </tr>`).join('') || `<tr><td colspan="6" style="text-align:center; padding: 40px; color:var(--text-light);">مقاله‌ای در این بخش یافت نشد.</td></tr>`}
                </tbody>
            </table></div>`;

        if (limit < list.length) {
            html += `<div style="text-align:center; padding: 25px; border-top:1px solid var(--border-color); background:#f8fafc;"><button class="btn-secondary" onclick="loadMoreArticlesTab('${tabId}')"><i class="fas fa-chevron-down"></i> مشاهده موارد بیشتر (صفحه بعد)</button></div>`;
        }
        container.innerHTML = html;
    }

    function loadMoreArticlesTab(tabId) {
        articlesLimits[tabId] += 10;
        renderArticlesTableByTab(tabId);
    }

    async function executeServerSearch() {
        const query = document.getElementById('server-search-input').value.trim();
        const btn = document.getElementById('server-search-btn');

        if (!query) {
            currentArticlesList = [...appState.data.articles];
            renderArticlesViewInit();
            return;
        }

        btn.classList.add('btn-loading');
        document.getElementById('articles-list-container').innerHTML = `<div class="loader-wrapper"><div class="loader"></div></div>`;

        const response = await callApi('searchArticlesByTitle', { query });
        btn.classList.remove('btn-loading');

        if (response && response.status === 'success') {
            currentArticlesList = response.articles;
            articlesLimits['6'] = 10; articlesLimits['5'] = 10; articlesLimits['10'] = 10; articlesLimits['other'] = 10;
            const activeTab = document.querySelector('.tab-nav button.active');
            let tabId = '6';
            if(activeTab) {
                if(activeTab.innerText.includes('تایید شده')) tabId = '5';
                else if(activeTab.innerText.includes('نیازمند ویرایش مجدد')) tabId = '10';
                else if(activeTab.innerText.includes('سایر')) tabId = 'other';
            }
            const count6 = currentArticlesList.filter(a => String(a.status) === '6').length;
            const count5 = currentArticlesList.filter(a => String(a.status) === '5').length;
            const count10 = currentArticlesList.filter(a => String(a.status) === '10').length;
            const countOther = currentArticlesList.length - (count6 + count5 + count10);
            
            const btns = document.querySelectorAll('.tab-nav button');
            if(btns.length >= 4) {
                btns[0].innerHTML = `منتظر بررسی شما <span style="background:var(--warning);color:#fff;padding:2px 8px;border-radius:12px;font-size:0.8rem;margin-right:5px;">${count6}</span>`;
                btns[1].innerHTML = `تایید شده <span style="background:var(--success);color:#fff;padding:2px 8px;border-radius:12px;font-size:0.8rem;margin-right:5px;">${count5}</span>`;
                btns[2].innerHTML = `نیازمند ویرایش مجدد <span style="background:var(--info);color:#fff;padding:2px 8px;border-radius:12px;font-size:0.8rem;margin-right:5px;">${count10}</span>`;
                btns[3].innerHTML = `سایر وضعیت‌ها <span style="background:var(--secondary);color:#fff;padding:2px 8px;border-radius:12px;font-size:0.8rem;margin-right:5px;">${countOther}</span>`;
            }
            renderArticlesTableByTab(tabId);
        } else {
            document.getElementById('articles-list-container').innerHTML = `<div style="text-align:center; padding: 40px; color:var(--danger);">خطا در جستجو</div>`;
        }
    }

    function renderCategoriesView() {
        const cats = appState.data.categories || [];
        document.getElementById('main-content').innerHTML = `
            <h1>مدیریت حوزه‌های پژوهش</h1>
            <div class="card" style="max-width: 800px;">
                <div class="card-header"><h3>افزودن حوزه پژوهشی جدید</h3></div>
                <div class="card-body" style="display:flex; gap:15px; align-items:flex-end; flex-wrap:wrap;">
                    <div style="flex-grow:1; min-width:200px;">
                        <label>عنوان حوزه پژوهش (عیناً جهت انتخاب توسط نویسندگان نمایش داده می‌شود)</label>
                        <input type="text" id="new-category-name" placeholder="مثال: روانشناسی تربیتی نوجوانان">
                    </div>
                    <button class="btn-primary" onclick="handleAddCategory(this)" style="height: 46px;"><i class="fas fa-plus"></i> ایجاد حوزه</button>
                </div>
            </div>
            
            <div class="card" style="max-width: 800px;">
                <div class="card-header"><h3>حوزه‌های پژوهش فعلی نشریه</h3></div>
                <div class="card-body" id="categories-list">
                    ${cats.length > 0 ? cats.map(c => `
                        <div class="category-item">
                            <span class="category-item-text"><i class="fas fa-check-circle" style="color:var(--success); margin-left:8px;"></i>${c}</span>
                            <div class="category-actions">
                                <button class="btn-light btn-sm" onclick="showEditCategoryModal('${c}')"><i class="fas fa-pen" style="color:var(--info);"></i> ویرایش</button>
                                <button class="btn-light btn-sm" onclick="handleDeleteCategory('${c}', this)"><i class="fas fa-trash" style="color:var(--danger);"></i> حذف</button>
                            </div>
                        </div>
                    `).join('') : '<p style="text-align:center; color:var(--text-light); padding:20px;">هیچ حوزه‌ای ثبت نشده است.</p>'}
                </div>
            </div>`;
    }

    async function handleAddCategory(btn) {
        const name = document.getElementById('new-category-name').value.trim();
        if (!name) return showToast('لطفاً عنوان حوزه را وارد کنید.', 'warning');
        if (appState.data.categories.includes(name)) return showToast('این حوزه قبلاً ثبت شده است.', 'warning');
        
        const res = await callApi('addCategory', { name }, btn);
        if (res && res.status === 'success') {
            showToast(res.message, 'success');
            appState.data.categories = res.categories;
            renderCategoriesView();
        }
    }

    function showEditCategoryModal(oldName) {
        const content = `
            <div class="form-group">
                <label>عنوان جدید را وارد کنید:</label>
                <input type="text" id="edit-category-input" value="${oldName}">
            </div>
            <p style="font-size:0.85rem; color:var(--danger);"><i class="fas fa-exclamation-triangle"></i> توجه: در صورتی که مقاله‌ای با این حوزه ثبت شده باشد، امکان ویرایش وجود نخواهد داشت.</p>
        `;
        showModal('ویرایش حوزه پژوهش', content, 'modal-md');
        document.getElementById('main-modal-footer').innerHTML = `
            <button class="btn-light" onclick="closeModal('main-modal')">لغو</button>
            <button class="btn-primary" onclick="handleEditCategory('${oldName}', this)">ذخیره تغییرات</button>`;
    }

    async function handleEditCategory(oldName, btn) {
        const newName = document.getElementById('edit-category-input').value.trim();
        if (!newName || newName === oldName) return closeModal('main-modal');
        if (appState.data.categories.includes(newName)) return showToast('این نام قبلاً وجود دارد.', 'warning');

        const res = await callApi('editCategory', { oldName, newName }, btn);
        if (res) {
            if (res.status === 'success') {
                showToast(res.message, 'success');
                appState.data.categories = res.categories;
                closeModal('main-modal');
                renderCategoriesView();
            } else {
                showToast(res.message, 'error'); 
                closeModal('main-modal');
            }
        }
    }

    async function handleDeleteCategory(name, btn) {
        if (!confirm(`آیا از حذف حوزه "${name}" اطمینان دارید؟`)) return;
        const res = await callApi('deleteCategory', { name }, btn);
        if (res) {
            if (res.status === 'success') {
                showToast(res.message, 'success');
                appState.data.categories = res.categories;
                renderCategoriesView();
            } else {
                showToast(res.message, 'error'); 
            }
        }
    }

    function renderPublicationsView() {
        visiblePastIssuesCount = 10;
        renderPublicationsContent();
    }

    function renderPublicationsContent() {
        const { issues, readyArticles } = appState.data.publications;
        
        const now = new Date();
        now.setHours(0,0,0,0);
        
        const futureIssues = [];
        const pastIssues = [];
        
        issues.forEach(i => {
            const d = new Date(i.publishDate);
            d.setHours(0,0,0,0);
            if (d >= now) futureIssues.push(i);
            else pastIssues.push(i);
        });

        futureIssues.sort((a,b) => new Date(a.publishDate) - new Date(b.publishDate));
        pastIssues.sort((a,b) => new Date(b.publishDate) - new Date(a.publishDate));

        const maxIssue = issues.length > 0 ? Math.max(...issues.map(i => Number(i.issueNumber)).filter(n => !isNaN(n))) : 0;
        const nextIssueNumber = maxIssue + 1;
        
        const todayString = now.toISOString().split('T')[0];
        
        const isFutureFull = futureIssues.length >= 5;
        const pastIssuesToShow = pastIssues.slice(0, visiblePastIssuesCount);

        document.getElementById('main-content').innerHTML = `
            <h1>مدیریت امور انتشارات</h1>
            <div class="pub-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 25px; align-items: start;">
                
                <div class="card">
                    <div class="card-header"><h3>تخصیص مقالات به شماره‌های آتی</h3></div>
                    <div class="card-body">
                        <h4 style="font-size:1rem; color:var(--secondary);">۱. مقالات تایید شده (آماده تخصیص):</h4>
                        <div id="ready-articles-list" style="max-height: 250px; overflow-y: auto; border: 1px solid var(--border-color); padding: 15px; margin-bottom: 1.5rem; background: #f8fafc; border-radius: var(--radius-md);">
                            ${readyArticles.map(a => `<div style="margin-bottom:8px; border-bottom:1px dashed #e2e8f0; padding-bottom:8px;"><input type="checkbox" id="art-${a.articleId}" value="${a.articleId}" class="article-checkbox" style="width:auto; margin-left:10px;"> <label for="art-${a.articleId}" style="display:inline; font-weight:normal;">${a.title} <strong>(${a.articleId})</strong></label></div>`).join('') || `<p style="color:var(--text-light); text-align:center; margin:0;">مقاله‌ای برای تخصیص وجود ندارد.</p>`}
                        </div>
                        <h4 style="font-size:1rem; color:var(--secondary);">۲. انتخاب شماره نشر مقصد:</h4>
                        <select id="issue-select" style="margin-bottom: 20px;">
                            ${futureIssues.map(i => `<option value="${i.issueNumber}">دوره ${i.issueNumber} (تاریخ مقرر: ${formatDate(i.publishDate, false)})</option>`).join('')}
                            ${futureIssues.length === 0 ? '<option value="">ابتدا یک شماره نشر برای آینده ایجاد کنید</option>' : ''}
                        </select>
                        <button id="assign-btn" class="btn-success" style="width:100%; height:46px;" ${futureIssues.length === 0 ? 'disabled' : ''}><i class="fas fa-link"></i> تخصیص مقالات انتخاب شده</button>
                    </div>
                </div>

                <div class="card">
                     <div class="card-header"><h3>مدیریت دوره‌های آتی</h3></div>
                     <div class="card-body">
                        <div id="future-issues-list" style="max-height: 250px; overflow-y: auto; margin-bottom: 1.5rem;">
                            ${futureIssues.map(i => `
                                <div class="issue-list-item">
                                    <div style="line-height:1.6;">
                                        <strong style="color:var(--primary-dark); font-size:1.1rem;">دوره ${i.issueNumber}</strong><br>
                                        <span style="color:var(--text-light); font-size:0.9rem;"><i class="fas fa-calendar-alt"></i> ${formatDate(i.publishDate, false)} &nbsp;|&nbsp; <i class="fas fa-file-alt"></i> ${i.assignedCount} مقاله</span>
                                    </div>
                                    <div style="display:flex; gap:5px;">
                                        <button title="مشاهده مقالات" class="view-btn" onclick="showAssignedArticlesModal('${i.issueNumber}')"><i class="fas fa-list"></i></button>
                                        <button class="delete-btn" title="حذف کامل این شماره" onclick="handleDeleteIssue('${i.issueNumber}', this)"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </div>
                            `).join('') || `<p style="color:var(--text-light); text-align:center; padding: 20px 0; margin:0;">دوره‌ای برای آینده تعریف نشده است.</p>`}
                        </div>
                        <div style="background:var(--secondary-light); padding: 20px; border-radius: var(--radius-md); border:1px solid var(--border-color);">
                            <h4 style="font-size:1rem; color:var(--primary-dark); margin-bottom:15px;"><i class="fas fa-plus-circle"></i> ایجاد شماره نشر جدید</h4>
                            <div class="form-group" style="margin-bottom:10px;">
                                <label>شماره دوره (خودکار)</label>
                                <input type="number" id="new-issue-number" value="${nextIssueNumber}" readonly style="background-color: #e2e8f0; color:#64748b; cursor: not-allowed; font-weight:bold;">
                            </div>
                            <div class="form-group">
                                <label>تاریخ دقیق انتشار در سامانه</label>
                                <input type="date" id="new-issue-date" min="${todayString}">
                            </div>
                            <button id="add-issue-btn" class="btn-primary" style="width:100%; height:46px;" ${isFutureFull ? 'disabled title="ظرفیت ۵ دوره تکمیل است"' : ''}>${isFutureFull ? 'ظرفیت تکمیل است' : 'ایجاد دوره جدید'}</button>
                        </div>
                     </div>
                </div>

            </div>

            <div class="card" style="margin-top:10px;">
                <div class="card-header"><h3><i class="fas fa-archive"></i> آرشیو شماره‌های منتشر شده</h3></div>
                <div class="card-body">
                    <div id="past-issues-list" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">
                        ${pastIssuesToShow.map(i => `
                            <div style="border:1px solid var(--border-color); border-radius:var(--radius-md); padding:20px; background:#fff; box-shadow:var(--shadow-sm);">
                                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px dashed var(--border-color); padding-bottom:15px; margin-bottom:15px;">
                                    <strong style="color:var(--primary-dark); font-size:1.2rem;">دوره ${i.issueNumber}</strong>
                                    <span style="font-size:0.9rem; color:var(--text-light); background:var(--secondary-light); padding:4px 10px; border-radius:12px;"><i class="fas fa-calendar-check"></i> ${formatDate(i.publishDate, false)}</span>
                                </div>
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <span style="font-weight:bold; color:var(--success);"><i class="fas fa-file-alt"></i> ${i.assignedCount} مقاله</span>
                                    <button class="btn-light btn-sm" onclick="showAssignedArticlesModal('${i.issueNumber}')"><i class="fas fa-eye"></i> مرور دوره</button>
                                </div>
                            </div>
                        `).join('') || `<p style="color:var(--text-light); grid-column: 1 / -1; text-align:center; padding:30px;">شماره منتشر شده‌ای یافت نشد.</p>`}
                    </div>
                    ${visiblePastIssuesCount < pastIssues.length ? `<div style="text-align:center; margin-top:25px; padding-top:20px; border-top:1px solid var(--border-color);"><button class="btn-secondary" onclick="loadMorePastIssues()"><i class="fas fa-chevron-down"></i> بارگذاری آرشیو قدیمی‌تر</button></div>` : ''}
                </div>
            </div>`;
        
        document.getElementById('add-issue-btn').onclick = handleCreateIssue;
        document.getElementById('assign-btn').onclick = handleAssignArticles;
    }

    function loadMorePastIssues() {
        visiblePastIssuesCount += 10;
        renderPublicationsContent();
    }
    
    // جستجوی کاربران در سمت سرور (دستور 4)
    function renderUsersView() {
        const { researchers, professors } = appState.data.users;
        document.getElementById('main-content').innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px;">
                <h1 style="border:none; margin:0; padding:0;">مدیریت حساب کاربران</h1>
                 <div style="display:flex; gap:10px;">
                    <button class="btn-light" onclick="showImportUsersModal()"><i class="fas fa-file-import"></i> درون‌ریزی (Excel)</button>
                    <button class="btn-success" onclick="showCreateUserModal()"><i class="fas fa-user-plus"></i> کاربر جدید</button>
                 </div>
            </div>
            <div class="card">
                <div class="tab-nav" style="background:#f8fafc; padding:0 20px; border-bottom: 1px solid var(--border-color); margin-bottom: 0;">
                    <button class="active" data-tab="researchers" onclick="switchUserTab('researchers', this)">پژوهشگران</button>
                    <button data-tab="professors" onclick="switchUserTab('professors', this)">اساتید راهنما</button>
                </div>
                <div class="card-body" id="users-content"></div>
            </div>`;
        switchUserTab('researchers', document.querySelector('.tab-nav button.active'));
    }

    function switchUserTab(tabName, clickedBtn) {
        document.querySelectorAll('.tab-nav button').forEach(btn => btn.classList.remove('active'));
        clickedBtn.classList.add('active');
        const contentDiv = document.getElementById('users-content');
        const users = appState.data.users[tabName] || [];
        contentDiv.innerHTML = `
            <div style="display:flex; gap:10px; margin-bottom:1.5rem; max-width:500px;">
                <input type="text" id="server-user-search-${tabName}" placeholder="جستجو فقط بر اساس کد ملی..." dir="ltr" style="text-align:left;">
                <button class="btn-primary" id="search-user-btn-${tabName}" onclick="executeUserSearch('${tabName}')"><i class="fas fa-search"></i> جستجو در سرور</button>
            </div>
            <div id="users-table-container-${tabName}">
                ${renderUsersTableHTML(tabName, users)}
            </div>`;
            
        document.getElementById(`server-user-search-${tabName}`).addEventListener('keypress', function(e) {
            if (e.key === 'Enter') executeUserSearch(tabName);
        });
    }
    
    function renderUsersTableHTML(tabName, users) {
        return `
            <div class="table-wrapper"><table>
            <thead><tr><th>نام و نام خانوادگی</th><th>شناسه سیستمی (کد ملی)</th>${tabName === 'professors' ? '<th>وضعیت حساب</th>' : ''}<th>عملیات مدیریتی</th></tr></thead><tbody id="${tabName}-table">
            ${users.map(u => `<tr><td><strong>${u.name}</strong></td><td style="font-family:monospace;">${u.nid}</td>${tabName === 'professors' ? `<td><span class="status-badge" style="background:${u.status == 5 ? 'var(--success)' : 'var(--danger)'}; color:white;">${u.status == 5 ? 'فعال' : 'غیرفعال'}</span></td>` : ''}<td><button class="btn-light btn-sm" onclick="showEditUserModal('${u.nid}', '${tabName}')"><i class="fas fa-cog"></i> تنظیمات</button></td></tr>`).join('') || `<tr><td colspan="4" style="text-align:center; padding:20px; color:var(--text-light);">کاربری یافت نشد.</td></tr>`}
            </tbody></table></div>`;
    }

    async function executeUserSearch(tabName) {
        const query = document.getElementById(`server-user-search-${tabName}`).value.trim();
        const btn = document.getElementById(`search-user-btn-${tabName}`);
        const container = document.getElementById(`users-table-container-${tabName}`);

        if (!query) {
            container.innerHTML = renderUsersTableHTML(tabName, appState.data.users[tabName]);
            return;
        }

        btn.classList.add('btn-loading');
        container.innerHTML = `<div class="loader-wrapper"><div class="loader"></div></div>`;

        const response = await callApi('searchUsersByNid', { nid: query, userType: tabName });
        btn.classList.remove('btn-loading');

        if (response && response.status === 'success') {
            container.innerHTML = renderUsersTableHTML(tabName, response.users);
        } else {
            container.innerHTML = `<div style="text-align:center; padding: 20px; color:var(--danger);">خطا در جستجو</div>`;
        }
    }
    
    function renderLogsView() {
        currentLogsList = [...appState.data.logs].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
        visibleLogsCount = 20;

        document.getElementById('main-content').innerHTML = `
            <h1>گزارش وقایع و لاگ سیستم</h1>
            <div class="card">
                <div class="card-header" style="background:#fff; display:flex; gap:10px; flex-wrap:wrap;">
                    <input type="text" id="server-log-search" placeholder="جستجوی سرور (شناسه کاربر، کد مقاله یا اقدام)..." style="flex-grow:1; max-width:400px; border-color:var(--border-color);">
                    <button class="btn-primary" id="server-log-search-btn" onclick="executeLogSearch()"><i class="fas fa-search"></i> جستجو در سرور</button>
                </div>
                <div id="logs-table-container" style="padding:0;"></div>
            </div>`;
        
        renderLogsTable();
        
        document.getElementById('server-log-search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') executeLogSearch();
        });
    }

    function renderLogsTable() {
        const container = document.getElementById('logs-table-container');
        const listToShow = currentLogsList.slice(0, visibleLogsCount);
        
        let html = `
            <div class="table-wrapper" style="border:none; border-radius:0;"><table>
                <thead><tr><th>شناسه/آیکون</th><th>نوع اقدام</th><th>کاربر عامل</th><th>کد مقاله مرتبط</th><th>جزئیات سیستم</th><th>زمان وقوع</th></tr></thead>
                <tbody>
                    ${listToShow.map(l => {
                        const logInfo = LOG_ACTIONS[l.action] || LOG_ACTIONS.default;
                        return `<tr>
                            <td style="text-align:center;"><div style="width:40px; height:40px; background:${logInfo.color}1A; color:${logInfo.color}; border-radius:50%; display:flex; align-items:center; justify-content:center; margin-left:auto;"><i class="fa-solid ${logInfo.icon}"></i></div></td>
                            <td><strong style="color:var(--primary-dark);">${logInfo.title}</strong><br><small style="color:var(--text-light); font-family:monospace;">${l.action}</small></td>
                            <td style="font-weight:600;">${l.user}</td><td><span style="background:var(--secondary-light); padding:2px 8px; border-radius:4px; font-family:monospace;">${l.articleId || 'N/A'}</span></td>
                            <td style="max-width:350px; white-space:normal; line-height:1.7; color:var(--secondary);">${l.details}</td>
                            <td style="direction:ltr; text-align:right; color:var(--text-light); font-size:0.9rem;">${formatDate(l.timestamp)}</td>
                        </tr>`;
                    }).join('') || `<tr><td colspan="6" style="text-align:center; padding:40px; color:var(--text-light);">موردی برای نمایش یافت نشد.</td></tr>`}
                </tbody>
            </table></div>`;
        
        if (visibleLogsCount < currentLogsList.length) {
            html += `<div style="text-align:center; padding: 25px; border-top:1px solid var(--border-color); background:#f8fafc;"><button class="btn-secondary" onclick="loadMoreLogs()"><i class="fas fa-chevron-down"></i> مشاهده ۲۰ رویداد بعدی (صفحه بعد)</button></div>`;
        }
        container.innerHTML = html;
    }

    function loadMoreLogs() {
        visibleLogsCount += 20;
        renderLogsTable();
    }

    async function executeLogSearch() {
        const query = document.getElementById('server-log-search').value.trim();
        const btn = document.getElementById('server-log-search-btn');

        if (!query) {
            currentLogsList = [...appState.data.logs].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            visibleLogsCount = 20;
            renderLogsTable();
            return;
        }

        btn.classList.add('btn-loading');
        document.getElementById('logs-table-container').innerHTML = `<div class="loader-wrapper"><div class="loader"></div></div>`;

        const response = await callApi('searchLogs', { query });
        btn.classList.remove('btn-loading');

        if (response && response.status === 'success') {
            currentLogsList = response.logs.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            visibleLogsCount = 20;
            renderLogsTable();
        } else {
            document.getElementById('logs-table-container').innerHTML = `<div style="text-align:center; color:var(--danger); padding:40px;">خطا در جستجوی لاگ‌ها</div>`;
        }
    }
    
    // باز شدن مودال مقاله و صفحه‌بندی لاگ‌های داخل آن (دستور 1)
    async function showArticleDetailsModal(articleId) {
        showModal('پرونده جامع مقاله', `<div class="loader-wrapper"><div class="loader"></div></div>`, 'modal-lg');

        let details = appState.data.articles.find(a => String(a.articleId) === String(articleId));
        let history = appState.data.logs.filter(h => String(h.articleId) === String(articleId)).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

        if (!details || !details.abstract) {
            const response = await callApi('getArticleDetails', { articleId });
            if (!response) { closeModal('main-modal'); return; }
            details = response.data.details;
            history = response.data.history;
        } else {
            await new Promise(r => setTimeout(r, 50));
        }
        
        currentModalHistoryList = history;
        visibleModalHistoryCount = 20;

        const modalBody = `
            <div id="article-modal-tabs">
                <button class="active" onclick="switchArticleTab('actions', this)"><i class="fas fa-tasks"></i> وضعیت و تصمیم‌گیری</button>
                <button onclick="switchArticleTab('content', this)"><i class="fas fa-file-alt"></i> متون و محتوا</button>
                <button onclick="switchArticleTab('history', this)"><i class="fas fa-history"></i> تاریخچه وقایع</button>
            </div>
            <div id="actions-content" class="tab-content">
                <h3 style="color:var(--primary-dark); line-height:1.6; font-size:1.3rem; margin-bottom:20px;">${details.title}</h3>
                <div style="background:#f8fafc; padding:20px; border-radius:var(--radius-md); border:1px solid var(--border-color); margin-bottom:25px; display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div><span style="color:var(--text-light); font-size:0.9rem; display:block;">شناسه سیستمی:</span> <strong>${details.articleId}</strong></div>
                    <div><span style="color:var(--text-light); font-size:0.9rem; display:block;">وضعیت فعلی:</span> ${getStatusBadge(details.articleStatus || details.status)}</div>
                    <div><span style="color:var(--text-light); font-size:0.9rem; display:block;">محقق:</span> <strong>${details.researcherName}</strong></div>
                    <div><span style="color:var(--text-light); font-size:0.9rem; display:block;">استاد راهنما:</span> <strong>${details.supervisorName}</strong></div>
                    ${details.knowledgeArea ? `<div style="grid-column: 1 / -1;"><span style="color:var(--text-light); font-size:0.9rem; display:block;">حوزه پژوهشی:</span> <strong>${details.knowledgeArea}</strong></div>` : ''}
                </div>
                <h4 style="border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px;">پنل تصمیم‌گیری</h4>
                <div id="admin-actions"></div>
            </div>
            <div id="content-content" class="tab-content hidden content-accordion" style="max-height: 55vh; overflow-y:auto; padding-right:5px;">
               ${Object.entries({
                   'چکیده مقاله': details.abstract, 'کلیدواژگان': details.keywords, 'مقدمه و طرح مسئله': details.introduction, 
                   'بدنه اصلی تحقیق': details.body, 'نتیجه‌گیری': details.conclusion, 'منابع و مآخذ': details.references
               }).map(([title, content]) => `<details><summary><i class="fas fa-chevron-left" style="font-size:0.8rem; margin-left:10px; color:var(--primary);"></i> ${title}</summary><div class="content-panel">${content || '<span style="color:var(--text-light); font-style:italic;">محتوایی ثبت نشده است.</span>'}</div></details>`).join('')}
            </div>
            <div id="history-content" class="tab-content hidden" style="max-height: 55vh; overflow-y: auto; padding: 10px;">
                 <div id="modal-history-container"></div>
            </div>`;
            
        updateModalContent('main-modal', modalBody);
        renderModalHistoryTable();
        
        const actionsContainer = document.getElementById('admin-actions');
        const artStatus = String(details.articleStatus || details.status);
        if (artStatus === '6') {
             actionsContainer.innerHTML = `<p style="color:var(--secondary); font-size:1.05rem; margin-bottom:20px;"><i class="fas fa-info-circle" style="color:var(--info);"></i> این مقاله تاییدیه استاد راهنما را دریافت کرده و هم‌اکنون منتظر تصمیم نهایی هیئت تحریریه است.</p>
                <div style="display:flex; gap: 15px; flex-wrap:wrap;">
                    <button class="btn-success" id="accept-btn" onclick="handleDecisionClick('${articleId}', 'accept', null, this)" style="flex-grow:1; padding:15px; font-size:1.05rem;"><i class="fas fa-check-circle fa-lg"></i> تایید و پذیرش نهایی</button>
                    <button class="btn-warning" onclick="showReasonModal('${articleId}', 'revise')" style="flex-grow:1; padding:15px;"><i class="fas fa-undo"></i> نیازمند ویرایش مجدد</button>
                    <button class="btn-danger" onclick="showReasonModal('${articleId}', 'reject')" style="flex-grow:1; padding:15px;"><i class="fas fa-times-circle"></i> رد مقاله</button>
                </div>`;
        } else {
            actionsContainer.innerHTML = `<div style="text-align:center; padding: 40px; background:#f8fafc; border-radius:var(--radius-md); border:1px dashed var(--border-color);">
                <i class="fas fa-lock fa-3x" style="color:#cbd5e1; margin-bottom:15px;"></i>
                <p style="color:var(--secondary); font-size:1.05rem; margin:0;">در وضعیت فعلی مقاله (${getStatusBadge(artStatus).replace(/<[^>]+>/g, '')})، پرونده جهت تصمیم‌گیری مدیر قفل می‌باشد.</p>
            </div>`;
        }
        document.getElementById('main-modal-footer').innerHTML = `<button class="btn-danger" onclick="handleDownloadPDF('${articleId}', this)" style="margin-left:auto;"><span class="btn-text"><i class="fas fa-file-pdf"></i> خروجی PDF کامل</span></button> <button class="btn-secondary" onclick="closeModal('main-modal')">بستن پنجره</button>`;
    }
    
    function renderModalHistoryTable() {
        const container = document.getElementById('modal-history-container');
        if(!container) return;
        const listToShow = currentModalHistoryList.slice(0, visibleModalHistoryCount);
        
        let html = `<ul class="history-timeline">${listToShow.map(h => {
             const logInfo = LOG_ACTIONS[h.action] || LOG_ACTIONS.default;
             return `<li class="timeline-item"><div class="timeline-icon" style="background-color:${logInfo.color}1A; color:${logInfo.color};"><i class="fa-solid ${logInfo.icon}"></i></div><div class="timeline-content"><div class="timeline-header"><span>${logInfo.title}</span><span style="direction:ltr; background:#f1f5f9; padding:2px 8px; border-radius:12px; font-size:0.85rem; font-weight:normal;">${formatDate(h.timestamp)}</span></div><p style="font-size:0.9rem; margin:5px 0; color:var(--secondary);">کاربر عامل: <strong>${h.user}</strong></p><p class="timeline-details" style="margin:0;">${h.details || ''}</p></div></li>`
         }).join('')}</ul>`;
         
        if (visibleModalHistoryCount < currentModalHistoryList.length) {
            html += `<div style="text-align:center; margin-top:20px; padding-top:15px; border-top:1px solid var(--border-color);"><button class="btn-light" onclick="loadMoreModalHistory()"><i class="fas fa-chevron-down"></i> بارگذاری لاگ‌های قدیمی‌تر (صفحه بعد)</button></div>`;
        }
        container.innerHTML = html;
    }
    
    function loadMoreModalHistory() {
        visibleModalHistoryCount += 20;
        renderModalHistoryTable();
    }
    
    async function handleDecisionClick(articleId, decision, reason, button) {
        const res = await callApi('decideOnArticle', { articleId, decision, reason }, button);
        if (res) {
            showToast(res.message, 'success');
            closeModal('main-modal');
            appState.data.articles = res.updatedData.articles;
            appState.data.publications = res.updatedData.publications;
            renderArticlesViewInit();
        }
    }
    async function handleCreateIssue(e) {
        const issueNumber = document.getElementById('new-issue-number').value;
        const publishDate = document.getElementById('new-issue-date').value;
        if(!issueNumber || !publishDate) { showToast('لطفا هر دو فیلد را به دقت پر کنید.', 'error'); return; }
        const res = await callApi('createPublicationIssue', { issueNumber, publishDate }, e.target);
        if(res) { 
            showToast(res.message, 'success'); 
            appState.data.publications.issues = res.updatedIssues;
            renderPublicationsView();
        }
    }
    async function handleAssignArticles(e) {
        const selectedArticles = Array.from(document.querySelectorAll('.article-checkbox:checked')).map(cb => cb.value);
        const issueNumber = document.getElementById('issue-select').value;
        if(selectedArticles.length === 0 || !issueNumber) { showToast('حداقل یک مقاله و یک دوره باید انتخاب شوند.', 'error'); return; }
        const res = await callApi('assignArticlesToIssue', { articleIds: selectedArticles, issueNumber }, e.target);
        if(res) { 
            showToast(res.message, 'success'); 
            appState.data.articles = res.updatedArticles;
            appState.data.publications = res.updatedPublications;
            renderPublicationsView();
        }
    }
    async function handleDeleteIssue(issueNumber, button) {
        if (!confirm(`هشدار: آیا از حذف کامل شماره نشر ${issueNumber} اطمینان دارید؟`)) return;
        const res = await callApi('deletePublicationIssue', { issueNumber }, button);
        if (res) {
            showToast(res.message, 'success');
            appState.data.publications.issues = res.updatedIssues;
            renderPublicationsView();
        }
    }
    async function handleCreateUser(button) {
        const userData = { name: document.getElementById('user-name').value, nid: document.getElementById('user-nid').value, pass: document.getElementById('user-pass').value };
        const userType = document.getElementById('user-type').value;
        if(!userData.name || !userData.nid || !userData.pass) { showToast('تکمیل تمام فیلدها الزامی است.', 'error'); return; }
        const res = await callApi('createUser', { userData, userType }, button);
        if(res) { 
            showToast(res.message, 'success'); 
            closeModal('main-modal');
            appState.data.users = res.updatedUsers;
            renderUsersView();
        }
    }
    async function handleUpdateUser(button) {
        const oldNid = document.getElementById('user-nid-old').value;
        const userData = { name: document.getElementById('user-name-edit').value, nid: document.getElementById('user-nid-edit').value, pass: document.getElementById('user-pass-edit').value };
        const userType = document.getElementById('user-type-edit').value;
         if(!userData.name || !userData.nid) { showToast('ثبت نام و شناسه (کد ملی) اجباری است.', 'error'); return; }
        const res = await callApi('updateUser', { oldNid, userData, userType }, button);
        if (res) {
            showToast(res.message, 'success');
            closeModal('main-modal');
            appState.data.users = res.updatedUsers;
            renderUsersView();
        }
    }
    async function handleBatchCreateUsers(button, parsedData, userType) {
        if (!parsedData || parsedData.length === 0) { showToast('داده معتبری در فایل یافت نشد.', 'error'); return; }
        const res = await callApi('batchCreateUsers', { users: parsedData, userType }, button);
        if (res) {
            showToast(res.message, 'success');
            closeModal('main-modal');
            appState.data.users = res.updatedUsers;
            renderUsersView();
        }
    }

    function showReasonModal(articleId, decision) {
        const title = decision === 'reject' ? 'ثبت دلیل رد نهایی' : 'ثبت دلیل بازگشت جهت ویرایش';
        const content = `<div class="form-group"><label>توضیحات و دلایل هیئت تحریریه را مرقوم فرمایید:</label><textarea id="decision-reason" rows="6" style="resize:vertical;"></textarea></div>`;
        showModal(title, content, 'modal-md');
        document.getElementById('main-modal-footer').innerHTML = `<button class="btn-light" onclick="closeModal('main-modal')">لغو و بازگشت</button>
            <button id="confirm-decision-btn" class="${decision === 'reject' ? 'btn-danger' : 'btn-warning'}" onclick="handleDecisionClick('${articleId}', '${decision}', document.getElementById('decision-reason').value, this)"><i class="fas fa-paper-plane"></i> تایید و ابلاغ تصمیم</button>`;
    }
    function showCreateUserModal() {
        const content = `
            <div class="form-group"><label>نقش و سطح دسترسی</label><select id="user-type"><option value="researcher">پژوهشگر / نویسنده</option><option value="professor">استاد راهنما</option></select></div>
            <div class="form-group"><label>نام و نام خانوادگی رسمی</label><input type="text" id="user-name"></div>
            <div class="form-group"><label>شناسه کاربری (کد ملی)</label><input type="text" id="user-nid" dir="ltr" style="text-align:left;"></div>
            <div class="form-group"><label>گذرواژه اولیه</label><input type="text" id="user-pass" dir="ltr" style="text-align:left;"></div>`;
        showModal('ثبت‌نام کاربر جدید', content, 'modal-md');
        document.getElementById('main-modal-footer').innerHTML = `<button class="btn-light" onclick="closeModal('main-modal')">انصراف</button><button class="btn-success" onclick="handleCreateUser(this)"><i class="fas fa-check"></i> ثبت اطلاعات در سیستم</button>`;
    }
    function showEditUserModal(nid, type) {
        const user = appState.data.users[type].find(u => u.nid == nid);
        if (!user) return;
        const content = `
            <input type="hidden" id="user-nid-old" value="${user.nid}">
            <input type="hidden" id="user-type-edit" value="${type}">
            <div class="form-group"><label>نام و نام خانوادگی رسمی</label><input type="text" id="user-name-edit" value="${user.name}"></div>
            <div class="form-group"><label>شناسه کاربری (کد ملی)</label><input type="text" id="user-nid-edit" value="${user.nid}" dir="ltr" style="text-align:left;"></div>
            <div class="form-group"><label>بروزرسانی گذرواژه</label><input type="text" id="user-pass-edit" placeholder="جهت حفظ گذرواژه قبلی، این فیلد را خالی رها کنید" dir="ltr" style="text-align:left;"></div>`;
        showModal('ویرایش پروفایل کاربر', content, 'modal-md');
        document.getElementById('main-modal-footer').innerHTML = `<button class="btn-light" onclick="closeModal('main-modal')">انصراف</button><button class="btn-primary" onclick="handleUpdateUser(this)"><i class="fas fa-save"></i> اعمال تغییرات</button>`;
    }
    function showImportUsersModal() {
        const content = `
            <p style="color:var(--secondary); margin-bottom:20px;">فایل Excel حاوی اطلاعات کاربران را انتخاب نموده و یا در این کادر رها کنید.</p>
            <div id="drop-area">
                <input type="file" id="file-input" accept=".xlsx, .xls" style="display: none;">
                <i class="fas fa-file-excel fa-3x" style="color:var(--success); margin-bottom:15px;"></i>
                <p style="font-size:0.95rem; margin:0;">قالب استاندارد: ستون اول (A): نام کامل، ستون دوم (B): کد ملی، ستون سوم (C): گذرواژه</p>
            </div>
            <div id="file-info"></div>
            <div id="import-actions" class="hidden" style="margin-top: 25px; background:#f8fafc; padding:20px; border-radius:var(--radius-md); border:1px solid var(--border-color);">
                <p style="font-weight:bold; margin-top:0;">تخصیص سطح دسترسی به فایل بارگذاری شده:</p>
                <div style="display:flex; gap:15px;">
                    <button class="btn-secondary" id="import-researchers-btn" style="flex:1;"><i class="fas fa-user"></i> ثبت به عنوان پژوهشگر</button>
                    <button class="btn-primary" id="import-professors-btn" style="flex:1;"><i class="fas fa-user-tie"></i> ثبت به عنوان استاد</button>
                </div>
            </div>`;
        showModal('درون‌ریزی گروهی (Excel)', content, 'modal-md');
        setupExcelDropArea();
    }
    
    function showAssignedArticlesModal(issueNumber) {
        const assignedArticles = appState.data.articles.filter(a => String(a.issueNumber) === String(issueNumber));
        const content = `
            <div style="background:var(--secondary-light); padding:15px 20px; border-radius:var(--radius-md); border-right:4px solid var(--info); margin-bottom:20px; font-weight:800; color:var(--primary-dark);">تعداد کل مقالات مندرج: ${assignedArticles.length} عدد</div>
            <ul style="list-style:none; padding:0; margin:0; max-height: 400px; overflow-y:auto;">
                ${assignedArticles.map(a => `
                    <li style="border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 15px 20px; margin-bottom: 10px; display:flex; justify-content:space-between; align-items:center; background:#fff;">
                        <div style="line-height:1.8;">
                            <strong style="color:var(--primary-dark); font-size:1.1rem; display:block;">${a.title}</strong>
                            <span style="font-size:0.9rem; color:var(--text-light);"><i class="fas fa-user"></i> محقق: <strong>${a.researcherName}</strong> &nbsp;|&nbsp; <i class="fas fa-user-tie"></i> استاد: <strong>${a.supervisorName}</strong></span>
                        </div>
                        <button class="btn-light" title="دریافت نسخه چاپی PDF" onclick="handleDownloadPDF('${a.articleId}', this)"><i class="fas fa-file-pdf" style="color:var(--danger); font-size:1.3rem;"></i></button>
                    </li>
                `).join('') || '<li style="text-align:center; padding:30px; color:var(--text-light); background:#f8fafc; border-radius:var(--radius-md);">هیچ مقاله‌ای به این دوره متصل نشده است.</li>'}
            </ul>`;
        showModal(`لیست مقالات دوره ${issueNumber}`, content, 'modal-lg');
    }
    
    // توابع کمکی 
    function showModal(title, content, sizeClass = '') {
        closeModal('main-modal');
        document.getElementById('modal-container').innerHTML = `<div class="modal-overlay" id="main-modal" onclick="if (event.target.id === 'main-modal') closeModal('main-modal');"><div class="modal-box ${sizeClass}"><div class="modal-header"><h3>${title}</h3><button onclick="closeModal('main-modal')" style="background:none; border:none; font-size: 1.8rem; cursor:pointer; color: var(--text-light); transition:color 0.2s;">&times;</button></div><div class="modal-body">${content}</div><div class="modal-footer" id="main-modal-footer"></div></div></div>`;
        document.querySelector('.modal-header button').addEventListener('mouseover', function() { this.style.color = 'var(--danger)'; });
        document.querySelector('.modal-header button').addEventListener('mouseout', function() { this.style.color = 'var(--text-light)'; });
    }
    function updateModalContent(modalId, newContent) {
        const modal = document.getElementById(modalId);
        if (modal) modal.querySelector('.modal-body').innerHTML = newContent;
    }
    function closeModal(id) { document.getElementById(id)?.remove(); }
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        let icon = 'fa-info-circle';
        if(type==='success') icon = 'fa-check-circle';
        if(type==='error') icon = 'fa-times-circle';
        if(type==='warning') icon = 'fa-exclamation-triangle';
        
        toast.innerHTML = `<i class="fas ${icon} fa-lg"></i> <span>${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => { toast.remove(); }, 4000);
    }
    
    function getStatusBadge(status) {
        const s = String(status).trim();
        const map = {
            '1': { t: 'در دست بررسی استاد', c: 'primary' },
            '2': { t: 'نیازمند ویرایش (محقق)', c: 'warning' },
            '3': { t: 'انصراف کاربر', c: 'secondary' },
            '4': { t: 'انصراف استاد', c: 'danger' },
            '5': { t: 'تایید نهایی برای نشر', c: 'success' },
            '0': { t: 'رد شده (عدم نشر)', c: 'danger' },
            '6': { t: 'منتظر تصمیم نشریه', c: 'warning' },
            '9': { t: 'پیش‌نویس اولیه', c: 'secondary' },
            '10': { t: 'نیاز به ویرایش مجدد (نشریه)', c: 'info' },
            '11': { t: 'ارسال نهایی به استاد', c: 'primary-dark' },
            '12': { t: 'دریافت نسخه ویرایش شده', c: 'primary' },
            '13': { t: 'آماده ارسال به نشریه', c: 'success' }
        };
        const info = map[s] || { t: `وضعیت نامشخص (${s})`, c: 'secondary' };
        return `<span class="status-badge" style="background-color: var(--${info.c}); color:white;">${info.t}</span>`;
    }
    
    function filterTable(tableBodyId, searchTerm) {
        const rows = document.getElementById(tableBodyId).rows;
        const term = searchTerm.toLowerCase();
        for (let row of rows) row.style.display = (row.textContent || row.innerText).toLowerCase().includes(term) ? '' : 'none';
    }
    function formatDate(dateString, includeTime = true) {
        if (!dateString || isNaN(new Date(dateString))) return '-';
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        if (includeTime) { options.hour = '2-digit'; options.minute = '2-digit'; }
        return new Date(dateString).toLocaleDateString('fa-IR', options);
    }
    
    function setupExcelDropArea() {
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        let parsedData = [];

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }));
        ['dragenter', 'dragover'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight')));
        ['dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight')));
        
        dropArea.onclick = () => fileInput.click();
        fileInput.onchange = e => handleFile(e.target.files[0]);
        dropArea.ondrop = e => handleFile(e.dataTransfer.files[0]);

        function handleFile(file) {
            if (!file) return;
            document.getElementById('file-info').innerHTML = `<i class="fas fa-file-excel"></i> ${file.name}`;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    parsedData = jsonData.slice(1).map(row => ({ name: row[0], nid: row[1], pass: row[2] })).filter(u => u.name && u.nid && u.pass);
                    if(parsedData.length > 0) {
                        document.getElementById('import-actions').classList.remove('hidden');
                        document.getElementById('file-info').innerHTML += `<br><span style="color:var(--success); font-weight:normal; font-size:0.9rem;">تعداد ${parsedData.length} رکورد معتبر خوانده شد.</span>`;
                    } else {
                        document.getElementById('file-info').innerHTML += `<br><span style="color:var(--danger); font-weight:normal; font-size:0.9rem;">هیچ رکورد معتبری مطابق قالب یافت نشد.</span>`;
                    }
                } catch(err) {
                    showToast('خطا در پردازش فایل اکسل.', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        document.getElementById('import-researchers-btn').onclick = (e) => handleBatchCreateUsers(e.target, parsedData, 'researcher');
        document.getElementById('import-professors-btn').onclick = (e) => handleBatchCreateUsers(e.target, parsedData, 'professor');
    }

    function handleExportExcel() {
        const dataToExport = appState.data.articles.map(a => ({
            'عنوان مقاله': a.title, 'نام محقق': a.researcherName, 'کد ملی محقق': a.researcherId,
            'استاد راهنما': a.supervisorName, 'کد ملی استاد': a.supervisorId,
            'حوزه پژوهشی': a.knowledgeArea || 'ثبت نشده',
            'وضعیت پرونده': getStatusBadge(a.status).replace(/<[^>]+>/g, ''),
            'تاریخ ثبت اولیه': formatDate(a.requestDate, false), 'تاریخ تایید نهایی': formatDate(a.acceptanceDate, false)
        }));
        const ws = XLSX.utils.json_to_sheet([{ A: `تاریخ تهیه گزارش سیستمی: ${formatDate(new Date())}` }], { skipHeader: true });
        XLSX.utils.sheet_add_json(ws, dataToExport, { origin: 'A2' });
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "بانک مقالات");
        XLSX.writeFile(wb, `Articles_Export_${new Date().toLocaleDateString('fa-IR').replace(/\//g,'-')}.xlsx`);
    }

    // <<<< دستور 1: رفع هنگ سیستم حین تولید PDF و نمایش پیام انتظار >>>>
    // <<<< دستور 5 و 6: تنظیم حاشیه بالا/پایین و اصلاح کلمات به هم ریخته >>>>
    async function handleDownloadPDF(articleId, button) {
        if (button) button.classList.add('btn-loading');
        
        let details = appState.data.articles.find(a => String(a.articleId) === String(articleId));
        if (!details || !details.abstract) {
            const response = await callApi('getArticleDetails', { articleId });
            if (!response) { if (button) button.classList.remove('btn-loading'); return; }
            details = response.data.details;
        }

        const downloadOverlay = document.getElementById('download-overlay');
        downloadOverlay.classList.remove('hidden');
        
        // استراحت ۱۰۰ میلی‌ثانیه‌ای به مرورگر تا پیام لودینگ را قبل از قفل کردن رندر کند
        await new Promise(r => setTimeout(r, 100));

        const renderContainer = document.getElementById('pdf-render-container');
        
        let content = `
            <div style="text-align:center; margin-bottom: 25px; border-bottom: 2px solid #000; padding-bottom:15px;"><h1 style="font-size:24px; font-weight: 800; line-height:1.5;">${details.title}</h1></div>
            <p style="font-size: 15px;"><strong>پژوهشگر / نویسنده:</strong> ${details.researcherName}</p>
            <p style="font-size: 15px;"><strong>استاد راهنما:</strong> ${details.supervisorName}</p>
            ${details.knowledgeArea ? `<p style="font-size: 15px;"><strong>حوزه دانشی:</strong> ${details.knowledgeArea}</p>` : ''}
            <p style="font-size: 15px;"><strong>تاریخ ثبت در سامانه:</strong> ${formatDate(details.requestDate, false)}</p>
            <hr style="margin: 25px 0; border:1px solid #ccc;">
            <h2 style="font-size: 19px; font-weight: 800; color:#1e3a8a;">چکیده مقاله</h2><p style="font-size: 14.5px; line-height: 2;">${details.abstract || '-'}</p>
            <p style="font-size: 14.5px; margin-top:15px;"><strong>کلیدواژگان:</strong> ${details.keywords || '-'}</p>
            <div style="page-break-before: always;"></div>
            <h2 style="font-size: 19px; font-weight: 800; color:#1e3a8a;">مقدمه و طرح مسئله</h2><div style="font-size: 14.5px; line-height: 2; white-space: pre-line;">${details.introduction || '-'}</div>
            <div style="page-break-before: always;"></div>
            <h2 style="font-size: 19px; font-weight: 800; color:#1e3a8a;">بدنه اصلی تحقیق</h2><div style="font-size: 14.5px; line-height: 2; white-space: pre-line;">${details.body || '-'}</div>
            <div style="page-break-before: always;"></div>
            <h2 style="font-size: 19px; font-weight: 800; color:#1e3a8a;">نتیجه‌گیری</h2><div style="font-size: 14.5px; line-height: 2; white-space: pre-line;">${details.conclusion || '-'}</div>
            <div style="page-break-before: always;"></div>
            <h2 style="font-size: 19px; font-weight: 800; color:#1e3a8a;">فهرست منابع و مآخذ</h2><div style="font-size: 14.5px; line-height: 2; white-space: pre-line;" dir="ltr">${details.references || '-'}</div>`;
        
        renderContainer.innerHTML = content;
        
        html2canvas(renderContainer, { scale: 3, useCORS: true }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const marginX = 20; // 20mm حاشیه چپ و راست
            const marginY = 25; // 25mm حاشیه بالا و پایین (دستور 5)
            
            const imgProps = pdf.getImageProperties(imgData);
            const ratio = imgProps.height / imgProps.width;
            const canvasWidth = pdfWidth - (2 * marginX);
            const canvasHeight = canvasWidth * ratio;

            let heightLeft = canvasHeight;
            let position = 0;
            
            pdf.addImage(imgData, 'PNG', marginX, marginY, canvasWidth, canvasHeight);
            pdf.setFontSize(10);
            pdf.text('1', marginX, pdfHeight - 10);
            heightLeft -= (pdfHeight - (2 * marginY));
            let page = 1;

            while (heightLeft > 0) {
                position -= (pdfHeight - (2 * marginY));
                pdf.addPage();
                page++;
                pdf.addImage(imgData, 'PNG', marginX, position + marginY, canvasWidth, canvasHeight);
                heightLeft -= (pdfHeight - (2 * marginY));
                pdf.setFontSize(10);
                pdf.text(String(page), (page % 2 === 0 ? pdfWidth - marginX : marginX), pdfHeight - 10);
            }

            pdf.save(`Document_${details.articleId}.pdf`);
            renderContainer.innerHTML = '';
            
            downloadOverlay.classList.add('hidden');
            if (button) button.classList.remove('btn-loading');
        }).catch(err => {
            console.error('PDF Error:', err);
            downloadOverlay.classList.add('hidden');
            if (button) button.classList.remove('btn-loading');
            showToast('خطا در تولید فایل PDF رخ داد.', 'error');
        });
    }

</script>
</body>
</html>
