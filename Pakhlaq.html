
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>سامانه جامع پایش اخلاق | نسخه حرفه‌ای</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-body: #f1f5f9;
            --surface: #ffffff;
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --success-dark: #047857;
            --danger: #ef4444;
            --danger-dark: #b91c1c;
            --neutral: #64748b;
            --text-main: #0f172a;
            --text-light: #64748b;
            --border-radius: 18px;
            --shadow: 0 4px 15px -3px rgba(0,0,0,0.1), 0 2px 6px -2px rgba(0,0,0,0.05);
            --card-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Vazirmatn', sans-serif;
            margin: 0; padding: 0; padding-bottom: 110px;
            overflow-x: hidden;
            position: relative;
        }

        .container { max-width: 600px; margin: 0 auto; padding: 15px; }

        /* --- Header Area --- */
        .top-bar {
            display: flex; justify-content: space-between; align-items: stretch;
            margin-bottom: 20px; gap: 10px; height: 45px;
        }

        .manifesto-btn {
            flex: 1;
            background: var(--surface); color: var(--primary);
            border: 1px solid var(--primary); 
            border-radius: 12px; font-size: 0.8rem; font-weight: bold;
            display: flex; align-items: center; justify-content: center; gap: 6px; 
            cursor: pointer; box-shadow: var(--shadow); transition: 0.2s;
            padding: 0 10px; min-width: 0;
        }
        .manifesto-btn.read { background: var(--success); color: white; border-color: var(--success); }

        .date-navigator {
            flex: 1;
            display: flex; align-items: center; justify-content: space-between;
            background: var(--surface); padding: 0 8px;
            border-radius: 12px; box-shadow: var(--shadow);
            border: 1px solid #e2e8f0;
            min-width: 0;
        }
        .date-btn { background: none; border: none; color: var(--text-main); font-size: 1rem; cursor: pointer; display: flex; align-items: center; padding: 5px; }
        .date-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .date-text { font-weight: bold; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- Dynamic Score Card --- */
        .score-card {
            color: white; padding: 25px; border-radius: 24px;
            text-align: center; box-shadow: var(--card-shadow);
            margin-bottom: 25px; transition: background 0.5s ease;
            position: relative; overflow: hidden;
        }
        
        .score-card.neutral { background: linear-gradient(135deg, #64748b 0%, #475569 100%); }
        .score-card.positive { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .score-card.negative { background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); }

        .main-score { font-size: 4rem; font-weight: 900; line-height: 1; text-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .score-label { font-size: 0.9rem; opacity: 0.9; letter-spacing: 1px; margin-bottom: 5px; }
        
        .sub-scores {
            display: flex; justify-content: space-around; margin-top: 20px;
            background: rgba(0,0,0,0.15); padding: 10px; border-radius: 16px;
        }
        .sub-score-item { display: flex; flex-direction: column; }
        .sub-val { font-weight: 800; font-size: 1.2rem; }
        .sub-lbl { font-size: 0.75rem; opacity: 0.8; }

        /* --- Modern Card Design --- */
        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin: 25px 0 10px 0; padding: 0 5px;
        }
        .section-title { font-size: 1.1rem; font-weight: 800; display: flex; align-items: center; gap: 8px; }
        .virtue-text { color: var(--success-dark); }
        .vice-text { color: var(--danger-dark); }

        .modern-card {
            background: var(--surface); border-radius: 20px;
            margin-bottom: 15px; box-shadow: var(--shadow);
            display: flex; align-items: stretch; overflow: hidden;
            transition: transform 0.1s;
            min-height: 100px;
            position: relative;
            z-index: 1;
        }
        .modern-card:active { transform: scale(0.98); }

        /* Side Buttons */
        .card-btn {
            width: 60px; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.4rem; color: white; transition: background 0.2s, filter 0.2s;
        }
        
        /* Virtue Colors */
        .virtue .card-btn.minus { background: #cbd5e1; color: #475569; }
        .virtue .card-btn.plus { background: #10b981; color: white; }
        .virtue .card-btn.plus:active { filter: brightness(0.9); }

        /* Vice Colors */
        .vice .card-btn.minus { background: #cbd5e1; color: #475569; }
        .vice .card-btn.plus { background: #ef4444; color: white; }
        .vice .card-btn.plus:active { filter: brightness(0.9); }

        /* Center Content */
        .card-info {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 8px 5px; text-align: center;
            border-top: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9;
        }
        .card-title { font-weight: 800; font-size: 1.05rem; color: var(--text-main); margin-bottom: 6px; }
        .card-meta { display: flex; gap: 6px; justify-content: center; align-items: center; flex-wrap: wrap; margin-bottom: 5px; }
        .meta-badge {
            font-size: 0.75rem; padding: 3px 8px; border-radius: 6px;
            background: #f1f5f9; color: var(--text-light); font-weight: bold;
        }
        .meta-badge.count {
            background: var(--text-main); color: white;
        }
        .next-threshold {
            font-size: 0.75rem; font-weight:bold;
            padding: 4px 10px; border-radius: 50px;
            display: inline-flex; align-items: center; gap: 5px;
            margin-top: 4px;
        }
        .next-threshold.reward { color: #047857; background: #d1fae5; border: 1px solid #a7f3d0; }
        .next-threshold.penalty { color: #b91c1c; background: #fee2e2; border: 1px solid #fecaca; }

        /* --- PROFESSIONAL ANIMATIONS --- */
        
        /* 1. Confetti (Flower) Effect - Original style kept for backup */
        .confetti {
            position: absolute;
            width: 8px; height: 8px;
            background-color: #ffd700;
            animation: fall linear forwards;
            z-index: 9999;
            pointer-events: none;
            border-radius: 50%;
        }
        @keyframes fall {
            0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; }
            100% { transform: translateY(100px) rotate(720deg) scale(0); opacity: 0; }
        }

        /* 2. Red Screen Shake & Overlay (For Negative) */
        @keyframes shakeScreen {
            0% { transform: translate(0, 0); }
            10% { transform: translate(-5px, -5px); }
            20% { transform: translate(5px, 5px); }
            30% { transform: translate(-5px, 5px); }
            40% { transform: translate(5px, -5px); }
            50% { transform: translate(-5px, 0); }
            60% { transform: translate(5px, 0); }
            100% { transform: translate(0, 0); }
        }
        
        body.shake-effect {
            animation: shakeScreen 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        body.shake-effect::after {
            content: '';
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(239, 68, 68, 0.15); /* Red Overlay */
            pointer-events: none; z-index: 10000;
            animation: fadeOutOverlay 0.5s forwards;
        }

        /* 3. Green Screen Overlay & Star System (For Positive) */
        body.green-flash-effect::after {
            content: '';
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(16, 185, 129, 0.3); /* Green Overlay */
            pointer-events: none; z-index: 10000;
            animation: fadeOutOverlay 1s forwards;
        }

        @keyframes fadeOutOverlay { from { opacity: 1; } to { opacity: 0; } }

        /* Star Particle Style */
        .star-particle {
            position: fixed;
            z-index: 10001;
            pointer-events: none;
            color: #FFD700;
            font-size: 20px;
            filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.7));
        }

        /* --- Settings Grid --- */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }
        .setting-block {
            background: white; border-radius: 20px;
            padding: 20px 10px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            text-align: center;
            box-shadow: var(--shadow);
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            aspect-ratio: 1/1;
            border: 1px solid transparent;
        }
        .setting-block:active { transform: scale(0.96); }
        .setting-block i { font-size: 2rem; margin-bottom: 10px; color: var(--primary); }
        .setting-block span { font-weight: bold; font-size: 0.9rem; color: var(--text-main); }
        
        .setting-block.danger { border-color: #fee2e2; }
        .setting-block.danger i { color: var(--danger); }
        
        /* --- Action List --- */
        .action-item {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px;
            display: flex; align-items: center; gap: 12px; box-shadow: var(--shadow);
            border: 1px solid #f1f5f9; cursor: pointer;
        }
        .action-checkbox {
            width: 24px; height: 24px; border-radius: 6px; border: 2px solid #cbd5e1;
            display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;
        }
        .action-checkbox.checked { background: var(--success); border-color: var(--success); color: white; }
        .action-content { flex: 1; }
        .action-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
        .badge-reward { background: #d1fae5; color: #065f46; }
        .badge-penalty { background: #fee2e2; color: #991b1b; }

        /* Stats Summary Box */
        .stats-summary-card {
            background: var(--surface); padding: 15px; border-radius: 12px; box-shadow: var(--shadow);
            display: flex; justify-content: space-around; margin-bottom: 20px;
        }
        .stat-box { text-align: center; cursor: pointer; padding: 10px; border-radius: 8px; transition: background 0.2s; width: 45%; }
        .stat-box:active { background: #f1f5f9; }
        .stat-num { font-size: 1.5rem; font-weight: bold; display: block; }
        .stat-label { font-size: 0.8rem; color: var(--text-light); }
        .stat-reward { color: var(--success); border: 1px solid #d1fae5; }
        .stat-penalty { color: var(--danger); border: 1px solid #fee2e2; }

        /* --- Trigger Alert Box --- */
        .trigger-box {
            background: #fff7ed; border: 1px solid #ffedd5; border-radius: 16px;
            padding: 15px; margin-bottom: 20px; display: none;
            animation: slideDown 0.3s ease;
        }
        .trigger-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-weight: bold; }
        .trigger-actions { display: flex; gap: 10px; }
        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; font-size: 0.9rem; }
        .btn-accept { background: var(--primary); color: white; flex: 1; }
        .btn-change { background: white; border: 1px solid #cbd5e1; color: var(--text-light); }
        .btn-danger-outline { background: white; border: 1px solid var(--danger); color: var(--danger); }
        .btn-danger { background: var(--danger); color: white; border:none; }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Bottom Nav --- */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; background: white;
            display: flex; justify-content: space-around; padding: 12px 0;
            border-top: 1px solid #f1f5f9; box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
            z-index: 900;
        }
        .nav-item {
            background: none; border: none; display: flex; flex-direction: column;
            align-items: center; color: #94a3b8; gap: 5px; font-size: 0.7rem; cursor: pointer;
        }
        .nav-item i { font-size: 1.4rem; }
        .nav-item.active { color: var(--primary); }

        /* --- Modals & Layers --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(3px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
        
        #manifestoModal { z-index: 2000; }
        #nameModal { z-index: 2000; }
        #clearDataModal { z-index: 2000; }
        #editorModal { z-index: 2000; }
        #dateRangeModal { z-index: 2000; }
        #backupModal { z-index: 2000; } 
        
        #actionListPopupModal { z-index: 2100; }
        #editFormModal { z-index: 2100; }
        #actionDetailModal { z-index: 2200; }

        .modal-content {
            background: white; width: 90%; max-width: 500px; border-radius: 20px;
            padding: 20px; max-height: 90vh; overflow-y: auto;
            position: relative;
        }

        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-size: 0.9rem; font-weight: bold; }
        .form-input, .form-select { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-family: inherit; }
        .list-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f1f5f9; }
        .btn-icon { background: none; border: none; color: var(--text-light); cursor: pointer; font-size: 1rem; }
        .btn-icon.edit { color: var(--primary); }
        .btn-icon.delete { color: var(--danger); }
        
        .search-box { margin-bottom: 15px; position: relative; }
        .search-box input { width: 100%; padding: 10px 35px 10px 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-family: inherit; }
        .search-box i { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: var(--text-light); }

        .manifesto-content {
            font-size: 0.95rem; line-height: 1.8; text-align: justify;
            background: #f8fafc; padding: 15px; border-radius: 12px;
            max-height: 60vh; overflow-y: auto; border: 1px solid #e2e8f0;
            margin: 15px 0;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .list-toggle { display: flex; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; margin-bottom: 15px; }
        .toggle-btn { flex: 1; padding: 10px; border: none; background: white; cursor: pointer; font-weight: bold; color: var(--text-light); }
        .toggle-btn.active { background: var(--primary); color: white; }
        
        .detail-row { margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .detail-label { font-weight: bold; font-size: 0.85rem; color: var(--text-light); display: block; }
        .detail-value { font-size: 1rem; }

    </style>
</head>
<body>

<div id="app">

<!-- TAB: HOME -->
<div id="tab-home" class="tab-content active">
    <div class="container">
        
        <div class="top-bar">
            <button class="manifesto-btn" onclick="openManifestoModal()">
                <i class="fas fa-book-open" id="manifestoIcon"></i> <span id="manifestoBtnText">منشور اخلاقی</span>
            </button>
            <div class="date-navigator">
                <button class="date-btn" onclick="navigateDate(-1)"><i class="fas fa-chevron-right"></i></button>
                <div class="date-text" id="headerDateDisplay">...</div>
                <button class="date-btn" id="nextDayBtn" onclick="navigateDate(1)" disabled><i class="fas fa-chevron-left"></i></button>
            </div>
        </div>

        <div class="score-card neutral" id="scoreCard">
            <div class="score-label">تراز امروز</div>
            <div class="main-score" id="totalScoreDisplay">0</div>
            <div class="sub-scores">
                <div class="sub-score-item">
                    <span class="sub-val" id="posScoreDisplay">0</span>
                    <span class="sub-lbl">مثبت</span>
                </div>
                <div class="sub-score-item">
                    <span class="sub-val" id="negScoreDisplay">0</span>
                    <span class="sub-lbl">منفی</span>
                </div>
            </div>
        </div>

        <div id="triggerArea"></div>

        <div id="homePendingSummary" class="stats-summary-card" style="margin-bottom: 20px; display:none;">
            <div class="stat-box stat-reward" onclick="openActionListModal('reward', false)">
                <span class="stat-num" id="pendingRewardCount">0</span>
                <span class="stat-label">پاداش مانده</span>
            </div>
            <div class="stat-box stat-penalty" onclick="openActionListModal('penalty', false)">
                <span class="stat-num" id="pendingPenaltyCount">0</span>
                <span class="stat-label">جریمه مانده</span>
            </div>
        </div>

        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="homeSearch" placeholder="جستجو در رفتارها..." oninput="filterHomeList()">
        </div>

        <div class="section-header">
            <span class="section-title virtue"><i class="fas fa-check-circle"></i> فضایل</span>
        </div>
        <div id="virtuesList"></div>

        <div class="section-header">
            <span class="section-title vice"><i class="fas fa-times-circle"></i> رذایل</span>
        </div>
        <div id="vicesList"></div>

    </div>
</div>

<!-- TAB: ACTIONS -->
<div id="tab-actions" class="tab-content">
    <div class="container">
        <h2 style="margin-top:0;">کارنامه عملی</h2>
        
        <div class="stats-summary-card">
            <div class="stat-box stat-reward" onclick="filterActionsTab('reward')">
                <span class="stat-num" id="totalRewardCount">0</span>
                <span class="stat-label">کل پاداش‌ها</span>
            </div>
            <div class="stat-box stat-penalty" onclick="filterActionsTab('penalty')">
                <span class="stat-num" id="totalPenaltyCount">0</span>
                <span class="stat-label">کل جریمه‌ها</span>
            </div>
        </div>

        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="actionsSearch" placeholder="جستجو در کارنامه..." oninput="renderActionsTab()">
        </div>

        <div style="margin-bottom: 15px; display:flex; gap:10px; overflow-x:auto; padding-bottom:5px;">
             <div class="stat-box" style="min-width:100px; background:#f0f9ff;" onclick="openActionListModal(null, true)">
                <span class="stat-num" id="totalDoneCount">0</span>
                <span class="stat-label">انجام شده</span>
            </div>
            <div class="stat-box" style="min-width:100px; background:#fff1f2;" onclick="openActionListModal(null, false)">
                <span class="stat-num" id="totalPendingCount">0</span>
                <span class="stat-label">انجام نشده</span>
            </div>
             <div class="stat-box" style="min-width:120px; background:#fef3c7;" onclick="openDateRangeStats()">
                <span class="stat-num"><i class="fas fa-calendar-alt"></i></span>
                <span class="stat-label">آمار بازه زمانی</span>
            </div>
        </div>

        <div id="actionsListFull"></div>
    </div>
</div>

<!-- TAB: SETTINGS -->
<div id="tab-settings" class="tab-content">
    <div class="container">
        <h2>تنظیمات</h2>
        
        <div class="settings-grid">
            <div class="setting-block" onclick="openEditor('behavior')">
                <i class="fas fa-list-check"></i>
                <span>مدیریت رفتارها</span>
            </div>

            <div class="setting-block" onclick="openEditor('rule')">
                <i class="fas fa-gavel"></i>
                <span>پیکربندی عواقب</span>
            </div>

            <div class="setting-block" onclick="openBackupModal()">
                <i class="fas fa-save"></i>
                <span>پشتیبان‌گیری</span>
            </div>

            <div class="setting-block danger" onclick="openClearDataModal()">
                <i class="fas fa-trash-alt"></i>
                <span>پاکسازی</span>
            </div>
        </div>
        
        <br><br><br>
    </div>
</div>
</div>

<!-- NAVIGATION -->
<div class="nav-bar">
    <button class="nav-item active" onclick="switchTab('home')">
        <i class="fas fa-home"></i>
        <span>امروز</span>
    </button>
    <button class="nav-item" onclick="switchTab('actions')">
        <i class="fas fa-clipboard-list"></i>
        <span>اقدامات</span>
    </button>
    <button class="nav-item" onclick="switchTab('settings')">
        <i class="fas fa-cog"></i>
        <span>تنظیمات</span>
    </button>
</div>

<!-- MODAL: MANIFESTO -->
<div id="manifestoModal" class="modal-overlay">
    <div class="modal-content" style="position:relative; max-height:85vh; display:flex; flex-direction:column;">
        <div style="position:absolute; top:15px; left:15px; z-index:10; cursor:pointer;" onclick="document.getElementById('manifestoModal').style.display='none'">
            <i class="fas fa-times" style="font-size:1.2rem; color:var(--text-light);"></i>
        </div>
        <h3 style="text-align:center; color:var(--primary); margin-top:0;">مرور عهدنامه</h3>
        <div class="manifesto-content" id="manifestoTextContainer"></div>
        <button id="manifestoConfirmBtn" class="btn btn-accept" style="width:100%; opacity:0.5;" disabled onclick="confirmManifestoRead()">تایید و تعهد</button>
        <p style="text-align:center; font-size:0.75rem; color:red; margin-top:5px;">(لطفاً تا انتها مطالعه کنید)</p>
    </div>
</div>

<!-- MODAL: ONBOARDING -->
<div id="nameModal" class="modal-overlay">
    <div class="modal-content" style="text-align:center;">
        <h3>خوش آمدید</h3>
        <p>لطفاً نام خود را برای ثبت در منشور وارد کنید:</p>
        <input type="text" id="userNameInput" class="form-input" placeholder="نام شما..." style="text-align:center; font-size:1.2rem;">
        <br><br>
        <button class="btn btn-accept" onclick="saveName()">ثبت و شروع</button>
    </div>
</div>

<!-- MODAL: BACKUP -->
<div id="backupModal" class="modal-overlay">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0">پشتیبان‌گیری</h3>
            <i class="fas fa-times" style="cursor:pointer; font-size:1.2rem;" onclick="document.getElementById('backupModal').style.display='none'"></i>
        </div>
        <p style="font-size:0.9rem; color:var(--text-light);">برای ذخیره اطلاعات خود یا بازگردانی فایل قبلی استفاده کنید.</p>
        
        <button class="btn btn-accept" style="width:100%; margin-bottom:15px;" onclick="backupData()">
            <i class="fas fa-download"></i> دانلود فایل پشتیبان
        </button>
        
        <div style="border-top:1px solid #eee; padding-top:15px;">
             <input type="file" id="restoreFile" style="display:none" onchange="restoreData(this)">
             <button class="btn btn-change" style="width:100%;" onclick="document.getElementById('restoreFile').click()">
                 <i class="fas fa-upload"></i> بازگردانی اطلاعات
             </button>
        </div>
    </div>
</div>

<!-- MODAL: CLEAR DATA -->
<div id="clearDataModal" class="modal-overlay">
    <div class="modal-content" style="position:relative;">
        <div style="position:absolute; top:15px; left:15px; cursor:pointer;" onclick="document.getElementById('clearDataModal').style.display='none'">
            <i class="fas fa-times" style="font-size:1.2rem; color:var(--text-light);"></i>
        </div>
        <h3 style="color:var(--danger)">حذف اطلاعات</h3>
        <p>لطفاً بازه زمانی را انتخاب کنید:</p>
        <div class="form-group">
            <label><input type="radio" name="clearOption" value="today" checked> امروز</label>
        </div>
        <div class="form-group">
            <label><input type="radio" name="clearOption" value="all"> تمام اطلاعات (بازگشت به تنظیمات کارخانه)</label>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-danger" style="flex:1" onclick="performClearData()">حذف کن</button>
            <button class="btn btn-change" style="flex:1" onclick="document.getElementById('clearDataModal').style.display='none'">انصراف</button>
        </div>
    </div>
</div>

<!-- MODAL: EDITOR -->
<div id="editorModal" class="modal-overlay">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 id="editorTitle" style="margin:0">ویرایش</h3>
            <i class="fas fa-times" style="cursor:pointer; font-size:1.2rem;" onclick="closeEditor()"></i>
        </div>
        <div id="ruleListToggle" class="list-toggle" style="display:none;">
            <button class="toggle-btn active" onclick="toggleRuleList('virtue')" id="toggleVirtueBtn">فضایل/پاداش</button>
            <button class="toggle-btn" onclick="toggleRuleList('vice')" id="toggleViceBtn">رذایل/جریمه</button>
        </div>
        <div class="search-box" style="margin-bottom:10px;">
             <i class="fas fa-search"></i>
             <input type="text" id="editorSearch" placeholder="جستجو..." oninput="filterEditorList()">
        </div>
        <div id="editorListContainer" style="max-height:300px; overflow-y:auto; margin-bottom:20px;"></div>
        <button class="btn btn-accept" onclick="openEditForm(null)" style="width:100%">+ افزودن مورد جدید</button>
    </div>
</div>

<!-- MODAL: EDIT FORM -->
<div id="editFormModal" class="modal-overlay">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 id="formTitle" style="margin:0">افزودن/ویرایش</h3>
            <i class="fas fa-times" style="cursor:pointer; font-size:1.2rem;" onclick="closeEditForm()"></i>
        </div>
        <input type="hidden" id="editId" value="">
        <div id="behaviorFields" style="display:none;">
            <div class="form-group">
                <input type="text" id="behTitle" class="form-input" placeholder="عنوان رفتار">
            </div>
            <div class="form-group" style="display:flex; gap:10px;">
                <select id="behType" class="form-select">
                    <option value="virtue">فضیلت (مثبت)</option>
                    <option value="vice">رذیلت (منفی)</option>
                </select>
                <input type="number" id="behWeight" class="form-input" placeholder="امتیاز" value="1">
            </div>
        </div>
        <div id="ruleFields" style="display:none;">
            <div class="form-group">
                <label class="form-label">نوع شرط:</label>
                <select id="ruleType" class="form-select" onchange="toggleRuleInputs()">
                    <option value="total_pos">مجموع امتیاز مثبت روزانه</option>
                    <option value="total_neg">مجموع امتیاز منفی روزانه</option>
                    <option value="total_net">امتیاز خالص (برآیند)</option>
                    <option value="specific">رفتار خاص</option>
                </select>
            </div>
            <div class="form-group" id="specificBehDiv" style="display:none;">
                <label class="form-label">انتخاب رفتار:</label>
                <select id="ruleTargetId" class="form-select" onchange="updateRuleResultTypeBasedOnTarget()"></select>
                <div id="ruleAutoTypeIndicator" style="font-size:0.8rem; margin-top:5px; padding:5px; border-radius:4px; display:inline-block;"></div>
            </div>
            <div class="form-group">
                <label class="form-label">حد نصاب (تعداد/امتیاز):</label>
                <input type="number" id="ruleThreshold" class="form-input" placeholder="مثلا 20">
            </div>
            <div class="form-group">
                <label class="form-label">نتیجه (خودکار تعیین می‌شود):</label>
                <div style="display:flex; gap:5px;">
                     <input type="text" id="ruleResultTypeDisplay" class="form-input" style="width:80px; background:#eee; color:#555;" disabled>
                     <input type="hidden" id="ruleResultType">
                    <input type="text" id="ruleResultText" class="form-input" placeholder="مثلا: دیدن فیلم">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">محدوده زمانی (اختیاری):</label>
                <div style="display:flex; gap:5px; align-items:center;">
                    <span>از</span>
                    <input type="time" id="ruleStartTime" class="form-input">
                    <span>تا</span>
                    <input type="time" id="ruleEndTime" class="form-input">
                </div>
            </div>
            <div class="form-group">
                <label style="font-size:0.8rem; display:flex; align-items:center; gap:5px;">
                    <input type="checkbox" id="ruleIsSpecific"> این پاداش/جریمه اختصاصی است (تصادفی انتخاب نشود)
                </label>
            </div>
        </div>
        <button class="btn btn-accept" style="width:100%; margin-top:15px;" onclick="saveEditorItem()">ذخیره</button>
    </div>
</div>

<!-- MODAL: ACTION DETAILS -->
<div id="actionDetailModal" class="modal-overlay">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 id="actionDetailTitle" style="margin:0">جزئیات اقدام</h3>
            <i class="fas fa-times" style="cursor:pointer; font-size:1.2rem;" onclick="document.getElementById('actionDetailModal').style.display='none'"></i>
        </div>
        <div id="actionDetailContent"></div>
        <div style="margin-top:20px; text-align:right;">
             <button class="btn btn-outline" onclick="document.getElementById('actionDetailModal').style.display='none'">بستن</button>
        </div>
    </div>
</div>

<!-- MODAL: ACTION LIST POPUP -->
<div id="actionListPopupModal" class="modal-overlay">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 id="actionListPopupTitle" style="margin:0">لیست</h3>
            <i class="fas fa-times" style="cursor:pointer; font-size:1.2rem;" onclick="document.getElementById('actionListPopupModal').style.display='none'"></i>
        </div>
        <div id="actionListPopupContent"></div>
    </div>
</div>

<!-- MODAL: DATE RANGE STATS -->
<div id="dateRangeModal" class="modal-overlay">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">آمار بازه زمانی</h3>
            <i class="fas fa-times" style="cursor:pointer; font-size:1.2rem;" onclick="document.getElementById('dateRangeModal').style.display='none'"></i>
        </div>
        <div class="form-group">
            <label>تاریخ شروع:</label>
            <input type="date" id="statStartDate" class="form-input">
        </div>
        <div class="form-group">
            <label>تاریخ پایان:</label>
            <input type="date" id="statEndDate" class="form-input">
        </div>
        <button class="btn btn-accept" onclick="calcDateRangeStats()">محاسبه</button>
        <div id="rangeStatsResult" style="margin-top:20px; display:none;">
            <div class="sub-scores" style="background:#f8fafc; padding:15px;">
                <div class="sub-score-item"><span>مثبت:</span> <strong id="rsPos" style="color:var(--success)"></strong></div>
                <div class="sub-score-item"><span>منفی:</span> <strong id="rsNeg" style="color:var(--danger)"></strong></div>
                <div class="sub-score-item"><span>کل:</span> <strong id="rsTotal"></strong></div>
            </div>
            <div class="list-row"><span>تعداد پاداش‌ها:</span> <strong id="rsRewards"></strong></div>
            <div class="list-row"><span>تعداد جریمه‌ها:</span> <strong id="rsPenalties"></strong></div>
            <div class="list-row" onclick="showRangeActionDetails(true)" style="cursor:pointer; color:var(--primary);">
                <span>انجام شده (کلیک کنید):</span> <strong id="rsDone"></strong>
            </div>
            <div class="list-row" onclick="showRangeActionDetails(false)" style="cursor:pointer; color:var(--danger);">
                <span>انجام نشده (کلیک کنید):</span> <strong id="rsPending"></strong>
            </div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. DATA STRUCTURE & INITIALIZATION
    // ==========================================
    
    const DEFAULT_DATA = {
        user: { name: "" },
        behaviors: [
            // Virtues
            { id: 'v1', title: 'خردورزی', type: 'virtue', weight: 5 },
            { id: 'v2', title: 'انضباط شخصی', type: 'virtue', weight: 4 },
            { id: 'v3', title: 'صداقت', type: 'virtue', weight: 5 },
            { id: 'v4', title: 'مسئولیت‌پذیری', type: 'virtue', weight: 4 },
            { id: 'v5', title: 'همدلی', type: 'virtue', weight: 3 },
            { id: 'v6', title: 'کمک به همنوع', type: 'virtue', weight: 5 },
            { id: 'v7', title: 'کنترل خشم', type: 'virtue', weight: 6 },
            { id: 'v8', title: 'احترام به حریم‌ها', type: 'virtue', weight: 3 },
            { id: 'v9', title: 'شکرگزاری', type: 'virtue', weight: 2 },
            { id: 'v10', title: 'یادگیری مستمر', type: 'virtue', weight: 4 },
            { id: 'v11', title: 'نظافت و آراستگی', type: 'virtue', weight: 2 },
            { id: 'v12', title: 'وفای به عهد', type: 'virtue', weight: 5 },
            { id: 'v13', title: 'عدالت و انصاف', type: 'virtue', weight: 5 },
            { id: 'v14', title: 'شجاعت', type: 'virtue', weight: 4 },
            { id: 'v15', title: 'تاب‌آوری', type: 'virtue', weight: 3 },
            { id: 'v16', title: 'رازداری', type: 'virtue', weight: 4 },
            { id: 'v17', title: 'سحرخیزی', type: 'virtue', weight: 3 },
            { id: 'v18', title: 'سکوتِ آگاهانه', type: 'virtue', weight: 2 },
            { id: 'v19', title: 'حفظ محیط زیست', type: 'virtue', weight: 2 },
            { id: 'v20', title: 'عزت نفس', type: 'virtue', weight: 4 },
            // Vices
            { id: 'x1', title: 'دروغ', type: 'vice', weight: 5 },
            { id: 'x2', title: 'غیبت', type: 'vice', weight: 4 },
            { id: 'x3', title: 'توهین و فحاشی', type: 'vice', weight: 4 },
            { id: 'x4', title: 'تهمت', type: 'vice', weight: 6 },
            { id: 'x5', title: 'سخن‌چینی', type: 'vice', weight: 4 },
            { id: 'x6', title: 'تنبلی و اهمال', type: 'vice', weight: 3 },
            { id: 'x7', title: 'حسادت', type: 'vice', weight: 3 },
            { id: 'x8', title: 'قضاوت عجولانه', type: 'vice', weight: 3 },
            { id: 'x9', title: 'پرخوری یا پرخوابی', type: 'vice', weight: 2 },
            { id: 'x10', title: 'اسراف', type: 'vice', weight: 2 },
            { id: 'x11', title: 'تکبر و خودبرتربینی', type: 'vice', weight: 4 },
            { id: 'x12', title: 'بدقولی', type: 'vice', weight: 4 },
            { id: 'x13', title: 'کنترل‌گری', type: 'vice', weight: 3 },
            { id: 'x14', title: 'قربانی‌نمایی', type: 'vice', weight: 3 },
            { id: 'x15', title: 'نگاه آلوده', type: 'vice', weight: 5 },
            { id: 'x16', title: 'کینه و انتقام‌جویی', type: 'vice', weight: 4 },
            { id: 'x17', title: 'خیانت', type: 'vice', weight: 6 },
            { id: 'x18', title: 'چاپلوسی', type: 'vice', weight: 3 },
            { id: 'x19', title: 'ناامیدی و پوچ‌گرایی', type: 'vice', weight: 4 },
            { id: 'x20', title: 'بی‌تفاوتی', type: 'vice', weight: 3 }
        ],
        rules: [
            // General Rules
            { id: 'r_total_pos', type: 'total_pos', targetId: null, threshold: 200, resultType: 'reward', resultText: 'تماشای فیلم یا سریال', isSpecific: false },
            { id: 'r_total_neg', type: 'total_neg', targetId: null, threshold: 300, resultType: 'penalty', resultText: '۲۰ شنا سوئدی اضافه', isSpecific: false },
            // Specific Rules (Virtues) with Concrete Rewards
            { id: 'rv1', type: 'specific', targetId: 'v1', threshold: 25, resultType: 'reward', resultText: 'خرید یک کتاب جدید', isSpecific: true },
            { id: 'rv2', type: 'specific', targetId: 'v2', threshold: 20, resultType: 'reward', resultText: 'یک وعده غذای مورد علاقه', isSpecific: true },
            { id: 'rv3', type: 'specific', targetId: 'v3', threshold: 25, resultType: 'reward', resultText: 'تماشای مستند علمی', isSpecific: true },
            { id: 'rv4', type: 'specific', targetId: 'v4', threshold: 20, resultType: 'reward', resultText: 'یک ساعت استراحت مطلق', isSpecific: true },
            { id: 'rv5', type: 'specific', targetId: 'v5', threshold: 15, resultType: 'reward', resultText: 'تماشای فیلم کمدی', isSpecific: true },
            { id: 'rv6', type: 'specific', targetId: 'v6', threshold: 25, resultType: 'reward', resultText: 'دعوت دوستان به قهوه', isSpecific: true },
            { id: 'rv7', type: 'specific', targetId: 'v7', threshold: 30, resultType: 'reward', resultText: 'خرید اشتراک مجله/سایت', isSpecific: true },
            { id: 'rv8', type: 'specific', targetId: 'v8', threshold: 15, resultType: 'reward', resultText: 'گوش دادن به پادکست', isSpecific: true },
            { id: 'rv9', type: 'specific', targetId: 'v9', threshold: 10, resultType: 'reward', resultText: 'نوشیدن دمنوش گیاهی', isSpecific: true },
            { id: 'rv10', type: 'specific', targetId: 'v10', threshold: 20, resultType: 'reward', resultText: 'ثبت نام در دوره آموزشی', isSpecific: true },
            { id: 'rv11', type: 'specific', targetId: 'v11', threshold: 10, resultType: 'reward', resultText: 'خرید عطر یا خوشبوکننده', isSpecific: true },
            { id: 'rv12', type: 'specific', targetId: 'v12', threshold: 25, resultType: 'reward', resultText: 'سفر کوتاه یک روزه', isSpecific: true },
            { id: 'rv13', type: 'specific', targetId: 'v13', threshold: 25, resultType: 'reward', resultText: 'خرید هدیه کوچک برای خود', isSpecific: true },
            { id: 'rv14', type: 'specific', targetId: 'v14', threshold: 20, resultType: 'reward', resultText: 'شهربازی یا تفریح هیجانی', isSpecific: true },
            { id: 'rv15', type: 'specific', targetId: 'v15', threshold: 15, resultType: 'reward', resultText: 'ماساژ یا استخر', isSpecific: true },
            { id: 'rv16', type: 'specific', targetId: 'v16', threshold: 20, resultType: 'reward', resultText: 'نوشتن در دفتر خاطرات', isSpecific: true },
            { id: 'rv17', type: 'specific', targetId: 'v17', threshold: 15, resultType: 'reward', resultText: 'مشاهده طلوع خورشید', isSpecific: true },
            { id: 'rv18', type: 'specific', targetId: 'v18', threshold: 10, resultType: 'reward', resultText: 'مراقبه در طبیعت', isSpecific: true },
            { id: 'rv19', type: 'specific', targetId: 'v19', threshold: 10, resultType: 'reward', resultText: 'کاشت یک گل یا گیاه', isSpecific: true },
            { id: 'rv20', type: 'specific', targetId: 'v20', threshold: 20, resultType: 'reward', resultText: 'شرکت در سمینار', isSpecific: true },
            // Specific Rules (Vices) with Concrete Penalties
            { id: 'rx1', type: 'specific', targetId: 'x1', threshold: 10, resultType: 'penalty', resultText: '۵۰ هزار تومان صدقه', isSpecific: true },
            { id: 'rx2', type: 'specific', targetId: 'x2', threshold: 8, resultType: 'penalty', resultText: 'عذرخواهی و حلالیت', isSpecific: true },
            { id: 'rx3', type: 'specific', targetId: 'x3', threshold: 8, resultType: 'penalty', resultText: '۲۰ دقیقه سکوت مطلق', isSpecific: true },
            { id: 'rx4', type: 'specific', targetId: 'x4', threshold: 12, resultType: 'penalty', resultText: 'خواندن ۱۰ صفحه کتاب اخلاق', isSpecific: true },
            { id: 'rx5', type: 'specific', targetId: 'x5', threshold: 8, resultType: 'penalty', resultText: 'شستن ظرف‌های خانه', isSpecific: true },
            { id: 'rx6', type: 'specific', targetId: 'x6', threshold: 9, resultType: 'penalty', resultText: '۱ ساعت کار مفید بدون گوشی', isSpecific: true },
            { id: 'rx7', type: 'specific', targetId: 'x7', threshold: 9, resultType: 'penalty', resultText: 'تعریف از موفقیت دیگران', isSpecific: true },
            { id: 'rx8', type: 'specific', targetId: 'x8', threshold: 9, resultType: 'penalty', resultText: 'نوشتن ۱۰ نکته مثبت فرد', isSpecific: true },
            { id: 'rx9', type: 'specific', targetId: 'x9', threshold: 6, resultType: 'penalty', resultText: 'حذف یک وعده دسر/شیرینی', isSpecific: true },
            { id: 'rx10', type: 'specific', targetId: 'x10', threshold: 6, resultType: 'penalty', resultText: 'کمک مالی به خیریه', isSpecific: true },
            { id: 'rx11', type: 'specific', targetId: 'x11', threshold: 12, resultType: 'penalty', resultText: 'نظافت راه پله یا مشاعات', isSpecific: true },
            { id: 'rx12', type: 'specific', targetId: 'x12', threshold: 12, resultType: 'penalty', resultText: 'جبران خسارت بدقولی', isSpecific: true },
            { id: 'rx13', type: 'specific', targetId: 'x13', threshold: 9, resultType: 'penalty', resultText: 'واگذاری تصمیم به دیگران', isSpecific: true },
            { id: 'rx14', type: 'specific', targetId: 'x14', threshold: 9, resultType: 'penalty', resultText: 'نوشتن ۵ نعمت زندگی', isSpecific: true },
            { id: 'rx15', type: 'specific', targetId: 'x15', threshold: 10, resultType: 'penalty', resultText: 'روزه چشمی (۱ ساعت)', isSpecific: true },
            { id: 'rx16', type: 'specific', targetId: 'x16', threshold: 12, resultType: 'penalty', resultText: 'هدیه دادن به فرد مقابل', isSpecific: true },
            { id: 'rx17', type: 'specific', targetId: 'x17', threshold: 15, resultType: 'penalty', resultText: 'توبه و جبران مافات', isSpecific: true },
            { id: 'rx18', type: 'specific', targetId: 'x18', threshold: 9, resultType: 'penalty', resultText: 'نقد پذیری آشکار', isSpecific: true },
            { id: 'rx19', type: 'specific', targetId: 'x19', threshold: 12, resultType: 'penalty', resultText: 'بازدید از آسایشگاه/بیمارستان', isSpecific: true },
            { id: 'rx20', type: 'specific', targetId: 'x20', threshold: 9, resultType: 'penalty', resultText: 'تماس با یک دوست قدیمی', isSpecific: true }
        ],
        logs: {} 
    };

    let db = JSON.parse(localStorage.getItem('EthicsDB_Final')) || JSON.parse(JSON.stringify(DEFAULT_DATA));
    let viewingDate = new Date();
    viewingDate.setHours(0,0,0,0);
    
    let currentEditorMode = null; 
    let currentRuleFilter = 'virtue';
    let editingItemId = null;
    let currentActionFilter = null; 
    let currentActionEditId = null; 
    let tempDateRangeResults = null; 

    // --- Helper: Persian Date Converter ---
    function getVerbalDate(date) {
        const weekDays = ['یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنج‌شنبه', 'جمعه', 'شنبه'];
        const months = ['فروردین','اردیبهشت','خرداد','تیر','مرداد','شهریور','مهر','آبان','آذر','دی','بهمن','اسفند'];
        
        const options = { year: 'numeric', month: 'numeric', day: 'numeric', weekday: 'long' };
        const parts = new Intl.DateTimeFormat('fa-IR', options).formatToParts(date);
        
        let y, m, d, wd;
        parts.forEach(p => {
            if(p.type === 'year') y = p.value;
            if(p.type === 'month') m = p.value;
            if(p.type === 'day') d = p.value;
            if(p.type === 'weekday') wd = p.value;
        });

        const parseFa = (s) => parseInt(s.replace(/[۰-۹]/g, c => c.charCodeAt(0) - 1776));
        const dayInt = parseFa(d);
        const yearInt = parseFa(y);
        const monthInt = parseFa(m); 

        const numToWord = (n) => {
            if (n === 0) return 'صفر';
            const ones = ['','یک','دو','سه','چهار','پنج','شش',' هفت','هشت','نه'];
            const teens = ['ده','یازده','دوازده','سیزده','چهارده','پانزده','شانزده','هفده','هجده','نوزده'];
            const tens = ['','','بیست','سی','چهل','پنجاه','شصت','هفتاد','هشتاد','نود'];
            const hundreds = ['','صد','دویست','سیصد','چهارصد','پانصد','ششصد','هفتصد','هشتصد','نهصد'];
            
            let str = '';
            
            if (n >= 1000) {
                const th = Math.floor(n / 1000);
                const rem = n % 1000;
                str += (th === 1 ? 'هزار' : ones[th] + ' هزار');
                if (rem > 0) str += ' و ' + numToWord(rem); 
                return str;
            }
            
            const h = Math.floor(n / 100);
            const t = Math.floor((n % 100) / 10);
            const o = n % 10;
            
            if (h > 0) { str += hundreds[h]; if(t>0 || o>0) str += ' و '; }
            if (t >= 2) {
                str += tens[t];
                if (o > 0) str += ' و ' + ones[o];
            } else if (t === 1) {
                str += teens[o];
            } else {
                str += ones[o];
            }
            return str;
        };

        const dayOrdinals = ["", "یکم", "دوم", "سوم", "چهارم", "پنجم", "ششم", "هفتم", "هشتم", "نهم", "دهم", 
                   "یازدهم", "دوازدهم", "سیزدهم", "چهاردهم", "پانزدهم", "شانزدهم", "هفدهم", "هجدهم", "نوزدهم", "بیستم",
                   "بیست و یکم", "بیست و دوم", "بیست و سوم", "بیست و چهارم", "بیست و پنجم", "بیست و ششم", "بیست و هفتم", "بیست و هشتم", "بیست و نهم", "سی‌ام", "سی و یکم"];
        
        const dayWord = dayOrdinals[dayInt];
        const yearWord = numToWord(yearInt);
        const monthNameStr = months[monthInt - 1];
        
        return `${wd}، ${dayWord} ${monthNameStr} ${yearWord}`;
    }
    
    function getHeaderDate(date) {
        const weekDayName = new Intl.DateTimeFormat('fa-IR', {weekday: 'long'}).format(date);
        const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
        const dateStr = new Intl.DateTimeFormat('fa-IR', options).format(date); 
        return `${weekDayName}، ${dateStr}`;
    }

    function getKey(date) { return date.toLocaleDateString('en-CA'); }

    function saveDB() { localStorage.setItem('EthicsDB_Final', JSON.stringify(db)); }

    // ==========================================
    // 2. INITIALIZATION
    // ==========================================
    
    window.onload = () => {
        if(!db.user.name) {
            document.getElementById('nameModal').style.display = 'flex';
        } else {
            initUI();
        }
    };

    function saveName() {
        const name = document.getElementById('userNameInput').value.trim();
        if(name) {
            db.user.name = name;
            saveDB();
            document.getElementById('nameModal').style.display = 'none';
            initUI();
        }
    }

    function initUI() {
        renderHome();
        const key = getKey(new Date());
        if(db.logs[key] && !db.logs[key].manifestoRead) {
            openManifestoModal();
        }
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        
        document.getElementById('tab-' + tabId).classList.add('active');
        
        const indices = { 'home': 0, 'actions': 1, 'settings': 2 };
        document.querySelectorAll('.nav-item')[indices[tabId]].classList.add('active');

        if (tabId === 'home') renderHome();
        if (tabId === 'actions') renderActionsTab();
    }

    // ==========================================
    // 3. HOME LOGIC
    // ==========================================

    function navigateDate(delta) {
        const newDate = new Date(viewingDate);
        newDate.setDate(newDate.getDate() + delta);
        newDate.setHours(0,0,0,0); 
        
        const today = new Date();
        today.setHours(0,0,0,0);
        
        if (newDate > today) return; 
        
        viewingDate = newDate;
        renderHome();
    }

    function renderHome() {
        const key = getKey(viewingDate);
        const todayKey = getKey(new Date());
        
        document.getElementById('headerDateDisplay').innerText = getHeaderDate(viewingDate);
        document.getElementById('nextDayBtn').disabled = (key === todayKey);

        if(!db.logs[key]) db.logs[key] = { behaviors: {}, actions: [], manifestoRead: false, consumed: {} };
        const log = db.logs[key];

        const manBtn = document.querySelector('.manifesto-btn');
        const manText = document.getElementById('manifestoBtnText');
        const manIcon = document.getElementById('manifestoIcon');

        if (log.manifestoRead) {
            manBtn.classList.add('read');
            manIcon.className = 'fas fa-check';
        } else {
            manBtn.classList.remove('read');
            manIcon.className = 'fas fa-book-open';
        }

        let totalScore = 0;
        let posScore = 0;
        let negScore = 0;

        const vContainer = document.getElementById('virtuesList');
        const xContainer = document.getElementById('vicesList');
        vContainer.innerHTML = '';
        xContainer.innerHTML = '';

        const searchTerm = document.getElementById('homeSearch').value.toLowerCase();

        db.behaviors.forEach(b => {
            if(searchTerm && !b.title.toLowerCase().includes(searchTerm)) return;

            const count = log.behaviors[b.id] || 0;
            const itemScore = count * b.weight;

            if (b.type === 'virtue') {
                totalScore += itemScore;
                posScore += itemScore;
            } else {
                totalScore -= itemScore;
                negScore += itemScore; 
            }

            // Calculation for Next Threshold (Logic: Remaining until NEXT trigger)
            // It calculates based on 'consumed' + 'threshold' vs 'current'
            let thresholdInfo = "";
            const specificRule = db.rules.find(r => r.type === 'specific' && r.targetId === b.id);
            if (specificRule) {
                 const consumed = log.consumed && log.consumed[specificRule.id] ? log.consumed[specificRule.id] : 0;
                 const currentVal = count * b.weight;
                 const nextTarget = consumed + specificRule.threshold;
                 const needed = nextTarget - currentVal;
                 
                 // Show info only if needed > 0. If <= 0, it means trigger is pending action.
                 if (needed > 0) {
                     const typeText = specificRule.resultType === 'reward' ? 'پاداش' : 'جریمه';
                     const typeClass = specificRule.resultType === 'reward' ? 'reward' : 'penalty';
                     thresholdInfo = `<div class="next-threshold ${typeClass}"><i class="fas fa-flag"></i> ${needed} امتیاز تا ${typeText}</div>`;
                 }
            }

            const html = `
                <div class="modern-card ${b.type}" id="card-${b.id}">
                    <button class="card-btn minus" onclick="updateCount('${b.id}', -1)">
                        <i class="fas fa-minus"></i>
                    </button>
                    <div class="card-info">
                        <div class="card-title">${b.title}</div>
                        <div class="card-meta">
                            <span class="meta-badge">ضریب: ${b.weight}</span>
                            <span class="meta-badge count">مرتبه: ${count}</span>
                        </div>
                        ${thresholdInfo}
                    </div>
                    <button class="card-btn plus" onclick="updateCount('${b.id}', 1)">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            `;

            if (b.type === 'virtue') vContainer.innerHTML += html;
            else xContainer.innerHTML += html;
        });

        document.getElementById('totalScoreDisplay').innerText = totalScore > 0 ? `+${totalScore}` : totalScore;
        document.getElementById('posScoreDisplay').innerText = posScore;
        document.getElementById('negScoreDisplay').innerText = negScore;

        const scoreCard = document.getElementById('scoreCard');
        scoreCard.className = 'score-card ' + (totalScore > 0 ? 'positive' : (totalScore < 0 ? 'negative' : 'neutral'));

        const pendingActions = log.actions.filter(a => !a.done);
        const pendingRewards = pendingActions.filter(a => a.type === 'reward').length;
        const pendingPenalties = pendingActions.filter(a => a.type === 'penalty').length;
        const pendingSummaryDiv = document.getElementById('homePendingSummary');
        
        if (pendingActions.length > 0) {
            pendingSummaryDiv.style.display = 'flex';
            document.getElementById('pendingRewardCount').innerText = pendingRewards;
            document.getElementById('pendingPenaltyCount').innerText = pendingPenalties;
        } else {
            pendingSummaryDiv.style.display = 'none';
        }

        checkTriggers(key, totalScore, posScore, negScore);
    }

    function filterHomeList() {
        renderHome();
    }

    // TRIGGER ANIMATION UTILITIES
    function explodeStarsFromSides() {
        const colors = ['#FFD700', '#FDB813', '#FFFACD'];
        for (let i = 0; i < 60; i++) { 
            const star = document.createElement('div');
            star.className = 'star-particle';
            star.innerHTML = '<i class="fas fa-star"></i>';
            
            // Randomize side
            const isLeft = Math.random() > 0.5;
            const startX = isLeft ? -50 : window.innerWidth + 50;
            const startY = Math.random() * window.innerHeight;
            
            star.style.left = `${startX}px`;
            star.style.top = `${startY}px`;
            star.style.color = colors[Math.floor(Math.random() * colors.length)];
            star.style.fontSize = `${Math.random() * 20 + 10}px`;
            
            document.body.appendChild(star);
            
            // Calculate destination (towards center-ish)
            const destX = isLeft ? startX + (Math.random() * 400 + 100) : startX - (Math.random() * 400 + 100);
            const destY = startY + (Math.random() * 200 - 100);
            
            star.animate([
                { transform: 'translate(0, 0) scale(0.5) rotate(0deg)', opacity: 1 },
                { transform: `translate(${destX - startX}px, ${destY - startY}px) scale(1.5) rotate(${Math.random()*360}deg)`, opacity: 0 }
            ], {
                duration: 1000 + Math.random() * 1000,
                easing: 'cubic-bezier(0.25, 1, 0.5, 1)',
                fill: 'forwards'
            });
            
            setTimeout(() => star.remove(), 2000);
        }
    }

    function triggerVisualEffect(type, rect) {
        if(type === 'reward') {
            document.body.classList.add('green-flash-effect');
            explodeStarsFromSides();
            setTimeout(() => document.body.classList.remove('green-flash-effect'), 1000);
        } else {
            // Red Shake
            document.body.classList.add('shake-effect');
            setTimeout(() => document.body.classList.remove('shake-effect'), 500);
        }
    }

    function updateCount(behId, delta) {
        const key = getKey(viewingDate);
        const log = db.logs[key];
        const currentCount = log.behaviors[behId] || 0;
        const newVal = currentCount + delta;
        
        if (newVal < 0) return;

        // Calculate Pre-State for Trigger Check
        const beh = db.behaviors.find(b => b.id === behId);
        const rule = db.rules.find(r => r.type === 'specific' && r.targetId === behId);
        
        let visualTriggered = false;

        if (rule) {
            const consumed = log.consumed && log.consumed[rule.id] ? log.consumed[rule.id] : 0;
            const oldTotal = currentCount * beh.weight;
            const newTotal = newVal * beh.weight;
            const threshold = rule.threshold;
            
            // Logic: Trigger ONLY if we cross a new threshold boundary relative to what was consumed.
            // i.e., previously we were below the next target, now we met or exceeded it.
            // Target is (consumed + threshold).
            const target = consumed + threshold;
            
            if (oldTotal < target && newTotal >= target) {
                // We just crossed the line!
                visualTriggered = true;
                const card = document.getElementById(`card-${behId}`);
                const rect = card ? card.getBoundingClientRect() : {left:window.innerWidth/2, top:window.innerHeight/2, width:0, height:0};
                triggerVisualEffect(rule.resultType, rect);
            }
        }

        log.behaviors[behId] = newVal;
        saveDB();
        
        // Delay render slightly so animation doesn't get cut by DOM refresh
        if(visualTriggered) {
            setTimeout(renderHome, 50); 
        } else {
            renderHome();
        }
    }

    // ==========================================
    // 4. TRIGGER LOGIC
    // ==========================================
    
    function checkTriggers(dateKey, total, posTotal, negTotal) {
        const log = db.logs[dateKey];
        const consumed = log.consumed || {};
        const triggerArea = document.getElementById('triggerArea');
        triggerArea.innerHTML = ''; 
        
        for (let rule of db.rules) {
            let currentValue = 0;
            let consumedValue = consumed[rule.id] || 0;

            if (rule.type === 'total_net') {
                currentValue = total;
                 if (rule.resultType === 'reward') {
                     if (currentValue - consumedValue >= rule.threshold) {
                         showTriggerAlert(rule);
                         break; 
                     }
                 } else {
                     if (currentValue <= (consumedValue - Math.abs(rule.threshold))) {
                         showTriggerAlert(rule);
                         break;
                     }
                 }
            } 
            else if (rule.type === 'total_pos') {
                currentValue = posTotal;
                if (currentValue - consumedValue >= rule.threshold) {
                     showTriggerAlert(rule);
                     break;
                }
            }
            else if (rule.type === 'total_neg') {
                currentValue = negTotal;
                if (currentValue - consumedValue >= rule.threshold) {
                     showTriggerAlert(rule);
                     break;
                }
            }
            else if (rule.type === 'specific') {
                const bId = rule.targetId;
                const b = db.behaviors.find(x => x.id === bId);
                if (!b) continue;
                const count = log.behaviors[bId] || 0;
                currentValue = count * b.weight; 
                
                if (currentValue - consumedValue >= rule.threshold) {
                     showTriggerAlert(rule);
                     break;
                }
            }
        }
    }

    function showTriggerAlert(rule) {
        const area = document.getElementById('triggerArea');
        area.style.display = 'block';
        
        const typeLabel = rule.resultType === 'reward' ? '🎉 پاداش:' : '⚠️ جریمه:';
        const color = rule.resultType === 'reward' ? 'var(--success)' : 'var(--danger)';
        const bg = rule.resultType === 'reward' ? '#ecfdf5' : '#fef2f2';

        area.innerHTML = `
            <div class="trigger-box" style="display:block; border-color:${color}; background:${bg}">
                <div class="trigger-header" style="color:${color}">
                    ${typeLabel} حد نصاب "${getRuleDescription(rule)}" پر شد.
                </div>
                <div style="margin-bottom:10px;">${rule.resultText}</div>
                <div class="trigger-actions">
                    <button class="btn btn-accept" onclick="acceptTrigger('${rule.id}')">ثبت در اقدامات</button>
                    <button class="btn btn-change" onclick="ignoreTrigger('${rule.id}')">نادیده گرفتن</button>
                </div>
            </div>
        `;
    }

    function getRuleDescription(rule) {
        if(rule.type === 'specific') {
            const b = db.behaviors.find(x => x.id === rule.targetId);
            return b ? b.title : 'رفتار حذف شده';
        }
        if(rule.type === 'total_pos') return 'مجموع مثبت';
        if(rule.type === 'total_neg') return 'مجموع منفی';
        return 'امتیاز کل';
    }

    function acceptTrigger(ruleId) {
        const key = getKey(viewingDate);
        const rule = db.rules.find(r => r.id === ruleId);
        const log = db.logs[key];

        const now = new Date();
        const timeStr = now.toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit', hour12:false});
        const dateStr = getVerbalDate(now);

        const prevActions = log.actions.filter(a => a.ruleId === ruleId);
        let timeRangeStr = "";
        
        if (prevActions.length === 0) {
            timeRangeStr = `از ۰۰:۰۰ تا ${timeStr}`;
        } else {
            const lastAction = prevActions[prevActions.length - 1];
            const lastTime = lastAction.rawTime || "۰۰:۰۰"; 
            timeRangeStr = `مابین ${lastTime} تا ${timeStr}`;
        }

        log.actions.push({
            id: Date.now(),
            ruleId: ruleId, 
            text: rule.resultText,
            type: rule.resultType,
            reason: getRuleDescription(rule), 
            dateStr: dateStr,
            timeRange: timeRangeStr, 
            rawTime: timeStr,
            done: false
        });

        if (!log.consumed[ruleId]) log.consumed[ruleId] = 0;
        
        if (rule.type === 'total_net' && rule.resultType === 'penalty') {
             log.consumed[ruleId] -= Math.abs(rule.threshold);
        } else {
             log.consumed[ruleId] += rule.threshold;
        }

        saveDB();
        document.getElementById('triggerArea').style.display = 'none'; 
        renderHome(); 
    }

    function ignoreTrigger() {
        document.getElementById('triggerArea').style.display = 'none';
    }

    // ==========================================
    // 5. MANIFESTO
    // ==========================================
    
    function openManifestoModal() {
        const name = db.user.name;
        
        const now = new Date();
        const dateStr = getVerbalDate(now);
        const h = now.getHours().toLocaleString('fa-IR');
        const m = now.getMinutes().toLocaleString('fa-IR').padStart(2,'۰');
        const formattedTime = `${h}:${m} دقیقه`;

        const text = `
            من <strong>${name}</strong> در تاریخ <strong>${dateStr}</strong> و ساعت <strong>${formattedTime}</strong> منشور اخلاقی‌ام را مرور می‌کنم.<br><br>
            
            <strong style="color:var(--primary);">منشور اخلاق</strong><br>
            من به این زندگی و فرصت یگانه‌ی آن احترام می‌گذارم.<br>
            اصلِ بنیادینِ من، کاهشِ رنج و ساختنِ دنیایی بهتر است.<br>
            من خرد و عقلانیت را راهنمای خود قرار می‌دهم.<br>
            من مسئولِ احساسات، انتخاب‌ها و آینده‌ی خود هستم.<br>
            بسیار سپاسگزارم برای نَفَسی که می‌کشم و توانی که برای تغییر دارم.<br><br>

            من متعهد می‌شوم که صادق باشم و با خود و دیگران صادقانه رفتار کنم.<br>
            من متعهد می‌شوم که به حریم خصوصی دیگران و تفاوت‌های انسان‌ها احترام بگذارم.<br>
            من متعهد می‌شوم که از خط قرمزهای آسیب به دیگران عبور نکنم.<br>
            من متعهد میشوم تا تلاش کنم امروز، نسخه‌ای قوی‌تر و مهربان‌تر از دیروزِ خود باشم.<br><br>

            من در برابرِ قوانینِ طبیعت و واقعیت‌های جهان سر فرود می‌آورم.<br>
            من آن‌چه را که در کنترلم نیست، می‌پذیرم.<br>
            من انعطاف‌پذیرم، مثل درخت در برابر باد و تعصب را رها می‌کنم تا نشکنم.<br>
            من طبیعت را دوست دارم و با آن درست رفتار می‌کنم.<br><br>

            در این لحظه تمامِ خشم‌ها، شهوت‌ها و غم‌هایم را به خاک می‌سپارم. در این لحظه دوباره شکوفا شدم و جان تازه‌ای گرفتم. من خودم را دوست دارم و به خودم احترام میگذارم... من در امنیت و آرامشم... من آرامـم...<br><br>

            من برای خودم و دیگران ارزش بسیاری قائل هستم و برای همگی قدرت، سلامتی، زیبایی، انصاف و عدالت آرزو می‌کنم. باشد که هیچ انسانی مورد ظلم واقع نشود و من نیز ابزارِ ظلم نباشم.<br>
            من گواهی می‌دهم که انسان هستم و کرامت دارم.<br>
            من گواهی می‌دهم که از عقل و خردم بهره ببرم و استفاده کنم.<br>
            من گواهی میدهم، فارق از هر دیدگاهی که دارم اخلاق مدار باشم و رفتاری انسان دوستانه داشته باشم.<br>
            گواهی می‌دهم ظلم نکنم، ستم نکنم و برای برپایی عدالت تلاش کنم.<br><br>

            درود بر من که ارزشمندم.<br>
            درود بر تمام انسان‌های نیک‌ و نیک‌اندیش.<br>
            درود بر صلح و آگاهی و عقلانیت.<br>
            پایان.
        `;

        const container = document.getElementById('manifestoTextContainer');
        container.innerHTML = text;
        
        const btn = document.getElementById('manifestoConfirmBtn');
        btn.disabled = true;
        btn.style.opacity = 0.5;
        
        container.scrollTop = 0;

        container.onscroll = function() {
            if(Math.ceil(container.offsetHeight + container.scrollTop) >= container.scrollHeight - 20) {
                btn.disabled = false;
                btn.style.opacity = 1;
            }
        };

        document.getElementById('manifestoModal').style.display = 'flex';
    }

    function confirmManifestoRead() {
        const key = getKey(new Date());
        if(!db.logs[key]) db.logs[key] = { behaviors: {}, actions: [], manifestoRead: false, consumed: {} };
        db.logs[key].manifestoRead = true;
        saveDB();
        document.getElementById('manifestoModal').style.display = 'none';
        renderHome();
    }

    // ==========================================
    // 6. ACTIONS LIST & POPUP
    // ==========================================

    function renderActionsTab() {
        const key = getKey(viewingDate);
        const actions = db.logs[key]?.actions || [];
        const container = document.getElementById('actionsListFull');
        const searchTerm = document.getElementById('actionsSearch').value.toLowerCase();

        container.innerHTML = '';

        const rewardCount = actions.filter(a => a.type === 'reward').length;
        const penaltyCount = actions.filter(a => a.type === 'penalty').length;
        document.getElementById('totalRewardCount').innerText = rewardCount;
        document.getElementById('totalPenaltyCount').innerText = penaltyCount;
        
        const doneCount = actions.filter(a => a.done).length;
        const pendingCount = actions.filter(a => !a.done).length;
        document.getElementById('totalDoneCount').innerText = doneCount;
        document.getElementById('totalPendingCount').innerText = pendingCount;

        let filteredActions = actions;
        
        if (currentActionFilter) {
            filteredActions = filteredActions.filter(a => a.type === currentActionFilter);
        }

        if (searchTerm) {
            filteredActions = filteredActions.filter(a => a.text.toLowerCase().includes(searchTerm) || a.reason.toLowerCase().includes(searchTerm));
        }

        if (filteredActions.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#999;">موردی یافت نشد.</p>';
            return;
        }

        filteredActions.forEach(a => {
            container.innerHTML += `
                <div class="action-item ${a.done ? 'done' : ''}" onclick="openActionDetail(${a.id})">
                    <div class="action-checkbox ${a.done ? 'checked' : ''}" onclick="event.stopPropagation(); toggleAction(${a.id})">
                        <i class="fas fa-check" style="${a.done ? '' : 'display:none'}"></i>
                    </div>
                    <div class="action-content">
                        <span class="action-badge ${a.type==='reward'?'badge-reward':'badge-penalty'}">${a.type==='reward'?'پاداش':'جریمه'}</span>
                        <span style="font-weight:bold; display:block; margin-top:4px;">${a.text}</span>
                        <div style="font-size:0.75rem; color:var(--text-light); margin-top:2px;">دلیل: ${a.reason}</div>
                    </div>
                    <i class="fas fa-trash btn-icon delete" onclick="event.stopPropagation(); deleteAction(${a.id})"></i>
                </div>
            `;
        });
    }
    
    function filterActionsTab(type) {
        if(currentActionFilter === type) currentActionFilter = null;
        else currentActionFilter = type;
        renderActionsTab();
    }

    function toggleAction(id, forcedKey = null) {
        const key = forcedKey || getKey(viewingDate);
        const action = db.logs[key]?.actions.find(a => a.id === id);
        if(action) {
            action.done = !action.done;
            saveDB();
            
            if (document.getElementById('dateRangeModal').style.display === 'flex') {
                 calcDateRangeStats();
                 const isDoneList = document.getElementById('actionListPopupTitle').innerText.includes('انجام شده');
                 showRangeActionDetails(isDoneList); 
            } else {
                renderActionsTab();
                renderHome(); 
                if(document.getElementById('actionListPopupModal').style.display === 'flex') {
                    const type = document.getElementById('actionListPopupTitle').innerText.includes('پاداش') ? 'reward' : (document.getElementById('actionListPopupTitle').innerText.includes('جریمه') ? 'penalty' : null);
                    const isDone = document.getElementById('actionListPopupTitle').innerText.includes('انجام شده');
                    openActionListModal(type, isDone);
                }
            }
        }
    }

    function deleteAction(id) {
        if(!confirm('حذف شود؟')) return;
        const key = getKey(viewingDate);
        db.logs[key].actions = db.logs[key].actions.filter(a => a.id !== id);
        saveDB();
        renderActionsTab();
    }

    function openActionListModal(type, doneStatus) {
        const key = getKey(viewingDate);
        const actions = db.logs[key]?.actions || [];
        const filtered = actions.filter(a => (type ? a.type === type : true) && a.done === doneStatus);
        
        const container = document.getElementById('actionListPopupContent');
        let title = "";
        if (type === 'reward') title = 'پاداش‌ها';
        else if (type === 'penalty') title = 'جریمه‌ها';
        else title = 'اقدامات';
        
        title += (doneStatus ? ' (انجام شده)' : ' (مانده)');
        document.getElementById('actionListPopupTitle').innerText = title;
        
        container.innerHTML = '';
        if(filtered.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#999">موردی نیست.</p>';
        } else {
            filtered.forEach(a => {
                container.innerHTML += `
                    <div class="action-item" onclick="openActionDetail(${a.id})">
                        <div class="action-checkbox ${a.done ? 'checked' : ''}" onclick="event.stopPropagation(); toggleAction(${a.id})">
                             <i class="fas fa-check" style="${a.done ? '' : 'display:none'}"></i>
                        </div>
                        <div class="action-content">
                            <span style="font-weight:bold;">${a.text}</span>
                            <div style="font-size:0.75rem; color:var(--text-light);">دلیل: ${a.reason}</div>
                        </div>
                    </div>
                `;
            });
        }
        
        document.getElementById('actionListPopupModal').style.display = 'flex';
    }

    function openActionDetail(id) {
        currentActionEditId = id;
        
        let key = getKey(viewingDate);
        let action = db.logs[key]?.actions.find(a => a.id === id);
        
        if(!action && tempDateRangeResults) {
             const tempObj = tempDateRangeResults.find(a => a.id === id);
             if(tempObj && tempObj._dateKey) {
                 key = tempObj._dateKey;
                 action = db.logs[key].actions.find(a => a.id === id);
             }
        }

        if(!action) return;

        const content = `
            <div class="detail-row">
                <span class="detail-label">عنوان:</span>
                <span class="detail-value">${action.text}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">نوع:</span>
                <span class="detail-value ${action.type==='reward'?'success-text':'danger-text'}">${action.type==='reward'?'پاداش':'جریمه'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">دلیل:</span>
                <span class="detail-value">${action.reason}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">تاریخ ثبت:</span>
                <span class="detail-value">${action.dateStr}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">محدوده زمانی:</span>
                <span class="detail-value">${action.timeRange || '-'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">وضعیت:</span>
                <span class="detail-value">${action.done ? 'انجام شده' : 'انجام نشده'}</span>
            </div>
        `;
        
        document.getElementById('actionDetailContent').innerHTML = content;
        
        // Disable editing for DONE actions
        const editArea = document.getElementById('actionEditControls');
        if (editArea) {
            if (action.done) {
                editArea.style.display = 'none';
            } else {
                editArea.style.display = 'block';
                document.getElementById('actionEditText').value = action.text;
            }
        }
        
        document.getElementById('actionDetailModal').style.display = 'flex';
    }

    function saveActionEdit() {
        // Double check done status
        let key = getKey(viewingDate);
        let action = db.logs[key]?.actions.find(a => a.id === currentActionEditId);
        
         if(!action && tempDateRangeResults) {
             const tempObj = tempDateRangeResults.find(a => a.id === currentActionEditId);
             if(tempObj && tempObj._dateKey) {
                 key = tempObj._dateKey;
                 action = db.logs[key].actions.find(a => a.id === currentActionEditId);
             }
        }

        if (action && action.done) {
            alert('اقدام انجام شده قابل ویرایش نیست.');
            return;
        }

        const newText = document.getElementById('actionEditText').value.trim();
        if (!newText) return alert('متن خالی است');
        
        if (action) {
            action.text = newText;
            saveDB();
            alert('ویرایش شد');
            document.getElementById('actionDetailModal').style.display = 'none';
            renderActionsTab();
            renderHome(); 
            
            if(document.getElementById('dateRangeModal').style.display === 'flex') {
                calcDateRangeStats();
                const isDone = document.getElementById('actionListPopupTitle').innerText.includes('انجام شده');
                showRangeActionDetails(isDone);
            }
        }
    }

    // ==========================================
    // 7. EDITORS
    // ==========================================

    function openEditor(type) {
        currentEditorMode = type;
        document.getElementById('editorTitle').innerText = type === 'behavior' ? 'مدیریت رفتارها' : 'مدیریت قوانین';
        
        document.getElementById('ruleListToggle').style.display = type === 'rule' ? 'flex' : 'none';
        document.getElementById('editorSearch').style.display = type === 'behavior' ? 'block' : 'none';
        
        if (type === 'behavior') {
            document.getElementById('ruleListToggle').style.display = 'flex'; 
        }

        renderEditorList();
        document.getElementById('editorModal').style.display = 'flex';
    }
    
    function toggleRuleList(type) {
        currentRuleFilter = type;
        document.getElementById('toggleVirtueBtn').className = type === 'virtue' ? 'toggle-btn active' : 'toggle-btn';
        document.getElementById('toggleViceBtn').className = type === 'vice' ? 'toggle-btn active' : 'toggle-btn';
        renderEditorList();
    }

    function openEditForm(index) {
        editingItemId = index;
        document.getElementById('formTitle').innerText = (index === null) ? "افزودن جدید" : "ویرایش مورد";
        
        document.getElementById('behaviorFields').style.display = currentEditorMode === 'behavior' ? 'block' : 'none';
        document.getElementById('ruleFields').style.display = currentEditorMode === 'rule' ? 'block' : 'none';

        if (currentEditorMode === 'behavior') {
            if (index !== null) {
                const item = db.behaviors[index];
                document.getElementById('behTitle').value = item.title;
                document.getElementById('behType').value = item.type;
                document.getElementById('behWeight').value = item.weight;
            } else {
                document.getElementById('behTitle').value = '';
                document.getElementById('behWeight').value = 1;
            }
        } else {
            populateTargetSelect();
            if (index !== null) {
                const item = db.rules[index];
                document.getElementById('ruleType').value = item.type;
                toggleRuleInputs();
                if(item.targetId) document.getElementById('ruleTargetId').value = item.targetId;
                document.getElementById('ruleThreshold').value = Math.abs(item.threshold);
                document.getElementById('ruleResultText').value = item.resultText;
                document.getElementById('ruleIsSpecific').checked = item.isSpecific;
                updateRuleResultTypeBasedOnTarget();
            } else {
                 document.getElementById('ruleResultText').value = '';
                 document.getElementById('ruleThreshold').value = '';
                 toggleRuleInputs();
            }
        }
        
        document.getElementById('editFormModal').style.display = 'flex';
    }

    function closeEditForm() {
        document.getElementById('editFormModal').style.display = 'none';
    }

    function populateTargetSelect() {
        const sel = document.getElementById('ruleTargetId');
        sel.innerHTML = '';
        db.behaviors.forEach(b => {
            // Include weight in display
            sel.innerHTML += `<option value="${b.id}" data-type="${b.type}">${b.title} (${b.weight})</option>`;
        });
        updateRuleResultTypeBasedOnTarget();
    }

    function toggleRuleInputs() {
        const type = document.getElementById('ruleType').value;
        document.getElementById('specificBehDiv').style.display = type === 'specific' ? 'block' : 'none';
        
        const resTypeInput = document.getElementById('ruleResultType');
        const resTypeDisp = document.getElementById('ruleResultTypeDisplay');
        const autoInd = document.getElementById('ruleAutoTypeIndicator');
        
        if (type === 'total_pos') {
            resTypeInput.value = 'reward'; resTypeDisp.value = 'پاداش';
            autoInd.innerText = ''; autoInd.style.display = 'none';
        } else if (type === 'total_neg') {
            resTypeInput.value = 'penalty'; resTypeDisp.value = 'جریمه';
            autoInd.innerText = ''; autoInd.style.display = 'none';
        } else if (type === 'specific') {
            autoInd.style.display = 'inline-block';
            updateRuleResultTypeBasedOnTarget();
        }
    }

    function updateRuleResultTypeBasedOnTarget() {
        const sel = document.getElementById('ruleTargetId');
        if (sel.selectedIndex === -1) return;
        const type = sel.options[sel.selectedIndex].getAttribute('data-type');
        
        const resTypeInput = document.getElementById('ruleResultType');
        const resTypeDisp = document.getElementById('ruleResultTypeDisplay');
        const ind = document.getElementById('ruleAutoTypeIndicator');

        if (type === 'virtue') {
            resTypeInput.value = 'reward';
            resTypeDisp.value = 'پاداش';
            ind.innerText = "رفتار مثبت -> پاداش (خودکار)";
            ind.style.background = "#d1fae5"; ind.style.color = "#065f46";
        } else {
            resTypeInput.value = 'penalty';
            resTypeDisp.value = 'جریمه';
            ind.innerText = "رفتار منفی -> جریمه (خودکار)";
            ind.style.background = "#fee2e2"; ind.style.color = "#991b1b";
        }
    }

    function renderEditorList() {
        const container = document.getElementById('editorListContainer');
        container.innerHTML = '';
        const search = document.getElementById('editorSearch').value.toLowerCase();

        if (currentEditorMode === 'behavior') {
            const filtered = db.behaviors.filter(b => b.type === currentRuleFilter && b.title.toLowerCase().includes(search));
            
            filtered.forEach((b) => {
                const idx = db.behaviors.indexOf(b);
                container.innerHTML += `
                    <div class="list-row">
                        <span>${b.title} <span style="font-size:0.8rem; color:#999;">(${b.weight})</span></span>
                        <div>
                            <i class="fas fa-edit btn-icon edit" onclick="openEditForm(${idx})"></i>
                            <i class="fas fa-trash btn-icon delete" onclick="deleteItem('behavior', ${idx})"></i>
                        </div>
                    </div>
                `;
            });
        } else {
            const filteredRules = db.rules.filter(r => {
                let isVirtue = false;
                if (r.type === 'total_pos') isVirtue = true;
                else if (r.type === 'total_neg') isVirtue = false;
                else if (r.type === 'specific') {
                    const b = db.behaviors.find(x => x.id === r.targetId);
                    if(b && b.type === 'virtue') isVirtue = true;
                }
                else if (r.type === 'total_net') {
                    isVirtue = r.resultType === 'reward';
                }
                return (currentRuleFilter === 'virtue' && isVirtue) || (currentRuleFilter === 'vice' && !isVirtue);
            });

            if(filteredRules.length === 0) container.innerHTML = '<p style="text-align:center; color:#999">موردی یافت نشد.</p>';

            filteredRules.forEach((r) => {
                const originalIdx = db.rules.indexOf(r);
                let desc = getRuleDescription(r);
                container.innerHTML += `
                    <div class="list-row">
                        <div style="font-size:0.85rem;">
                            <strong>${desc}</strong> > ${Math.abs(r.threshold)}
                            <div style="color:var(--text-light); margin-top:2px;">${r.resultText}</div>
                        </div>
                        <div>
                            <i class="fas fa-edit btn-icon edit" onclick="openEditForm(${originalIdx})"></i>
                            <i class="fas fa-trash btn-icon delete" onclick="deleteItem('rule', ${originalIdx})"></i>
                        </div>
                    </div>
                `;
            });
        }
    }
    
    function filterEditorList() { renderEditorList(); }

    function saveEditorItem() {
        if (currentEditorMode === 'behavior') {
            const title = document.getElementById('behTitle').value.trim();
            const type = document.getElementById('behType').value;
            const weight = parseInt(document.getElementById('behWeight').value);
            
            if(!title) return alert('عنوان الزامی است');
            
            if (editingItemId !== null) {
                // Edit
                db.behaviors[editingItemId].title = title;
                db.behaviors[editingItemId].type = type;
                db.behaviors[editingItemId].weight = weight;
            } else {
                // Add
                db.behaviors.push({
                    id: 'b' + Date.now(),
                    title, type, weight
                });
            }

        } else {
            const rType = document.getElementById('ruleType').value;
            const target = document.getElementById('ruleTargetId').value;
            const threshold = parseInt(document.getElementById('ruleThreshold').value);
            const resType = document.getElementById('ruleResultType').value;
            const resText = document.getElementById('ruleResultText').value.trim();
            const isSpec = document.getElementById('ruleIsSpecific').checked;

            if(!resText || isNaN(threshold)) return alert('اطلاعات ناقص است');

            const newRule = {
                id: editingItemId !== null ? db.rules[editingItemId].id : 'r' + Date.now(),
                type: rType,
                targetId: rType === 'specific' ? target : null,
                threshold: Math.abs(threshold),
                resultType: resType,
                resultText: resText,
                isSpecific: isSpec
            };

            if (editingItemId !== null) {
                db.rules[editingItemId] = newRule;
            } else {
                db.rules.push(newRule);
            }
        }
        
        saveDB();
        closeEditForm();
        renderEditorList();
        if(editingItemId === null) {
             const container = document.getElementById('editorListContainer');
             setTimeout(() => container.scrollTop = container.scrollHeight, 100);
        }
    }

    function deleteItem(type, index) {
        if(!confirm('حذف شود؟')) return;
        if(type === 'behavior') db.behaviors.splice(index, 1);
        else db.rules.splice(index, 1);
        saveDB();
        renderEditorList();
    }

    function closeEditor() {
        document.getElementById('editorModal').style.display = 'none';
        renderHome();
    }

    // ==========================================
    // 8. DATA MANAGEMENT
    // ==========================================
    
    function openBackupModal() {
        document.getElementById('backupModal').style.display = 'flex';
    }

    function backupData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "Ethics_Backup_" + getKey(new Date()) + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function restoreData(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                if(imported.behaviors && imported.rules) {
                    db = imported;
                    saveDB();
                    alert('بازگردانی موفقیت‌آمیز بود.');
                    location.reload();
                } else {
                    alert('فایل نامعتبر است.');
                }
            } catch(err) {
                alert('خطا در خواندن فایل.');
            }
        };
        reader.readAsText(file);
    }
    
    function openClearDataModal() {
        document.getElementById('clearDataModal').style.display = 'flex';
    }
    
    function performClearData() {
        const option = document.querySelector('input[name="clearOption"]:checked').value;
        
        if (option === 'all') {
            if(confirm("آیا مطمئنید؟ تمام اطلاعات شما پاک خواهد شد.")) {
                localStorage.removeItem('EthicsDB_Final');
                location.reload();
            }
        } else {
            // Clear Today
            const key = getKey(new Date());
            if (db.logs[key]) {
                delete db.logs[key];
                saveDB();
                renderHome();
                document.getElementById('clearDataModal').style.display = 'none';
                alert('اطلاعات امروز پاک شد.');
            }
        }
    }

    function openDateRangeStats() {
        document.getElementById('dateRangeModal').style.display = 'flex';
    }

    function calcDateRangeStats() {
        const start = new Date(document.getElementById('statStartDate').value);
        const end = new Date(document.getElementById('statEndDate').value);
        
        if(isNaN(start) || isNaN(end)) return alert("تاریخ نامعتبر");
        
        if (end < start) return alert("تاریخ پایان نمی‌تواند قبل از تاریخ شروع باشد.");

        let pos = 0, neg = 0, total = 0;
        let rCount = 0, pCount = 0;
        let doneCount = 0, pendingCount = 0;
        let filteredActions = [];

        for(let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            const key = getKey(d);
            const log = db.logs[key];
            if(log) {
                db.behaviors.forEach(b => {
                    const c = log.behaviors[b.id] || 0;
                    const sc = c * b.weight;
                    if(b.type === 'virtue') pos += sc; else neg += sc;
                });
                
                log.actions.forEach(a => {
                    if(a.type === 'reward') rCount++; else pCount++;
                    if(a.done) doneCount++; else pendingCount++;
                    a._dateKey = key;
                    filteredActions.push(a);
                });
            }
        }
        total = pos - neg;
        
        document.getElementById('rsPos').innerText = pos;
        document.getElementById('rsNeg').innerText = neg;
        document.getElementById('rsTotal').innerText = total;
        document.getElementById('rsRewards').innerText = rCount;
        document.getElementById('rsPenalties').innerText = pCount;
        document.getElementById('rsDone').innerText = doneCount;
        document.getElementById('rsPending').innerText = pendingCount;
        
        document.getElementById('rangeStatsResult').style.display = 'block';
        tempDateRangeResults = filteredActions;
    }

    function showRangeActionDetails(doneStatus) {
        const filtered = tempDateRangeResults.filter(a => a.done === doneStatus);
        const container = document.getElementById('actionListPopupContent');
        document.getElementById('actionListPopupTitle').innerText = doneStatus ? 'انجام شده (بازه زمانی)' : 'انجام نشده (بازه زمانی)';
        
        container.innerHTML = '';
        if(filtered.length === 0) {
            container.innerHTML = '<p style="text-align:center;">موردی یافت نشد.</p>';
        } else {
            filtered.forEach(a => {
                container.innerHTML += `
                    <div class="action-item" onclick="openActionDetail(${a.id})">
                        <div class="action-checkbox ${a.done ? 'checked' : ''}" onclick="event.stopPropagation(); toggleAction(${a.id}, '${a._dateKey}')">
                             <i class="fas fa-check" style="${a.done ? '' : 'display:none'}"></i>
                        </div>
                        <div class="action-content">
                            <span style="font-weight:bold;">${a.text}</span>
                            <div style="font-size:0.75rem; color:var(--text-light);">${a.dateStr}</div>
                        </div>
                    </div>
                `;
            });
        }
        document.getElementById('actionListPopupModal').style.display = 'flex';
    }

</script>

</body>
</html>
