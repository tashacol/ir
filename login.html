<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ø¢Ù…ÙˆØ²Ø´ÛŒ - ØªØ±Ø¨ÛŒØª Ù…Ø±Ø¨ÛŒ Ù†ÙˆØ¬ÙˆØ§Ù†</title>
  <!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ XLSX Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ ÙÙˆÙ†Øª Ø¢ÛŒÚ©ÙˆÙ† Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @font-face {
      font-family: 'Vazirmatn';
      src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@33.003/Vazirmatn-Regular.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
    }

    :root {
      --primary-color: #0d1b2a;
      --secondary-color: #1b263b;
      --accent-color: #3a86ff;
      --text-primary: #e0e1dd;
      --text-secondary: #adb5bd;
      --card-bg: #1b263b;
      --shadow-color: rgba(0, 0, 0, 0.4);
      --success-color: #2a9d8f;
      --break-color: #fca311;
      --border-radius: 12px;
      --transition-speed: 0.3s;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Vazirmatn', sans-serif;
      background-color: var(--primary-color);
      color: var(--text-primary);
      direction: rtl;
      text-align: right;
      line-height: 1.7;
      overflow-x: hidden;
      min-height: 100vh;
    }

    body.loading-active {
      overflow: hidden;
    }
    
    /* --- Ù„ÙˆØ¯ÛŒÙ†Ú¯ --- */
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--primary-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 20000;
      transition: opacity 0.5s ease-out;
    }

    .loader {
      width: 60px;
      height: 60px;
      border: 6px solid var(--secondary-color);
      border-top: 6px solid var(--accent-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #loadingText {
      margin-top: 25px;
      font-size: 1.3em;
      color: var(--text-primary);
    }
    .wave {
      display: inline-block;
      animation: wave 2s infinite;
      transform-origin: 70% 70%;
    }
    @keyframes wave {
      0% { transform: rotate(0deg); } 10% { transform: rotate(14deg); } 20% { transform: rotate(-8deg); } 30% { transform: rotate(14deg); } 40% { transform: rotate(-4deg); } 50% { transform: rotate(10deg); } 60% { transform: rotate(0deg); } 100% { transform: rotate(0deg); }
    }
    
    /* --- Ù…Ø¯Ø§Ù„ ÙˆØ±ÙˆØ¯ --- */
    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      animation: fadeIn var(--transition-speed);
      overflow-y: auto;
      padding: 20px;
    }
    .modal-content {
      background: #f8f9fa;
      color: var(--primary-color);
      margin: 5% auto;
      padding: 30px;
      width: 90%;
      max-width: 450px;
      border-radius: var(--border-radius);
      position: relative;
      animation: slideDown var(--transition-speed);
      box-shadow: 0 8px 25px var(--shadow-color);
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideDown { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    
    .modal-content h2 {
      text-align: center;
      margin-bottom: 25px;
      font-size: 1.8em;
    }
    .modal-content input[type="text"] {
      width: 100%;
      padding: 14px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1.1em;
      font-family: 'Vazirmatn', sans-serif;
    }
     .modal-content input[type="text"]:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 5px var(--accent-color);
     }
    .modal-content button {
      width: 100%;
      padding: 14px;
      background: var(--accent-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.2em;
      font-family: 'Vazirmatn', sans-serif;
      transition: background var(--transition-speed);
    }
    .modal-content button:hover {
      background: #3178df;
    }
    .remember-container {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      margin: 15px 0;
      gap: 10px;
    }
    #rememberMe {
      transform: scale(1.3);
    }

    /* --- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§ØµÙ„ÛŒ --- */
    .main-header {
      background: var(--secondary-color);
      padding: 20px 40px;
      border-bottom-left-radius: 20px;
      border-bottom-right-radius: 20px;
      box-shadow: 0 5px 15px var(--shadow-color);
      margin-bottom: 30px;
    }
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      border-bottom: 1px solid #334155;
      padding-bottom: 15px;
    }
    #welcomeMessage {
      font-size: 1.5em;
      font-weight: bold;
    }
    #courseInfo h1 {
      font-size: 1.3em;
      margin-bottom: 5px;
    }
     #courseInfo p {
      font-size: 0.9em;
      color: var(--text-secondary);
     }
    
    nav {
      width: 100%;
      padding-top: 15px;
    }
    nav ul {
      list-style: none;
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    nav ul li a {
      text-decoration: none;
      color: var(--text-primary);
      background: #475569;
      padding: 10px 20px;
      border-radius: 8px;
      transition: background var(--transition-speed), color var(--transition-speed);
      display: block;
    }
     nav ul li a:hover {
      background: var(--accent-color);
      color: white;
     }
    #certificateRequestBtn {
       background-color: var(--success-color);
       color: white;
    }

    #certificateCountdown {
      background: #003049;
      color: #fca311;
      padding: 15px;
      border-radius: var(--border-radius);
      max-width: 800px;
      margin: -15px auto 30px auto;
      box-shadow: 0 4px 10px var(--shadow-color);
      text-align: center;
      font-weight: bold;
      font-size: 1.1em;
      border: 2px solid #fca311;
    }

    /* --- Ø¨Ø®Ø´ Ù…Ø­ØªÙˆØ§ÛŒ Ø¯ÙˆØ±Ù‡ --- */
    #courseTimeline {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 25px;
      padding: 0 20px 40px 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: 0 6px 12px var(--shadow-color);
      width: 320px;
      padding: 20px;
      transition: transform var(--transition-speed), box-shadow var(--transition-speed);
      border-top: 4px solid var(--accent-color);
    }
    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 10px 20px var(--shadow-color);
    }
    .card.locked {
      opacity: 0.6;
      border-top-color: #6c757d;
    }
     .card.locked:hover {
      transform: none;
     }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .card-header h3 {
      font-size: 1.6em;
    }
    .card-header .icon {
      font-size: 1.8em;
      color: var(--text-secondary);
    }
    .card.locked .icon {
      color: #e0e1dd;
    }
    
    .card p {
      color: var(--text-secondary);
      margin-bottom: 20px;
      font-size: 0.95em;
    }

    .card-actions {
      display: flex;
      gap: 10px;
    }
    .card-actions button {
      flex-grow: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Vazirmatn', sans-serif;
      font-size: 1em;
      font-weight: bold;
      transition: all var(--transition-speed);
    }
    .card-actions button:disabled {
      cursor: not-allowed;
      background-color: #495057 !important;
      color: #adb5bd;
    }
    .video-btn { background-color: var(--accent-color); color: white; }
    .pdf-btn { background-color: #6c757d; color: white; }
    .video-btn:hover:not(:disabled) { background-color: #3178df; }
    .pdf-btn:hover:not(:disabled) { background-color: #5a6268; }

    /* Ú©Ø§Ø±Øª Ø§Ø³ØªØ±Ø§Ø­Øª */
    .break-card {
      border-top-color: var(--break-color);
      text-align: center;
    }
    .break-card .card-header {
      justify-content: center;
      color: var(--break-color);
    }
    .break-card .icon {
      color: var(--break-color);
    }
     .break-card p {
      font-size: 1.1em;
      color: var(--text-primary);
     }
    
    /* --- Ù…Ø¯Ø§Ù„â€ŒÙ‡Ø§ÛŒ ÙˆÛŒØ¯Ø¦ÙˆØŒ PDF Ùˆ Ù¾ÛŒØ§Ù… --- */
    .video-modal-content, .pdf-modal-content, .alert-modal-content {
      padding: 20px;
      background: #f8f9fa;
    }
    .close {
      position: absolute;
      top: 10px;
      left: 15px;
      font-size: 2em;
      cursor: pointer;
      color: #6c757d;
    }
    .alert-modal-content { max-width: 400px; text-align: center; }
    .alert-modal-content button { margin-top: 20px; }
    #alertMessage { font-size: 1.2em; color: var(--primary-color); }
    #termVideo, #pdfViewer { width: 100%; border-radius: 8px; }
    
    @media (max-width: 768px) {
      .main-header { padding: 20px; }
      .header-top { flex-direction: column; text-align: center; }
      nav ul { justify-content: center; }
      .card { width: 90%; }
    }
  </style>
</head>
<body class="loading-active">

  <!-- Ù„ÙˆØ¯ÛŒÙ†Ú¯ -->
  <div id="loadingOverlay">
    <div class="loader"></div>
    <p id="loadingText">Ø³Ù„Ø§Ù… <span class="wave">ğŸ‘‹</span> Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³Ø§Ù…Ø§Ù†Ù‡...</p>
  </div>

  <!-- Ù…Ø¯Ø§Ù„ ÙˆØ±ÙˆØ¯ -->
  <div id="loginModal" class="modal" style="display: block;">
    <div class="modal-content">
      <h2><i class="fa-solid fa-right-to-bracket"></i> ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³Ø§Ù…Ø§Ù†Ù‡ Ø¢Ù…ÙˆØ²Ø´ÛŒ</h2>
      <input type="text" id="nationalCodeInput" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" />
      <div class="remember-container">
        <input type="checkbox" id="rememberMe" />
        <label for="rememberMe">Ù…Ø±Ø§ Ø¨Ù‡ Ø®Ø§Ø·Ø± Ø¨Ø³Ù¾Ø§Ø±</label>
      </div>
      <button id="verifyButton">ÙˆØ±ÙˆØ¯</button>
    </div>
  </div>

  <!-- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§ØµÙ„ÛŒ -->
  <div id="dashboard" style="display: none;">
    <header class="main-header">
      <div class="header-top">
        <div id="welcomeMessageContainer">
          <h2 id="welcomeMessage"></h2>
        </div>
        <div id="courseInfo">
          <h1 id="courseName"></h1>
          <p id="courseDates"></p>
        </div>
      </div>
      <nav>
        <ul>
          <li><a href="#courseTimeline"><i class="fa-solid fa-book-open"></i> Ù…Ø­ØªÙˆØ§ÛŒ Ø¯ÙˆØ±Ù‡</a></li>
          <li><a href="https://tashacol.github.io/ir/takalif.html" target="_blank"><i class="fa-solid fa-paper-plane"></i> Ø§Ø±Ø³Ø§Ù„ ØªÚ©Ø§Ù„ÛŒÙ</a></li>
          <li><a id="certificateRequestBtn" href="#" style="display: none;"><i class="fa-solid fa-award"></i> Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú¯ÙˆØ§Ù‡ÛŒ</a></li>
        </ul>
      </nav>
    </header>

    <div id="certificateCountdown" style="display: none;"></div>
    
    <main id="courseTimeline"></main>
  </div>

  <!-- Ù…Ø¯Ø§Ù„â€ŒÙ‡Ø§ -->
  <div id="videoModal" class="modal"><div class="modal-content video-modal-content"><span class="close" onclick="closeModal('videoModal')">Ã—</span><video controls id="termVideo" style="height: 400px;"><source src="" type="video/mp4"></video></div></div>
  <div id="pdfModal" class="modal"><div class="modal-content pdf-modal-content"><span class="close" onclick="closeModal('pdfModal')">Ã—</span><iframe id="pdfViewer" height="600px"></iframe></div></div>
  <div id="alertModal" class="modal"><div class="modal-content alert-modal-content"><p id="alertMessage"></p><button id="alertOkBtn">Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…</button></div></div>

  <script>
    // --- Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³Ø±Ø§Ø³Ø±ÛŒ ---
    let registeredUsers = [];
    let currentUser = null;
    let courseName, courseId, courseStartDateStr;
    let courseStartDate, courseEndDate, certificateDeadline;

    // --- ØªÙˆØ§Ø¨Ø¹ ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® ---
    function jalaliToGregorian(jy, jm, jd) {
      // (Ú©Ø¯ ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯)
      let gy;if(jy>979){gy=1600;jy-=979;}else{gy=621;}let days=(365*jy)+Math.floor(jy/33)*8+Math.floor((jy%33+3)/4)+78+jd+((jm<7)?((jm-1)*31):(((jm-7)*30)+186));gy+=400*Math.floor(days/146097);days%=146097;if(days>36524){gy+=100*Math.floor((--days)/36524);days%=36524;if(days>=365)days++;}gy+=Math.floor(days/365);days%=365;let leap=((gy%4===0&&gy%100!==0)||(gy%400===0));let sal_a=[0,31,(leap?29:28),31,30,31,30,31,31,30,31,30,31];let gm;for(gm=0;gm<13;gm++){if(days<sal_a[gm])break;days-=sal_a[gm];}let gd=days+1;return[gy,gm,gd];
    }
    function parseJalaliDate(jalaliStr) {
      const parts = jalaliStr.split('/');
      if (parts.length !== 3) return null;
      const g = jalaliToGregorian(parseInt(parts[0]), parseInt(parts[1]), parseInt(parts[2]));
      return new Date(g[0], g[1] - 1, g[2]);
    }
    function formatDatePersian(date) {
      return date.toLocaleDateString("fa-IR", { year: 'numeric', month: 'long', day: 'numeric' });
    }

    // --- ØªÙˆØ§Ø¨Ø¹ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ (UI) ---
    function hideLoader() {
      const loader = document.getElementById('loadingOverlay');
      loader.style.opacity = '0';
      setTimeout(() => {
        loader.style.display = 'none';
        document.body.classList.remove('loading-active');
      }, 500);
    }
    function showAlert(message) {
      document.getElementById('alertMessage').innerText = message;
      document.getElementById('alertModal').style.display = 'block';
    }
    function openModal(modalId) { document.getElementById(modalId).style.display = 'block'; }
    function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
    function openVideoModal(termNumber) {
      const videoElement = document.getElementById("termVideo");
      videoElement.querySelector("source").src = `sample_video_term${termNumber}.mp4`;
      videoElement.load();
      openModal('videoModal');
    }
    function openPdfModal(termNumber) {
      document.getElementById("pdfViewer").src = `sample_booklet_term${termNumber}.pdf`;
      openModal('pdfModal');
    }
    
    // --- Ù…Ù†Ø·Ù‚ Ø§ØµÙ„ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ ---
    function populateCourseHeader() {
      document.getElementById('courseName').innerText = courseName;
      document.getElementById('courseDates').innerText = `ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹: ${formatDatePersian(courseStartDate)} | Ù¾Ø§ÛŒØ§Ù† Ø¯ÙˆØ±Ù‡: ${formatDatePersian(courseEndDate)}`;
      document.getElementById('welcomeMessage').innerText = `Ø³Ù„Ø§Ù…ØŒ ${currentUser[0]}!`;
    }

    // ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ú©Ø§Ø±Øª ØªØ±Ù…
    function createTermCard(termNumber, termStart, now) {
        const isLocked = now < termStart;
        const card = document.createElement('div');
        card.className = `card term-card ${isLocked ? 'locked' : ''}`;

        card.innerHTML = `
            <div class="card-header">
                <h3>ØªØ±Ù… ${termNumber}</h3>
                <i class="icon fa-solid ${isLocked ? 'fa-lock' : 'fa-lock-open'}"></i>
            </div>
            <p>Ø´Ø±ÙˆØ¹ ØªØ±Ù… Ø§Ø² ØªØ§Ø±ÛŒØ®: ${formatDatePersian(termStart)}</p>
            <div class="card-actions">
                <button class="video-btn" ${isLocked ? 'disabled' : ''} onclick="openVideoModal(${termNumber})"><i class="fa-solid fa-video"></i> Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙˆÛŒØ¯Ø¦Ùˆ</button>
                <button class="pdf-btn" ${isLocked ? 'disabled' : ''} onclick="openPdfModal(${termNumber})"><i class="fa-solid fa-file-pdf"></i> Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²ÙˆÙ‡</button>
            </div>
        `;
        return card;
    }

    // ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ú©Ø§Ø±Øª Ø§Ø³ØªØ±Ø§Ø­Øª
    function createBreakCard(breakStart, now) {
        const isLocked = now < breakStart;
        const card = document.createElement('div');
        card.className = `card break-card ${isLocked ? 'locked' : ''}`;
        
        card.innerHTML = `
            <div class="card-header">
                <h3>Ù‡ÙØªÙ‡ Ø§Ø³ØªØ±Ø§Ø­Øª</h3>
                <i class="icon fa-solid fa-mug-saucer"></i>
            </div>
            <p>${isLocked ? 'Ø§ÛŒÙ† Ù‡ÙØªÙ‡ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ±Ø§Ø­Øª Ø¯Ø± Ù†Ø¸Ø± Ú¯Ø±ÙØªÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.' : 'Ù‡ÙØªÙ‡ Ø§Ø³ØªØ±Ø§Ø­Øª ÙØ¹Ø§Ù„ Ø§Ø³Øª. Ø§Ø² ÙØ±ØµØª Ø¨Ø±Ø§ÛŒ Ù…Ø±ÙˆØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.'}</p>
            <p>Ø´Ø±ÙˆØ¹ Ø§Ø² ØªØ§Ø±ÛŒØ®: ${formatDatePersian(breakStart)}</p>
        `;
        return card;
    }

    // ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ØªØ±Ù… Ùˆ Ø§Ø³ØªØ±Ø§Ø­Øª
    function generateCourseTimeline() {
        const timelineSection = document.getElementById('courseTimeline');
        timelineSection.innerHTML = '';
        const now = new Date();

        // Ø§Ú¯Ø± Ø¯ÙˆØ±Ù‡ Ù‡Ù†ÙˆØ² Ø´Ø±ÙˆØ¹ Ù†Ø´Ø¯Ù‡
        if (now < courseStartDate) {
            timelineSection.innerHTML = `<p style="width:100%; text-align:center; font-size:1.2em;">Ø¯ÙˆØ±Ù‡ Ù‡Ù†ÙˆØ² Ø´Ø±ÙˆØ¹ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ø§ÙˆÙ„ÛŒÙ† ØªØ±Ù… Ø¯Ø± ØªØ§Ø±ÛŒØ® ${formatDatePersian(courseStartDate)} ÙØ¹Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.</p>`;
            return;
        }

        let termCounter = 1;
        const totalWeeks = 12; // 8 ØªØ±Ù… + 4 Ø§Ø³ØªØ±Ø§Ø­Øª

        for (let i = 0; i < totalWeeks; i++) {
            const weekStart = new Date(courseStartDate.getTime() + i * 7 * 24 * 60 * 60 * 1000);
            
            // Ù‡ÙØªÙ‡â€ŒÙ‡Ø§ÛŒ 3, 6, 9, 12 (Ø§Ù†Ø¯ÛŒØ³ 2, 5, 8, 11) Ù‡ÙØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªØ±Ø§Ø­Øª Ù‡Ø³ØªÙ†Ø¯
            const isBreakWeek = (i + 1) % 3 === 0;

            if (isBreakWeek) {
                timelineSection.appendChild(createBreakCard(weekStart, now));
            } else {
                timelineSection.appendChild(createTermCard(termCounter, weekStart, now));
                termCounter++;
            }
        }
    }

    function updateCertificateStatus() {
        const now = new Date();
        const certBtn = document.getElementById('certificateRequestBtn');
        const countdownBar = document.getElementById('certificateCountdown');

        if (now > courseEndDate && now <= certificateDeadline) {
            certBtn.style.display = 'inline-block';
            countdownBar.style.display = 'block';

            const remainingTime = certificateDeadline - now;
            const remainingDays = Math.ceil(remainingTime / (1000 * 60 * 60 * 24));
            countdownBar.innerText = `ÙØ±ØµØª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú¯ÙˆØ§Ù‡ÛŒ: ÙÙ‚Ø· ${remainingDays} Ø±ÙˆØ² Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡ Ø§Ø³Øª.`;

            certBtn.onclick = (e) => {
                e.preventDefault();
                showAlert("Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú¯ÙˆØ§Ù‡ÛŒ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!");
            };
        } else if (now > certificateDeadline) {
            const timelineSection = document.getElementById('courseTimeline');
            timelineSection.innerHTML = `<p style="width:100%; text-align:center; font-size:1.2em;">Ø§ÛŒÙ† Ø¯ÙˆØ±Ù‡ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯Ù‡ Ùˆ Ù…Ù‡Ù„Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú¯ÙˆØ§Ù‡ÛŒ Ù†ÛŒØ² ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>`;
            document.querySelector('nav').style.display = 'none';
        } else {
            certBtn.style.display = 'none';
            countdownBar.style.display = 'none';
        }
    }
    
    function initDashboard() {
        document.getElementById('loginModal').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        populateCourseHeader();
        generateCourseTimeline();
        updateCertificateStatus();
    }

    function loadRegisteredUsers() {
      fetch("https://docs.google.com/spreadsheets/d/1QSRAGajWtCWHJHsU-u4dRW85nq2hCGySKqtZQL0iTjY/export?format=xlsx")
        .then(response => {
            if (!response.ok) throw new Error("Network response was not ok.");
            return response.arrayBuffer();
        })
        .then(data => {
            const workbook = XLSX.read(data, { type: "array" });
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            if (jsonData.length > 1) {
                const courseData = jsonData[1];
                courseName = courseData[2] || "Ø¯ÙˆØ±Ù‡ Ø¢Ù…ÙˆØ²Ø´ÛŒ";
                courseId = courseData[3] || "N/A";
                courseStartDateStr = courseData[4] || "";

                if (!courseStartDateStr) {
                    showAlert("Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø¯ÙˆØ±Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯.");
                    hideLoader();
                    return;
                }

                courseStartDate = parseJalaliDate(courseStartDateStr);
                // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ø§Ø®ØªØ§Ø± Ø¬Ø¯ÛŒØ¯
                const COURSE_DURATION_DAYS = 84; // 12 Ù‡ÙØªÙ‡
                const CERTIFICATE_PERIOD_DAYS = 30; // 1 Ù…Ø§Ù‡

                courseEndDate = new Date(courseStartDate.getTime() + COURSE_DURATION_DAYS * 24 * 60 * 60 * 1000);
                certificateDeadline = new Date(courseEndDate.getTime() + CERTIFICATE_PERIOD_DAYS * 24 * 60 * 60 * 1000);
                
                registeredUsers = jsonData.slice(1); // Ø§Ø² Ø±Ø¯ÛŒÙ Ø¯ÙˆÙ… Ø¨Ù‡ Ø¨Ø¹Ø¯
                checkRememberMe();
            } else {
                 showAlert("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÙˆØ±Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯.");
            }
            hideLoader();
        })
        .catch(error => {
            console.error("Error loading data:", error);
            showAlert("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª. Ù„Ø·ÙØ§Ù‹ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ ØµÙØ­Ù‡ Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ú©Ù†ÛŒØ¯.");
            hideLoader();
        });
    }

    function verifyUser() {
        const inputCode = document.getElementById('nationalCodeInput').value.trim();
        if (!inputCode) {
            showAlert("Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ù…Ù„ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
            return;
        }

        const userFound = registeredUsers.find(user => user[1] && user[1].toString() === inputCode);

        if (userFound) {
            currentUser = userFound;
            if (document.getElementById('rememberMe').checked) {
                localStorage.setItem('rememberedUser', inputCode);
            }
            initDashboard();
        } else {
            showAlert("Ú©Ø¯ Ù…Ù„ÛŒ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ø¯Ø± Ø§ÛŒÙ† Ø¯ÙˆØ±Ù‡ Ø«Ø¨Øª Ù†Ø§Ù… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.");
        }
    }

    function checkRememberMe() {
        const rememberedCode = localStorage.getItem('rememberedUser');
        if (rememberedCode) {
            const userFound = registeredUsers.find(user => user[1] && user[1].toString() === rememberedCode);
            if (userFound) {
                currentUser = userFound;
                initDashboard();
            } else {
                localStorage.removeItem('rememberedUser');
            }
        }
    }
    
    // --- Event Listeners ---
    document.getElementById('verifyButton').addEventListener('click', verifyUser);
    document.getElementById('nationalCodeInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') verifyUser();
    });
    document.getElementById('alertOkBtn').addEventListener('click', () => closeModal('alertModal'));
    window.addEventListener('click', (event) => {
        if (event.target.classList.contains('modal')) {
            closeModal(event.target.id);
        }
    });

    // --- Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡ ---
    loadRegisteredUsers();
  </script>
</body>
</html>
