 
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>آکادمی هوشمند قرآن کریم | نسخه پیشرفته</title>
    
    <!-- فونت‌های گوگل و آیکون -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-color: #064e3b; /* سبز بسیار تیره و وزین */
            --primary-light: #10b981;
            --accent-color: #d97706; /* طلایی پررنگ */
            --bg-color: #f0fdf4;
            --text-color: #1f2937;
            --sidebar-width: 320px;
            --header-height: 70px;
            --footer-height: 80px;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Vazirmatn', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- هدر حرفه‌ای --- */
        .app-header {
            height: var(--header-height);
            background: white;
            border-bottom: 1px solid #ccfbf1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            z-index: 50;
            box-shadow: 0 4px 20px rgba(6, 78, 59, 0.05);
        }

        .header-branding {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            width: 45px;
            height: 45px;
            background: var(--primary-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 4px 10px rgba(6, 78, 59, 0.3);
        }

        .header-title h1 {
            font-size: 1.2rem;
            color: var(--primary-color);
            font-weight: 900;
            margin: 0;
        }
        
        .header-title span {
            font-size: 0.8rem;
            color: #64748b;
        }

        /* نوار پیشرفت دایره‌ای */
        .progress-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f0fdf4;
            padding: 5px 15px;
            border-radius: 20px;
            border: 1px solid #ccfbf1;
        }

        .progress-text {
            font-size: 0.85rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.6rem;
            color: var(--primary-color);
            cursor: pointer;
        }

        @media (max-width: 992px) {
            .menu-toggle { display: block; }
            .progress-indicator { display: none; }
        }

        /* --- لی اوت --- */
        .layout {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* --- سایدبار --- */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            border-left: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: absolute;
            top: 0; bottom: 0; right: 0;
            z-index: 40;
            transform: translateX(100%);
        }

        @media (min-width: 992px) {
            .sidebar { position: relative; transform: translateX(0); }
        }

        .sidebar.open {
            transform: translateX(0);
            box-shadow: -5px 0 25px rgba(0,0,0,0.15);
        }

        .sidebar-header {
            padding: 25px;
            background: linear-gradient(135deg, var(--primary-color), #047857);
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .sidebar-header::after {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
            opacity: 0.5;
        }

        .lesson-list {
            flex: 1;
            overflow-y: auto;
            list-style: none;
            padding: 10px;
        }

        .lesson-item {
            margin-bottom: 8px;
        }

        .lesson-btn {
            width: 100%;
            padding: 12px 15px;
            background: white;
            border: 1px solid #f1f5f9;
            border-radius: 10px;
            text-align: right;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #64748b;
            font-size: 0.95rem;
        }

        .lesson-btn:hover:not(:disabled) {
            transform: translateX(-5px);
            border-color: var(--primary-light);
            color: var(--primary-color);
        }

        .lesson-btn.active {
            background: linear-gradient(to left, #ecfdf5, white);
            border-right: 5px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: 800;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .lesson-btn.locked {
            background: #f8fafc;
            color: #cbd5e1;
            cursor: not-allowed;
            border: none;
        }

        /* --- محتوای اصلی --- */
        .main-content {
            flex: 1;
            background: #f8fafc;
            overflow-y: auto;
            padding: 30px;
            padding-bottom: 120px;
        }

        .course-card {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 24px;
            box-shadow: var(--card-shadow);
            padding: 40px;
            display: none;
            animation: slideUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            position: relative;
        }

        .course-card.active { display: block; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .lesson-badge {
            display: inline-block;
            background: #ecfdf5;
            color: var(--primary-color);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 800;
            margin-bottom: 15px;
            border: 1px solid #d1fae5;
        }

        h1.lesson-title {
            font-size: 1.8rem;
            color: #064e3b;
            margin-bottom: 25px;
            font-weight: 900;
        }

        p {
            line-height: 2;
            font-size: 1.1rem;
            color: #374151;
            margin-bottom: 25px;
            text-align: justify;
        }

        /* باکس قرآن */
        .quran-box {
            background: #fffbeb;
            border: 2px solid #fcd34d;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin: 30px 0;
            position: relative;
            box-shadow: inset 0 0 20px rgba(251, 191, 36, 0.1);
        }

        .quran-box::before {
            content: '۞';
            position: absolute;
            top: 10px; right: 15px;
            color: #d97706;
            font-size: 1.5rem;
            opacity: 0.5;
        }

        .quran-text {
            font-family: 'Scheherazade New', serif;
            font-size: 2.8rem;
            color: #000;
            line-height: 2.2;
            direction: rtl;
        }

        /* دکمه‌های صوتی کلمات */
        .audio-word {
            display: inline-block;
            cursor: pointer;
            transition: 0.2s;
            padding: 5px 15px;
            border-radius: 12px;
            position: relative;
            border: 1px solid transparent;
        }
        
        .audio-word:hover {
            background-color: white;
            border-color: #fcd34d;
            color: var(--primary-color);
            transform: scale(1.05);
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .audio-word::after {
            content: '\f028';
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            font-size: 1rem;
            position: absolute;
            top: -15px; left: 50%;
            transform: translateX(-50%);
            color: var(--primary-color);
            opacity: 0;
            transition: 0.2s;
            pointer-events: none;
        }

        .audio-word:hover::after {
            opacity: 1;
            top: -25px;
        }

        .highlight { color: #be185d; font-weight: bold; }

        /* گرید الفبای تعاملی */
        .alphabet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }

        .letter-btn {
            background: white;
            border: 2px solid #e2e8f0;
            aspect-ratio: 1;
            border-radius: 16px;
            font-family: 'Scheherazade New', serif;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #334155;
            position: relative;
        }

        .letter-btn i {
            font-size: 0.8rem;
            color: var(--primary-light);
            position: absolute;
            bottom: 8px;
            opacity: 0.5;
        }

        .letter-btn:hover {
            border-color: var(--primary-color);
            background: #ecfdf5;
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .letter-btn:active {
            transform: scale(0.95);
        }

        /* --- فوتر کنترل --- */
        .control-footer {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: var(--footer-height);
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 100;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.03);
        }

        @media (min-width: 992px) {
            .control-footer { right: var(--sidebar-width); }
        }

        .btn {
            padding: 12px 25px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: 0.2s;
            font-size: 1rem;
        }

        .btn-prev {
            background: #f1f5f9;
            color: #64748b;
        }
        .btn-prev:hover { background: #e2e8f0; color: #334155; }

        .btn-exam {
            background: linear-gradient(135deg, var(--accent-color), #b45309);
            color: white;
            box-shadow: 0 4px 15px rgba(217, 119, 6, 0.4);
        }
        .btn-exam:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(217, 119, 6, 0.5); }

        /* --- مودال آزمون (Quiz) --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(6, 78, 59, 0.85);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            padding: 20px;
        }

        .quiz-card {
            background: white;
            width: 100%;
            max-width: 500px;
            border-radius: 24px;
            padding: 30px;
            text-align: center;
            position: relative;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .quiz-header {
            margin-bottom: 20px;
        }
        
        .quiz-icon {
            width: 80px; height: 80px;
            background: #ecfdf5;
            color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin: 0 auto 15px;
        }

        .quiz-question {
            font-size: 1.1rem;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 25px;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 25px;
        }

        .option-btn {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.2s;
            font-family: 'Scheherazade New', serif;
            font-size: 1.4rem;
        }

        .option-btn:hover {
            border-color: var(--primary-light);
            background: #ecfdf5;
        }

        .option-btn.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .option-btn.wrong {
            background: #fecaca;
            border-color: #ef4444;
            color: #991b1b;
            animation: shake 0.5s;
        }

        .option-btn.correct {
            background: #bbf7d0;
            border-color: #22c55e;
            color: #14532d;
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        .btn-submit-quiz {
            width: 100%;
            padding: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
        }

        /* موبایل */
        @media (max-width: 768px) {
            .course-card { padding: 25px; border-radius: 0; box-shadow: none; min-height: 100%; margin-top: 0; }
            .quran-text { font-size: 2.2rem; }
            .header-title h1 { font-size: 1rem; }
            .main-content { padding: 0; }
            .control-footer { padding: 10px 15px; }
            .btn span { display: none; } /* فقط آیکون در موبایل خیلی کوچک */
            .btn { gap: 5px; }
        }

        .sidebar-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 30; display: none;
        }
        .sidebar-overlay.active { display: block; }

    </style>
</head>
<body>

    <!-- هدر -->
    <header class="app-header">
        <div class="header-branding">
            <div class="header-logo">
                <i class="fas fa-quran"></i>
            </div>
            <div class="header-title">
                <h1>آکادمی هوشمند قرآن</h1>
                <span>آموزش تخصصی | عثمان طه</span>
            </div>
        </div>
        
        <div class="progress-indicator">
            <span class="progress-text">پیشرفت شما: <span id="progressPercent">0%</span></span>
            <div style="width: 100px; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                <div id="progressBar" style="width: 0%; height: 100%; background: var(--accent-color); transition: 0.5s;"></div>
            </div>
        </div>
        
        <button class="menu-toggle" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>
    </header>

    <div class="layout">
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <!-- سایدبار -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2 style="font-size:1.3rem; margin-bottom:5px; position:relative; z-index:1;">فهرست دروس</h2>
                <div style="font-size:0.85rem; opacity:0.9; position:relative; z-index:1;">مسیر یادگیری حرفه‌ای</div>
            </div>
            <ul class="lesson-list" id="lessonList">
                <!-- جاوااسکریپت -->
            </ul>
        </aside>

        <!-- محتوا -->
        <main class="main-content" id="mainContent">
            
            <div id="welcome-screen" class="course-card active" style="text-align: center; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:60vh;">
                <div style="width:100px; height:100px; background:#dcfce7; border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--primary-color); font-size:3rem; margin-bottom:20px;">
                    <i class="fas fa-book-open"></i>
                </div>
                <h1 style="color:var(--primary-color); margin-bottom: 15px; font-weight:900;">بسم الله الرحمن الرحیم</h1>
                <p style="text-align:center; max-width:600px;">
                    به کامل‌ترین سامانه آموزش روخوانی قرآن خوش آمدید.
                    <br>
                    این سامانه مجهز به موتور صوتی هوشمند جهت تلفظ صحیح حروف و کلمات با قابلیت تشخیص تفخیم می‌باشد.
                </p>
                <button class="btn btn-exam" style="font-size:1.2rem; padding:15px 40px;" onclick="startCourse()">
                    شروع مسیر نورانی <i class="fas fa-arrow-left"></i>
                </button>
            </div>

            <!-- قالب درس‌ها -->
            <!-- درس ۱ -->
            <div id="lesson0" class="course-card">
                <span class="lesson-badge">درس اول</span>
                <h1 class="lesson-title">آشنایی با حروف الفبا</h1>
                <p>برای شروع قرائت قرآن، ابتدا باید حروف را به درستی بشناسیم. روی هر حرف کلیک کنید تا صدای خالص آن (بدون همزه اضافی) پخش شود.</p>
                
                <div class="alphabet-grid" id="alphabetGrid">
                    <!-- پر شده توسط JS -->
                </div>
                
                <div style="margin-top:30px; background:#fff7ed; padding:20px; border-radius:15px; border-right:4px solid #f97316;">
                    <i class="fas fa-exclamation-triangle" style="color:#f97316;"></i> <strong>توجه:</strong>
                    حروف (پ، ژ، گ، چ) در زبان عربی وجود ندارند. در عربی باید حرف «ز» را به صورت «زَا» تلفظ کنیم نه «زین».
                </div>
            </div>

            <!-- درس ۲ -->
            <div id="lesson1" class="course-card">
                <span class="lesson-badge">درس دوم</span>
                <h1 class="lesson-title">حرکات کوتاه (فتحه، کسره، ضمه)</h1>
                <p>حرکات به حروف جان می‌دهند. در عربی صداها باید کوتاه و ضربه‌ای باشند.</p>
                
                <div class="quran-box">
                    <div class="quran-text">
                        <span class="audio-word" onclick="speak('اَ')">ــَـ (اَ)</span> &nbsp;&nbsp; 
                        <span class="audio-word" onclick="speak('اِ')">ــِـ (اِ)</span> &nbsp;&nbsp; 
                        <span class="audio-word" onclick="speak('اُ')">ــُـ (اُ)</span>
                    </div>
                </div>

                <h3>مثال‌های تعاملی (کلیک کنید تا با قرائت صحیح بشنوید):</h3>
                <div class="quran-box">
                    <div class="quran-text">
                        <span class="audio-word" onclick="speak('خَلَقَ')">خَلَقَ</span> - 
                        <span class="audio-word" onclick="speak('كُتِبَ')">كُتِبَ</span> - 
                        <span class="audio-word" onclick="speak('رُزِقَ')">رُزِقَ</span>
                    </div>
                </div>
            </div>
            
            <!-- درس ۳ -->
            <div id="lesson2" class="course-card">
                <span class="lesson-badge">درس سوم</span>
                <h1 class="lesson-title">تفاوت صداها</h1>
                <p>صدای حرکات عربی کمی با فارسی تفاوت دارد. به خصوص کسره و ضمه.</p>
                <div class="quran-box">
                    <p style="font-size:1.2rem; color:#d97706;">گوش دهید و تکرار کنید:</p>
                    <div class="quran-text">
                        <span class="audio-word" onclick="speak('إِهْدِنَا')">إِهْدِنَا</span> (کسره مایل به ای)
                    </div>
                </div>
            </div>

        </main>

        <!-- فوتر -->
        <footer class="control-footer">
            <button class="btn btn-prev" id="btnPrev" onclick="prevLesson()" disabled>
                <i class="fas fa-chevron-right"></i> <span style="display:inline;">قبلی</span>
            </button>
            <div style="font-size: 0.9rem; font-weight: bold; color: var(--text-color);">
                 <span id="currentStepInfo">خوش‌آمدید</span>
            </div>
            <button class="btn btn-exam" id="btnNext" onclick="openExam()">
                آزمون و مرحله بعد <i class="fas fa-clipboard-check"></i>
            </button>
        </footer>
    </div>

    <!-- مودال آزمون -->
    <div class="modal-overlay" id="examModal">
        <div class="quiz-card">
            <div class="quiz-header">
                <div class="quiz-icon"><i class="fas fa-question"></i></div>
                <h2 style="color:var(--text-color);">آزمون پایان درس</h2>
            </div>
            <div class="quiz-question" id="quizQuestionText">
                سوال آزمون اینجا قرار می‌گیرد؟
            </div>
            <div class="quiz-options" id="quizOptionsContainer">
                <!-- گزینه‌ها -->
            </div>
            <div id="quizFeedback" style="margin-bottom:15px; font-weight:bold; display:none;"></div>
            <button class="btn-submit-quiz" onclick="checkAnswer()">ثبت پاسخ</button>
            <button class="btn-prev" onclick="closeExam()" style="width:100%; margin-top:10px; justify-content:center; background:transparent;">انصراف</button>
        </div>
    </div>

    <script>
        // ============================================
        // 1. DATA STRUCTURE (LETTERS & PRONUNCIATION MAP)
        // ============================================
        
        // این مپ بسیار مهم است. حرف را به صدای اصلاح شده تبدیل می‌کند
        const letterMap = [
            { c: 'ء', p: 'هَمزِه' }, { c: 'ا', p: 'اَلِف' }, { c: 'ب', p: 'بَا' }, 
            { c: 'ت', p: 'تَا' }, { c: 'ث', p: 'ثَا' }, { c: 'ج', p: 'جِيم' }, 
            { c: 'ح', p: 'حَا' }, { c: 'خ', p: 'خَا' }, { c: 'د', p: 'دَال' }, 
            { c: 'ذ', p: 'ذَال' }, { c: 'ر', p: 'رَا' }, { c: 'ز', p: 'زَا' }, // اصلاح زاء به زا
            { c: 'س', p: 'سِين' }, { c: 'ش', p: 'شِين' }, { c: 'ص', p: 'صَاد' }, 
            { c: 'ض', p: 'ضَاد' }, { c: 'ط', p: 'طَا' }, { c: 'ظ', p: 'ظَا' }, 
            { c: 'ع', p: 'عَاين' }, { c: 'غ', p: 'غَاين' }, { c: 'ف', p: 'فَا' }, 
            { c: 'ق', p: 'قَاف' }, { c: 'ک', p: 'كَاف' }, { c: 'ل', p: 'لَام' }, 
            { c: 'م', p: 'مِيم' }, { c: 'ن', p: 'نُون' }, { c: 'و', p: 'وَاو' }, 
            { c: 'ه', p: 'هَا' }, { c: 'ی', p: 'يَا' }
        ];

        const lessonsData = [
            { title: "حروف الفبا", quiz: { q: "حرف «ز» چگونه خوانده می‌شود؟", opts: ["زین (نام فارسی)", "زَا (نام عربی)", "زه", "زی"], ans: 1 } },
            { title: "حرکات کوتاه", quiz: { q: "صدای ــُـ (ضمه) شبیه کدام است؟", opts: ["اَ", "او (کوتاه)", "ای", "اِ"], ans: 1 } },
            { title: "تفاوت صداها", quiz: { q: "حرکت کسره در عربی مایل به کدام صدا است؟", opts: ["اَ", "ای (یای مدی)", "او", "هیچکدام"], ans: 1 } },
            { title: "حرکات کشیده", quiz: { q: "کدام کلمه دارای فتحه کشیده است؟", opts: ["كُتِبَ", "قَالَ", "مِنْ", "عَلِمَ"], ans: 1 } },
            { title: "سکون", quiz: { q: "علامت سکون چیست؟", opts: ["ــًـ", "ــّـ", "ْ یا ۡ", "ــَـ"], ans: 2 } },
            { title: "تنوین", quiz: { q: "تنوین چیست؟", opts: ["نون ساکن زائده", "میم ساکن", "حرکت کشیده", "تشدید"], ans: 0 } },
            { title: "تشدید", quiz: { q: "حرف مشدد چگونه خوانده می‌شود؟", opts: ["یک بار", "دو بار (اول ساکن دوم متحرک)", "سه بار", "خوانده نمی‌شود"], ans: 1 } },
            { title: "پایه همزه", quiz: { q: "در کلمه 'مُؤْمِن' کدام خوانده می‌شود؟", opts: ["واو", "همزه", "هردو", "هیچکدام"], ans: 1 } },
            { title: "الف کوتاه", quiz: { q: "الف مقصوره (کوتوله) چه حکمی دارد؟", opts: ["خوانده نمی‌شود", "مثل الف مدی خوانده می‌شود", "همیشه ساکن است", "کوتاه می‌شود"], ans: 1 } },
            { title: "حروف ناخوانا ۱", quiz: { q: "علامت دایره توخالی روی الف ( ْ ) نشانه چیست؟", opts: ["سکون", "ناخوانا بودن", "مد", "تشدید"], ans: 1 } },
            { title: "الف مدی (انا)", quiz: { q: "کلمه «انا» چگونه خوانده می‌شود؟", opts: ["اَنَا (کوتاه)", "اَنَااا (کشیده)", "اِنا", "هیچکدام"], ans: 0 } },
            { title: "همزه وصل", quiz: { q: "همزه وصل (ٱ) در وسط جمله چه حکمی دارد؟", opts: ["خوانده می‌شود", "ساکن می‌شود", "می‌افتد (خوانده نمی‌شود)", "تشدید می‌گیرد"], ans: 2 } },
            { title: "شروع با همزه وصل", quiz: { q: "همزه وصل در «ٱلْحَمْدُ» با چه حرکتی شروع می‌شود؟", opts: ["کسره", "ضمه", "فتحه", "سکون"], ans: 2 } },
            { title: "حروف بدون علامت", quiz: { q: "حرف بدون علامت در قرآن نشانه چیست؟", opts: ["باید محکم خوانده شود", "ادغام یا عدم تلفظ", "سکون", "حرکت کشیده"], ans: 1 } },
            { title: "الف بعد تنوین", quiz: { q: "در کلمه «عَلِيمًا» هنگام وقف، تنوین چه می‌شود؟", opts: ["ساکن می‌شود", "حذف و الف مدی می‌شود", "همانطور خوانده می‌شود", "هاء می‌شود"], ans: 1 } },
            { title: "یاء ناخوانا", quiz: { q: "در کلمه «مُوسَی» حرف ی چه حکمی دارد؟", opts: ["خوانده می‌شود", "پایه الف است و خوانده نمی‌شود", "یا ساکن است", "تشدید دارد"], ans: 1 } },
            { title: "حروف کوچک", quiz: { q: "آیا حروف کوچک (مثل ی کوچک) باید خوانده شوند؟", opts: ["خیر", "بله حتماً", "اختیاری است", "فقط در وقف"], ans: 1 } },
            { title: "مد", quiz: { q: "علامت مد (~) نشانه چیست؟", opts: ["کشش بیش از حد طبیعی", "کوتاه کردن صدا", "توقف", "سکون"], ans: 0 } },
            { title: "وقف", quiz: { q: "هنگام وقف بر «ة» (تاء گرد) چه اتفاقی می‌افتد؟", opts: ["ت تلفظ می‌شود", "ساکن می‌شود", "تبدیل به هاء ساکن می‌شود", "حرکت می‌گیرد"], ans: 2 } },
            { title: "حروف مقطعه", quiz: { q: "«الم» چگونه خوانده می‌شود؟", opts: ["اَلَم", "اَلِم", "الف لام میم", "اِلِم"], ans: 2 } },
            { title: "التقاء ساکنین", quiz: { q: "در «أَحَدٌ ٱللَّهُ» نون تنوین چه حرکتی می‌گیرد؟", opts: ["فتحه", "کسره", "ضمه", "ساکن می‌ماند"], ans: 1 } },
            { title: "بخش خوانی", quiz: { q: "هدف از بخش‌خوانی چیست؟", opts: ["تندخوانی", "زیباخوانی", "یادگیری کلمات سخت", "حفظ کردن"], ans: 2 } },
            { title: "تجوید", quiz: { q: "کدام یک از حروف استعلاء (پرخوانی) است؟", opts: ["ب", "س", "ط", "م"], ans: 2 } }
        ];

        // تولید محتوای درس‌های باقی‌مانده
        for(let i=3; i<lessonsData.length; i++) {
            if(!document.getElementById(`lesson${i}`)) {
                // این بخش فقط placeholder است تا ساختار حفظ شود
            }
        }

        let currentLessonIdx = -1;
        let unlockedLessonIdx = 0;
        let selectedOption = null;

        // ============================================
        // 2. INITIALIZATION
        // ============================================

        window.onload = function() {
            loadState();
            renderSidebar();
            renderAlphabet();
            renderPlaceholders();
            updateUI();
        };

        function renderPlaceholders() {
            const main = document.getElementById('mainContent');
            for(let i=3; i<lessonsData.length; i++) {
                if(!document.getElementById(`lesson${i}`)) {
                    const div = document.createElement('div');
                    div.id = `lesson${i}`;
                    div.className = 'course-card';
                    div.innerHTML = `
                        <span class="lesson-badge">درس ${i+1}</span>
                        <h1 class="lesson-title">${lessonsData[i].title}</h1>
                        <p>محتوای آموزشی درس ${lessonsData[i].title} شامل مثال‌های قرآنی و فایل‌های صوتی مربوطه در اینجا نمایش داده می‌شود.</p>
                        <div class="quran-box"><div class="quran-text">مثال‌های صوتی درس ${i+1}</div></div>
                    `;
                    main.appendChild(div);
                }
            }
        }

        function renderAlphabet() {
            const grid = document.getElementById('alphabetGrid');
            if(!grid) return;
            grid.innerHTML = '';
            letterMap.forEach(item => {
                const btn = document.createElement('div');
                btn.className = 'letter-btn';
                btn.innerHTML = `${item.c} <i class="fas fa-volume-up"></i>`;
                // اینجا به جای کاراکتر، تلفظ صحیح (p) را می‌فرستیم
                btn.onclick = () => speak(item.p, false); 
                grid.appendChild(btn);
            });
        }

        // ============================================
        // 3. ENHANCED AUDIO ENGINE (Google TTS + Fallback)
        // ============================================
        
        function speak(text, isWord = true) {
            // برای کلمات (مثل خلق) از Google TTS استفاده می‌کنیم چون تفخیم بهتری دارد
            // برای حروف تکی از سیستم داخلی مرورگر با متن اصلاح شده استفاده می‌کنیم
            
            // استراتژی: استفاده از لینک مستقیم گوگل برای کیفیت بالا (نیاز به اینترنت)
            // اگر کاربر آفلاین بود یا خطا داد، فال‌بک به SpeechSynthesis
            
            const audioUrl = `https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=ar&q=${encodeURIComponent(text)}`;
            
            if(isWord && navigator.onLine) {
                const audio = new Audio(audioUrl);
                audio.play().catch(() => {
                    // اگر خطا داد (مثلا بلاک شد)، از روش دوم استفاده کن
                    speakNative(text);
                });
            } else {
                speakNative(text);
            }
        }

        function speakNative(text) {
            if ('speechSynthesis' in window) {
                // کنسل کردن صداهای قبلی
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ar-SA'; 
                utterance.rate = 0.85; // سرعت کمی آهسته
                
                // تلاش برای انتخاب صدای عربی مناسب
                const voices = window.speechSynthesis.getVoices();
                const arabicVoice = voices.find(v => v.lang.includes('ar'));
                if(arabicVoice) utterance.voice = arabicVoice;

                window.speechSynthesis.speak(utterance);
            } else {
                alert("مرورگر شما پشتیبانی نمی‌کند.");
            }
        }

        // ============================================
        // 4. NAVIGATION & STATE
        // ============================================

        function loadState() {
            const savedUnlock = localStorage.getItem('q_unlock_v2');
            const savedCurrent = localStorage.getItem('q_curr_v2');
            if(savedUnlock) unlockedLessonIdx = parseInt(savedUnlock);
            if(savedCurrent) currentLessonIdx = parseInt(savedCurrent);
        }

        function saveState() {
            localStorage.setItem('q_unlock_v2', unlockedLessonIdx);
            localStorage.setItem('q_curr_v2', currentLessonIdx);
        }

        function renderSidebar() {
            const list = document.getElementById('lessonList');
            list.innerHTML = '';
            lessonsData.forEach((l, i) => {
                const li = document.createElement('li');
                li.className = 'lesson-item';
                
                let statusClass = '';
                let icon = 'fa-lock';
                
                if (i < unlockedLessonIdx) { icon = 'fa-check-circle text-primary'; } // آیکون سبز برای تکمیل شده
                else if (i === unlockedLessonIdx) { icon = 'fa-lock-open text-warning'; }
                else { statusClass = 'locked'; }

                if (i === currentLessonIdx) statusClass += ' active';

                li.innerHTML = `
                    <button class="lesson-btn ${statusClass}" onclick="navToLesson(${i})" ${i > unlockedLessonIdx ? 'disabled' : ''}>
                        <span>${i+1}. ${l.title}</span>
                        <i class="fas ${icon}" style="${i < unlockedLessonIdx ? 'color:var(--primary-light);' : ''}"></i>
                    </button>
                `;
                list.appendChild(li);
            });
        }

        function startCourse() {
            navToLesson(0);
        }

        function navToLesson(idx) {
            if(idx > unlockedLessonIdx) return;
            
            document.querySelectorAll('.course-card').forEach(el => el.classList.remove('active'));
            
            currentLessonIdx = idx;
            const target = document.getElementById(`lesson${idx}`);
            if(target) target.classList.add('active');
            
            document.getElementById('mainContent').scrollTo(0,0);
            
            if(window.innerWidth < 992) {
                document.getElementById('sidebar').classList.remove('open');
                document.querySelector('.sidebar-overlay').classList.remove('active');
            }

            saveState();
            updateUI();
        }

        function updateUI() {
            renderSidebar();
            
            const btnPrev = document.getElementById('btnPrev');
            const btnNext = document.getElementById('btnNext');
            const info = document.getElementById('currentStepInfo');

            if(currentLessonIdx === -1) {
                document.querySelector('.control-footer').style.display = 'none';
            } else {
                document.querySelector('.control-footer').style.display = 'flex';
                btnPrev.disabled = (currentLessonIdx === 0);
                info.innerText = `درس ${currentLessonIdx+1} از ${lessonsData.length}`;
                
                if(currentLessonIdx < unlockedLessonIdx) {
                    btnNext.innerHTML = 'درس بعدی <i class="fas fa-chevron-left"></i>';
                    btnNext.classList.remove('btn-exam');
                    btnNext.onclick = function() { navToLesson(currentLessonIdx + 1); };
                } else {
                    btnNext.innerHTML = 'آزمون و ادامه <i class="fas fa-clipboard-check"></i>';
                    btnNext.classList.add('btn-exam');
                    btnNext.onclick = openExam;
                }
            }

            const percent = Math.round((unlockedLessonIdx / lessonsData.length) * 100);
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressPercent').innerText = `${percent}%`;
        }

        function prevLesson() {
            if(currentLessonIdx > 0) navToLesson(currentLessonIdx - 1);
        }

        // ============================================
        // 5. QUIZ LOGIC
        // ============================================

        function openExam() {
            const data = lessonsData[currentLessonIdx].quiz;
            document.getElementById('quizQuestionText').innerText = data.q;
            
            const optsContainer = document.getElementById('quizOptionsContainer');
            optsContainer.innerHTML = '';
            
            selectedOption = null;
            document.getElementById('quizFeedback').style.display = 'none';

            data.opts.forEach((opt, idx) => {
                const btn = document.createElement('div');
                btn.className = 'option-btn';
                btn.innerText = opt;
                btn.onclick = () => selectOption(idx, btn);
                optsContainer.appendChild(btn);
            });

            document.getElementById('examModal').style.display = 'flex';
        }

        function selectOption(idx, el) {
            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            selectedOption = idx;
        }

        function checkAnswer() {
            if(selectedOption === null) {
                alert("لطفاً یک گزینه را انتخاب کنید.");
                return;
            }

            const correct = lessonsData[currentLessonIdx].quiz.ans;
            const btns = document.querySelectorAll('.option-btn');
            const feedback = document.getElementById('quizFeedback');

            if(selectedOption === correct) {
                btns[selectedOption].classList.add('correct');
                feedback.innerText = "احسنت! پاسخ صحیح است.";
                feedback.style.color = "green";
                feedback.style.display = "block";
                
                // پخش صدای موفقیت (از گوگل TTS استفاده می‌کنیم تا نیاز به فایل نباشد)
                const audio = new Audio('https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=en&q=Correct');
                audio.play().catch(()=>{});

                setTimeout(() => {
                    closeExam();
                    if(currentLessonIdx === unlockedLessonIdx) {
                        unlockedLessonIdx++;
                        if(unlockedLessonIdx >= lessonsData.length) unlockedLessonIdx = lessonsData.length - 1;
                    }
                    navToLesson(currentLessonIdx + 1);
                }, 1500);

            } else {
                btns[selectedOption].classList.add('wrong');
                feedback.innerText = "پاسخ اشتباه است. لطفاً درس را مجدد مرور کنید.";
                feedback.style.color = "red";
                feedback.style.display = "block";
                
                const audio = new Audio('https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=en&q=Wrong');
                audio.play().catch(()=>{});
            }
        }

        function closeExam() {
            document.getElementById('examModal').style.display = 'none';
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }

    </script>
</body>
</html>
