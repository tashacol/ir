<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1200">
    <title>پرتال اساتید قرآن کریم</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-main: 'Vazirmatn', sans-serif;
            --primary-color: #0c4a6e; --secondary-color: #075985; --accent-color: #38bdf8;
            --light-bg: #f8fafc; --container-bg: #ffffff; --dark-text: #1e293b; --light-text: #64748b;
            --border-color: #e2e8f0; --danger-color: #dc2626; --success-color: #16a34a; --warning-color: #f59e0b;
        }
        body {
            font-family: var(--font-main);
            color: var(--dark-text);
            line-height: 1.7;
            min-width: 1200px;
            margin: 0;
            background-image: url('https://tashacol.ir/1l5jlse9 (1).jpeg');
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            /* --- START: REVERTED CHANGE --- */
            background-attachment: fixed; /* بازگشت به حالت اولیه برای ثابت ماندن پس‌زمینه */
            /* --- END: REVERTED CHANGE --- */
        }
        .hidden { display: none !important; }

        /*  استایل صفحه ورود */
        #login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        #login-section { text-align: center; max-width: 420px; width: 100%; background: var(--container-bg); padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05), 0 10px 10px -5px rgba(0,0,0,0.04); }
        .login-header-icon {
            max-width: 120px;
            height: auto;
            margin-bottom: 20px;
            display: inline-block;
        }
        #login-form button[type="submit"] { width: 100%; }
        .container { max-width: 1100px; margin: 40px auto; } 
        
        h1, h2, h3, h4 { color: var(--primary-color); text-align: center; font-weight: 700; }
        h1 { font-size: 2.2rem; margin-bottom: 30px;} h2 { font-size: 1.8rem; border-bottom: 2px solid var(--border-color); padding-bottom: 15px; margin-bottom: 30px; }
        h4 { font-size: 1.3rem; color: var(--secondary-color); margin-bottom: 15px; }

        .skeleton-card { background: #fff; border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-bottom: 30px; }
        .skeleton { background-color: #e2e8f0; border-radius: 4px; } .skeleton.title { height: 28px; width: 40%; margin-bottom: 15px; }
        .skeleton.text { height: 16px; width: 70%; margin-bottom: 10px; } .skeleton.table-head { height: 40px; width: 100%; margin-top: 20px; }
        .skeleton.table-row { height: 50px; width: 100%; margin-top: 5px; } .shimmer { position: relative; overflow: hidden; }
        .shimmer::after { content: ''; position: absolute; top: 0; right: 0; bottom: 0; left: 0; transform: translateX(-100%); background-image: linear-gradient(90deg, rgba(255,255,255,0) 0, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%); animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 100% { transform: translateX(100%); } }
        .skeleton.button { height: 48px; width: 180px; margin-bottom: 30px; }

        .form-group { margin-bottom: 20px; position: relative; } 
        label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 1rem; text-align: right; }
        input, select { text-align: center; width: 100%; box-sizing: border-box; padding: 12px 15px; border: 1px solid #a8b3c2; border-radius: 8px; font-size: 1rem; font-family: var(--font-main); transition: all 0.3s; }
        input.has-icon { padding-right: 45px; }
        .input-icon { position: absolute; top: 43px; right: 15px; color: var(--light-text); font-size: 1.3rem; }
        input:focus, select:focus { border-color: var(--secondary-color); box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.3); outline: none; }
        
        button, a.btn-like { text-decoration: none; position:relative; background-color: var(--secondary-color); color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-family: var(--font-main); transition: all 0.3s; display: inline-block; text-align: center; }
        button:hover:not(:disabled), a.btn-like:hover:not(.disabled) { background-color: var(--primary-color); transform: translateY(-2px); }
        button:disabled, a.btn-like.disabled { background-color: #94a3b8; cursor: not-allowed; }
        button.danger { background-color: var(--danger-color); } button.danger:hover:not(:disabled) { background-color: #b91c1c; }
        
        .btn-loading .btn-text { visibility: hidden; }
        .btn-loading::after { content: ''; position: absolute; width: 20px; height: 20px; top: 0; left: 0; right: 0; bottom: 0; margin: auto; border: 3px solid transparent; border-top-color: #ffffff; border-radius: 50%; animation: button-loading-spinner 1s ease infinite; }
        @keyframes button-loading-spinner { from { transform: rotate(0turn); } to { transform: rotate(1turn); } }

        .icon { width: 1em; height: 1em; vertical-align: middle; }
        .icon-btn { background: none; border: none; color: var(--light-text); cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; font-family: var(--font-main); padding: 8px; border-radius: 8px; transition: all 0.3s; }
        .icon-btn .icon { width: 1.3em; height: 1.3em; } .icon-btn:hover:not(:disabled) { color: var(--secondary-color); background-color: #f0f9ff; }
        .icon-btn.delete-btn:hover:not(:disabled) { background-color: #fee2e2; }

        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding: 15px; background-color: rgba(255,255,255,0.8); backdrop-filter: blur(5px); border-radius: 12px; }
        .header-actions { display: flex; align-items: center; gap: 10px; }
        .header-loader { width: 24px; height: 24px; border: 3px solid var(--border-color); border-top-color: var(--secondary-color); border-radius: 50%; animation: button-loading-spinner 1s linear infinite; display: none; margin-right: 15px;}
        .dashboard-header.loading .header-loader { display: block; }

        .course-card { background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-bottom: 30px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .course-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .course-card table { width: 100%; border-collapse: collapse; margin-top: 20px; } 
        .course-card td { text-align: center; padding: 15px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .course-card th { background-color: #e2e8f0; color: var(--primary-color); text-align: center; font-size: 1rem; font-weight: 700; padding: 15px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .course-card tr:last-child td { border-bottom: none; }
        
        .course-card th:first-child, .course-card td:first-child {
            border-left: 2px solid #cbd5e1;
            font-weight: bold;
            color: var(--secondary-color);
            width: 50px;
        }
        
        .course-header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .course-date-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            background-color: #f0f9ff;
            border: 1px solid var(--accent-color);
            border-radius: 8px;
            padding: 5px 15px;
            font-size: 0.9rem;
            color: var(--secondary-color);
        }
        .course-date-container strong {
            font-weight: 700;
            color: var(--primary-color);
        }

        .course-actions { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px dashed var(--border-color); }
        .action-buttons-container { display: flex; align-items: center; gap: 10px; }
        .course-status-container { display: flex; justify-content: flex-start; }
        .course-status { font-weight: bold; display: flex; align-items: center; gap: 8px; padding: 6px 12px; border-radius: 8px; font-size: 0.9rem; }
        .status-approved { background-color: #f0fdf4; color: var(--success-color); }
        .status-pending { background-color: #fefce8; color: var(--warning-color); }
        .status-rejected { background-color: #fef2f2; color: var(--danger-color); display:block; padding: 10px; }
        .status-rejected .status-header { display: flex; align-items: center; gap: 8px; }
        .rejection-reason { font-size: 0.9rem; margin-top: 8px; padding-right: 32px; color: var(--dark-text); font-weight: normal; }
        
        .student-actions { display: flex; justify-content: center; align-items: center; gap: 5px; }
        .edit-btn .icon { color: var(--secondary-color); }
        .delete-btn .icon { color: var(--danger-color); }
        
        .grade-btn { background-color: #f0f9ff; padding-right: 12px; padding-left: 12px; }
        .grade-btn .icon { color: #15803d; }
        .grade-btn .btn-text { color: var(--secondary-color); font-weight: bold; }
        .grade-btn:hover:not(:disabled) { background-color: #e0f2fe; outline: 2px solid var(--accent-color); outline-offset: -2px; }

        .modal { position: fixed; z-index: 1000; inset: 0; background-color: rgba(15, 23, 42, 0.7); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); padding: 20px; }
        .modal-content { background-color: var(--container-bg); padding: 30px; width: 100%; max-width: 650px; border-radius: 16px; animation: modal-appear 0.4s; }
        .modal-content.narrow { max-width: 500px; }
        @keyframes modal-appear { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .modal-header .close-btn { background: none; border: none; font-size: 2rem; color: var(--light-text); cursor: pointer; }
        
        .alert-modal-content { max-width: 450px; text-align: center; } .alert-icon { font-size: 4rem; margin-bottom: 15px; }
        .alert-icon.success { color: var(--success-color); } .alert-icon.error { color: var(--danger-color); }
        .alert-icon.confirm { color: var(--warning-color); } .alert-message { font-size: 1.1rem; color: var(--dark-text); margin-bottom: 25px; }
        .alert-buttons { display: flex; justify-content: center; gap: 15px; } .alert-buttons button { padding: 10px 25px; }
        .alert-buttons button.secondary { background-color: var(--border-color); color: var(--dark-text); }
        .alert-buttons button.secondary:hover { background-color: #cbd5e1; }

        .grade-input-group { display: flex; justify-content: space-between; align-items: center; gap: 15px; }
        .grade-input-group label { text-align: right; flex-grow: 1; margin-bottom: 0; }
        .grade-input-group input[type="number"] { width: 90px; flex-grow: 0; flex-shrink: 0; }

        .grading-modal-header { background-color: var(--light-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: center; }
        .grading-modal-header .student-name { color: var(--primary-color); font-weight: 700; font-size: 1.2rem; }
        
        .modal-error-message { color: var(--danger-color); background-color: #fee2e2; border: 1px solid #f87171; border-radius: 8px; padding: 10px 15px; font-size: 0.95rem; text-align: center; }
        
        #temp-student-list { min-height: 50px; background: #f8fafc; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; list-style-type: none; }
        #temp-student-list li { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid #e2e8f0; }
        #temp-student-list li:last-child { border-bottom: none; }
        .temp-student-delete-btn { padding: 5px; }
        .temp-student-delete-btn .icon { width: 1.4em; height: 1.4em; }
        .confirm-delete-btn { color: var(--success-color) !important; animation: flash 1s infinite; }
        @keyframes flash { 50% { opacity: 0.2; } }

        .syllabus-modal-content { text-align: right; line-height: 2; }
    </style>
</head>
<body>
    <svg width="0" height="0" class="hidden">
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-plus-circle"><path fill="currentColor" d="M12 2c-5.52 0-10 4.48-10 10s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m5 11h-4v4h-2v-4H7v-2h4V7h2v4h4z"/></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-pencil"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83l3.75 3.75z"/></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-trash"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z"/></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-grade"><path fill="currentColor" d="M12 3L1 9l4 2.18v6.32L12 21l7-3.5V11.18L23 9zm-2 13.91V13h4v3.91l-2 1.09zM12 11.33L4.93 8L12 4.67L19.07 8z"/></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-logout"><path fill="currentColor" d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4z"></path></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-star"><path fill="currentColor" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2L9.19 8.63L2 9.24l5.46 4.73L5.82 21z"></path></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-alert-success"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2m-2 15l-5-5l1.41-1.41L10 14.17l7.59-7.59L19 8z"></path></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-alert-error"><path fill="currentColor" d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10s10-4.47 10-10S17.53 2 12 2m-1 15h2v2h-2zm0-12h2v10h-2z"></path></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-alert-confirm"><path fill="currentColor" d="M1 21h22L12 2L1 21m12-3h-2v-2h2m0-4h-2v-4h2"></path></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-check-circle"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2m-2 15l-5-5l1.41-1.41L10 14.17l7.59-7.59L19 8z"></path></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-id-card"><path fill="currentColor" d="M20 4H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2M4 6h16v2H4zm8 12H4v-7h8zm-1-4a2 2 0 1 1 0-4a2 2 0 0 1 0 4m7 4h-5v-2h5zm0-3h-5v-2h5z"></path></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-lock"><path fill="currentColor" d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2m-6 9c-1.1 0-2-.9-2-2s.9-2 2-2s2 .9 2 2s-.9 2-2 2M9 8V6c0-1.66 1.34-3 3-3s3 1.34 3 3v2z"></path></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-info"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2m1 15h-2v-6h2zm0-8h-2V7h2z"></path></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-download"><path fill="currentColor" d="M5 20h14v-2H5zM19 9h-4V3H9v6H5l7 7z"/></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-clock"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2m4.5 13.5L11 12.17V7h1.5v4.5l4.62 2.81z"/></symbol>
        <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-email"><path fill="currentColor" d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2m0 4l-8 5l-8-5V6l8 5l8-5z"/></symbol>
    </svg>
    
    <div id="login-container">
        <div id="login-section">
            <img src="https://tashacol.ir/quran.png" alt="لوگو" class="login-header-icon">
            <h1>پرتال اساتید قرآن کریم</h1>
            <form id="login-form" onsubmit="handleManualLogin(event)">
                <div class="form-group">
                    <label for="nationalId">کد ملی</label>
                    <div class="input-icon"><svg class="icon"><use href="#icon-id-card"></use></svg></div>
                    <input type="tel" inputmode="numeric" pattern="[0-9]*" id="nationalId" required class="has-icon">
                </div>
                <div class="form-group">
                    <label for="password">رمز عبور</label>
                    <div class="input-icon"><svg class="icon"><use href="#icon-lock"></use></svg></div>
                    <input type="password" id="password" required class="has-icon">
                </div>
                <button type="submit"><span class="btn-text">ورود</span></button>
                <p id="error-message" class="hidden modal-error-message" style="margin-top: 15px;"></p>
            </form>
        </div>
    </div>
    
    <div id="dashboard-section" class="hidden">
        <div class="container">
            <div class="dashboard-header">
                <div id="welcome-message" style="font-size: 1.5rem;"></div>
                <div class="header-loader"></div>
                <div class="header-actions">
                    <button id="edit-email-btn" class="icon-btn"><svg class="icon" style="color:var(--accent-color);"><use href="#icon-email"></use></svg><span class="btn-text">ویرایش ایمیل</span></button>
                    <button id="logout-btn" class="icon-btn delete-btn"><svg class="icon"><use href="#icon-logout"></use></svg><span class="btn-text">خروج</span></button>
                </div>
            </div>
            <div id="create-course-container"><button id="btn-create-course"><span class="btn-text">ایجاد دوره جدید</span></button></div>
            <div id="courses-container" style="margin-top:30px;"></div>
        </div>
    </div>
    <div id="modal-container"></div>
<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxj9p-ogf58R4MTbNEKEu13iNAj-Y8O4xNu0Y96Jsjr-teUSX7UoEHUj_-5HPrSau9P/exec";
    const sessionKey = 'quranTeacherSession';
    let loggedInInstructorId = null, loggedInInstructorName = null, loggedInInstructorEmail = null, tempStudents = []; 
    let currentCourseId = null, currentStudentOriginalId = null;
    let existingStudentsByCourse = {};

    async function callAppsScript(action, params = {}, button = null) {
        if(button) setButtonLoading(button, true);
        try { const res = await fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', headers: {'Content-Type': 'text/plain;charset=utf-8'}, body: JSON.stringify({ action, params }) }); if (!res.ok) throw new Error(`Network error: ${res.statusText}`); return await res.json();
        } catch (error) { showCustomAlert('خطا در ارتباط با سرور.', 'error'); return { success: false, message: error.message };
        } finally { if(button) setButtonLoading(button, false); }
    }
    
    function setButtonLoading(button, isLoading) { if(!button) return; if(isLoading) { button.disabled = true; button.classList.add('btn-loading'); } else { button.disabled = false; button.classList.remove('btn-loading'); } }
    
    function isValidNationalId(nid) { if (!nid) return false; return /^\d{10}$/.test(nid); }
    function isValidEmail(email) { if (!email) return false; return /\S+@\S+\.\S+/.test(email); }

    document.addEventListener('DOMContentLoaded', () => {
        const savedSession = localStorage.getItem(sessionKey);
        if (savedSession) {
            const { nationalId, name, email } = JSON.parse(savedSession);
            showDashboard(nationalId, name, email);
        }
    });

    function showDashboard(nationalId, name, email) {
        loggedInInstructorId = nationalId; 
        loggedInInstructorName = name;
        loggedInInstructorEmail = email;

        document.getElementById('login-container').classList.add('hidden'); 
        document.getElementById('dashboard-section').classList.remove('hidden');
        document.getElementById('welcome-message').innerHTML = `استاد <strong>${name}</strong>، خوش آمدید.`;
        
        document.getElementById('btn-create-course').addEventListener('click', e => showCreateCourseModal(e.target));
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        document.getElementById('edit-email-btn').addEventListener('click', showEditEmailModal);

        fetchDashboardData();
        
        if (!loggedInInstructorEmail) {
            showEmailPromptModal();
        }
    }
    
    async function handleManualLogin(event) {
        event.preventDefault();
        const nationalId = document.getElementById('nationalId').value;
        const password = document.getElementById('password').value;
        const errorP = document.getElementById('error-message');

        if (!isValidNationalId(nationalId)) {
            errorP.innerText = "کد ملی باید یک عدد ۱۰ رقمی صحیح باشد.";
            errorP.classList.remove('hidden');
            return;
        }
        errorP.classList.add('hidden');

        const res = await callAppsScript('checkLogin', { nationalId, password }, event.target.querySelector('button'));
        if (res.success) {
            localStorage.setItem(sessionKey, JSON.stringify({ nationalId: nationalId, name: res.name, email: res.email }));
            showDashboard(nationalId, res.name, res.email);
        } else {
            errorP.innerText = res.message || "خطای ورود.";
            errorP.classList.remove('hidden');
        }
    }

    function handleLogout() { localStorage.removeItem(sessionKey); window.location.reload(); }
    
    function showEmailPromptModal() {
        const content = `
            <p style="text-align: center; margin-bottom: 20px;">لطفا ایمیل خود را جهت اطلاع از وضعیت دوره‌ها و قرآن آموزان وارد کنید.</p>
            <div class="form-group">
                <label for="prompt-email">آدرس ایمیل</label>
                <div class="input-icon"><svg class="icon"><use href="#icon-email"></use></svg></div>
                <input type="email" id="prompt-email" required class="has-icon" style="direction: ltr;">
            </div>
            <div id="modal-error-container" class="hidden" style="margin-bottom: 15px;"></div>
            <div style="text-align:center;"><button onclick="handleEmailPromptSubmit(event)"><span class="btn-text">ذخیره ایمیل</span></button></div>`;
        renderModal('ثبت ایمیل', content, 'narrow');
    }

    async function handleEmailPromptSubmit(event) {
        const emailInput = document.getElementById('prompt-email');
        const email = emailInput.value.trim();
        hideModalError('modal-error-container');

        if (!isValidEmail(email)) {
            showModalError('modal-error-container', 'لطفا یک آدرس ایمیل معتبر وارد کنید.');
            return;
        }

        const res = await callAppsScript('updateTeacherEmail', { instructorId: loggedInInstructorId, newEmail: email }, event.target);
        if (res.success) {
            loggedInInstructorEmail = email;
            const sessionData = JSON.parse(localStorage.getItem(sessionKey));
            sessionData.email = email;
            localStorage.setItem(sessionKey, JSON.stringify(sessionData));

            closeAllModals();
            showCustomAlert('ایمیل شما با موفقیت ثبت شد!', 'success');
        } else {
            showModalError('modal-error-container', res.message);
        }
    }

    function showEditEmailModal() {
        const content = `
            <div class="form-group">
                <label for="edit-email">ایمیل جدید</label>
                <div class="input-icon"><svg class="icon"><use href="#icon-email"></use></svg></div>
                <input type="email" id="edit-email" required class="has-icon" style="direction: ltr;" value="${loggedInInstructorEmail || ''}">
            </div>
            <div id="modal-error-container" class="hidden" style="margin-bottom: 15px;"></div>
            <div style="text-align:center;"><button onclick="handleUpdateEmail(event)"><span class="btn-text">ذخیره تغییرات</span></button></div>`;
        renderModal('ویرایش ایمیل', content, 'narrow');
    }

    async function handleUpdateEmail(event) {
        const emailInput = document.getElementById('edit-email');
        const email = emailInput.value.trim();
        hideModalError('modal-error-container');

        if (!isValidEmail(email)) {
            showModalError('modal-error-container', 'لطفا یک آدرس ایمیل معتبر وارد کنید.');
            return;
        }

        const res = await callAppsScript('updateTeacherEmail', { instructorId: loggedInInstructorId, newEmail: email }, event.target);
        if (res.success) {
            loggedInInstructorEmail = email;
            const sessionData = JSON.parse(localStorage.getItem(sessionKey));
            sessionData.email = email;
            localStorage.setItem(sessionKey, JSON.stringify(sessionData));
            
            closeAllModals();
            showCustomAlert(res.message, 'success');
        } else {
            showModalError('modal-error-container', res.message);
        }
    }

    async function fetchDashboardData() {
        renderSkeletonLoader();
        document.querySelector('.dashboard-header').classList.add('loading');
        const res = await callAppsScript('getInstructorDashboardData', { instructorId: loggedInInstructorId });
        document.querySelector('.dashboard-header').classList.remove('loading');
        if(res.success) renderCourses(res.data); else showCustomAlert("خطا در دریافت اطلاعات: " + res.message, 'error'); return true;
    }
    
    function renderSkeletonLoader() { 
        document.getElementById('create-course-container').innerHTML = '<div class="skeleton button shimmer"></div>';
        let skeletonHTML = ''; for (let i = 0; i < 2; i++) { skeletonHTML += `<div class="skeleton-card shimmer"><div class="skeleton title"></div><div class="skeleton text"></div><div class="skeleton table-head"></div><div class="skeleton table-row"></div><div class="skeleton table-row"></div></div>`; } 
        document.getElementById('courses-container').innerHTML = skeletonHTML;
    }

    function renderCourses(courses) {
        document.getElementById('create-course-container').innerHTML = '<button id="btn-create-course"><span class="btn-text">ایجاد دوره جدید</span></button>';
        document.getElementById('btn-create-course').addEventListener('click', e => showCreateCourseModal(e.target));

        const container = document.getElementById('courses-container');
        container.innerHTML = !courses || courses.length === 0 ? '<p style="text-align: center;">شما هنوز هیچ دوره‌ای ایجاد نکرده‌اید.</p>' : '';
        existingStudentsByCourse = {};

        courses.forEach(course => {
            const isApproved = course.approvalStatus === '5';
            existingStudentsByCourse[course.courseId] = new Set(course.students.map(s => s.nationalId));

            const gregorianStartDate = jalaliToGregorian(...course.startDate.split('/').map(Number));
            const gregorianEndDate = new Date(gregorianStartDate);
            gregorianEndDate.setDate(gregorianStartDate.getDate() + 25);
            
            const p2e = s => s.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d));
            const endDateJalali = p2e(gregorianEndDate.toLocaleDateString('fa-IR', { year: 'numeric', month: '2-digit', day: '2-digit' }));
            
            const today = new Date();
            gregorianStartDate.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);
            const diffDays = Math.ceil((today - gregorianStartDate) / (1000 * 60 * 60 * 24));
            
            const canAddStudent = diffDays < 25 && isApproved;
            const canDeleteCourse = diffDays < 20;
            const canEditDate = diffDays <= 0 && isApproved;
            const canGrade = diffDays >= 25;
            
            let addStudentBtn = canAddStudent ? `<button class="icon-btn" onclick="showAddStudentModal(event, '${course.courseId}')"><svg class="icon"><use href="#icon-plus-circle"></use></svg><span class="btn-text">افزودن قرآن آموز</span></button>` : '';
            let editDateBtn = canEditDate ? `<button class="icon-btn" onclick="showEditDateModal(event, '${course.courseId}')"><svg class="icon"><use href="#icon-pencil"></use></svg><span class="btn-text">ویرایش تاریخ</span></button>` : '';
            let deleteCourseBtn = canDeleteCourse ? `<button class="icon-btn delete-btn" onclick="showDeleteCourseModal(event, '${course.courseId}')"><svg class="icon"><use href="#icon-trash"></use></svg><span class="btn-text">حذف دوره</span></button>` : '';
            
            let statusHtml = '';
            switch (course.approvalStatus) {
                case '5': statusHtml = `<div class="course-status status-approved"><svg class="icon"><use href="#icon-check-circle"></use></svg><span>تایید شده</span></div>`; break;
                case '2': statusHtml = `<div class="course-status status-pending"><svg class="icon"><use href="#icon-clock"></use></svg><span>در حال بررسی</span></div>`; addStudentBtn = ''; break;
                case '0':
                    const reasonText = course.rejectionReason ? `<div class="rejection-reason">${course.rejectionReason}</div>` : '';
                    statusHtml = `<div class="course-status status-rejected"><div class="status-header"><svg class="icon"><use href="#icon-alert-error"></use></svg><span>نیازمند اصلاح</span></div>${reasonText}</div>`;
                    editDateBtn = '';
                    addStudentBtn = `<button class="icon-btn" onclick="showEditRejectedCourseModal(event, '${course.courseId}', '${course.startDate}', '${course.courseCode}')"><svg class="icon"><use href="#icon-pencil"></use></svg><span class="btn-text">ویرایش دوره</span></button>`;
                    break;
                default: statusHtml = '';
            }

            let studentsHtml = '<p style="text-align: center; color: var(--light-text);">هنوز قرآن‌آموزی ثبت نشده است.</p>';
            if (course.students.length > 0) {
                studentsHtml = `<table><thead><tr><th>ردیف</th><th>نام و نام خانوادگی</th><th>کد ملی</th><th>نمره کل</th><th>وضعیت گواهی</th><th>عملیات</th></tr></thead><tbody>
                    ${course.students.map((s, index) => {
                        const hasGrade = s.totalScore && s.totalScore != '0';
                        let scoreDisplay;

                        if (hasGrade) {
                            scoreDisplay = `<strong>${s.totalScore}</strong>`;
                        } else if (isApproved && canGrade) {
                             scoreDisplay = `<button class="icon-btn grade-btn" onclick="showGradingModal(event, '${course.courseId}', '${s.name}', '${s.nationalId}', '${course.courseCode}')"><svg class="icon"><use href="#icon-grade"></use></svg><span class="btn-text">ثبت نمره</span></button>`;
                        } else {
                            scoreDisplay = `<span style="color: var(--light-text); font-size: 0.9em;">غیرفعال</span>`;
                        }
                        
                        let certStatusDisplay = ''; let studentActionsDisplay = '';
                        if (hasGrade) {
                            switch (s.certificateStatus) {
                                case '0': certStatusDisplay = `<span style="color: var(--danger-color); font-weight: bold;">مردود</span>`; studentActionsDisplay = `<span style="color: var(--danger-color); font-size: 1.5rem; font-weight: bold;">—</span>`; break;
                                case '2': certStatusDisplay = `<span>بررسی</span>`; studentActionsDisplay = ``; break;
                                case '5': certStatusDisplay = `<span style="color: var(--success-color); font-weight: bold;">صدور</span>`; studentActionsDisplay = `<a href="https://tashacol.ir/equran.html?id=${s.nationalId}" target="_blank" class="icon-btn" title="مشاهده گواهی"><svg class="icon" style="color:var(--warning-color);"><use href="#icon-star"></use></svg></a>`; break;
                                default: certStatusDisplay = ''; studentActionsDisplay = '';
                            }
                        } else {
                            const editDeleteEnabled = isApproved || course.approvalStatus === '';
                            studentActionsDisplay = editDeleteEnabled ? `<div class="student-actions"><button class="icon-btn edit-btn" onclick="showEditStudentModal(event, '${course.courseId}', '${s.name}', '${s.nationalId}')" title="ویرایش"><svg class="icon"><use href="#icon-pencil"></use></svg></button><button class="icon-btn delete-btn" onclick="showDeleteStudentModal(event, '${course.courseId}', '${s.name}', '${s.nationalId}')" title="حذف"><svg class="icon"><use href="#icon-trash"></use></svg></button></div>` : '';
                        }
                        return `<tr><td>${index + 1}</td><td>${s.name || ''}</td><td>${s.nationalId || ''}</td><td>${scoreDisplay}</td><td>${certStatusDisplay}</td><td>${studentActionsDisplay}</td></tr>`
                    }).join('')}</tbody></table>`;
            }

            container.innerHTML += `<div class="course-card">
                <div class="course-header">
                    <h4>${course.courseName} (کد: ${course.courseId})</h4>
                    <div class="course-header-right">
                        <div class="course-date-container">
                            <span>شروع: <strong>${course.startDate}</strong></span>
                            <span>اتمام: <strong>${endDateJalali}</strong></span>
                        </div>
                        <button class="icon-btn" onclick="showSyllabusModal(event, '${course.courseCode}')" title="مشاهده شیوه نامه">
                            <svg class="icon" style="color: var(--accent-color); width: 1.4em; height: 1.4em;"><use href="#icon-info"></use></svg>
                            <span class="btn-text">شیوه نامه</span>
                        </button>
                    </div>
                </div>
                ${studentsHtml}
                <div class="course-actions">
                    <div class="action-buttons-container">${addStudentBtn}${editDateBtn}${deleteCourseBtn}</div>
                    <div class="course-status-container">${statusHtml}</div>
                </div>
            </div>`;
        });
    }

    const modalContainer = document.getElementById('modal-container');
    function renderModal(title, content, extraClasses = '') { modalContainer.innerHTML = `<div class="modal"><div class="modal-content ${extraClasses}"><div class="modal-header"><h3>${title}</h3><button class="close-btn" onclick="closeAllModals()">×</button></div>${content}</div></div>`; }
    function closeAllModals() { modalContainer.innerHTML = ''; }
    function showCustomAlert(message, type = 'info') { const icons = { success: 'icon-alert-success', error: 'icon-alert-error', info: 'icon-alert-confirm' }; const iconClass = type === 'info' ? 'confirm' : type; const content = `<div class="alert-icon ${iconClass}"><svg class="icon"><use href="#${icons[type]}"></use></svg></div><p class="alert-message">${message}</p><div class="alert-buttons"><button onclick="closeAllModals()"><span class="btn-text">باشه</span></button></div>`; modalContainer.innerHTML = `<div class="modal"><div class="modal-content alert-modal-content">${content}</div></div>`; }
    function showCustomConfirm(message) { return new Promise((resolve) => { const content = `<div class="alert-icon confirm"><svg class="icon"><use href="#icon-alert-confirm"></use></svg></div><p class="alert-message">${message}</p><div class="alert-buttons"><button id="confirm-btn-yes"><span class="btn-text">تایید</span></button><button id="confirm-btn-no" class="secondary"><span class="btn-text">لغو</span></button></div>`; modalContainer.innerHTML = `<div class="modal"><div class="modal-content alert-modal-content">${content}</div></div>`; document.getElementById('confirm-btn-yes').onclick = () => { closeAllModals(); resolve(true); }; document.getElementById('confirm-btn-no').onclick = () => { closeAllModals(); resolve(false); }; }); }
    function showModalError(containerId, message) { const errorContainer = document.getElementById(containerId); if (errorContainer) { errorContainer.innerHTML = `<p class="modal-error-message">${message}</p>`; errorContainer.classList.remove('hidden'); } }
    function hideModalError(containerId) { const errorContainer = document.getElementById(containerId); if (errorContainer) { errorContainer.classList.add('hidden'); errorContainer.innerHTML = ''; } }
    function getTodayJalaliString() { const p2e = s => s.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d)); return p2e(new Date().toLocaleDateString('fa-IR', {year: 'numeric', month: '2-digit', day: '2-digit'})); }
    function populateDatePicker(prefix = 'start', defaultDateStr) { let defaultDay, defaultMonth, defaultYear; if (defaultDateStr) { [defaultYear, defaultMonth, defaultDay] = defaultDateStr.split('/').map(Number); } let opts = { d: '', m: '', y: ''}; for (let i = 1; i <= 31; i++) opts.d += `<option value="${i}" ${i === defaultDay ? 'selected' : ''}>${i}</option>`; ["فروردین","اردیبهشت","خرداد","تیر","مرداد","شهریور","مهر","آبان","آذر","دی","بهمن","اسفند"].forEach((m, i) => opts.m += `<option value="${i+1}" ${i + 1 === defaultMonth ? 'selected' : ''}>${m}</option>`); const currentYear = new Date().toLocaleDateString('fa-IR-u-nu-latn').split('/')[0]; opts.y = `<option value="${currentYear}">${currentYear}</option>`; return `<select id="${prefix}-day">${opts.d}</select><select id="${prefix}-month">${opts.m}</select><select id="${prefix}-year" disabled>${opts.y}</select>`; }
    function jalaliToGregorian(jy, jm, jd) { var sal_a, gy, gm, gd, days; jy += 1595; days = -355668 + (365 * jy) + (~~(jy / 33) * 8) + ~~(((jy % 33) + 3) / 4) + jd + ((jm < 7) ? (jm - 1) * 31 : ((jm - 7) * 30) + 186); gy = 400 * ~~(days / 146097); days %= 146097; if (days > 36524) { gy += 100 * ~~(--days / 36524); days %= 36524; if (days >= 365) days++; } gy += 4 * ~~(days / 1461); days %= 1461; if (days > 365) { gy += ~~((days - 1) / 365); days = (days - 1) % 365; } gd = days + 1; sal_a = [0, 31, ((gy % 4 === 0 && gy % 100 !== 0) || (gy % 400 === 0)) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]; for (gm = 0; gm < 13 && gd > sal_a[gm]; gm++) gd -= sal_a[gm]; return new Date(gy, gm - 1, gd); }
    async function showCreateCourseModal(button) { const res = await callAppsScript('getCourseDefinitions', {}, button); if (!res.success || !res.data || res.data.length === 0) { showCustomAlert(res.message || 'هیچ دوره تعریف شده‌ای برای انتخاب یافت نشد.', 'error'); return; } const courseOptions = res.data.map(course => `<option value="${course.code}">${course.name}</option>`).join(''); const content = `<div class="form-group"><label for="course-definition-select">نام دوره</label><select id="course-definition-select" style="text-align-last: center;">${courseOptions}</select></div><div class="form-group"><label>تاریخ شروع</label>${populateDatePicker('start')}</div><div id="modal-error-container" class="hidden" style="margin-bottom: 15px;"></div><div style="text-align:center;"><button onclick="handleCreateCourse(event)"><span class="btn-text">ایجاد دوره</span></button></div>`; renderModal('ایجاد دوره جدید', content, 'narrow'); }
    async function handleCreateCourse(event) { hideModalError('modal-error-container'); const selectedCourseCode = document.getElementById('course-definition-select').value; const date = `${document.getElementById('start-year').value}/${document.getElementById('start-month').value.padStart(2,'0')}/${document.getElementById('start-day').value.padStart(2,'0')}`; if (!selectedCourseCode) { showModalError("modal-error-container", "لطفا یک دوره را انتخاب کنید."); return; } if (date < getTodayJalaliString()) { showModalError("modal-error-container", "تاریخ انتخابی نمی‌تواند در گذشته باشد."); return; } const res = await callAppsScript('createNewCourse', { instructorId: loggedInInstructorId, startDate: date, courseCode: selectedCourseCode, instructorName: loggedInInstructorName }, event.target); if (res.success) { closeAllModals(); showCustomAlert('دوره با موفقیت ایجاد و برای تایید ارسال شد.', 'success'); fetchDashboardData(); } else { showModalError("modal-error-container", 'خطا: ' + res.message); } }
    async function showEditRejectedCourseModal(event, courseId, originalStartDate, originalCourseCode) { const button = event.target.closest('button'); const res = await callAppsScript('getCourseDefinitions', {}, button); if (!res.success || !res.data || res.data.length === 0) { showCustomAlert(res.message || 'هیچ دوره تعریف شده‌ای برای انتخاب یافت نشد.', 'error'); return; } const courseOptions = res.data.map(course => `<option value="${course.code}" ${course.code === originalCourseCode ? 'selected' : ''}>${course.name}</option>`).join(''); const content = `<div class="form-group"><label for="edit-course-definition-select">نام دوره</label><select id="edit-course-definition-select" style="text-align-last: center;">${courseOptions}</select></div><div class="form-group"><label>تاریخ شروع</label>${populateDatePicker('edit-start', originalStartDate)}</div><div id="modal-error-container" class="hidden" style="margin-bottom: 15px;"></div><div style="text-align:center;"><button onclick="handleUpdateRejectedCourse(event, '${courseId}', '${originalStartDate}')"><span class="btn-text">ثبت ویرایش و ارسال مجدد</span></button></div>`; renderModal('ویرایش دوره', content, 'narrow'); }
    async function handleUpdateRejectedCourse(event, courseId, originalStartDate) { hideModalError('modal-error-container'); const newCourseCode = document.getElementById('edit-course-definition-select').value; const newStartDate = `${document.getElementById('edit-start-year').value}/${document.getElementById('edit-start-month').value.padStart(2,'0')}/${document.getElementById('edit-start-day').value.padStart(2,'0')}`; const today = getTodayJalaliString(); if (!newCourseCode) { showModalError("modal-error-container", "لطفا یک دوره را انتخاب کنید."); return; } if (newStartDate < originalStartDate && newStartDate < today) { showModalError("modal-error-container", `تاریخ جدید نامعتبر است. لطفاً تاریخی از امروز به بعد یا بعد از تاریخ قبلی (${originalStartDate}) انتخاب کنید.`); return; } const res = await callAppsScript('updateRejectedCourse', { courseId: courseId, newCourseCode: newCourseCode, newStartDate: newStartDate }, event.target); if (res.success) { closeAllModals(); showCustomAlert(res.message, 'success'); fetchDashboardData(); } else { showModalError("modal-error-container", 'خطا: ' + res.message); } }
    function showEditDateModal(event, courseId) { currentCourseId = courseId; const content = `<div class="form-group"><label>تاریخ جدید</label>${populateDatePicker('edit')}</div><div id="modal-error-container" class="hidden" style="margin-bottom: 15px;"></div><div style="text-align:center;"><button onclick="handleUpdateCourseDate(event)"><span class="btn-text">ذخیره</span></button></div>`; renderModal('ویرایش تاریخ دوره', content); }
    async function handleUpdateCourseDate(event) { hideModalError('modal-error-container'); const newDate = `${document.getElementById('edit-year').value}/${document.getElementById('edit-month').value.padStart(2, '0')}/${document.getElementById('edit-day').value.padStart(2, '0')}`; if (newDate < getTodayJalaliString()) { showModalError("modal-error-container", "تاریخ انتخابی نمی‌تواند در گذشته باشد."); return; } const res = await callAppsScript('updateCourseDate', { courseId: currentCourseId, newDate }, event.target); if (res.success) { closeAllModals(); showCustomAlert(res.message, 'success'); fetchDashboardData(); } else { showModalError("modal-error-container", "خطا: " + res.message); } }
    function showDeleteCourseModal(event, courseId) { currentCourseId = courseId; const content = `<p style="color:var(--danger-color); text-align:center;">آیا از حذف این دوره و تمام قرآن‌آموزان آن اطمینان دارید؟</p><div class="form-group"><label for="delete-password">برای تایید، رمز عبور را وارد کنید:</label><input type="password" id="delete-password"></div><div id="modal-error-container" class="hidden" style="margin-bottom: 15px;"></div><div style="text-align:center;"><button class="danger" onclick="handleDeleteCourse(event)"><span class="btn-text">بله، حذف کن</span></button></div>`; renderModal('تایید حذف دوره', content); }
    async function handleDeleteCourse(event) { hideModalError('modal-error-container'); const password = document.getElementById('delete-password').value; if (!password) { showModalError("modal-error-container", "رمز عبور الزامی است."); return; } const res = await callAppsScript('deleteCourse', { courseId: currentCourseId, instructorId: loggedInInstructorId, password }, event.target); if (res.success) { closeAllModals(); showCustomAlert(res.message, 'success'); fetchDashboardData(); } else { showModalError("modal-error-container", "خطا: " + res.message); } }
    
    async function showSyllabusModal(event, courseCode) {
        const button = event.target.closest('button');
        const res = await callAppsScript('getSyllabusInfo', { courseCode }, button);

        if (!res.success) {
            showCustomAlert(res.message || 'اطلاعات شیوه نامه یافت نشد.', 'error');
            return;
        }

        const { courseName, syllabusText, pdfLink } = res.data;
        const formattedSyllabusText = syllabusText.replace(/\n/g, '<br>');

        const downloadButtonHTML = pdfLink
            ? `<div style="text-align:center; margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                   <a href="${pdfLink}" target="_blank" download class="btn-like">
                       <svg class="icon" style="width: 1.2em; height: 1.2em; margin-left: 8px; vertical-align: middle;"><use href="#icon-download"></use></svg>
                       <span class="btn-text">دریافت جزوه پیشنهادی</span>
                   </a>
               </div>`
            : '';

        const modalTitle = `<strong>شیوه نامه کلاس های ${courseName}</strong>`;
        const modalContent = `<div class="syllabus-modal-content">${formattedSyllabusText}</div>${downloadButtonHTML}`;

        renderModal(modalTitle, modalContent);
    }
    
    function showAddStudentModal(event, courseId) {
        const existingStudentsCount = existingStudentsByCourse[courseId] ? existingStudentsByCourse[courseId].size : 0;
        if (existingStudentsCount >= 12) {
            showCustomAlert('ظرفیت این کلاس تکمیل شده است (حداکثر ۱۲ نفر). امکان افزودن قرآن آموز جدید وجود ندارد.', 'error');
            return;
        }
        currentCourseId = courseId;
        const savedData = localStorage.getItem(`tempStudents_${currentCourseId}`);
        tempStudents = savedData ? JSON.parse(savedData) : [];
        const content = `<div id="add-student-form">
                <div class="form-group"><label for="student-name">نام</label><input type="text" id="student-name"></div>
                <div class="form-group"><label for="student-nationalId">کد ملی</label><input type="tel" inputmode="numeric" pattern="[0-9]*" id="student-nationalId"></div>
                <div style="text-align:center;"><button onclick="addStudentToTempList(event)"><span class="btn-text">افزودن به لیست</span></button></div>
                <div id="modal-error-container" class="hidden" style="margin-top: 15px;"></div>
            </div>
            <h4 style="margin-top: 25px;">لیست موقت</h4>
            <ul id="temp-student-list"></ul><br>
            <div style="text-align:center;"><button onclick="saveStudentList(event)"><span class="btn-text">ارسال و ذخیره لیست</span></button></div>`;
        renderModal(`افزودن قرآن آموز به دوره ${courseId}`, content);
        renderTempStudentList();
    }

    function renderTempStudentList() {
        const listElement = document.getElementById('temp-student-list');
        if (!listElement) return;
        if (tempStudents.length === 0) {
            listElement.innerHTML = `<li style="justify-content: center; color: var(--light-text);">لیست موقت خالی است.</li>`;
            return;
        }
        listElement.innerHTML = tempStudents.map((student, index) => `<li><span>${student.name} - ${student.nationalId}</span><button class="icon-btn delete-btn temp-student-delete-btn" onclick="promptDeleteTempStudent(${index}, this)" title="حذف از لیست موقت"><svg class="icon"><use href="#icon-trash"></use></svg></button></li>`).join('');
    }

    function saveTempStudentsToLocal() {
        if (currentCourseId) localStorage.setItem(`tempStudents_${currentCourseId}`, JSON.stringify(tempStudents));
    }

    function promptDeleteTempStudent(index, btnElement) {
        const existingConfirmBtn = document.querySelector('.confirm-delete-btn');
        if (existingConfirmBtn && existingConfirmBtn !== btnElement) {
            const originalIndex = existingConfirmBtn.getAttribute('data-index');
            existingConfirmBtn.innerHTML = `<svg class="icon"><use href="#icon-trash"></use></svg>`;
            existingConfirmBtn.onclick = () => promptDeleteTempStudent(originalIndex, existingConfirmBtn);
            existingConfirmBtn.classList.remove('confirm-delete-btn');
            existingConfirmBtn.removeAttribute('data-index');
        }
        btnElement.innerHTML = `<svg class="icon"><use href="#icon-check-circle"></use></svg>`;
        btnElement.onclick = () => confirmDeleteTempStudent(index);
        btnElement.classList.add('confirm-delete-btn');
        btnElement.setAttribute('data-index', index);
    }

    function confirmDeleteTempStudent(index) {
        tempStudents.splice(index, 1);
        saveTempStudentsToLocal();
        renderTempStudentList();
    }

    function addStudentToTempList() {
        hideModalError('modal-error-container');
        const existingStudentsCount = existingStudentsByCourse[currentCourseId] ? existingStudentsByCourse[currentCourseId].size : 0;
        const tempStudentsCount = tempStudents.length;
        if (existingStudentsCount + tempStudentsCount >= 12) {
            showModalError('modal-error-container', 'ظرفیت کلاس تکمیل است. حداکثر تعداد قرآن آموزان در هر دوره ۱۲ نفر می‌باشد.');
            return;
        }
        const nameInput = document.getElementById('student-name'),
            nidInput = document.getElementById('student-nationalId');
        const name = nameInput.value.trim(),
            nationalId = nidInput.value.trim();
        if (!name || !nationalId) {
            showModalError('modal-error-container', 'نام و کد ملی هر دو الزامی هستند.');
            return;
        }
        if (!isValidNationalId(nationalId)) {
            showModalError('modal-error-container', 'کد ملی وارد شده نامعتبر است. لطفاً یک کد ملی ۱۰ رقمی وارد کنید.');
            return;
        }
        if (tempStudents.some(s => s.nationalId === nationalId)) {
            showModalError('modal-error-container', 'این کد ملی در لیست موقت شما وجود دارد.');
            return;
        }
        if (existingStudentsByCourse[currentCourseId] && existingStudentsByCourse[currentCourseId].has(nationalId)) {
            showModalError('modal-error-container', 'این قرآن‌آموز قبلاً در این دوره ثبت‌نام شده است.');
            return;
        }
        tempStudents.push({ name: name, nationalId: nationalId });
        saveTempStudentsToLocal();
        renderTempStudentList();
        nameInput.value = '';
        nidInput.value = '';
        nameInput.focus();
    }

    async function saveStudentList(event) {
        hideModalError('modal-error-container');
        if (tempStudents.length === 0) {
            showModalError('modal-error-container', 'لیست افزودن قرآن‌آموزان خالی است. ابتدا شخصی را به لیست اضافه کنید.');
            return;
        }
        const existingStudentsCount = existingStudentsByCourse[currentCourseId] ? existingStudentsByCourse[currentCourseId].size : 0;
        if (existingStudentsCount + tempStudents.length > 12) {
            showModalError('modal-error-container', `امکان افزودن این تعداد قرآن آموز وجود ندارد. ظرفیت نهایی کلاس ۱۲ نفر است و در حال حاضر ${12 - existingStudentsCount} جای خالی باقی مانده است.`);
            return;
        }
        const res = await callAppsScript('addStudentsToCourse', { courseId: currentCourseId, students: tempStudents, instructorName: loggedInInstructorName }, event.target);
        if (res.success) {
            localStorage.removeItem(`tempStudents_${currentCourseId}`);
            tempStudents = [];
            closeAllModals();
            showCustomAlert(res.message, 'success');
            fetchDashboardData();
        } else {
            showModalError('modal-error-container', `خطا: ${res.message}`);
        }
    }
    
    function showEditStudentModal(event, courseId, name, nid) { currentCourseId = courseId; currentStudentOriginalId = nid; const content = `<div class="form-group"><label for="edit-student-name">نام</label><input type="text" id="edit-student-name" value="${name}"></div><div class="form-group"><label for="edit-student-nationalId">کد ملی</label><input type="tel" inputmode="numeric" pattern="[0-9]*" id="edit-student-nationalId" value="${nid}"></div><div id="modal-error-container" class="hidden" style="margin-bottom: 15px;"></div><div style="text-align:center;"><button onclick="handleUpdateStudent(event)"><span class="btn-text">ذخیره</span></button></div>`; renderModal('ویرایش قرآن آموز', content); }
    async function handleUpdateStudent(event) { hideModalError('modal-error-container'); const newName = document.getElementById('edit-student-name').value.trim(), newNid = document.getElementById('edit-student-nationalId').value.trim(); if(!newName || !newNid) { showModalError('modal-error-container', "فیلدها نباید خالی باشند."); return; } if(!isValidNationalId(newNid)) { showModalError('modal-error-container', "کد ملی وارد شده نامعتبر است. لطفاً یک کد ملی ۱۰ رقمی وارد کنید."); return; } const res = await callAppsScript('updateStudentInfo', { courseId: currentCourseId, originalNationalId: currentStudentOriginalId, newName, newNationalId: newNid }, event.target); if (res.success) { closeAllModals(); showCustomAlert(res.message, 'success'); fetchDashboardData(); } else { showModalError('modal-error-container', "خطا: " + res.message); } }
    function showDeleteStudentModal(event, courseId, studentName, studentNationalId) { currentCourseId = courseId; currentStudentOriginalId = studentNationalId; renderModal('تایید حذف قرآن‌آموز', `<p style="text-align:center;">آیا از حذف قرآن‌آموز <strong>${studentName}</strong> (کد ملی: ${studentNationalId}) اطمینان دارید؟</p><p style="color:var(--danger-color); text-align:center;">این عمل غیرقابل بازگشت است.</p><div style="text-align:center;"><button class="danger" onclick="handleDeleteStudent(event)"><span class="btn-text">بله، حذف کن</span></button></div>`); }
    async function handleDeleteStudent(event) { const res = await callAppsScript('deleteStudent', { courseId: currentCourseId, studentNationalId: currentStudentOriginalId }, event.target); if (res.success) { closeAllModals(); showCustomAlert(res.message, 'success'); fetchDashboardData(); } else { showCustomAlert("خطا: " + res.message, 'error'); } }
    
    async function showGradingModal(event, courseId, studentName, studentNationalId, courseCode) {
        const res = await callAppsScript('getGradingCriteria', { courseCode }, event.target.closest('button'));
        
        if (!res.success || !res.data || res.data.length === 0) {
            showCustomAlert(res.message || 'ساختار نمره‌دهی برای این دوره یافت نشد.', 'error');
            return;
        }
        
        currentCourseId = courseId;
        currentStudentOriginalId = studentNationalId;

        let gradeInputsHTML = res.data.map((item, index) => {
            return `<div class="form-group grade-input-group">
                        <label for="g${index + 1}">${item.title} (از ${item.maxScore})</label>
                        <input type="number" id="g${index + 1}" min="0" max="${item.maxScore}">
                    </div>`;
        }).join('');

        const content = `<div class="grading-modal-header">
                            <div><span class="student-name">${studentName}</span></div>
                            <div style="font-size: 0.9rem; color: var(--light-text);">کد ملی: ${studentNationalId}</div>
                        </div>
                        <div id="grading-form-content">
                            ${gradeInputsHTML}
                            <div id="modal-error-container" class="hidden" style="margin-bottom: 15px;"></div>
                            <div style="text-align:center;">
                                <button onclick="handleGradeSubmission(event, '${studentName}')" data-step="initial">
                                    <span class="btn-text">تایید و ارسال نمرات</span>
                                </button>
                            </div>
                        </div>`;
        
        renderModal('ثبت نمره برای قرآن آموز', content, 'narrow');
    }
    
    // --- START: MODIFIED FUNCTION (FIXED LOGIC) ---
    async function handleGradeSubmission(event, studentName) {
        const submissionButton = event.target.closest('button');
        const buttonText = submissionButton.querySelector('.btn-text');
        hideModalError('modal-error-container');

        // مرحله اول: اعتبارسنجی و درخواست تایید
        if (submissionButton.dataset.step === 'initial') {
            const gradeInputs = document.querySelectorAll('.grade-input-group input[type="number"]');
            let isValid = true;
            for (let i = 0; i < gradeInputs.length; i++) {
                const input = gradeInputs[i];
                const gradeVal = input.value;
                const maxScore = Number(input.max);
                const labelText = input.previousElementSibling.textContent;

                if (gradeVal === '' || isNaN(gradeVal) || gradeVal < 0 || gradeVal > maxScore) {
                    showModalError('modal-error-container', `نمره برای "${labelText}" باید عددی بین 0 و ${maxScore} باشد.`);
                    isValid = false;
                    break;
                }
            }

            if (isValid) {
                submissionButton.dataset.step = 'confirm';
                submissionButton.classList.add('danger');
                buttonText.innerText = 'برای تایید نهایی مجدد کلیک کنید';
            }
            return; // توقف اجرا تا کلیک دوم
        }

        // مرحله دوم: ارسال نهایی پس از تایید
        if (submissionButton.dataset.step === 'confirm') {
            const grades = {};
            const gradeInputs = document.querySelectorAll('.grade-input-group input[type="number"]');

            for (let i = 0; i < gradeInputs.length; i++) {
                const input = gradeInputs[i];
                grades[`g${i + 1}`] = Number(input.value);
            }
            for (let i = gradeInputs.length + 1; i <= 5; i++) {
                grades[`g${i}`] = '';
            }

            setButtonLoading(submissionButton, true);

            const res = await callAppsScript('submitStudentGrades', { 
                courseId: currentCourseId, 
                studentNationalId: currentStudentOriginalId, 
                studentName: studentName, 
                grades: grades 
            });
            
            setButtonLoading(submissionButton, false);

            if (res.success) {
                const modalContent = document.querySelector('#grading-form-content');
                if (modalContent) {
                    modalContent.innerHTML = `
                        <div style="text-align:center;">
                            <div class="alert-icon success" style="font-size: 3rem;"><svg class="icon"><use href="#icon-alert-success"></use></svg></div>
                            <p class="alert-message" style="font-size: 1rem;">${res.message}</p>
                            <div class="alert-buttons">
                                <button onclick="closeAllModals(); fetchDashboardData();"><span class="btn-text">بسیار خب</span></button>
                            </div>
                        </div>`;
                }
            } else {
                showModalError('modal-error-container', "خطا: " + res.message);
                // بازگرداندن دکمه به حالت اولیه
                submissionButton.dataset.step = 'initial';
                submissionButton.classList.remove('danger');
                buttonText.innerText = 'تایید و ارسال نمرات';
            }
        }
    }
    // --- END: MODIFIED FUNCTION (FIXED LOGIC) ---
</script>
</body>
</html>
