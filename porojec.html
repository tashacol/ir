<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>درخواست گواهی و تکالیف</title>
  <!-- آیکون‌های Font Awesome برای دکمه‌ها -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <!-- CSS کلی برای صفحه -->
  <style>
    body {
      font-family: Tahoma, Arial, sans-serif;
      direction: rtl;
      text-align: right;
      margin: 20px;
      font-size: 14px;
      background-color: #f9f9f9;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .container {
      max-width: 500px;
      margin: 20px auto;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background-color: #fff;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    input {
      display: block;
      width: calc(100% - 40px);
      margin: 10px auto;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      font-size: 16px;
      text-align: center;
      transition: border-color 0.3s;
      box-sizing: border-box;
    }
    input:focus {
      border-color: #4CAF50;
      outline: none;
    }
    .btn {
      display: block;
      width: calc(100% - 40px);
      margin: 10px auto;
      padding: 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s, transform 0.2s;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .btn:hover {
      background-color: #45a049;
      transform: translateY(-2px);
    }
    .btn-signature {
      background-color: white;
      color: black;
      border: 1px solid #ccc;
    }
    .btn-signature:hover {
      background-color: #f0f0f0;
    }
    .btn-print {
      display: flex;
      align-items: center;
      justify-content: center;
      width: calc(100% - 40px);
      margin: 10px auto;
      padding: 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    .btn-print i {
      margin-right: 5px;
    }
    .btn-print:hover {
      background-color: #66BB6A;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
      transform: scale(1.05);
    }
    .output {
      display: none;
      max-width: 500px;
      margin: 20px auto;
      border: 1px solid #000;
      padding: 20px;
      line-height: 1.6;
      text-align: center;
      border-radius: 5px;
      background-color: #fff;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    table.result-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table.result-table th,
    table.result-table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    /* استایل لودینگ */
    .loader {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #4CAF50;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* پنجره مدال امضای دیجیتال */
    #signatureModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    #signatureModal canvas {
      background-color: #fff;
      border: 2px solid #000;
      border-radius: 5px;
      touch-action: none;
    }
    .modal-buttons {
      margin-top: 10px;
    }
    /* پنجره اخطار */
    #warningModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 3000;
    }
    #warningModal .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      max-width: 90%;
      text-align: center;
    }
    #warningModal .modal-content p {
      margin: 0 0 20px;
      font-size: 16px;
    }
    #warningModal .modal-content button {
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    #warningModal .modal-content button:hover {
      background-color: #45a049;
    }
    /* استایل چاپ مناسب A4 */
    @media print {
      @page {
        size: A4;
        margin: 20mm;
      }
      body {
        direction: rtl;
        text-align: center;
        font-size: 20px;
      }
      table.result-table th,
      table.result-table td {
        border: 1px solid #000;
      }
    }
  </style>
  <!-- کتابخانه XLSX جهت خواندن اکسل از منابع معتبر -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- کتابخانه SweetAlert2 برای نمایش پیام‌های زیبا -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

  <h1>درخواست گواهی و تکالیف</h1>

  <!-- مرحله 1: دریافت کد ملی -->
  <div class="container" id="idcodeContainer">
    <input type="tel" id="idcode" placeholder="کد ملی را وارد کنید" maxlength="10" required oninput="validateIdCode()" />
    <small id="idcode-error" style="color: red; display: none;">کد ملی باید 10 رقمی و عددی باشد.</small>
  </div>
  <div class="container" id="validateContainer">
    <button class="btn" onclick="validateNationalCode()">اعتبار سنجی</button>
  </div>

  <!-- لودینگ -->
  <div id="loadingIndicator" class="container" style="display: none;">
    <div class="loader"></div>
    <p>در حال بررسی...</p>
  </div>

  <!-- مرحله 2: نمایش اطلاعات دریافت‌شده -->
  <div class="container" id="fullnameContainer" style="display: none;">
    <input type="text" id="fullname" placeholder="نام و نام خانوادگی" required />
  </div>
  <div class="container" id="courseNameContainer" style="display: none;">
    <input type="text" id="courseName" placeholder="نام دوره" required />
  </div>
  <div class="container" id="courseCodeContainer" style="display: none;">
    <input type="text" id="courseCode" placeholder="کد دوره" required />
  </div>

  <!-- مرحله 3: امضای دیجیتال -->
  <div class="container" id="signatureContainer" style="display: none;">
    <button class="btn btn-signature" onclick="openSignatureModal()">امضا کنید</button>
    <img id="signatureImage" alt="امضا" style="display: none; margin-top: 10px; border: 1px solid #000; max-width: 300px; max-height: 300px;" />
  </div>

  <!-- مرحله 4: استعلام تکالیف و نمایش نتایج -->
  <div class="container" id="projectSetupContainer" style="display: none;">
    <button class="btn" onclick="handleProjectSetup()">نمایش نتایج</button>
  </div>

  <!-- نمایش نتایج به صورت ستونی -->
  <div class="output" id="outputContainer">
    <h2>اطلاعات کاربر و دوره</h2>
    <table class="result-table">
      <tr><th>نام و نام خانوادگی</th><td id="out-fullname"></td></tr>
      <tr><th>کد ملی</th><td id="out-idcode"></td></tr>
      <tr><th>نام دوره</th><td id="out-courseName"></td></tr>
      <tr><th>کد دوره</th><td id="out-courseCode"></td></tr>
    </table>
    <h3 style="margin-top:20px;">تکالیف</h3>
    <div id="out-assignments" style="text-align: left;"></div>
  </div>

  <!-- پنجره مدال امضای دیجیتال -->
  <div id="signatureModal">
    <div>
      <canvas id="signatureCanvas" width="400" height="200" style="touch-action: none;"></canvas>
      <div class="modal-buttons">
        <button class="btn" onclick="saveSignature()">تایید</button>
        <button class="btn" onclick="clearSignature()">پاک کردن امضا</button>
        <button class="btn" onclick="closeSignatureModal()">لغو</button>
      </div>
    </div>
  </div>

  <!-- پنجره اخطار -->
  <div id="warningModal">
    <div class="modal-content">
      <p id="warningMessage"></p>
      <button onclick="closeWarningModal()">تایید</button>
    </div>
  </div>

  <!-- اسکریپت‌های کاربردی -->
  <script>
    // آدرس‌های گوگل شیت‌ها
    const googleSheetUrl1 = 'https://docs.google.com/spreadsheets/d/1QSRAGajWtCWHJHsU-u4dRW85nq2hCGySKqtZQL0iTjY/export?format=xlsx';
    const googleSheetUrl2 = 'https://docs.google.com/spreadsheets/d/1XF4pEc5pAKAFQFo2EInBrgLgu7uJBgQlv5U-mVCw8KE/export?format=xlsx';

    /* ------------------ توابع امضای دیجیتال ------------------ */
    let drawing = false;
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    canvas.addEventListener('mousedown', startDrawing, { passive: false });
    canvas.addEventListener('mousemove', draw, { passive: false });
    canvas.addEventListener('mouseup', stopDrawing, { passive: false });
    canvas.addEventListener('mouseleave', stopDrawing, { passive: false });
    canvas.addEventListener('touchstart', startDrawing, { passive: false });
    canvas.addEventListener('touchmove', draw, { passive: false });
    canvas.addEventListener('touchend', stopDrawing, { passive: false });
    function startDrawing(e) { e.preventDefault(); drawing = true; ctx.beginPath(); ctx.moveTo(getX(e), getY(e)); }
    function stopDrawing(e) { e.preventDefault(); drawing = false; }
    function draw(e) { e.preventDefault(); if (!drawing) return; ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.strokeStyle = '#00008B'; ctx.lineTo(getX(e), getY(e)); ctx.stroke(); }
    function getX(e) { if (e.touches) return e.touches[0].clientX - canvas.getBoundingClientRect().left; return e.clientX - canvas.getBoundingClientRect().left; }
    function getY(e) { if (e.touches) return e.touches[0].clientY - canvas.getBoundingClientRect().top; return e.clientY - canvas.getBoundingClientRect().top; }
    function openSignatureModal() { document.getElementById('signatureModal').style.display = 'flex'; }
    function closeSignatureModal() { document.getElementById('signatureModal').style.display = 'none'; }
    function saveSignature() { const signatureImage = document.getElementById('signatureImage'); signatureImage.src = canvas.toDataURL('image/png'); signatureImage.style.display = 'block'; closeSignatureModal(); }
    function clearSignature() { ctx.clearRect(0, 0, canvas.width, canvas.height); document.getElementById('signatureImage').style.display = 'none'; }

    /* ------------------ پنجره اخطار ------------------ */
    function showWarning(message) { document.getElementById('warningMessage').innerText = message; document.getElementById('warningModal').style.display = 'flex'; }
    function closeWarningModal() { document.getElementById('warningModal').style.display = 'none'; }

    /* ------------------ اعتبارسنجی کد ملی ------------------ */
    function validateIdCode() {
      const idcode = document.getElementById('idcode').value;
      const errorMessage = document.getElementById('idcode-error');
      errorMessage.style.display = (idcode.length !== 10 || isNaN(idcode)) ? 'inline' : 'none';
    }

    /* ------------------ دریافت اطلاعات از اولین اکسل ------------------ */
    function validateNationalCode() {
      const idcode = document.getElementById('idcode').value.trim();
      if (idcode.length !== 10 || isNaN(idcode)) {
        document.getElementById('idcode-error').style.display = 'inline';
        return;
      } else {
        document.getElementById('idcode-error').style.display = 'none';
      }
      document.getElementById('loadingIndicator').style.display = 'block';
      fetch(googleSheetUrl1)
        .then(response => response.arrayBuffer())
        .then(data => {
          const wb = XLSX.read(data, { type: 'array' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
          let found = false, fullName = "", courseName = "", courseCode = "";
          for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            // ستون B (index 1) = کد ملی، ستون C (2)=نام، G (6)=نام دوره، H (7)=کد دوره
            if (row[1] && String(row[1]).trim() === idcode) {
              fullName = row[2] || "";
              courseName = row[6] || "";
              courseCode = row[7] || "";
              found = true;
              break;
            }
          }
          document.getElementById('loadingIndicator').style.display = 'none';
          if (found) {
            // پر کردن فیلدها
            const fn = document.getElementById('fullname');
            const cn = document.getElementById('courseName');
            const cc = document.getElementById('courseCode');
            fn.value = fullName; fn.setAttribute('readonly','readonly');
            cn.value = courseName; cn.setAttribute('readonly','readonly');
            cc.value = courseCode; cc.setAttribute('readonly','readonly');
            // نمایش مراحل بعدی
            document.getElementById('idcodeContainer').style.display = 'none';
            document.getElementById('validateContainer').style.display = 'none';
            document.getElementById('fullnameContainer').style.display = 'block';
            document.getElementById('courseNameContainer').style.display = 'block';
            document.getElementById('courseCodeContainer').style.display = 'block';
            document.getElementById('signatureContainer').style.display = 'block';
            document.getElementById('projectSetupContainer').style.display = 'block';
          } else {
            showWarning('کد ملی یافت نشد.');
          }
        })
        .catch(err => {
          document.getElementById('loadingIndicator').style.display = 'none';
          showWarning('خطا در بارگذاری اطلاعات.');
          console.error(err);
        });
    }

    /* ------------------ نمایش نتایج و تکالیف به صورت ستونی ------------------ */
    function handleProjectSetup() {
      const fullname = document.getElementById('fullname').value.trim();
      const idcode    = document.getElementById('idcode').value.trim();
      const courseName= document.getElementById('courseName').value.trim();
      const courseCode= document.getElementById('courseCode').value.trim();
      const signature = document.getElementById('signatureImage').src;
      if (!fullname || !idcode || idcode.length!==10 || !courseName || !courseCode || !signature) {
        showWarning('لطفاً ابتدا اطلاعات را به‌طور کامل تکمیل و امضا نمایید.');
        return;
      }
      document.getElementById('loadingIndicator').style.display = 'block';
      fetch(googleSheetUrl2)
        .then(res => res.arrayBuffer())
        .then(data => {
          const wb = XLSX.read(data, { type:'array' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(ws, { header:1 }).slice(1);
          const matches = rows.filter(r=>r[1] && String(r[1]).trim()===idcode);
          document.getElementById('loadingIndicator').style.display = 'none';
          if (!matches.length) {
            Swal.fire({ icon:'error', title:'خطا!', text:'هیچ داده‌ای یافت نشد.', confirmButtonText:'باشه' });
            return;
          }
          // استخراج تکالیف از ستون D (index 3)
          const assignments = matches.map(r=>r[3]).filter(x=>x).join('\n');
          // نمایش در سایت
          document.getElementById('out-fullname').innerText   = fullname;
          document.getElementById('out-idcode').innerText     = idcode;
          document.getElementById('out-courseName').innerText = courseName;
          document.getElementById('out-courseCode').innerText = courseCode;
          // نمایش تکالیف
          const am = document.getElementById('out-assignments');
          am.innerHTML = assignments.split('\n').map(line=>`<div>${line}</div>`).join('');
          document.getElementById('outputContainer').style.display = 'block';
        })
        .catch(err=>{
          document.getElementById('loadingIndicator').style.display = 'none';
          Swal.fire({ icon:'error', title:'خطا!', text:'خطا در دریافت داده‌ها.', confirmButtonText:'باشه' });
          console.error(err);
        });
    }
  </script>
</body>
</html>
