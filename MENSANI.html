<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل مدیریت سامانه</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        :root {
            --primary: #17a2b8; --primary-light: #e8f6f8; --primary-dark: #117a8b;
            --text-dark: #212529; --text-light: #6c757d; --text-on-dark: #ffffff;
            --bg-main: #f0f3f5; --bg-card: #ffffff; --border-color: #dee2e6;
            --success: #28a745; --danger: #dc3545; --warning: #ffc107; --info: #007bff;
            --shadow: 0 4px 25px rgba(0,0,0,0.08); --radius-lg: 16px; --radius-md: 12px;
            --transition: 0.3s ease;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--bg-main); color: var(--text-dark); line-height: 1.7; }
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Login View */
        #admin-login-view { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; animation: fadeIn 0.5s; background: linear-gradient(135deg, #e0eafc, #cfdef3); }
        .login-container { width: 100%; max-width: 450px; background: var(--bg-card); padding: 40px; border-radius: var(--radius-lg); box-shadow: var(--shadow); }
        .login-header { text-align: center; margin-bottom: 30px; }
        .login-header h1 { font-size: 2rem; color: var(--primary); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-input { width: 100%; padding: 12px 15px; border-radius: var(--radius-md); border: 1px solid var(--border-color); font-size: 1rem; font-family: inherit; transition: var(--transition); }
        .form-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); outline: none; }
        .btn-submit { width: 100%; padding: 14px; font-size: 1.1rem; font-weight: 500; background: var(--primary); color: var(--text-on-dark); border: none; border-radius: var(--radius-md); cursor: pointer; transition: var(--transition); position: relative; display: flex; align-items: center; justify-content: center; min-height: 50px; }
        .btn-submit:hover:not(:disabled) { background: var(--primary-dark); }
        .btn-submit:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        .btn-submit .spinner { width: 22px; height: 22px; border: 3px solid rgba(255,255,255,0.3); border-top-color: var(--text-on-dark); border-radius: 50%; animation: spin 0.8s linear infinite; display: none; position: absolute; }
        .btn-submit.loading .btn-text { visibility: hidden; }
        .btn-submit.loading .spinner { display: block; }
        #login-error-msg { margin-top: 15px; color: var(--danger); min-height: 20px; font-weight: 500; text-align: center; }

        /* Dashboard View */
        #admin-dashboard-view { animation: fadeIn 0.5s; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background: var(--bg-card); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .admin-info span { font-weight: 700; color: var(--primary); }
        .btn-logout { background: var(--danger); width: auto; padding: 8px 15px; color: #fff; border-radius: var(--radius-md); border: none; cursor: pointer; }
        
        .dashboard-container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        .card { background: var(--bg-card); border-radius: var(--radius-lg); box-shadow: var(--shadow); padding: 25px; margin-bottom: 30px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .card-header h2 { font-size: 1.3rem; margin: 0; }
        .badge { background-color: var(--primary-light); color: var(--primary-dark); padding: 4px 10px; border-radius: 20px; font-weight: 700; font-size: 0.9rem; }
        
        .item-list { list-style-type: none; }
        .item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid var(--border-color); border-radius: var(--radius-md); margin-bottom: 10px; }
        .item-details { display: flex; flex-direction: column; }
        .item-title { font-weight: 700; margin-bottom: 5px; }
        .item-meta { font-size: 0.9rem; color: var(--text-light); }
        .item-actions button { border: none; padding: 8px 15px; border-radius: var(--radius-md); cursor: pointer; font-weight: 500; margin-right: 5px; }
        .btn-approve { background-color: var(--success); color: #fff; }
        .btn-reject { background-color: var(--danger); color: #fff; }

        .search-form { display: flex; gap: 15px; margin-bottom: 20px; }
        #search-results-container { min-height: 100px; padding-top: 20px; }
        .user-profile-card { background-color: var(--primary-light); padding: 20px; border-radius: var(--radius-md); margin-bottom: 20px; }
        .user-profile-card h3 { margin-bottom: 15px; }
        .profile-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        
        .activity-history-item { border-left: 3px solid; padding: 15px; margin-bottom: 10px; border-radius: 8px; }
        .activity-history-item[data-status="0"] { border-color: var(--warning); background-color: #fff9e6; }
        .activity-history-item[data-status="1"] { border-color: var(--danger); background-color: #fff5f5; }
        .activity-history-item[data-status="5"] { border-color: var(--success); background-color: #f0fff4; }

        #toast-container { position: fixed; top: 20px; left: 20px; z-index: 1001; display: flex; flex-direction: column; gap: 10px; direction: ltr; }
    </style>
</head>
<body>

    <div id="admin-login-view">
        <div class="login-container">
            <div class="login-header"><h1>پنل مدیریت</h1><p>برای ورود، اطلاعات خود را وارد کنید</p></div>
            <form id="admin-login-form">
                <div class="form-group"><label for="admin-username">نام کاربری</label><input type="text" id="admin-username" class="form-input" required></div>
                <div class="form-group"><label for="admin-password">رمز عبور</label><input type="password" id="admin-password" class="form-input" required></div>
                <button type="submit" class="btn-submit"><span class="btn-text">ورود</span><div class="spinner"></div></button>
            </form>
            <p id="login-error-msg"></p>
        </div>
    </div>

    <div id="admin-dashboard-view" class="hidden">
        <header class="admin-header">
            <div class="admin-info">خوش آمدید، <span id="admin-name-display"></span>!</div>
            <button id="logout-btn" class="btn-logout"><i class="fas fa-sign-out-alt"></i> خروج</button>
        </header>
        <main class="dashboard-container">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-user-check" style="color: var(--info)"></i> ثبت‌نام‌های در انتظار بررسی</h2>
                    <span class="badge" id="pending-users-count">0</span>
                </div>
                <ul id="pending-users-list" class="item-list"><li>موردی برای نمایش وجود ندارد.</li></ul>
            </div>
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-tasks" style="color: var(--warning)"></i> فعالیت‌های در انتظار بررسی</h2>
                    <span class="badge" id="pending-activities-count">0</span>
                </div>
                <ul id="pending-activities-list" class="item-list"><li>موردی برای نمایش وجود ندارد.</li></ul>
            </div>
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-search"></i> جستجوی کاربر</h2>
                </div>
                <form id="user-search-form" class="search-form">
                    <input type="text" id="search-nid" class="form-input" placeholder="کد ملی کاربر را وارد کنید..." required inputmode="numeric">
                    <button type="submit" class="btn-submit" style="width: auto; padding: 0 30px;">جستجو</button>
                </form>
                <div id="search-results-container">
                    <p>برای مشاهده سوابق کاربر، کد ملی او را جستجو کنید.</p>
                </div>
            </div>
        </main>
    </div>
    
    <div id="toast-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx_USt6iFHiAMKZXSmfQqDnl95hYw2prf-V5SWaPLU25YXNyBUBhQjgoqwwHzRyPgrizg/exec"; // ⚠️ مهم: این آدرس را با آدرس خودتان جایگزین کنید

            const loginView = document.getElementById('admin-login-view');
            const dashboardView = document.getElementById('admin-dashboard-view');
            const adminLoginForm = document.getElementById('admin-login-form');
            const adminNameDisplay = document.getElementById('admin-name-display');
            const logoutBtn = document.getElementById('logout-btn');

            // توابع پایه (showToast, toggleButtonLoading)
            const showToast = (message, type = 'info') => {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                let icon = 'fa-info-circle';
                if (type === 'success') icon = 'fa-check-circle';
                if (type === 'error') icon = 'fa-times-circle';
                toast.innerHTML = `<i class="fas ${icon} toast-icon"></i><span class="toast-text">${message.replace(/</g, "&lt;")}</span>`;
                container.appendChild(toast);
                setTimeout(() => { toast.classList.add('hide'); toast.addEventListener('animationend', () => toast.remove()); }, 5000);
            };

            const toggleButtonLoading = (btn, isLoading) => {
                btn.classList.toggle('loading', isLoading);
                btn.disabled = isLoading;
            };
            
            // ارتباط با سرور از طریق POST
            const apiRequest = async (params) => {
                const token = sessionStorage.getItem('adminAuthToken');
                if (token) params.token = token;

                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(params)
                    });
                    if (!response.ok) throw new Error('خطای شبکه.');
                    const result = await response.json();
                    if (!result.success && result.message.includes("نشست شما نامعتبر")) {
                        handleLogout(false);
                        showToast(result.message, 'error');
                    }
                    return result;
                } catch (error) {
                    console.error("API Request Error:", error);
                    return { success: false, message: 'خطا در ارتباط با سرور.' };
                }
            };

            // مدیریت ورود
            adminLoginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('.btn-submit');
                toggleButtonLoading(btn, true);
                document.getElementById('login-error-msg').textContent = '';

                const result = await apiRequest({
                    action: 'adminLogin',
                    username: document.getElementById('admin-username').value,
                    password: document.getElementById('admin-password').value
                });

                toggleButtonLoading(btn, false);
                if (result.success) {
                    sessionStorage.setItem('adminAuthToken', result.token);
                    sessionStorage.setItem('adminUser', JSON.stringify(result.adminData));
                    initDashboard(result.adminData);
                } else {
                    document.getElementById('login-error-msg').textContent = result.message;
                }
            });

            // مدیریت خروج
            const handleLogout = (showSuccessMessage = true) => {
                sessionStorage.clear();
                dashboardView.classList.add('hidden');
                loginView.classList.remove('hidden');
                adminLoginForm.reset();
                if (showSuccessMessage) showToast('با موفقیت خارج شدید.', 'info');
            };
            logoutBtn.addEventListener('click', () => handleLogout(true));

            // راه‌اندازی داشبورد
            const initDashboard = async (adminData) => {
                if (!adminData) return;
                loginView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                adminNameDisplay.textContent = adminData.name;
                await fetchDashboardData();
            };

            // دریافت و نمایش داده‌های داشبورد
            const fetchDashboardData = async () => {
                const result = await apiRequest({ action: 'getAdminDashboardData' });
                if (result.success) {
                    renderPendingUsers(result.data.pendingUsers);
                    renderPendingActivities(result.data.pendingActivities);
                } else {
                    showToast(result.message, 'error');
                }
            };

            const renderPendingUsers = (users) => {
                const list = document.getElementById('pending-users-list');
                const countBadge = document.getElementById('pending-users-count');
                list.innerHTML = '';
                countBadge.textContent = users.length;

                if (users.length === 0) {
                    list.innerHTML = '<li>موردی برای نمایش وجود ندارد.</li>';
                    return;
                }

                users.forEach(user => {
                    const item = document.createElement('li');
                    item.className = 'item';
                    item.id = `user-${user.nationalId}`;
                    item.innerHTML = `
                        <div class="item-details">
                            <div class="item-title">${escapeHTML(user.fullName)}</div>
                            <div class="item-meta">کد ملی: ${escapeHTML(user.nationalId)} | تاریخ ثبت‌نام: ${escapeHTML(user.regDate)}</div>
                        </div>
                        <div class="item-actions">
                            <button class="btn-approve" data-nid="${user.nationalId}">تایید</button>
                            <button class="btn-reject" data-nid="${user.nationalId}">رد</button>
                        </div>`;
                    list.appendChild(item);
                });
                
                // افزودن Event Listener ها
                list.querySelectorAll('.btn-approve, .btn-reject').forEach(btn => {
                    btn.addEventListener('click', handleUserStatusUpdate);
                });
            };

            const renderPendingActivities = (activities) => {
                const list = document.getElementById('pending-activities-list');
                const countBadge = document.getElementById('pending-activities-count');
                list.innerHTML = '';
                countBadge.textContent = activities.length;

                if (activities.length === 0) {
                    list.innerHTML = '<li>موردی برای نمایش وجود ندارد.</li>';
                    return;
                }

                activities.forEach(act => {
                    const item = document.createElement('li');
                    item.className = 'item';
                    item.id = `activity-${act.row}`;
                    item.innerHTML = `
                        <div class="item-details">
                            <div class="item-title">${escapeHTML(act.title)}</div>
                            <div class="item-meta">کاربر: ${escapeHTML(act.nationalId)} | تاریخ ثبت: ${escapeHTML(act.submissionDate)}</div>
                            <small>${escapeHTML(act.description.substring(0, 100))}...</small>
                        </div>
                        <div class="item-actions">
                            <button class="btn-approve" data-row="${act.row}">تایید</button>
                            <button class="btn-reject" data-row="${act.row}">رد</button>
                        </div>`;
                    list.appendChild(item);
                });

                list.querySelectorAll('.btn-approve, .btn-reject').forEach(btn => {
                    btn.addEventListener('click', handleActivityStatusUpdate);
                });
            };
            
            // مدیریت رویدادهای کلیک
            const handleUserStatusUpdate = async (e) => {
                const btn = e.target;
                const nationalId = btn.dataset.nid;
                const newStatus = btn.classList.contains('btn-approve') ? 5 : 1;
                const actionText = newStatus === 5 ? 'تایید' : 'رد';

                if (!confirm(`آیا از ${actionText} این کاربر اطمینان دارید؟`)) return;
                
                const result = await apiRequest({ action: 'updateUserStatus', nationalId, status: newStatus });
                showToast(result.message, result.success ? 'success' : 'error');
                if (result.success) {
                    document.getElementById(`user-${nationalId}`).remove();
                    document.getElementById('pending-users-count').textContent--;
                }
            };
            
            const handleActivityStatusUpdate = async (e) => {
                const btn = e.target;
                const rowId = btn.dataset.row;
                const newStatus = btn.classList.contains('btn-approve') ? 5 : 1;
                 const actionText = newStatus === 5 ? 'تایید' : 'رد';

                if (!confirm(`آیا از ${actionText} این فعالیت اطمینان دارید؟`)) return;

                const result = await apiRequest({ action: 'updateActivityStatus', row: rowId, status: newStatus });
                showToast(result.message, result.success ? 'success' : 'error');
                if (result.success) {
                     document.getElementById(`activity-${rowId}`).remove();
                     document.getElementById('pending-activities-count').textContent--;
                }
            };

            // مدیریت جستجوی کاربر
            document.getElementById('user-search-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button');
                toggleButtonLoading(btn, true);
                
                const nid = document.getElementById('search-nid').value;
                const result = await apiRequest({ action: 'searchUserByNid', nationalId: nid });
                
                renderSearchResults(result);
                toggleButtonLoading(btn, false);
            });

            const renderSearchResults = (result) => {
                const container = document.getElementById('search-results-container');
                container.innerHTML = '';

                if (!result.success) {
                    container.innerHTML = `<p style="color: var(--danger);">${escapeHTML(result.message)}</p>`;
                    return;
                }

                const { user, activities } = result.data;
                
                // Card پروفایل کاربر
                const profileCard = document.createElement('div');
                profileCard.className = 'user-profile-card';
                profileCard.innerHTML = `
                    <h3>پرونده کاربر: ${escapeHTML(user.fullName)}</h3>
                    <div class="profile-details">
                        <span><strong>کد ملی:</strong> ${escapeHTML(user.nationalId)}</span>
                        <span><strong>تاریخ تولد:</strong> ${escapeHTML(user.dob)}</span>
                        <span><strong>جنسیت:</strong> ${escapeHTML(user.gender)}</span>
                        <span><strong>تحصیلات:</strong> ${escapeHTML(user.education)}</span>
                        <span><strong>شماره تماس:</strong> ${escapeHTML(user.phone)}</span>
                        <span><strong>مهارت:</strong> ${escapeHTML(user.skill)}</span>
                    </div>`;
                container.appendChild(profileCard);
                
                // تاریخچه فعالیت‌ها
                const historyHeader = document.createElement('h4');
                historyHeader.textContent = 'سوابق فعالیت‌ها';
                historyHeader.style.marginBottom = '15px';
                container.appendChild(historyHeader);
                
                if (activities.length === 0) {
                    container.innerHTML += '<p>این کاربر هیچ فعالیتی ثبت نکرده است.</p>';
                    return;
                }

                activities.forEach(act => {
                    const statusMap = { '0': 'در حال بررسی', '1': 'رد شده', '5': 'تایید شده' };
                    const activityItem = document.createElement('div');
                    activityItem.className = 'activity-history-item';
                    activityItem.dataset.status = act.status;
                    activityItem.innerHTML = `
                        <div class="item-title">${escapeHTML(act.title)} (وضعیت: ${statusMap[act.status]})</div>
                        <p>${escapeHTML(act.description)}</p>
                        <div class="item-meta">تاریخ ثبت: ${escapeHTML(act.submissionDate)} | بازه: ${escapeHTML(act.startDate)} تا ${escapeHTML(act.endDate)}</div>
                    `;
                    // افزودن دکمه‌های ویرایش وضعیت اگر فعالیت رد شده باشد
                    if (act.status == '1') {
                         activityItem.innerHTML += `
                         <div class="item-actions" style="margin-top: 10px;">
                            <button class="btn-approve" data-row="${act.row}" data-type="activity-search">تغییر به تایید شده</button>
                            <button class="btn-warning" style="background-color: var(--warning); color: #fff;" data-row="${act.row}" data-type="activity-search">تغییر به در حال بررسی</button>
                         </div>
                         `;
                    }
                    container.appendChild(activityItem);
                });
                // Event listener برای دکمه های داخل نتایج جستجو
                container.querySelectorAll('button[data-type="activity-search"]').forEach(btn => {
                    btn.addEventListener('click', handleActivityStatusChangeFromSearch);
                });
            };

            const handleActivityStatusChangeFromSearch = async (e) => {
                const btn = e.target;
                const rowId = btn.dataset.row;
                const newStatus = btn.classList.contains('btn-approve') ? 5 : 0;
                const actionText = newStatus === 5 ? 'تایید' : 'انتقال به لیست بررسی';

                if (!confirm(`آیا از "${actionText}" این فعالیت اطمینان دارید؟`)) return;

                const result = await apiRequest({ action: 'updateActivityStatus', row: rowId, status: newStatus });
                showToast(result.message, result.success ? 'success' : 'error');
                if (result.success) {
                    // رفرش نتایج جستجو
                    document.getElementById('user-search-form').dispatchEvent(new Event('submit'));
                }
            };
            
            // تابع کمکی برای جلوگیری از حملات XSS
            const escapeHTML = str => str.toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');

            // بررسی وجود نشست فعال
            const checkAdminSession = () => {
                const savedAdmin = sessionStorage.getItem('adminUser');
                const token = sessionStorage.getItem('adminAuthToken');
                if (savedAdmin && token) {
                    initDashboard(JSON.parse(savedAdmin));
                }
            };
            checkAdminSession();
        });
    </script>
</body>
</html>
