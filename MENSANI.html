<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>سامانه ارزیابی جهادگران</title>
    <!-- دستور سوم: تنظیم viewport برای نمایش حالت دسکتاپ در همه دستگاه‌ها -->
    <meta name="viewport" content="width=1200">
    <meta name="robots" content="noindex, nofollow">
    <!-- کتابخانه‌های مورد نیاز -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <!-- دستور ششم و هفتم: افزودن کتابخانه‌های اکسل و PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf-autotable.min.js"></script>
    
<style>
    /* دستور اول: طراحی مدرن و حرفه‌ای با فونت وزیرمتن */
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700;800&display=swap');
    :root {
        --primary: #0d6efd; --primary-light: #e7f0ff; --primary-dark: #0b5ed7;
        --text-dark: #212529; --text-light: #6c757d; --text-on-dark: #ffffff;
        --bg-main: #f0f2f5; --bg-card: #ffffff; --border-color: #dee2e6;
        --success: #198754; --danger: #dc3545; --warning: #ffc107; --info: #0dcaf0;
        --shadow: 0 4px 25px rgba(0,0,0,0.08); --radius-lg: 16px; --radius-md: 12px;
        --transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    html.dark-mode {
        --primary: #3b82f6; --primary-light: #1e293b; --primary-dark: #2563eb;
        --text-dark: #e0e0e0; --text-light: #a0a0a0;
        --bg-main: #1a202c; --bg-card: #2d3748; --border-color: #4a5568;
        --shadow: 0 4px 25px rgba(0,0,0,0.4);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Vazirmatn', sans-serif; background-color: var(--bg-main); color: var(--text-dark); transition: background-color var(--transition), color var(--transition); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* دستور نهم: استایل صفحه ورود با پس‌زمینه جدید */
    #login-view {
        display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; animation: fadeIn 0.5s;
        background-image: linear-gradient(45deg, rgba(13, 110, 253, 0.7), rgba(13, 202, 240, 0.7)), url('https://tashacol.ir/123.jpg');
        background-size: cover; background-position: center;
    }
    .login-container { width: 100%; max-width: 420px; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); padding: 40px; border-radius: var(--radius-lg); box-shadow: var(--shadow); text-align: center; }
    .login-container h1 { font-size: 1.8rem; margin-bottom: 8px; color: var(--text-dark); }
    .login-container p { color: var(--text-light); margin-bottom: 30px; }
    .input-wrapper { position: relative; margin-bottom: 25px; text-align: right; }
    .input-icon { position: absolute; top: 50%; transform: translateY(-50%); right: 15px; color: var(--text-light); transition: var(--transition); }
    .form-input { width: 100%; padding: 14px 50px 14px 15px; border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem; outline: none; transition: var(--transition); background-color: #fff; color: var(--text-dark); }
    .form-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
    .btn-login { width: 100%; padding: 14px; font-size: 1.1rem; font-weight: 500; background: var(--primary); color: var(--text-on-dark); border: none; border-radius: var(--radius-md); cursor: pointer; transition: var(--transition); position: relative; min-height: 52px; display: flex; align-items: center; justify-content: center; }
    .btn-login:hover:not(:disabled) { background: var(--primary-dark); }
    .btn-login.loading .btn-text { opacity: 0; }
    .btn-login.loading .spinner { opacity: 1; }
    .btn-login .spinner { width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3); border-top-color: var(--text-on-dark); border-radius: 50%; animation: spin 0.8s linear infinite; position: absolute; opacity: 0; }
    #login-error-msg { margin-top: 15px; color: var(--danger); min-height: 20px; font-weight: 500; }
    .captcha-wrapper { display: flex; justify-content: center; margin-bottom: 25px; transform: scale(0.95); transform-origin: center; }

    /* استایل‌های داشبورد */
    #dashboard-view { display: none; animation: fadeIn 0.5s; }
    .dashboard-header { background: var(--bg-card); padding: 0 30px; height: 70px; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 1000; }
    .header-logo { display: flex; align-items: center; color: var(--text-dark); font-weight: 700; font-size: 1.2rem; }
    .header-logo i { margin-left: 10px; color: var(--primary); }
    .header-controls { display: flex; align-items: center; gap: 15px; }
    #user-name-display { font-weight: 500; }
    .icon-button { background: none; border: none; font-size: 1.4rem; color: var(--text-light); cursor: pointer; transition: var(--transition); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .icon-button:hover { color: var(--primary); background-color: var(--primary-light); }

    .main-container { max-width: 1400px; margin: 30px auto; padding: 0 30px; }
    .card { background: var(--bg-card); border-radius: var(--radius-lg); box-shadow: var(--shadow); padding: 25px; }
    .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
    .card-title { display: flex; align-items: center; }
    .card-title i { color: var(--primary); font-size: 1.5rem; margin-left: 15px; }
    .card-title h2 { font-size: 1.4rem; margin: 0; }
    .card-actions { display: flex; gap: 10px; }

    .nav-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 25px; }
    .nav-tab { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -1px; font-weight: 500; color: var(--text-light); transition: var(--transition); }
    .nav-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    .nav-tab:hover:not(.active) { color: var(--text-dark); }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.4s; }

    .table-responsive { overflow-x: auto; }
    .data-table { width: 100%; border-collapse: collapse; text-align: right; }
    .data-table th, .data-table td { padding: 15px; border-bottom: 1px solid var(--border-color); white-space: nowrap; vertical-align: middle; }
    .data-table th { font-weight: 700; color: var(--text-dark); background-color: var(--bg-main); }
    .data-table tbody tr:not(.child-row):hover { background-color: var(--primary-light); }
    .table-actions i { cursor: pointer; margin: 0 8px; font-size: 1.3rem; transition: transform 0.2s; }
    .action-approve { color: var(--success); } .action-reject { color: var(--danger); } .action-reapprove { color: var(--info); }
    .action-pdf { color: #c0392b; }
    .table-actions i:hover { transform: scale(1.2); }
    
    .search-container { display: flex; gap: 10px; margin-bottom: 20px; }
    .search-input { flex-grow: 1; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: var(--radius-md); }
    .action-button { padding: 0 25px; background: var(--primary); color: white; border: none; border-radius: var(--radius-md); cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
    .action-button i { font-size: 1.1em; }
    
    .placeholder-row td { text-align: center; padding: 50px 0; color: var(--text-light); }
    .loading-spinner { font-size: 2rem; color: var(--primary); animation: spin 1s linear infinite; }
    .pagination-controls { margin-top: 25px; display: flex; justify-content: center; align-items: center; gap: 10px; }
    .pagination-controls button { padding: 8px 20px; background: var(--primary-light); color: var(--primary); font-weight: 500; border: none; border-radius: 8px; cursor: pointer; }
    .pagination-controls button:disabled { background: var(--border-color); color: var(--text-light); cursor: not-allowed; }
    
    /* دستور هفتم: استایل برای ردیف‌های بازشونده فعالیت‌ها */
    .user-row { cursor: pointer; }
    .child-row { background-color: #fafafa; }
    html.dark-mode .child-row { background-color: #354154; }
    .child-row-content { padding: 20px; }
    .child-row-content table { margin-top: 10px; }

    /* Modals & Toasts */
    #toast-container { position: fixed; top: 20px; left: 20px; z-index: 10001; display: flex; flex-direction: column; gap: 10px; direction: ltr; }
    .toast { background-color: var(--bg-card); color: var(--text-dark); padding: 15px 20px; border-radius: var(--radius-md); box-shadow: var(--shadow); border-right: 5px solid var(--primary); display: flex; align-items: center; gap: 15px; opacity: 0; transform: translateX(-100%); animation: toast-in 0.5s forwards; min-width: 350px; }
    @keyframes toast-in { to { opacity: 1; transform: translateX(0); } }
    .toast.hide { animation: toast-out 0.5s forwards; }
    @keyframes toast-out { to { opacity: 0; transform: translateX(-120%); } }
    .toast .toast-icon { font-size: 1.5rem; }
    .toast span { font-weight: 500; direction: rtl; text-align: right; width: 100%; }
    .toast.success { border-right-color: var(--success); } .toast.success .toast-icon { color: var(--success); }
    .toast.error { border-right-color: var(--danger); } .toast.error .toast-icon { color: var(--danger); }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 10000; animation: fadeIn 0.3s; }
    .modal-overlay.show { display: flex; }
    .modal-box { background: var(--bg-card); padding: 30px; border-radius: var(--radius-lg); width: 90%; max-width: 500px; box-shadow: var(--shadow); text-align: center; position: relative;}
    .modal-close-btn { position: absolute; top: 15px; left: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); }
    .modal-box .icon { font-size: 3rem; margin-bottom: 20px; }
    .modal-box p { font-size: 1.1rem; line-height: 1.8; margin-bottom: 25px; }
    .modal-actions { display: flex; gap: 15px; margin-top: 25px; }
    .modal-action-btn { flex-grow: 1; padding: 12px; font-size: 1rem; font-weight: 500; border: none; border-radius: var(--radius-md); cursor: pointer; transition: var(--transition); }
    .confirm-btn { background-color: var(--success); color: #fff; } .confirm-btn:hover { background-color: #157347; }
    .cancel-btn { background-color: var(--danger); color: #fff; } .cancel-btn:hover { background-color: #b02a37; }
</style>
</head>
<body>

<div id="login-view">
    <div class="login-container">
        <h1>سامانه ارزیابان جهادی</h1>
        <p>جهت ورود به پنل، اطلاعات خود را وارد نمائید</p>
        <form id="login-form">
            <div class="input-wrapper">
                <input type="text" id="login-username" class="form-input" placeholder="کد ملی" required inputmode="numeric">
                <i class="fas fa-id-card input-icon"></i>
            </div>
            <div class="input-wrapper">
                <input type="password" id="login-password" class="form-input" placeholder="رمز عبور" required>
                <i class="fas fa-lock input-icon"></i>
            </div>
            <div class="captcha-wrapper">
                <div class="g-recaptcha" data-sitekey="6Lc1vqkrAAAAAHLHbzPMzlREvKwgHDNSmakrB-aq"></div>
            </div>
            <button class="btn-login" id="login-button">
                <span class="btn-text">ورود</span>
                <div class="spinner"></div>
            </button>
        </form>
        <p id="login-error-msg"></p>
    </div>
</div>

<div id="dashboard-view">
    <header class="dashboard-header">
        <div class="header-logo"><i class="fas fa-tasks"></i><span>پنل ارزیابی جهادگران</span></div>
        <div class="header-controls">
            <span id="user-name-display"></span>
            <button id="theme-toggle-btn" class="icon-button" title="تغییر حالت نمایش"><i class="fas fa-moon"></i></button>
            <button id="logout-btn" class="icon-button" title="خروج از حساب"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </header>

    <main class="main-container">
        <div class="nav-tabs" id="main-nav-tabs">
            <div class="nav-tab active" data-tab="memberships"><i class="fas fa-user-check"></i> بررسی عضویت‌ها</div>
            <div class="nav-tab" data-tab="activities"><i class="fas fa-chart-line"></i> بررسی فعالیت‌ها</div>
            <div class="nav-tab" data-tab="search"><i class="fas fa-search"></i> جستجو کاربران</div>
        </div>

        <!-- Membership Tab -->
        <div id="memberships-content" class="tab-content active">
            <div class="card">
                <div class="nav-tabs" id="membership-status-tabs">
                    <div class="nav-tab active" data-status="0">در حال انتظار</div>
                    <div class="nav-tab" data-status="5">تائید شده</div>
                    <div class="nav-tab" data-status="1">رد شده</div>
                </div>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>تاریخ ثبت نام</th>
                                <th>نام و نام خانوادگی</th>
                                <th>کد ملی</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="memberships-table-body"></tbody>
                    </table>
                </div>
                <div class="pagination-controls" id="memberships-pagination"></div>
            </div>
        </div>

        <!-- Activities Tab -->
        <div id="activities-content" class="tab-content">
            <div class="card">
                <div class="nav-tabs" id="activity-status-tabs">
                    <div class="nav-tab active" data-status="0">در حال بررسی</div>
                    <div class="nav-tab" data-status="5">تائید شده</div>
                    <div class="nav-tab" data-status="1">رد شده</div>
                </div>
                <!-- دستور ششم: افزودن جستجو و خروجی اکسل -->
                <div class="card-actions" style="margin-bottom: 20px;">
                     <input type="search" class="search-input" id="activity-search-input" placeholder="جستجوی کد ملی...">
                     <button class="action-button" id="activity-export-btn"><i class="fas fa-file-excel"></i> خروجی اکسل</button>
                </div>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>نام جهادگر</th>
                                <th>کد ملی</th>
                                <th>عنوان فعالیت</th>
                                <th>تاریخ شروع</th>
                                <th>تاریخ اتمام</th>
                                <th>توضیحات</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="activities-table-body"></tbody>
                    </table>
                </div>
                <div class="pagination-controls" id="activities-pagination"></div>
            </div>
        </div>

        <!-- Search Tab -->
        <div id="search-content" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-search"></i>
                        <h2>جستجوی جهادگران</h2>
                    </div>
                </div>
                <div class="search-container">
                    <input type="search" id="search-input" class="search-input" placeholder="نام یا کد ملی را وارد کنید...">
                    <button id="search-btn" class="action-button"><i class="fas fa-search"></i> جستجو</button>
                </div>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>نام و نام خانوادگی</th>
                                <th>کد ملی</th>
                                <th>تاریخ تولد</th>
                                <th>وضعیت عضویت</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="search-results-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Modals -->
<div class="modal-overlay" id="action-confirmation-modal">
    <div class="modal-box">
        <button class="modal-close-btn"><i class="fas fa-times"></i></button>
        <i class="fas fa-exclamation-triangle icon" style="color: var(--warning);"></i>
        <p id="action-confirmation-message"></p>
        <div class="modal-actions">
            <button id="confirm-action-btn" class="modal-action-btn confirm-btn">تایید</button>
            <button class="modal-action-btn cancel-btn modal-close-btn">انصراف</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="description-modal">
    <div class="modal-box" style="text-align: right;">
        <button class="modal-close-btn"><i class="fas fa-times"></i></button>
        <h3 style="margin-bottom: 15px;">توضیحات فعالیت</h3>
        <p id="modal-description-text" style="line-height: 2; max-height: 60vh; overflow-y: auto;"></p>
    </div>
</div>

<div id="toast-container"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ⬇️⬇️⬇️ مهم: این آدرس را با آدرس Web App خود جایگزین کنید ⬇️⬇️⬇️
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx_USt6iFHiAMKZXSmfQqDnl95hYw2prf-V5SWaPLU25YXNyBUBhQjgoqwwHzRyPgrizg/exec"; // <--- آدرس را اینجا قرار دهید

    // --- State Management ---
    const state = {
        currentPage: 'memberships',
        membershipStatus: '0',
        membershipPage: 1,
        activityStatus: '0',
        activityPage: 1,
        activitySearchQuery: '',
    };
    const AUTH_TOKEN_KEY = 'jahadgaranAuthToken';

    // --- Element Caching ---
    const loginView = document.getElementById('login-view');
    const dashboardView = document.getElementById('dashboard-view');
    const loginForm = document.getElementById('login-form');
    const loginButton = document.getElementById('login-button');
    const loginErrorMsg = document.getElementById('login-error-msg');
    const themeToggleBtn = document.getElementById('theme-toggle-btn');
    const logoutBtn = document.getElementById('logout-btn');

    // --- Utility Functions ---
    const showToast = (message, type = 'info') => {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        let icon = 'fa-info-circle';
        if (type === 'success') icon = 'fa-check-circle';
        if (type === 'error') icon = 'fa-times-circle';
        toast.innerHTML = `<i class="fas ${icon} toast-icon"></i><span>${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('hide');
            toast.addEventListener('animationend', () => toast.remove());
        }, 5000);
    };

    const apiRequest = async (params) => {
        const token = sessionStorage.getItem(AUTH_TOKEN_KEY);
        if (!token && params.action !== 'loginAssessor') {
            showToast('نشست شما معتبر نیست. لطفاً وارد شوید.', 'error');
            logout();
            throw new Error("No auth token found.");
        }

        const url = new URL(SCRIPT_URL);
        if (token) params.authToken = token;
        Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('خطای شبکه در ارتباط با سرور.');
            const result = await response.json();
            if (result.error) {
                if (result.message.includes("نشست شما نامعتبر")) setTimeout(logout, 1500);
                throw new Error(result.message);
            }
            return result;
        } catch (e) {
            showToast(e.message, 'error');
            throw e;
        }
    };
    
    const renderPagination = (containerId, currentPage, totalPages, callback) => {
        const container = document.getElementById(containerId);
        if (totalPages <= 1) { container.innerHTML = ''; return; }
        container.innerHTML = `
            <button class="prev-btn" ${currentPage === 1 ? 'disabled' : ''}>قبلی</button>
            <span class="pagination-info">صفحه ${currentPage} از ${totalPages}</span>
            <button class="next-btn" ${currentPage === totalPages ? 'disabled' : ''}>بعدی</button>
        `;
        container.querySelector('.prev-btn')?.addEventListener('click', () => callback(currentPage - 1));
        container.querySelector('.next-btn')?.addEventListener('click', () => callback(currentPage + 1));
    };

    // دستور چهارم: نمایش لودینگ در جداول
    const showTableLoader = (tbodyId, columns) => {
        document.getElementById(tbodyId).innerHTML = `
            <tr class="placeholder-row">
                <td colspan="${columns}"><i class="fas fa-spinner fa-spin loading-spinner"></i><br>در حال بارگیری...</td>
            </tr>`;
    };

    const showPlaceholder = (tbodyId, message, columns) => {
        document.getElementById(tbodyId).innerHTML = `<tr class="placeholder-row"><td colspan="${columns}">${message}</td></tr>`;
    };

    // --- Authentication ---
    // **اصلاح شد:** بازگرداندن منطق ورود به حالت اصلی و پایدار
    const handleLogin = async () => {
        loginErrorMsg.textContent = '';
        loginButton.classList.add('loading');
        loginButton.disabled = true;

        const recaptchaResponse = grecaptcha.getResponse();
        if (!recaptchaResponse) {
            loginErrorMsg.textContent = 'لطفاً تأیید کنید که ربات نیستید.';
            loginButton.classList.remove('loading');
            loginButton.disabled = false;
            return;
        }
        
        try {
            const result = await apiRequest({
                action: 'loginAssessor',
                username: document.getElementById('login-username').value,
                password: document.getElementById('login-password').value,
                recaptchaToken: recaptchaResponse,
            });
            if (result.success) {
                sessionStorage.setItem(AUTH_TOKEN_KEY, result.authToken);
                initDashboard(result);
            }
        } catch(e) {
            loginErrorMsg.textContent = e.message;
        } finally {
            grecaptcha.reset();
            // فقط در صورتی که ورود ناموفق بود و کاربر هنوز در صفحه لاگین است، دکمه را فعال کن
            if (loginView.style.display !== 'none') {
                 loginButton.classList.remove('loading');
                 loginButton.disabled = false;
            }
        }
    };

    const logout = () => {
        const token = sessionStorage.getItem(AUTH_TOKEN_KEY);
        if (token) apiRequest({ action: 'logout' }).catch(err => console.error("Logout failed:", err));
        sessionStorage.removeItem(AUTH_TOKEN_KEY);
        location.reload();
    };

    const initDashboard = (userData) => {
        loginView.style.display = 'none';
        dashboardView.style.display = 'block';
        document.getElementById('user-name-display').textContent = `خوش آمدید، ${userData.name}`;
        fetchMemberships();
    };
    
    // --- Data Fetching & Rendering ---
    const fetchMemberships = async (page = 1) => {
        state.membershipPage = page;
        showTableLoader('memberships-table-body', 4);
        try {
            const result = await apiRequest({
                action: 'getMemberships',
                status: state.membershipStatus,
                page: state.membershipPage
            });
            renderMemberships(result.data);
            renderPagination('memberships-pagination', result.currentPage, result.totalPages, fetchMemberships);
        } catch (e) {
            showPlaceholder('memberships-table-body', 'خطا در بارگذاری اطلاعات.', 4);
        }
    };

    const renderMemberships = (data) => {
        const tbody = document.getElementById('memberships-table-body');
        if (data.length === 0) { showPlaceholder('memberships-table-body', 'موردی برای نمایش یافت نشد.', 4); return; }
        tbody.innerHTML = data.map(item => `
            <tr data-row-index="${item.rowIndex}" data-name="${item.fullName}">
                <td>${item.regDate}</td>
                <td>${item.fullName}</td>
                <td>${item.nationalId}</td>
                <td class="table-actions" data-type="membership">
                    ${state.membershipStatus !== '5' ? `<i class="fas fa-check-circle action-approve" title="تائید"></i>` : ''}
                    ${state.membershipStatus !== '1' ? `<i class="fas fa-times-circle action-reject" title="رد کردن"></i>` : ''}
                    ${state.membershipStatus === '1' ? `<i class="fas fa-redo action-reapprove" title="تائید مجدد"></i>` : ''}
                </td>
            </tr>
        `).join('');
    };
    
    const fetchActivities = async (page = 1) => {
        state.activityPage = page;
        showTableLoader('activities-table-body', 7);
        try {
            const params = {
                action: 'getActivities',
                status: state.activityStatus,
                page: state.activityPage
            };
            if (state.activitySearchQuery) {
                params.nationalId = state.activitySearchQuery; // ارسال پارامتر جستجو
            }
            const result = await apiRequest(params);
            renderActivities(result.data);
            renderPagination('activities-pagination', result.currentPage, result.totalPages, fetchActivities);
        } catch (e) {
            showPlaceholder('activities-table-body', 'خطا در بارگذاری اطلاعات.', 7);
        }
    };
    
    const renderActivities = (data) => {
        const tbody = document.getElementById('activities-table-body');
        if (data.length === 0) { showPlaceholder('activities-table-body', 'موردی برای نمایش یافت نشد.', 7); return; }
        tbody.innerHTML = data.map(item => `
            <tr data-row-index="${item.rowIndex}" data-name="${item.title}">
                <td>${item.fullName}</td>
                <td>${item.nationalId}</td>
                <td>${item.title}</td>
                <td>${item.startDate}</td>
                <td>${item.endDate}</td>
                <td><i class="fas fa-eye" title="مشاهده توضیحات" style="cursor:pointer; color: var(--primary);" data-description="${item.description}"></i></td>
                <td class="table-actions" data-type="activity">
                    ${state.activityStatus !== '5' ? `<i class="fas fa-check-circle action-approve" title="تائید"></i>` : ''}
                    ${state.activityStatus !== '1' ? `<i class="fas fa-times-circle action-reject" title="رد کردن"></i>` : ''}
                    ${state.activityStatus === '1' ? `<i class="fas fa-redo action-reapprove" title="تائید مجدد"></i>` : ''}
                </td>
            </tr>
        `).join('');
    };
    
    const performSearch = async () => {
        const query = document.getElementById('search-input').value.trim();
        if (query.length < 3) { showToast('برای جستجو حداقل ۳ حرف وارد کنید.', 'error'); return; }
        showTableLoader('search-results-body', 5);
        try {
            const result = await apiRequest({ action: 'searchUsers', query });
            const tbody = document.getElementById('search-results-body');
            if(result.users.length === 0) { showPlaceholder('search-results-body', 'هیچ نتیجه‌ای یافت نشد.', 5); return; }
            tbody.innerHTML = result.users.map(user => `
                <tr class="user-row" data-national-id="${user.nationalId}" data-full-name="${user.fullName}" data-membership-row-index="${user.rowIndex}">
                    <td>${user.fullName}</td>
                    <td>${user.nationalId}</td>
                    <td>${user.dob}</td>
                    <td>${user.statusText}</td>
                    <td class="table-actions" data-type="membership">
                        <!-- دستور هفتم: قابلیت تائید کاربر تائید نشده -->
                        ${user.status !== 5 ? `<i class="fas fa-check-circle action-approve" title="تائید عضویت"></i>` : ''}
                        <i class="fas fa-file-pdf action-pdf" title="دانلود فعالیت‌ها (PDF)"></i>
                    </td>
                </tr>
            `).join('');
        } catch(e) {
            showPlaceholder('search-results-body', 'خطا در جستجو.', 5);
        }
    };
    
    // --- Action Handling ---
    const confirmAction = (message, onConfirm) => {
        document.getElementById('action-confirmation-message').textContent = message;
        const modal = document.getElementById('action-confirmation-modal');
        modal.classList.add('show');
        const confirmBtn = document.getElementById('confirm-action-btn');
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.onclick = () => { onConfirm(); modal.classList.remove('show'); };
    };

    // دستور هشتم: افزودن لودینگ به آیکن‌ها
    const updateStatus = async (type, rowIndex, newStatus, iconElement) => {
        const action = type === 'membership' ? 'updateMembershipStatus' : 'updateActivityStatus';
        const fetchFn = type === 'membership' ? fetchMemberships : fetchActivities;
        const page = type === 'membership' ? state.membershipPage : state.activityPage;
        
        const originalIconClass = iconElement.className;
        iconElement.className = 'fas fa-spinner fa-spin'; // نمایش لودینگ
        iconElement.style.pointerEvents = 'none';

        try {
            await apiRequest({ action, rowIndex, newStatus });
            showToast('عملیات با موفقیت انجام شد.', 'success');
            if (state.currentPage === 'search') performSearch(); // رفرش جستجو
            else fetchFn(page); // رفرش تب فعلی
        } catch (e) {
            // Error toast is shown by apiRequest
            iconElement.className = originalIconClass; // بازگرداندن آیکن در صورت خطا
        } finally {
            iconElement.style.pointerEvents = 'auto';
        }
    };

    // --- Event Listeners ---
    loginForm.addEventListener('submit', (e) => { e.preventDefault(); handleLogin(); });
    logoutBtn.addEventListener('click', logout);
    
    document.getElementById('main-nav-tabs').addEventListener('click', (e) => {
        const tab = e.target.closest('.nav-tab');
        if (!tab || tab.classList.contains('active')) return;
        
        tab.parentElement.querySelector('.active').classList.remove('active');
        tab.classList.add('active');
        
        document.querySelector('.tab-content.active').classList.remove('active');
        const tabName = tab.dataset.tab;
        document.getElementById(`${tabName}-content`).classList.add('active');

        state.currentPage = tabName;
        if (tabName === 'memberships') fetchMemberships(1);
        if (tabName === 'activities') fetchActivities(1);
    });
    
    document.getElementById('membership-status-tabs').addEventListener('click', (e) => {
        const tab = e.target.closest('.nav-tab');
        if (!tab || tab.classList.contains('active')) return;
        tab.parentElement.querySelector('.active').classList.remove('active');
        tab.classList.add('active');
        state.membershipStatus = tab.dataset.status;
        fetchMemberships(1);
    });

    document.getElementById('activity-status-tabs').addEventListener('click', (e) => {
        const tab = e.target.closest('.nav-tab');
        if (!tab || tab.classList.contains('active')) return;
        tab.parentElement.querySelector('.active').classList.remove('active');
        tab.classList.add('active');
        state.activityStatus = tab.dataset.status;
        document.getElementById('activity-search-input').value = ''; // ریست جستجو
        state.activitySearchQuery = '';
        fetchActivities(1);
    });
    
    const handleTableActions = (e) => {
        const target = e.target;
        if (!target.matches('.table-actions i')) return;

        const row = target.closest('tr');
        const type = target.parentElement.dataset.type;
        const rowIndex = (type === 'membership' && state.currentPage === 'search') ? row.dataset.membershipRowIndex : row.dataset.rowIndex;
        const name = row.dataset.name || row.dataset.fullName;
        
        let actionFn;
        if (target.classList.contains('action-approve') || target.classList.contains('action-reapprove')) {
            actionFn = () => updateStatus(type, rowIndex, 5, target);
            confirmAction(`آیا از تائید "${name}" مطمئن هستید؟`, actionFn);
        } else if (target.classList.contains('action-reject')) {
            actionFn = () => updateStatus(type, rowIndex, 1, target);
            confirmAction(`آیا از رد کردن "${name}" مطمئن هستید؟`, actionFn);
        } else if (target.classList.contains('action-pdf')) {
            exportUserActivitiesToPdf(row.dataset.nationalId, name);
        } else if (target.dataset.description) {
            document.getElementById('modal-description-text').textContent = target.dataset.description;
            document.getElementById('description-modal').classList.add('show');
        }
    };
    
    document.getElementById('memberships-table-body').addEventListener('click', handleTableActions);
    document.getElementById('activities-table-body').addEventListener('click', handleTableActions);
    document.getElementById('search-results-body').addEventListener('click', handleTableActions);

    document.getElementById('search-btn').addEventListener('click', performSearch);
    document.getElementById('search-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') performSearch(); });

    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', e => { if (e.target === modal || e.target.closest('.modal-close-btn')) modal.classList.remove('show'); });
    });
    
    // --- Theme Management ---
    const loadTheme = () => {
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.classList.add('dark-mode');
            themeToggleBtn.querySelector('i').classList.replace('fa-moon', 'fa-sun');
        }
    };
    const toggleTheme = () => {
        document.documentElement.classList.toggle('dark-mode');
        const isDark = document.documentElement.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        themeToggleBtn.querySelector('i').classList.toggle('fa-moon', !isDark);
        themeToggleBtn.querySelector('i').classList.toggle('fa-sun', isDark);
    };
    themeToggleBtn.addEventListener('click', toggleTheme);

    // --- دستور ششم: توابع جستجو و خروجی اکسل برای فعالیت‌ها ---
    document.getElementById('activity-search-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            state.activitySearchQuery = e.target.value.trim();
            fetchActivities(1);
        }
    });

    document.getElementById('activity-export-btn').addEventListener('click', () => {
        const table = document.querySelector("#activities-content .data-table");
        const wb = XLSX.utils.table_to_book(table, {sheet: "فعالیت‌ها"});
        XLSX.writeFile(wb, "Jahadgaran-Activities.xlsx");
        showToast('فایل اکسل با موفقیت ایجاد شد.', 'success');
    });

    // --- دستور هفتم: توابع مربوط به جستجوی پیشرفته کاربران ---
    document.getElementById('search-results-body').addEventListener('click', async (e) => {
        const row = e.target.closest('tr.user-row');
        if (!row || e.target.closest('.table-actions')) return; // فقط روی خود ردیف عمل کند نه دکمه‌ها

        const nextRow = row.nextElementSibling;
        if (nextRow && nextRow.classList.contains('child-row')) {
            nextRow.remove(); // بستن ردیف باز شده
            return;
        }

        const nationalId = row.dataset.nationalId;
        const childRow = document.createElement('tr');
        childRow.className = 'child-row';
        const cell = document.createElement('td');
        cell.colSpan = 5;
        cell.innerHTML = `<div class="child-row-content"><i class="fas fa-spinner fa-spin"></i> در حال بارگذاری فعالیت‌ها...</div>`;
        childRow.appendChild(cell);
        row.insertAdjacentElement('afterend', childRow);

        try {
            const result = await apiRequest({ action: 'getActivities', nationalId: nationalId, page: 1, status: 'all' });
            if (result.data.length === 0) {
                cell.innerHTML = `<div class="child-row-content">هیچ فعالیتی برای این کاربر ثبت نشده است.</div>`;
            } else {
                let tableHTML = `
                    <div class="child-row-content">
                        <h4>فعالیت‌های ثبت شده:</h4>
                        <table class="data-table">
                            <thead><tr><th>عنوان</th><th>تاریخ شروع</th><th>تاریخ پایان</th><th>وضعیت</th><th>عملیات</th></tr></thead>
                            <tbody>
                `;
                result.data.forEach(act => {
                    tableHTML += `
                        <tr data-row-index="${act.rowIndex}" data-name="${act.title}">
                            <td>${act.title}</td>
                            <td>${act.startDate}</td>
                            <td>${act.endDate}</td>
                            <td>${act.statusText}</td>
                            <td class="table-actions" data-type="activity">
                                ${act.status !== 5 ? `<i class="fas fa-check-circle action-approve" title="تائید فعالیت"></i>` : ''}
                                ${act.status !== 1 ? `<i class="fas fa-times-circle action-reject" title="رد فعالیت"></i>` : ''}
                            </td>
                        </tr>`;
                });
                tableHTML += `</tbody></table></div>`;
                cell.innerHTML = tableHTML;
            }
        } catch (err) {
            cell.innerHTML = `<div class="child-row-content" style="color: var(--danger);">خطا در دریافت فعالیت‌ها.</div>`;
        }
    });
    
    const exportUserActivitiesToPdf = async (nationalId, fullName) => {
        showToast('در حال آماده‌سازی فایل PDF...', 'info');
        try {
            const { jsPDF } = window.jspdf;
            const result = await apiRequest({ action: 'getActivities', nationalId, status: 'all' });
            const doc = new jsPDF();
            
            // برای پشتیبانی از فارسی، نیاز به فونت مناسب است.
            doc.addFont('https://cdn.rawgit.com/MrM Romano/jsPDF-CustomFonts-farsi/master/fonts/Vazir/Vazir-Regular.ttf', 'Vazir', 'normal');
            doc.setFont('Vazir');

            doc.setR2L(true); // فعال کردن راست به چپ
            doc.text("گروه جهادی طلاب و روحانیون جنوب", 105, 20, { align: 'center' });
            doc.text(`فعالیت‌های جهادگر: ${fullName}`, 105, 30, { align: 'center' });

            const head = [['عملیات', 'وضعیت', 'تاریخ پایان', 'تاریخ شروع', 'عنوان فعالیت']];
            const body = result.data.map(act => [ '', act.statusText, act.endDate, act.startDate, act.title ]);

            doc.autoTable({
                head: head,
                body: body,
                startY: 40,
                styles: { font: 'Vazir', halign: 'center' },
                headStyles: {fillColor: [13, 110, 253]},
                theme: 'grid'
            });

            doc.save(`Activities-${fullName.replace(/ /g, '_')}.pdf`);
        } catch (err) {
            showToast('خطا در ایجاد فایل PDF.', 'error');
        }
    };


    // --- Initial Load ---
    if (sessionStorage.getItem(AUTH_TOKEN_KEY)) {
        initDashboard({ name: 'ارزیاب' });
    } else {
        loginView.style.display = 'flex';
    }
    loadTheme();
});
</script>

</body>
</html>
