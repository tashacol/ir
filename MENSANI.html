<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>سامانه ارزیابی جهادگران</title>
    <!-- دستور دوم: نمایش سایت در حالت دسکتاپ حتی در موبایل -->
    <meta name="viewport" content="width=1280">
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<style>
    /* دستور اول و هفتم: طراحی مدرن، حرفه‌ای و پس‌زمینه جدید */
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700;800&display=swap');
    :root {
        --primary: #0d6efd; --primary-light: #e7f0ff; --primary-dark: #0b5ed7;
        --text-dark: #212529; --text-light: #6c757d; --text-on-dark: #ffffff;
        --bg-main: #f0f2f5; --bg-card: #ffffff; --border-color: #dee2e6;
        --success: #198754; --danger: #dc3545; --warning: #ffc107; --info: #0dcaf0;
        --shadow: 0 4px 25px rgba(0,0,0,0.08); --radius-lg: 16px; --radius-md: 12px;
        --transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    html.dark-mode {
        --primary: #3b82f6; --primary-light: #1e293b; --primary-dark: #2563eb;
        --text-dark: #e0e0e0; --text-light: #a0a0a0;
        --bg-main: #1a202c; --bg-card: #2d3748; --border-color: #4a5568;
        --shadow: 0 4px 25px rgba(0,0,0,0.4);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Vazirmatn', sans-serif; background-color: var(--bg-main); color: var(--text-dark); transition: background-color var(--transition), color var(--transition); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Login View Styles */
    #login-view {
        display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; animation: fadeIn 0.5s;
        /* دستور هفتم: تنظیم عکس پس‌زمینه */
        background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://tashacol.ir/123.jpg');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
    }
    .login-container { width: 100%; max-width: 420px; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); padding: 40px; border-radius: var(--radius-lg); box-shadow: var(--shadow); text-align: center; }
    .login-container h1 { font-size: 1.8rem; margin-bottom: 8px; color: var(--text-dark); }
    .login-container p { color: var(--text-light); margin-bottom: 30px; }
    .input-wrapper { position: relative; margin-bottom: 25px; text-align: right; }
    .input-icon { position: absolute; top: 50%; transform: translateY(-50%); right: 15px; color: var(--text-light); transition: var(--transition); }
    .form-input { width: 100%; padding: 14px 50px 14px 15px; border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem; outline: none; transition: var(--transition); background-color: #fff; color: var(--text-dark); }
    .form-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
    .btn-login { width: 100%; padding: 14px; font-size: 1.1rem; font-weight: 500; background: var(--primary); color: var(--text-on-dark); border: none; border-radius: var(--radius-md); cursor: pointer; transition: var(--transition); position: relative; min-height: 52px; display: flex; align-items: center; justify-content: center; }
    .btn-login:hover:not(:disabled) { background: var(--primary-dark); }
    .btn-login.loading .spinner { opacity: 1; }
    .btn-login .spinner { width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3); border-top-color: var(--text-on-dark); border-radius: 50%; animation: spin 0.8s linear infinite; position: absolute; opacity: 0; }
    #login-error-msg { margin-top: 15px; color: var(--danger); min-height: 20px; font-weight: 500; }
    .captcha-wrapper { display: flex; justify-content: center; margin-bottom: 25px; transform: scale(0.95); transform-origin: center; }

    /* Dashboard Styles */
    #dashboard-view { display: none; animation: fadeIn 0.5s; }
    .dashboard-header { background: var(--bg-card); padding: 0 30px; height: 70px; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 1000; }
    .header-logo { display: flex; align-items: center; color: var(--text-dark); font-weight: 700; font-size: 1.2rem; }
    .header-logo i { margin-left: 10px; color: var(--primary); }
    .header-controls { display: flex; align-items: center; gap: 15px; }
    #user-name-display { font-weight: 500; }
    .icon-button { background: none; border: none; font-size: 1.4rem; color: var(--text-light); cursor: pointer; transition: var(--transition); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .icon-button:hover { color: var(--primary); background-color: var(--primary-light); }

    .main-container { max-width: 1400px; margin: 30px auto; padding: 0 30px; }
    .card { background: var(--bg-card); border-radius: var(--radius-lg); box-shadow: var(--shadow); padding: 25px; }
    .card-header { display: flex; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
    .card-header i { color: var(--primary); font-size: 1.5rem; margin-left: 15px; }
    .card-header h2 { font-size: 1.4rem; margin: 0; }
    .card-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
    
    .nav-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 25px; }
    .nav-tab { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -1px; font-weight: 500; color: var(--text-light); transition: var(--transition); }
    .nav-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    .nav-tab:hover:not(.active) { color: var(--text-dark); }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.4s; }

    .table-responsive { overflow-x: auto; }
    .data-table { width: 100%; border-collapse: collapse; text-align: right; }
    .data-table th, .data-table td { padding: 15px; border-bottom: 1px solid var(--border-color); white-space: nowrap; vertical-align: middle; }
    .data-table th { font-weight: 700; color: var(--text-dark); background-color: var(--bg-main); }
    .data-table tbody tr:hover { background-color: var(--primary-light); }
    .table-actions { position: relative; }
    .table-actions .action-icon { cursor: pointer; margin: 0 8px; font-size: 1.3rem; transition: transform 0.2s, color 0.2s; }
    .table-actions .spinner { width: 18px; height: 18px; border: 2px solid var(--primary); border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0; transition: opacity 0.2s; }
    .table-actions .action-icon.loading { visibility: hidden; }
    .table-actions .action-icon.loading + .spinner { opacity: 1; }
    .action-approve { color: var(--success); }
    .action-reject { color: var(--danger); }
    .action-reapprove { color: var(--info); }
    .action-icon:hover { transform: scale(1.2); }
    
    /* دستور چهارم و پنجم: استایل‌های جستجو، دکمه‌ها و ردیف‌های بازشونده */
    .search-container { display: flex; gap: 10px; }
    .search-container input { min-width: 250px; flex-grow: 1; padding: 10px 15px; border: 1px solid var(--border-color); border-radius: var(--radius-md); transition: var(--transition); }
    .search-container input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
    .search-container button { padding: 0 25px; background: var(--primary); color: white; border: none; border-radius: var(--radius-md); cursor: pointer; transition: var(--transition); }
    .search-container button:hover { background: var(--primary-dark); }
    .btn-export { padding: 10px 20px; font-weight: 500; background: var(--success); color: white; border: none; border-radius: var(--radius-md); cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 8px; }
    .btn-export:hover { background: #157347; }
    .user-name-clickable { cursor: pointer; color: var(--primary); font-weight: 500; }
    .user-name-clickable:hover { text-decoration: underline; }
    .activities-detail-row td { padding: 0 !important; background: var(--bg-main); }
    .activities-detail-content { padding: 20px; animation: fadeIn 0.4s; }
    .activities-detail-content h4 { margin-bottom: 15px; }

    /* دستور سوم: لودینگ در کنار پیام "در حال بارگیری" */
    .placeholder-row { text-align: center; padding: 50px 0; color: var(--text-light); }
    .loading-placeholder { display: flex; align-items: center; justify-content: center; gap: 15px; font-size: 1.1rem; }
    .loading-placeholder .spinner { width: 28px; height: 28px; border: 3px solid var(--primary-light); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }

    .pagination-controls { margin-top: 25px; display: flex; justify-content: center; align-items: center; gap: 10px; }
    .pagination-controls button { padding: 8px 20px; background: var(--primary-light); color: var(--primary); font-weight: 500; border: none; border-radius: 8px; cursor: pointer; }
    .pagination-controls button:disabled { background: var(--border-color); color: var(--text-light); cursor: not-allowed; }

    /* Modals & Toasts */
    #toast-container { position: fixed; top: 20px; left: 20px; z-index: 10001; display: flex; flex-direction: column; gap: 10px; direction: ltr; }
    .toast { background-color: var(--bg-card); color: var(--text-dark); padding: 15px 20px; border-radius: var(--radius-md); box-shadow: var(--shadow); border-right: 5px solid var(--primary); display: flex; align-items: center; gap: 15px; opacity: 0; transform: translateX(-100%); animation: toast-in 0.5s forwards; min-width: 350px; }
    @keyframes toast-in { to { opacity: 1; transform: translateX(0); } }
    .toast.hide { animation: toast-out 0.5s forwards; }
    @keyframes toast-out { to { opacity: 0; transform: translateX(-120%); } }
    .toast .toast-icon { font-size: 1.5rem; }
    .toast span { font-weight: 500; direction: rtl; text-align: right; width: 100%; }
    .toast.success { border-right-color: var(--success); } .toast.success .toast-icon { color: var(--success); }
    .toast.error { border-right-color: var(--danger); } .toast.error .toast-icon { color: var(--danger); }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 10000; animation: fadeIn 0.3s; }
    .modal-overlay.show { display: flex; }
    .modal-box { background: var(--bg-card); padding: 30px; border-radius: var(--radius-lg); width: 90%; max-width: 500px; box-shadow: var(--shadow); text-align: center; position: relative;}
    .modal-close-btn { position: absolute; top: 15px; left: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); }
    .modal-box .icon { font-size: 3rem; margin-bottom: 20px; }
    .modal-box p { font-size: 1.1rem; line-height: 1.8; margin-bottom: 25px; }
    .modal-actions { display: flex; gap: 15px; margin-top: 25px; }
    .modal-action-btn { flex-grow: 1; padding: 12px; font-size: 1rem; font-weight: 500; border: none; border-radius: var(--radius-md); cursor: pointer; transition: var(--transition); }
    .confirm-btn { background-color: var(--success); color: #fff; } .confirm-btn:hover { background-color: #157347; }
    .cancel-btn { background-color: var(--danger); color: #fff; } .cancel-btn:hover { background-color: #b02a37; }
</style>
</head>
<body>

<div id="login-view">
    <div class="login-container">
        <h1>سامانه ارزیابان جهادی</h1>
        <p>جهت ورود به پنل، اطلاعات خود را وارد نمائید</p>
        <form id="login-form">
            <div class="input-wrapper">
                <input type="text" id="login-username" class="form-input" placeholder="کد ملی" required inputmode="numeric">
                <i class="fas fa-id-card input-icon"></i>
            </div>
            <div class="input-wrapper">
                <input type="password" id="login-password" class="form-input" placeholder="رمز عبور" required>
                <i class="fas fa-lock input-icon"></i>
            </div>
            <div class="captcha-wrapper">
                <div class="g-recaptcha" data-sitekey="6Lc1vqkrAAAAAHLHbzPMzlREvKwgHDNSmakrB-aq"></div>
            </div>
            <button class="btn-login" id="login-button"><span class="btn-text">ورود</span><div class="spinner"></div></button>
        </form>
        <p id="login-error-msg"></p>
    </div>
</div>

<div id="dashboard-view">
    <header class="dashboard-header">
        <div class="header-logo"><i class="fas fa-tasks"></i><span>پنل ارزیابی جهادگران</span></div>
        <div class="header-controls">
            <span id="user-name-display"></span>
            <button id="theme-toggle-btn" class="icon-button" title="تغییر حالت نمایش"><i class="fas fa-moon"></i></button>
            <button id="logout-btn" class="icon-button" title="خروج از حساب"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </header>

    <main class="main-container">
        <div class="nav-tabs" id="main-nav-tabs">
            <div class="nav-tab active" data-tab="memberships">
                <i class="fas fa-user-check"></i> بررسی عضویت‌ها
            </div>
            <div class="nav-tab" data-tab="activities">
                <i class="fas fa-chart-line"></i> بررسی فعالیت‌ها
            </div>
            <div class="nav-tab" data-tab="search">
                <i class="fas fa-search"></i> جستجو کاربران
            </div>
        </div>

        <!-- Membership Tab -->
        <div id="memberships-content" class="tab-content active">
            <div class="card">
                <div class="nav-tabs" id="membership-status-tabs">
                    <div class="nav-tab active" data-status="0">در حال انتظار</div>
                    <div class="nav-tab" data-status="5">تائید شده</div>
                    <div class="nav-tab" data-status="1">رد شده</div>
                </div>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>تاریخ ثبت نام</th>
                                <th>نام و نام خانوادگی</th>
                                <th>کد ملی</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="memberships-table-body"></tbody>
                    </table>
                </div>
                <div class="pagination-controls" id="memberships-pagination"></div>
            </div>
        </div>

        <!-- Activities Tab -->
        <div id="activities-content" class="tab-content">
            <div class="card">
                <div class="nav-tabs" id="activity-status-tabs">
                    <div class="nav-tab active" data-status="0">در حال بررسی</div>
                    <div class="nav-tab" data-status="5">تائید شده</div>
                    <div class="nav-tab" data-status="1">رد شده</div>
                    <div class="nav-tab" data-status="all">همه</div>
                </div>
                <!-- دستور چهارم: افزودن جستجو و دکمه استخراج اکسل -->
                <div class="card-controls">
                    <div class="search-container">
                        <input type="search" id="activity-search-input" placeholder="جستجوی کد ملی...">
                        <button id="activity-search-btn" title="جستجو"><i class="fas fa-search"></i></button>
                    </div>
                    <button id="export-excel-btn" class="btn-export"><i class="fas fa-file-excel"></i> استخراج اکسل</button>
                </div>
                <div class="table-responsive">
                    <table class="data-table" id="activities-data-table">
                        <thead>
                            <tr>
                                <th>نام جهادگر</th>
                                <th>کد ملی</th>
                                <th>عنوان فعالیت</th>
                                <th>تاریخ شروع</th>
                                <th>تاریخ اتمام</th>
                                <th>توضیحات</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="activities-table-body"></tbody>
                    </table>
                </div>
                <div class="pagination-controls" id="activities-pagination"></div>
            </div>
        </div>

        <!-- Search Tab -->
        <div id="search-content" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-search"></i>
                    <h2>جستجوی جهادگران</h2>
                </div>
                <div class="search-container">
                    <input type="search" id="search-input" placeholder="نام یا کد ملی را وارد کنید...">
                    <button id="search-btn"><i class="fas fa-search"></i></button>
                </div>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>نام و نام خانوادگی</th>
                                <th>کد ملی</th>
                                <th>تاریخ تولد</th>
                                <th>تخصص</th>
                                <th>وضعیت عضویت</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="search-results-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Modals -->
<div class="modal-overlay" id="action-confirmation-modal">
    <div class="modal-box">
        <button class="modal-close-btn"><i class="fas fa-times"></i></button>
        <i class="fas fa-exclamation-triangle icon" style="color: var(--warning);"></i>
        <p id="action-confirmation-message"></p>
        <div class="modal-actions">
            <button id="confirm-action-btn" class="modal-action-btn confirm-btn">تایید</button>
            <button class="modal-action-btn cancel-btn modal-close-btn">انصراف</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="description-modal">
    <div class="modal-box" style="text-align: right;">
        <button class="modal-close-btn"><i class="fas fa-times"></i></button>
        <h3 style="margin-bottom: 15px;">توضیحات فعالیت</h3>
        <p id="modal-description-text" style="line-height: 2; max-height: 60vh; overflow-y: auto;"></p>
    </div>
</div>

<div id="toast-container"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ⬇️⬇️⬇️ مهم: این آدرس را با آدرس Web App خود جایگزین کنید ⬇️⬇️⬇️
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx_USt6iFHiAMKZXSmfQqDnl95hYw2prf-V5SWaPLU25YXNyBUBhQjgoqwwHzRyPgrizg/exec"; // <--- آدرس را اینجا قرار دهید

    // --- State Management ---
    const state = {
        currentPage: 'memberships',
        membershipStatus: '0',
        membershipPage: 1,
        activityStatus: '0',
        activityPage: 1,
        activitySearchQuery: '',
    };
    const AUTH_TOKEN_KEY = 'jahadgaranAuthToken';

    // --- Element Caching ---
    const loginView = document.getElementById('login-view');
    const dashboardView = document.getElementById('dashboard-view');
    const loginForm = document.getElementById('login-form');
    const loginButton = document.getElementById('login-button');
    const loginErrorMsg = document.getElementById('login-error-msg');
    const themeToggleBtn = document.getElementById('theme-toggle-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const mainNavTabs = document.getElementById('main-nav-tabs');
    const membershipStatusTabs = document.getElementById('membership-status-tabs');
    const activityStatusTabs = document.getElementById('activity-status-tabs');
    const activitySearchBtn = document.getElementById('activity-search-btn');
    const activitySearchInput = document.getElementById('activity-search-input');
    const exportExcelBtn = document.getElementById('export-excel-btn');

    // --- Utility Functions ---
    const showToast = (message, type = 'info') => {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        let icon = 'fa-info-circle';
        if (type === 'success') icon = 'fa-check-circle';
        if (type === 'error') icon = 'fa-times-circle';
        toast.innerHTML = `<i class="fas ${icon} toast-icon"></i><span>${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('hide');
            toast.addEventListener('animationend', () => toast.remove());
        }, 5000);
    };

    const apiRequest = async (params) => {
        const token = sessionStorage.getItem(AUTH_TOKEN_KEY);
        if (!token && params.action !== 'loginAssessor') {
            showToast('نشست شما معتبر نیست. لطفاً وارد شوید.', 'error');
            logout();
            throw new Error("No auth token found.");
        }

        const url = new URL(SCRIPT_URL);
        if (token) params.authToken = token;
        Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('خطای شبکه در ارتباط با سرور.');
            const result = await response.json();
            if (result.error) {
                if (result.message.includes("نشست شما نامعتبر")) {
                    setTimeout(logout, 1500);
                }
                throw new Error(result.message);
            }
            return result;
        } catch (e) {
            showToast(e.message, 'error');
            throw e;
        }
    };
    
    // دستور سوم: اصلاح نمایش تاریخ‌ها به صورت شمسی
    const formatShamsiDate = (dateString) => {
        if (!dateString || typeof dateString !== 'string') return '-';
        // اگر فرمت از قبل صحیح بود، همان را برگردان
        if (/^\d{4}\/\d{2}\/\d{2}$/.test(dateString)) {
            return dateString;
        }
        try {
            const date = new Date(dateString);
            // استفاده از Intl برای فرمت‌دهی صحیح تاریخ شمسی
            return new Intl.DateTimeFormat('fa-IR-u-nu-latn', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }).format(date);
        } catch (error) {
            // در صورت خطا، مقدار اصلی را برگردان تا محتوایی نمایش داده شود
            return dateString.split(' ')[0] || '-'; 
        }
    };

    const renderPagination = (containerId, currentPage, totalPages, callback) => {
        const container = document.getElementById(containerId);
        if (!container || totalPages <= 1) {
            if(container) container.innerHTML = '';
            return;
        }
        container.innerHTML = `
            <button class="prev-btn" ${currentPage === 1 ? 'disabled' : ''}>قبلی</button>
            <span class="pagination-info">صفحه ${currentPage} از ${totalPages}</span>
            <button class="next-btn" ${currentPage === totalPages ? 'disabled' : ''}>بعدی</button>
        `;
        container.querySelector('.prev-btn')?.addEventListener('click', () => callback(currentPage - 1));
        container.querySelector('.next-btn')?.addEventListener('click', () => callback(currentPage + 1));
    };

    // دستور سوم: نمایش لودینگ در هنگام بارگذاری داده‌ها
    const showPlaceholder = (tbodyId, message) => {
        const loadingHTML = `
            <div class="loading-placeholder">
                <div class="spinner"></div>
                <span>${message}</span>
            </div>
        `;
        document.getElementById(tbodyId).innerHTML = `<tr><td colspan="10" class="placeholder-row">${loadingHTML}</td></tr>`;
    };

    // --- Authentication ---
    const handleLogin = async () => {
        loginErrorMsg.textContent = '';
        loginButton.classList.add('loading');
        loginButton.disabled = true;

        const recaptchaResponse = grecaptcha.getResponse();
        if (!recaptchaResponse) {
            loginErrorMsg.textContent = 'لطفاً تأیید کنید که ربات نیستید.';
            loginButton.classList.remove('loading');
            loginButton.disabled = false;
            return;
        }
        
        try {
            const result = await apiRequest({
                action: 'loginAssessor',
                username: document.getElementById('login-username').value,
                password: document.getElementById('login-password').value,
                recaptchaToken: recaptchaResponse,
            });
            if (result.success) {
                sessionStorage.setItem(AUTH_TOKEN_KEY, result.authToken);
                initDashboard(result);
            }
        } catch(e) {
            loginErrorMsg.textContent = e.message;
        } finally {
            grecaptcha.reset();
            loginButton.classList.remove('loading');
            loginButton.disabled = false;
        }
    };

    const logout = () => {
        const token = sessionStorage.getItem(AUTH_TOKEN_KEY);
        if (token) apiRequest({ action: 'logout' }).catch(err => console.error("Logout failed:", err));
        sessionStorage.removeItem(AUTH_TOKEN_KEY);
        location.reload();
    };

    const initDashboard = (userData) => {
        loginView.style.display = 'none';
        dashboardView.style.display = 'block';
        document.getElementById('user-name-display').textContent = `خوش آمدید، ${userData.name}`;
        fetchMemberships();
    };
    
    // --- Data Fetching & Rendering ---
    const fetchMemberships = async (page = 1) => {
        state.membershipPage = page;
        showPlaceholder('memberships-table-body', 'در حال بارگذاری عضویت‌ها...');
        try {
            const result = await apiRequest({
                action: 'getMemberships',
                status: state.membershipStatus,
                page: state.membershipPage
            });
            renderMemberships(result.data);
            renderPagination('memberships-pagination', result.currentPage, result.totalPages, fetchMemberships);
        } catch (e) {
            document.getElementById('memberships-table-body').innerHTML = `<tr><td colspan="4" class="placeholder-row">خطا در بارگذاری اطلاعات.</td></tr>`;
        }
    };

    const renderMemberships = (data) => {
        const tbody = document.getElementById('memberships-table-body');
        if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="4" class="placeholder-row">موردی برای نمایش یافت نشد.</td></tr>`;
            return;
        }
        tbody.innerHTML = data.map(item => `
            <tr data-row-index="${item.rowIndex}" data-name="${item.fullName}">
                <td>${formatShamsiDate(item.regDate)}</td>
                <td>${item.fullName}</td>
                <td>${item.nationalId}</td>
                <td class="table-actions">
                    ${state.membershipStatus !== '5' ? `<i class="fas fa-check-circle action-icon action-approve" title="تائید"></i><div class="spinner"></div>` : ''}
                    ${state.membershipStatus !== '1' ? `<i class="fas fa-times-circle action-icon action-reject" title="رد کردن"></i><div class="spinner"></div>` : ''}
                    ${state.membershipStatus === '1' ? `<i class="fas fa-redo action-icon action-reapprove" title="تائید مجدد"></i><div class="spinner"></div>` : ''}
                </td>
            </tr>
        `).join('');
    };
    
    const fetchActivities = async (page = 1) => {
        state.activityPage = page;
        showPlaceholder('activities-table-body', 'در حال بارگذاری فعالیت‌ها...');
        try {
            const result = await apiRequest({
                action: 'getActivities',
                status: state.activityStatus,
                page: state.activityPage,
                search: state.activitySearchQuery,
            });
            renderActivities(result.data);
            renderPagination('activities-pagination', result.currentPage, result.totalPages, fetchActivities);
        } catch (e) {
             document.getElementById('activities-table-body').innerHTML = `<tr><td colspan="7" class="placeholder-row">خطا در بارگذاری اطلاعات.</td></tr>`;
        }
    };
    
    const renderActivities = (data) => {
        const tbody = document.getElementById('activities-table-body');
        if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="placeholder-row">موردی برای نمایش یافت نشد.</td></tr>`;
            return;
        }
        tbody.innerHTML = data.map(item => `
            <tr data-row-index="${item.rowIndex}" data-name="${item.title}">
                <td>${item.fullName}</td>
                <td>${item.nationalId}</td>
                <td>${item.title}</td>
                <td>${formatShamsiDate(item.startDate)}</td>
                <td>${formatShamsiDate(item.endDate)}</td>
                <td><i class="fas fa-eye" title="مشاهده توضیحات" style="cursor:pointer; color: var(--primary);" data-description="${item.description}"></i></td>
                <td class="table-actions">
                    ${(state.activityStatus !== '5' && item.status !== '5') ? `<i class="fas fa-check-circle action-icon action-approve" title="تائید"></i><div class="spinner"></div>` : ''}
                    ${(state.activityStatus !== '1' && item.status !== '1') ? `<i class="fas fa-times-circle action-icon action-reject" title="رد کردن"></i><div class="spinner"></div>` : ''}
                    ${(state.activityStatus === '1' || item.status === '1') ? `<i class="fas fa-redo action-icon action-reapprove" title="تائید مجدد"></i><div class="spinner"></div>` : ''}
                </td>
            </tr>
        `).join('');
    };
    
    const performSearch = async () => {
        const query = document.getElementById('search-input').value.trim();
        if (query.length < 3) {
            showToast('برای جستجو حداقل ۳ حرف وارد کنید.', 'error');
            return;
        }
        showPlaceholder('search-results-body', 'در حال جستجو...');
        try {
            const result = await apiRequest({ action: 'searchUsers', query });
            const tbody = document.getElementById('search-results-body');
            if(result.users.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="6" class="placeholder-row">هیچ نتیجه‌ای یافت نشد.</td></tr>`;
                 return;
            }
            tbody.innerHTML = result.users.map(user => `
                <tr data-national-id="${user.nationalId}" data-row-index="${user.rowIndex}" data-name="${user.fullName}">
                    <td class="user-name-clickable" title="برای مشاهده فعالیت‌ها کلیک کنید">${user.fullName}</td>
                    <td>${user.nationalId}</td>
                    <td>${formatShamsiDate(user.dob)}</td>
                    <td>${user.skills}</td>
                    <td>${user.status === '5' ? 'تائید شده' : 'تائید نشده'}</td>
                    <td class="table-actions">
                        ${user.status !== '5' ? `<i class="fas fa-check-circle action-icon action-approve" title="تائید عضویت"></i><div class="spinner"></div>` : '-'}
                    </td>
                </tr>
            `).join('');
        } catch(e) {
            document.getElementById('search-results-body').innerHTML = `<tr><td colspan="6" class="placeholder-row">خطا در جستجو.</td></tr>`;
        }
    };
    
    // --- Action Handling ---
    const confirmAction = (message, onConfirm) => {
        document.getElementById('action-confirmation-message').textContent = message;
        const modal = document.getElementById('action-confirmation-modal');
        modal.classList.add('show');
        const confirmBtn = document.getElementById('confirm-action-btn');
        
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

        newConfirmBtn.onclick = () => {
            onConfirm();
            modal.classList.remove('show');
        };
    };

    const updateStatus = async (type, rowIndex, newStatus, element) => {
        // دستور ششم: نمایش لودینگ روی آیکن عملیات
        if(element) element.classList.add('loading');
        
        const action = type === 'membership' ? 'updateMembershipStatus' : 'updateActivityStatus';
        const fetchFn = type === 'membership' ? fetchMemberships : fetchActivities;
        const page = type === 'membership' ? state.membershipPage : state.activityPage;
        try {
            await apiRequest({ action, rowIndex, newStatus });
            showToast('عملیات با موفقیت انجام شد.', 'success');
            if (state.currentPage === 'search') {
                performSearch(); // Refresh search results
            } else {
                fetchFn(page); // Refresh the current view
            }
        } catch (e) {
            // Error toast is already shown by apiRequest
        } finally {
            if(element) element.classList.remove('loading');
        }
    };

    // دستور پنجم: نمایش فعالیت‌های کاربر و دانلود PDF
    const toggleUserActivities = async (row) => {
        const existingDetailRow = row.nextElementSibling;
        if (existingDetailRow && existingDetailRow.classList.contains('activities-detail-row')) {
            existingDetailRow.remove();
            return;
        }

        const nationalId = row.dataset.nationalId;
        const userName = row.dataset.name;
        
        const detailRow = document.createElement('tr');
        detailRow.className = 'activities-detail-row';
        detailRow.innerHTML = `<td colspan="6"><div class="activities-detail-content">در حال بارگذاری فعالیت‌ها...</div></td>`;
        row.after(detailRow);

        try {
            const result = await apiRequest({ action: 'getActivitiesForUser', nationalId });
            const contentDiv = detailRow.querySelector('.activities-detail-content');
            
            if (result.activities.length === 0) {
                contentDiv.innerHTML = '<h4>این کاربر فعالیتی ثبت نکرده است.</h4>';
                return;
            }

            let tableHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h4>فعالیت‌های ${userName}</h4>
                    <button class="btn-export" data-national-id="${nationalId}" data-name="${userName}" id="pdf-export-btn"><i class="fas fa-file-pdf"></i> دانلود PDF</button>
                </div>
                <table class="data-table">
                    <thead><tr><th>عنوان</th><th>تاریخ شروع</th><th>تاریخ پایان</th><th>وضعیت</th><th>عملیات</th></tr></thead>
                    <tbody>
            `;
            result.activities.forEach(act => {
                const statusText = act.status === '5' ? 'تائید شده' : (act.status === '1' ? 'رد شده' : 'در حال بررسی');
                tableHTML += `
                    <tr data-row-index="${act.rowIndex}" data-name="${act.title}">
                        <td>${act.title}</td>
                        <td>${formatShamsiDate(act.startDate)}</td>
                        <td>${formatShamsiDate(act.endDate)}</td>
                        <td>${statusText}</td>
                        <td class="table-actions">
                          ${act.status !== '5' ? `<i class="fas fa-check-circle action-icon action-approve" title="تائید فعالیت"></i><div class="spinner"></div>` : '-'}
                        </td>
                    </tr>`;
            });
            tableHTML += '</tbody></table>';
            contentDiv.innerHTML = tableHTML;
            
        } catch (e) {
            detailRow.querySelector('.activities-detail-content').innerHTML = 'خطا در دریافت فعالیت‌ها.';
        }
    };
    
    const generatePdfForUser = async (nationalId, userName) => {
        showToast('در حال آماده‌سازی فایل PDF...');
        try {
            const { activities } = await apiRequest({ action: 'getActivitiesForUser', nationalId });
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add Vazir font (assuming it's available or loaded)
            // This part requires a Base64 encoded font file to be included in the script for full Persian support.
            // For simplicity, we use a standard font which may not render Persian correctly without font embedding.
            doc.setFont('Helvetica'); // Placeholder font
            
            doc.setR2L(true); // Enable Right-to-Left for Persian
            
            doc.text("گروه جهادی طلاب و روحانیون جنوب", 105, 15, { align: 'center' });
            doc.text(`فعالیت های جهادگر: ${userName}`, 105, 25, { align: 'center' });
            
            const tableColumn = ["عملیات", "وضعیت", "تاریخ پایان", "تاریخ شروع", "عنوان فعالیت"];
            const tableRows = [];

            activities.forEach(act => {
                const statusText = act.status === '5' ? 'تائید شده' : (act.status === '1' ? 'رد شده' : 'در حال بررسی');
                const activityData = [
                    '-',
                    statusText,
                    formatShamsiDate(act.endDate),
                    formatShamsiDate(act.startDate),
                    act.title,
                ];
                tableRows.push(activityData);
            });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 35,
                theme: 'grid',
                headStyles: { halign: 'center', fontStyle: 'bold' },
                styles: { halign: 'right', font: 'Helvetica' } // Use the loaded font
            });
            
            doc.save(`activities_${nationalId}.pdf`);

        } catch (e) {
            showToast('خطا در ایجاد فایل PDF.', 'error');
        }
    };
    
    // دستور چهارم: استخراج داده‌ها به اکسل (CSV)
    const exportTableToExcel = (tableId, filename = '') => {
        const table = document.getElementById(tableId);
        if (!table) return;

        let csv = [];
        const rows = table.querySelectorAll("tr");
        
        for (const row of rows) {
            const cols = row.querySelectorAll("td, th");
            const rowData = [];
            for (const col of cols) {
                // Remove the "عملیات" column from export
                if (col.cellIndex !== cols.length - 1) { 
                    rowData.push('"' + col.innerText.replace(/"/g, '""') + '"');
                }
            }
            csv.push(rowData.join(","));
        }

        const csvFile = new Blob(["\uFEFF" + csv.join("\n")], { type: "text/csv;charset=utf-8;" });
        const downloadLink = document.createElement("a");
        downloadLink.href = URL.createObjectURL(csvFile);
        downloadLink.download = filename ? filename + '.csv' : 'export.csv';
        downloadLink.style.display = "none";
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
    };

    // --- Event Listeners ---
    loginForm.addEventListener('submit', (e) => { e.preventDefault(); handleLogin(); });
    logoutBtn.addEventListener('click', logout);
    exportExcelBtn.addEventListener('click', () => exportTableToExcel('activities-data-table', 'jahadgaran_activities'));

    mainNavTabs.addEventListener('click', (e) => {
        const tab = e.target.closest('.nav-tab');
        if (!tab) return;
        
        mainNavTabs.querySelector('.active').classList.remove('active');
        tab.classList.add('active');
        
        document.querySelector('.tab-content.active').classList.remove('active');
        const tabName = tab.dataset.tab;
        document.getElementById(`${tabName}-content`).classList.add('active');

        state.currentPage = tabName;
        if (tabName === 'memberships') fetchMemberships(1);
        if (tabName === 'activities') {
            state.activitySearchQuery = '';
            activitySearchInput.value = '';
            fetchActivities(1);
        };
        if (tabName === 'search') document.getElementById('search-results-body').innerHTML = '';
    });
    
    membershipStatusTabs.addEventListener('click', (e) => {
        const tab = e.target.closest('.nav-tab');
        if (!tab || tab.classList.contains('active')) return;
        membershipStatusTabs.querySelector('.active').classList.remove('active');
        tab.classList.add('active');
        state.membershipStatus = tab.dataset.status;
        fetchMemberships(1);
    });

    activityStatusTabs.addEventListener('click', (e) => {
        const tab = e.target.closest('.nav-tab');
        if (!tab || tab.classList.contains('active')) return;
        activityStatusTabs.querySelector('.active').classList.remove('active');
        tab.classList.add('active');
        state.activityStatus = tab.dataset.status;
        fetchActivities(1);
    });
    
    document.getElementById('memberships-table-body').addEventListener('click', (e) => {
        const target = e.target;
        if (!target.classList.contains('action-icon')) return;
        const row = target.closest('tr');
        if (!row) return;
        const rowIndex = row.dataset.rowIndex;
        const name = row.dataset.name;
        
        if (target.classList.contains('action-approve') || target.classList.contains('action-reapprove')) {
            confirmAction(`آیا از تائید عضویت "${name}" مطمئن هستید؟`, () => updateStatus('membership', rowIndex, 5, target));
        } else if (target.classList.contains('action-reject')) {
            confirmAction(`آیا از رد عضویت "${name}" مطمئن هستید؟`, () => updateStatus('membership', rowIndex, 1, target));
        }
    });

    document.getElementById('activities-table-body').addEventListener('click', (e) => {
        const target = e.target;
        const row = target.closest('tr');
        if (!row) return;

        if (target.classList.contains('action-icon')) {
            const rowIndex = row.dataset.rowIndex;
            const name = row.dataset.name;
            if (target.classList.contains('action-approve') || target.classList.contains('action-reapprove')) {
                confirmAction(`آیا از تائید فعالیت "${name}" مطمئن هستید؟`, () => updateStatus('activity', rowIndex, 5, target));
            } else if (target.classList.contains('action-reject')) {
                confirmAction(`آیا از رد فعالیت "${name}" مطمئن هستید؟`, () => updateStatus('activity', rowIndex, 1, target));
            }
        } else if (target.dataset.description) {
            document.getElementById('modal-description-text').textContent = target.dataset.description;
            document.getElementById('description-modal').classList.add('show');
        }
    });

    document.getElementById('search-results-body').addEventListener('click', (e) => {
        const target = e.target;
        const row = target.closest('tr');
        if (!row) return;

        // Handle expanding activities
        if (target.classList.contains('user-name-clickable')) {
            toggleUserActivities(row);
        }
        
        // Handle approve membership from search
        if (target.classList.contains('action-icon') && target.classList.contains('action-approve')) {
             const rowIndex = row.dataset.rowIndex;
             const name = row.dataset.name;
             confirmAction(`آیا از تائید عضویت "${name}" مطمئن هستید؟`, () => updateStatus('membership', rowIndex, 5, target));
        }

        // Handle actions within the expanded detail row
        if (target.closest('.activities-detail-row')) {
             if (target.id === 'pdf-export-btn') {
                 generatePdfForUser(target.dataset.nationalId, target.dataset.name);
             } else if (target.classList.contains('action-icon') && target.classList.contains('action-approve')) {
                 const activityRow = target.closest('tr');
                 const rowIndex = activityRow.dataset.rowIndex;
                 const name = activityRow.dataset.name;
                 confirmAction(`آیا از تائید فعالیت "${name}" مطمئن هستید؟`, () => updateStatus('activity', rowIndex, 5, target));
             }
        }
    });

    const handleActivitySearch = () => {
        state.activitySearchQuery = activitySearchInput.value.trim();
        fetchActivities(1);
    };
    activitySearchBtn.addEventListener('click', handleActivitySearch);
    activitySearchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleActivitySearch();
    });
    
    document.getElementById('search-btn').addEventListener('click', performSearch);
    document.getElementById('search-input').addEventListener('keypress', (e) => {
        if(e.key === 'Enter') performSearch();
    });

    // Modal close listeners
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', e => {
            if (e.target === modal || e.target.closest('.modal-close-btn')) {
                modal.classList.remove('show');
            }
        });
    });
    
    // --- Theme Management ---
    const loadTheme = () => {
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.classList.add('dark-mode');
            themeToggleBtn.querySelector('i').classList.replace('fa-moon', 'fa-sun');
        }
    };
    const toggleTheme = () => {
        document.documentElement.classList.toggle('dark-mode');
        const isDark = document.documentElement.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        themeToggleBtn.querySelector('i').classList.toggle('fa-moon', !isDark);
        themeToggleBtn.querySelector('i').classList.toggle('fa-sun', isDark);
    };
    themeToggleBtn.addEventListener('click', toggleTheme);

    // --- Initial Load ---
    if (sessionStorage.getItem(AUTH_TOKEN_KEY)) {
        initDashboard({ name: 'ارزیاب' });
    } else {
        loginView.style.display = 'flex';
    }
    loadTheme();
});
</script>

</body>
</html>
