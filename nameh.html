
<!DOCTYPE html> 
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سامانه مکاتبات</title>
    
    <!-- فونت‌ها -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <!-- استایل برش تصویر -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">

    <style>
        :root { --primary: #34495e; --accent: #3498db; --bg: #f5f6fa; }
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background: var(--bg);
            direction: rtl;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%; max-width: 900px;
            background: #fff; padding: 30px;
            border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        h2, h3 { color: var(--primary); margin-bottom: 15px; }
        h3 { font-size: 1.1rem; border-right: 4px solid var(--accent); padding-right: 10px; margin-top: 25px; }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 5px; color: #555; font-size: 0.9rem; }
        .form-input {
            width: 100%; padding: 10px;
            border: 1px solid #ddd; border-radius: 5px;
            font-family: 'Vazirmatn', sans-serif;
        }
        textarea.form-input { min-height: 120px; resize: vertical; }

        /* بخش تصاویر */
        .image-box {
            border: 2px dashed #ccc; padding: 15px; border-radius: 8px;
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
        }
        .img-btn {
            background: #ecf0f1; border: 1px solid #bdc3c7;
            padding: 20px; text-align: center; cursor: pointer; border-radius: 5px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .img-preview { max-width: 100%; height: 80px; object-fit: contain; margin-top: 10px; display: none; }
        
        .controls { margin-top: 15px; display: flex; align-items: center; gap: 20px; }
        .radio-group label { margin-left: 15px; cursor: pointer; }
        .range-group { flex: 1; display: flex; align-items: center; gap: 10px; }
        input[type="range"] { flex: 1; }

        /* دکمه‌ها */
        .btn {
            width: 100%; padding: 15px; border: none; border-radius: 5px;
            font-size: 1rem; cursor: pointer; color: #fff; font-weight: bold; margin-top: 10px;
        }
        .btn-submit { background: var(--primary); }
        .btn-dl { background: #27ae60; display: none; margin-top: 20px; }
        .btn:disabled { opacity: 0.7; cursor: wait; }

        /* ناحیه پیش نمایش */
        #previewArea { display: none; margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; }
        #sheetsContainer { background: #555; padding: 20px; overflow-x: auto; display: flex; flex-direction: column; align-items: center; gap: 20px; }

        /* مدال برش تصویر */
        .crop-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000;
            display: none; align-items: center; justify-content: center;
        }
        .crop-content { background: #fff; padding: 15px; width: 90%; max-width: 500px; border-radius: 8px; }
        .crop-img-container { height: 300px; background: #eee; overflow: hidden; }
        .crop-img-container img { max-width: 100%; }
        .crop-btns { margin-top: 15px; display: flex; gap: 10px; }
        .btn-crop { flex: 1; padding: 10px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn-cancel { flex: 1; padding: 10px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; }

        /* استایل کاغذ A5 - دقیق */
        .sheet {
            width: 148mm; height: 210mm;
            background: #fff; padding: 10mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            position: relative; box-sizing: border-box;
            display: flex; flex-direction: column; overflow: hidden; flex-shrink: 0;
        }
        .sheet * { font-family: 'Amiri', serif; color: #000; line-height: 1.6; }

        .header { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 10px; }
        .col { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .right { text-align: right; font-size: 11px; }
        .center { text-align: center; flex: 1.5; font-weight: bold; font-size: 16px; }
        .left { text-align: left; font-size: 11px; }

        .body { flex-grow: 1; display: flex; flex-direction: column; font-size: 14px; }
        
        .letter-txt {
            text-align: justify; /* تراز کامل */
            text-justify: inter-word;
            margin-bottom: 15px;
            white-space: pre-wrap;
        }

        .img-container { display: flex; justify-content: center; align-items: flex-start; margin: 10px 0; }
        .img-container.vertical { flex-direction: column; align-items: center; gap: 15px; }
        .img-container.horizontal { flex-direction: row; gap: 15px; }
        
        .final-img { border-radius: 4px; object-fit: contain; height: auto !important; }

        .footer { margin-top: auto; text-align: center; padding-top: 20px; }
        .sign-text { font-weight: bold; font-size: 12px; margin-bottom: 5px; }
        
        #msg { padding: 10px; margin-top: 10px; text-align: center; display: none; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2>سامانه مکاتبات</h2>
    <form id="form">
        <div class="form-group"><label class="form-label">اداره / گیرنده</label><input type="text" id="dept" class="form-input" required></div>
        <div class="form-group"><label class="form-label">موضوع</label><input type="text" id="subj" class="form-input" required></div>
        <div class="form-group"><label class="form-label">متن نامه</label><textarea id="txt" class="form-input" required></textarea></div>

        <h3>تصاویر (با قابلیت برش)</h3>
        <div class="image-box">
            <div class="img-btn" onclick="openCrop('img1')">
                <span>انتخاب تصویر ۱</span>
                <img id="prev1" class="img-preview">
            </div>
            <div class="img-btn" onclick="openCrop('img2')">
                <span>انتخاب تصویر ۲</span>
                <img id="prev2" class="img-preview">
            </div>
        </div>
        <input type="file" id="fileInput" accept="image/*" hidden>

        <div class="controls">
            <div class="radio-group">
                <label><input type="radio" name="layout" value="vertical" checked> عمودی</label>
                <label><input type="radio" name="layout" value="horizontal"> افقی</label>
            </div>
            <div class="range-group">
                <label>سایز:</label>
                <input type="range" id="scale" min="20" max="100" value="80" oninput="document.getElementById('sv').innerText=this.value+'%'">
                <span id="sv">80%</span>
            </div>
        </div>

        <h3>پیوست و تایید</h3>
        <div class="form-group"><label class="form-label">متن پیوست</label><textarea id="attach" class="form-input"></textarea></div>
        <div class="form-group"><label class="form-label">کد تایید مدیرعامل</label><input type="password" id="code" class="form-input" inputmode="numeric" required></div>

        <button type="submit" id="btnGen" class="btn btn-submit">تولید نامه</button>
    </form>

    <div id="msg"></div>

    <div id="previewArea">
        <div id="sheetsContainer"></div>
        <button id="btnDl" class="btn btn-dl" onclick="downloadPDF()">دانلود PDF</button>
    </div>
</div>

<!-- مدال برش -->
<div id="cropModal" class="crop-modal">
    <div class="crop-content">
        <h4>برش تصویر</h4>
        <div class="crop-img-container">
            <img id="cropImageSrc">
        </div>
        <div class="crop-btns">
            <button class="btn-crop" onclick="cropAndSave()">تایید و برش</button>
            <button class="btn-cancel" onclick="closeModal()">انصراف</button>
        </div>
    </div>
</div>

<!-- رندر مخفی -->
<div id="render" style="position:fixed; left:-9999px;"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrJh6FWkNjydhbSUwXgXy9Etobnbs0hTq7LRkVWj9zC-2I2uOXqPyDXn159t5vcZoWlg/exec";
    
    let images = { img1: null, img2: null };
    let currentCropTarget = null;
    let cropper = null;
    let letterData = {};

    // مدیریت برش تصویر
    const fileInput = document.getElementById('fileInput');
    const modal = document.getElementById('cropModal');
    const imageSrc = document.getElementById('cropImageSrc');

    function openCrop(target) {
        currentCropTarget = target;
        fileInput.value = '';
        fileInput.click();
    }

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                imageSrc.src = e.target.result;
                modal.style.display = 'flex';
                if (cropper) cropper.destroy();
                cropper = new Cropper(imageSrc, { viewMode: 1 });
            };
            reader.readAsDataURL(file);
        }
    });

    function cropAndSave() {
        if (!cropper) return;
        const canvas = cropper.getCroppedCanvas();
        const croppedData = canvas.toDataURL('image/jpeg');
        
        images[currentCropTarget] = croppedData;
        const prev = document.getElementById(currentCropTarget === 'img1' ? 'prev1' : 'prev2');
        prev.src = croppedData;
        prev.style.display = 'block';
        
        closeModal();
    }

    function closeModal() {
        modal.style.display = 'none';
        if (cropper) cropper.destroy();
    }

    function toFa(s) { return String(s).replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]); }
    function toEn(s) { return String(s).replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d)); }

    function createSheet(data, isAttach) {
        const div = document.createElement('div');
        div.className = 'sheet';

        const title = isAttach ? "پیوست نامه" : "بسمه تعالی";
        const body = isAttach ? data.attach : data.txt;
        
        let imgHtml = '';
        if (!isAttach && (images.img1 || images.img2)) {
            const layout = document.querySelector('input[name="layout"]:checked').value;
            const size = document.getElementById('scale').value;
            // محاسبه عرض: در افقی ماکسیمم ۴۸ درصد
            const w = layout === 'vertical' ? `${size}%` : `${Math.min(size, 48)}%`;
            
            let imgs = '';
            if (images.img1) imgs += `<img src="${images.img1}" class="final-img" style="width:${w}">`;
            if (images.img2) imgs += `<img src="${images.img2}" class="final-img" style="width:${w}">`;
            
            imgHtml = `<div class="img-container ${layout}">${imgs}</div>`;
        }

        div.innerHTML = `
            <div class="header">
                <div class="col right">
                    <p>تلفن: ۰۹۱۳۵۰۷۶۵۸۷</p>
                    <p>آدرس: جیرفت، خ استقلال</p>
                </div>
                <div class="col center">
                    <p>مؤسسه تعالی اندیشه و رشد</p>
                    <p style="font-size:11px; font-weight:normal;">شناسه: ۱۴۰۱۳۷۷۰۶۱۱</p>
                </div>
                <div class="col left">
                    <p>شماره: ${toFa(data.num)}</p>
                    <p>تاریخ: ${toFa(data.date)}</p>
                </div>
            </div>
            <div class="body">
                <p style="text-align:center; font-weight:bold; margin-bottom:10px;">${title}</p>
                ${!isAttach ? `<p style="font-weight:bold;">گیرنده: ${data.dept}</p>` : ''}
                <p style="margin-bottom:15px;">موضوع: ${data.subj}</p>
                <div class="letter-txt">${body.replace(/\n/g, '<br>')}</div>
                ${imgHtml}
            </div>
            <div class="footer">
                <p class="sign-text">امضاء</p>
                <p class="sign-text">مدیرعامل مؤسسه تعالی اندیشه و رشد</p>
            </div>
        `;
        return div;
    }

    document.getElementById('form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnGen');
        const msg = document.getElementById('msg');
        
        btn.disabled = true; msg.style.display = 'none';

        const now = new Date();
        const jDate = now.toLocaleDateString('fa-IR');
        const lNum = `${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}4`;
        
        const payload = {
            verificationCode: toEn(document.getElementById('code').value),
            department: document.getElementById('dept').value,
            subject: document.getElementById('subj').value,
            letterText: document.getElementById('txt').value,
            attachmentText: document.getElementById('attach').value,
            issueDate: toEn(jDate),
            letterNumber: lNum,
            imageStatus: (images.img1 || images.img2) ? "تصویر دارد" : "بدون تصویر"
        };

        try {
            const req = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
            const res = await req.json();

            if (res.status === 'success') {
                msg.innerText = "تولید شد."; msg.style.color = "green"; msg.style.display = "block";
                
                letterData = { ...payload, num: lNum, date: jDate, txt: payload.letterText, attach: payload.attachmentText, dept: payload.department, subj: payload.subject };
                
                const container = document.getElementById('sheetsContainer');
                const render = document.getElementById('render');
                container.innerHTML = ''; render.innerHTML = '';

                const p1 = createSheet(letterData, false);
                container.appendChild(p1);
                render.appendChild(p1.cloneNode(true));

                if (payload.attachmentText.trim()) {
                    const p2 = createSheet(letterData, true);
                    container.appendChild(p2);
                    render.appendChild(p2.cloneNode(true));
                }

                document.getElementById('form').style.display = 'none';
                document.getElementById('previewArea').style.display = 'block';
                document.getElementById('btnDl').style.display = 'block';

            } else {
                throw new Error(res.message);
            }
        } catch (err) {
            msg.innerText = "خطا: " + err.message; msg.style.color = "red"; msg.style.display = "block";
            btn.disabled = false;
        }
    });

    async function downloadPDF() {
        const btn = document.getElementById('btnDl');
        btn.innerText = "در حال ساخت..."; btn.disabled = true;

        const { jsPDF } = window.jspdf;
        const sheets = document.querySelectorAll('#render .sheet');
        const pdf = new jsPDF({ format: 'a5', unit: 'mm' });

        for (let i = 0; i < sheets.length; i++) {
            if (i > 0) pdf.addPage();
            
            // حل مشکل حروف فارسی در حالت Justify
            await html2canvas(sheets[i], {
                scale: 3,
                useCORS: true,
                onclone: (cloned) => {
                    // ترفند: برای جلوگیری از بهم ریختن حروف، موقع عکس گرفتن
                    // متن را موقتا راست چین میکنیم اما با text-align-last: right
                    // این بهترین حالت برای حفظ ظاهر است
                    cloned.querySelectorAll('.letter-txt').forEach(el => {
                        el.style.textAlign = 'right'; 
                    });
                }
            }).then(canvas => {
                pdf.addImage(canvas.toDataURL('image/jpeg', 0.98), 'JPEG', 0, 0, 148, 210);
            });
        }

        pdf.save(`${letterData.subj}.pdf`);
        btn.innerText = "دانلود PDF"; btn.disabled = false;
    }
</script>

</body>
</html>
