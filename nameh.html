  
<!DOCTYPE html> 
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ø¬Ø§Ù…Ø¹ Ù…Ú©Ø§ØªØ¨Ø§Øª</title>
    
    <!-- ÙÙˆÙ†Øªâ€ŒÙ‡Ø§ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <!-- Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø´ ØªØµÙˆÛŒØ± -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">

    <style>
        :root {
            --primary: #2c3e50;
            --accent: #2980b9;
            --success: #27ae60;
            --danger: #c0392b;
            --bg: #ecf0f1;
            --card: #ffffff;
            --border: #bdc3c7;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background: linear-gradient(135deg, var(--bg), #bdc3c7);
            color: var(--primary);
            direction: rtl;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 950px;
            background: var(--card);
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            padding: 40px;
            margin-bottom: 60px;
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        h2 { text-align: center; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 25px; color: var(--primary); font-size: 1.8rem; }
        h3 { font-size: 1.1rem; color: var(--accent); margin: 30px 0 15px 0; border-right: 5px solid var(--accent); padding-right: 12px; display: flex; align-items: center; }

        /* ÙØ±Ù…â€ŒÙ‡Ø§ */
        .form-row { display: flex; gap: 20px; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 250px; margin-bottom: 25px; position: relative; }
        
        .form-input {
            width: 100%; padding: 14px 15px;
            border: 1px solid var(--border); border-radius: 10px;
            font-family: 'Vazirmatn', sans-serif; font-size: 1rem;
            background: #fdfdfd; transition: 0.3s;
        }
        .form-input:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 4px rgba(41, 128, 185, 0.15); }
        textarea.form-input { min-height: 130px; resize: vertical; line-height: 1.8; }
        
        .floating-label {
            position: absolute; top: -12px; right: 15px;
            background: var(--card); padding: 0 8px;
            font-size: 0.85rem; color: var(--accent); font-weight: bold;
            pointer-events: none;
        }

        /* Ù¾Ù†Ù„ ØªØµØ§ÙˆÛŒØ± Ùˆ Ø¨Ø±Ø´ */
        .image-manager {
            border: 2px dashed var(--accent); border-radius: 15px;
            padding: 25px; background: #f4f6f7;
        }
        .upload-grid { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .upload-card {
            flex: 1; min-width: 140px;
            background: #fff; border: 1px solid #e0e0e0; border-radius: 10px;
            padding: 15px; text-align: center; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .upload-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .preview-thumb { max-width: 100%; height: 100px; object-fit: contain; margin-top: 10px; display: none; border-radius: 5px; }

        .img-controls {
            display: flex; gap: 20px; align-items: center; flex-wrap: wrap;
            border-top: 1px solid #dcdcdc; padding-top: 20px;
        }
        .radio-group { display: flex; gap: 15px; background: #fff; padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; }
        .radio-label { cursor: pointer; font-size: 0.95rem; display: flex; align-items: center; gap: 6px; }
        input[type="radio"] { accent-color: var(--accent); transform: scale(1.2); }
        
        .slider-wrapper { flex-grow: 1; display: flex; align-items: center; gap: 15px; background: #fff; padding: 10px; border-radius: 10px; border: 1px solid #ddd; }
        input[type="range"] { flex-grow: 1; accent-color: var(--accent); cursor: pointer; height: 6px; }

        /* Ù…Ø¯Ø§Ù„ Ø¨Ø±Ø´ */
        .crop-modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .crop-modal-content {
            background: #fff; padding: 20px; width: 95%; max-width: 600px;
            border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .crop-area { height: 400px; background: #333; overflow: hidden; border-radius: 8px; margin-bottom: 20px; }
        .crop-actions { display: flex; gap: 15px; }

        /* Ú©Ù¾Ú†Ø§ */
        .security-box {
            background: #fff8e1; border: 1px solid #ffe0b2; padding: 15px; border-radius: 10px;
            display: flex; align-items: center; gap: 15px; margin-bottom: 25px;
        }
        .captcha-text { font-weight: bold; font-size: 1.3rem; letter-spacing: 3px; color: #e67e22; }
        .captcha-inp { width: 100px; text-align: center; font-size: 1.2rem; }

        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
        .btn {
            width: 100%; padding: 18px; border: none; border-radius: 12px;
            font-size: 1.1rem; font-weight: bold; color: #fff; cursor: pointer;
            transition: 0.3s; display: flex; justify-content: center; align-items: center; gap: 10px;
            position: relative; overflow: hidden;
        }
        .btn-submit { background: linear-gradient(45deg, var(--primary), #34495e); box-shadow: 0 5px 15px rgba(44, 62, 80, 0.3); }
        .btn-submit:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(44, 62, 80, 0.4); }
        
        .btn-crop-ok { background: var(--success); flex: 2; padding: 12px; border-radius: 8px; color: white; border: none; cursor: pointer; font-size: 1rem; }
        .btn-crop-cancel { background: var(--danger); flex: 1; padding: 12px; border-radius: 8px; color: white; border: none; cursor: pointer; font-size: 1rem; }

        .btn:disabled { background: #95a5a6; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.8; }

        /* Ù„ÙˆØ¯ÛŒÙ†Ú¯ */
        .spinner {
            width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3);
            border-top-color: #fff; border-radius: 50%; animation: spin 0.8s infinite linear;
            display: none;
        }
        .loading .spinner { display: block; }
        .loading .btn-text { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Ù¾ÛŒØ§Ù… Ø³ÛŒØ³ØªÙ… */
        #msgBox { text-align: center; padding: 15px; margin-top: 25px; border-radius: 10px; display: none; font-weight: bold; animation: fadeIn 0.3s; }
        .success-msg { background: #d4efdf; color: #145a32; border: 1px solid #a9dfbf; }
        .error-msg { background: #fadbd8; color: #78281f; border: 1px solid #f5b7b1; }

        /* Ù…Ø¯Ø§Ù„ Ù…ÙˆÙÙ‚ÛŒØª Ù†Ù‡Ø§ÛŒÛŒ */
        .success-modal-wrap {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none;
            align-items: center; justify-content: center; z-index: 3000; backdrop-filter: blur(5px);
        }
        .success-box {
            background: #fff; padding: 40px; border-radius: 20px; width: 90%; max-width: 450px;
            text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.5); animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .success-icon { font-size: 4rem; color: var(--success); margin-bottom: 20px; display: block; }
        .action-btns { display: flex; flex-direction: column; gap: 12px; margin-top: 30px; }
        .act-btn { padding: 15px; border-radius: 10px; text-decoration: none; color: white; font-weight: bold; transition: 0.2s; display: block; cursor: pointer; }
        .btn-view { background: var(--success); } .btn-view:hover { background: #219150; }
        .btn-share { background: var(--accent); } .btn-share:hover { background: #1f618d; }
        .btn-close { background: #7f8c8d; } .btn-close:hover { background: #626567; }

        /* Ù¾ÛŒØ´ Ù†Ù…Ø§ÛŒØ´ Ùˆ Ø±Ù†Ø¯Ø± */
        #finalArea { display: none; margin-top: 50px; border-top: 3px dashed #bdc3c7; padding-top: 30px; }
        #previewWrapper { background: #525659; padding: 30px; border-radius: 15px; display: flex; flex-direction: column; align-items: center; gap: 30px; overflow-x: auto; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
        #renderCanvas { position: fixed; left: -9999px; top: 0; }

        /* --- Ø§Ø³ØªØ§ÛŒÙ„ Ú©Ø§ØºØ° A5 (Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯) --- */
        .sheet {
            width: 148mm; height: 210mm;
            background: #fff; padding: 15mm 12mm;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            position: relative; box-sizing: border-box;
            display: flex; flex-direction: column; overflow: hidden; flex-shrink: 0;
            direction: rtl;
        }
        /* ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙÙˆÙ†Øª */
        .sheet * { 
            font-family: 'Amiri', serif; 
            color: #000; 
            line-height: 1.8;
        }

        .letter-head { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px; flex-shrink: 0; }
        .head-col { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .head-right { text-align: right; font-size: 11px; }
        .head-center { text-align: center; flex: 1.5; font-weight: bold; font-size: 17px; }
        .head-left { text-align: left; font-size: 11px; }

        .letter-content { flex-grow: 1; display: flex; flex-direction: column; font-size: 14px; position: relative; }
        
        .text-body {
            text-align: justify;
            text-justify: inter-word;
            text-align-last: right;
            white-space: pre-wrap;
            margin-bottom: 20px;
        }

        /* Ú©Ù„Ø§Ø³ ÙˆÛŒÚ˜Ù‡ Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª Ù¾Ø±ÛŒÙ†Øª - Ø­Ù„ Ù…Ø´Ú©Ù„ Ø¨Ù‡Ù… Ø±ÛŒØ®ØªÚ¯ÛŒ */
        .print-mode .text-body {
            text-align: right !important;
            text-justify: auto !important;
            letter-spacing: normal !important;
            font-variant-ligatures: none !important;
            text-rendering: auto !important;
        }

        .images-container {
            display: flex; justify-content: center; align-items: flex-start;
            margin: 10px 0; width: 100%;
        }
        .images-container.vertical { flex-direction: column; gap: 20px; align-items: center; }
        .images-container.horizontal { flex-direction: row; gap: 20px; }

        .letter-img {
            display: block; border-radius: 4px;
            object-fit: contain; max-height: 80mm;
            height: auto !important; 
        }

        .signature-section { margin-top: auto; text-align: center; padding-top: 30px; flex-shrink: 0; }
        .sig-text { font-weight: bold; font-size: 13px; margin-bottom: 5px; }

        /* Ú©Ù„Ø§Ø³ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø¯Ø± Ø±Ù†Ø¯Ø± */
        .hidden-in-print { display: none !important; }

    </style>
</head>
<body>

<div class="container">
    <h2>Ø³Ø§Ù…Ø§Ù†Ù‡ ØµØ¯ÙˆØ± Ù…Ú©Ø§ØªØ¨Ø§Øª</h2>
    
    <form id="appForm">
        <h3>Û±. Ù…Ø´Ø®ØµØ§Øª Ù†Ø§Ù…Ù‡</h3>
        <div class="form-row">
            <div class="form-group">
                <input type="text" id="dept" class="form-input" required placeholder=" ">
                <label class="floating-label">Ú¯ÛŒØ±Ù†Ø¯Ù‡ (Ø§Ø¯Ø§Ø±Ù‡/Ø´Ø®Øµ)</label>
            </div>
            <div class="form-group">
                <input type="text" id="subj" class="form-input" required placeholder=" ">
                <label class="floating-label">Ù…ÙˆØ¶ÙˆØ¹ Ù†Ø§Ù…Ù‡</label>
            </div>
        </div>
        <div class="form-group">
            <textarea id="txt" class="form-input" required placeholder=" "></textarea>
            <label class="floating-label">Ù…ØªÙ† Ø§ØµÙ„ÛŒ Ù†Ø§Ù…Ù‡</label>
        </div>

        <h3>Û². ØªØµØ§ÙˆÛŒØ± (Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª Ø¨Ø±Ø´ Ùˆ ØªÙ†Ø¸ÛŒÙ…)</h3>
        <div class="image-manager">
            <div class="upload-grid">
                <div class="upload-card" onclick="startCrop('img1')">
                    <span style="font-size:2rem; margin-bottom:10px;">ğŸ“¸</span>
                    <span>Ø§ÙØ²ÙˆØ¯Ù† ØªØµÙˆÛŒØ± Û±</span>
                    <img id="prev_img1" class="preview-thumb">
                </div>
                <div class="upload-card" onclick="startCrop('img2')">
                    <span style="font-size:2rem; margin-bottom:10px;">ğŸ“¸</span>
                    <span>Ø§ÙØ²ÙˆØ¯Ù† ØªØµÙˆÛŒØ± Û²</span>
                    <img id="prev_img2" class="preview-thumb">
                </div>
            </div>
            <!-- ÙˆØ±ÙˆØ¯ÛŒ ÙØ§ÛŒÙ„ Ù…Ø®ÙÛŒ -->
            <input type="file" id="fileInput" accept="image/*" style="display:none">

            <div class="img-controls">
                <div class="radio-group">
                    <label class="radio-label"><input type="radio" name="layout" value="vertical" checked> Ø¹Ù…ÙˆØ¯ÛŒ (Ø²ÛŒØ± Ù‡Ù…)</label>
                    <label class="radio-label"><input type="radio" name="layout" value="horizontal"> Ø§ÙÙ‚ÛŒ (Ú©Ù†Ø§Ø± Ù‡Ù…)</label>
                </div>
                <div class="slider-wrapper">
                    <span style="font-size:1.2rem;">ğŸ”</span>
                    <input type="range" id="imgScale" min="20" max="100" value="80" oninput="document.getElementById('scaleVal').innerText=this.value+'%'">
                    <span id="scaleVal" style="font-weight:bold; color:var(--accent); min-width: 40px;">80%</span>
                </div>
            </div>
        </div>

        <h3>Û³. Ù¾ÛŒÙˆØ³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</h3>
        <div class="form-group">
            <textarea id="attach" class="form-input" placeholder=" "></textarea>
            <label class="floating-label">Ù…ØªÙ† Ù¾ÛŒÙˆØ³Øª (Ø¯Ø± ØµÙØ­Ù‡ Ø¯ÙˆÙ… Ø¯Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆØ¯)</label>
        </div>

        <h3>Û´. ØªØ§ÛŒÛŒØ¯ Ùˆ Ø§Ù…Ù†ÛŒØª</h3>
        <div class="security-box">
            <span>ØªØ³Øª Ø§Ù…Ù†ÛŒØªÛŒ:</span>
            <span id="mathQ" class="captcha-text">...</span>
            <input type="number" id="mathAns" class="form-input captcha-inp" placeholder="ØŸ" required>
        </div>
        <div class="form-group">
            <input type="password" id="passCode" class="form-input" inputmode="numeric" placeholder=" " required>
            <label class="floating-label">Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ù…Ø¯ÛŒØ±Ø¹Ø§Ù…Ù„</label>
        </div>

        <button type="submit" id="submitBtn" class="btn btn-submit">
            <span class="btn-text">ØªÙˆÙ„ÛŒØ¯ Ù†Ø§Ù…Ù‡ Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø®ÙˆØ¯Ú©Ø§Ø±</span>
            <span class="spinner"></span>
        </button>
    </form>

    <div id="msgBox"></div>

    <div id="finalArea">
        <h3 style="text-align:center; margin-bottom:20px;">Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙØ§ÛŒÙ„ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡</h3>
        <div id="previewWrapper"></div>
        <button id="downloadPdfBtn" class="btn btn-submit" style="background:var(--success); margin-top:20px;">
            <span class="btn-text">Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù…Ø¬Ø¯Ø¯ PDF</span>
            <span class="spinner"></span>
        </button>
    </div>
</div>

<div id="renderCanvas"></div>

<!-- Ù…Ø¯Ø§Ù„ Ø¨Ø±Ø´ ØªØµÙˆÛŒØ± -->
<div id="cropModal" class="crop-modal-overlay">
    <div class="crop-modal-content">
        <h3 style="margin-top:0; border:none;">Ø¨Ø±Ø´ ØªØµÙˆÛŒØ±</h3>
        <div class="crop-area">
            <img id="cropTargetImg" style="max-width:100%;">
        </div>
        <div class="crop-actions">
            <button class="btn-crop-ok" onclick="applyCrop()">ØªØ§ÛŒÛŒØ¯ Ùˆ Ø¨Ø±Ø´</button>
            <button class="btn-crop-cancel" onclick="cancelCrop()">Ø§Ù†ØµØ±Ø§Ù</button>
        </div>
    </div>
</div>

<!-- Ù…Ø¯Ø§Ù„ Ù…ÙˆÙÙ‚ÛŒØª Ù†Ù‡Ø§ÛŒÛŒ -->
<div id="successModal" class="success-modal-wrap">
    <div class="success-box">
        <span class="success-icon">âœ“</span>
        <h2 style="color:var(--success); border:none; margin-bottom:10px;">Ø¹Ù…Ù„ÛŒØ§Øª Ù…ÙˆÙÙ‚!</h2>
        <p>ÙØ§ÛŒÙ„ PDF Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯ Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø¢ØºØ§Ø² Ú¯Ø±Ø¯ÛŒØ¯.</p>
        <div class="action-btns">
            <a id="btnOpen" class="act-btn btn-view" target="_blank">Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙØ§ÛŒÙ„</a>
            <a id="btnShare" class="act-btn btn-share">Ø§Ø´ØªØ±Ø§Ú© Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„</a>
            <a onclick="document.getElementById('successModal').style.display='none'" class="act-btn btn-close">Ø¨Ø³ØªÙ†</a>
        </div>
    </div>
</div>

<!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
    // **********************************************
    // Ø¢Ø¯Ø±Ø³ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ú¯ÙˆÚ¯Ù„ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrJh6FWkNjydhbSUwXgXy9Etobnbs0hTq7LRkVWj9zC-2I2uOXqPyDXn159t5vcZoWlg/exec";
    // **********************************************

    let finalImages = { img1: null, img2: null };
    let captchaSum = 0;
    let finalPdfBlob = null;
    let letterData = {};
    
    // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø¨Ø±Ø´
    let currentCropKey = null;
    let cropper = null;
    const cropModal = document.getElementById('cropModal');
    const cropTarget = document.getElementById('cropTargetImg');
    const fileInput = document.getElementById('fileInput');

    // Ø´Ø±ÙˆØ¹ Ú©Ù¾Ú†Ø§
    function initMath() {
        let n1 = Math.floor(Math.random()*9)+1;
        let n2 = Math.floor(Math.random()*9)+1;
        captchaSum = n1 + n2;
        document.getElementById('mathQ').innerText = `${n1} + ${n2} = ØŸ`;
        document.getElementById('mathAns').value = '';
    }
    initMath();

    // ØªÙˆØ§Ø¨Ø¹ Ø¨Ø±Ø´ ØªØµÙˆÛŒØ±
    function startCrop(key) {
        currentCropKey = key;
        fileInput.value = '';
        fileInput.click();
    }

    fileInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                cropTarget.src = evt.target.result;
                cropModal.style.display = 'flex';
                if(cropper) cropper.destroy();
                cropper = new Cropper(cropTarget, { 
                    viewMode: 1, 
                    autoCropArea: 0.9 
                });
            };
            reader.readAsDataURL(e.target.files[0]);
        }
    });

    function applyCrop() {
        if(!cropper) return;
        const canvas = cropper.getCroppedCanvas();
        const croppedData = canvas.toDataURL('image/jpeg', 0.9); 
        
        finalImages[currentCropKey] = croppedData;
        const preview = document.getElementById('prev_' + currentCropKey);
        preview.src = croppedData;
        preview.style.display = 'block';
        
        cancelCrop();
    }

    function cancelCrop() {
        cropModal.style.display = 'none';
        if(cropper) cropper.destroy();
        fileInput.value = '';
    }

    // Ù…Ø¨Ø¯Ù„ Ø§Ø¹Ø¯Ø§Ø¯
    function toPersian(s) { return String(s).replace(/\d/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d]); }
    function toEnglish(s) { return String(s).replace(/[Û°-Û¹]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d)); }

    // Ø³Ø§Ø®Øª Ø¨Ø±Ú¯Ù‡ A5
    // mode: 'normal' | 'images_only'
    function createSheetHTML(data, type = 'main') {
        const div = document.createElement('div');
        div.className = 'sheet';

        let content = '';
        let header = '';
        let sign = '';

        // Ø³Ø±Ø¨Ø±Ú¯
        header = `
            <div class="letter-head">
                <div class="head-col head-right">
                    <p>ØªÙ„ÙÙ†: Û°Û¹Û±Û³ÛµÛ°Û·Û¶ÛµÛ¸Û·</p>
                    <p>Ø¢Ø¯Ø±Ø³: Ø¬ÛŒØ±ÙØªØŒ Ø® Ø§Ø³ØªÙ‚Ù„Ø§Ù„</p>
                </div>
                <div class="head-col head-center">
                    <p>Ù…Ø¤Ø³Ø³Ù‡ ØªØ¹Ø§Ù„ÛŒ Ø§Ù†Ø¯ÛŒØ´Ù‡ Ùˆ Ø±Ø´Ø¯</p>
                    <p style="font-size:11px; font-weight:normal;">Ø´Ù†Ø§Ø³Ù‡ Ù…Ù„ÛŒ: Û±Û´Û°Û±Û³Û·Û·Û°Û¶Û±Û±</p>
                </div>
                <div class="head-col head-left">
                    <p>Ø´Ù…Ø§Ø±Ù‡: ${toPersian(data.num)}</p>
                    <p>ØªØ§Ø±ÛŒØ®: ${toPersian(data.date)}</p>
                </div>
            </div>`;

        // Ø§Ù…Ø¶Ø§
        sign = `
            <div class="signature-section">
                <p class="sig-text">Ø§Ù…Ø¶Ø§Ø¡</p>
                <p class="sig-text">Ù…Ø¯ÛŒØ±Ø¹Ø§Ù…Ù„ Ù…Ø¤Ø³Ø³Ù‡ ØªØ¹Ø§Ù„ÛŒ Ø§Ù†Ø¯ÛŒØ´Ù‡ Ùˆ Ø±Ø´Ø¯</p>
            </div>`;

        // Ø¨Ø¯Ù†Ù‡ Ø§ØµÙ„ÛŒ
        if(type === 'main') {
            content = `
                <div class="letter-content" id="mainContentArea">
                    <p style="text-align:center; font-weight:bold; margin-bottom:15px;">Ø¨Ø³Ù…Ù‡ ØªØ¹Ø§Ù„ÛŒ</p>
                    <p style="font-weight:bold; margin-bottom:10px;">Ø±ÛŒØ§Ø³Øª Ù…Ø­ØªØ±Ù… ${data.dept}</p>
                    <p style="margin-bottom:15px;">Ù…ÙˆØ¶ÙˆØ¹: ${data.subj}</p>
                    <div class="text-body">${data.txt.replace(/\n/g, '<br>')}</div>
                    
                    <!-- Ù…Ø­Ù„ Ù‚Ø±Ø§Ø±Ú¯ÛŒØ±ÛŒ ØªØµØ§ÙˆÛŒØ± (Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ø¹Ø¯Ø§Ù‹ Ø¨Ø§ Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¬Ø§Ø¨Ø¬Ø§ Ø´ÙˆØ¯) -->
                    <div id="imgPlaceholder"></div>
                </div>`;
        } 
        else if (type === 'attachment') {
            content = `
                <div class="letter-content">
                    <p style="text-align:center; font-weight:bold; margin-bottom:15px;">Ù¾ÛŒÙˆØ³Øª Ù†Ø§Ù…Ù‡</p>
                    <div class="text-body">${data.attach.replace(/\n/g, '<br>')}</div>
                </div>`;
        }
        else if (type === 'images_page') {
             content = `
                <div class="letter-content" style="display:flex; align-items:center; justify-content:center; flex-direction:column; height:100%;">
                    <p style="text-align:center; font-weight:bold; margin-bottom:15px;">ØªØµØ§ÙˆÛŒØ± Ù¾ÛŒÙˆØ³Øª</p>
                    <div id="extraImgContainer" style="width:100%;"></div>
                </div>`;
        }

        div.innerHTML = header + content + sign;
        return div;
    }

    // ØªÙˆÙ„ÛŒØ¯ Ø¨Ù„ÙˆÚ© ØªØµØ§ÙˆÛŒØ±
    function getImagesHTML() {
        if(!finalImages.img1 && !finalImages.img2) return null;
        
        const layout = document.querySelector('input[name="layout"]:checked').value;
        const size = document.getElementById('imgScale').value;
        const wVal = layout === 'vertical' ? `${size}%` : `${Math.min(size, 48)}%`;
        
        let imgs = '';
        if(finalImages.img1) imgs += `<img src="${finalImages.img1}" class="letter-img" style="width:${wVal}">`;
        if(finalImages.img2) imgs += `<img src="${finalImages.img2}" class="letter-img" style="width:${wVal}">`;
        
        const div = document.createElement('div');
        div.className = `images-container ${layout}`;
        div.innerHTML = imgs;
        return div;
    }

    // Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù…
    document.getElementById('appForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const msg = document.getElementById('msgBox');
        const btn = document.getElementById('submitBtn');
        
        if(parseInt(toEnglish(document.getElementById('mathAns').value)) !== captchaSum) {
            msg.textContent = "Ù¾Ø§Ø³Ø® Ø³ÙˆØ§Ù„ Ø§Ù…Ù†ÛŒØªÛŒ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.";
            msg.className = 'error-msg'; msg.style.display = 'block';
            initMath(); return;
        }

        msg.style.display = 'none';
        btn.disabled = true; 
        btn.classList.add('loading');

        const now = new Date();
        const jDate = now.toLocaleDateString('fa-IR');
        const lNum = `${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}4`;
        
        let imgState = "Ø¨Ø¯ÙˆÙ† ØªØµÙˆÛŒØ±";
        if(finalImages.img1 && finalImages.img2) imgState = "Ø¯Ùˆ ØªØµÙˆÛŒØ±";
        else if(finalImages.img1 || finalImages.img2) imgState = "ÛŒÚ© ØªØµÙˆÛŒØ±";

        const formData = {
            dept: document.getElementById('dept').value,
            subj: document.getElementById('subj').value,
            txt: document.getElementById('txt').value,
            attach: document.getElementById('attach').value,
            verificationCode: toEnglish(document.getElementById('passCode').value),
            issueDate: toEnglish(jDate),
            letterNumber: lNum,
            imageStatus: imgState
        };

        try {
            const req = await fetch(GOOGLE_SCRIPT_URL, { 
                method: 'POST', 
                body: JSON.stringify({
                    department: formData.dept,
                    subject: formData.subj,
                    letterText: formData.txt,
                    attachmentText: formData.attach,
                    verificationCode: formData.verificationCode,
                    issueDate: formData.issueDate,
                    letterNumber: formData.letterNumber,
                    imageStatus: formData.imageStatus
                }) 
            });
            const res = await req.json();

            if(res.status === 'success') {
                msg.textContent = "Ø«Ø¨Øª Ù…ÙˆÙÙ‚! Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ùˆ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ...";
                msg.className = 'success-msg'; msg.style.display = 'block';
                
                letterData = { ...formData, num: lNum, date: jDate };
                
                // ----------------------------------------------------
                // Ù…Ù†Ø·Ù‚ Ù‡ÙˆØ´Ù…Ù†Ø¯ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ (Overflow Logic)
                // ----------------------------------------------------
                const wrapper = document.getElementById('previewWrapper');
                const canvasArea = document.getElementById('renderCanvas');
                wrapper.innerHTML = ''; canvasArea.innerHTML = '';

                // 1. Ø³Ø§Ø®Øª ØµÙØ­Ù‡ Ø§ÙˆÙ„
                const page1 = createSheetHTML(letterData, 'main');
                canvasArea.appendChild(page1); // Ù…ÙˆÙ‚ØªØ§Ù‹ Ø¨Ù‡ DOM Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒÚ©Ù†ÛŒÙ… ØªØ§ Ø§Ø±ØªÙØ§Ø¹ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´ÙˆØ¯
                
                // Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ú©Ø³ Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ÙˆÙ„ Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø¬Ø§ Ø´Ø¯Ù†
                const imgBlock = getImagesHTML();
                if(imgBlock) {
                    page1.querySelector('#imgPlaceholder').appendChild(imgBlock);
                }

                // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø±ØªÙØ§Ø¹ Ù…Ø­ØªÙˆØ§ (ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ 180mm Ø§Ø±ØªÙØ§Ø¹ Ù…ÙÛŒØ¯ A5 Ø§Ø³Øª = Ø­Ø¯ÙˆØ¯ 680 Ù¾ÛŒÚ©Ø³Ù„ Ø¯Ø± ØµÙØ­Ù‡ ÙˆØ¨)
                // Ø§Ø±ØªÙØ§Ø¹ Ú©Ù„ ØµÙØ­Ù‡ 210mm Ø§Ø³Øª. Ù‡Ø¯Ø± Ùˆ Ø§Ù…Ø¶Ø§ Ø­Ø¯ÙˆØ¯ 60mm Ù…ÛŒÚ¯ÛŒØ±Ù†Ø¯. ÙØ¶Ø§ÛŒ Ù…ØªÙ† Ùˆ Ø¹Ú©Ø³ 150mm Ø§Ø³Øª.
                // Ø§Ú¯Ø± Ø§Ø³Ú©Ø±ÙˆÙ„ Ø®ÙˆØ±Ø¯ØŒ ÛŒØ¹Ù†ÛŒ Ø¬Ø§ Ù†Ù…ÛŒØ´ÙˆØ¯.
                
                let imagesMoved = false;
                const contentDiv = page1.querySelector('.letter-content');
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø±Ø±ÛŒØ² Ø´Ø¯Ù† Ù…Ø­ØªÙˆØ§
                if (page1.scrollHeight > page1.clientHeight + 5) {
                    // Ø§Ú¯Ø± Ø¹Ú©Ø³ Ø¯Ø§Ø±ÛŒÙ… Ùˆ ØµÙØ­Ù‡ Ø³Ø±Ø±ÛŒØ² Ú©Ø±Ø¯Ù‡ØŒ Ø¹Ú©Ø³ Ø±Ø§ Ø¨Ø±Ø¯Ø§Ø±
                    if(imgBlock) {
                        imgBlock.remove(); // Ø­Ø°Ù Ø§Ø² ØµÙØ­Ù‡ Ø§ÙˆÙ„
                        imagesMoved = true;
                    }
                }

                // Ø§Ù†ØªÙ‚Ø§Ù„ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ù‡ Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø±Ù†Ø¯Ø±
                // (Ú†ÙˆÙ† append child Ú©Ø±Ø¯ÛŒÙ… Ø§Ù„Ù…Ù†Øª Ø¬Ø§Ø¨Ø¬Ø§ Ù…ÛŒØ´ÙˆØ¯ØŒ Ù¾Ø³ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒÚ©Ù†ÛŒÙ…)
                wrapper.appendChild(page1.cloneNode(true));
                canvasArea.innerHTML = ''; // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ø±Ù†Ø¯Ø± ØªÙ…ÛŒØ²
                canvasArea.appendChild(page1); // Ù†Ø³Ø®Ù‡ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¹Ú©Ø³ Ú¯Ø±ÙØªÙ†

                // 2. Ø§Ú¯Ø± Ø¹Ú©Ø³â€ŒÙ‡Ø§ Ø¬Ø§ Ù†Ø´Ø¯Ù†Ø¯ØŒ ØµÙØ­Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ø³Ø§Ø²
                if(imagesMoved && imgBlock) {
                    const pageImg = createSheetHTML(letterData, 'images_page');
                    pageImg.querySelector('#extraImgContainer').appendChild(imgBlock.cloneNode(true));
                    
                    wrapper.appendChild(pageImg.cloneNode(true));
                    canvasArea.appendChild(pageImg);
                }

                // 3. Ø§Ú¯Ø± Ù¾ÛŒÙˆØ³Øª Ù…ØªÙ†ÛŒ Ø¯Ø§Ø´ØªÛŒÙ…
                if(formData.attach.trim()) {
                    const pageAttach = createSheetHTML(letterData, 'attachment');
                    wrapper.appendChild(pageAttach.cloneNode(true));
                    canvasArea.appendChild(pageAttach);
                }

                document.getElementById('appForm').style.display = 'none';
                document.getElementById('finalArea').style.display = 'block';
                
                setTimeout(downloadPDF, 500); 

            } else {
                throw new Error(res.message);
            }
        } catch(err) {
            msg.textContent = err.message || "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±";
            msg.className = 'error-msg'; msg.style.display = 'block';
            btn.disabled = false; btn.classList.remove('loading');
        }
    });

    // ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ ØªÙˆÙ„ÛŒØ¯ PDF (Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡ Ú©Ø§Ù…Ù„)
    async function downloadPDF() {
        const dBtn = document.getElementById('downloadPdfBtn');
        dBtn.disabled = true; dBtn.classList.add('loading');

        const { jsPDF } = window.jspdf;
        const sheets = document.querySelectorAll('#renderCanvas .sheet');
        const pdf = new jsPDF({ format: 'a5', unit: 'mm', compress: true });

        // Ø§ÙØ²ÙˆØ¯Ù† Ú©Ù„Ø§Ø³ Ø­Ø§Ù„Øª Ù¾Ø±ÛŒÙ†Øª Ø¨Ù‡ Ú©Ù„ Ø¨Ø¯Ù†Ù‡ (Ø¨Ø³ÛŒØ§Ø± Ø³Ø±ÛŒØ¹ØªØ± Ø§Ø² onclone)
        // Ø§ÛŒÙ† Ú©Ù„Ø§Ø³ Ø¨Ø§Ø¹Ø« Ù…ÛŒØ´ÙˆØ¯ Ù…ØªÙ† Ø±Ø§Ø³Øª Ú†ÛŒÙ† Ø´ÙˆØ¯ Ùˆ Ø­Ø±ÙˆÙ ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡Ù… Ù†Ø±ÛŒØ²Ø¯
        document.body.classList.add('print-mode');

        for(let i=0; i<sheets.length; i++) {
            if(i>0) pdf.addPage();
            
            const sheet = sheets[i];
            
            // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡ html2canvas
            await html2canvas(sheet, {
                scale: 2, // Ú©ÛŒÙÛŒØª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ (Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù‡Ù†Ú¯ Ú©Ø±Ø¯Ù†)
                useCORS: true,
                allowTaint: true,
                logging: false, // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯ Ø¨Ø±Ø§ÛŒ Ø³Ø±Ø¹Øª
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/jpeg', 0.9);
                pdf.addImage(imgData, 'JPEG', 0, 0, 148, 210);
            });
        }

        // Ø­Ø°Ù Ø­Ø§Ù„Øª Ù¾Ø±ÛŒÙ†Øª
        document.body.classList.remove('print-mode');

        finalPdfBlob = pdf.output('blob');
        const fName = `${letterData.subj}.pdf`;
        pdf.save(fName); 
        
        dBtn.disabled = false; dBtn.classList.remove('loading');
        
        const modal = document.getElementById('successModal');
        modal.style.display = 'flex';
        
        document.getElementById('btnOpen').href = URL.createObjectURL(finalPdfBlob);
        
        document.getElementById('btnShare').onclick = async () => {
            if(navigator.canShare) {
                const f = new File([finalPdfBlob], fName, {type:'application/pdf'});
                try {
                    await navigator.share({files:[f], title: letterData.subj, text: 'Ù†Ø§Ù…Ù‡ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡'});
                } catch(e) { console.log(e); }
            } else {
                alert('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.');
            }
        };
    }
    
    document.getElementById('downloadPdfBtn').onclick = downloadPDF;

</script>
</body>
</html>
