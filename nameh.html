<!DOCTYPE html>  
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ø¬Ø§Ù…Ø¹ Ù…Ú©Ø§ØªØ¨Ø§Øª</title>

<!-- ÙÙˆÙ†Øªâ€ŒÙ‡Ø§ -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
<!-- Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø´ ØªØµÙˆÛŒØ± -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">

<style>
    /* ØªØºÛŒÛŒØ±Ø§Øª Ø¸Ø§Ù‡Ø± Ø±Ø³Ù…ÛŒ Ùˆ Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ (Ø¯Ø³ØªÙˆØ± Û±) */
    :root {
        --primary: #1A2530;    /* Ø³Ø±Ù…Ù‡â€ŒØ§ÛŒ Ø¨Ø³ÛŒØ§Ø± ØªÛŒØ±Ù‡ Ùˆ Ø±Ø³Ù…ÛŒ */
        --secondary: #2C3E50;  /* Ø³Ø±Ù…Ù‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†â€ŒØªØ± Ø¨Ø±Ø§ÛŒ Ù‡Ø§ÙˆØ± Ùˆ Ù…Ú©Ù…Ù„ */
        --accent: #B89766;     /* Ø·Ù„Ø§ÛŒÛŒ/Ø¨Ø±Ù†Ø²ÛŒ Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ Ùˆ Ø´Ú©ÛŒÙ„ */
        --success: #1E6B3B;    /* Ø³Ø¨Ø² ØªÛŒØ±Ù‡ Ùˆ Ù¾Ø®ØªÙ‡ */
        --danger: #A93226;     /* Ù‚Ø±Ù…Ø² Ø±Ø³Ù…ÛŒ */
        --bg: #EAECEE;         /* Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ø¨Ø³ÛŒØ§Ø± Ù…Ù„Ø§ÛŒÙ… Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ */
        --card: #FFFFFF;       /* Ø³ÙÛŒØ¯ Ø®Ø§Ù„Øµ Ø¨Ø±Ø§ÛŒ ÙØ±Ù… */
        --border: #CFD8DC;     /* Ø­Ø§Ø´ÛŒÙ‡ Ù…Ù„Ø§ÛŒÙ… */
        --text-main: #212F3D;  /* Ø±Ù†Ú¯ Ù…ØªÙ† Ø§ØµÙ„ÛŒ */
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
        font-family: 'Vazirmatn', sans-serif;
        background: var(--bg);
        color: var(--text-main);
        direction: rtl;
        padding: 40px 20px;
        display: flex;
        justify-content: center;
        min-height: 100vh;
    }

    /* Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø±Ø³Ù…ÛŒ Ùˆ Ù…Ø¯Ø±Ù† */
    .container {
        width: 100%;
        max-width: 1000px;
        background: var(--card);
        border-radius: 8px; /* Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ ØªÛŒØ²ØªØ± Ø¨Ø±Ø§ÛŒ Ø¸Ø§Ù‡Ø± Ø±Ø³Ù…ÛŒ */
        box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        border-top: 5px solid var(--accent); /* Ù†ÙˆØ§Ø± Ø·Ù„Ø§ÛŒÛŒ Ø¨Ø§Ù„Ø§ÛŒ ÙØ±Ù… */
        padding: 50px;
        margin-bottom: 60px;
        animation: fadeIn 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

    h2 { 
        text-align: center; 
        border-bottom: 1px solid var(--border); 
        padding-bottom: 20px; 
        margin-bottom: 35px; 
        color: var(--primary); 
        font-size: 2rem; 
        font-weight: 700;
        letter-spacing: -0.5px;
    }
    h3 { 
        font-size: 1.15rem; 
        color: var(--primary); 
        margin: 40px 0 20px 0; 
        border-right: 4px solid var(--accent); 
        padding-right: 12px; 
        display: flex; 
        align-items: center; 
        background: #F8F9F9;
        padding: 10px 12px;
        border-radius: 4px 0 0 4px;
    }

    /* ÙØ±Ù…â€ŒÙ‡Ø§ - Ø§Ø³ØªØ§ÛŒÙ„ Ù…Ø¯Ø±Ù† Ùˆ Ø´Ø±Ú©ØªÛŒ */
    .form-row { display: flex; gap: 25px; flex-wrap: wrap; }
    .form-group { flex: 1; min-width: 250px; margin-bottom: 30px; position: relative; }
    
    .form-input {
        width: 100%; padding: 16px 18px;
        border: 1px solid var(--border); border-radius: 6px;
        font-family: 'Vazirmatn', sans-serif; font-size: 1rem;
        background: #FDFEFE; transition: all 0.3s ease;
        color: var(--text-main);
    }
    .form-input:focus { 
        border-color: var(--accent); 
        outline: none; 
        box-shadow: 0 0 0 3px rgba(184, 151, 102, 0.15); 
        background: #FFFFFF;
    }
    textarea.form-input { min-height: 140px; resize: vertical; line-height: 1.9; }
    
    textarea.img-caption-input {
        min-height: 45px; height: 45px; resize: none; overflow-y: hidden; 
        line-height: 1.5; margin-top: 15px; display: none;
        background: #F2F4F4; border-color: #E5E7E9;
    }
    textarea.img-caption-input:focus { background: #FFFFFF; }

    .floating-label {
        position: absolute; top: -11px; right: 15px;
        background: var(--card); padding: 0 8px;
        font-size: 0.85rem; color: var(--secondary); font-weight: 500;
        pointer-events: none;
        transition: 0.3s;
    }
    .form-input:focus + .floating-label { color: var(--accent); font-weight: 700; }

    /* Ù¾Ù†Ù„ ØªØµØ§ÙˆÛŒØ± Ùˆ Ø¨Ø±Ø´ */
    .image-manager {
        border: 1px solid var(--border); border-radius: 6px;
        padding: 30px; background: #FAFAFA;
    }
    .upload-grid { display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; }
    .upload-card {
        flex: 1; min-width: 160px;
        background: #FFFFFF; border: 1px dashed #BFC9CA; border-radius: 6px;
        padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s ease;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .upload-card:hover { border-color: var(--accent); background: #FDFBF7; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .preview-thumb { max-width: 100%; height: 110px; object-fit: contain; margin-top: 15px; display: none; border-radius: 4px; border: 1px solid #EEEEEE; padding: 2px; }

    .img-controls {
        display: flex; gap: 20px; align-items: center; flex-wrap: wrap;
        border-top: 1px solid var(--border); padding-top: 25px;
    }
    .radio-group { 
        display: flex; gap: 20px; background: #FFFFFF; padding: 15px 25px; 
        border-radius: 6px; border: 1px solid var(--border); width: 100%; justify-content: center; 
    }
    .radio-label { cursor: pointer; font-size: 0.95rem; display: flex; align-items: center; gap: 10px; font-weight: 500; color: var(--secondary); }
    input[type="radio"] { accent-color: var(--accent); transform: scale(1.2); }

    /* Ù…Ø¯Ø§Ù„ Ø¨Ø±Ø´ */
    .crop-modal-overlay {
        position: fixed; inset: 0; background: rgba(26, 37, 48, 0.9); z-index: 2000;
        display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px);
    }
    .crop-modal-content {
        background: #fff; padding: 25px; width: 95%; max-width: 650px;
        border-radius: 8px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    .crop-area { height: 450px; background: #222; overflow: hidden; border-radius: 6px; margin-bottom: 25px; }
    .crop-actions { display: flex; gap: 15px; }

    /* Ú©Ù¾Ú†Ø§ */
    .security-box {
        background: #FDFBF7; border: 1px solid #E5D5BA; padding: 20px; border-radius: 6px;
        display: flex; align-items: center; justify-content: space-between; gap: 15px; margin-bottom: 30px;
    }
    .captcha-text { font-weight: 700; font-size: 1.4rem; letter-spacing: 2px; color: var(--accent); }
    .captcha-inp { width: 120px; text-align: center; font-size: 1.2rem; font-weight: bold; background: #FFFFFF; }

    /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ - Ø·Ø±Ø§Ø­ÛŒ Ø³Ø§Ù„ÛŒØ¯ Ùˆ Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ */
    .btn {
        width: 100%; padding: 18px; border: none; border-radius: 6px;
        font-size: 1.1rem; font-weight: 700; color: #fff; cursor: pointer;
        transition: all 0.3s ease; display: flex; justify-content: center; align-items: center; gap: 10px;
        position: relative; overflow: hidden; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .btn-submit { background: var(--primary); box-shadow: 0 4px 15px rgba(26, 37, 48, 0.2); }
    .btn-submit:hover:not(:disabled) { background: #131B24; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(26, 37, 48, 0.3); }
    
    .btn-add-img { background: #FFFFFF; color: var(--primary); border: 1px solid var(--border); margin-bottom: 25px; }
    .btn-add-img:hover { border-color: var(--accent); color: var(--accent); background: #FDFBF7; }

    .btn-crop-ok { background: var(--success); flex: 2; padding: 14px; border-radius: 6px; color: white; border: none; cursor: pointer; font-size: 1rem; font-weight: bold; }
    .btn-crop-cancel { background: var(--danger); flex: 1; padding: 14px; border-radius: 6px; color: white; border: none; cursor: pointer; font-size: 1rem; font-weight: bold; }
    .btn-crop-ok:hover { background: #18552F; } .btn-crop-cancel:hover { background: #8E2A1F; }

    .btn:disabled { background: #95A5A6; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }

    /* Ù„ÙˆØ¯ÛŒÙ†Ú¯ */
    .spinner {
        width: 22px; height: 22px; border: 3px solid rgba(255,255,255,0.2);
        border-top-color: #fff; border-radius: 50%; animation: spin 0.8s infinite linear;
        display: none;
    }
    .loading .spinner { display: block; }
    .loading .btn-text { display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Ù¾ÛŒØ§Ù… Ø³ÛŒØ³ØªÙ… */
    #msgBox { text-align: center; padding: 18px; margin-top: 30px; border-radius: 6px; display: none; font-weight: bold; animation: fadeIn 0.3s; font-size: 1.05rem; }
    .success-msg { background: #EAFAF1; color: #145A32; border: 1px solid #ABEBC6; border-right: 5px solid var(--success); }
    .error-msg { background: #FDEDEC; color: #78281F; border: 1px solid #F5B7B1; border-right: 5px solid var(--danger); }

    /* Ù…Ø¯Ø§Ù„ Ù…ÙˆÙÙ‚ÛŒØª Ù†Ù‡Ø§ÛŒÛŒ */
    .success-modal-wrap {
        position: fixed; inset: 0; background: rgba(26, 37, 48, 0.85); display: none;
        align-items: center; justify-content: center; z-index: 3000; backdrop-filter: blur(5px);
    }
    .success-box {
        background: #fff; padding: 50px 40px; border-radius: 8px; width: 90%; max-width: 480px;
        text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.5); border-top: 5px solid var(--success);
        animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    
    .success-icon { font-size: 4.5rem; color: var(--success); margin-bottom: 15px; display: block; }
    .action-btns { display: flex; flex-direction: column; gap: 15px; margin-top: 35px; }
    .act-btn { padding: 16px; border-radius: 6px; text-decoration: none; color: white; font-weight: bold; transition: 0.2s; display: block; cursor: pointer; font-size: 1.05rem; }
    .btn-view { background: var(--success); } .btn-view:hover { background: #18552F; }
    .btn-share { background: var(--primary); } .btn-share:hover { background: #131B24; }
    .btn-close { background: #7F8C8D; } .btn-close:hover { background: #626567; }

    /* Ù¾ÛŒØ´ Ù†Ù…Ø§ÛŒØ´ Ùˆ Ø±Ù†Ø¯Ø± */
    #finalArea { display: none; margin-top: 60px; border-top: 2px dashed var(--border); padding-top: 40px; }
    #previewWrapper { background: #2C3E50; padding: 40px; border-radius: 8px; display: flex; flex-direction: column; align-items: center; gap: 35px; overflow-x: auto; box-shadow: inset 0 0 20px rgba(0,0,0,0.4); }
    #renderCanvas { position: fixed; left: -9999px; top: 0; }

    /* --- Ø§Ø³ØªØ§ÛŒÙ„ Ú©Ø§ØºØ° A5 (Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯) --- Ø¹Ø¯Ù… ØªØºÛŒÛŒØ± Ø¯Ø± Ø³Ø§Ø®ØªØ§Ø± Ù¾Ø§ÛŒÙ‡ Ú©Ø§ØºØ° Ø¬Ù‡Øª Ø­ÙØ¸ Ù‚Ø§Ù„Ø¨ */
    .sheet {
        width: 148mm; height: 210mm;
        background: #fff; padding: 15mm 12mm;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        position: relative; box-sizing: border-box;
        display: flex; flex-direction: column; overflow: hidden; flex-shrink: 0;
        direction: rtl;
    }
    .sheet * { 
        font-family: 'Amiri', serif; 
        color: #000; 
        line-height: 1.8;
        font-variant-ligatures: common-ligatures;
        text-rendering: geometricPrecision; 
    }

    .letter-head { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px; flex-shrink: 0; }
    .head-col { flex: 1; display: flex; flex-direction: column; justify-content: flex-start; }
    .head-right { align-items: flex-start; text-align: right; font-size: 11px; }
    .head-center { align-items: center; text-align: center; flex: 1.5; font-weight: bold; font-size: 17px; }
    .head-left { align-items: flex-end; text-align: left; font-size: 11px; }

    .letter-content { flex-grow: 1; display: flex; flex-direction: column; font-size: 14px; overflow: hidden; }
    
    .text-body {
        text-align: justify;
        text-justify: inter-word;
        text-align-last: right; 
        white-space: pre-wrap;
        margin-bottom: 20px;
    }

    .images-container {
        display: flex; margin: 10px 0; width: 100%; flex-wrap: wrap; justify-content: center;
    }
    .images-container.vertical { flex-direction: column; align-items: center; gap: 25px; }
    .images-container.horizontal { flex-direction: row; justify-content: space-between; align-items: flex-start; gap: 0; }

    .letter-img {
        display: block; border-radius: 4px; object-fit: contain; max-height: 80mm; height: auto !important;
    }

    .signature-section { margin-top: auto; text-align: center; padding-top: 30px; flex-shrink: 0; }
    .sig-text { font-weight: bold; font-size: 13px; margin-bottom: 5px; }

</style>
</head>
<body>

<div class="container">
    <h2>Ø³Ø§Ù…Ø§Ù†Ù‡ ØµØ¯ÙˆØ± Ù…Ú©Ø§ØªØ¨Ø§Øª</h2>
    
<form id="appForm">
    <h3>Û±. Ù…Ø´Ø®ØµØ§Øª Ù†Ø§Ù…Ù‡</h3>
    <div class="form-row">
        <div class="form-group">
            <input type="text" id="dept" class="form-input" required placeholder=" ">
            <label class="floating-label">Ú¯ÛŒØ±Ù†Ø¯Ù‡ (Ø§Ø¯Ø§Ø±Ù‡/Ø´Ø®Øµ)</label>
        </div>
        <div class="form-group">
            <input type="text" id="subj" class="form-input" required placeholder=" ">
            <label class="floating-label">Ù…ÙˆØ¶ÙˆØ¹ Ù†Ø§Ù…Ù‡</label>
        </div>
    </div>
    <div class="form-group">
        <textarea id="txt" class="form-input" required placeholder=" "></textarea>
        <label class="floating-label">Ù…ØªÙ† Ø§ØµÙ„ÛŒ Ù†Ø§Ù…Ù‡</label>
    </div>

    <h3>Û². Ù…ØªÙ† Ù¾ÛŒÙˆØ³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</h3>
    <div class="form-group">
        <textarea id="attach" class="form-input" placeholder=" "></textarea>
        <label class="floating-label">Ù…ØªÙ† Ù¾ÛŒÙˆØ³Øª (Ø¯Ø± ØµÙØ­Ù‡ Ø¯ÙˆÙ… Ø¯Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆØ¯)</label>
    </div>

    <h3>Û³. Ù¾ÛŒÙˆØ³Øª ØªØµØ§ÙˆÛŒØ±</h3>
    <div class="image-manager">
        <div class="upload-grid" id="uploadGrid">
            <div class="upload-card" onclick="startCrop('img1')">
                <span style="font-size:2rem; margin-bottom:10px;">ğŸ“¸</span>
                <span style="font-weight:bold; color:var(--primary);">Ø§ÙØ²ÙˆØ¯Ù† ØªØµÙˆÛŒØ± Û±</span>
                <img id="prev_img1" class="preview-thumb">
                <textarea id="cap_img1" class="form-input img-caption-input" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª ØªØµÙˆÛŒØ± Û±" onclick="event.stopPropagation()"></textarea>
            </div>
            <div class="upload-card" onclick="startCrop('img2')">
                <span style="font-size:2rem; margin-bottom:10px;">ğŸ“¸</span>
                <span style="font-weight:bold; color:var(--primary);">Ø§ÙØ²ÙˆØ¯Ù† ØªØµÙˆÛŒØ± Û²</span>
                <img id="prev_img2" class="preview-thumb">
                <textarea id="cap_img2" class="form-input img-caption-input" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª ØªØµÙˆÛŒØ± Û²" onclick="event.stopPropagation()"></textarea>
            </div>
        </div>
        <button type="button" class="btn btn-add-img" onclick="addNewImageBox()">â• Ø§ÙØ²ÙˆØ¯Ù† Ø¬Ø§ÛŒÚ¯Ø§Ù‡ ØªØµÙˆÛŒØ± Ø¬Ø¯ÛŒØ¯</button>

        <input type="file" id="fileInput" accept="image/*" style="display:none">

        <div class="img-controls">
            <div class="radio-group">
                <label class="radio-label"><input type="radio" name="layout" value="vertical" checked> Ú†ÛŒØ¯Ù…Ø§Ù† Ø¹Ù…ÙˆØ¯ÛŒ (Ø²ÛŒØ± Ù‡Ù… - Ø¨Ø²Ø±Ú¯)</label>
                <label class="radio-label"><input type="radio" name="layout" value="horizontal"> Ú†ÛŒØ¯Ù…Ø§Ù† Ø§ÙÙ‚ÛŒ (Ú©Ù†Ø§Ø± Ù‡Ù… - Ù…ØªÙˆØ³Ø·)</label>
            </div>
        </div>
    </div>

    <h3>Û´. ØªØ§ÛŒÛŒØ¯ Ùˆ Ø§Ù…Ù†ÛŒØª</h3>
    <div class="security-box">
        <div style="display:flex; align-items:center; gap:15px;">
            <span style="font-weight:500;">ØªØ³Øª Ø§Ù…Ù†ÛŒØªÛŒ:</span>
            <span id="mathQ" class="captcha-text">...</span>
        </div>
        <input type="number" id="mathAns" class="form-input captcha-inp" placeholder="ØŸ" required>
    </div>
    <div class="form-group" style="margin-bottom: 40px;">
        <input type="password" id="passCode" class="form-input" inputmode="numeric" placeholder=" " required>
        <label class="floating-label">Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ù…Ø¯ÛŒØ±Ø¹Ø§Ù…Ù„</label>
    </div>

    <button type="submit" id="submitBtn" class="btn btn-submit">
        <span class="btn-text">ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒØŒ Ø«Ø¨Øª Ø¯Ø± Ø³Ø§Ù…Ø§Ù†Ù‡ Ùˆ Ø¯Ø±ÛŒØ§ÙØª PDF</span>
        <span class="spinner"></span>
    </button>
</form>

<div id="msgBox"></div>

<div id="finalArea">
    <h3 style="text-align:center; margin-bottom:20px; background:none; padding:0; border:none; color:var(--card);">Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø³Ù†Ø¯ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡</h3>
    <div id="previewWrapper"></div>
    <button id="downloadPdfBtn" class="btn btn-submit" style="background:var(--accent); margin-top:30px; border:none;">
        <span class="btn-text">Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù…Ø¬Ø¯Ø¯ ÙØ§ÛŒÙ„ PDF</span>
        <span class="spinner"></span>
    </button>
</div>
</div>

<div id="renderCanvas"></div>

<!-- Ù…Ø¯Ø§Ù„ Ø¨Ø±Ø´ ØªØµÙˆÛŒØ± -->

<div id="cropModal" class="crop-modal-overlay">
    <div class="crop-modal-content">
        <h3 style="margin-top:0; border:none; background:none; padding:0;">ØªÙ†Ø¸ÛŒÙ… Ùˆ Ø¨Ø±Ø´ ØªØµÙˆÛŒØ±</h3>
        <div class="crop-area">
            <img id="cropTargetImg" style="max-width:100%;">
        </div>
        <div class="crop-actions">
            <button class="btn-crop-ok" onclick="applyCrop()">ØªØ§ÛŒÛŒØ¯ Ùˆ Ø§Ø¹Ù…Ø§Ù„ Ø¨Ø±Ø´</button>
            <button class="btn-crop-cancel" onclick="cancelCrop()">Ø§Ù†ØµØ±Ø§Ù</button>
        </div>
    </div>
</div>

<!-- Ù…Ø¯Ø§Ù„ Ù…ÙˆÙÙ‚ÛŒØª Ù†Ù‡Ø§ÛŒÛŒ -->

<div id="successModal" class="success-modal-wrap">
    <div class="success-box">
        <span class="success-icon">âœ“</span>
        <h2 style="color:var(--success); border:none; margin-bottom:10px; padding:0;">Ø¹Ù…Ù„ÛŒØ§Øª Ù…ÙˆÙÙ‚!</h2>
        <p style="color:var(--secondary); font-size:1.1rem;">Ø³Ù†Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ø³Ø§Ù…Ø§Ù†Ù‡ Ø«Ø¨Øª Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¢ØºØ§Ø² Ú¯Ø±Ø¯ÛŒØ¯.</p>
        <div class="action-btns">
            <a id="btnOpen" class="act-btn btn-view" target="_blank">Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙØ§ÛŒÙ„ PDF</a>
            <a id="btnShare" class="act-btn btn-share">Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„</a>
            <a onclick="document.getElementById('successModal').style.display='none'" class="act-btn btn-close">Ø¨Ø³ØªÙ† Ù¾Ù†Ø¬Ø±Ù‡</a>
        </div>
    </div>
</div>

<!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
    // **********************************************
    // Ø¢Ø¯Ø±Ø³ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ú¯ÙˆÚ¯Ù„ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbywUkWbfsr2Gckg8HTiYcG58qmqBk69dbSmK0Vs7v-eZUpWNuxxEr7HxmqrGs01A9OG0w/exec";
    // **********************************************

    let finalImages = { img1: null, img2: null };
    let captchaSum = 0;
    let finalPdfBlob = null;
    let letterData = {};
    let extraImgCount = 2; 

    let cropper = null;
    let currentCropKey = null;
    const cropModal = document.getElementById('cropModal');
    const cropTarget = document.getElementById('cropTargetImg');
    const fileInput = document.getElementById('fileInput');

    // Ú©Ù¾Ú†Ø§
    function initMath() {
        let n1 = Math.floor(Math.random()*9)+1;
        let n2 = Math.floor(Math.random()*9)+1;
        captchaSum = n1 + n2;
        document.getElementById('mathQ').innerText = `${n1} + ${n2} = ØŸ`;
        document.getElementById('mathAns').value = '';
    }
    initMath();

    // ØªÙ†Ø¸ÛŒÙ… Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø±ØªÙØ§Ø¹ ØªÙˆØ¶ÛŒØ­Ø§Øª
    function autoResizeTextarea(el) {
        el.style.height = '45px'; 
        let newHeight = el.scrollHeight;
        let maxHeight = 45 * 3; 
        if (newHeight > maxHeight) {
            el.style.height = maxHeight + 'px';
            el.style.overflowY = 'auto'; 
        } else {
            el.style.height = newHeight + 'px';
            el.style.overflowY = 'hidden';
        }
    }
    document.querySelectorAll('.img-caption-input').forEach(el => {
        el.addEventListener('input', function() { autoResizeTextarea(this); });
    });

    // Ø§ÙØ²ÙˆØ¯Ù† Ø¬Ø§ÛŒÚ¯Ø§Ù‡ Ø¹Ú©Ø³
    function addNewImageBox() {
        extraImgCount++;
        const grid = document.getElementById('uploadGrid');
        const card = document.createElement('div');
        card.className = 'upload-card';
        card.onclick = () => startCrop(`img${extraImgCount}`);
        
        card.innerHTML = `
            <span style="font-size:2rem; margin-bottom:10px;">ğŸ“¸</span>
            <span style="font-weight:bold; color:var(--primary);">Ø§ÙØ²ÙˆØ¯Ù† ØªØµÙˆÛŒØ± ${toPersian(extraImgCount)}</span>
            <img id="prev_img${extraImgCount}" class="preview-thumb">
            <textarea id="cap_img${extraImgCount}" class="form-input img-caption-input" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª ØªØµÙˆÛŒØ± ${toPersian(extraImgCount)}" onclick="event.stopPropagation()"></textarea>
        `;
        grid.appendChild(card);
        finalImages[`img${extraImgCount}`] = null;
        const newTextarea = document.getElementById(`cap_img${extraImgCount}`);
        newTextarea.addEventListener('input', function() { autoResizeTextarea(this); });
    }

    // Ø¨Ø±Ø´ Ø¹Ú©Ø³
    function startCrop(key) { currentCropKey = key; fileInput.value = ''; fileInput.click(); }
    fileInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                cropTarget.src = evt.target.result;
                cropModal.style.display = 'flex';
                if(cropper) cropper.destroy();
                cropper = new Cropper(cropTarget, { viewMode: 1, autoCropArea: 0.9 });
            };
            reader.readAsDataURL(e.target.files[0]);
        }
    });
    function applyCrop() {
        if(!cropper) return;
        const canvas = cropper.getCroppedCanvas();
        const croppedData = canvas.toDataURL('image/jpeg', 0.9); 
        finalImages[currentCropKey] = croppedData;
        const preview = document.getElementById('prev_' + currentCropKey);
        preview.src = croppedData; preview.style.display = 'block';
        const cap = document.getElementById('cap_' + currentCropKey);
        if(cap) cap.style.display = 'block';
        cancelCrop();
    }
    function cancelCrop() { cropModal.style.display = 'none'; if(cropper) cropper.destroy(); fileInput.value = ''; }

    // Ø§Ø¨Ø²Ø§Ø± Ù…ØªÙ†
    function toPersian(s) { return String(s).replace(/\d/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d]); }
    function toEnglish(s) { return String(s).replace(/[Û°-Û¹]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d)); }

    // Ø³Ø§Ø®ØªÙ† Ø¨Ø±Ú¯Ù‡ A5
    function createEmptySheet(isPage2, pageNum) {
        const div = document.createElement('div');
        div.className = 'sheet';
        const title = (!isPage2 && pageNum === 1) ? "Ø¨Ø³Ù…Ù‡ ØªØ¹Ø§Ù„ÛŒ" : ""; 
        const sigStyle = 'display:none;'; 

        let rightExtra = ""; let leftExtra = "";
        if (isPage2) {
            rightExtra = `<p>Ù¾ÛŒÙˆØ³Øª Ù†Ø§Ù…Ù‡</p>`; leftExtra = `<p>ØµÙØ­Ù‡: ${toPersian(pageNum)}</p>`;
        } else {
            rightExtra = `<p class="main-pages-info">ØµÙØ­Ø§Øª: Ù†Ø§Ù…Ø´Ø®Øµ</p>`;
            if (pageNum === 1) leftExtra = `<p class="main-attach-info">Ù¾ÛŒÙˆØ³Øª: Ù†Ø§Ù…Ø´Ø®Øµ</p>`;
            else leftExtra = `<p>ØµÙØ­Ù‡: ${toPersian(pageNum)}</p>`;
        }

        div.innerHTML = `
            <div class="letter-head">
                <div class="head-col head-right">
                    <p>ØªÙ„ÙÙ†: Û°Û¹Û±Û³ÛµÛ°Û·Û¶ÛµÛ¸Û·</p><p>Ø¢Ø¯Ø±Ø³: Ø¬ÛŒØ±ÙØªØŒ Ø® Ø§Ø³ØªÙ‚Ù„Ø§Ù„</p>${rightExtra}
                </div>
                <div class="head-col head-center">
                    <p>Ù…Ø¤Ø³Ø³Ù‡ ØªØ¹Ø§Ù„ÛŒ Ø§Ù†Ø¯ÛŒØ´Ù‡ Ùˆ Ø±Ø´Ø¯</p><p style="font-size:11px; font-weight:normal;">Ø´Ù†Ø§Ø³Ù‡ Ù…Ù„ÛŒ: Û±Û´Û°Û±Û³Û·Û·Û°Û¶Û±Û±</p>
                </div>
                <div class="head-col head-left">
                    <p>Ø´Ù…Ø§Ø±Ù‡: ${toPersian(letterData.num || '')}</p><p>ØªØ§Ø±ÛŒØ®: ${toPersian(letterData.date || '')}</p>${leftExtra}
                </div>
            </div>
            <div class="letter-content">
                ${title ? `<p style="text-align:center; font-weight:bold; margin-bottom:15px;">${title}</p>` : ''}
                ${!isPage2 && pageNum === 1 ? `<p style="font-weight:bold; margin-bottom:10px;">Ø±ÛŒØ§Ø³Øª Ù…Ø­ØªØ±Ù… ${letterData.dept}</p>` : ''}
                ${!isPage2 && pageNum === 1 ? `<p style="margin-bottom:15px;">Ù…ÙˆØ¶ÙˆØ¹: ${letterData.subj}</p>` : ''}
                <div class="text-body"></div>
            </div>
            <div class="signature-section" style="${sigStyle}">
                <p class="sig-text">Ø§Ù…Ø¶Ø§Ø¡</p><p class="sig-text">Ù…Ø¯ÛŒØ±Ø¹Ø§Ù…Ù„ Ù…Ø¤Ø³Ø³Ù‡ ØªØ¹Ø§Ù„ÛŒ Ø§Ù†Ø¯ÛŒØ´Ù‡ Ùˆ Ø±Ø´Ø¯</p>
            </div>
        `;
        return div;
    }

    // Ù…ÙˆØªÙˆØ± ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯
    async function renderPaginatedSheets(text, isAttach, imagesArray =[]) {
        let sheets =[];
        let currentSheet = createEmptySheet(isAttach, 1);
        let testContainer = document.getElementById('renderCanvas');
        testContainer.appendChild(currentSheet);
        
        let contentBox = currentSheet.querySelector('.letter-content');
        let textContainer = currentSheet.querySelector('.text-body');

        if (text && text.trim()) {
            let paragraphs = text.split('\n');
            for (let p = 0; p < paragraphs.length; p++) {
                let pText = paragraphs[p];
                if (!pText.trim() && p !== paragraphs.length - 1) {
                     textContainer.appendChild(document.createElement('br'));
                     textContainer.appendChild(document.createElement('br'));
                     continue;
                }
                let words = pText.split(/(\s+)/);
                for (let i = 0; i < words.length; i++) {
                    let token = words[i];
                    let span = document.createElement('span'); span.textContent = token;
                    textContainer.appendChild(span);
                    if (contentBox.scrollHeight > contentBox.clientHeight) {
                        span.remove(); sheets.push(currentSheet); 
                        currentSheet = createEmptySheet(isAttach, sheets.length + 1);
                        testContainer.appendChild(currentSheet);
                        contentBox = currentSheet.querySelector('.letter-content');
                        textContainer = currentSheet.querySelector('.text-body');
                        let newSpan = document.createElement('span'); newSpan.textContent = token;
                        textContainer.appendChild(newSpan);
                    }
                }
                if (p !== paragraphs.length - 1) {
                    textContainer.appendChild(document.createElement('br')); textContainer.appendChild(document.createElement('br'));
                    if (contentBox.scrollHeight > contentBox.clientHeight) {
                        sheets.push(currentSheet);
                        currentSheet = createEmptySheet(isAttach, sheets.length + 1);
                        testContainer.appendChild(currentSheet);
                        contentBox = currentSheet.querySelector('.letter-content');
                        textContainer = currentSheet.querySelector('.text-body');
                    }
                }
            }
        }

        if (isAttach && imagesArray.length > 0) {
            const layoutType = document.querySelector('input[name="layout"]:checked').value;
            let cursors = { right: { sheetIndex: sheets.length, container: null }, left:  { sheetIndex: sheets.length, container: null } };

            function getOrCreateColumnContainer(sheet, side) {
                let cb = sheet.querySelector('.letter-content');
                let rowContainer = cb.querySelector('.img-row-container');
                if (!rowContainer) {
                    rowContainer = document.createElement('div'); rowContainer.className = `images-container ${layoutType}`;
                    rowContainer.style.width = '100%';
                    if(layoutType === 'horizontal') { rowContainer.style.display = 'flex'; rowContainer.style.justifyContent = 'space-between'; }
                    cb.appendChild(rowContainer);
                }
                if (layoutType === 'vertical') return rowContainer;
                else {
                    let col = rowContainer.querySelector(`.col-${side}`);
                    if (!col) {
                        col = document.createElement('div'); col.className = `col-${side}`; col.style.width = '48%'; col.style.display = 'flex'; col.style.flexDirection = 'column';
                        if(side === 'right') rowContainer.insertBefore(col, rowContainer.firstChild); else rowContainer.appendChild(col);
                    }
                    return col;
                }
            }

            cursors.right.container = getOrCreateColumnContainer(currentSheet, 'right');
            cursors.left.container  = getOrCreateColumnContainer(currentSheet, 'left');

            for (let i = 0; i < imagesArray.length; i++) {
                let imgData = imagesArray[i]; let imgIndexLabel = toPersian(i + 1);
                let activeSide = 'right'; let activeCursor = cursors.right;

                if (layoutType === 'horizontal') {
                    if (cursors.left.sheetIndex < cursors.right.sheetIndex) { activeSide = 'left'; activeCursor = cursors.left; }
                    else { activeSide = 'right'; activeCursor = cursors.right; }
                }

                let targetSheet;
                if (activeCursor.sheetIndex === sheets.length) { targetSheet = currentSheet; }
                else {
                    sheets.push(currentSheet);
                    currentSheet = createEmptySheet(isAttach, sheets.length + 1);
                    testContainer.appendChild(currentSheet);
                    cursors.right.sheetIndex = sheets.length; cursors.left.sheetIndex = sheets.length;
                    cursors.right.container = getOrCreateColumnContainer(currentSheet, 'right');
                    cursors.left.container  = getOrCreateColumnContainer(currentSheet, 'left');
                    activeCursor = cursors[activeSide]; targetSheet = currentSheet;
                }

                let targetColumn = activeCursor.container;
                let targetContentBox = targetSheet.querySelector('.letter-content');

                let wrapper = document.createElement('div'); wrapper.style.textAlign = 'center'; wrapper.style.marginBottom = '25px'; wrapper.style.width = '100%';
                let imgEl = document.createElement('img'); imgEl.src = imgData.src;
                await new Promise((resolve) => { imgEl.onload = resolve; imgEl.onerror = resolve; });
                imgEl.className = 'letter-img'; imgEl.style.width = layoutType === 'horizontal' ? '100%' : '80%';
                
                let captionP = document.createElement('p'); captionP.style.fontWeight = 'bold'; captionP.style.marginTop = '10px'; captionP.style.fontSize = '14px'; captionP.style.textAlign = 'justify';
                
                wrapper.appendChild(imgEl); wrapper.appendChild(captionP); targetColumn.appendChild(wrapper);

                if (targetContentBox.scrollHeight > targetContentBox.clientHeight) {
                    wrapper.remove(); sheets.push(currentSheet);
                    currentSheet = createEmptySheet(isAttach, sheets.length + 1); testContainer.appendChild(currentSheet);
                    cursors.right.sheetIndex = sheets.length; cursors.left.sheetIndex = sheets.length;
                    cursors.right.container = getOrCreateColumnContainer(currentSheet, 'right'); cursors.left.container  = getOrCreateColumnContainer(currentSheet, 'left');
                    targetSheet = currentSheet; activeCursor = cursors[activeSide]; targetColumn = activeCursor.container; targetContentBox = targetSheet.querySelector('.letter-content');
                    targetColumn.appendChild(wrapper);
                }

                let capText = `ØªØµÙˆÛŒØ± ${imgIndexLabel}: ${imgData.caption || 'Ø¨Ø¯ÙˆÙ† ØªÙˆØ¶ÛŒØ­'}`;
                let words = capText.split(/(\s+)/); let isContinued = false;

                for (let w = 0; w < words.length; w++) {
                    let span = document.createElement('span'); span.textContent = words[w]; captionP.appendChild(span);
                    if (targetContentBox.scrollHeight > targetContentBox.clientHeight) {
                        span.remove(); isContinued = true; sheets.push(currentSheet);
                        currentSheet = createEmptySheet(isAttach, sheets.length + 1); testContainer.appendChild(currentSheet);
                        cursors.right.sheetIndex = sheets.length; cursors.left.sheetIndex = sheets.length;
                        cursors.right.container = getOrCreateColumnContainer(currentSheet, 'right'); cursors.left.container  = getOrCreateColumnContainer(currentSheet, 'left');
                        targetSheet = currentSheet; activeCursor = cursors[activeSide]; targetColumn = activeCursor.container; targetContentBox = targetSheet.querySelector('.letter-content');
                        
                        captionP = document.createElement('p'); captionP.style.fontWeight = 'bold'; captionP.style.marginTop = '10px'; captionP.style.fontSize = '14px'; captionP.style.textAlign = 'justify';
                        let continuationHeader = document.createElement('span'); continuationHeader.textContent = `Ø§Ø¯Ø§Ù…Ù‡ ØªÙˆØ¶ÛŒØ­Ø§Øª ØªØµÙˆÛŒØ± ${imgIndexLabel}: `; continuationHeader.style.color = 'var(--danger)';
                        captionP.appendChild(continuationHeader); targetColumn.appendChild(captionP);
                        let newSpan = document.createElement('span'); newSpan.textContent = words[w]; captionP.appendChild(newSpan);
                    }
                }
            }
        }

        let sig = currentSheet.querySelector('.signature-section'); sig.style.display = 'block';
        await new Promise(r => setTimeout(r, 10));
        if (contentBox.scrollHeight > contentBox.clientHeight) {
            sig.style.display = 'none'; sheets.push(currentSheet);
            currentSheet = createEmptySheet(isAttach, sheets.length + 1); testContainer.appendChild(currentSheet);
            contentBox = currentSheet.querySelector('.letter-content'); currentSheet.querySelector('.signature-section').style.display = 'block';
        }

        sheets.push(currentSheet);
        return sheets;
    }

    // ÙØ±Ø¢ÛŒÙ†Ø¯ Ø«Ø¨ØªØŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ùˆ Ø±Ù†Ø¯Ø±
    document.getElementById('appForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const msg = document.getElementById('msgBox');
        const btn = document.getElementById('submitBtn');
        
        if(parseInt(toEnglish(document.getElementById('mathAns').value)) !== captchaSum) {
            msg.textContent = "Ù¾Ø§Ø³Ø® Ø³ÙˆØ§Ù„ Ø§Ù…Ù†ÛŒØªÛŒ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª."; msg.className = 'error-msg'; msg.style.display = 'block'; initMath(); return;
        }

        msg.style.display = 'none'; btn.disabled = true; btn.classList.add('loading');

        const now = new Date();
        const jDate = now.toLocaleDateString('fa-IR');
        const lNum = `${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}4`;
        
        // Ø¬Ù…Ø¹ Ø¢ÙˆØ±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        let activeImages =[]; let imageDescriptions =[]; let indexCounter = 1;
        for (let key in finalImages) {
            if (finalImages[key]) {
                let capInput = document.getElementById('cap_' + key); let captionText = capInput ? capInput.value : '';
                activeImages.push({ src: finalImages[key], caption: captionText });
                imageDescriptions.push(`[ØªØµÙˆÛŒØ± ${toPersian(indexCounter)}] ØªÙˆØ¶ÛŒØ­: ${captionText || 'Ù†Ø¯Ø§Ø±Ø¯'}`);
                indexCounter++;
            }
        }
        let imgState = imageDescriptions.length > 0 ? imageDescriptions.join(' | ') : "Ø¨Ø¯ÙˆÙ† ØªØµÙˆÛŒØ±";

        letterData = {
            dept: document.getElementById('dept').value, subj: document.getElementById('subj').value,
            txt: document.getElementById('txt').value, attach: document.getElementById('attach').value,
            verificationCode: toEnglish(document.getElementById('passCode').value), issueDate: toEnglish(jDate), num: lNum, date: jDate
        };

        // --- Ø§Ø¬Ø±Ø§ÛŒ Ø±Ù†Ø¯Ø± Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø¨Ú©â€ŒØ§Ù†Ø¯ Ø¬Ù‡Øª Ø¬Ù…Ø¹ Ø¢ÙˆØ±ÛŒ Ø¯Ù‚ÛŒÙ‚ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ù… ØµÙØ­Ø§Øª (Ø¯Ø³ØªÙˆØ± Û²) ---
        const wrapper = document.getElementById('previewWrapper');
        const canvasArea = document.getElementById('renderCanvas');
        wrapper.innerHTML = ''; canvasArea.innerHTML = '';

        const mainSheets = await renderPaginatedSheets(letterData.txt, false,[]);
        let attachSheets =[];
        if(letterData.attach.trim() || activeImages.length > 0) attachSheets = await renderPaginatedSheets(letterData.attach, true, activeImages);

        let attachCount = attachSheets.length;
        let attachText = attachCount > 0 ? `${toPersian(attachCount)} ØµÙØ­Ù‡` : "Ù†Ø¯Ø§Ø±Ø¯";
        let mainCountText = `${toPersian(mainSheets.length)} ØµÙØ­Ù‡`;

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ØªÙ† Ø¯Ù‚ÛŒÙ‚ Ù‡Ø± ØµÙØ­Ù‡ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø´ÛŒØª
        let exactDetailedText = `--- Ù†Ø§Ù…Ù‡ Ø§ØµÙ„ÛŒ (${mainCountText}) ---\n`;
        mainSheets.forEach((sheet, idx) => {
            let attachInfoEl = sheet.querySelector('.main-attach-info'); if (attachInfoEl) attachInfoEl.textContent = `Ù¾ÛŒÙˆØ³Øª: ${attachText}`;
            let pagesInfoEl = sheet.querySelector('.main-pages-info'); if (pagesInfoEl) pagesInfoEl.textContent = `ØµÙØ­Ø§Øª: ${mainCountText}`;
            exactDetailedText += `\n[Ù…ØªÙ† ØµÙØ­Ù‡ ${toPersian(idx + 1)}]:\n${sheet.querySelector('.text-body').innerText.trim()}\n`;
        });

        if(attachCount > 0) {
            exactDetailedText += `\n--- Ù¾ÛŒÙˆØ³Øªâ€ŒÙ‡Ø§ (${attachText}) ---\n`;
            attachSheets.forEach((sheet, idx) => {
                exactDetailedText += `\n[Ù…ØªÙ† ØµÙØ­Ù‡ Ù¾ÛŒÙˆØ³Øª ${toPersian(idx + 1)}]:\n${sheet.querySelector('.text-body').innerText.trim()}\n`;
            });
        }
        if(imageDescriptions.length > 0) {
            exactDetailedText += `\n--- ØªØµØ§ÙˆÛŒØ± Ù¾ÛŒÙˆØ³Øª Ø´Ø¯Ù‡ (${toPersian(activeImages.length)} Ø¹Ø¯Ø¯) ---\n` + imageDescriptions.join('\n');
        }

        // Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù¾Ú©ÛŒØ¬ Ù†Ù‡Ø§ÛŒÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
        const payload = {
            department: letterData.dept,
            subject: letterData.subj,
            verificationCode: letterData.verificationCode,
            issueDate: letterData.issueDate,
            letterNumber: letterData.num,
            imageStatus: imgState,
            mainPageCount: mainSheets.length,
            attachPageCount: attachCount,
            totalImagesCount: activeImages.length,
            detailedText: exactDetailedText // Ù…ØªÙ† Ø®Ø· Ø¨Ù‡ Ø®Ø· Ù‡Ù…Ø±Ø§Ù‡ Ø¨Ø§ Ø´Ù…Ø§Ø±Ù‡ ØµÙØ­Ø§Øª
        };

        try {
            const req = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
            const res = await req.json();

            if(res.status === 'success') {
                msg.textContent = "Ø«Ø¨Øª Ù…ÙˆÙÙ‚! Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± Ø³Ø§Ù…Ø§Ù†Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ùˆ ØªÙˆÙ„ÛŒØ¯ PDF Ø¢ØºØ§Ø² Ø´Ø¯.";
                msg.className = 'success-msg'; msg.style.display = 'block';
                
                mainSheets.forEach(s => wrapper.appendChild(s.cloneNode(true)));
                attachSheets.forEach(s => wrapper.appendChild(s.cloneNode(true)));

                document.getElementById('appForm').style.display = 'none';
                document.getElementById('finalArea').style.display = 'block';
                
                setTimeout(downloadPDF, 1500); 

            } else { throw new Error(res.message); }
        } catch(err) {
            msg.textContent = err.message || "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ø³Ø§Ù…Ø§Ù†Ù‡";
            msg.className = 'error-msg'; msg.style.display = 'block';
            btn.disabled = false; btn.classList.remove('loading');
        }
    });

    // ØªÙˆÙ„ÛŒØ¯ PDF
    async function downloadPDF() {
        const dBtn = document.getElementById('downloadPdfBtn');
        dBtn.disabled = true; dBtn.classList.add('loading');

        const { jsPDF } = window.jspdf;
        const sheets = document.querySelectorAll('#renderCanvas .sheet');
        const pdf = new jsPDF({ format: 'a5', unit: 'mm', compress: true });

        for(let i=0; i<sheets.length; i++) {
            if(i>0) pdf.addPage();
            const sheet = sheets[i];
            
            await html2canvas(sheet, {
                scale: 3, useCORS: true,
                onclone: (doc) => {
                    const texts = doc.querySelectorAll('.text-body, .text-body span, p');
                    texts.forEach(t => {
                        if (t.classList.contains('sig-text') || t.parentElement.classList.contains('signature-section')) {
                             t.style.textAlign = 'center'; t.style.letterSpacing = 'normal';
                        } else {
                             t.style.textAlign = 'right'; t.style.letterSpacing = '0px'; 
                        }
                        t.style.fontVariantLigatures = 'common-ligatures'; t.style.textRendering = 'geometricPrecision'; 
                    });
                }
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                pdf.addImage(imgData, 'JPEG', 0, 0, 148, 210);
            });
        }

        finalPdfBlob = pdf.output('blob');
        const fName = `${letterData.subj}.pdf`;
        pdf.save(fName); 
        
        dBtn.disabled = false; dBtn.classList.remove('loading');
        
        const modal = document.getElementById('successModal');
        modal.style.display = 'flex';
        document.getElementById('btnOpen').href = URL.createObjectURL(finalPdfBlob);
        
        document.getElementById('btnShare').onclick = async () => {
            if(navigator.canShare) {
                const f = new File([finalPdfBlob], fName, {type:'application/pdf'});
                try { await navigator.share({files:[f], title: letterData.subj, text: 'Ø³Ù†Ø¯ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡'}); } catch(e) { console.log(e); }
            } else { alert('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.'); }
        };
    }
    
    document.getElementById('downloadPdfBtn').onclick = downloadPDF;

</script>

</body>
</html>
