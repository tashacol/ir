 
<!DOCTYPE html> 
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ú©Ø§ØªØ¨Ø§Øª Ø§Ø¯Ø§Ø±ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</title>
    
    <!-- Ù„ÙˆØ¯ ÙÙˆÙ†Øªâ€ŒÙ‡Ø§ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-start: #f4f6f9;
            --bg-end: #eef2f3;
            --primary: #2c3e50;
            --primary-hover: #1a252f;
            --accent: #3498db;
            --success: #27ae60;
            --danger: #c0392b;
            --text-main: #2c3e50;
            --text-light: #7f8c8d;
            --card-bg: #ffffff;
            --border: #dcdde1;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Vazirmatn', sans-serif;
            margin: 0;
            padding: 20px;
            direction: rtl;
            background: linear-gradient(135deg, var(--bg-start), var(--bg-end));
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .container {
            width: 100%;
            max-width: 850px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            padding: 40px;
            margin-bottom: 50px;
        }

        /* Ø³Ø±Ø¨Ø±Ú¯ ÙØ±Ù… */
        .form-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #f1f1f1;
            padding-bottom: 20px;
        }
        .form-header h2 { font-size: 1.6rem; color: var(--primary); }
        
        .section-title {
            font-size: 1.1rem;
            color: var(--accent);
            margin: 25px 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section-title::before { content: ''; width: 5px; height: 20px; background: var(--accent); border-radius: 3px; }

        /* ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ */
        .form-group { position: relative; margin-bottom: 20px; }
        
        .form-input {
            width: 100%;
            padding: 12px 15px;
            background: #fdfdfd;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: 'Vazirmatn', sans-serif;
            font-size: 1rem;
            transition: 0.3s;
        }
        .form-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); outline: none; }
        textarea.form-input { min-height: 120px; line-height: 1.7; resize: vertical; }
        
        .floating-label {
            position: absolute; top: 13px; right: 15px;
            color: var(--text-light); pointer-events: none;
            transition: 0.3s; background: transparent;
        }
        .form-input:focus ~ .floating-label, .form-input:not(:placeholder-shown) ~ .floating-label {
            top: -10px; right: 10px; background: #fff; padding: 0 5px;
            font-size: 0.85rem; color: var(--accent);
        }

        /* Ù¾Ù†Ù„ ØªØµØ§ÙˆÛŒØ± */
        .image-panel {
            background: #f8f9fa;
            border: 1px dashed var(--border);
            border-radius: 10px;
            padding: 20px;
        }
        .upload-row { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; }
        .upload-btn {
            flex: 1;
            background: #fff;
            border: 1px solid var(--border);
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            min-width: 150px;
        }
        .upload-btn:hover { border-color: var(--accent); background: #f0f8ff; }
        .file-status { display: block; font-size: 0.8rem; color: var(--success); margin-top: 5px; font-weight: bold; }
        input[type="file"] { display: none; }

        .settings-row {
            display: flex; gap: 20px; align-items: center; flex-wrap: wrap;
            border-top: 1px solid #eee; padding-top: 15px;
        }
        .radio-group { display: flex; gap: 15px; }
        .radio-label { cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; }
        
        .range-group { flex-grow: 1; display: flex; align-items: center; gap: 10px; }
        input[type="range"] { flex-grow: 1; accent-color: var(--accent); }

        /* Ú©Ù¾Ú†Ø§ */
        .captcha-box {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        .captcha-question { font-weight: bold; font-size: 1.1rem; letter-spacing: 2px; }
        .captcha-input { width: 80px; text-align: center; }

        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
        .btn {
            width: 100%; padding: 15px; font-size: 1.1rem; font-weight: bold;
            color: #fff; border: none; border-radius: 8px; cursor: pointer;
            transition: 0.3s; position: relative; overflow: hidden;
        }
        .btn-primary { background: var(--primary); }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-2px); }
        .btn-download { background: var(--success); margin-top: 20px; }
        .btn-download:hover { background: #219150; }
        .btn:disabled { background: #95a5a6; cursor: not-allowed; transform: none; }

        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-right: 10px; display: none; }
        .loading .spinner { display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Ù¾ÛŒØ§Ù… ÙˆØ¶Ø¹ÛŒØª */
        #statusMessage { display: none; padding: 15px; border-radius: 8px; margin-top: 20px; text-align: center; }
        .msg-error { background: #fadbd8; color: #7b241c; }
        .msg-success { background: #d4efdf; color: #186a3b; }

        /* Ù¾ÛŒØ´ Ù†Ù…Ø§ÛŒØ´ Ùˆ Ú†Ø§Ù¾ */
        #resultArea { display: none; margin-top: 40px; border-top: 2px dashed #ccc; padding-top: 30px; }
        #previewBox { background: #525659; padding: 20px; border-radius: 8px; display: flex; flex-direction: column; align-items: center; gap: 20px; overflow-x: auto; }

        /* Ø§Ø³ØªØ§ÛŒÙ„ Ú©Ø§ØºØ° A5 */
        .sheet {
            width: 148mm;
            height: 210mm;
            background: #fff;
            padding: 10mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            position: relative;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            direction: rtl;
        }

        .sheet * { font-family: 'Amiri', serif; color: #000; line-height: 1.6; }

        /* Ù‡Ø¯Ø± Ù†Ø§Ù…Ù‡ */
        .letter-header { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 10px; }
        .h-col { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .h-right { text-align: right; font-size: 10px; }
        .h-center { text-align: center; flex: 1.5; }
        .h-left { text-align: left; font-size: 10px; }
        .h-title { font-size: 15px; font-weight: bold; }

        /* Ø¨Ø¯Ù†Ù‡ Ù†Ø§Ù…Ù‡ */
        .letter-body { flex-grow: 1; display: flex; flex-direction: column; font-size: 13px; }
        .letter-text { 
            text-align: justify; 
            text-justify: inter-word; 
            text-align-last: right; 
            white-space: pre-wrap;
            margin-bottom: 10px;
        }
        
        /* Ú©Ù„Ø§Ø³ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø±ÙØ¹ Ø¨Ø§Ú¯ Ø¬Ø¯Ø§ Ø´Ø¯Ù† Ø­Ø±ÙˆÙ Ù‡Ù†Ú¯Ø§Ù… Ú†Ø§Ù¾ */
        .fix-ligatures { text-align: right !important; text-align-last: right !important; letter-spacing: normal !important; }

        /* Ú†ÛŒØ¯Ù…Ø§Ù† ØªØµØ§ÙˆÛŒØ± */
        .images-wrapper { margin: 10px 0; display: flex; justify-content: center; align-items: center; }
        .images-wrapper.vertical { flex-direction: column; gap: 10px; }
        .images-wrapper.horizontal { flex-direction: row; gap: 10px; }
        .img-item { max-width: 100%; max-height: 50mm; object-fit: contain; border-radius: 4px; }

        /* Ø§Ù…Ø¶Ø§ */
        .signature-box { margin-top: auto; text-align: center; padding-top: 15px; }
        .sig-title { font-weight: bold; font-size: 12px; margin-bottom: 5px; }
        .sig-img { width: 120px; height: auto; display: block; margin: 0 auto; mix-blend-mode: multiply; }

        /* Ù…Ø¯Ø§Ù„ */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 999; backdrop-filter: blur(4px); }
        .modal { background: #fff; padding: 30px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; }
        .modal-btns { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .modal-btn { padding: 12px; border-radius: 8px; text-decoration: none; color: white; display: block; }

        @media (max-width: 600px) {
            .container { padding: 20px; }
            .sheet { transform: scale(0.95); margin: 0 auto; }
            .settings-row { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="form-header">
        <h2>Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ú©Ø§ØªØ¨Ø§Øª Ø§Ù…Ù†</h2>
        <p style="font-size:0.9rem; color:#777;">ØªÙˆÙ„ÛŒØ¯ Ù†Ø§Ù…Ù‡ Ø¨Ø§ Ù…Ù‡Ø± Ùˆ Ø§Ù…Ø¶Ø§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„</p>
    </div>

    <form id="letterForm">
        <!-- Ø¨Ø®Ø´ Û±: Ø§Ø·Ù„Ø§Ø¹Ø§Øª -->
        <h3 class="section-title">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ø§Ù…Ù‡</h3>
        <div class="form-group">
            <input type="text" id="department" class="form-input" placeholder=" " required>
            <label class="floating-label">Ú¯ÛŒØ±Ù†Ø¯Ù‡ (Ø§Ø¯Ø§Ø±Ù‡/Ø´Ø®Øµ)</label>
        </div>
        <div class="form-group">
            <input type="text" id="subject" class="form-input" placeholder=" " required>
            <label class="floating-label">Ù…ÙˆØ¶ÙˆØ¹ Ù†Ø§Ù…Ù‡</label>
        </div>
        <div class="form-group">
            <textarea id="letterText" class="form-input" placeholder=" " required></textarea>
            <label class="floating-label">Ù…ØªÙ† Ø§ØµÙ„ÛŒ Ù†Ø§Ù…Ù‡</label>
        </div>

        <!-- Ø¨Ø®Ø´ Û²: ØªØµØ§ÙˆÛŒØ± Ù¾ÛŒØ´Ø±ÙØªÙ‡ -->
        <h3 class="section-title">ØªØµØ§ÙˆÛŒØ± Ùˆ Ù…Ø³ØªÙ†Ø¯Ø§Øª</h3>
        <div class="image-panel">
            <div class="upload-row">
                <div class="upload-btn" onclick="document.getElementById('img1').click()">
                    Ø§Ù†ØªØ®Ø§Ø¨ ØªØµÙˆÛŒØ± Ø§ÙˆÙ„ ğŸ“·
                    <input type="file" id="img1" accept="image/*" onchange="handleFile(this, 'status1')">
                    <span id="status1" class="file-status"></span>
                </div>
                <div class="upload-btn" onclick="document.getElementById('img2').click()">
                    Ø§Ù†ØªØ®Ø§Ø¨ ØªØµÙˆÛŒØ± Ø¯ÙˆÙ… ğŸ“·
                    <input type="file" id="img2" accept="image/*" onchange="handleFile(this, 'status2')">
                    <span id="status2" class="file-status"></span>
                </div>
            </div>
            
            <div class="settings-row">
                <div class="radio-group">
                    <label class="radio-label"><input type="radio" name="layout" value="vertical" checked> Ø²ÛŒØ± Ù‡Ù… (Ø¹Ù…ÙˆØ¯ÛŒ)</label>
                    <label class="radio-label"><input type="radio" name="layout" value="horizontal"> Ú©Ù†Ø§Ø± Ù‡Ù… (Ø§ÙÙ‚ÛŒ)</label>
                </div>
                <div class="range-group">
                    <label>Ø³Ø§ÛŒØ²:</label>
                    <input type="range" id="imgSize" min="30" max="100" value="80">
                </div>
            </div>
        </div>

        <!-- Ø¨Ø®Ø´ Û³: Ù¾ÛŒÙˆØ³Øª -->
        <h3 class="section-title">Ù¾ÛŒÙˆØ³Øª (ØµÙØ­Ù‡ Ø¯ÙˆÙ…)</h3>
        <div class="form-group">
            <textarea id="attachmentText" class="form-input" placeholder=" "></textarea>
            <label class="floating-label">Ù…ØªÙ† Ù¾ÛŒÙˆØ³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
        </div>

        <!-- Ø¨Ø®Ø´ Û´: Ø§Ù…Ù†ÛŒØª -->
        <h3 class="section-title">Ø§Ù…Ù†ÛŒØª Ùˆ ØªØ§Ø¦ÛŒØ¯</h3>
        <div class="captcha-box">
            <span>ØªØ³Øª Ø§Ù…Ù†ÛŒØªÛŒ:</span>
            <span id="captchaQ" class="captcha-question">2 + 2 = ?</span>
            <input type="text" id="captchaAns" class="form-input captcha-input" placeholder="ØŸ" required>
        </div>

        <div class="form-group">
            <input type="password" id="verificationCode" class="form-input" placeholder=" " inputmode="numeric" required>
            <label class="floating-label">Ú©Ø¯ ØªØ§Ø¦ÛŒØ¯ Ù…Ø¯ÛŒØ±Ø¹Ø§Ù…Ù„</label>
        </div>

        <button type="submit" id="generateBtn" class="btn btn-primary">
            <span class="spinner"></span>
            ØªÙˆÙ„ÛŒØ¯ Ù†Ø§Ù…Ù‡ Ùˆ Ø«Ø¨Øª Ø¯Ø± Ø³ÛŒØ³ØªÙ…
        </button>
    </form>

    <div id="statusMessage"></div>

    <!-- Ù†Ø§Ø­ÛŒÙ‡ Ù¾ÛŒØ´ Ù†Ù…Ø§ÛŒØ´ -->
    <div id="resultArea">
        <h3 style="text-align: center; color:#fff; margin-bottom:15px;">Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù†Ù‡Ø§ÛŒÛŒ</h3>
        <div id="previewBox">
            <!-- ØµÙØ­Ø§Øª Ø§ÛŒÙ†Ø¬Ø§ Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒØ´ÙˆÙ†Ø¯ -->
        </div>
        <button id="downloadBtn" class="btn btn-download">
            <span class="spinner"></span>
            Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ PDF Ù†Ù‡Ø§ÛŒÛŒ
        </button>
    </div>
</div>

<!-- ÙØ¶Ø§ÛŒ Ø±Ù†Ø¯Ø± Ù…Ø®ÙÛŒ -->
<div id="renderArea" style="position:fixed; left:-9999px; top:0;"></div>

<!-- Ù…Ø¯Ø§Ù„ Ù…ÙˆÙÙ‚ÛŒØª -->
<div id="successModal" class="modal-overlay">
    <div class="modal">
        <h3 style="color:var(--success);">Ø¹Ù…Ù„ÛŒØ§Øª Ù…ÙˆÙÙ‚!</h3>
        <p>ÙØ§ÛŒÙ„ PDF Ù†Ø§Ù…Ù‡ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯.</p>
        <div class="modal-btns">
            <a id="viewFile" class="modal-btn" style="background:var(--success);" target="_blank">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ùˆ Ú†Ø§Ù¾</a>
            <a id="shareFile" class="modal-btn" style="background:var(--accent);">Ø§Ø´ØªØ±Ø§Ú© Ú¯Ø°Ø§Ø±ÛŒ</a>
            <a href="#" onclick="document.getElementById('successModal').style.display='none'" class="modal-btn" style="background:#777;">Ø¨Ø³ØªÙ†</a>
        </div>
    </div>
</div>

<!-- Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù‡Ø§ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
    // *************************************************************************
    // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ù‡Ù… Ú©Ø§Ø±Ø¨Ø± (Ù„Ø·ÙØ§ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯)
    
    // Ø¢Ø¯Ø±Ø³ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ú¯ÙˆÚ¯Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrJh6FWkNjydhbSUwXgXy9Etobnbs0hTq7LRkVWj9zC-2I2uOXqPyDXn159t5vcZoWlg/exec";
    
    // Ú©Ø¯ Base64 Ù…Ù‡Ø± Ùˆ Ø§Ù…Ø¶Ø§ Ø±Ø§ Ø¯Ø± Ù…ØªØºÛŒØ± Ø²ÛŒØ± Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯ (Ø¨ÛŒÙ† Ø¯Ùˆ Ú©ÙˆØªÛŒØ´Ù† "")
    const OFFICIAL_SIGNATURE = ""; // <--- Ø§ÛŒÙ†Ø¬Ø§ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯
    
    // *************************************************************************

    let imagesData = { img1: null, img2: null };
    let captchaResult = 0;
    let lastPdfBlob = null;
    let currentInfo = {};

    // ØªÙˆØ§Ø¨Ø¹ Ø§ÙˆÙ„ÛŒÙ‡
    function initCaptcha() {
        const n1 = Math.floor(Math.random() * 9) + 1;
        const n2 = Math.floor(Math.random() * 9) + 1;
        captchaResult = n1 + n2;
        document.getElementById('captchaQ').textContent = `${n1} + ${n2} = ØŸ`;
        document.getElementById('captchaAns').value = '';
    }
    initCaptcha();

    function handleFile(input, statusId) {
        const file = input.files[0];
        const statusSpan = document.getElementById(statusId);
        const key = input.id; // img1 or img2
        
        if (file) {
            statusSpan.textContent = "Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯: " + file.name;
            const reader = new FileReader();
            reader.onload = (e) => { imagesData[key] = e.target.result; };
            reader.readAsDataURL(file);
        } else {
            statusSpan.textContent = "";
            imagesData[key] = null;
        }
    }

    function toPersianDigits(str) { return String(str).replace(/\d/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d]); }
    function toEnglishDigits(str) { return String(str).replace(/[Û°-Û¹]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d)); }

    // Ø³Ø§Ø®Øª HTML ØµÙØ­Ù‡ A5
    function createSheet(data, isAttachment) {
        const div = document.createElement('div');
        div.className = 'sheet';

        // Ù…Ø­ØªÙˆØ§ÛŒ Ù…ØªÙ†
        const bodyContent = isAttachment ? data.attachmentText : data.letterText;
        const headerTitle = isAttachment ? "Ù¾ÛŒÙˆØ³Øª Ù†Ø§Ù…Ù‡" : "Ø¨Ø³Ù…Ù‡ ØªØ¹Ø§Ù„ÛŒ";
        
        // ØªØµØ§ÙˆÛŒØ± (ÙÙ‚Ø· Ø¯Ø± ØµÙØ­Ù‡ Ø§ÙˆÙ„)
        let imagesHtml = '';
        if (!isAttachment && (imagesData.img1 || imagesData.img2)) {
            const layout = document.querySelector('input[name="layout"]:checked').value;
            const size = document.getElementById('imgSize').value;
            const cssWidth = layout === 'vertical' ? `${size}%` : `${Math.min(size, 48)}%`; // Ø¯Ø± Ø­Ø§Ù„Øª Ø§ÙÙ‚ÛŒ Ø­Ø¯Ø§Ú©Ø«Ø± 48 Ø¯Ø±ØµØ¯
            
            let imgs = '';
            if (imagesData.img1) imgs += `<img src="${imagesData.img1}" class="img-item" style="width:${cssWidth}">`;
            if (imagesData.img2) imgs += `<img src="${imagesData.img2}" class="img-item" style="width:${cssWidth}">`;
            
            imagesHtml = `<div class="images-wrapper ${layout}">${imgs}</div>`;
        }

        // Ø§Ù…Ø¶Ø§ (Ø¢ÛŒØ§ Ø¨ÛŒØ³64 Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³ØªØŸ)
        const sigSrc = (OFFICIAL_SIGNATURE && OFFICIAL_SIGNATURE.length > 50) 
            ? `<img src="${OFFICIAL_SIGNATURE}" class="sig-img">` 
            : `<p style="font-size:16px;">(Ù…Ø­Ù„ Ù…Ù‡Ø± Ùˆ Ø§Ù…Ø¶Ø§)</p>`;

        div.innerHTML = `
            <div class="letter-header">
                <div class="h-col h-right">
                    <p>ØªÙ„ÙÙ†: Û°Û¹Û±Û³ÛµÛ°Û·Û¶ÛµÛ¸Û·</p>
                    <p>Ø¢Ø¯Ø±Ø³: Ø¬ÛŒØ±ÙØªØŒ Ø§Ø¨ØªØ¯Ø§ÛŒ Ø® Ø§Ø³ØªÙ‚Ù„Ø§Ù„</p>
                </div>
                <div class="h-col h-center">
                    <p class="h-title">Ù…Ø¤Ø³Ø³Ù‡ ØªØ¹Ø§Ù„ÛŒ Ø§Ù†Ø¯ÛŒØ´Ù‡ Ùˆ Ø±Ø´Ø¯</p>
                    <p>Ø´Ù†Ø§Ø³Ù‡ Ù…Ù„ÛŒ: Û±Û´Û°Û±Û³Û·Û·Û°Û¶Û±Û±</p>
                </div>
                <div class="h-col h-left">
                    <p>Ø´Ù…Ø§Ø±Ù‡: ${toPersianDigits(data.letterNumber)}</p>
                    <p>ØªØ§Ø±ÛŒØ®: ${toPersianDigits(data.issueDate)}</p>
                </div>
            </div>
            
            <div class="letter-body">
                <p style="text-align:center; font-weight:bold; margin-bottom:15px;">${headerTitle}</p>
                ${!isAttachment ? `<p style="font-weight:bold;">Ø±ÛŒØ§Ø³Øª Ù…Ø­ØªØ±Ù… ${data.department}</p>` : ''}
                <p style="margin-bottom:10px;">Ù…ÙˆØ¶ÙˆØ¹: ${data.subject}</p>
                
                <div class="letter-text">${bodyContent.replace(/\n/g, '<br>')}</div>
                ${imagesHtml}
            </div>

            <div class="signature-box">
                <p class="sig-title">Ø§Ù…Ø¶Ø§Ø¡</p>
                <p class="sig-title">Ù…Ø¯ÛŒØ±Ø¹Ø§Ù…Ù„ Ù…Ø¤Ø³Ø³Ù‡ ØªØ¹Ø§Ù„ÛŒ Ø§Ù†Ø¯ÛŒØ´Ù‡ Ùˆ Ø±Ø´Ø¯</p>
                ${sigSrc}
            </div>
        `;
        return div;
    }

    // Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù…
    document.getElementById('letterForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const msgBox = document.getElementById('statusMessage');
        const btn = document.getElementById('generateBtn');
        
        // 1. Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù¾Ú†Ø§
        const userCaptcha = parseInt(toEnglishDigits(document.getElementById('captchaAns').value));
        if (userCaptcha !== captchaResult) {
            msgBox.textContent = "Ù¾Ø§Ø³Ø® Ø³ÙˆØ§Ù„ Ø§Ù…Ù†ÛŒØªÛŒ (Ø±ÛŒØ§Ø¶ÛŒ) Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.";
            msgBox.className = "msg-error";
            msgBox.style.display = 'block';
            initCaptcha();
            return;
        }

        msgBox.style.display = 'none';
        btn.disabled = true;
        btn.classList.add('loading');

        const now = new Date();
        const jalaliDate = now.toLocaleDateString('fa-IR');
        const letterNum = `${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}4`;
        
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙˆØ¶Ø¹ÛŒØª ØªØµÙˆÛŒØ± Ø¨Ø±Ø§ÛŒ Ø´ÛŒØª
        let imgStatus = "Ø¨Ø¯ÙˆÙ† ØªØµÙˆÛŒØ±";
        if (imagesData.img1 && imagesData.img2) imgStatus = "Ø¯Ùˆ ØªØµÙˆÛŒØ± Ø¯Ø§Ø±Ø¯";
        else if (imagesData.img1 || imagesData.img2) imgStatus = "ÛŒÚ© ØªØµÙˆÛŒØ± Ø¯Ø§Ø±Ø¯";

        const formData = {
            department: document.getElementById('department').value,
            subject: document.getElementById('subject').value,
            letterText: document.getElementById('letterText').value,
            attachmentText: document.getElementById('attachmentText').value,
            verificationCode: toEnglishDigits(document.getElementById('verificationCode').value),
            issueDate: toEnglishDigits(jalaliDate),
            letterNumber: letterNum,
            imageStatus: imgStatus
        };

        try {
            const req = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(formData) });
            const res = await req.json();

            if (res.status === 'success') {
                msgBox.textContent = "Ø«Ø¨Øª Ø´Ø¯! Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ PDF...";
                msgBox.className = "msg-success";
                msgBox.style.display = 'block';
                
                currentInfo = {...formData, issueDate: jalaliDate};
                
                // Ø±Ù†Ø¯Ø± ØµÙØ­Ø§Øª
                const previewBox = document.getElementById('previewBox');
                const renderArea = document.getElementById('renderArea');
                previewBox.innerHTML = '';
                renderArea.innerHTML = '';

                const page1 = createSheet(currentInfo, false);
                previewBox.appendChild(page1);
                renderArea.appendChild(page1.cloneNode(true));

                if (formData.attachmentText.trim()) {
                    const page2 = createSheet(currentInfo, true);
                    previewBox.appendChild(page2);
                    renderArea.appendChild(page2.cloneNode(true));
                }

                document.getElementById('letterForm').style.display = 'none';
                document.getElementById('resultArea').style.display = 'block';
                
                // Ø´Ø±ÙˆØ¹ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø®ÙˆØ¯Ú©Ø§Ø±
                setTimeout(downloadPDF, 1000);

            } else {
                throw new Error(res.message);
            }
        } catch (err) {
            msgBox.textContent = err.message || "Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø·";
            msgBox.className = "msg-error";
            msgBox.style.display = 'block';
            btn.disabled = false;
            btn.classList.remove('loading');
        }
    });

    // ØªÙˆÙ„ÛŒØ¯ PDF Ø¨Ø§ Ø±ÙØ¹ Ø¨Ø§Ú¯ Ø­Ø±ÙˆÙ ÙØ§Ø±Ø³ÛŒ
    async function downloadPDF() {
        const dBtn = document.getElementById('downloadBtn');
        dBtn.classList.add('loading');
        dBtn.disabled = true;

        const { jsPDF } = window.jspdf;
        const sheets = document.querySelectorAll('#renderArea .sheet');
        
        const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a5', compress: true });

        for (let i = 0; i < sheets.length; i++) {
            if (i > 0) pdf.addPage();
            
            const sheet = sheets[i];
            
            // ************************************************
            // Ø§ØµÙ„Ø§Ø­ Ø¬Ø¯Ø§ Ø´Ø¯Ù† Ø­Ø±ÙˆÙ: ØªØºÛŒÛŒØ± Ù…ÙˆÙ‚Øª ØªØ±Ø§Ø² Ù…ØªÙ† Ù‚Ø¨Ù„ Ø§Ø² Ø¹Ú©Ø³ Ú¯Ø±ÙØªÙ†
            const textDivs = sheet.querySelectorAll('.letter-text');
            textDivs.forEach(div => div.classList.add('fix-ligatures'));
            // ************************************************

            try {
                const canvas = await html2canvas(sheet, { scale: 2.5, useCORS: true, logging: false });
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                pdf.addImage(imgData, 'JPEG', 0, 0, 148, 210);
            } finally {
                // Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ù…ØªÙ† Ø¨Ù‡ Ø­Ø§Ù„Øª Ø²ÛŒØ¨Ø§
                textDivs.forEach(div => div.classList.remove('fix-ligatures'));
            }
        }

        lastPdfBlob = pdf.output('blob');
        const fileName = `${currentInfo.subject}.pdf`;
        
        dBtn.classList.remove('loading');
        dBtn.disabled = false;
        dBtn.onclick = () => pdf.save(fileName);
        
        document.getElementById('successModal').style.display = 'flex';
    }

    // Ø¯Ú©Ù…Ù‡ Ù‡Ø§ÛŒ Ù…Ø¯Ø§Ù„
    document.getElementById('viewFile').onclick = (e) => {
        e.preventDefault();
        if(lastPdfBlob) window.open(URL.createObjectURL(lastPdfBlob));
    };
    
    document.getElementById('shareFile').onclick = async (e) => {
        e.preventDefault();
        if(lastPdfBlob) {
            const file = new File([lastPdfBlob], `${currentInfo.subject}.pdf`, {type: 'application/pdf'});
            if(navigator.canShare && navigator.canShare({files:[file]})) {
                await navigator.share({files:[file], title: currentInfo.subject, text: 'Ù†Ø§Ù…Ù‡ Ø§Ø¯Ø§Ø±ÛŒ'});
            } else {
                alert('Ù…Ø±ÙˆØ±Ú¯Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒÚ©Ù†Ø¯');
            }
        }
    };
</script>

</body>
</html>
