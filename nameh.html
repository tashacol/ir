  
<!DOCTYPE html> 
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ú©Ø§ØªØ¨Ø§Øª Ø§Ø¯Ø§Ø±ÛŒ - Ù†Ø³Ø®Ù‡ Ù¾ÛŒØ´Ø±ÙØªÙ‡</title>
    <!-- Ø§ÙØ²ÙˆØ¯Ù† ÙÙˆÙ†Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ùˆ Ø²ÛŒØ¨Ø§ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-gradient-start: #f0f4f8;
            --bg-gradient-end: #d9e2ec;
            --primary-color: #0056b3;
            --primary-hover: #004494;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --text-dark: #212529;
            --text-muted: #6c757d;
            --card-bg: #ffffff;
            --card-border: #dee2e6;
            --input-bg: #f8f9fa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Vazirmatn', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            direction: rtl;
            background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            padding: 40px;
            margin-top: 20px;
            margin-bottom: 40px;
        }

        /* Ù‡Ø¯Ø± ÙØ±Ù… */
        h2.form-title { 
            text-align: center; 
            color: var(--text-dark); 
            margin-bottom: 30px; 
            font-size: 1.8rem; 
            border-bottom: 2px solid #eee; 
            padding-bottom: 15px;
            font-weight: 700;
        }

        h3.section-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--primary-color);
            border-right: 4px solid var(--primary-color);
            padding-right: 10px;
        }

        .form-section {
            margin-bottom: 35px;
            background: #fff;
            padding: 10px;
        }

        /* Ø§Ø³ØªØ§ÛŒÙ„ ÙˆØ±ÙˆØ¯ÛŒ Ù‡Ø§ */
        .input-group { position: relative; margin-bottom: 25px; }
        
        .form-input {
            width: 100%;
            padding: 14px 15px;
            background: var(--input-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            color: var(--text-dark);
            font-size: 1rem;
            font-family: 'Vazirmatn', sans-serif;
            outline: none;
            transition: all 0.3s ease;
        }
        
        textarea.form-input { 
            resize: vertical; 
            min-height: 120px; 
            line-height: 1.8;
        }

        .form-label {
            position: absolute; 
            top: 14px; 
            right: 15px; 
            color: var(--text-muted);
            pointer-events: none; 
            transition: all 0.3s ease;
            background: transparent; 
            padding: 0 5px;
        }

        .form-input:focus { 
            border-color: var(--primary-color); 
            background: #fff;
            box-shadow: 0 0 0 4px rgba(0, 86, 179, 0.1); 
        }
        
        .form-input:focus ~ .form-label, 
        .form-input:not(:placeholder-shown) ~ .form-label {
            top: -12px; 
            right: 10px;
            font-size: 0.85rem; 
            color: var(--primary-color); 
            background: var(--card-bg);
            padding: 0 5px;
        }

        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ */
        .file-upload-box {
            border: 2px dashed var(--card-border);
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            background: var(--input-bg);
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 15px;
            position: relative;
        }
        .file-upload-box:hover { border-color: var(--primary-color); background: #f0f7ff; }
        
        input[type="file"] { display: none; }
        
        .upload-icon { font-size: 2rem; color: var(--text-muted); margin-bottom: 10px; display: block; }
        .upload-text { font-size: 0.95rem; color: var(--text-muted); }
        .file-name { display: block; margin-top: 10px; font-weight: bold; color: var(--success-color); }

        .range-control {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .range-control input { flex-grow: 1; }

        /* Ø¯Ú©Ù…Ù‡ Ù‡Ø§ */
        .action-btn {
            width: 100%; 
            padding: 16px; 
            font-size: 1.1rem; 
            font-weight: 700;
            background-color: var(--primary-color); 
            color: #fff; 
            border: none;
            border-radius: 10px; 
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative; 
            overflow: hidden; 
            box-shadow: 0 4px 15px rgba(0, 86, 179, 0.3);
        }
        
        .action-btn:hover:not(:disabled) { 
            background-color: var(--primary-hover); 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 86, 179, 0.4);
        }
        
        .action-btn:disabled { 
            background-color: #6c757d; 
            cursor: not-allowed; 
            opacity: 0.8; 
        }

        .spinner { display: none; margin-left: 10px; }
        .loading .spinner { display: inline-block; animation: spin 1s infinite linear; }
        .loading .btn-text { display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Ù¾ÛŒØ§Ù… ÙˆØ¶Ø¹ÛŒØª */
        #statusMessage {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            display: none;
            font-weight: 500;
        }
        .msg-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .msg-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* Ù†Ø§Ø­ÛŒÙ‡ Ù†Ù…Ø§ÛŒØ´ Ù†Ø§Ù…Ù‡ Ùˆ PDF */
        #resultArea {
            display: none;
            margin-top: 40px;
            border-top: 2px dashed #eee;
            padding-top: 30px;
        }

        #pdfPreview {
            background-color: #525659;
            padding: 30px;
            border-radius: 10px;
            overflow-x: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        /* --- Ø§Ø³ØªØ§ÛŒÙ„ Ø¯Ù‚ÛŒÙ‚ Ú©Ø§ØºØ° A5 --- */
        .sheet {
            width: 148mm;
            height: 210mm;
            background: white;
            padding: 10mm;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-shrink: 0;
        }

        /* ØªØ§ÛŒÙ¾ÙˆÚ¯Ø±Ø§ÙÛŒ Ù†Ø§Ù…Ù‡ */
        .sheet * { font-family: 'Amiri', serif; color: #000; }
        
        .letter-header {
            display: flex;
            justify-content: space-between;
            border-bottom: 2px solid #000;
            padding-bottom: 8px;
            margin-bottom: 15px;
        }

        .header-col { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .header-right { text-align: right; font-size: 11px; line-height: 1.4; }
        .header-center { text-align: center; flex: 1.5; }
        .header-left { text-align: left; font-size: 11px; line-height: 1.4; }

        .header-title { font-size: 16px; font-weight: bold; margin: 0; }
        .header-sub { font-size: 11px; margin-top: 4px; }

        .letter-body {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            font-size: 14px;
            line-height: 1.8; /* ÙØ§ØµÙ„Ù‡ Ø®Ø·ÙˆØ· Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ */
        }

        .recipient { margin-bottom: 15px; font-weight: bold; }
        
        .text-content {
            text-align: justify;
            text-justify: inter-word;
            text-align-last: right;
            white-space: pre-wrap; /* Ø­ÙØ¸ Ø§ÛŒÙ†ØªØ±Ù‡Ø§ */
        }

        .inserted-image {
            display: block;
            margin: 10px auto;
            max-width: 100%;
        }

        .signature {
            margin-top: auto;
            text-align: center;
            padding-top: 20px;
            page-break-inside: avoid;
        }
        .signature-title { font-weight: bold; font-size: 13px; margin-bottom: 5px; }

        /* Ù…Ø¯Ø§Ù„ Ù…ÙˆÙÙ‚ÛŒØª */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .modal-btns { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .modal-btn {
            padding: 12px; border-radius: 8px; text-decoration: none; color: white; font-weight: bold; display: block;
        }
        .btn-view { background-color: var(--success-color); }
        .btn-share { background-color: #17a2b8; }
        .close-modal { position: absolute; top: 10px; left: 15px; font-size: 28px; cursor: pointer; color: #aaa; }

        /* Ù†Ø§Ø­ÛŒÙ‡ Ù…Ø®ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø±Ù†Ø¯Ø± */
        #renderArea { position: fixed; left: -9999px; top: 0; }

        @media (max-width: 600px) {
            .container { padding: 20px; border-radius: 0; box-shadow: none; margin: 0; }
            .sheet { transform: scale(0.9); transform-origin: top center; margin-bottom: -30px; }
            h2.form-title { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

<div class="container">
    <h2 class="form-title">Ø³Ø§Ù…Ø§Ù†Ù‡ Ù†Ú¯Ø§Ø±Ø´ Ù…Ú©Ø§ØªØ¨Ø§Øª Ø¢Ø²Ø§Ø¯</h2>
    
    <form id="letterForm">
        <!-- Ø¨Ø®Ø´ Û±: Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø§ÛŒÙ‡ -->
        <div class="form-section">
            <h3 class="section-title">Ù…Ø´Ø®ØµØ§Øª Ù†Ø§Ù…Ù‡</h3>
            <div class="input-group">
                <input type="text" id="department" class="form-input" placeholder=" " required>
                <label for="department" class="form-label">Ù†Ø§Ù… Ø§Ø¯Ø§Ø±Ù‡ / Ú¯ÛŒØ±Ù†Ø¯Ù‡</label>
            </div>
            <div class="input-group">
                <input type="text" id="subject" class="form-input" placeholder=" " required>
                <label for="subject" class="form-label">Ù…ÙˆØ¶ÙˆØ¹ Ù†Ø§Ù…Ù‡</label>
            </div>
            <div class="input-group">
                <textarea id="letterText" class="form-input" placeholder=" " required></textarea>
                <label for="letterText" class="form-label">Ù…ØªÙ† Ø§ØµÙ„ÛŒ Ù†Ø§Ù…Ù‡</label>
            </div>
        </div>

        <!-- Ø¨Ø®Ø´ Û²: ØªØµÙˆÛŒØ± -->
        <div class="form-section">
            <h3 class="section-title">Ø§ÙØ²ÙˆØ¯Ù† ØªØµÙˆÛŒØ± (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</h3>
            <div class="file-upload-box" onclick="document.getElementById('imageInput').click()">
                <input type="file" id="imageInput" accept="image/*">
                <span class="upload-icon">ğŸ“·</span>
                <span class="upload-text">Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ ØªØµÙˆÛŒØ± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</span>
                <span id="fileNameDisplay" class="file-name"></span>
            </div>
            
            <div class="range-control" id="imageControls" style="display:none;">
                <label>Ø³Ø§ÛŒØ² ØªØµÙˆÛŒØ±:</label>
                <input type="range" id="imageSize" min="30" max="100" value="80">
                <span id="sizeValue">80%</span>
            </div>
        </div>

        <!-- Ø¨Ø®Ø´ Û³: Ù¾ÛŒÙˆØ³Øª -->
        <div class="form-section">
            <h3 class="section-title">Ù¾ÛŒÙˆØ³Øª / Ø§Ø¯Ø§Ù…Ù‡ Ù…Ø·Ù„Ø¨ (ØµÙØ­Ù‡ Ø¬Ø¯ÛŒØ¯)</h3>
            <div class="input-group">
                <textarea id="attachmentText" class="form-input" placeholder=" "></textarea>
                <label for="attachmentText" class="form-label">Ù…ØªÙ† Ù¾ÛŒÙˆØ³Øª (Ø¯Ø± ØµÙØ­Ù‡ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ú†Ø§Ù¾ Ù…ÛŒâ€ŒØ´ÙˆØ¯)</label>
            </div>
        </div>

        <!-- Ø¨Ø®Ø´ Û´: ØªØ§ÛŒÛŒØ¯ -->
        <div class="input-group">
            <input type="password" id="verificationCode" class="form-input" inputmode="numeric" pattern="[0-9]*" placeholder=" " required>
            <label for="verificationCode" class="form-label">Ú©Ø¯ ØªØ§Ø¦ÛŒØ¯ Ù…Ø¯ÛŒØ±Ø¹Ø§Ù…Ù„</label>
        </div>

        <button type="submit" id="generateBtn" class="action-btn">
            <span class="btn-text">ØªÙˆÙ„ÛŒØ¯ Ù†Ø§Ù…Ù‡ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø³ÛŒØ³ØªÙ…</span>
            <span class="spinner">â†»</span>
        </button>
    </form>

    <div id="statusMessage"></div>

    <div id="resultArea">
        <h3 style="text-align: center; margin-bottom: 10px;">Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ú†Ø§Ù¾ (A5)</h3>
        <div id="pdfPreview">
            <!-- ØµÙØ­Ø§Øª Ù†Ø§Ù…Ù‡ Ø§ÛŒÙ†Ø¬Ø§ ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
        </div>
        <button type="button" id="downloadBtn" class="action-btn" style="margin-top: 20px; background-color: var(--success-color);">
            <span class="btn-text">Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ù†Ù‡Ø§ÛŒÛŒ (PDF)</span>
            <span class="spinner">â†»</span>
        </button>
    </div>
</div>

<!-- Ù†Ø§Ø­ÛŒÙ‡ Ù…Ø®ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø±Ù†Ø¯Ø± -->
<div id="renderArea"></div>

<!-- Ù…Ø¯Ø§Ù„ Ù…ÙˆÙÙ‚ÛŒØª -->
<div id="successModal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h3 style="color:var(--success-color);">ØªÙˆÙ„ÛŒØ¯ Ù…ÙˆÙÙ‚!</h3>
        <p>ÙØ§ÛŒÙ„ PDF Ø´Ù…Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª.</p>
        <div class="modal-btns">
            <a id="viewPdfBtn" class="modal-btn btn-view" target="_blank">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ùˆ Ú†Ø§Ù¾</a>
            <a id="sharePdfBtn" class="modal-btn btn-share">Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ</a>
        </div>
    </div>
</div>

<!-- Ø§Ø³Ú©Ø±ÛŒÙ¾Øªâ€ŒÙ‡Ø§ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
    // ************************************************************
    // Ù„Ø·ÙØ§Ù‹ Ø¢Ø¯Ø±Ø³ Ø²ÛŒØ± Ø±Ø§ Ø¨Ø§ Ø¢Ø¯Ø±Ø³ Ø¬Ø¯ÛŒØ¯ ÙˆØ¨ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø®ÙˆØ¯ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrJh6FWkNjydhbSUwXgXy9Etobnbs0hTq7LRkVWj9zC-2I2uOXqPyDXn159t5vcZoWlg/exec"; 
    // ************************************************************

    let lastGeneratedPdfBlob = null;
    let currentData = {};
    let uploadedImageData = null;

    // Ø¹Ù†Ø§ØµØ± DOM
    const form = document.getElementById('letterForm');
    const generateBtn = document.getElementById('generateBtn');
    const statusMsg = document.getElementById('statusMessage');
    const resultArea = document.getElementById('resultArea');
    const pdfPreview = document.getElementById('pdfPreview');
    const renderArea = document.getElementById('renderArea');
    const downloadBtn = document.getElementById('downloadBtn');
    
    // Ù…Ø¯ÛŒØ±ÛŒØª ØªØµÙˆÛŒØ±
    const imageInput = document.getElementById('imageInput');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const imageControls = document.getElementById('imageControls');
    const imageSize = document.getElementById('imageSize');
    const sizeValue = document.getElementById('sizeValue');

    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            fileNameDisplay.textContent = "ØªØµÙˆÛŒØ± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯: " + file.name;
            imageControls.style.display = 'flex';
            const reader = new FileReader();
            reader.onload = (ev) => { uploadedImageData = ev.target.result; };
            reader.readAsDataURL(file);
        } else {
            fileNameDisplay.textContent = "";
            imageControls.style.display = 'none';
            uploadedImageData = null;
        }
    });

    imageSize.addEventListener('input', function() {
        sizeValue.textContent = this.value + '%';
    });

    // ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
    function toPersianDigits(str) {
        return String(str).replace(/\d/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d]);
    }
    
    function toEnglishDigits(str) {
        return String(str).replace(/[Û°-Û¹]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d));
    }

    function showStatus(msg, type) {
        statusMsg.textContent = msg;
        statusMsg.className = type === 'success' ? 'msg-success' : 'msg-error';
        statusMsg.style.display = 'block';
    }

    // Ø³Ø§Ø®Øª HTML ØµÙØ­Ù‡ A5
    function createSheetHTML(data, isAttachmentPage = false) {
        const div = document.createElement('div');
        div.className = 'sheet';
        
        // Ù…Ø­ØªÙˆØ§ÛŒ ØªØµÙˆÛŒØ±
        let imgHtml = '';
        if (!isAttachmentPage && uploadedImageData) {
            const width = imageSize.value + '%';
            imgHtml = `<img src="${uploadedImageData}" class="inserted-image" style="width:${width}">`;
        }

        // Ù…Ø­ØªÙˆØ§ÛŒ Ù…ØªÙ†
        const bodyText = isAttachmentPage ? data.attachmentText : data.letterText;
        const subjectLine = isAttachmentPage ? 'Ù¾ÛŒÙˆØ³Øª Ù†Ø§Ù…Ù‡: ' + data.subject : 'Ù…ÙˆØ¶ÙˆØ¹: ' + data.subject;
        const recipientLine = isAttachmentPage ? '' : `<p class="recipient">Ø±ÛŒØ§Ø³Øª Ù…Ø­ØªØ±Ù… ${data.department}</p>`;
        const basmeLine = isAttachmentPage ? '' : `<p style="text-align:center; font-weight:bold; margin-bottom:10px;">Ø¨Ø³Ù…Ù‡ ØªØ¹Ø§Ù„ÛŒ</p>`;

        div.innerHTML = `
            <div class="letter-header">
                <div class="header-col header-right">
                    <p>ØªÙ„ÙÙ†: Û°Û¹Û±Û³ÛµÛ°Û·Û¶ÛµÛ¸Û·</p>
                    <p>Ø¢Ø¯Ø±Ø³: Ø¬ÛŒØ±ÙØªØŒ Ø§Ø¨ØªØ¯Ø§ÛŒ Ø® Ø§Ø³ØªÙ‚Ù„Ø§Ù„</p>
                </div>
                <div class="header-col header-center">
                    <p class="header-title">Ù…Ø¤Ø³Ø³Ù‡ ØªØ¹Ø§Ù„ÛŒ Ø§Ù†Ø¯ÛŒØ´Ù‡ Ùˆ Ø±Ø´Ø¯</p>
                    <p class="header-sub">Ø´Ù†Ø§Ø³Ù‡ Ù…Ù„ÛŒ: Û±Û´Û°Û±Û³Û·Û·Û°Û¶Û±Û±</p>
                </div>
                <div class="header-col header-left">
                    <p>Ø´Ù…Ø§Ø±Ù‡: ${toPersianDigits(data.letterNumber)}</p>
                    <p>ØªØ§Ø±ÛŒØ®: ${toPersianDigits(data.issueDate)}</p>
                </div>
            </div>
            <div class="letter-body">
                ${basmeLine}
                ${recipientLine}
                <p style="margin-bottom:10px;">${subjectLine}</p>
                <div class="text-content">
                    ${bodyText.replace(/\n/g, '<br>')}
                </div>
                ${imgHtml}
            </div>
            <div class="signature">
                <p class="signature-title">Ø§Ù…Ø¶Ø§Ø¡</p>
                <p>Ù…Ø¯ÛŒØ±Ø¹Ø§Ù…Ù„ Ù…Ø¤Ø³Ø³Ù‡ ØªØ¹Ø§Ù„ÛŒ Ø§Ù†Ø¯ÛŒØ´Ù‡ Ùˆ Ø±Ø´Ø¯</p>
            </div>
        `;
        return div;
    }

    // Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù…
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        statusMsg.style.display = 'none';
        generateBtn.disabled = true;
        generateBtn.classList.add('loading');

        const now = new Date();
        const jalaliDate = now.toLocaleDateString('fa-IR');
        // Ø´Ù…Ø§Ø±Ù‡ Ù†Ø§Ù…Ù‡: Ø³Ø§Ø¹Øª + Ø¯Ù‚ÛŒÙ‚Ù‡ + 4
        const letterNum = `${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}4`;

        const formData = {
            department: document.getElementById('department').value,
            subject: document.getElementById('subject').value,
            letterText: document.getElementById('letterText').value,
            attachmentText: document.getElementById('attachmentText').value,
            verificationCode: toEnglishDigits(document.getElementById('verificationCode').value),
            issueDate: toEnglishDigits(jalaliDate),
            letterNumber: letterNum,
            image: uploadedImageData ? "ØªØµÙˆÛŒØ± Ø¯Ø§Ø±Ø¯" : "Ø¨Ø¯ÙˆÙ† ØªØµÙˆÛŒØ±" // Ø§Ø±Ø³Ø§Ù„ ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡ Ø¬Ø§ÛŒ Ø®ÙˆØ¯ ØªØµÙˆÛŒØ±
        };

        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(formData)
            });
            const result = await response.json();

            if (result.status === 'success') {
                showStatus('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ PDF...', 'success');
                currentData = { ...formData, issueDate: jalaliDate }; // Ø°Ø®ÛŒØ±Ù‡ Ø¨Ø±Ø§ÛŒ PDF
                
                // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù‚Ø¨Ù„ÛŒ
                pdfPreview.innerHTML = '';
                renderArea.innerHTML = '';

                // ØªÙˆÙ„ÛŒØ¯ ØµÙØ­Ù‡ Û±
                const page1 = createSheetHTML(currentData, false);
                pdfPreview.appendChild(page1);
                renderArea.appendChild(page1.cloneNode(true));

                // ØªÙˆÙ„ÛŒØ¯ ØµÙØ­Ù‡ Û² (Ù¾ÛŒÙˆØ³Øª) Ø§Ú¯Ø± Ø¨Ø§Ø´Ø¯
                if (formData.attachmentText.trim()) {
                    const page2 = createSheetHTML(currentData, true);
                    pdfPreview.appendChild(page2);
                    renderArea.appendChild(page2.cloneNode(true));
                }

                form.style.display = 'none';
                resultArea.style.display = 'block';
                resultArea.scrollIntoView({behavior: 'smooth'});

                // ØªÙˆÙ„ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø± PDF
                setTimeout(generatePDF, 1000);

            } else {
                showStatus(result.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª.', 'error');
                generateBtn.disabled = false;
                generateBtn.classList.remove('loading');
            }
        } catch (error) {
            console.error(error);
            showStatus('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±. Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ Ú†Ú© Ú©Ù†ÛŒØ¯.', 'error');
            generateBtn.disabled = false;
            generateBtn.classList.remove('loading');
        }
    });

    // ØªØ§Ø¨Ø¹ ØªÙˆÙ„ÛŒØ¯ PDF Ø¨Ø§ Ú©ÛŒÙÛŒØª Ø¨Ø§Ù„Ø§
    async function generatePDF() {
        const { jsPDF } = window.jspdf;
        downloadBtn.classList.add('loading');
        downloadBtn.disabled = true;

        const sheets = renderArea.querySelectorAll('.sheet');
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a5',
            compress: true
        });

        for (let i = 0; i < sheets.length; i++) {
            if (i > 0) pdf.addPage();
            
            // ØªØ¨Ø¯ÛŒÙ„ HTML Ø¨Ù‡ Ø¨ÙˆÙ… Ù†Ù‚Ø§Ø´ÛŒ (Canvas)
            const canvas = await html2canvas(sheets[i], {
                scale: 2.5, // Ú©ÛŒÙÛŒØª Ø¨Ø§Ù„Ø§
                useCORS: true,
                logging: false
            });
            
            const imgData = canvas.toDataURL('image/jpeg', 0.95);
            pdf.addImage(imgData, 'JPEG', 0, 0, 148, 210);
        }

        lastGeneratedPdfBlob = pdf.output('blob');
        const fileName = `${currentData.subject}.pdf`;
        
        // Ù†Ù…Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡ Ù‡Ø§
        downloadBtn.classList.remove('loading');
        downloadBtn.disabled = false;
        
        // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…Ø¯Ø§Ù„ Ù…ÙˆÙÙ‚ÛŒØª
        const successModal = document.getElementById('successModal');
        successModal.style.display = 'flex';
        
        // ØªÙ†Ø¸ÛŒÙ… Ø¯Ú©Ù…Ù‡ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§ØµÙ„ÛŒ
        downloadBtn.onclick = () => pdf.save(fileName);
    }

    // Ø¨Ø³ØªÙ† Ù…Ø¯Ø§Ù„
    document.querySelector('.close-modal').onclick = () => {
        document.getElementById('successModal').style.display = 'none';
    };

    // Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙØ§ÛŒÙ„
    document.getElementById('viewPdfBtn').onclick = (e) => {
        e.preventDefault();
        if (lastGeneratedPdfBlob) {
            const url = URL.createObjectURL(lastGeneratedPdfBlob);
            window.open(url, '_blank');
        }
    };

    // Ø§Ø´ØªØ±Ø§Ú© Ú¯Ø°Ø§Ø±ÛŒ
    document.getElementById('sharePdfBtn').onclick = async (e) => {
        e.preventDefault();
        if (!lastGeneratedPdfBlob) return;
        
        const file = new File([lastGeneratedPdfBlob], `${currentData.subject}.pdf`, { type: 'application/pdf' });
        const shareData = {
            files: [file],
            title: currentData.subject,
            text: `Ù†Ø§Ù…Ù‡ Ø¬Ù‡Øª ${currentData.department} \nÙ…ÙˆØ¶ÙˆØ¹: ${currentData.subject}`
        };

        if (navigator.canShare && navigator.canShare(shareData)) {
            try { await navigator.share(shareData); } catch (err) { console.log(err); }
        } else {
            alert('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.');
        }
    };

</script>

</body>
</html>
