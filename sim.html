  <!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†</title>
    <style>
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ */
        body { font-family: tahoma, sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 70px; user-select: none; }
        .hide { display: none !important; }
        .container { max-width: 500px; margin: 0 auto; padding: 15px; }
        .card { background: #fff; padding: 15px; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 10px; font-family: inherit; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-p { background: #007bff; color: white; }
        .btn-o { background: transparent; border: 1px solid #ddd; color: #555; }
        .nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #ddd; z-index: 1000; }
        .nav div { font-size: 1.5rem; cursor: pointer; opacity: 0.6; }
        .nav div.active { opacity: 1; color: #007bff; }
        .loading { opacity: 0.7; pointer-events: none; }
        
        /* ØªØ³Øª Ùˆ Ù¾ÛŒØ§Ù… */
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 20px; z-index: 2000; display: none; }
        
        /* Ù‡Ø¯Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ */
        .prof-head { text-align: center; margin-bottom: 15px; }
        .prof-img { width: 80px; height: 80px; background: #ddd; border-radius: 50%; margin: 0 auto 10px; object-fit: cover; }
    </style>
</head>
<body>

    <div id="toast"></div>

    <!-- ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ Ùˆ Ø«Ø¨Øª Ù†Ø§Ù… -->
    <div id="page-auth" class="container" style="height: 100vh; display: flex; flex-direction: column; justify-content: center;">
        <h2 style="text-align:center; color:#007bff">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…</h2>
        
        <!-- ÙØ±Ù… ÙˆØ±ÙˆØ¯ -->
        <div id="form-login" class="card">
            <input type="text" id="l-user" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ (Ø³ØªÙˆÙ† B)">
            <input type="password" id="l-pass" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± (Ø³ØªÙˆÙ† C)">
            <button class="btn-p" onclick="app.login(this)">ÙˆØ±ÙˆØ¯</button>
            <button class="btn-o" style="margin-top:10px" onclick="app.guest()">ÙˆØ±ÙˆØ¯ Ù…Ù‡Ù…Ø§Ù†</button>
            <p style="text-align:center; font-size:0.8rem; margin-top:10px; color:blue; cursor:pointer" onclick="document.getElementById('form-login').classList.add('hide');document.getElementById('form-reg').classList.remove('hide')">Ø«Ø¨Øª Ù†Ø§Ù… Ù†Ø¯Ø§Ø±ÛŒØ¯ØŸ</p>
        </div>

        <!-- ÙØ±Ù… Ø«Ø¨Øª Ù†Ø§Ù… -->
        <div id="form-reg" class="card hide">
            <h3>Ø«Ø¨Øª Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯</h3>
            <input type="text" id="r-id" placeholder="Ø¢ÛŒØ¯ÛŒ (Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ùˆ ÛŒÚ©ØªØ§)">
            <input type="text" id="r-user" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ / Ú©Ø¯ Ù…Ù„ÛŒ">
            <input type="password" id="r-pass" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
            <input type="text" id="r-name" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ">
            <input type="number" id="r-ref" placeholder="Ú©Ø¯ Ù…Ø¹Ø±Ù">
            <button class="btn-p" onclick="app.register(this)">Ø«Ø¨Øª Ù†Ø§Ù…</button>
            <p style="text-align:center; font-size:0.8rem; margin-top:10px; color:blue; cursor:pointer" onclick="document.getElementById('form-reg').classList.add('hide');document.getElementById('form-login').classList.remove('hide')">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ÙˆØ±ÙˆØ¯</p>
        </div>
    </div>

    <!-- ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ -->
    <div id="page-app" class="hide">
        
        <!-- Ø®Ø§Ù†Ù‡ -->
        <div id="tab-home" class="container">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <h2>Ø®Ø§Ù†Ù‡</h2>
                <button style="width:auto" class="btn-o" onclick="app.sync(true)">ğŸ”„</button>
            </div>
            <div id="feed"></div>
        </div>

        <!-- Ù¾Ø±ÙˆÙØ§ÛŒÙ„ -->
        <div id="tab-prof" class="container hide">
            <div class="card">
                <button class="btn-o" id="btn-back-prof" style="width:auto; float:left" onclick="app.nav('home')">â¬…</button>
                <div class="prof-head">
                    <img id="p-img" class="prof-img">
                    <h3 id="p-name"></h3>
                    <div style="color:gray" id="p-user"></div>
                </div>
                <div style="display:flex; justify-content:space-around; margin-bottom:15px">
                    <div style="text-align:center"><b id="c-fol">0</b><br><small>Ø¯Ù†Ø¨Ø§Ù„ Ú©Ù†Ù†Ø¯Ù‡</small></div>
                    <div style="text-align:center"><b id="c-ing">0</b><br><small>Ø¯Ù†Ø¨Ø§Ù„ Ø´ÙˆÙ†Ø¯Ù‡</small></div>
                </div>
                <div id="act-prof"></div>
            </div>
            <div id="prof-posts"></div>
        </div>

        <!-- Ù¾ÛŒØ§Ù… Ù‡Ø§ -->
        <div id="tab-msg" class="container hide">
            <h2>Ù¾ÛŒØ§Ù… Ù‡Ø§</h2>
            <div id="msg-list"></div>
        </div>

        <!-- Ù¾Ø³Øª Ø¬Ø¯ÛŒØ¯ -->
        <div id="tab-add" class="container hide">
            <h2>Ù¾Ø³Øª Ø¬Ø¯ÛŒØ¯</h2>
            <div class="card">
                <input type="text" id="n-title" placeholder="Ø¹Ù†ÙˆØ§Ù†">
                <select id="n-cat">
                    <option value="Ø¹Ù…ÙˆÙ…ÛŒ">Ø¹Ù…ÙˆÙ…ÛŒ</option>
                    <option value="Ø§Ø®Ø¨Ø§Ø±">Ø§Ø®Ø¨Ø§Ø±</option>
                </select>
                <textarea id="n-text" rows="5" placeholder="Ù…ØªÙ† Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
                <button class="btn-p" onclick="app.newPost(this)">Ø§Ø±Ø³Ø§Ù„</button>
            </div>
        </div>

        <!-- Ù†ÙˆØ§Ø± Ù¾Ø§ÛŒÛŒÙ† -->
        <div class="nav">
            <div onclick="app.nav('home')" id="n-home" class="active">ğŸ </div>
            <div onclick="app.nav('add')" id="n-add">â•</div>
            <div onclick="app.nav('msg')" id="n-msg">ğŸ’¬</div>
            <div onclick="app.nav('prof')" id="n-prof">ğŸ‘¤</div>
        </div>
    </div>

    <script>
        // *** Ù„ÛŒÙ†Ú© Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú¯Ø°Ø§Ø± (Ø­ØªÙ…Ø§ New Deployment Ø¨Ø²Ù†) ***
        const API_URL = 'YOUR_NEW_DEPLOYMENT_URL_HERE';

        const app = {
            data: { user: null, users: [], posts: [], msgs: [], guest: false },
            
            init: function() {
                // Ú†Ú© Ú©Ø±Ø¯Ù† ÙˆØ±ÙˆØ¯ Ù‚Ø¨Ù„ÛŒ
                const uid = localStorage.getItem('saved_uid');
                if(uid) {
                    // Ø§Ú¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù„ÙˆÚ©Ø§Ù„ Ø¨ÙˆØ¯ Ù„ÙˆØ¯ Ú©Ù† ØªØ§ ÙˆÙ‚ØªÛŒ Ø§Ø² Ø³Ø±ÙˆØ± Ø¨ÛŒØ§Ø¯
                    const localDB = localStorage.getItem('local_db');
                    if(localDB) {
                        const d = JSON.parse(localDB);
                        this.data.users = d.users;
                        this.data.posts = d.posts;
                        this.data.msgs = d.msgs;
                        const u = this.data.users.find(x => x.id === uid);
                        if(u) {
                            this.data.user = u;
                            this.startApp();
                            this.sync(false); // Ø¢Ù¾Ø¯ÛŒØª Ù…Ø®ÙÛŒ
                            return;
                        }
                    }
                }
                // Ø§Ú¯Ø± ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø¨ÙˆØ¯
                document.getElementById('page-auth').classList.remove('hide');
            },

            // *** ØªØ§Ø¨Ø¹ Ø§ØªØµØ§Ù„ Ø­ÛŒØ§ØªÛŒ (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡) ***
            call: async function(action, payload) {
                try {
                    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² text/plain Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø±ÙˆØ± CORS Ú¯ÙˆÚ¯Ù„
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        redirect: "follow",
                        headers: { "Content-Type": "text/plain;charset=utf-8" },
                        body: JSON.stringify({ action: action, payload: payload })
                    });
                    const json = await response.json();
                    return json;
                } catch (e) {
                    console.error(e);
                    return { status: 'error', msg: 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±. Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø±Ø§ Ú†Ú© Ú©Ù†ÛŒØ¯.' };
                }
            },

            login: async function(btn) {
                const u = document.getElementById('l-user').value;
                const p = document.getElementById('l-pass').value;
                if(!u || !p) return alert('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ø±Ù…Ø² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');

                btn.classList.add('loading');
                btn.innerText = 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...';
                
                const res = await this.call('login', { user: u, pass: p });
                
                btn.classList.remove('loading');
                btn.innerText = 'ÙˆØ±ÙˆØ¯';

                if(res.status === 'success') {
                    this.data.user = res.user;
                    localStorage.setItem('saved_uid', res.user.id);
                    this.startApp();
                    this.sync(true);
                } else {
                    alert(res.msg);
                }
            },

            register: async function(btn) {
                const pl = {
                    id: document.getElementById('r-id').value,
                    user: document.getElementById('r-user').value,
                    pass: document.getElementById('r-pass').value,
                    name: document.getElementById('r-name').value,
                    refCode: document.getElementById('r-ref').value
                };
                if(!pl.id || !pl.user || !pl.pass) return alert('Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
                
                btn.classList.add('loading');
                const res = await this.call('register', pl);
                btn.classList.remove('loading');
                
                if(res.status === 'success') {
                    alert('Ø«Ø¨Øª Ù†Ø§Ù… Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯. Ø­Ø§Ù„Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.');
                    document.getElementById('form-reg').classList.add('hide');
                    document.getElementById('form-login').classList.remove('hide');
                } else {
                    alert(res.msg);
                }
            },

            guest: function() {
                this.data.guest = true;
                this.data.user = { id: 'guest', name: 'Ù…Ù‡Ù…Ø§Ù†', followers:[], following:[] };
                this.startApp();
                this.sync(true);
            },

            startApp: function() {
                document.getElementById('page-auth').classList.add('hide');
                document.getElementById('page-app').classList.remove('hide');
                this.nav('home');
            },

            sync: async function(showToast) {
                if(showToast) this.toast('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ...');
                const res = await this.call('getAll', {});
                if(res.status === 'success') {
                    this.data.users = res.users;
                    this.data.posts = res.posts;
                    this.data.msgs = res.msgs;
                    localStorage.setItem('local_db', JSON.stringify(res));
                    
                    // Ø¢Ù¾Ø¯ÛŒØª ÛŒÙˆØ²Ø± Ø¬Ø§Ø±ÛŒ
                    if(!this.data.guest && this.data.user) {
                        const freshUser = this.data.users.find(u => u.id === this.data.user.id);
                        if(freshUser) this.data.user = freshUser;
                    }
                    
                    this.renderHome();
                    if(showToast) this.toast('Ø¨Ø±ÙˆØ² Ø´Ø¯');
                } else {
                    if(showToast) this.toast('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª');
                }
            },

            // --- UI FUNCTIONS ---
            nav: function(tab) {
                document.querySelectorAll('.container').forEach(c => c.classList.add('hide'));
                document.querySelectorAll('.nav div').forEach(d => d.classList.remove('active'));
                
                if(tab === 'home') {
                    document.getElementById('tab-home').classList.remove('hide');
                    document.getElementById('n-home').classList.add('active');
                    this.renderHome();
                } else if(tab === 'prof') {
                    document.getElementById('tab-prof').classList.remove('hide');
                    document.getElementById('n-prof').classList.add('active');
                    this.renderProf(this.data.user.id);
                } else if(tab === 'add') {
                    if(this.data.guest) return alert('Ù…Ù‡Ù…Ø§Ù† Ù†Ù…ÛŒØªÙˆØ§Ù†Ø¯ Ù¾Ø³Øª Ø¨Ú¯Ø°Ø§Ø±Ø¯');
                    document.getElementById('tab-add').classList.remove('hide');
                    document.getElementById('n-add').classList.add('active');
                } else if(tab === 'msg') {
                    document.getElementById('tab-msg').classList.remove('hide');
                    document.getElementById('n-msg').classList.add('active');
                    this.renderMsg();
                }
            },

            renderHome: function() {
                const div = document.getElementById('feed');
                div.innerHTML = '';
                const sorted = this.data.posts.sort((a,b) => b.time - a.time);
                sorted.forEach(p => {
                    const u = this.data.users.find(x => x.id === p.uid);
                    if(!u) return;
                    div.innerHTML += `
                        <div class="card">
                            <div style="display:flex; justify-content:space-between">
                                <b onclick="app.renderProf('${u.id}')">${u.name}</b>
                                <span style="font-size:0.8rem; color:gray">${p.cat}</span>
                            </div>
                            <h3>${p.title}</h3>
                            <p>${p.text}</p>
                            <div style="border-top:1px solid #eee; padding-top:10px; display:flex; gap:15px">
                                <span>â¤ ${p.likes.length}</span>
                                <span>ğŸ’¬ ${p.comments.length}</span>
                            </div>
                        </div>
                    `;
                });
            },

            renderProf: function(uid) {
                document.getElementById('tab-prof').classList.remove('hide');
                document.getElementById('tab-home').classList.add('hide');
                
                const u = this.data.users.find(x => x.id === uid);
                if(!u) return;

                document.getElementById('p-name').innerText = u.name;
                document.getElementById('p-user').innerText = '@' + u.username;
                document.getElementById('c-fol').innerText = u.followers.length;
                document.getElementById('c-ing').innerText = u.following.length;
                
                // Ø¯Ú©Ù…Ù‡ ÙØ§Ù„Ùˆ/Ø¢Ù†ÙØ§Ù„Ùˆ
                const actDiv = document.getElementById('act-prof');
                actDiv.innerHTML = '';
                if(uid !== this.data.user.id && !this.data.guest) {
                    const isFol = this.data.user.following.includes(uid);
                    actDiv.innerHTML = `<button class="${isFol?'btn-o':'btn-p'}" onclick="app.toggleFollow('${uid}')">${isFol?'Ù„ØºÙˆ Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù†':'Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù†'}</button>`;
                }

                // Ù¾Ø³Øª Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
                const pDiv = document.getElementById('prof-posts');
                pDiv.innerHTML = '';
                const userPosts = this.data.posts.filter(p => p.uid === uid);
                userPosts.forEach(p => {
                    pDiv.innerHTML += `<div class="card"><h4>${p.title}</h4><p>${p.text}</p></div>`;
                });
            },

            newPost: async function(btn) {
                const p = {
                    pid: 'post_' + Date.now(),
                    uid: this.data.user.id,
                    title: document.getElementById('n-title').value,
                    cat: document.getElementById('n-cat').value,
                    text: document.getElementById('n-text').value,
                    time: Date.now()
                };
                btn.innerText = 'Ø§Ø±Ø³Ø§Ù„...';
                await this.call('createPost', p);
                btn.innerText = 'Ø§Ø±Ø³Ø§Ù„';
                this.sync(false);
                this.nav('home');
            },

            renderMsg: function() {
                // Ù„ÛŒØ³Øª Ù¾ÛŒØ§Ù… Ù‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù…ÛŒØ§Ø¯ (Ø³Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø­Ø¬Ù… Ú©Ù…)
                document.getElementById('msg-list').innerHTML = '<p style="text-align:center">Ù¾ÛŒØ§Ù… Ù‡Ø§ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>';
                // Ø¨Ø±Ø§ÛŒ Ø§Ø®ØªØµØ§Ø± Ú©Ø¯ØŒ Ø§ÛŒÙ†Ø¬Ø§ ÙÙ‚Ø· Ù„ÛŒØ³Øª Ø®Ø§Ù… Ø±Ùˆ Ù†Ø´ÙˆÙ† Ù…ÛŒØ¯Ù‡. Ù…Ù†Ø·Ù‚ Ú†Øª Ø´Ø¨ÛŒÙ‡ Ù¾Ø³Øª Ø§Ø³Øª.
            },

            toggleFollow: async function(uid) {
                const me = this.data.user;
                const target = this.data.users.find(u => u.id === uid);
                
                if(me.following.includes(uid)) {
                    me.following = me.following.filter(x => x !== uid);
                    target.followers = target.followers.filter(x => x !== me.id);
                } else {
                    me.following.push(uid);
                    target.followers.push(me.id);
                }
                
                this.renderProf(uid); // Ø¢Ù¾Ø¯ÛŒØª Ø¢Ù†ÛŒ UI
                // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±
                await this.call('updateUser', [me, target]);
            },

            toast: function(txt) {
                const t = document.getElementById('toast');
                t.innerText = txt;
                t.style.display = 'block';
                setTimeout(() => t.style.display = 'none', 3000);
            }
        };

        app.init();
    </script>
</body>
</html>
