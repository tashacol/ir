<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ</title>
    <style>
        :root {
            --p: #2563eb; --pd: #1e40af; --bg: #f8fafc; --s: #ffffff;
            --t: #0f172a; --tg: #64748b; --bor: #e2e8f0; --err: #ef4444; --suc: #22c55e;
            --sh: 0 4px 6px -1px rgba(0,0,0,0.05); --rad: 18px;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; -webkit-tap-highlight-color:transparent; outline:none; }
        body { background:var(--bg); color:var(--t); padding-bottom:90px; overflow-x:hidden; user-select:none; }
        .con { max-width:550px; margin:0 auto; padding:15px; min-height:100vh; }
        .hide { display:none !important; }
        .flex-bw { display:flex; justify-content:space-between; align-items:center; }

        /* UI Components */
        .card { background:var(--s); border-radius:var(--rad); padding:18px; margin-bottom:15px; box-shadow:var(--sh); border:1px solid var(--bor); position:relative; transition:transform 0.2s; }
        .inp { width:100%; padding:14px; border:2px solid var(--bor); border-radius:14px; background:var(--bg); font-size:1rem; margin-bottom:12px; transition:0.3s; }
        .inp:focus { border-color:var(--p); background:var(--s); }
        .btn { width:100%; padding:14px; border-radius:14px; font-weight:700; font-size:1rem; display:flex; justify-content:center; align-items:center; gap:8px; cursor:pointer; border:none; transition:0.2s; }
        .btn:active { transform:scale(0.97); }
        .btn-p { background:linear-gradient(135deg, var(--p), var(--pd)); color:white; box-shadow:0 4px 10px rgba(37,99,235,0.3); }
        .btn-o { border:2px solid var(--bor); color:var(--tg); background:transparent; }
        .btn-s { padding:6px 14px; font-size:0.85rem; width:auto; border-radius:20px; }
        .btn-i { font-size:1.5rem; padding:5px; color:var(--t); background:transparent; border:none; cursor:pointer; }
        
        /* Loading Spinner */
        .loading { position:relative; color:transparent !important; pointer-events:none; }
        .loading::after { content:""; position:absolute; left:50%; top:50%; width:22px; height:22px; border:3px solid #fff; border-top-color:transparent; border-radius:50%; animation:rot 0.8s linear infinite; transform:translate(-50%,-50%); }
        @keyframes rot { to { transform:translate(-50%,-50%) rotate(360deg); } }

        /* Skeleton Loader */
        .skel { background:linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%); background-size:200% 100%; animation:shm 1.5s infinite; border-radius:8px; }
        @keyframes shm { 0% { background-position:200% 0; } 100% { background-position:-200% 0; } }
        .sk-av { width:48px; height:48px; border-radius:50%; }
        .sk-ln-sm { height:12px; width:40%; border-radius:6px; }
        .sk-ln-md { height:12px; width:60%; border-radius:6px; }
        .sk-ln-lg { height:16px; width:80%; border-radius:8px; margin-top:10px; }
        .skel-card .flex-bw { margin-bottom: 15px; }

        /* User Avatar & Block */
        .u-blk { display:flex; align-items:center; gap:12px; cursor:pointer; }
        .u-img { width:48px; height:48px; border-radius:50%; object-fit:cover; background:#cbd5e1; border:2px solid var(--s); box-shadow:0 2px 5px rgba(0,0,0,0.1); }
        .u-nm { font-weight:700; font-size:0.95rem; color:var(--t); }
        .u-id { font-size:0.75rem; color:var(--tg); }

        /* Navigation Bar */
        .nav { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); width:92%; max-width:500px; background:rgba(255,255,255,0.9); backdrop-filter:blur(15px); border-radius:25px; display:flex; justify-content:space-around; padding:12px; box-shadow:0 10px 40px rgba(0,0,0,0.15); border:1px solid rgba(255,255,255,0.5); z-index:900; }
        .n-it { font-size:1.7rem; padding:8px 16px; border-radius:18px; color:#cbd5e1; transition:0.3s cubic-bezier(0.4, 0, 0.2, 1); position:relative; cursor:pointer; }
        .n-it.active { color:var(--p); background:#eff6ff; transform:translateY(-5px); }
        .bdg { position:absolute; top:5px; right:5px; background:var(--err); color:white; font-size:0.65rem; padding:2px 6px; border-radius:10px; border:2px solid white; font-weight:bold; min-width:18px; text-align:center; }

        /* Profile Styles */
        .p-top { display:flex; align-items:center; gap:20px; margin-bottom:20px; }
        .p-pic { width:90px; height:90px; border-radius:50%; border:4px solid white; box-shadow:0 8px 20px rgba(0,0,0,0.15); object-fit:cover; background:#cbd5e1; cursor: pointer; transition: transform 0.2s; }
        .p-pic:active { transform: scale(0.95); }
        .p-sts { flex:1; display:flex; justify-content:space-around; text-align:center; }
        .st-n { font-weight:900; font-size:1.2rem; display:block; color:var(--t); }
        .st-l { font-size:0.8rem; color:var(--tg); }
        .chips { display:flex; gap:10px; overflow-x:auto; padding:5px 0 15px; scrollbar-width:none; }
        .chip { padding:8px 18px; border-radius:25px; background:var(--s); border:1px solid var(--bor); white-space:nowrap; font-size:0.85rem; transition:0.2s; cursor:pointer; color:var(--tg); font-weight:500; }
        .chip.active { background:var(--t); color:white; border-color:var(--t); transform:scale(1.05); }

        /* Post Styles */
        .p-act { display:flex; justify-content:space-around; align-items:center; gap:10px; margin-top:10px; border-top:1px solid var(--bor); padding-top:12px; color:var(--tg); }
        .act-b { display:flex; align-items:center; gap:6px; cursor:pointer; font-size:0.95rem; transition:0.2s; }
        .act-b:hover { color:var(--p); }
        .act-b.lk { color:var(--err); animation:pop 0.3s; }
        .act-b.lk span:first-child { transform:scale(1.1); }
        @keyframes pop { 50% { transform:scale(1.2); } }
        .ment { color:var(--p); font-weight:bold; cursor:pointer; text-decoration:none; background:rgba(37,99,235,0.1); padding:0 4px; border-radius:4px; }
        .url-link { color: var(--p); text-decoration: underline; word-break: break-all; cursor: pointer; }

        /* Upload Linear Progress */
        .prog-c { position:relative; height:6px; background:#e2e8f0; width:100%; margin-top:15px; border-radius:3px; overflow:hidden; display:none; }
        .fill { height:100%; background:linear-gradient(90deg, var(--p), #60a5fa); width:0%; transition:width 0.4s ease-out; border-radius:3px; }
        .up-msg { font-size:0.85rem; color:var(--suc); text-align:center; display:none; margin-top:8px; font-weight:800; animation:fadeIn 0.5s; }
        .sending { opacity:0.8; pointer-events:none; border:2px dashed var(--p); background:#eff6ff; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        /* Message Ticks & Styles */
        .tik { font-size:0.75rem; margin-right:4px; vertical-align:middle; display:inline-block; width:16px; text-align:center; }
        .tik.wait { color:var(--tg); } /* Ø³Ø§Ø¹Øª */
        .tik.sent { color:var(--tg); } /* ØªÛŒÚ© Ø®Ø§Ú©Ø³ØªØ±ÛŒ */
        .tik.read { color:var(--p); font-weight:bold; } /* Ø¯Ùˆ ØªÛŒÚ© Ø¢Ø¨ÛŒ */
        
        .msg-bub { padding:12px 16px; border-radius:18px; max-width:85%; margin-bottom:8px; position:relative; word-wrap:break-word; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
        .msg-me { background:linear-gradient(135deg, #e0f2fe, #bfdbfe); align-self:flex-end; border-bottom-left-radius:18px; border-bottom-right-radius:4px; color:var(--pd); }
        .msg-ot { background:white; align-self:flex-start; border-bottom-left-radius:4px; border:1px solid var(--bor); color:var(--t); }
        .msg-tm { font-size:0.65rem; margin-top:4px; display:flex; align-items:center; justify-content:flex-end; opacity:0.7; }

        /* Shared Post in Chat */
        .msg-post-share { border: 1px solid var(--bor); border-radius: 12px; padding: 12px; cursor: pointer; background-color: #f8fafc; transition: background-color 0.2s; }
        .msg-post-share:hover { background-color: #f1f5f9; }
        .msg-post-share .u-nm { font-size: 0.85rem; }
        .msg-post-share .u-img { width: 32px; height: 32px; }
        .msg-post-share-title { font-weight: bold; margin-top: 8px; font-size: 0.9rem; color: var(--t); }
        .msg-post-share-text { font-size: 0.8rem; color: var(--tg); margin-top: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }
        .msg-bub .msg-post-share { margin: -5px; } 

        /* Toast Notification */
        #tst { position:fixed; top:20px; left:50%; transform:translateX(-50%) translateY(-100px); background:#0f172a; color:white; padding:12px 24px; border-radius:50px; z-index:2000; font-size:0.9rem; opacity:0; transition:0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display:flex; align-items:center; gap:10px; box-shadow:0 10px 30px rgba(0,0,0,0.3); }
        #tst.show { opacity:1; transform:translateX(-50%) translateY(0); }

        /* Full Screen Modals */
        .mod-bg { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(15,23,42,0.6); z-index:1000; display:flex; align-items:flex-end; justify-content:center; backdrop-filter:blur(4px); transition:0.3s; opacity:0; pointer-events:none; }
        .mod-bg.show { opacity:1; pointer-events:all; }
        .mod { background:var(--s); width:100%; max-width:550px; border-radius:30px 30px 0 0; padding:25px; max-height:85vh; overflow-y:auto; transform:translateY(100%); transition:transform 0.3s cubic-bezier(0.165, 0.84, 0.44, 1); }
        .mod-bg.show .mod { transform:translateY(0); }
        
        /* Image Viewer Modal */
        #m-img { align-items: center; }
        #img-vw { max-width: 90%; max-height: 80vh; border-radius: 50%; border: 4px solid white; box-shadow: 0 10px 30px rgba(0,0,0,0.5); object-fit: cover; aspect-ratio: 1/1; }

        /* Chat Screen */
        #sc-ch { position:fixed; top:0; left:0; right:0; bottom:0; background:var(--bg); z-index:2000; display:flex; flex-direction:column; transform:translateX(100%); transition:transform 0.3s ease-in-out; }
        #sc-ch.show { transform:translateX(0); }
        
        /* Single Post View Screen */
        #sc-post { position:fixed; top:0; left:0; right:0; bottom:0; background:var(--bg); z-index:1900; overflow-y:auto; display:none; padding-bottom: 20px; }
        #sc-post.show { display:block; }
        
        /* Custom Categories UI */
        #st-cats-list .cat-item { background: #f1f5f9; padding: 8px 12px; border-radius: 20px; margin-bottom: 8px; font-size: 0.9rem; }
        #st-cats-list .cat-item span { cursor:pointer; opacity:0.5; transition:0.2s; }
        #st-cats-list .cat-item span:hover { opacity:1; transform:scale(1.1); }

    </style>
</head>
<body>

<div id="tst"><span>Ù¾ÛŒØ§Ù…</span></div>

<!-- AUTHENTICATION -->
<div id="scr-auth" class="con" style="height:100vh; display:flex; flex-direction:column; justify-content:center; position:relative; z-index:10;">
    <div style="text-align:center; margin-bottom:40px; animation:pop 1s;">
        <div style="font-size:4rem;">ğŸŒ€</div>
        <h1 style="color:var(--p); font-size:2rem;">Ø³ÙˆØ´ÛŒØ§Ù„</h1>
    </div>
    
    <div id="f-log">
        <div class="card">
            <h2 style="text-align:center; margin-bottom:20px; color:var(--pd)">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨</h2>
            <input type="text" id="l-nc" class="inp" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ" inputmode="numeric">
            <input type="password" id="l-ps" class="inp" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
            <div style="margin-bottom:20px; font-size:0.9rem; color:var(--tg)"><label style="display:flex; align-items:center; gap:8px"><input type="checkbox" id="l-rem" checked> Ù…Ø±Ø§ Ø¨Ù‡ Ø®Ø§Ø·Ø± Ø¨Ø³Ù¾Ø§Ø±</label></div>
            <button class="btn btn-p" onclick="app.login(this)">ÙˆØ±ÙˆØ¯</button>
        </div>
        <p style="text-align:center; color:var(--p); cursor:pointer; margin-top:20px; font-weight:bold" onclick="app.togAuth()">Ø«Ø¨Øª Ù†Ø§Ù… Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÛŒØ¯</p>
    </div>

    <div id="f-reg" class="hide">
        <div class="card">
            <h2 style="text-align:center; margin-bottom:20px; color:var(--suc)">Ø«Ø¨Øª Ù†Ø§Ù…</h2>
            <input type="number" id="r-nc" class="inp" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ (Û±Û° Ø±Ù‚Ù…)" inputmode="numeric">
            <input type="text" id="r-nm" class="inp" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ (ÙØ§Ø±Ø³ÛŒ)">
            <input type="text" id="r-us" class="inp" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ (Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒØŒ ÛŒÚ©ØªØ§)">
            <input type="number" id="r-rf" class="inp" placeholder="Ú©Ø¯ Ù…Ø¹Ø±Ù" inputmode="numeric">
            <input type="password" id="r-ps" class="inp" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
            <button class="btn btn-p" style="background:linear-gradient(135deg, var(--suc), #15803d)" onclick="app.reg(this)">ØªÚ©Ù…ÛŒÙ„ Ø«Ø¨Øª Ù†Ø§Ù…</button>
        </div>
        <p style="text-align:center; color:var(--tg); cursor:pointer; margin-top:20px" onclick="app.togAuth()">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ÙˆØ±ÙˆØ¯</p>
    </div>
</div>

<!-- MAIN APP -->
<div id="scr-app" class="hide">
    
    <!-- HOME FEED -->
    <section id="s-hm" class="con">
        <div class="flex-bw" style="margin-bottom:20px; padding:0 5px">
            <h2 style="font-size:1.8rem; color:var(--pd)">Ø®Ø§Ù†Ù‡</h2>
            <div style="font-size:1.5rem; cursor:pointer; position:relative;" onclick="app.showNotifs()">
                ğŸ””
                <span id="notif-badge" class="bdg hide" style="top:-5px; right:-10px;"></span>
            </div> 
        </div>
        <input type="text" id="hm-sr" class="inp" placeholder="ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ (ID)..." onkeyup="app.checkSearch(this)" style="border-radius:20px; border:none; box-shadow:var(--sh)">
        
        <!-- Story/New Users -->
        <div style="margin-bottom:25px; margin-top:15px">
            <h4 style="margin-bottom:12px; font-size:0.85rem; color:var(--tg)">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ</h4>
            <div id="new-bx" style="display:flex; gap:15px; overflow-x:auto; padding:5px 5px 15px 5px; scrollbar-width:none"></div>
        </div>

        <!-- Uploading Post Container -->
        <div id="feed-up"></div> 
        
        <!-- Real Posts / Skeleton Loader -->
        <div id="feed"></div>
        <div id="feed-ldr" style="text-align:center; padding:20px; display:none"><span class="loading" style="color:var(--p)!important"></span></div>
    </section>

    <!-- PROFILE -->
    <section id="s-pr" class="con hide">
        <div class="card" style="border-radius:0 0 30px 30px; margin:-15px -15px 15px -15px; border-top:none; padding-top:40px; background:linear-gradient(to bottom, #fff, #f8fafc)">
            <div class="flex-bw" style="margin-bottom:20px">
                <button class="btn-i" id="bp-bk" onclick="app.nav('hm')">â¬…ï¸</button>
                <h3 id="p-hd" style="font-size:1.1rem"></h3>
                <button class="btn-i" id="btn-p-menu" onclick="event.stopPropagation(); document.getElementById('p-mn').classList.toggle('hide')">â‹®</button>
                <div id="p-mn" class="card hide" style="position:absolute; top:50px; left:20px; width:160px; z-index:10; padding:10px;">
                    <div style="padding:10px; cursor:pointer; border-bottom:1px solid #eee" onclick="app.share('prof')">ğŸ”— Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ</div>
                    <div style="padding:10px; color:var(--err); cursor:pointer" id="btn-block" onclick="app.block()">ğŸš« Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù†</div>
                </div>
            </div>
            
            <div class="p-top">
                <img id="p-im" class="p-pic" src="" onclick="app.viewImg(this.src)" title="Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªØµÙˆÛŒØ±">
                <div class="p-sts">
                    <div onclick="app.list('posts')"><span class="st-n" id="c-pt">0</span><span class="st-l">Ù¾Ø³Øª</span></div>
                    <div onclick="app.list('fol')"><span class="st-n" id="c-fl">0</span><span class="st-l">Ø¯Ù†Ø¨Ø§Ù„â€ŒÚ©Ù†Ù†Ø¯Ù‡</span></div>
                    <div onclick="app.list('fing')"><span class="st-n" id="c-fi">0</span><span class="st-l">Ø¯Ù†Ø¨Ø§Ù„â€ŒØ´ÙˆÙ†Ø¯Ù‡</span></div>
                </div>
            </div>
            
            <div style="padding:0 10px">
                <h3 id="p-nm" style="font-size:1.3rem"></h3>
                <div style="color:var(--tg); font-size:0.95rem; margin-bottom:10px">@<span id="p-id"></span></div>
                <p id="p-bi" style="font-size:0.95rem; line-height:1.6; color:#334155"></p>
                <div id="p-lnk" style="margin-top:10px; font-size:0.9rem; color:var(--p)"></div>
                
                <div class="flex-bw" id="p-act" style="margin-top:20px; gap:12px">
                    <button id="b-fl" class="btn btn-p" onclick="app.fol()">Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù†</button>
                    <button id="b-msg" class="btn btn-o" onclick="app.chat(app.st.vid)">Ù¾ÛŒØ§Ù…</button>
                </div>
            </div>
        </div>

        <div id="p-con">
            <div class="chips">
                <span class="chip active" onclick="app.flt('all',this)">Ù‡Ù…Ù‡ Ù¾Ø³Øªâ€ŒÙ‡Ø§</span>
                <span class="chip" onclick="app.flt('book',this)">ğŸ“š Ú©ØªØ§Ø¨</span>
                <span class="chip" onclick="app.flt('movie',this)">ğŸ¬ ÙÛŒÙ„Ù…</span>
                <span class="chip" onclick="app.flt('site',this)">ğŸŒ Ø³Ø§ÛŒØª</span>
            </div>
            <div id="p-pts" style="padding-bottom:20px"></div>
        </div>
        <div id="p-lck" class="card hide" style="text-align:center; padding:50px;">
            <div style="font-size:3rem; margin-bottom:10px">ğŸ”’</div>
            <h3>Ø­Ø³Ø§Ø¨ Ø®ØµÙˆØµÛŒ Ø§Ø³Øª</h3>
            <p style="color:var(--tg)">Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø³Øªâ€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¯Ù†Ø¨Ø§Ù„ Ú©Ù†ÛŒØ¯.</p>
        </div>
    </section>

    <!-- ADD POST -->
    <section id="s-ad" class="con hide">
        <h2 style="margin-bottom:20px; color:var(--pd)">Ù¾Ø³Øª Ø¬Ø¯ÛŒØ¯</h2>
        <div class="card" id="post-card" style="padding:25px">
            <label style="font-size:0.85rem; color:var(--tg); margin-bottom:5px; display:block">Ø¹Ù†ÙˆØ§Ù† Ù¾Ø³Øª</label>
            <input type="text" id="a-ti" class="inp" placeholder="Ù…Ø«Ù„Ø§: Ù…Ø¹Ø±ÙÛŒ Ú©ØªØ§Ø¨..." style="font-weight:bold">
            
            <label style="font-size:0.85rem; color:var(--tg); margin-bottom:5px; display:block">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
            <select id="a-ct" class="inp">
                <!-- Options are generated dynamically -->
            </select>
            
            <label style="font-size:0.85rem; color:var(--tg); margin-bottom:5px; display:block">Ù…ØªÙ† ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
            <textarea id="a-tx" class="inp" rows="8" placeholder="Ù…ØªÙ† Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯... (Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² Ù…Ù†Ø´Ù† @ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯)" style="resize:none"></textarea>
            
            <!-- Upload Progress UI -->
            <div class="prog-c" id="p-prg"><div class="fill" id="p-fil"></div></div>
            <div class="up-msg" id="p-msg">âœ¨ Ù¾Ø³Øª Ø´Ù…Ø§ Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯!</div>

            <button class="btn btn-p" style="margin-top:15px" onclick="app.pub(this)">Ø§Ù†ØªØ´Ø§Ø± Ù¾Ø³Øª</button>
        </div>
    </section>

    <!-- MESSAGES -->
    <section id="s-ms" class="con hide">
        <div class="flex-bw" style="margin-bottom:20px">
            <h2 style="color:var(--pd)">Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§</h2>
        </div>
        <input type="text" class="inp" placeholder="ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ø´Ù†Ø§Ø³Ù‡ (ID) ÛŒØ§ Ù†Ø§Ù…..." onkeyup="app.filterChats(this.value)" style="margin-bottom: 20px;">
        <div id="req-box"></div> 
        <div id="msg-bx"></div>
        <button id="msg-more" class="btn btn-o hide" onclick="app.loadMoreMsgs()">Ù†Ù…Ø§ÛŒØ´ Ø¨ÛŒØ´ØªØ±</button>
    </section>

    <!-- SETTINGS -->
    <section id="s-st" class="con hide">
        <h2 style="margin-bottom:20px; color:var(--pd)">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h2>
        <div class="card" style="background:linear-gradient(135deg, #3b82f6, #2563eb); color:white; margin-top:15px; border:none">
            <div class="flex-bw"><h3 id="st-nm" style="font-size:1.4rem"></h3> <small id="st-id" style="opacity:0.8"></small></div>
            <div style="margin-top:15px; opacity:0.9">Ú©Ø¯ Ù…Ù„ÛŒ: <span id="st-nc"></span></div>
            <div style="margin-top:8px">Ú©Ø¯ Ø¯Ø¹ÙˆØª: <b id="st-cd" style="font-size:1.3rem; background:rgba(255,255,255,0.2); padding:2px 8px; border-radius:8px"></b></div>
        </div>
        <div class="card">
            <h4 style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px">ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</h4>
            <input type="text" id="st-pc" class="inp" placeholder="Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… ØªØµÙˆÛŒØ± Ù¾Ø±ÙˆÙØ§ÛŒÙ„">
            <input type="text" id="st-nn" class="inp" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ">
            <textarea id="st-bi" class="inp" placeholder="Ø¨ÛŒÙˆÚ¯Ø±Ø§ÙÛŒ Ú©ÙˆØªØ§Ù‡" rows="3"></textarea>
            <input type="text" id="st-ln" class="inp" placeholder="ÙˆØ¨Ø³Ø§ÛŒØª">
            <input type="text" id="st-mn" class="inp" placeholder="Ù…ØªÙ† Ù…Ù†Ø´Ù†">
            
            <div class="flex-bw" style="margin:15px 0; padding:10px 0; border-top:1px solid #eee"><span>ğŸ”’ Ø­Ø³Ø§Ø¨ Ø®ØµÙˆØµÛŒ</span> <input type="checkbox" id="st-pr" style="transform:scale(1.3)"></div>
            <div class="flex-bw" style="margin-bottom:20px"><span>ğŸ’¬ Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…</span> <input type="checkbox" id="st-al" style="transform:scale(1.3)"></div>
            
            <!-- Custom Categories Management (NEW) -->
            <div style="border-top:1px solid #eee; padding-top:15px; margin-top:20px;">
                <h4 style="margin-bottom:15px;">Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ (<span id="cat-count">0</span>/20)</h4>
                <div id="st-cats-list" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:15px;"></div>
                <div class="flex-bw" style="gap:10px;">
                    <input type="text" id="st-new-cat" class="inp" placeholder="Ù†Ø§Ù… Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¬Ø¯ÛŒØ¯..." maxlength="10" style="margin:0;">
                    <button class="btn btn-s btn-p" onclick="app.addCat()">Ø§ÙØ²ÙˆØ¯Ù†</button>
                </div>
            </div>

            <!-- Blocked Users Management (NEW) -->
            <div style="border-top:1px solid #eee; padding-top:15px; margin-top:20px;">
                <h4 style="margin-bottom:15px;">Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡</h4>
                <button class="btn btn-o" onclick="app.listBlocked()">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„ÛŒØ³Øª Ù…Ø³Ø¯ÙˆØ¯ÛŒâ€ŒÙ‡Ø§</button>
            </div>

            <button class="btn btn-p" onclick="app.sav(this)" style="margin-top:20px;">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
            <button class="btn btn-o" style="margin-top:15px; color:var(--err); border-color:var(--err)" onclick="app.out()">Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨</button>
        </div>
    </section>

    <!-- SEARCH RESULTS -->
    <section id="s-sr" class="con hide">
        <h2>Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ</h2>
        <div class="flex-bw" style="gap:10px; margin: 10px 0;">
            <input type="text" id="sr-inp" class="inp" placeholder="Ø´Ù†Ø§Ø³Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..." style="margin:0">
            <button class="btn btn-p" style="width:auto;" onclick="app.doSearch()">ğŸ”</button>
        </div>
        <button class="btn-s btn-o" onclick="app.nav('hm')">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø®Ø§Ù†Ù‡</button>
        <div id="sr-res" style="margin-top:15px"></div>
        <button id="sr-more" class="btn btn-o hide" onclick="app.loadMoreSearch()">Ù†Ù…Ø§ÛŒØ´ Ø¨ÛŒØ´ØªØ±</button>
    </section>

    <!-- SINGLE POST VIEW (NEW) -->
    <div id="sc-post">
        <div class="con">
             <div class="flex-bw" style="margin-bottom:20px">
                <button class="btn-s btn-o" onclick="app.closePostView()">â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø®Ø§Ù†Ù‡</button>
                <h3 style="color:var(--pd)">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø³Øª</h3>
            </div>
            <div id="sc-post-content"></div>
        </div>
    </div>

    <!-- BOTTOM NAV -->
    <div class="nav">
        <div class="n-it active" id="n-hm" onclick="app.nav('hm')">ğŸ </div>
        <div class="n-it" id="n-ad" onclick="app.nav('ad')">â•</div>
        <div class="n-it" id="n-ms" onclick="app.nav('ms')">ğŸ’¬ <span id="b-nv" class="bdg hide"></span></div>
        <div class="n-it" id="n-pr" onclick="app.nav('pr')">ğŸ‘¤</div>
        <div class="n-it" id="n-st" onclick="app.nav('st')">âš™ï¸</div>
    </div>
</div>

<!-- MODALS -->
<div id="m-sh" class="mod-bg" onclick="if(event.target==this) this.classList.remove('show')">
    <div class="mod">
        <h3>Ø§Ø´ØªØ±Ø§Ú© Ú¯Ø°Ø§Ø±ÛŒ</h3>
        <div style="margin-top:25px; display:flex; flex-direction:column; gap:10px">
            <button class="btn btn-o" onclick="app.copyLink()">ğŸ”— Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†Ú©</button>
            <button class="btn btn-p" onclick="app.doSh()">ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ù„ÛŒÙ†Ú©</button>
        </div>
    </div>
</div>

<div id="m-pk" class="mod-bg" onclick="if(event.target==this) this.classList.remove('show')">
    <div class="mod"><h3 id="pk-tt">Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡...</h3><input type="text" class="inp" onkeyup="app.flP(this.value)" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ø´Ù†Ø§Ø³Ù‡ (ID) ÛŒØ§ Ù†Ø§Ù…..." style="margin-top:10px"><div id="pk-ls" style="max-height:300px; overflow-y:auto; margin-top:10px"></div></div>
</div>

<div id="m-ls" class="mod-bg" onclick="if(event.target==this) this.classList.remove('show')">
    <div class="mod">
        <h3 id="ls-tt">Ù„ÛŒØ³Øª</h3>
        <div id="ls-bd" style="margin-top:15px; max-height:400px; overflow-y:auto"></div>
        <button id="ls-more" class="btn btn-o hide" onclick="app.loadMoreList()">Ù†Ù…Ø§ÛŒØ´ Ø¨ÛŒØ´ØªØ±</button>
    </div>
</div>

<div id="m-cm" class="mod-bg" onclick="if(event.target==this) this.classList.remove('show')">
    <div class="mod">
        <h3>Ù†Ø¸Ø±Ø§Øª</h3>
        <div id="cm-bd" style="height:350px; overflow-y:auto; margin:15px 0; background:#f8fafc; border-radius:15px; padding:10px; border:1px solid #eee"></div>
        <div class="flex-bw" style="gap:10px"><input type="text" id="cm-in" class="inp" placeholder="Ù†Ø¸Ø± Ø´Ù…Ø§..." style="margin:0"><button class="btn btn-p" style="width:50px" onclick="app.sndC(this)">â¤</button></div>
    </div>
</div>

<div id="m-nt" class="mod-bg" onclick="if(event.target==this) this.classList.remove('show')">
    <div class="mod">
        <h3>ğŸ”” Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§</h3>
        <div id="nt-bd" style="margin-top:15px; max-height:400px; overflow-y:auto"></div>
        <button id="nt-more" class="btn btn-o hide" onclick="app.loadMoreNotifs()">Ù†Ù…Ø§ÛŒØ´ Ø¨ÛŒØ´ØªØ±</button>
    </div>
</div>

<!-- NEW IMAGE VIEWER MODAL -->
<div id="m-img" class="mod-bg" onclick="this.classList.remove('show')">
    <img id="img-vw" src="" onclick="event.stopPropagation()">
</div>

<!-- CHAT SCREEN (FULL PAGE) -->
<div id="sc-ch">
    <div class="card" style="margin:0; border-radius:0; border-bottom:1px solid var(--bor); padding:15px; display:flex; align-items:center; gap:15px; background:rgba(255,255,255,0.95); backdrop-filter:blur(10px)">
        <button class="btn-i" onclick="document.getElementById('sc-ch').classList.remove('show')">â¬…ï¸</button>
        <div id="ch-inf" style="flex:1; cursor:pointer; display:flex; align-items:center; gap:10px" onclick="app.nav('pr', app.st.cpid)">
            <img id="ch-im" src="" style="width:40px; height:40px; border-radius:50%; background:#eee">
            <div>
                <div style="font-weight:bold; font-size:1rem" id="ch-hd"></div>
                <div style="font-size:0.75rem; color:green" id="ch-st">Ø¢Ù†Ù„Ø§ÛŒÙ†</div>
            </div>
        </div>
    </div>
    <div id="ch-bx" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:4px; background:var(--bg)"></div>
    <div style="padding:15px; background:white; display:flex; gap:10px; border-top:1px solid var(--bor)">
        <input type="text" id="ch-in" class="inp" style="margin:0; border-radius:25px" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." onkeyup="if(event.key==='Enter') app.sndM()">
        <button class="btn btn-p" style="width:50px; border-radius:50%; height:50px" onclick="app.sndM()">â¤</button>
    </div>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyf_X4VQfe1YC95wWXkUkFrHAHDOCTmC6qzzsNCp-O57HvGikcAPZWlPAbS_9_kWrYI/exec';

    const app = {
        st: { user:null, users:[], posts:[], msgs:[], vid:null, shr:null, cpid:null, guest:false, page:1, limit:20, syncing:false, postToSend: null, pickerMode: null, searchLimit: 10, tempUsers: [], listType: null, listData: [], listLimit: 20, notifLimit: 20, msgLimit: 20 },
        
        init: async function() {
            this.showInitialSkeletons();
            if(localStorage.getItem('db')) {
                const db = JSON.parse(localStorage.getItem('db'));
                this.st.users=db.users||[]; this.st.posts=db.posts||[]; this.st.msgs=db.msgs||[];
            }
            const uid = localStorage.getItem('uid');
            if(uid) {
                const u = this.st.users.find(x=>x.id===uid);
                if(u) { this.st.user=u; this.start(); this.sync(true); }
                else { document.getElementById('scr-auth').classList.remove('hide'); }
            } else {
                document.getElementById('scr-auth').classList.remove('hide');
            }

            const p = new URLSearchParams(location.search);
            const showUser = p.get('u');
            const showPost = p.get('p');

            setTimeout(() => {
                if (showUser) {
                    this.nav('pr', showUser);
                } else if (showPost) {
                    this.showPost(showPost);
                }
            }, 1500);

            setInterval(() => { if(!document.getElementById('scr-app').classList.contains('hide')) app.sync(false); }, 4000);

            // Close Menu when clicking outside
            window.addEventListener('click', function(e) {
                if (!e.target.matches('.btn-i') && !e.target.closest('#p-mn')) {
                     document.getElementById('p-mn').classList.add('hide');
                }
            });

            window.onscroll = () => {
                if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
                    // Logic to load more posts on scroll
                    const isHome = !document.getElementById('s-hm').classList.contains('hide');
                    const isProfile = !document.getElementById('s-pr').classList.contains('hide');
                    
                    if (isHome || isProfile) {
                        // Increase limit by 20 (as requested)
                        if(this.st.limit < this.st.posts.length) {
                            this.st.limit += 20;
                            if(isHome) this.feed();
                            if(isProfile) this.flt(document.querySelector('.chip.active') ? document.querySelector('.chip.active').innerText.includes('Ù‡Ù…Ù‡') ? 'all' : 'other' : 'all', document.querySelector('.chip.active'));
                        }
                    }
                }
            };
            
            // Handle Browser Back Button for Single Post View
            window.addEventListener('popstate', (event) => {
                if (!event.state || !event.state.pid) {
                    document.getElementById('sc-post').classList.remove('show');
                } else if (event.state.pid) {
                    this.showPost(event.state.pid, false);
                }
            });
        },

        call: async function(act, pl) {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    redirect: "follow",
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: act, payload: pl })
                });
                return await res.json();
            } catch(e) { console.error(e); return {status:'error'}; }
        },

        sync: async function(initial) {
            if(this.st.syncing) return;
            this.st.syncing = true;
            const d = await this.call('getAll', {});
            this.st.syncing = false;
            
            if(d.status === 'success') {
                this.st.users = d.users;
                d.posts.forEach(np => {
                    const op = this.st.posts.find(p=>p.pid===np.pid);
                    if(op) { 
                        op.likes = np.likes; 
                        op.comments = np.comments;
                    } else {
                        this.st.posts.unshift(np);
                    }
                });
                
                // Update msgs safely to preserve local 'sent' state
                d.msgs.forEach(nm => {
                    const om = this.st.msgs.find(m => m.from === nm.from && m.to === nm.to && m.time === nm.time);
                    if (om) {
                        om.read = nm.read;
                    } else {
                        this.st.msgs.push(nm);
                    }
                });
                
                localStorage.setItem('db', JSON.stringify({users:this.st.users, posts:this.st.posts, msgs:this.st.msgs}));
                if(this.st.user && !this.st.guest) {
                    const freshMe = this.st.users.find(u=>u.id===this.st.user.id);
                    if(freshMe) this.st.user = freshMe;
                    this.bdg();
                    this.updateNotifBadge(); // Update notification badge on sync
                }
                if(!document.getElementById('s-hm').classList.contains('hide')) this.feed(); 
                if(document.getElementById('sc-ch').classList.contains('show')) this.rnC(); 
                if(!document.getElementById('s-ms').classList.contains('hide')) this.msg();
            }
        },

        togAuth: () => { document.getElementById('f-log').classList.toggle('hide'); document.getElementById('f-reg').classList.toggle('hide'); },
        login: async function(btn) {
            const nc=document.getElementById('l-nc').value, pass=document.getElementById('l-ps').value;
            if(!nc || !pass) return this.notif('Ù„Ø·ÙØ§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§ Ú©Ø§Ù…Ù„ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'err');
            btn.innerHTML = '<span class="loading"></span>';
            const d = await this.call('login', {nc, pass});
            if(d.status === 'success') {
                this.st.user = d.user;
                if(document.getElementById('l-rem').checked) localStorage.setItem('uid', d.user.id);
                this.start(); this.sync(true);
            } else { this.notif(d.msg, 'err'); btn.innerHTML='ÙˆØ±ÙˆØ¯'; }
        },
        reg: async function(btn) {
            const p = {
                id:document.getElementById('r-us').value.toLowerCase(), 
                nc:document.getElementById('r-nc').value,
                pass:document.getElementById('r-ps').value, 
                name:document.getElementById('r-nm').value,
                refCode:document.getElementById('r-rf').value
            };
            if(!p.id || !p.nc || !p.pass) return this.notif('Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª', 'err');
            btn.innerHTML = '<span class="loading"></span>';
            const d = await this.call('register', p);
            if(d.status === 'success') { this.notif('Ø«Ø¨Øª Ù†Ø§Ù… Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù…ÛŒØ² Ø¨ÙˆØ¯', 'suc'); this.togAuth(); }
            else { this.notif(d.msg, 'err'); btn.innerHTML='ØªÚ©Ù…ÛŒÙ„ Ø«Ø¨Øª Ù†Ø§Ù…'; }
        },
        out: () => { localStorage.removeItem('uid'); location.reload(); },
        start: function() {
            document.getElementById('scr-auth').classList.add('hide');
            document.getElementById('scr-app').classList.remove('hide');
            this.nav('hm');
        },

        nav: function(p, arg) {
            document.querySelectorAll('section').forEach(s=>s.classList.add('hide'));
            document.querySelectorAll('.n-it').forEach(i=>i.classList.remove('active'));
            
            document.getElementById('sc-ch').classList.remove('show');
            document.getElementById('sc-post').classList.remove('show'); // Close post view on nav
            document.querySelector('#m-cm').classList.remove('show');

            if(p==='hm') { 
                document.getElementById('s-hm').classList.remove('hide'); 
                document.getElementById('n-hm').classList.add('active');
                document.getElementById('hm-sr').value = ''; // Clear search bar on home nav
                if (this.st.posts.length === 0) { document.getElementById('feed').innerHTML = this.htmlSkelPost(3); }
                else { this.feed(); }
            }
            else if(p==='pr') { 
                document.getElementById('s-pr').classList.remove('hide'); 
                if(!arg || (this.st.user && arg===this.st.user.id)) document.getElementById('n-pr').classList.add('active');
                document.getElementById('p-pts').innerHTML = this.htmlSkelPost(2);
                this.prof(arg||this.st.user.id);
            }
            else if(p==='ad') { 
                document.getElementById('s-ad').classList.remove('hide'); 
                document.getElementById('n-ad').classList.add('active'); 
                this.populateCategories(); // Populate categories on showing the page
            }
            else if(p==='ms') { 
                document.getElementById('s-ms').classList.remove('hide'); 
                document.getElementById('n-ms').classList.add('active'); 
                document.getElementById('msg-bx').innerHTML = this.htmlSkelUser(3);
                this.msg(); 
            }
            else if(p==='st') { 
                document.getElementById('s-st').classList.remove('hide'); 
                document.getElementById('n-st').classList.add('active'); 
                this.sets(); 
            }
             else if(p==='sr') { document.getElementById('s-sr').classList.remove('hide'); }
        },

        feed: function() {
            const c = document.getElementById('feed'), nb = document.getElementById('new-bx');
            nb.innerHTML='';
            this.st.users.filter(u=>u.id!==this.st.user.id).slice(-6).forEach(u=>{
                const img = u.pic ? `<img src="${u.pic}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">` : u.name[0];
                nb.innerHTML += `<div style="min-width:75px;text-align:center;cursor:pointer" onclick="app.nav('pr','${u.id}')">
                    <div style="width:55px;height:55px;border-radius:50%;background:linear-gradient(45deg,#f09433,#bc1888);padding:2px;margin:auto"><div style="width:100%;height:100%;background:white;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;font-weight:bold">${img}</div></div>
                    <div style="font-size:0.75rem;margin-top:5px;overflow:hidden;text-overflow:ellipsis">${u.name.split(' ')[0]}</div></div>`;
            });

            let visiblePosts = this.st.posts.filter(p=>{
                const au = this.st.users.find(u=>u.id===p.uid); if(!au) return false;
                return !au.isPrivate || this.st.user.following.includes(p.uid) || p.uid===this.st.user.id;
            });
            
            visiblePosts.sort((a,b)=>b.time-a.time);
            
            const renderList = visiblePosts.slice(0, this.st.limit);
            let html = '';
            renderList.forEach(p => html += this.htmlP(p));
            
            if(c.innerHTML !== html) c.innerHTML = html;
            
            if(visiblePosts.length > this.st.limit) document.getElementById('feed-ldr').style.display='block';
            else document.getElementById('feed-ldr').style.display='none';
        },
        
        showPost: function(pid, pushState = true) {
            if (this.st.posts.length === 0) {
                setTimeout(() => this.showPost(pid, pushState), 500);
                return;
            }
            const post = this.st.posts.find(p => p.pid === pid);
            if (!post) {
                this.notif('Ù¾Ø³Øª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯', 'err');
                return;
            }
            const author = this.st.users.find(u => u.id === post.uid);
            const canView = !author || author.id === this.st.user.id || !author.isPrivate || (author.isPrivate && this.st.user.following.includes(author.id));

            if (!canView) {
                this.nav('pr', author.id);
                this.notif('Ø§ÛŒÙ† Ù¾Ø³Øª Ø®ØµÙˆØµÛŒ Ø§Ø³Øª', 'err');
                return;
            }

            // Close other modals and screens
            document.getElementById('sc-ch').classList.remove('show');
            document.getElementById('m-nt').classList.remove('show');
            document.getElementById('m-ls').classList.remove('show');
            document.getElementById('m-pk').classList.remove('show');

            // Show Single Post View Screen
            const postScreen = document.getElementById('sc-post');
            const postContent = document.getElementById('sc-post-content');
            
            postContent.innerHTML = this.htmlP(post);
            postScreen.classList.add('show');
            
            if (pushState) {
                const url = new URL(window.location);
                url.searchParams.set('p', pid);
                window.history.pushState({pid: pid}, '', url);
            }
        },

        closePostView: function() {
            document.getElementById('sc-post').classList.remove('show');
            const url = new URL(window.location);
            url.searchParams.delete('p');
            window.history.pushState({}, '', url);
            this.nav('hm');
        },
        
        // NEW FUNCTION: VIEW IMAGE
        viewImg: function(src) {
            if(!src || src.includes('undefined')) return;
            document.getElementById('img-vw').src = src;
            document.getElementById('m-img').classList.add('show');
        },

        htmlU: (uid) => {
            const u = app.st.users.find(x=>x.id===uid); if(!u) return 'Ú©Ø§Ø±Ø¨Ø± Ø­Ø°Ù Ø´Ø¯Ù‡';
            const i = u.pic ? `<img class="u-img" src="${u.pic}">` : `<div class="u-img" style="display:flex;align-items:center;justify-content:center;background:#cbd5e1;font-weight:bold">${u.name[0]}</div>`;
            return `<div class="u-blk" onclick="event.stopPropagation();app.nav('pr','${u.id}')">${i}<div class="u-in"><div class="u-nm">${u.name}</div><div class="u-id">@${u.id}</div></div></div>`;
        },
        
        htmlP: (p) => {
            const lk = p.likes.includes(app.st.user.id) ? 'lk' : '';
            
            let contentHtml = '';
            const maxLength = 500; // CHANGED FROM 100 TO 500
            if (p.text.length > maxLength) {
                const shortText = p.text.substring(0, maxLength) + '... ';
                contentHtml = `
                    <span id="txt-s-${p.pid}">${app.autoLinker(shortText)}<b style="cursor:pointer;color:var(--p);display:inline-block;margin-right:5px;" onclick="app.readMore('${p.pid}')">Ø¨ÛŒØ´ØªØ±</b></span>
                    <span id="txt-f-${p.pid}" class="hide">${app.autoLinker(p.text)}</span>
                `;
            } else {
                contentHtml = app.autoLinker(p.text);
            }

            const postDate = new Date(p.time).toLocaleDateString('fa-IR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });

            // CHANGED: Date moved to bottom, Text paragraph forced RTL/Block
            return `<div class="card" id="p-${p.pid}">
                <div class="flex-bw">
                    ${app.htmlU(p.uid)} 
                    <div style="text-align:left">
                        <span style="font-size:0.7rem;background:#e0f2fe;color:#0284c7;padding:3px 10px;border-radius:10px">${p.cat||'Ø¹Ù…ÙˆÙ…ÛŒ'}</span>
                    </div>
                </div>
                <h4 style="margin-top:12px;font-size:1.05rem">${p.title}</h4>
                <p style="margin-top:8px;line-height:1.7;font-size:0.95rem;white-space:pre-wrap;color:#334155;text-align:right;direction:rtl;display:block;unicode-bidi:embed;">${contentHtml}</p>
                
                <div style="font-size:0.7rem; color:var(--tg); text-align:right; margin-top:15px; padding-bottom:5px; border-bottom:1px solid #f1f5f9;">${postDate}</div>
                
                <div class="p-act">
                    <div class="act-b ${lk}" id="lb-${p.pid}"><span onclick="app.like('${p.pid}')">${lk?'â¤ï¸':'ğŸ¤'}</span> <span id="ln-${p.pid}" onclick="app.showLikes('${p.pid}', event)" style="margin-right:5px;min-width:10px">${p.likes.length}</span></div>
                    <div class="act-b" onclick="app.comm('${p.pid}')">ğŸ’¬ ${p.comments.length}</div>
                    <div class="act-b" onclick="app.copyPostLink('${p.pid}')" title="Ú©Ù¾ÛŒ Ù„ÛŒÙ†Ú© Ù¾Ø³Øª">ğŸ“‹</div>
                    <div class="act-b" onclick="app.openSendPostModal('${p.pid}')" title="Ø§Ø±Ø³Ø§Ù„ Ù¾Ø³Øª Ø¨Ù‡ Ø¯ÙˆØ³ØªØ§Ù†">â¤</div>
                    <div class="act-b" onclick="app.share('post','${p.pid}')" title="Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ">ğŸ“¤</div>
                </div></div>`;
        },

        readMore: function(pid) {
            document.getElementById('txt-s-' + pid).classList.add('hide');
            document.getElementById('txt-f-' + pid).classList.remove('hide');
        },

        pub: async function(btn) {
            const p = { 
                pid: this.st.user.id + '_' + Date.now(), 
                uid: this.st.user.id, 
                title: document.getElementById('a-ti').value, 
                cat: document.getElementById('a-ct').value, 
                text: document.getElementById('a-tx').value, 
                time: Date.now(),
                likes: [], comments: [] 
            };
            if(!p.title || !p.text) return this.notif('Ø¹Ù†ÙˆØ§Ù† Ùˆ Ù…ØªÙ† Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª', 'err');
            this.nav('hm');
            window.scrollTo(0,0);
            const upBox = document.getElementById('feed-up');
            upBox.innerHTML = `
                <div class="card sending" style="border:2px solid var(--p)">
                    <div class="flex-bw">${this.htmlU(p.uid)}</div>
                    <h4>${p.title}</h4>
                    <div class="prog-c" style="display:block"><div class="fill" style="width:0%"></div></div>
                    <div class="up-msg" style="color:var(--p)">Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ù„ÙˆØ¯...</div>
                </div>
            `;
            const fill = upBox.querySelector('.fill');
            setTimeout(()=>fill.style.width='30%', 100);
            setTimeout(()=>fill.style.width='70%', 800);
            try {
                await this.call('createPost', { ...p, likes:[], comments:[] });
                fill.style.width='100%';
                upBox.querySelector('.up-msg').innerText = 'Ù¾Ø³Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ âœ“';
                upBox.querySelector('.up-msg').style.display = 'block';
                upBox.querySelector('.up-msg').style.color = 'green';
                this.st.posts.unshift(p);
                document.getElementById('a-ti').value=''; document.getElementById('a-tx').value='';
                setTimeout(() => {
                    upBox.innerHTML = '';
                    this.feed();
                }, 1500);
            } catch(e) {
                upBox.innerHTML = '<div class="card" style="color:red">Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾Ø³Øª. Ù„Ø·ÙØ§ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.</div>';
            }
        },
        like: function(pid) {
            const p = this.st.posts.find(x=>x.pid===pid);
            const uid = this.st.user.id;
            const btn = document.getElementById('lb-'+pid);
            const num = document.getElementById('ln-'+pid);
            let liked = p.likes.includes(uid);
            if(liked) {
                p.likes = p.likes.filter(x=>x!==uid);
                btn.classList.remove('lk');
                btn.querySelector('span').innerText = 'ğŸ¤';
            } else {
                p.likes.push(uid);
                btn.classList.add('lk');
                btn.querySelector('span').innerText = 'â¤ï¸';
            }
            num.innerText = p.likes.length;
            this.call('updatePost', {pid, likes:p.likes, comments:p.comments});
        },
        showLikes: function(pid, e) {
            if(e) e.stopPropagation();
            const p = this.st.posts.find(x=>x.pid===pid);
            if(!p || !p.likes.length) return this.notif('Ù‡Ù†ÙˆØ² Ú©Ø³ÛŒ Ø§ÛŒÙ† Ù¾Ø³Øª Ø±Ø§ Ù„Ø§ÛŒÚ© Ù†Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª', 'err');
            
            const b = document.getElementById('ls-bd'); b.innerHTML = '';
            document.getElementById('ls-tt').innerText = 'Ù„Ø§ÛŒÚ©â€ŒÚ©Ù†Ù†Ø¯Ú¯Ø§Ù†';
            
            p.likes.forEach(uid => {
                b.innerHTML += `<div style="margin-bottom:10px">${app.htmlU(uid)}</div>`;
            });
            
            document.getElementById('m-ls').classList.add('show');
        },
        comm: function(pid) {
            this.st.cpid = pid;
            const p = this.st.posts.find(x=>x.pid===pid);
            const b = document.getElementById('cm-bd');
            b.innerHTML = p.comments.length ? '' : '<p style="text-align:center;color:gray;margin-top:20px">Ù‡Ù†ÙˆØ² Ù†Ø¸Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>';
            p.comments.forEach(c => {
                b.innerHTML += `<div class="card" style="padding:12px; box-shadow:none; border-bottom:1px solid #eee; border-radius:0;">
                    ${this.htmlU(c.uid)}
                    <p style="font-size:0.9rem; margin-top:8px; padding-right:60px;">${app.autoLinker(c.text)}</p>
                </div>`;
            });
            document.getElementById('m-cm').classList.add('show');
        },
        sndC: function(btn) {
            const txt = document.getElementById('cm-in').value;
            if(!txt) return;
            const p = this.st.posts.find(x=>x.pid===this.st.cpid);
            const newCm = {uid:this.st.user.id, text:txt, time: Date.now()}; // Add time for sorting notifications
            p.comments.push(newCm);
            const b = document.getElementById('cm-bd');
            if(b.innerHTML.includes('Ù‡Ù†ÙˆØ² Ù†Ø¸Ø±ÛŒ')) b.innerHTML='';
            const tempHTML = `<div style="background:white;padding:12px;border-radius:12px;margin-bottom:8px;opacity:0.6;border:1px solid var(--p)">
                    ${this.htmlU(this.st.user.id)}
                    <p style="font-size:0.9rem; margin-top:8px; padding-right:60px;">${this.autoLinker(txt)} <span style="font-size:0.7rem;color:var(--p)">(Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...)</span></p>
                </div>`;
            b.insertAdjacentHTML('beforeend', tempHTML);
            b.scrollTop=b.scrollHeight;
            document.getElementById('cm-in').value='';
            this.call('updatePost', {pid:p.pid, likes:p.likes, comments:p.comments}).then(()=>{
                this.comm(this.st.cpid); 
            });
        },
        fol: function() {
            const uid = this.st.vid; const me = this.st.user; const u = this.st.users.find(x=>x.id===uid);
            const btn = document.getElementById('b-fl');
            let action = 'follow'; 
            if(me.following.includes(uid)) action = 'unfollow';
            if(action==='follow') {
                if(u.isPrivate) {
                    if (!u.requests.includes(me.id)) u.requests.push(me.id);
                    btn.innerText = 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯'; btn.className = 'btn btn-o';
                } else {
                    if (!me.following.includes(uid)) me.following.push(uid);
                    if (!u.followers.includes(me.id)) u.followers.push(me.id);
                    btn.innerText = 'Ù„ØºÙˆ Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù†'; btn.className = 'btn btn-o';
                }
            } else {
                me.following = me.following.filter(x=>x!==uid); 
                u.followers = u.followers.filter(x=>x!==me.id); 
                u.requests = u.requests.filter(x=>x!==me.id);
                btn.innerText = 'Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù†'; btn.className = 'btn btn-p';
            }
            document.getElementById('c-fl').innerText = u.followers.length;
            this.call('updateUser', [me, u]);
        },

        msg: function() {
            const reqBox = document.getElementById('req-box');
            const msgBox = document.getElementById('msg-bx');
            reqBox.innerHTML = '';
            msgBox.innerHTML = '';
            
            if (this.st.user.requests && this.st.user.requests.length > 0) {
                reqBox.innerHTML += '<h4 style="margin:15px 5px 10px;color:var(--tg);font-size:0.9rem;">Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù†</h4>';
                this.st.user.requests.forEach(rid => {
                    const u = this.st.users.find(x => x.id === rid);
                    if (u) {
                        reqBox.innerHTML += `<div class="card flex-bw">${this.htmlU(rid)}<div><button class="btn-s btn-p" onclick="app.ans('${rid}',true)">Ù¾Ø°ÛŒØ±ÙØªÙ†</button> <button class="btn-s btn-o" onclick="app.ans('${rid}',false)" style="margin-right:5px">Ø±Ø¯</button></div></div>`;
                    }
                });
            }
            
            const chats = [...new Set(this.st.msgs.filter(x => x.from === this.st.user.id || x.to === this.st.user.id).map(x => x.from === this.st.user.id ? x.to : x.from))];
            
            // Limit Chat List
            const limitedChats = chats.slice(0, this.st.msgLimit);

            if (chats.length === 0 && (!this.st.user.requests || this.st.user.requests.length === 0)) {
                msgBox.innerHTML = '<div style="text-align:center;padding:50px;color:gray"><div style="font-size:3rem">ğŸ’¬</div><p>Ù‡Ù†ÙˆØ² Ù¾ÛŒØ§Ù…ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</p></div>';
            } else {
                msgBox.innerHTML += '<h4 style="margin:15px 5px 10px;color:var(--tg);font-size:0.9rem;">Ú¯ÙØªÚ¯ÙˆÙ‡Ø§</h4>';
            }
            
            limitedChats.forEach(pid => {
                const u = this.st.users.find(x => x.id === pid);
                if (!u) return;

                const conv = this.st.msgs.filter(x => (x.from === this.st.user.id && x.to === pid) || (x.from === pid && x.to === this.st.user.id));
                if (conv.length === 0) return;
                const last = conv.sort((a,b) => b.time - a.time)[0];
                const unread = conv.filter(x => x.from === pid && x.to === this.st.user.id && !x.read).length;
                
                let tick = '';
                if (last.from === this.st.user.id) {
                     if(last.read) tick = '<span class="tik read">âœ“âœ“</span>';
                     else if(last.sent || last.id) tick = '<span class="tik sent">âœ“</span>'; // Fixed Logic
                     else tick = '<span class="tik wait">ğŸ•“</span>';
                }

                let lastMsgText = '...';
                try {
                    const parsed = JSON.parse(last.text);
                    if (parsed.type === 'shared_post') {
                        lastMsgText = 'ÛŒÚ© Ù¾Ø³Øª Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ø±Ø¯';
                    } else {
                        lastMsgText = last.text;
                    }
                } catch(e) {
                    lastMsgText = last.text;
                }

                msgBox.innerHTML += `
                <div class="card" onclick="app.chat('${pid}')" style="cursor:pointer; padding: 12px;" data-chat-id="${u.id}">
                    <div class="flex-bw">
                        ${this.htmlU(u.id)}
                        <small style="font-size:0.7rem;color:var(--tg); align-self: flex-start;">${new Date(last.time).toLocaleTimeString('fa-IR', {hour:'2-digit',minute:'2-digit'})}</small>
                    </div>
                    <div class="flex-bw" style="margin-top:8px; padding-right: 60px;">
                        <p style="color:${unread ? 'var(--t)' : 'var(--tg)'}; font-size:0.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 85%; font-weight:${unread ? 'bold':'normal'}">
                            ${tick} ${lastMsgText}
                        </p>
                        ${unread > 0 ? `<span class="bdg" style="position:static;font-size:0.75rem;padding:2px 8px;border-radius:12px;">${unread}</span>` : ''}
                    </div>
                </div>`;
            });
            
            if(chats.length > this.st.msgLimit) {
                document.getElementById('msg-more').classList.remove('hide');
            } else {
                document.getElementById('msg-more').classList.add('hide');
            }
        },
        
        loadMoreMsgs: function() {
            this.st.msgLimit += 20;
            this.msg();
        },
        
        chat: function(uid) {
            const u = this.st.users.find(x=>x.id===uid);
            
            // Check allowing message logic
            // Allow if (User allows it) OR (We have a history)
            const me = this.st.user;
            const hasHistory = this.st.msgs.some(m => (m.from === me.id && m.to === uid) || (m.from === uid && m.to === me.id));
            
            if(!u.allowMsg && !u.following.includes(me.id) && !hasHistory) return this.notif('Ø§Ù…Ú©Ø§Ù† Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', 'err');
            
            this.st.cpid = uid;
            document.getElementById('sc-ch').classList.add('show');
            document.getElementById('ch-hd').innerText = u.name;
            document.getElementById('ch-im').src = u.pic || '';
            
            this.rnC();
            
            const unread = this.st.msgs.filter(x=>x.from===uid && x.to===this.st.user.id && !x.read);
            if(unread.length > 0) {
                unread.forEach(m => m.read=true);
                this.bdg();
                this.call('readMsg', {target: uid, me: this.st.user.id});
            }
        },
        
        rnC: function() {
            const b=document.getElementById('ch-bx'); 
            b.innerHTML='';
            
            const ms = this.st.msgs.filter(x=>(x.from==this.st.user.id&&x.to==this.st.cpid)||(x.from==this.st.cpid&&x.to==this.st.user.id));
            
            ms.forEach((x, index)=>{ 
                const mine = x.from===this.st.user.id;
                let tick = '';
                if(mine) {
                     if(x.read) tick = '<span class="tik read">âœ“âœ“</span>';
                     else if(x.sent || x.id) tick = '<span class="tik sent">âœ“</span>'; // Fixed Logic
                     else tick = '<span class="tik wait">ğŸ•“</span>';
                }

                let msgContent = '';
                try {
                    const parsed = JSON.parse(x.text);
                    if (parsed.type === 'shared_post' && parsed.pid) {
                        msgContent = this.htmlSharedPost(parsed.pid);
                    } else {
                        throw new Error("Not a shared post");
                    }
                } catch (e) {
                    // Long Message Logic
                    const txt = x.text;
                    const maxLen = 500;
                    if(txt.length > maxLen) {
                         const shortTxt = app.autoLinker(txt.substring(0, maxLen)) + '... ';
                         msgContent = `
                            <span id="msg-s-${index}">${shortTxt}<b style="cursor:pointer;color:var(--p)" onclick="document.getElementById('msg-s-${index}').classList.add('hide');document.getElementById('msg-f-${index}').classList.remove('hide')">Ø¨ÛŒØ´ØªØ±</b></span>
                            <span id="msg-f-${index}" class="hide">${app.autoLinker(txt)}</span>
                         `;
                    } else {
                        msgContent = this.autoLinker(txt);
                    }
                }
                
                b.innerHTML += `<div class="msg-bub ${mine?'msg-me':'msg-ot'}">
                    ${msgContent}
                    <div class="msg-tm">${tick} ${new Date(x.time).toLocaleTimeString('fa-IR', {hour:'2-digit',minute:'2-digit'})}</div>
                </div>`; 
            });
            b.scrollTop=b.scrollHeight;
        },
        
        sndM: async function() {
            const t = document.getElementById('ch-in').value; if(!t) return;
            
            const m = {from:this.st.user.id, to:this.st.cpid, text:t, time:Date.now(), read:false}; 
            this.st.msgs.push(m);
            
            this.rnC();
            document.getElementById('ch-in').value='';

            try {
                const res = await this.call('createMsg', m);
                // Set sent flag locally
                m.sent = true;
                this.rnC();
            } catch(e) {
                this.notif('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…', 'err');
            }
        },

        notif: (t, s) => { 
            const b=document.getElementById('tst'); 
            b.innerHTML = (s==='err'?'â›” ':'âœ… ') + t; 
            b.style.background = s==='err'?'#ef4444':'#0f172a';
            b.classList.add('show'); 
            setTimeout(()=>b.classList.remove('show'), 3000); 
        },
        
        autoLinker: function(t) {
            if(!t) return '';
            let text = t;
            // Internal Post Links (?p=...)
            const postLinkRegex = new RegExp(location.origin + location.pathname + '\\?p=([a-zA-Z0-9_]+)', 'g');
            text = text.replace(postLinkRegex, (match, pid) => {
                 return `<span class="url-link" onclick="event.preventDefault(); event.stopPropagation(); app.showPost('${pid}')">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø³Øª</span>`;
            });

            // Normal URLs
            const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\b[A-Z0-9.-]+\.[A-Z]{2,4}\b)/ig;
            text = text.replace(urlRegex, function(url) {
                if(url.includes('?p=')) return url; // Skip if already processed
                let href = url;
                if (!href.match(/^[a-zA-Z]+:\/\//)) {
                    href = 'https://' + href;
                }
                return `<a href="${href}" class="url-link" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()">${url}</a>`;
            });
            
            // Linkify mentions
            const mentionRegex = /@(\w+)/g;
            text = text.replace(mentionRegex, (match, username) => {
                const u = this.st.users.find(x => x.id === username.toLowerCase());
                if (u) {
                    return `<span class="ment" onclick="event.stopPropagation();app.nav('pr','${u.id}')">${match}</span>`;
                }
                return match;
            });
            return text;
        },
        
        bdg: () => {
            const r= (this.st.user.requests && this.st.user.requests.length) || 0;
            const u=this.st.msgs.filter(x=>x.to===this.st.user.id && !x.read).length;
            
            const b1=document.getElementById('b-nv');
            if(r+u>0) { b1.innerText=r+u; b1.classList.remove('hide'); } else b1.classList.add('hide');
        },

        prof: function(uid) {
            const u = this.st.users.find(x=>x.id===uid);
            if (!u) {
              return this.notif('Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯', 'err');
            }
            const me = this.st.user; this.st.vid = uid; const isMe = uid === me.id;
            document.getElementById('bp-bk').classList.toggle('hide', isMe);
            document.getElementById('p-im').src = u.pic||''; 
            document.getElementById('p-nm').innerText = u.name; document.getElementById('p-id').innerText = u.id;
            document.getElementById('p-bi').innerHTML = this.autoLinker(u.bio);
            
            const lnk = document.getElementById('p-lnk'); lnk.innerHTML='';
            if(u.web) lnk.innerHTML = `<div>ğŸŒ ${this.autoLinker(u.web)}</div>`;
            
            const ps = this.st.posts.filter(x=>x.uid===uid);
            document.getElementById('c-pt').innerText=ps.length; document.getElementById('c-fl').innerText=u.followers.length; document.getElementById('c-fi').innerText=u.following.length;
            
            const acts = document.getElementById('p-act');
            if(isMe) acts.classList.add('hide');
            else {
                acts.classList.remove('hide');
                const b = document.getElementById('b-fl');
                if(me.following.includes(uid)) { b.innerText='Ù„ØºÙˆ Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù†'; b.className='btn btn-o'; }
                else if(u.requests && u.requests.includes(me.id)) { b.innerText='Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯'; b.className='btn btn-o'; }
                else { b.innerText='Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù†'; b.className='btn btn-p'; }
                
                // Allow Message Button Visibility Logic
                const bMsg = document.getElementById('b-msg');
                const hasHistory = this.st.msgs.some(m => (m.from === me.id && m.to === uid) || (m.from === uid && m.to === me.id));
                
                if (u.allowMsg || hasHistory) {
                    bMsg.classList.remove('hide');
                } else {
                    bMsg.classList.add('hide');
                }
                
                // Block Button Text Update
                const btnBlock = document.getElementById('btn-block');
                if(me.blocked && me.blocked.includes(uid)) {
                     btnBlock.innerText = 'âœ… Ø±ÙØ¹ Ù…Ø³Ø¯ÙˆØ¯ÛŒØª';
                     btnBlock.style.color = 'var(--suc)';
                } else {
                     btnBlock.innerText = 'ğŸš« Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù†';
                     btnBlock.style.color = 'var(--err)';
                }
            }
            const acc = isMe || !u.isPrivate || (u.isPrivate && u.followers.includes(me.id));
            document.getElementById('p-con').classList.toggle('hide', !acc);
            document.getElementById('p-lck').classList.toggle('hide', acc);
            if(acc) this.flt('all', document.querySelector('#s-pr .chips .chip'));
        },
        flt: function(cat, el) {
            if(el) { document.querySelectorAll('#s-pr .chips .chip').forEach(c=>c.classList.remove('active')); el.classList.add('active'); }
            const c = document.getElementById('p-pts'); c.innerHTML='';
            let p = this.st.posts.filter(x=>x.uid===this.st.vid);
            if(cat!=='all') p = p.filter(x=>x.cat===cat);
            if(p.length===0) c.innerHTML='<p style="text-align:center;padding:20px;color:gray">Ù‡ÛŒÚ† Ù¾Ø³ØªÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</p>';
            
            p.sort((a,b)=>b.time-a.time);
            const renderList = p.slice(0, this.st.limit);
            
            renderList.forEach(x=>c.innerHTML+=this.htmlP(x));
        },
        ans: function(uid, ac) {
            const me = this.st.user; me.requests = me.requests.filter(x=>x!==uid);
            const u = this.st.users.find(x=>x.id===uid);
            if(ac) { 
                if (!me.followers.includes(uid)) me.followers.push(uid);
                if (!u.following.includes(me.id)) u.following.push(me.id);
            }
            this.msg(); this.call('updateUser', [me, u]);
        },
        sets: function() {
            const u=this.st.user;
            document.getElementById('st-nm').innerText=u.name; document.getElementById('st-id').innerText='@'+u.id;
            document.getElementById('st-nc').innerText=u.nc; document.getElementById('st-cd').innerText=u.refCode;
            document.getElementById('st-pc').value=u.pic||''; document.getElementById('st-nn').value=u.name;
            document.getElementById('st-bi').value=u.bio||''; document.getElementById('st-ln').value=u.web||'';
            document.getElementById('st-mn').value=u.mention||''; document.getElementById('st-pr').checked=u.isPrivate;
            document.getElementById('st-al').checked=u.allowMsg;
            this.renderCustomCats();
        },
        sav: async function(btn) {
            const u=this.st.user;
            u.pic=document.getElementById('st-pc').value; u.name=document.getElementById('st-nn').value;
            u.bio=document.getElementById('st-bi').value; u.web=document.getElementById('st-ln').value;
            u.mention=document.getElementById('st-mn').value; u.isPrivate=document.getElementById('st-pr').checked;
            u.allowMsg=document.getElementById('st-al').checked;
            // customCats is already updated in st.user
            btn.innerHTML = '<span class="loading"></span>'; 
            await this.call('updateUser', [u]); // Send as array
            this.notif('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'suc'); 
            btn.innerHTML='Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª';
        },
        share: function(t, id) {
            if (t !== 'post') {
                const url = location.origin + location.pathname + '?u=' + (id || this.st.vid);
                if (navigator.share) {
                    navigator.share({ title: 'Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±', text: 'Ø§ÛŒÙ† Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø±Ø§ Ø¨Ø¨ÛŒÙ†ÛŒØ¯', url: url });
                } else {
                    this.st.shr = { txt: 'Ù„ÛŒÙ†Ú© Ù¾Ø±ÙˆÙØ§ÛŒÙ„:', lnk: url };
                    document.getElementById('m-sh').classList.add('show');
                }
                return;
            }
            const post = this.st.posts.find(p => p.pid === id);
            const author = this.st.users.find(u => u.id === post.uid);
            if (!post || !author) return;
            const url = location.origin + location.pathname + '?p=' + id;
            const textToShare = `${post.title}\n\n${post.text}\n\nÙ†ÙˆÛŒØ³Ù†Ø¯Ù‡: ${author.name} (@${author.id})\n\nÙ„ÛŒÙ†Ú©:\n${url}`;
            if (navigator.share) {
                navigator.share({
                    title: `Ù¾Ø³Øª Ø§Ø² ${author.name}: ${post.title}`,
                    text: textToShare,
                }).catch(err => console.log('Share failed:', err));
            } else {
                this.copyPostLink(id);
                this.notif('Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø² Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ù„ÛŒÙ†Ú© Ù¾Ø³Øª Ú©Ù¾ÛŒ Ø´Ø¯.', 'err');
            }
        },
        copyLink: function() {
            if (navigator.clipboard && this.st.shr.lnk) {
                navigator.clipboard.writeText(this.st.shr.lnk).then(() => {
                    this.notif('Ù„ÛŒÙ†Ú© Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ú©Ù¾ÛŒ Ø´Ø¯!', 'suc');
                }, (err) => {
                    this.notif('Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†Ú©', 'err');
                });
            } else {
                prompt('Ù„ÛŒÙ†Ú© Ø±Ø§ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯:', this.st.shr.lnk);
            }
            document.getElementById('m-sh').classList.remove('show');
        },
        doSh: () => { 
            if(navigator.share && app.st.shr.lnk) {
                navigator.share({title:'Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø§Ø² Ø³ÙˆØ´ÛŒØ§Ù„', url:app.st.shr.lnk});
            } else {
                app.notif('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯', 'err');
            }
            document.getElementById('m-sh').classList.remove('show');
        },
        flP: (v) => {
            const l=document.getElementById('pk-ls');
            const searchTerm = v.toLowerCase().replace('@', '');
            l.innerHTML = app.htmlSkelUser(3);
            setTimeout(() => {
                l.innerHTML='';
                let usersToList = [];
                const recentChatIds = [...new Set(app.st.msgs.filter(x => x.from === app.st.user.id || x.to === app.st.user.id).map(x => x.from === app.st.user.id ? x.to : x.from))];
                let sourceUsers = app.st.users.filter(u => recentChatIds.includes(u.id));
                
                // CHANGED: Added search by Name as well
                if (searchTerm === '') {
                    usersToList = sourceUsers;
                } else {
                    usersToList = sourceUsers.filter(u=> u.id.toLowerCase().includes(searchTerm) || u.name.toLowerCase().includes(searchTerm));
                }
                
                if (usersToList.length === 0) {
                    l.innerHTML = '<p style="text-align:center;color:var(--tg);padding:15px;">Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>';
                } else {
                    usersToList.forEach(u=>{ 
                        const action = app.st.pickerMode === 'post' ? `app.doSendPost('${u.id}')` : `app.snSh('${u.id}')`;
                        l.innerHTML+=`<div class="card flex-bw">${app.htmlU(u.id)} <button class="btn-s btn-p" onclick="${action}">Ø§Ø±Ø³Ø§Ù„</button></div>`;
                    });
                }
            }, 300);
        },
        snSh: (uid) => {
            const m={from:this.st.user.id, to:uid, text:this.st.shr.lnk, time:Date.now(), read:false};
            this.st.msgs.push(m); this.call('createMsg', m); document.getElementById('m-pk').classList.remove('show'); this.notif('Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯', 'suc');
        },
        checkSearch: function(el) {
            let raw = el.value;
            const v = raw.replace(/[@\s]/g, '').toLowerCase();
            if (v.length >= 5) {
                this.nav('sr');
                document.getElementById('sr-inp').value = raw;
                this.doSearch(); // Automatically search when redirected
            }
        },
        doSearch: async function() {
            const el = document.getElementById('sr-inp');
            const v = el.value.replace(/[@\s]/g, '').toLowerCase();
            if (!v) return;
            
            const b = document.getElementById('sr-res');
            b.innerHTML = this.htmlSkelUser(3);
            document.getElementById('sr-more').classList.add('hide');
            
            el.disabled = true;
            const d = await this.call('searchUser', { id: v });
            el.disabled = false;
            
            b.innerHTML = '';
            if (d.status === 'success' && d.users.length > 0) {
                this.st.tempUsers = d.users;
                this.st.searchLimit = 10;
                this.renderSearch();
            } else {
                b.innerHTML = '<p style="text-align:center; padding:20px; color:var(--tg);">Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ø´Ù†Ø§Ø³Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>';
            }
        },
        renderSearch: function() {
            const b = document.getElementById('sr-res');
            const list = this.st.tempUsers.slice(0, this.st.searchLimit);
            b.innerHTML = '';
            list.forEach(u => {
                b.innerHTML += `<div class="card">${this.htmlU(u.id)}</div>`;
            });
            
            if (this.st.tempUsers.length > this.st.searchLimit) {
                document.getElementById('sr-more').classList.remove('hide');
            } else {
                document.getElementById('sr-more').classList.add('hide');
            }
        },
        loadMoreSearch: function() {
            this.st.searchLimit += 10;
            this.renderSearch();
        },
        list: (t) => {
            const u = app.st.users.find(x => x.id === app.st.vid);
            if (!u) return;
            
            if(t==='posts') return;
            
            this.st.listType = t;
            this.st.listData = (t === 'fol' ? u.followers : u.following) || [];
            this.st.listLimit = 20;

            document.getElementById('ls-tt').innerText = t==='fol'?'Ø¯Ù†Ø¨Ø§Ù„â€ŒÚ©Ù†Ù†Ø¯Ú¯Ø§Ù†':'Ø¯Ù†Ø¨Ø§Ù„â€ŒØ´ÙˆÙ†Ø¯Ú¯Ø§Ù†';
            document.getElementById('m-ls').classList.add('show');
            this.renderList();
        },
        renderList: function() {
            const b = document.getElementById('ls-bd'); 
            b.innerHTML = '';
            
            const renderData = this.st.listData.slice(0, this.st.listLimit);

            if(this.st.listData.length === 0) {
                b.innerHTML = '<p style="text-align:center; padding:20px; color:var(--tg)">Ø®Ø§Ù„ÛŒ</p>';
            } else {
                renderData.forEach(id => {
                    b.innerHTML += `<div style="margin-bottom:10px">${app.htmlU(id)}</div>`;
                });
            }

            if(this.st.listData.length > this.st.listLimit) {
                document.getElementById('ls-more').classList.remove('hide');
            } else {
                document.getElementById('ls-more').classList.add('hide');
            }
        },
        loadMoreList: function() {
             this.st.listLimit += 20;
             this.renderList();
        },
        // NEW FUNCTION: List Blocked Users
        listBlocked: function() {
            this.st.listType = 'blocked';
            this.st.listData = this.st.user.blocked || [];
            this.st.listLimit = 20;
            document.getElementById('ls-tt').innerText = 'Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡';
            document.getElementById('m-ls').classList.add('show');
            this.renderList();
        },
        // NEW FUNCTION: Toggle Block User
        block: async function() {
            const uid = this.st.vid;
            if(!this.st.user.blocked) this.st.user.blocked = [];
            
            const index = this.st.user.blocked.indexOf(uid);
            if (index > -1) {
                this.st.user.blocked.splice(index, 1);
                this.notif('Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ù…Ø³Ø¯ÙˆØ¯ÛŒØª Ø®Ø§Ø±Ø¬ Ø´Ø¯', 'suc');
            } else {
                this.st.user.blocked.push(uid);
                this.notif('Ú©Ø§Ø±Ø¨Ø± Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯', 'err');
            }
            
            document.getElementById('p-mn').classList.add('hide'); // Close menu
            
            await this.call('updateUser', [this.st.user]);
            this.prof(uid); // Refresh Profile view
        },
        showNotifs: function() {
            localStorage.setItem('lastSeenNotif', Date.now());
            this.updateNotifBadge();
            this.st.notifLimit = 20;
            
            document.getElementById('m-nt').classList.add('show');
            this.renderNotifs();
        },
        renderNotifs: function() {
            const b = document.getElementById('nt-bd');
            const notifications = this.getNotifications();
            
            const renderData = notifications.slice(0, this.st.notifLimit);
            b.innerHTML = '';
            
            if (notifications.length === 0) {
                b.innerHTML = '<p style="text-align:center;color:gray;padding:20px;">Ù‡ÛŒÚ† Ø§Ø¹Ù„Ø§Ù† Ø¬Ø¯ÛŒØ¯ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>';
            } else {
                renderData.forEach(n => {
                    const u = this.st.users.find(usr => usr.id === n.uid);
                    if (!u) return;
                    let text = '';
                    let action = `onclick="app.nav('pr', '${u.id}')"`;
                    switch (n.type) {
                        case 'like': text = `Ù¾Ø³Øª Ø´Ù…Ø§ Ø±Ø§ Ù¾Ø³Ù†Ø¯ÛŒØ¯: <i>"${n.post.title}"</i>`; action=`onclick="app.showPost('${n.post.pid}')"`; break;
                        case 'comment': text = `Ù†Ø¸Ø± Ø¯Ø§Ø¯: <span style="display:block;margin-top:5px;padding:8px;background:#f1f5f9;border-radius:8px;font-size:0.85rem;border:1px solid #e2e8f0;">"${n.text}"</span><small style="opacity:0.7;display:block;margin-top:5px">Ø¯Ø± Ù¾Ø³Øª: ${n.post.title}</small>`; action=`onclick="app.showPost('${n.post.pid}')"`; break;
                        case 'follow': text = `Ø´Ù…Ø§ Ø±Ø§ Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯.`; break;
                        case 'request': text = `ÛŒÚ© Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù† Ø§Ø±Ø³Ø§Ù„ Ú©Ø±Ø¯.`; break;
                    }
                    b.innerHTML += `<div class="card" style="padding:12px; font-size:0.9rem; display:flex; flex-direction:column; gap:8px; cursor:pointer;" ${action}>
                        ${this.htmlU(u.id)}
                        <div style="padding-right:60px;">${text}</div>
                    </div>`;
                });
            }
            
            if(notifications.length > this.st.notifLimit) {
                document.getElementById('nt-more').classList.remove('hide');
            } else {
                document.getElementById('nt-more').classList.add('hide');
            }
        },
        loadMoreNotifs: function() {
            this.st.notifLimit += 20;
            this.renderNotifs();
        },
        copyPostLink: function(pid) {
            const url = location.origin + location.pathname + '?p=' + pid;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(url).then(() => {
                    this.notif('Ù„ÛŒÙ†Ú© Ù¾Ø³Øª Ú©Ù¾ÛŒ Ø´Ø¯', 'suc');
                });
            } else {
                this.notif('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ú©Ù¾ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.', 'err');
                prompt('Ù„ÛŒÙ†Ú© Ù¾Ø³Øª:', url);
            }
        },
        openSendPostModal: function(pid) {
            this.st.postToSend = pid;
            this.st.pickerMode = 'post';
            document.querySelector('#m-pk #pk-tt').innerText = 'Ø§Ø±Ø³Ø§Ù„ Ù¾Ø³Øª Ø¨Ù‡...';
            document.getElementById('m-pk').classList.add('show');
            const searchInput = document.querySelector('#m-pk .inp');
            searchInput.value = '';
            this.flP('');
        },
        doSendPost: function(recipientId) {
            if (!this.st.postToSend) return;
            const msgContent = JSON.stringify({ type: 'shared_post', pid: this.st.postToSend });
            const m = { from: this.st.user.id, to: recipientId, text: msgContent, time: Date.now(), read: false };
            this.st.msgs.push(m);
            this.call('createMsg', m);
            document.getElementById('m-pk').classList.remove('show');
            this.notif('Ù¾Ø³Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯', 'suc');
            this.st.postToSend = null;
            this.st.pickerMode = null;
        },
        filterChats: function(val) {
            const searchTerm = val.toLowerCase().replace('@','');
            const chatItems = document.querySelectorAll('#msg-bx .card');
            chatItems.forEach(item => {
                const chatId = item.dataset.chatId.toLowerCase();
                // CHANGED: Search by Name too
                const user = app.st.users.find(u => u.id === item.dataset.chatId);
                const userName = user ? user.name.toLowerCase() : '';
                
                if (chatId.includes(searchTerm) || userName.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        },
        htmlSkelPost: function(count = 1) {
            let html = '';
            for (let i=0; i < count; i++) {
                html += `<div class="card skel-card">
                    <div class="flex-bw">
                        <div class="u-blk">
                            <div class="sk-av skel"></div>
                            <div>
                                <div class="sk-ln-md skel"></div>
                                <div class="sk-ln-sm skel" style="margin-top:8px"></div>
                            </div>
                        </div>
                    </div>
                    <div class="sk-ln-lg skel"></div>
                    <div class="sk-ln-md skel" style="width:100%; margin-top:12px;"></div>
                    <div class="sk-ln-md skel" style="width:70%; margin-top:8px;"></div>
                </div>`;
            }
            return html;
        },
        htmlSkelUser: function(count = 1) {
            let html = '';
            for (let i=0; i < count; i++) {
                html += `<div class="card">
                    <div class="u-blk">
                        <div class="sk-av skel"></div>
                        <div>
                            <div class="sk-ln-md skel"></div>
                            <div class="sk-ln-sm skel" style="margin-top:8px"></div>
                        </div>
                    </div>
                </div>`;
            }
            return html;
        },
        showInitialSkeletons: function() {
            if (!document.getElementById('scr-app').classList.contains('hide')) {
                document.getElementById('feed').innerHTML = this.htmlSkelPost(3);
            }
        },
        htmlSharedPost: function(pid) {
            const post = this.st.posts.find(p => p.pid === pid);
            if (!post) {
                return '<div class="msg-post-share" style="opacity:0.7;">Ù¾Ø³Øª Ø­Ø°Ù Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
            }
            const author = this.st.users.find(u => u.id === post.uid);
            return `
                <div class="msg-post-share" onclick="app.showPost('${pid}')">
                    ${this.htmlU(author.id)}
                    <div class="msg-post-share-title">${post.title}</div>
                    <div class="msg-post-share-text">${post.text}</div>
                </div>
            `;
        },
        getNotifications: function() {
            if (!this.st.user) return [];
            let notifications = [];
            const myPosts = this.st.posts.filter(p => p.uid === this.st.user.id);

            myPosts.forEach(p => {
                (p.likes || []).forEach(like => {
                    const likerId = typeof like === 'object' ? like.uid : like;
                    if (likerId !== this.st.user.id) {
                         notifications.push({ time: like.time || p.time, type: 'like', uid: likerId, post: p });
                    }
                });
                (p.comments || []).forEach(c => {
                    if (c.uid !== this.st.user.id) {
                        notifications.push({ time: c.time || p.time, type: 'comment', uid: c.uid, post: p, text: c.text });
                    }
                });
            });

            const followers = this.st.users.find(u => u.id === this.st.user.id)?.followers || [];
            followers.forEach(uid => {
                 notifications.push({ time: Date.now(), type: 'follow', uid: uid });
            });
            
            (this.st.user.requests || []).forEach(uid => {
                notifications.push({ time: Date.now(), type: 'request', uid: uid });
            });

            notifications.sort((a, b) => b.time - a.time);
            return notifications;
        },
        updateNotifBadge: function() {
            const lastSeen = parseInt(localStorage.getItem('lastSeenNotif') || '0');
            const notifs = this.getNotifications();
            const newCount = notifs.filter(n => n.time > lastSeen).length;
            
            const badge = document.getElementById('notif-badge');
            if (newCount > 0) {
                badge.innerText = newCount;
                badge.classList.remove('hide');
            } else {
                badge.classList.add('hide');
            }
        },
        // --- NEW FUNCTIONS FOR CUSTOM CATEGORIES ---
        populateCategories: function() {
            const select = document.getElementById('a-ct');
            select.innerHTML = ''; // Clear old options
            
            // Add default categories
            const defaults = ['ğŸ“ Ø¹Ù…ÙˆÙ…ÛŒ', 'ğŸ“š Ú©ØªØ§Ø¨', 'ğŸ¬ ÙÛŒÙ„Ù…', 'ğŸŒ Ø³Ø§ÛŒØª', 'ğŸ’¡ Ø§ÛŒØ¯Ù‡'];
            defaults.forEach(cat => {
                const val = cat.split(' ')[1];
                select.innerHTML += `<option value="${val}">${cat}</option>`;
            });

            // Add user's custom categories
            if (this.st.user && this.st.user.customCats) {
                this.st.user.customCats.forEach(cat => {
                    select.innerHTML += `<option value="${cat}">${cat}</option>`;
                });
            }
        },
        renderCustomCats: function() {
            const list = document.getElementById('st-cats-list');
            const countEl = document.getElementById('cat-count');
            const cats = this.st.user.customCats || [];
            list.innerHTML = '';
            countEl.innerText = cats.length;

            cats.forEach(cat => {
                list.innerHTML += `
                    <div class="cat-item flex-bw">
                        ${cat} <span style="margin-right:10px;" onclick="app.deleteCat('${cat}')">âŒ</span>
                    </div>`;
            });
        },
        addCat: function() {
            const input = document.getElementById('st-new-cat');
            const newCat = input.value.trim();
            
            if (!this.st.user.customCats) {
                this.st.user.customCats = [];
            }
            
            if (!newCat) return this.notif('Ù†Ø§Ù… Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯.', 'err');
            if (this.st.user.customCats.length >= 20) return this.notif('Ø­Ø¯Ø§Ú©Ø«Ø± Û²Û° Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù…Ø¬Ø§Ø² Ø§Ø³Øª.', 'err');
            if (this.st.user.customCats.includes(newCat)) return this.notif('Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ Ø§Ø³Øª.', 'err');

            this.st.user.customCats.push(newCat);
            input.value = '';
            this.renderCustomCats();
        },
        deleteCat: function(catToDelete) {
            this.st.user.customCats = this.st.user.customCats.filter(cat => cat !== catToDelete);
            this.renderCustomCats();
        }
    };
    app.init();
</script>
</body>
</html>
