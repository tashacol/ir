<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø´Ø¨Ú©Ù‡ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ Ù…Ø¯Ø±Ù†</title>
    <style>
        :root {
            --primary: #4f46e5; --primary-dark: #4338ca; --bg: #f1f5f9; --surface: #ffffff;
            --text: #1e293b; --text-gray: #64748b; --border: #e2e8f0; --danger: #ef4444;
            --success: #10b981; --shadow: 0 4px 20px -5px rgba(0,0,0,0.1); --radius: 16px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); color: var(--text); padding-bottom: 85px; overflow-x: hidden; user-select: none; }
        a { text-decoration: none; color: var(--primary); }
        button { border: none; background: none; font-family: inherit; cursor: pointer; }
        
        .container { max-width: 500px; margin: 0 auto; padding: 15px; }
        .hidden { display: none !important; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .flex-center { display: flex; justify-content: center; align-items: center; }

        /* Modern UI Elements */
        .card { background: var(--surface); border-radius: var(--radius); padding: 15px; margin-bottom: 15px; box-shadow: var(--shadow); border: 1px solid var(--border); position: relative; overflow: hidden; }
        
        .inp-group { position: relative; margin-bottom: 15px; }
        .inp-modern { width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 12px; background: var(--bg); font-size: 1rem; transition: 0.3s; }
        .inp-modern:focus { border-color: var(--primary); background: var(--surface); }
        .inp-modern:placeholder-shown + label { top: 14px; right: 14px; font-size: 0.9rem; color: var(--text-gray); }
        .inp-modern:focus + label, .inp-modern:not(:placeholder-shown) + label { top: -8px; right: 10px; font-size: 0.75rem; background: var(--surface); padding: 0 4px; color: var(--primary); font-weight: bold; }
        .inp-label { position: absolute; transition: 0.3s; pointer-events: none; }

        .btn { width: 100%; padding: 14px; border-radius: 12px; font-weight: 700; font-size: 1rem; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4); }
        .btn-outline { border: 2px solid var(--border); color: var(--text-gray); background: transparent; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; width: auto; }
        .btn-icon { font-size: 1.4rem; color: var(--text); padding: 5px; }

        /* Skeleton Loading (Bone Style) */
        .skeleton { background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .sk-avatar { width: 45px; height: 45px; border-radius: 50%; }
        .sk-line { height: 12px; margin-bottom: 8px; width: 100%; }
        .sk-card { padding: 15px; background: white; border-radius: 16px; margin-bottom: 15px; border: 1px solid var(--border); }

        /* Loading Spinner inside Button */
        .spinner { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* User Avatar */
        .u-block { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .u-img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: #e2e8f0; border: 2px solid var(--surface); }
        .u-info { line-height: 1.2; }
        .u-name { font-weight: 700; font-size: 0.95rem; }
        .u-id { font-size: 0.75rem; color: var(--text-gray); }

        /* Nav Bar */
        .nav-bar { position: fixed; bottom: 20px; left: 5%; width: 90%; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 20px; display: flex; justify-content: space-around; padding: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.5); z-index: 900; }
        .nav-item { font-size: 1.6rem; padding: 8px 12px; border-radius: 12px; transition: 0.3s; color: #94a3b8; position: relative; }
        .nav-item.active { color: var(--primary); background: #e0e7ff; transform: translateY(-3px); }
        .badge { position: absolute; top: 0; right: 0; background: var(--danger); color: white; font-size: 0.6rem; padding: 2px 5px; border-radius: 10px; border: 2px solid white; }

        /* Toast Notification */
        #toast-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; width: 90%; max-width: 350px; pointer-events: none; }
        .toast { background: #1e293b; color: white; padding: 12px; border-radius: 10px; margin-bottom: 10px; text-align: center; font-size: 0.9rem; animation: slideIn 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Post & Feed */
        .post-act { display: flex; gap: 20px; margin-top: 15px; border-top: 1px solid var(--border); padding-top: 10px; }
        .act-btn { display: flex; align-items: center; gap: 6px; color: var(--text-gray); font-size: 0.9rem; cursor: pointer; transition: 0.2s; }
        .act-btn.liked { color: var(--danger); }
        .act-btn.liked svg { fill: var(--danger); animation: heartPop 0.3s; }
        @keyframes heartPop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        
        /* Modals */
        .modal-wrap { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); z-index: 1000; display: flex; align-items: flex-end; justify-content: center; backdrop-filter: blur(2px); }
        .modal { background: var(--surface); width: 100%; max-width: 500px; border-radius: 25px 25px 0 0; padding: 20px; max-height: 85vh; overflow-y: auto; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Profile */
        .prof-head { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .prof-pic { width: 80px; height: 80px; border-radius: 50%; border: 3px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); object-fit: cover; }
        .prof-stat { flex: 1; display: flex; justify-content: space-around; text-align: center; }
        .prof-num { font-weight: 800; font-size: 1.1rem; display: block; }
        .prof-lbl { font-size: 0.75rem; color: var(--text-gray); }
        .filter-tab { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; scrollbar-width: none; }
        .chip { padding: 6px 14px; border-radius: 20px; background: var(--surface); border: 1px solid var(--border); white-space: nowrap; font-size: 0.85rem; transition: 0.2s; }
        .chip.active { background: var(--text); color: white; border-color: var(--text); }

        /* Others */
        .comment-item { background: #f8fafc; padding: 10px; border-radius: 10px; margin-top: 8px; font-size: 0.9rem; }
        .new-mem-scroll { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .new-mem-card { min-width: 80px; text-align: center; }
    </style>
</head>
<body>

    <div id="toast-box"></div>

    <!-- AUTH SECTION -->
    <div id="auth-screen" class="container" style="height:100vh; display:flex; flex-direction:column; justify-content:center;">
        <h1 style="text-align:center; color:var(--primary); margin-bottom:30px; font-size:2rem;">ğŸŒ Ø³ÙˆØ´ÛŒØ§Ù„</h1>
        
        <!-- Login Form -->
        <div id="form-login">
            <div class="card">
                <h2 style="margin-bottom:20px; text-align:center;">Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h2>
                <div class="inp-group">
                    <input type="number" id="l-nc" class="inp-modern" placeholder=" " inputmode="numeric">
                    <label class="inp-label">Ú©Ø¯ Ù…Ù„ÛŒ</label>
                </div>
                <div class="inp-group">
                    <input type="password" id="l-pass" class="inp-modern" placeholder=" ">
                    <label class="inp-label">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                </div>
                <div class="flex-between" style="margin-bottom:20px">
                    <label style="font-size:0.8rem; display:flex; align-items:center; gap:5px">
                        <input type="checkbox" id="l-remember" checked> Ø°Ø®ÛŒØ±Ù‡ ÙˆØ±ÙˆØ¯
                    </label>
                </div>
                <button class="btn btn-primary" onclick="app.login()" id="btn-login">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨</button>
                <button class="btn btn-outline" style="margin-top:10px" onclick="app.guestLogin()">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ù‡Ù…Ø§Ù†</button>
            </div>
            <p style="text-align:center; margin-top:15px; color:var(--primary); cursor:pointer" onclick="app.toggleForms()">Ø³Ø§Ø®Øª Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÛŒØ¯</p>
        </div>

        <!-- Register Form -->
        <div id="form-reg" class="hidden">
            <div class="card">
                <h2 style="margin-bottom:20px; text-align:center;">Ø«Ø¨Øª Ù†Ø§Ù…</h2>
                <div class="inp-group"><input type="number" id="r-nc" class="inp-modern" placeholder=" "><label class="inp-label">Ú©Ø¯ Ù…Ù„ÛŒ (Û±Û° Ø±Ù‚Ù…)</label></div>
                <div class="inp-group"><input type="text" id="r-name" class="inp-modern" placeholder=" "><label class="inp-label">Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ</label></div>
                <div class="inp-group"><input type="text" id="r-user" class="inp-modern" placeholder=" "><label class="inp-label">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ (Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)</label></div>
                <div class="inp-group"><input type="number" id="r-ref" class="inp-modern" placeholder=" "><label class="inp-label">Ú©Ø¯ Ù…Ø¹Ø±Ù (Ø§Ù„Ø²Ø§Ù…ÛŒ)</label></div>
                <div class="inp-group"><input type="password" id="r-pass" class="inp-modern" placeholder=" "><label class="inp-label">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label></div>
                <button class="btn btn-primary" style="background:var(--success)" onclick="app.register()" id="btn-reg">Ø«Ø¨Øª Ù†Ø§Ù…</button>
            </div>
            <p style="text-align:center; margin-top:15px; color:var(--text-gray); cursor:pointer" onclick="app.toggleForms()">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ÙˆØ±ÙˆØ¯</p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-screen" class="hidden">
        
        <!-- 1. Home Feed -->
        <section id="sec-home" class="container">
            <div class="flex-between" style="margin-bottom:15px">
                <h2 style="font-size:1.5rem">Ø®Ø§Ù†Ù‡</h2>
                <button class="btn-icon" onclick="app.refreshData()">ğŸ”„</button>
            </div>
            
            <!-- Search -->
            <div class="inp-group">
                <input type="text" class="inp-modern" placeholder=" " onkeyup="if(event.key==='Enter') app.search(this.value)" style="padding:10px; border-radius:20px">
                <label class="inp-label">Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ú©Ù„ Ø´Ø¨Ú©Ù‡...</label>
            </div>

            <!-- New Members -->
            <div style="margin-bottom:20px">
                <h4 style="margin-bottom:10px; font-size:0.9rem; color:var(--text-gray)">Ø§Ø¹Ø¶Ø§ÛŒ Ø¬Ø¯ÛŒØ¯</h4>
                <div id="box-new-users" class="new-mem-scroll"></div>
            </div>

            <div id="feed-list"></div>
        </section>

        <!-- 2. Profile -->
        <section id="sec-prof" class="container hidden">
            <div class="card">
                <div class="flex-between" style="margin-bottom:15px">
                    <button class="btn-icon" id="btn-back-prof" onclick="app.nav('home')">â¬…ï¸</button>
                    <h3 id="p-header">Ù¾Ø±ÙˆÙØ§ÛŒÙ„</h3>
                    <button class="btn-icon" onclick="document.getElementById('menu-prof').classList.toggle('hidden')">â‹®</button>
                    <!-- Prof Menu -->
                    <div id="menu-prof" class="card hidden" style="position:absolute; top:40px; left:10px; width:150px; z-index:10; padding:5px;">
                        <div style="padding:10px; cursor:pointer" onclick="app.shareLink('prof')">ğŸ”— Ø§Ø´ØªØ±Ø§Ú©</div>
                        <div style="padding:10px; color:red; cursor:pointer" onclick="app.blockUser()">ğŸš« Ù…Ø³Ø¯ÙˆØ¯</div>
                    </div>
                </div>

                <div class="prof-head">
                    <img id="p-img" class="prof-pic" src="">
                    <div class="prof-stat">
                        <div onclick="app.showModalList('Ù¾Ø³Øª')"><span class="prof-num" id="p-c-post">0</span><span class="prof-lbl">Ù¾Ø³Øª</span></div>
                        <div onclick="app.showModalList('followers')"><span class="prof-num" id="p-c-fol">0</span><span class="prof-lbl">Ø¯Ù†Ø¨Ø§Ù„â€ŒÚ©Ù†Ù†Ø¯Ù‡</span></div>
                        <div onclick="app.showModalList('following')"><span class="prof-num" id="p-c-fing">0</span><span class="prof-lbl">Ø¯Ù†Ø¨Ø§Ù„â€ŒØ´ÙˆÙ†Ø¯Ù‡</span></div>
                    </div>
                </div>

                <h3 id="p-name"></h3>
                <div style="color:var(--text-gray); font-size:0.9rem; margin-bottom:5px">@<span id="p-id"></span></div>
                <p id="p-bio" style="font-size:0.9rem; line-height:1.5"></p>
                <div id="p-links" style="margin-top:5px; font-size:0.9rem;"></div>

                <div class="flex-between" id="p-actions" style="margin-top:15px; gap:10px">
                    <button id="btn-foll" class="btn btn-primary" onclick="app.actFollow()">Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù†</button>
                    <button id="btn-msg" class="btn btn-outline" onclick="app.openChat(app.state.viewId)">Ù¾ÛŒØ§Ù…</button>
                </div>
            </div>

            <div id="p-content">
                <div class="filter-tab">
                    <span class="chip active" onclick="app.filterPosts('all', this)">Ù‡Ù…Ù‡</span>
                    <span class="chip" onclick="app.filterPosts('book', this)">Ú©ØªØ§Ø¨</span>
                    <span class="chip" onclick="app.filterPosts('movie', this)">ÙÛŒÙ„Ù…</span>
                    <span class="chip" onclick="app.filterPosts('site', this)">Ø³Ø§ÛŒØª</span>
                </div>
                <div id="p-posts"></div>
            </div>
            
            <div id="p-private" class="card hidden" style="text-align:center; padding:40px;">
                <div style="font-size:3rem">ğŸ”’</div>
                <p>Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø®ØµÙˆØµÛŒ Ø§Ø³Øª</p>
            </div>
        </section>

        <!-- 3. Add Post -->
        <section id="sec-add" class="container hidden">
            <h2 style="margin-bottom:15px">Ù¾Ø³Øª Ø¬Ø¯ÛŒØ¯</h2>
            <div class="card">
                <div class="inp-group"><input type="text" id="add-title" class="inp-modern" placeholder=" "><label class="inp-label">Ø¹Ù†ÙˆØ§Ù†</label></div>
                <div style="margin-bottom:15px">
                    <select id="add-cat" class="inp-modern" style="padding:10px">
                        <option value="book">Ú©ØªØ§Ø¨</option>
                        <option value="movie">ÙÛŒÙ„Ù…</option>
                        <option value="site">Ø³Ø§ÛŒØª</option>
                    </select>
                </div>
                <div class="inp-group">
                    <textarea id="add-text" class="inp-modern" rows="5" placeholder=" "></textarea>
                    <label class="inp-label">Ù…ØªÙ† Ù¾Ø³Øª...</label>
                </div>
                <button class="btn btn-primary" onclick="app.publish()" id="btn-pub">Ø§Ø±Ø³Ø§Ù„ Ù¾Ø³Øª</button>
            </div>
        </section>

        <!-- 4. Messages -->
        <section id="sec-msg" class="container hidden">
            <div class="flex-between" style="margin-bottom:15px">
                <h2>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§</h2>
                <div style="display:flex; gap:5px">
                    <span class="chip active" onclick="app.renderMsg('chat')">Ú¯ÙØªÚ¯Ùˆ</span>
                    <span class="chip" onclick="app.renderMsg('req')">Ø¯Ø±Ø®ÙˆØ§Ø³Øª <span id="badge-req" class="badge hidden"></span></span>
                </div>
            </div>
            <div id="msg-list"></div>
        </section>

        <!-- 5. Settings -->
        <section id="sec-set" class="container hidden">
            <h2>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h2>
            <!-- Identity Card -->
            <div class="card" style="background: linear-gradient(135deg, #0ea5e9, #2563eb); color:white; margin-top:15px;">
                <div class="flex-between">
                    <h3 id="set-d-name"></h3> <small id="set-d-id"></small>
                </div>
                <div style="margin-top:10px; opacity:0.9">Ú©Ø¯ Ù…Ù„ÛŒ: <span id="set-d-nc"></span></div>
                <div style="margin-top:5px; font-weight:bold">Ú©Ø¯ Ø¯Ø¹ÙˆØª Ø´Ù…Ø§: <span id="set-d-code" style="font-size:1.2rem"></span></div>
            </div>

            <div class="card">
                <div class="inp-group"><input type="text" id="set-pic" class="inp-modern" placeholder=" "><label class="inp-label">Ù„ÛŒÙ†Ú© Ø¹Ú©Ø³</label></div>
                <div class="inp-group"><input type="text" id="set-name" class="inp-modern" placeholder=" "><label class="inp-label">Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ</label></div>
                <div class="inp-group"><textarea id="set-bio" class="inp-modern" placeholder=" "></textarea><label class="inp-label">Ø¨ÛŒÙˆÚ¯Ø±Ø§ÙÛŒ</label></div>
                <div class="inp-group"><input type="text" id="set-link" class="inp-modern" placeholder=" "><label class="inp-label">Ù„ÛŒÙ†Ú© ÙˆØ¨Ø³Ø§ÛŒØª</label></div>
                <div class="inp-group"><input type="text" id="set-mention" class="inp-modern" placeholder=" "><label class="inp-label">Ù…Ù†Ø´Ù† (@id)</label></div>
                
                <div class="flex-between" style="margin-bottom:10px">
                    <span>Ø­Ø³Ø§Ø¨ Ø®ØµÙˆØµÛŒ</span> <input type="checkbox" id="set-priv" style="transform:scale(1.5)">
                </div>
                <div class="flex-between" style="margin-bottom:20px">
                    <span>Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…</span> <input type="checkbox" id="set-amsg" style="transform:scale(1.5)">
                </div>
                
                <button class="btn btn-primary" onclick="app.saveSet()" id="btn-save">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
                <button class="btn btn-outline" style="margin-top:10px; color:red; border-color:red" onclick="app.logout()">Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨</button>
            </div>
        </section>

        <!-- Search Results -->
        <section id="sec-search" class="container hidden">
            <h2>Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ</h2>
            <button class="btn-sm btn-outline" onclick="app.nav('home')">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            <div id="search-box" style="margin-top:15px"></div>
        </section>

        <!-- Navigation -->
        <div class="nav-bar">
            <div class="nav-item active" id="n-home" onclick="app.nav('home')">ğŸ </div>
            <div class="nav-item" id="n-add" onclick="app.nav('add')">â•</div>
            <div class="nav-item" id="n-msg" onclick="app.nav('msg')">ğŸ’¬ <span id="badge-nav" class="badge hidden"></span></div>
            <div class="nav-item" id="n-prof" onclick="app.nav('prof')">ğŸ‘¤</div>
            <div class="nav-item" id="n-set" onclick="app.nav('set')">âš™ï¸</div>
        </div>
    </div>

    <!-- MODALS -->
    <!-- Share Sheet -->
    <div id="modal-share" class="modal-wrap hidden" onclick="if(event.target==this) this.classList.add('hidden')">
        <div class="modal">
            <h3>Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ</h3>
            <div style="margin-top:20px">
                <button class="btn btn-outline" style="margin-bottom:10px" onclick="app.doShareExt()">ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±</button>
                <button class="btn btn-outline" onclick="app.openSharePick()">ğŸ’¬ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ù…Ø®Ø§Ø·Ø¨ÛŒÙ† Ø¯Ø§Ø®Ù„ÛŒ</button>
            </div>
        </div>
    </div>
    
    <!-- User Picker -->
    <div id="modal-pick" class="modal-wrap hidden" onclick="if(event.target==this) this.classList.add('hidden')">
        <div class="modal">
            <h3>Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡...</h3>
            <input type="text" class="inp-modern" placeholder="Ø¬Ø³ØªØ¬Ùˆ..." onkeyup="app.filterPick(this.value)">
            <div id="pick-list" style="margin-top:10px"></div>
        </div>
    </div>

    <!-- List Modal -->
    <div id="modal-list" class="modal-wrap hidden" onclick="if(event.target==this) this.classList.add('hidden')">
        <div class="modal">
            <h3 id="list-title">Ù„ÛŒØ³Øª</h3>
            <div id="list-body" style="margin-top:15px"></div>
        </div>
    </div>

    <!-- Comments Modal -->
    <div id="modal-comm" class="modal-wrap hidden" onclick="if(event.target==this) this.classList.add('hidden')">
        <div class="modal">
            <h3>Ù†Ø¸Ø±Ø§Øª</h3>
            <div id="comm-body" style="min-height:100px; margin:10px 0;"></div>
            <div class="flex-between">
                <input type="text" id="comm-in" class="inp-modern" placeholder="Ù†Ø¸Ø± Ø´Ù…Ø§..." style="width:75%">
                <button class="btn btn-primary" style="width:20%" onclick="app.sendComm()">âœ”</button>
            </div>
        </div>
    </div>

    <!-- Chat Fullscreen -->
    <div id="screen-chat" class="hidden" style="position:fixed; top:0; left:0; right:0; bottom:0; background:var(--bg); z-index:2000; display:flex; flex-direction:column">
        <div class="card" style="margin:0; border-radius:0; border-bottom:1px solid var(--border); padding:15px; display:flex; align-items:center; gap:10px">
            <button onclick="document.getElementById('screen-chat').classList.add('hidden')">â¬…ï¸</button>
            <div style="font-weight:bold" id="chat-head"></div>
        </div>
        <div id="chat-box" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:10px"></div>
        <div style="padding:10px; background:white; display:flex; gap:10px">
            <input type="text" id="chat-in" class="inp-modern" placeholder="Ù¾ÛŒØ§Ù…...">
            <button class="btn btn-primary" style="width:50px" onclick="app.sendChat()">â¤</button>
        </div>
    </div>

    <script>
        // *** Ø¢Ø¯Ø±Ø³ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ú¯ÙˆÚ¯Ù„ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯ ***
        const API = 'LINK_GOOGLE_SCRIPT_SHOMA'; 

        const app = {
            s: { user: null, users: [], posts: [], msgs: [], viewId: null, share: null, chatPid: null, guest: false },
            
            init: async function() {
                // Load Cache
                if(localStorage.getItem('db')) {
                    const db = JSON.parse(localStorage.getItem('db'));
                    this.s.users = db.users || [];
                    this.s.posts = db.posts || [];
                    this.s.msgs = db.msgs || [];
                }

                // Check Login
                const uid = localStorage.getItem('uid');
                if(uid) {
                    this.s.user = this.s.users.find(u=>u.id===uid);
                    if(this.s.user) {
                        this.showApp();
                        this.sync(); // Background sync
                    } else document.getElementById('auth-screen').classList.remove('hidden');
                } else {
                    document.getElementById('auth-screen').classList.remove('hidden');
                }
                
                // Deep Link
                const p = new URLSearchParams(location.search);
                if(p.get('u')) setTimeout(()=>this.nav('prof', p.get('u')), 1000);
            },

            sync: async function() {
                try {
                    const res = await fetch(API);
                    const data = await res.json();
                    this.s.users = data.users;
                    this.s.posts = data.posts;
                    this.s.msgs = data.msgs;
                    localStorage.setItem('db', JSON.stringify(data));
                    
                    if(this.s.user && !this.s.guest) {
                        this.s.user = this.s.users.find(u=>u.id===this.s.user.id);
                        this.badges();
                    }
                    if(!document.getElementById('sec-home').classList.contains('hidden')) this.renderFeed();
                } catch(e) { console.log('Offline mode'); }
            },

            // --- AUTH ---
            toggleForms: () => {
                document.getElementById('form-login').classList.toggle('hidden');
                document.getElementById('form-reg').classList.toggle('hidden');
            },
            
            toast: (msg) => {
                const b = document.getElementById('toast-box');
                const t = document.createElement('div'); t.className='toast'; t.innerText=msg;
                b.appendChild(t); setTimeout(()=>t.remove(), 3000);
            },
            
            loading: (btnId, state) => {
                const btn = document.getElementById(btnId);
                if(state) {
                    btn.dataset.txt = btn.innerText;
                    btn.innerHTML = '<div class="spinner"></div>';
                    btn.disabled = true;
                } else {
                    btn.innerHTML = btn.dataset.txt;
                    btn.disabled = false;
                }
            },

            guestLogin: function() {
                this.s.guest = true;
                this.s.user = { id: 'guest', name: 'Ù…Ù‡Ù…Ø§Ù†', following:[], followers:[], requests:[], blocked:[] };
                this.showApp();
                this.toast('Ø­Ø§Ù„Øª Ù…Ù‡Ù…Ø§Ù† ÙØ¹Ø§Ù„ Ø´Ø¯');
                this.sync();
            },

            login: async function() {
                const nc = document.getElementById('l-nc').value;
                const pass = document.getElementById('l-pass').value;
                if(!nc || !pass) return this.toast('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ø§Ù‚Øµ');
                
                this.loading('btn-login', true);
                try {
                    const res = await fetch(API, { method:'POST', body:JSON.stringify({act:'login', nc, pass}) });
                    const d = await res.json();
                    if(d.ok) {
                        this.s.user = d.user;
                        if(document.getElementById('l-remember').checked) localStorage.setItem('uid', d.user.id);
                        this.showApp();
                        this.sync();
                    } else this.toast(d.msg);
                } catch(e) { this.toast('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„'); }
                this.loading('btn-login', false);
            },

            register: async function() {
                const d = {
                    act: 'reg',
                    id: document.getElementById('r-user').value.toLowerCase(),
                    nc: document.getElementById('r-nc').value,
                    pass: document.getElementById('r-pass').value,
                    name: document.getElementById('r-name').value,
                    ref: document.getElementById('r-ref').value
                };
                if(!d.id || !d.nc || !d.pass || !d.ref) return this.toast('Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
                
                this.loading('btn-reg', true);
                try {
                    const res = await fetch(API, { method:'POST', body:JSON.stringify(d) });
                    const r = await res.json();
                    if(r.ok) {
                        this.toast('Ø«Ø¨Øª Ø´Ø¯. ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯');
                        this.toggleForms();
                    } else this.toast(r.msg);
                } catch(e) { this.toast('Ø®Ø·Ø§'); }
                this.loading('btn-reg', false);
            },

            logout: function() {
                localStorage.removeItem('uid');
                location.reload();
            },

            showApp: function() {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                if(this.s.guest) {
                    ['n-add','n-msg','n-set'].forEach(i=>document.getElementById(i).style.display='none');
                }
                this.nav('home');
            },

            // --- NAV ---
            nav: function(page, arg) {
                document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
                document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
                
                if(page === 'home') {
                    document.getElementById('sec-home').classList.remove('hidden');
                    document.getElementById('n-home').classList.add('active');
                    this.renderFeed();
                } else if(page === 'prof') {
                    document.getElementById('sec-prof').classList.remove('hidden');
                    if(!arg || (this.s.user && arg === this.s.user.id)) document.getElementById('n-prof').classList.add('active');
                    this.renderProf(arg || this.s.user.id);
                } else if(page === 'add') {
                    document.getElementById('sec-add').classList.remove('hidden');
                    document.getElementById('n-add').classList.add('active');
                } else if(page === 'msg') {
                    document.getElementById('sec-msg').classList.remove('hidden');
                    document.getElementById('n-msg').classList.add('active');
                    this.renderMsg('chat');
                } else if(page === 'set') {
                    document.getElementById('sec-set').classList.remove('hidden');
                    document.getElementById('n-set').classList.add('active');
                    this.renderSet();
                }
            },

            // --- FEED ---
            renderFeed: function() {
                const c = document.getElementById('feed-list');
                const scroll = document.getElementById('box-new-users');
                
                // New Members
                scroll.innerHTML = '';
                this.s.users.filter(u=>u.id!==this.s.user.id).slice(-5).forEach(u=>{
                    const img = u.pic ? `<img src="${u.pic}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">` : u.name[0];
                    scroll.innerHTML += `
                        <div class="new-mem-card" onclick="app.nav('prof','${u.id}')">
                            <div style="width:50px;height:50px;border-radius:50%;background:#e2e8f0;margin:auto;display:flex;align-items:center;justify-content:center;overflow:hidden">${img}</div>
                            <div style="font-size:0.7rem;margin-top:4px">${u.name}</div>
                        </div>`;
                });

                // Posts (Public or Following)
                c.innerHTML = '';
                if(this.s.posts.length === 0) return c.innerHTML = this.skel();
                
                const visible = this.s.posts.filter(p => {
                    const auth = this.s.users.find(u=>u.id===p.uid);
                    if(!auth) return false;
                    return !auth.isPrivate || this.s.user.following.includes(p.uid) || p.uid === this.s.user.id;
                });
                
                visible.sort((a,b)=>b.time-a.time).forEach(p => c.innerHTML += this.htmlPost(p));
            },

            skel: () => `<div class="sk-card"><div class="flex-between"><div class="sk-avatar skeleton"></div><div style="width:70%"><div class="sk-line skeleton"></div><div class="sk-line skeleton" style="width:50%"></div></div></div><div class="sk-line skeleton" style="height:100px;margin-top:10px"></div></div>`,

            htmlUser: (uid) => {
                const u = this.s.users.find(x=>x.id===uid);
                if(!u) return 'Unk';
                const img = u.pic ? `<img class="u-img" src="${u.pic}">` : `<div class="u-img flex-center">${u.name[0]}</div>`;
                return `<div class="u-block" onclick="event.stopPropagation();app.nav('prof','${u.id}')">${img}<div class="u-info"><div class="u-name">${u.name}</div><div class="u-id">@${u.id}</div></div></div>`;
            },

            htmlPost: function(p) {
                const liked = p.likes.includes(this.s.user.id) ? 'liked' : '';
                const cats = {book:'Ú©ØªØ§Ø¨', movie:'ÙÛŒÙ„Ù…', site:'Ø³Ø§ÛŒØª'};
                return `
                    <div class="card">
                        <div class="flex-between">
                            ${this.htmlUser(p.uid)}
                            <span style="font-size:0.7rem;background:#e0f2fe;color:#0284c7;padding:2px 8px;border-radius:8px">${cats[p.cat]}</span>
                        </div>
                        <h4 style="margin-top:10px">${p.title}</h4>
                        <p style="margin-top:5px;line-height:1.6;font-size:0.95rem">${p.text}</p>
                        <div class="post-act">
                            <div class="act-btn ${liked}" onclick="app.actLike('${p.pid}')">
                                <svg class="icon" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                ${p.likes.length}
                            </div>
                            <div class="act-btn" onclick="app.openComm('${p.pid}')">ğŸ’¬ ${p.comments.length}</div>
                            <div class="act-btn" onclick="app.shareLink('post','${p.pid}')">ğŸ”—</div>
                        </div>
                    </div>`;
            },

            // --- ACTIONS ---
            publish: async function() {
                if(this.s.guest) return this.toast('Ø¨Ø§ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯');
                const p = {
                    act: 'post', uid: this.s.user.id,
                    title: document.getElementById('add-title').value,
                    cat: document.getElementById('add-cat').value,
                    text: document.getElementById('add-text').value,
                    time: Date.now(), pid: this.s.user.id+'_'+Date.now()
                };
                if(!p.title || !p.text) return this.toast('Ø®Ø§Ù„ÛŒ Ø§Ø³Øª');
                
                this.loading('btn-pub', true);
                this.s.posts.unshift({ ...p, likes:[], comments:[] }); // Optimistic
                this.nav('home');
                
                await fetch(API, { method:'POST', body:JSON.stringify(p) });
                this.loading('btn-pub', false);
                document.getElementById('add-title').value = '';
                document.getElementById('add-text').value = '';
            },

            actLike: function(pid) {
                if(this.s.guest) return this.toast('Ø¨Ø§ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯');
                const p = this.s.posts.find(x=>x.pid===pid);
                const uid = this.s.user.id;
                if(p.likes.includes(uid)) p.likes = p.likes.filter(x=>x!==uid);
                else p.likes.push(uid);
                this.renderFeed(); // Re-render to show animation
                fetch(API, { method:'POST', body:JSON.stringify({act:'like', pid, uid}) });
            },

            openComm: function(pid) {
                this.s.chatPid = pid;
                const p = this.s.posts.find(x=>x.pid===pid);
                const b = document.getElementById('comm-body');
                b.innerHTML = p.comments.length ? '' : '<p style="text-align:center;color:gray">Ø¨Ø¯ÙˆÙ† Ù†Ø¸Ø±</p>';
                p.comments.forEach(c => {
                    b.innerHTML += `<div class="comment-item"><b>${this.s.users.find(u=>u.id===c.uid).name}</b>: ${c.text}</div>`;
                });
                document.getElementById('modal-comm').classList.remove('hidden');
            },

            sendComm: function() {
                if(this.s.guest) return this.toast('Ù…Ù‡Ù…Ø§Ù† Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯');
                const txt = document.getElementById('comm-in').value;
                if(!txt) return;
                const pid = this.s.chatPid;
                const p = this.s.posts.find(x=>x.pid===pid);
                p.comments.push({uid: this.s.user.id, text: txt});
                this.openComm(pid); // Refresh modal
                document.getElementById('comm-in').value = '';
                fetch(API, { method:'POST', body:JSON.stringify({act:'comm', pid, uid:this.s.user.id, text:txt}) });
            },

            // --- PROFILE ---
            renderProf: function(uid) {
                const u = this.s.users.find(x=>x.id===uid);
                const me = this.s.user;
                this.s.viewId = uid;
                const isMe = uid === me.id;

                // Bind Data
                document.getElementById('p-img').src = u.pic || '';
                if(!u.pic) document.getElementById('p-img').style.backgroundColor = '#cbd5e1';
                document.getElementById('p-name').innerText = u.name;
                document.getElementById('p-id').innerText = u.id;
                document.getElementById('p-bio').innerText = u.bio;
                
                // Links
                const lnk = document.getElementById('p-links'); lnk.innerHTML = '';
                if(u.web) lnk.innerHTML += `<div>ğŸŒ <a href="${u.web}" target="_blank">${u.web}</a></div>`;
                if(u.mention) lnk.innerHTML += `<div>ğŸ“£ <a href="#" onclick="app.nav('prof','${u.mention}')">@${u.mention}</a></div>`;

                // Stats
                const posts = this.s.posts.filter(x=>x.uid===uid);
                document.getElementById('p-c-post').innerText = posts.length;
                document.getElementById('p-c-fol').innerText = u.followers.length;
                document.getElementById('p-c-fing').innerText = u.following.length;

                // Controls
                const acts = document.getElementById('p-actions');
                if(isMe) acts.classList.add('hidden');
                else {
                    acts.classList.remove('hidden');
                    const btnF = document.getElementById('btn-foll');
                    if(me.following.includes(uid)) { btnF.innerText='Ù„ØºÙˆ Ø¯Ù†Ø¨Ø§Ù„'; btnF.className='btn btn-outline'; }
                    else if(u.requests.includes(me.id)) { btnF.innerText='Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±'; btnF.className='btn btn-outline'; }
                    else { btnF.innerText='Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù†'; btnF.className='btn btn-primary'; }
                }

                // Privacy
                const access = isMe || !u.isPrivate || (u.isPrivate && u.followers.includes(me.id));
                document.getElementById('p-content').classList.toggle('hidden', !access);
                document.getElementById('p-private').classList.toggle('hidden', access);
                
                if(access) this.filterPosts('all', document.querySelector('.chip'));
            },

            filterPosts: function(cat, el) {
                document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
                el.classList.add('active');
                const c = document.getElementById('p-posts'); c.innerHTML='';
                let posts = this.s.posts.filter(p=>p.uid===this.s.viewId);
                if(cat!=='all') posts = posts.filter(p=>p.cat===cat);
                if(posts.length===0) c.innerHTML='<p style="text-align:center;padding:20px;color:gray">Ù¾Ø³ØªÛŒ Ù†ÛŒØ³Øª</p>';
                posts.sort((a,b)=>b.time-a.time).forEach(p=>c.innerHTML+=this.htmlPost(p));
            },

            actFollow: function() {
                if(this.s.guest) return this.toast('Ù…Ù‡Ù…Ø§Ù†');
                const uid = this.s.viewId;
                const me = this.s.user;
                const u = this.s.users.find(x=>x.id===uid);
                
                let type = 'follow';
                if(me.following.includes(uid)) type = 'unfollow';
                
                // Optimistic
                if(type==='follow') {
                    if(u.isPrivate) u.requests.push(me.id);
                    else { me.following.push(uid); u.followers.push(me.id); }
                } else {
                    me.following = me.following.filter(x=>x!==uid);
                    u.followers = u.followers.filter(x=>x!==me.id);
                }
                this.renderProf(uid);
                fetch(API, { method:'POST', body:JSON.stringify({act:'follow', from:me.id, to:uid}) });
            },

            // --- MESSAGES ---
            renderMsg: function(mode) {
                const c = document.getElementById('msg-list'); c.innerHTML='';
                const me = this.s.user;
                if(this.s.guest) return c.innerHTML='<p style="text-align:center">Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</p>';

                if(mode==='req') {
                    if(me.requests.length===0) c.innerHTML='<p style="text-align:center">Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ Ù†ÛŒØ³Øª</p>';
                    me.requests.forEach(rid=>{
                        c.innerHTML += `
                        <div class="card flex-between">
                            ${this.htmlUser(rid)}
                            <div>
                                <button class="btn-sm btn-primary" onclick="app.ansReq('${rid}',true)">âœ”</button>
                                <button class="btn-sm btn-outline" onclick="app.ansReq('${rid}',false)">âœ–</button>
                            </div>
                        </div>`;
                    });
                } else {
                    const chats = [...new Set(this.s.msgs.filter(m=>m.from===me.id || m.to===me.id).map(m=> m.from===me.id?m.to:m.from))];
                    if(chats.length===0) c.innerHTML='<p style="text-align:center">Ú¯ÙØªÚ¯ÙˆÛŒÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</p>';
                    chats.forEach(pid=>{
                        const last = this.s.msgs.filter(m=>(m.from===me.id && m.to===pid)||(m.from===pid && m.to===me.id)).pop();
                        c.innerHTML += `
                        <div class="card" onclick="app.openChat('${pid}')">
                            <div class="flex-between">
                                ${this.htmlUser(pid)}
                                <small>${new Date(last.time).toLocaleTimeString('fa-IR')}</small>
                            </div>
                            <p style="margin-top:5px;color:gray;font-size:0.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${last.text}</p>
                        </div>`;
                    });
                }
            },

            ansReq: function(uid, acc) {
                const me = this.s.user;
                me.requests = me.requests.filter(x=>x!==uid);
                const u = this.s.users.find(x=>x.id===uid);
                if(acc) { me.followers.push(uid); u.following.push(me.id); }
                this.renderMsg('req');
                fetch(API, { method:'POST', body:JSON.stringify({act:'req', from:uid, to:me.id, acc}) });
            },

            openChat: function(uid) {
                if(this.s.guest) return this.toast('Ù…Ù‡Ù…Ø§Ù†');
                const u = this.s.users.find(x=>x.id===uid);
                if(!u.allowMsg && !u.following.includes(this.s.user.id)) return this.toast('Ù¾ÛŒØ§Ù… Ø¨Ø³ØªÙ‡ Ø§Ø³Øª');
                
                this.s.chatPid = uid;
                document.getElementById('screen-chat').classList.remove('hidden');
                document.getElementById('chat-head').innerText = u.name;
                this.renderChat();
            },

            renderChat: function() {
                const box = document.getElementById('chat-box');
                box.innerHTML = '';
                const me = this.s.user.id;
                const you = this.s.chatPid;
                const msgs = this.s.msgs.filter(m=>(m.from==me && m.to==you)||(m.from==you && m.to==me));
                
                msgs.forEach(m => {
                    const cls = m.from===me ? 'background:#e0e7ff; align-self:flex-end' : 'background:white; align-self:flex-start; border:1px solid #ddd';
                    box.innerHTML += `<div style="padding:10px; border-radius:12px; max-width:80%; ${cls}">${m.text}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            },

            sendChat: function() {
                const txt = document.getElementById('chat-in').value;
                if(!txt) return;
                const m = { from:this.s.user.id, to:this.s.chatPid, text:txt, time:Date.now() };
                this.s.msgs.push(m);
                this.renderChat();
                document.getElementById('chat-in').value = '';
                fetch(API, { method:'POST', body:JSON.stringify({act:'msg', ...m}) });
            },

            // --- SETTINGS ---
            renderSet: function() {
                if(this.s.guest) return document.getElementById('sec-set').innerHTML='<p class="card" style="text-align:center">Ø´Ù…Ø§ Ù…Ù‡Ù…Ø§Ù† Ù‡Ø³ØªÛŒØ¯</p>';
                const u = this.s.user;
                document.getElementById('set-d-name').innerText = u.name;
                document.getElementById('set-d-id').innerText = '@'+u.id;
                document.getElementById('set-d-nc').innerText = u.nc;
                document.getElementById('set-d-code').innerText = u.refCode;
                
                document.getElementById('set-pic').value = u.pic || '';
                document.getElementById('set-name').value = u.name;
                document.getElementById('set-bio').value = u.bio;
                document.getElementById('set-link').value = u.web || '';
                document.getElementById('set-mention').value = u.mention || '';
                document.getElementById('set-priv').checked = u.isPrivate;
                document.getElementById('set-amsg').checked = u.allowMsg;
            },

            saveSet: async function() {
                this.loading('btn-save', true);
                const u = this.s.user;
                u.pic = document.getElementById('set-pic').value;
                u.name = document.getElementById('set-name').value;
                u.bio = document.getElementById('set-bio').value;
                u.web = document.getElementById('set-link').value;
                u.mention = document.getElementById('set-mention').value;
                u.isPrivate = document.getElementById('set-priv').checked;
                u.allowMsg = document.getElementById('set-amsg').checked;
                
                await fetch(API, { method:'POST', body:JSON.stringify({act:'update', user:u}) });
                this.toast('Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
                this.loading('btn-save', false);
            },

            // --- SHARED UTILS ---
            shareLink: (type, id) => {
                const base = location.origin + location.pathname;
                const link = type==='prof' ? base+'?u='+(app.s.viewId) : base+'?p='+id;
                app.s.share = { text: 'Ø§Ø´ØªØ±Ø§Ú© Ú¯Ø°Ø§Ø±ÛŒ', link };
                document.getElementById('modal-share').classList.remove('hidden');
            },
            doShareExt: () => {
                const d = app.s.share;
                if(navigator.share) navigator.share({title:'Social', text:d.text, url:d.link});
                else prompt('Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯:', d.link);
            },
            openSharePick: () => {
                document.getElementById('modal-share').classList.add('hidden');
                document.getElementById('modal-pick').classList.remove('hidden');
            },
            filterPick: (q) => {
                const b = document.getElementById('pick-list'); b.innerHTML='';
                app.s.users.filter(u=>u.id.includes(q) && u.id!==app.s.user.id).forEach(u=>{
                    b.innerHTML += `<div class="flex-between card" style="padding:10px">${app.htmlUser(u.id)} <button class="btn-sm btn-primary" onclick="app.sendShareInt('${u.id}')">Ø§Ø±Ø³Ø§Ù„</button></div>`;
                });
            },
            sendShareInt: (uid) => {
                app.s.msgs.push({from:app.s.user.id, to:uid, text:app.s.share.link, time:Date.now()});
                fetch(API, {method:'POST', body:JSON.stringify({act:'msg', from:app.s.user.id, to:uid, text:app.s.share.link})});
                document.getElementById('modal-pick').classList.add('hidden');
                app.toast('Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯');
            },
            search: (q) => {
                app.nav('search');
                const b = document.getElementById('search-box'); b.innerHTML = '';
                app.s.users.filter(u=>u.id.includes(q)||u.name.includes(q)).forEach(u=>{
                    b.innerHTML += `<div class="card">${app.htmlUser(u.id)}</div>`;
                });
            },
            showModalList: (type) => {
                const u = app.s.users.find(x=>x.id===app.s.viewId);
                const l = type==='followers'?u.followers:u.following;
                // Privacy Check logic omitted for brevity, assumes accessible if profile visible
                const b = document.getElementById('list-body'); b.innerHTML='';
                if(type === 'Ù¾Ø³Øª') return; // Just scroll down
                l.forEach(id => b.innerHTML+=`<div style="margin-bottom:10px">${app.htmlUser(id)}</div>`);
                document.getElementById('list-title').innerText = type;
                document.getElementById('modal-list').classList.remove('hidden');
            },
            badges: () => {
                const req = app.s.user.requests.length;
                const unread = app.s.msgs.filter(m=>m.to===app.s.user.id && !m.read).length; // Need read flag logic
                const t = req+unread;
                const b1 = document.getElementById('badge-nav');
                const b2 = document.getElementById('badge-req');
                if(t>0) { b1.innerText=t; b1.classList.remove('hidden'); } else b1.classList.add('hidden');
                if(req>0) { b2.innerText=req; b2.classList.remove('hidden'); } else b2.classList.add('hidden');
            }
        };

        app.init();
    </script>
</body>
</html>
