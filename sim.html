 <!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sosial Sim</title>
    
    <!-- Modern Font: Vazirmatn -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    
    <!-- Modern Icons: Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root {
            /* Palette: Modern Instagram-like (Clean White/Gray with Blue Accent) */
            --p: #0095f6;      /* Primary Blue */
            --pd: #0074cc;     /* Primary Dark */
            --bg: #fafafa;     /* Background */
            --s: #ffffff;      /* Surface */
            --t: #262626;      /* Text Main */
            --tg: #8e8e8e;     /* Text Grey */
            --bor: #dbdbdb;    /* Border */
            --err: #ed4956;    /* Error/Like Red */
            --suc: #0095f6;    /* Success (Greenish blue in modern apps, or use green) */
            --suc-real: #00c851;
            --sh: 0 1px 2px rgba(0,0,0,0.05); 
            --rad: 12px;       /* Modern Radius */
            --font-main: 'Vazirmatn', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family: var(--font-main); -webkit-tap-highlight-color:transparent; outline:none; }
        body { background:var(--bg); color:var(--t); padding-bottom:70px; overflow-x:hidden; user-select:none; font-size: 14px; }
        .con { max-width:470px; margin:0 auto; padding:15px; min-height:100vh; }
        .hide { display:none !important; }
        .flex-bw { display:flex; justify-content:space-between; align-items:center; }
        .flex-c { display:flex; flex-direction:column; }
        
        /* Typography */
        h1, h2, h3, h4 { font-weight: 700; color: var(--t); }
        
        /* Modern UI Components */
        .card { 
            background:var(--s); 
            border-radius:var(--rad); 
            padding:16px; 
            margin-bottom:12px; 
            box-shadow:var(--sh); 
            border:1px solid var(--bor); 
            position:relative; 
            transition:transform 0.2s; 
        }

        /* Modern Input */
        .inp { 
            width:100%; 
            padding:12px 14px; 
            border:1px solid var(--bor); 
            border-radius:8px; 
            background:#fafafa; 
            font-size:0.95rem; 
            margin-bottom:10px; 
            transition:0.3s; 
            color: var(--t);
        }
        .inp:focus { border-color:var(--tg); background:var(--s); }
        textarea.inp { resize: none; }

        /* Modern Buttons */
        .btn { 
            width:100%; 
            padding:10px; 
            border-radius:8px; 
            font-weight:600; 
            font-size:0.95rem; 
            display:flex; 
            justify-content:center; 
            align-items:center; 
            gap:6px; 
            cursor:pointer; 
            border:none; 
            transition:0.2s; 
        }
        .btn:active { opacity: 0.7; }
        .btn-p { background:var(--p); color:white; }
        .btn-o { border:1px solid var(--bor); color:var(--t); background:transparent; }
        .btn-s { padding:5px 12px; font-size:0.85rem; width:auto; border-radius:6px; }
        .btn-i { font-size:1.6rem; padding:4px; color:var(--t); background:transparent; border:none; cursor:pointer; display:flex; align-items:center; }
        
        /* Password Toggle */
        .pwd-wrap { position: relative; margin-bottom: 10px; }
        .pwd-wrap .inp { margin-bottom: 0; }
        .pwd-tog { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; color:var(--tg); z-index:5; font-size: 1.2rem; display:flex; align-items:center;}

        /* Loading Spinner */
        .loading { position:relative; color:transparent !important; pointer-events:none; }
        .loading::after { content:""; position:absolute; left:50%; top:50%; width:20px; height:20px; border:2px solid #fff; border-top-color:transparent; border-radius:50%; animation:rot 0.8s linear infinite; transform:translate(-50%,-50%); }
        @keyframes rot { to { transform:translate(-50%,-50%) rotate(360deg); } }

        /* Skeleton */
        .skel { background:linear-gradient(90deg, #efefef 25%, #fcfcfc 50%, #efefef 75%); background-size:200% 100%; animation:shm 1.5s infinite; border-radius:4px; }
        @keyframes shm { 0% { background-position:200% 0; } 100% { background-position:-200% 0; } }
        .sk-av { width:42px; height:42px; border-radius:50%; }
        .sk-ln-sm { height:10px; width:40%; border-radius:4px; }
        .sk-ln-md { height:10px; width:60%; border-radius:4px; }
        .skel-card .flex-bw { margin-bottom: 15px; }

        /* Avatar */
        .u-blk { display:flex; align-items:center; gap:10px; cursor:pointer; }
        .u-img { width:42px; height:42px; border-radius:50%; object-fit:cover; background:#efefef; border:1px solid var(--bor); }
        .u-nm { font-weight:600; font-size:0.9rem; color:var(--t); }
        .u-id { font-size:0.75rem; color:var(--tg); }

        /* Bottom Nav (Glassmorphism) */
        .nav { 
            position:fixed; bottom:0; left:0; right:0; 
            background:rgba(255,255,255,0.95); 
            backdrop-filter:blur(10px); 
            border-top:1px solid var(--bor); 
            display:flex; justify-content:space-around; 
            padding:12px 0; z-index:900; 
        }
        .n-it { 
            font-size:1.6rem; 
            color:var(--t); 
            transition:0.2s; 
            position:relative; 
            cursor:pointer; 
            display:flex;
            flex-direction: column;
            align-items: center;
        }
        .n-it.active { color:var(--t); }
        .n-it.active i { font-weight: bold; } /* Using bold weight for active state in Phosphor */
        .n-it i { font-weight: regular; }
        .bdg { position:absolute; top:-2px; right:-2px; background:var(--err); color:white; font-size:0.6rem; padding:1px 5px; border-radius:10px; border:2px solid white; font-weight:bold; min-width:16px; text-align:center; }

        /* Profile Header */
        .p-top { display:flex; align-items:center; gap:20px; margin-bottom:15px; }
        .p-pic { width:80px; height:80px; border-radius:50%; border:1px solid var(--bor); object-fit:cover; background:#efefef; cursor: pointer; }
        .p-sts { flex:1; display:flex; justify-content:space-around; text-align:center; }
        .st-n { font-weight:700; font-size:1.1rem; display:block; color:var(--t); }
        .st-l { font-size:0.8rem; color:var(--t); }
        
        .chips { display:flex; gap:8px; overflow-x:auto; padding:5px 0 10px; scrollbar-width:none; }
        .chip { padding:6px 16px; border-radius:8px; background:var(--s); border:1px solid var(--bor); white-space:nowrap; font-size:0.85rem; transition:0.2s; cursor:pointer; color:var(--t); font-weight:600; }
        .chip.active { background:var(--t); color:white; border-color:var(--t); }
        
        .p-pic-fallback { width:80px; height:80px; border-radius:50%; border:1px solid var(--bor); background:linear-gradient(45deg,#f09433,#bc1888); display: flex; align-items: center; justify-content: center; font-size: 2rem; color: white; font-weight: bold; cursor: pointer; }

        /* Feed Post */
        .p-act { display:flex; justify-content:space-between; align-items:center; margin-top:10px; padding-top:8px; }
        .p-act-left { display: flex; gap: 16px; }
        .act-b { display:flex; align-items:center; gap:4px; cursor:pointer; font-size:1.5rem; color: var(--t); transition:0.2s; }
        .act-b:active { transform: scale(0.85); }
        .act-b.lk { color:var(--err); }
        .act-b.lk i { font-weight: fill; }
        .ment { color:var(--pd); font-weight:600; cursor:pointer; text-decoration:none; }
        .url-link { color: var(--pd); text-decoration: none; font-weight: 500; cursor: pointer; }
        .post-opts-btn { font-size:1.2rem; color:var(--t); cursor:pointer; position:absolute; left:16px; top:16px; }
        
        .p-menu { position: absolute; left: 16px; top: 40px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; overflow: hidden; display: none; width: 140px; }
        .p-menu.show { display: block; animation: fadeIn 0.1s; }
        .p-menu-item { padding: 12px; font-size: 0.9rem; cursor: pointer; transition: 0.1s; display: flex; align-items: center; gap: 8px; color: var(--t); }
        .p-menu-item:hover { background: #fafafa; }
        .p-menu-item.del { color: var(--err); }

        /* Upload */
        .prog-c { position:relative; height:4px; background:#efefef; width:100%; margin-top:15px; border-radius:2px; overflow:hidden; display:none; }
        .fill { height:100%; background:var(--p); width:0%; transition:width 0.4s ease-out; }
        .up-msg { font-size:0.85rem; color:var(--suc-real); text-align:center; display:none; margin-top:8px; font-weight:600; animation:fadeIn 0.5s; }
        .sending { opacity:0.8; pointer-events:none; border:none; background:#fff; }

        /* Chat */
        .tik { font-size:0.8rem; margin-right:4px; vertical-align:middle; display:inline-flex; }
        .tik.wait { color:#cbd5e1; }
        .tik.sent { color:#8e8e8e; }
        .tik.read { color:#0095f6; }
        
        .msg-bub { padding:10px 14px; border-radius:22px; max-width:80%; margin-bottom:6px; position:relative; word-wrap:break-word; font-size: 0.95rem; line-height: 1.4; user-select: none; }
        .msg-me { background:#3797f0; color:white; align-self:flex-end; border-bottom-left-radius:22px; border-bottom-right-radius:4px; }
        .msg-me .url-link, .msg-me .ment { color: white; text-decoration: underline; }
        .msg-me.pending { opacity: 0.7; }
        .msg-ot { background:#efefef; color:var(--t); align-self:flex-start; border-bottom-left-radius:4px; }
        .msg-tm { font-size:0.65rem; margin-top:4px; display:flex; align-items:center; justify-content:flex-end; opacity:0.7; gap: 2px; }
        
        /* Modals */
        .mod-bg { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:3000; display:flex; align-items:flex-end; justify-content:center; opacity:0; pointer-events:none; transition:0.2s; }
        .mod-bg.show { opacity:1; pointer-events:all; }
        .mod { background:var(--s); width:100%; max-width:470px; border-radius:16px 16px 0 0; padding:20px; max-height:85vh; overflow-y:auto; transform:translateY(100%); transition:transform 0.2s cubic-bezier(0.1, 0.9, 0.2, 1); }
        .mod-bg.show .mod { transform:translateY(0); }
        
        /* Settings Page Modernization */
        .set-grp { background: var(--s); border: 1px solid var(--bor); border-radius: var(--rad); overflow: hidden; margin-bottom: 20px; }
        .set-it { padding: 15px; border-bottom: 1px solid var(--bor); display: flex; align-items: center; justify-content: space-between; font-size: 0.95rem; }
        .set-it:last-child { border-bottom: none; }
        .set-it label { display: flex; align-items: center; gap: 10px; width: 100%; cursor: pointer; }
        .set-it i { font-size: 1.4rem; color: var(--t); }
        
        /* Toast */
        #tst { position:fixed; top:20px; left:50%; transform:translateX(-50%) translateY(-100px); background:#262626; color:white; padding:10px 20px; border-radius:8px; z-index:4000; font-size:0.9rem; opacity:0; transition:0.3s; display:flex; align-items:center; gap:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); font-weight: 500; }
        #tst.show { opacity:1; transform:translateX(-50%) translateY(0); }
        #tst i { font-size: 1.2rem; }

        /* Shared Post in Chat */
        .msg-post-share { border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; padding: 10px; cursor: pointer; background-color: rgba(255,255,255,0.1); margin: -4px -4px 4px -4px; }
        .msg-me .msg-post-share { background-color: rgba(255,255,255,0.2); border: none; }
        .msg-post-share .u-nm { font-size: 0.8rem; opacity: 0.9; }
        .msg-post-share-title { font-weight: bold; margin-top: 4px; font-size: 0.9rem; }
        .msg-post-share-text { font-size: 0.75rem; opacity: 0.8; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Other Screens */
        #sc-ch, #sc-post { position:fixed; top:0; left:0; right:0; bottom:0; background:var(--bg); z-index:2000; display:flex; flex-direction:column; transform:translateX(100%); transition:transform 0.3s; }
        #sc-ch.show, #sc-post.show { transform:translateX(0); }
        .chat-input-area { padding:10px 15px; background:var(--s); display:flex; gap:10px; border-top:1px solid var(--bor); align-items: flex-end; padding-bottom: 20px; }
        
        /* New Box (Suggested Users) */
        #new-bx { display:flex; gap:15px; overflow-x:auto; padding:5px; scrollbar-width:none; }

        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
    </style>
</head>
<body>

<div id="tst"><i class="ph ph-info"></i> <span>پیام</span></div>

<!-- AUTHENTICATION -->
<div id="scr-auth" class="con" style="height:100vh; display:flex; flex-direction:column; justify-content:center; position:relative; z-index:10;">
    <div style="text-align:center; margin-bottom:30px; animation:pop 1s;">
        <i class="ph ph-aperture" style="font-size: 4rem; color: var(--t);"></i>
        <h1 style="font-family: 'Segoe UI', sans-serif; font-size: 2.2rem; margin-top: 10px; letter-spacing: -1px;">Social</h1>
    </div>

<div id="f-log">
    <div class="card" style="padding: 30px 20px;">
        <input type="text" id="l-nc" class="inp" placeholder="کد ملی" inputmode="numeric">
        <div class="pwd-wrap">
            <input type="password" id="l-ps" class="inp" placeholder="رمز عبور">
            <span class="pwd-tog" onclick="app.togPwd('l-ps', this)"><i class="ph ph-eye"></i></span>
        </div>
        <div style="margin-bottom:20px; font-size:0.85rem; color:var(--tg)"><label style="display:flex; align-items:center; gap:8px"><input type="checkbox" id="l-rem" checked> مرا به خاطر بسپار</label></div>
        <button class="btn btn-p" onclick="app.login(this)">ورود</button>
    </div>
    <div style="text-align:center; margin-top:20px;">
        <span style="color:var(--tg); font-size: 0.9rem;">حساب ندارید؟</span>
        <span style="color:var(--p); cursor:pointer; font-weight:bold; margin-right: 5px;" onclick="app.togAuth()">ثبت نام کنید</span>
    </div>
</div>

<div id="f-reg" class="hide">
    <div class="card" style="padding: 30px 20px;">
        <h2 style="text-align:center; margin-bottom:20px;">ساخت حساب جدید</h2>
        <input type="number" id="r-nc" class="inp" placeholder="کد ملی (۱۰ رقم)" inputmode="numeric">
        <input type="text" id="r-nm" class="inp" placeholder="نام نمایشی (فارسی)">
        <input type="text" id="r-us" class="inp" placeholder="نام کاربری (انگلیسی)">
        <input type="number" id="r-rf" class="inp" placeholder="کد معرف" inputmode="numeric">
        <div class="pwd-wrap">
            <input type="password" id="r-ps" class="inp" placeholder="رمز عبور (حداقل ۸ رقم)">
            <span class="pwd-tog" onclick="app.togPwd('r-ps', this)"><i class="ph ph-eye"></i></span>
        </div>
        <button class="btn btn-p" onclick="app.reg(this)">ثبت نام</button>
    </div>
    <div style="text-align:center; margin-top:20px;">
        <span style="color:var(--p); cursor:pointer; font-weight:bold;" onclick="app.togAuth()">بازگشت به ورود</span>
    </div>
</div>
</div>

<!-- MAIN APP -->
<div id="scr-app" class="hide">

<!-- HOME FEED -->
<section id="s-hm" class="con" style="padding-top: 5px;">
    <div class="flex-bw" style="margin-bottom:15px; padding:0 5px">
        <h2 style="font-family: 'Segoe UI', sans-serif; font-size:1.6rem; letter-spacing: -1px;">Social</h2>
        <div style="font-size:1.6rem; cursor:pointer; position:relative; display: flex;" onclick="app.showNotifs()">
            <i class="ph ph-heart"></i>
            <span id="notif-badge" class="bdg hide" style="top:-2px; right:-2px;"></span>
        </div> 
    </div>
    
    <div style="position: relative; margin-bottom: 20px;">
        <i class="ph ph-magnifying-glass" style="position: absolute; right: 12px; top: 12px; color: var(--tg); font-size: 1.1rem;"></i>
        <input type="text" id="hm-sr" class="inp" placeholder="جستجو..." onkeyup="app.checkSearch(this)" style="border-radius:10px; border:none; background:#efefef; padding-right: 40px; margin-bottom: 0;">
    </div>
    
    <div style="margin-bottom:20px;">
        <div id="new-bx"></div>
    </div>

    <div id="feed-up"></div> 
    <div id="feed"></div>
    <div id="feed-ldr" style="text-align:center; padding:20px; display:none"><span class="loading" style="color:var(--tg)!important"></span></div>
    <button id="hm-more" class="btn btn-o hide" style="border:none; color:var(--p);" onclick="app.loadOldPosts()">مشاهده پست‌های قدیمی‌تر</button>
</section>

<!-- PROFILE -->
<section id="s-pr" class="con hide">
    <div style="background:var(--s); margin:-15px -15px 10px -15px; padding:15px 20px; border-bottom:1px solid var(--bor);">
        <div class="flex-bw" style="margin-bottom:20px">
            <button class="btn-i" id="bp-bk" onclick="app.nav('hm')"><i class="ph ph-arrow-right"></i></button>
            <h3 id="p-hd" style="font-size:1rem; font-weight: 700;"></h3>
            <button class="btn-i" id="p-mn-btn" onclick="app.togProfMenu(event)"><i class="ph ph-dots-three-vertical"></i></button>
            
            <div id="p-mn" class="p-menu">
                <div class="p-menu-item" onclick="app.share('prof')"><i class="ph ph-share-network"></i> اشتراک‌گذاری</div>
                <div id="mn-blk" class="p-menu-item del" onclick="app.block()"><i class="ph ph-prohibit"></i> مسدود کردن</div>
            </div>
        </div>
        
        <div class="p-top">
            <div id="p-pic-con"></div>
            <div class="p-sts">
                <div onclick="app.list('posts')"><span class="st-n" id="c-pt">0</span><span class="st-l">پست</span></div>
                <div onclick="app.list('fol')"><span class="st-n" id="c-fl">0</span><span class="st-l">دنبال‌کننده</span></div>
                <div onclick="app.list('fing')"><span class="st-n" id="c-fi">0</span><span class="st-l">دنبال‌شونده</span></div>
            </div>
        </div>
        
        <div>
            <h3 id="p-nm"></h3>
            <div style="color:var(--tg); font-size:0.9rem; margin-bottom:5px" dir="ltr">@<span id="p-id"></span></div>
            <p id="p-bi" style="font-size:0.9rem; line-height:1.5; color:var(--t); white-space: pre-wrap;"></p>
            <div id="p-lnk" style="margin-top:5px; font-size:0.9rem; color:var(--pd); font-weight: 500;"></div>
            
            <div class="flex-bw" id="p-act" style="margin-top:15px; gap:8px; border-top: none; padding-top: 0;">
                <button id="b-fl" class="btn btn-p" onclick="app.fol()">دنبال کردن</button>
                <button id="b-msg" class="btn btn-o" onclick="app.chat(app.st.vid)">پیام</button>
            </div>
        </div>
    </div>

    <div id="p-con">
        <div class="chips" style="padding: 0 5px 15px 5px;">
            <span class="chip active" onclick="app.flt('all',this)">همه</span>
            <span class="chip" onclick="app.flt('book',this)">کتاب</span>
            <span class="chip" onclick="app.flt('movie',this)">فیلم</span>
            <span class="chip" onclick="app.flt('site',this)">سایت</span>
        </div>
        <div id="p-pts" style="padding-bottom:20px"></div>
    </div>
    <div id="p-lck" class="card hide" style="text-align:center; padding:50px; border:none; box-shadow:none; background: transparent;">
        <i class="ph ph-lock-key" style="font-size: 4rem; color: var(--t);"></i>
        <h3 style="margin-top: 10px;">حساب خصوصی</h3>
        <p style="color:var(--tg); font-size: 0.9rem;">برای دیدن پست‌ها باید این کاربر را دنبال کنید.</p>
    </div>
</section>

<!-- ADD POST -->
<section id="s-ad" class="con hide">
    <div class="flex-bw" style="margin-bottom: 20px;">
         <h2 id="a-header">پست جدید</h2>
         <span style="color:var(--p); font-weight:bold; cursor:pointer;" id="btn-pub" onclick="app.pub(this)">اشتراک‌گذاری</span>
    </div>
    
    <div class="card" id="post-card" style="padding:15px; border:none; box-shadow:none; background:transparent;">
        <div style="display:flex; gap: 15px; margin-bottom: 20px;">
             <div class="u-img" style="width: 50px; height: 50px; flex-shrink: 0; display:flex; align-items:center; justify-content:center; background:#efefef;" id="add-post-av"><i class="ph ph-user"></i></div>
             <textarea id="a-tx" class="inp" rows="6" placeholder="چه خبری دارید؟..." style="border:none; background:transparent; padding: 10px 0; font-size: 1rem;"></textarea>
        </div>
        
        <div style="border-top: 1px solid var(--bor); padding-top: 15px;">
             <input type="text" id="a-ti" class="inp" placeholder="عنوان پست (اختیاری)" style="border:none; border-bottom: 1px solid var(--bor); border-radius: 0; padding-left:0; padding-right:0;">
             
             <div class="flex-bw" style="margin-top: 15px;">
                 <label style="color:var(--t); font-weight:600;">دسته‌بندی</label>
                 <select id="a-ct" class="inp" style="width: auto; margin:0; border:none; color:var(--p); font-weight:bold; background: transparent;"></select>
             </div>
        </div>

        <div class="prog-c" id="p-prg"><div class="fill" id="p-fil"></div></div>
        <div class="up-msg" id="p-msg"><i class="ph ph-check-circle"></i> آپلود شد!</div>
        
        <button class="btn btn-o" style="margin-top:20px; display:none; border-color: var(--err); color: var(--err);" id="btn-cncl-edit" onclick="app.cancelEdit()">لغو ویرایش</button>
    </div>
</section>

<!-- MESSAGES -->
<section id="s-ms" class="con hide">
    <div class="flex-bw" style="margin-bottom:20px">
        <h2 style="font-size: 1.4rem;">پیام‌ها</h2>
        <i class="ph ph-note-pencil" style="font-size: 1.6rem;"></i>
    </div>
    <div style="position: relative; margin-bottom: 20px;">
        <i class="ph ph-magnifying-glass" style="position: absolute; right: 12px; top: 12px; color: var(--tg); font-size: 1.1rem;"></i>
        <input type="text" class="inp" placeholder="جستجو..." onkeyup="app.filterChats(this.value)" style="border-radius:10px; border:none; background:#efefef; padding-right: 40px; margin-bottom: 0;">
    </div>
    
    <div id="req-box"></div> 
    <div id="msg-bx"></div>
</section>

<!-- SETTINGS (MODERNIZED) -->
<section id="s-st" class="con hide">
    <h2 style="margin-bottom:20px;">تنظیمات</h2>
    
    <!-- Profile Card -->
    <div class="set-grp" style="text-align: center; padding: 20px;">
        <div style="width: 80px; height: 80px; margin: 0 auto 10px auto; position: relative;">
            <img id="st-av-img" src="" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; background: #efefef; display:none;">
            <div id="st-av-ph" style="width: 100%; height: 100%; border-radius: 50%; background: #efefef; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: var(--tg);"><i class="ph ph-user"></i></div>
        </div>
        <h3 id="st-nm" style="font-size: 1.2rem;"></h3>
        <div id="st-id" style="color: var(--tg); font-size: 0.9rem;" dir="ltr"></div>
        <div style="margin-top: 5px; font-size: 0.8rem; background: #efefef; display: inline-block; padding: 2px 8px; border-radius: 4px;">کد دعوت: <span id="st-cd"></span></div>
    </div>

    <!-- Account Edit -->
    <h4 style="margin: 15px 5px 10px; font-size: 0.9rem; color: var(--tg);">حساب کاربری</h4>
    <div class="set-grp">
        <div class="set-it">
            <input type="text" id="st-pc" class="inp" placeholder="لینک تصویر پروفایل" style="margin:0; border:none; background:transparent;">
            <i class="ph ph-image"></i>
        </div>
        <div class="set-it">
            <input type="text" id="st-nn" class="inp" placeholder="نام نمایشی" style="margin:0; border:none; background:transparent;">
            <i class="ph ph-user-circle"></i>
        </div>
        <div class="set-it">
            <textarea id="st-bi" class="inp" placeholder="بیوگرافی" rows="1" style="margin:0; border:none; background:transparent;"></textarea>
            <i class="ph ph-text-aa"></i>
        </div>
        <div class="set-it">
            <input type="text" id="st-ln" class="inp" placeholder="وب‌سایت" style="margin:0; border:none; background:transparent;">
            <i class="ph ph-link"></i>
        </div>
    </div>

    <!-- Privacy & Settings -->
    <h4 style="margin: 15px 5px 10px; font-size: 0.9rem; color: var(--tg);">حریم خصوصی و امکانات</h4>
    <div class="set-grp">
        <div class="set-it">
            <label><i class="ph ph-lock-key"></i> حساب خصوصی</label>
            <input type="checkbox" id="st-pr" style="transform:scale(1.2)">
        </div>
        <div class="set-it">
            <label><i class="ph ph-chat-teardrop-dots"></i> دریافت پیام</label>
            <input type="checkbox" id="st-al" style="transform:scale(1.2)">
        </div>
    </div>

    <!-- Custom Categories -->
    <h4 style="margin: 15px 5px 10px; font-size: 0.9rem; color: var(--tg);">دسته‌بندی‌های من (<span id="cat-count">0</span>/20)</h4>
    <div class="set-grp" style="padding: 15px;">
        <div id="st-cats-list" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:15px;"></div>
        <div class="flex-bw" style="gap:10px;">
            <input type="text" id="st-new-cat" class="inp" placeholder="جدید..." maxlength="10" style="margin:0;">
            <button class="btn btn-s btn-p" onclick="app.addCat()"><i class="ph ph-plus"></i></button>
        </div>
    </div>

    <!-- Blocked Users -->
    <h4 style="margin: 15px 5px 10px; font-size: 0.9rem; color: var(--tg);">کاربران مسدود شده</h4>
    <div class="set-grp" style="padding: 0;">
        <div id="st-blk-list" style="max-height:150px; overflow-y:auto; padding: 10px;"></div>
    </div>

    <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
        <button class="btn btn-p" onclick="app.sav(this)">ذخیره تغییرات</button>
        <button class="btn btn-o" style="color:var(--err); border-color:var(--bor);" onclick="app.out()">خروج از حساب</button>
    </div>
</section>

<!-- SEARCH RESULTS -->
<section id="s-sr" class="con hide">
    <div class="flex-bw" style="margin-bottom: 20px;">
        <button class="btn-i" onclick="app.nav('hm')"><i class="ph ph-arrow-right"></i></button>
        <h3>جستجو</h3>
        <div style="width: 32px;"></div>
    </div>
    
    <div class="flex-bw" style="gap:10px; margin-bottom: 15px;">
        <input type="text" id="sr-inp" class="inp" placeholder="شناسه کاربر..." style="margin:0">
        <button class="btn btn-p" style="width:auto;" onclick="app.doSearch()"><i class="ph ph-magnifying-glass"></i></button>
    </div>
    
    <div id="sr-res"></div>
    <button id="sr-more" class="btn btn-o hide" onclick="app.loadMoreSearch()">نمایش بیشتر</button>
</section>

<!-- SINGLE POST VIEW -->
<div id="sc-post">
    <div class="con">
         <div class="flex-bw" style="margin-bottom:15px; border-bottom:1px solid var(--bor); padding-bottom:15px;">
            <button class="btn-i" onclick="app.closePostView()"><i class="ph ph-arrow-right"></i></button>
            <h3 style="font-size: 1rem;">پست</h3>
            <div style="width:30px"></div>
        </div>
        <div id="sc-post-content"></div>
    </div>
</div>

<!-- BOTTOM NAV -->
<div class="nav">
    <div class="n-it active" id="n-hm" onclick="app.nav('hm')"><i class="ph ph-house-fill"></i></div>
    <div class="n-it" id="n-ad" onclick="app.nav('ad')"><i class="ph ph-plus-square"></i></div>
    <div class="n-it" id="n-ms" onclick="app.nav('ms')"><i class="ph ph-chat-circle-dots"></i> <span id="b-nv" class="bdg hide"></span></div>
    <div class="n-it" id="n-pr" onclick="app.nav('pr')"><i class="ph ph-user"></i></div>
    <div class="n-it" id="n-st" onclick="app.nav('st')"><i class="ph ph-gear"></i></div>
</div>
</div>

<!-- MODALS -->
<div id="m-sh" class="mod-bg" onclick="if(event.target==this) this.classList.remove('show')">
    <div class="mod">
        <h3 style="text-align: center; margin-bottom: 20px;">اشتراک‌گذاری</h3>
        <div class="set-grp">
             <div class="set-it" onclick="app.copyLink()" style="cursor: pointer;">
                 <label><i class="ph ph-link"></i> کپی کردن لینک</label>
             </div>
             <div class="set-it" onclick="app.doSh()" style="cursor: pointer;">
                 <label><i class="ph ph-share-network"></i> ارسال به برنامه دیگر</label>
             </div>
        </div>
    </div>
</div>

<div id="m-pk" class="mod-bg" onclick="if(event.target==this) this.classList.remove('show')">
    <div class="mod">
        <h3 id="pk-tt" style="margin-bottom: 10px;">ارسال به...</h3>
        <input type="text" class="inp" onkeyup="app.flP(this.value)" placeholder="جستجو...">
        <div id="pk-ls" style="max-height:300px; overflow-y:auto; margin-top:10px"></div>
    </div>
</div>

<div id="m-ls" class="mod-bg" onclick="if(event.target==this) this.classList.remove('show')">
    <div class="mod">
        <h3 id="ls-tt" style="margin-bottom: 15px;">لیست</h3>
        <div id="ls-bd" style="max-height:400px; overflow-y:auto"></div>
    </div>
</div>

<div id="m-cm" class="mod-bg" onclick="if(event.target==this) this.classList.remove('show')">
    <div class="mod" style="height: 75vh; max-height: 75vh; display: flex; flex-direction: column; padding: 0;">
        <div style="padding: 15px; border-bottom: 1px solid var(--bor); text-align: center;"><h3>نظرات</h3></div>
        <div id="cm-bd" style="flex: 1; overflow-y:auto; padding: 15px;"></div>
        <div class="chat-input-area" style="padding-bottom: 25px;">
            <div style="width: 40px; height: 40px; border-radius: 50%; background: #efefef; display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;" id="cm-av">
                <i class="ph ph-user"></i>
            </div>
            <textarea id="cm-in" class="chat-textarea" placeholder="نظر دهید..." style="height:45px; min-height:45px; border-radius: 22px; padding: 12px 15px;"></textarea>
            <button class="btn btn-p" style="width:auto; border-radius: 50%; width: 45px; height: 45px; padding: 0;" onclick="app.sndC(this)"><i class="ph ph-paper-plane-right" style="font-size: 1.2rem;"></i></button>
        </div>
    </div>
</div>

<div id="m-nt" class="mod-bg" onclick="if(event.target==this) this.classList.remove('show')">
    <div class="mod">
        <h3 style="margin-bottom: 15px;">اعلان‌ها</h3>
        <div id="nt-bd" style="max-height:400px; overflow-y:auto"></div>
    </div>
</div>

<div id="m-mo" class="mod-bg" onclick="if(event.target==this) this.classList.remove('show')">
    <div class="mod">
        <div class="set-grp" style="margin-bottom: 0;">
            <div class="set-it" onclick="app.doCopyMsg()" style="cursor: pointer;">
                <label><i class="ph ph-copy"></i> کپی متن</label>
            </div>
            <div class="set-it" onclick="app.doDeleteMsg()" style="cursor: pointer; color: var(--err);">
                <label style="color: var(--err);"><i class="ph ph-trash"></i> حذف پیام</label>
            </div>
        </div>
    </div>
</div>

<div id="m-img" class="mod-bg" onclick="this.classList.remove('show')" style="z-index: 5000; background: rgba(0,0,0,0.9);">
    <img id="img-vw" src="" onclick="event.stopPropagation()" style="border-radius: 0; border: none; box-shadow: none; max-height: 100vh;">
</div>

<!-- CHAT SCREEN -->
<div id="sc-ch">
    <div class="flex-bw" style="padding:15px; border-bottom:1px solid var(--bor); background:rgba(255,255,255,0.95); backdrop-filter:blur(5px)">
        <div style="display: flex; align-items: center; gap: 10px;">
            <button class="btn-i" onclick="document.getElementById('sc-ch').classList.remove('show')"><i class="ph ph-arrow-right"></i></button>
            <div id="ch-inf" style="cursor:pointer; display:flex; align-items:center; gap:10px" onclick="app.nav('pr', app.st.cpid)">
                <img id="ch-im" src="" style="width:36px; height:36px; border-radius:50%; background:#efefef; object-fit: cover;">
                <div>
                    <div style="font-weight:700; font-size:0.95rem" id="ch-hd"></div>
                    <div style="font-size:0.75rem; color:var(--tg);">کاربر</div>
                </div>
            </div>
        </div>
        <i class="ph ph-info" style="font-size: 1.5rem; color: var(--t);"></i>
    </div>
    
    <div id="ch-bx" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:4px; background:var(--s);"></div>
    
    <div class="chat-input-area">
        <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--p); display: flex; align-items: center; justify-content: center; flex-shrink: 0; cursor: pointer;">
             <i class="ph ph-camera" style="color: white; font-size: 1.2rem;"></i>
        </div>
        <textarea id="ch-in" class="chat-textarea" placeholder="پیام..." style="border-radius: 22px; padding: 12px 15px; background: #efefef; border: none;"></textarea>
        <button class="btn" style="width:auto; color: var(--p); padding: 0 0 10px 0; background: transparent; font-weight: bold;" onclick="app.sndM()">ارسال</button>
    </div>
</div>

<script>
    // ************************************************************
    // *********************** IMPORTANT **************************
    // REPLACE THIS URL WITH YOUR NEW DEPLOYMENT URL
    // ************************************************************
    const API_URL = 'https://script.google.com/macros/s/AKfycbyf_X4VQfe1YC95wWXkUkFrHAHDOCTmC6qzzsNCp-O57HvGikcAPZWlPAbS_9_kWrYI/exec';

    const app = {
        st: { user:null, users:[], posts:[], msgs:[], vid:null, shr:null, cpid:null, guest:false, page:1, limit:20, syncing:false, postToSend: null, pickerMode: null, searchLimit: 10, tempUsers: [], isLoadingOld: false, editingPost: null, selectedMsg: null },
        longPressTimer: null,
        
        init: async function() {
            this.showInitialSkeletons();
            if(localStorage.getItem('db')) {
                const db = JSON.parse(localStorage.getItem('db'));
                this.st.users=db.users||[]; this.st.posts=db.posts||[]; this.st.msgs=db.msgs||[];
            }
            const uid = localStorage.getItem('uid');
            if(uid) {
                const u = this.st.users.find(x=>x.id===uid);
                if(u) { 
                    this.st.user=u; 
                    if(!this.st.user.blocked) this.st.user.blocked = [];
                    this.start(); this.sync(true); 
                }
                else { document.getElementById('scr-auth').classList.remove('hide'); }
            } else {
                document.getElementById('scr-auth').classList.remove('hide');
            }

            const p = new URLSearchParams(location.search);
            const showUser = p.get('u');
            const showPost = p.get('p');

            setTimeout(() => {
                if (showUser) { this.nav('pr', showUser); } 
                else if (showPost) { this.showPost(showPost); }
            }, 1500);

            setInterval(() => { 
                if(!document.getElementById('scr-app').classList.contains('hide')) {
                    const inChat = document.getElementById('sc-ch').classList.contains('show');
                    if (inChat || !app.st.syncing) {
                        app.sync(false);
                    }
                }
            }, 3000);
            
            window.onscroll = () => {
                if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
                    const isHome = !document.getElementById('s-hm').classList.contains('hide');
                    const isProfile = !document.getElementById('s-pr').classList.contains('hide');
                    
                    if (isHome || isProfile) {
                        if(this.st.limit < this.st.posts.length) {
                            this.st.limit += 20;
                            if(isHome) this.feed();
                            if(isProfile) this.flt(document.querySelector('.chip.active') ? (document.querySelector('.chip.active').innerText.includes('همه') ? 'all' : document.querySelector('.chip.active').getAttribute('data-cat')) : 'all', null);
                        } else if (isHome && !this.st.isLoadingOld) {
                            document.getElementById('hm-more').classList.remove('hide');
                        }
                    }
                }
            };
            
            window.addEventListener('popstate', (event) => {
                if (!event.state || !event.state.pid) { document.getElementById('sc-post').classList.remove('show'); } 
                else if (event.state.pid) { this.showPost(event.state.pid, false); }
            });
            
            document.addEventListener('click', function(event) {
                const menu = document.getElementById('p-mn');
                const btn = document.getElementById('p-mn-btn');
                if (!menu.classList.contains('hide') && !menu.contains(event.target) && event.target !== btn) {
                    menu.classList.add('hide');
                }
                document.querySelectorAll('.p-menu').forEach(m => {
                    if(!m.contains(event.target)) m.classList.remove('show');
                });
            });
        },

        call: async function(act, pl) {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    redirect: "follow",
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: act, payload: pl })
                });
                return await res.json();
            } catch(e) { console.error(e); return {status:'error'}; }
        },

        sync: async function(initial) {
            if(this.st.syncing) return;
            this.st.syncing = true;
            const d = await this.call('getAll', {});
            this.st.syncing = false;
            
            if(d.status === 'success') {
                this.st.users = d.users;
                d.posts.forEach(np => {
                    const idx = this.st.posts.findIndex(p=>p.pid===np.pid);
                    if(idx !== -1) { 
                        this.st.posts[idx] = np;
                    } else {
                        if (!this.st.posts.find(p=>p.pid===np.pid)) this.st.posts.unshift(np);
                    }
                });
                
                d.msgs.forEach(nm => {
                    const exists = this.st.msgs.find(m => m.from===nm.from && m.to===nm.to && m.time===nm.time);
                    if(!exists) {
                        this.st.msgs.push(nm);
                    } else {
                        if (exists.read !== nm.read) {
                           exists.read = nm.read;
                        }
                    }
                });

                if(document.getElementById('sc-ch').classList.contains('show')) {
                     this.rnC(); 
                }

                localStorage.setItem('db', JSON.stringify({users:this.st.users, posts:this.st.posts, msgs:this.st.msgs}));
                if(this.st.user && !this.st.guest) {
                    const freshMe = this.st.users.find(u=>u.id===this.st.user.id);
                    if(freshMe) {
                        this.st.user = freshMe;
                        if(!this.st.user.blocked) this.st.user.blocked = [];
                    }
                    this.bdg();
                    this.updateNotifBadge();
                }
                if(!document.getElementById('s-hm').classList.contains('hide')) this.feed(); 
                if(!document.getElementById('s-ms').classList.contains('hide')) this.msg();
            }
        },
        
        loadOldPosts: async function() {
            this.st.isLoadingOld = true;
            const btn = document.getElementById('hm-more');
            btn.innerHTML = '<span class="loading"></span>';
            const lastPost = this.st.posts[this.st.posts.length - 1];
            const lastTime = lastPost ? lastPost.time : Date.now();
            const d = await this.call('getMorePosts', { lastTime: lastTime });
            if (d.status === 'success' && d.posts.length > 0) {
                let count = 0;
                d.posts.forEach(op => {
                    if (!this.st.posts.find(p => p.pid === op.pid)) {
                        this.st.posts.push(op);
                        count++;
                    }
                });
                if (count > 0) {
                    this.st.limit += 20;
                    this.feed();
                    this.notif(count + ' پست قدیمی‌تر بارگیری شد', 'suc');
                } else {
                    this.notif('پست قدیمی‌تری وجود ندارد', 'err');
                    btn.classList.add('hide');
                }
            } else {
                this.notif('پست دیگری یافت نشد', 'err');
                btn.classList.add('hide');
            }
            btn.innerHTML = 'مشاهده پست‌های قدیمی‌تر';
            this.st.isLoadingOld = false;
        },

        togAuth: () => { document.getElementById('f-log').classList.toggle('hide'); document.getElementById('f-reg').classList.toggle('hide'); },
        
        togPwd: (id, el) => {
            const inp = document.getElementById(id);
            if (inp.type === 'password') {
                inp.type = 'text';
                el.innerHTML = '<i class="ph ph-eye-slash"></i>';
            } else {
                inp.type = 'password';
                el.innerHTML = '<i class="ph ph-eye"></i>';
            }
        },

        login: async function(btn) {
            const nc=document.getElementById('l-nc').value, pass=document.getElementById('l-ps').value;
            if(!nc || !pass) return this.notif('لطفا اطلاعات را کامل وارد کنید', 'err');
            btn.innerHTML = '<span class="loading"></span>';
            const d = await this.call('login', {nc, pass});
            if(d.status === 'success') {
                this.st.user = d.user;
                if(!this.st.user.blocked) this.st.user.blocked = [];
                if(document.getElementById('l-rem').checked) localStorage.setItem('uid', d.user.id);
                this.start(); this.sync(true);
            } else { this.notif(d.msg, 'err'); btn.innerHTML='ورود'; }
        },
        reg: async function(btn) {
            const p = {
                id:document.getElementById('r-us').value.toLowerCase(), 
                nc:document.getElementById('r-nc').value,
                pass:document.getElementById('r-ps').value, 
                name:document.getElementById('r-nm').value,
                refCode:document.getElementById('r-rf').value
            };
            if(!p.id || !p.nc || !p.pass) return this.notif('همه فیلدها الزامی است', 'err');
            if(p.nc.length !== 10) return this.notif('کد ملی باید ۱۰ رقم باشد', 'err');
            
            btn.innerHTML = '<span class="loading"></span>';
            const d = await this.call('register', p);
            if(d.status === 'success') { this.notif('ثبت نام موفقیت آمیز بود', 'suc'); this.togAuth(); }
            else { this.notif(d.msg, 'err'); btn.innerHTML='ثبت نام'; }
        },
        out: () => { 
            localStorage.clear(); 
            this.st = { user:null, users:[], posts:[], msgs:[], vid:null, shr:null, cpid:null, guest:false, page:1, limit:20, syncing:false, postToSend: null, pickerMode: null, searchLimit: 10, tempUsers: [], isLoadingOld: false, editingPost: null, selectedMsg: null };
            location.reload(); 
        },
        start: function() {
            document.getElementById('scr-auth').classList.add('hide');
            document.getElementById('scr-app').classList.remove('hide');
            this.nav('hm');
            // update profile pic in add post
            const me = this.st.user;
            if(me.pic) document.getElementById('add-post-av').innerHTML = `<img src="${me.pic}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
            if(me.pic) document.getElementById('cm-av').innerHTML = `<img src="${me.pic}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
        },

        nav: function(p, arg) {
            document.querySelectorAll('section').forEach(s=>s.classList.add('hide'));
            document.querySelectorAll('.n-it').forEach(i=>{
                i.classList.remove('active');
                i.querySelector('i').className = i.querySelector('i').className.replace('-fill', '');
            });
            document.getElementById('sc-ch').classList.remove('show');
            document.getElementById('sc-post').classList.remove('show');
            document.querySelector('#m-cm').classList.remove('show');

            if(p==='hm') { 
                document.getElementById('s-hm').classList.remove('hide'); 
                const n = document.getElementById('n-hm');
                n.classList.add('active');
                n.querySelector('i').className += '-fill';
                document.getElementById('hm-sr').value = ''; 
                if (this.st.posts.length === 0) { document.getElementById('feed').innerHTML = this.htmlSkelPost(3); }
                else { this.feed(); }
            }
            else if(p==='pr') { 
                document.getElementById('s-pr').classList.remove('hide'); 
                if(!arg || (this.st.user && arg===this.st.user.id)) {
                    const n = document.getElementById('n-pr');
                    n.classList.add('active');
                    n.querySelector('i').className += '-fill';
                }
                document.getElementById('p-pts').innerHTML = this.htmlSkelPost(2);
                this.prof(arg||this.st.user.id);
            }
            else if(p==='ad') { 
                document.getElementById('s-ad').classList.remove('hide'); 
                const n = document.getElementById('n-ad');
                n.classList.add('active');
                n.querySelector('i').className += '-fill';
                this.populateCategories(); 
                this.cancelEdit(false);
            }
            else if(p==='ms') { 
                document.getElementById('s-ms').classList.remove('hide'); 
                const n = document.getElementById('n-ms');
                n.classList.add('active');
                n.querySelector('i').className += '-fill';
                document.getElementById('msg-bx').innerHTML = this.htmlSkelUser(3);
                this.msg(); 
            }
            else if(p==='st') { 
                document.getElementById('s-st').classList.remove('hide'); 
                const n = document.getElementById('n-st');
                n.classList.add('active');
                n.querySelector('i').className += '-fill';
                this.sets(); 
            }
             else if(p==='sr') { document.getElementById('s-sr').classList.remove('hide'); }
        },

        feed: function() {
            const c = document.getElementById('feed'), nb = document.getElementById('new-bx');
            nb.innerHTML='';
            
            const blocked = this.st.user.blocked || [];
            this.st.users.filter(u=>u.id!==this.st.user.id && !blocked.includes(u.id)).slice(-6).forEach(u=>{
                const img = u.pic ? `<img src="${u.pic}" style="width:100%;height:100%;object-fit:cover;border-radius:50%; border:2px solid var(--p); padding:2px;">` : `<div style="width:100%;height:100%;background:#efefef;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold; border:2px solid var(--p); color:var(--tg);">${u.name[0]}</div>`;
                nb.innerHTML += `<div style="min-width:70px;text-align:center;cursor:pointer" onclick="app.nav('pr','${u.id}')">
                    <div style="width:60px;height:60px;margin:auto">${img}</div>
                    <div style="font-size:0.75rem;margin-top:5px;overflow:hidden;text-overflow:ellipsis;color:var(--t);">${u.name.split(' ')[0]}</div></div>`;
            });

            let visiblePosts = this.st.posts.filter(p=>{
                const au = this.st.users.find(u=>u.id===p.uid); if(!au) return false;
                if (blocked.includes(au.id)) return false; 
                if (au.blocked && au.blocked.includes(this.st.user.id)) return false; 
                return !au.isPrivate || this.st.user.following.includes(p.uid) || p.uid===this.st.user.id;
            });
            
            visiblePosts.sort((a,b)=>b.time-a.time);
            
            const renderList = visiblePosts.slice(0, this.st.limit);
            let html = '';
            renderList.forEach(p => html += this.htmlP(p, 'feed'));
            
            if(c.innerHTML !== html) c.innerHTML = html;
            
            if(visiblePosts.length > this.st.limit) document.getElementById('feed-ldr').style.display='block';
            else document.getElementById('feed-ldr').style.display='none';
        },
        
        showPost: function(pid, pushState = true) {
            if (this.st.posts.length === 0) { setTimeout(() => this.showPost(pid, pushState), 500); return; }
            const post = this.st.posts.find(p => p.pid === pid);
            if (!post) { this.notif('پست مورد نظر یافت نشد', 'err'); return; }
            
            const author = this.st.users.find(u => u.id === post.uid);
            if (author && (this.st.user.blocked.includes(author.id) || (author.blocked && author.blocked.includes(this.st.user.id)))) {
                 this.notif('پست قابل نمایش نیست', 'err'); return;
            }

            const canView = !author || author.id === this.st.user.id || !author.isPrivate || (author.isPrivate && this.st.user.following.includes(author.id));

            if (!canView) {
                this.nav('pr', author.id); this.notif('این پست خصوصی است', 'err'); return;
            }

            document.getElementById('sc-ch').classList.remove('show');
            document.getElementById('m-nt').classList.remove('show');
            document.getElementById('m-ls').classList.remove('show');
            document.getElementById('m-pk').classList.remove('show');

            const postScreen = document.getElementById('sc-post');
            const postContent = document.getElementById('sc-post-content');
            
            postContent.innerHTML = this.htmlP(post, 'view');
            postScreen.classList.add('show');
            
            if (pushState) {
                const url = new URL(window.location);
                url.searchParams.set('p', pid);
                window.history.pushState({pid: pid}, '', url);
            }
        },

        closePostView: function() {
            document.getElementById('sc-post').classList.remove('show');
            const url = new URL(window.location);
            url.searchParams.delete('p');
            window.history.pushState({}, '', url);
            this.nav('hm');
        },
        
        viewImg: function(src) {
            if(!src || src.includes('undefined')) return;
            document.getElementById('img-vw').src = src;
            document.getElementById('m-img').classList.add('show');
        },

        htmlU: (uid) => {
            const u = app.st.users.find(x=>x.id===uid); if(!u) return 'کاربر حذف شده';
            const i = u.pic ? `<img class="u-img" src="${u.pic}">` : `<div class="u-img" style="display:flex;align-items:center;justify-content:center;background:#efefef;color:var(--tg); font-size:1.2rem;"><i class="ph ph-user"></i></div>`;
            return `<div class="u-blk" onclick="event.stopPropagation();app.nav('pr','${u.id}')">${i}<div class="u-in"><div class="u-nm">${u.name}</div><div class="u-id">@${u.id}</div></div></div>`;
        },
        
        htmlP: (p, ctx) => {
            const lk = p.likes.includes(app.st.user.id) ? 'lk' : '';
            const heartIcon = lk ? '<i class="ph-fill ph-heart"></i>' : '<i class="ph ph-heart"></i>';

            let contentHtml = '';
            const maxLength = 500;
            if (p.text.length > maxLength) {
                const shortText = p.text.substring(0, maxLength) + '... ';
                contentHtml = `
                    <span id="txt-s-${p.pid}">${app.autoLinker(shortText)}<b style="cursor:pointer;color:var(--tg);display:inline-block;margin-right:5px;" onclick="app.readMore('${p.pid}')">بیشتر</b></span>
                    <span id="txt-f-${p.pid}" class="hide">${app.autoLinker(p.text)}</span>
                `;
            } else {
                contentHtml = app.autoLinker(p.text);
            }

            const postDate = new Date(p.time).toLocaleDateString('fa-IR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });

            let menuBtn = '';
            if(p.uid === app.st.user.id && ctx !== 'feed') {
                menuBtn = `
                <div class="post-opts-btn" onclick="event.stopPropagation(); document.getElementById('pm-${p.pid}').classList.toggle('show')"><i class="ph ph-dots-three"></i></div>
                <div id="pm-${p.pid}" class="p-menu">
                    <div class="p-menu-item" onclick="app.startEditPost('${p.pid}')"><i class="ph ph-pencil"></i> ویرایش</div>
                    <div class="p-menu-item del" onclick="app.doDeletePost('${p.pid}')"><i class="ph ph-trash"></i> حذف</div>
                </div>
                `;
            }

            return `<div class="card" id="p-${p.pid}" style="padding: 0;">
                ${menuBtn}
                <div class="flex-bw" style="padding: 12px; ${p.uid === app.st.user.id && ctx !== 'feed' ? 'margin-right:25px' : ''}">
                    ${app.htmlU(p.uid)} 
                    <div style="text-align:left">
                        <span style="font-size:0.7rem;background:#efefef;color:var(--t);padding:4px 10px;border-radius:6px; font-weight:600;">${p.cat||'عمومی'}</span>
                    </div>
                </div>
                
                <div style="padding: 0 16px 8px 16px;">
                    <h4 style="font-size:1.05rem; margin-bottom: 8px;">${p.title}</h4>
                    <p style="line-height:1.6;font-size:0.95rem;white-space:pre-wrap;color:var(--t);text-align:right;direction:rtl;display:block;unicode-bidi:embed;">${contentHtml}</p>
                    <div style="font-size:0.75rem; color:var(--tg); text-align:right; margin-top:10px;">${postDate}</div>
                </div>

                <div style="padding: 8px 16px 12px 16px;">
                    <div class="p-act">
                        <div class="p-act-left">
                            <div class="act-b ${lk}" id="lb-${p.pid}"><span onclick="app.like('${p.pid}')">${heartIcon}</span></div>
                            <div class="act-b" onclick="app.comm('${p.pid}')"><i class="ph ph-chat-circle"></i></div>
                            <div class="act-b" onclick="app.openSendPostModal('${p.pid}')"><i class="ph ph-paper-plane-tilt"></i></div>
                        </div>
                        <div class="act-b" onclick="app.share('post','${p.pid}')"><i class="ph ph-bookmark"></i></div>
                    </div>
                    <div style="margin-top: 8px; font-weight: 600; font-size: 0.9rem; cursor: pointer;" onclick="app.showLikes('${p.pid}', event)">${p.likes.length} پسند</div>
                    ${p.comments.length > 0 ? `<div style="margin-top: 4px; color: var(--tg); font-size: 0.9rem; cursor: pointer;" onclick="app.comm('${p.pid}')">مشاهده همه ${p.comments.length} نظر</div>` : ''}
                </div>
            </div>`;
        },

        readMore: function(pid) {
            document.getElementById('txt-s-' + pid).classList.add('hide');
            document.getElementById('txt-f-' + pid).classList.remove('hide');
        },
        readMoreMsg: function(id) {
            const el = document.getElementById('msg-txt-' + id);
            const fullText = el.getAttribute('data-full');
            el.innerHTML = app.autoLinker(fullText);
        },

        pub: async function(btn) {
            const title = document.getElementById('a-ti').value;
            const cat = document.getElementById('a-ct').value;
            const text = document.getElementById('a-tx').value;
            
            if(!text) return this.notif('متن پست الزامی است', 'err');
            
            if(this.st.editingPost) {
                const pid = this.st.editingPost;
                const p = this.st.posts.find(x => x.pid === pid);
                p.title = title; p.cat = cat; p.text = text;
                
                localStorage.setItem('db', JSON.stringify({users:this.st.users, posts:this.st.posts, msgs:this.st.msgs}));
                
                this.notif('در حال اعمال تغییرات...', 'wait');
                btn.innerHTML = '<span class="loading"></span>';
                await this.call('editPostContent', { pid: pid, uid: this.st.user.id, title, cat, text });
                
                this.notif('پست ویرایش شد', 'suc');
                this.cancelEdit();
                this.nav('hm');
                this.feed();
                return;
            }

            const p = { 
                pid: this.st.user.id + '_' + Date.now(), 
                uid: this.st.user.id, 
                title: title, 
                cat: cat, 
                text: text, 
                time: Date.now(),
                likes: [], comments: [] 
            };

            this.nav('hm');
            window.scrollTo(0,0);
            const upBox = document.getElementById('feed-up');
            upBox.innerHTML = `
                <div class="card sending" style="border:none; box-shadow: none;">
                    <div class="flex-bw">${this.htmlU(p.uid)}</div>
                    <div class="prog-c" style="display:block"><div class="fill" style="width:0%"></div></div>
                    <div class="up-msg" style="color:var(--p)">در حال آپلود...</div>
                </div>
            `;
            const fill = upBox.querySelector('.fill');
            setTimeout(()=>fill.style.width='30%', 100);
            setTimeout(()=>fill.style.width='70%', 800);
            try {
                this.notif('در حال ارسال...', 'wait');
                await this.call('createPost', { ...p, likes:[], comments:[] });
                fill.style.width='100%';
                upBox.querySelector('.up-msg').innerText = 'ارسال شد';
                upBox.querySelector('.up-msg').style.display = 'block';
                this.st.posts.unshift(p);
                localStorage.setItem('db', JSON.stringify({users:this.st.users, posts:this.st.posts, msgs:this.st.msgs}));
                
                document.getElementById('a-ti').value=''; document.getElementById('a-tx').value='';
                setTimeout(() => {
                    upBox.innerHTML = '';
                    this.feed();
                    this.notif('پست منتشر شد', 'suc');
                }, 1500);
            } catch(e) {
                upBox.innerHTML = '<div class="card" style="color:red">خطا در ارسال پست. لطفا اینترنت را بررسی کنید.</div>';
            }
        },
        
        startEditPost: function(pid) {
            const p = this.st.posts.find(x => x.pid === pid);
            if(!p) return;
            this.st.editingPost = pid;
            this.nav('ad');
            document.getElementById('a-ti').value = p.title;
            document.getElementById('a-ct').value = p.cat;
            document.getElementById('a-tx').value = p.text;
            document.getElementById('btn-pub').innerText = 'ذخیره';
            document.getElementById('a-header').innerText = 'ویرایش پست';
            document.getElementById('btn-cncl-edit').style.display = 'block';
        },
        
        cancelEdit: function(goBack=true) {
            this.st.editingPost = null;
            document.getElementById('a-ti').value = '';
            document.getElementById('a-ct').value = ''; 
            document.getElementById('a-tx').value = '';
            document.getElementById('btn-pub').innerText = 'اشتراک‌گذاری';
            document.getElementById('a-header').innerText = 'پست جدید';
            document.getElementById('btn-cncl-edit').style.display = 'none';
            if(goBack) this.nav('hm');
        },
        
        doDeletePost: async function(pid) {
             if(confirm('آیا از حذف این پست اطمینان دارید؟')) {
                 this.notif('در حال حذف پست...', 'wait');
                 this.st.posts = this.st.posts.filter(p => p.pid !== pid);
                 localStorage.setItem('db', JSON.stringify({users:this.st.users, posts:this.st.posts, msgs:this.st.msgs}));
                 
                 if(document.getElementById('p-'+pid)) document.getElementById('p-'+pid).remove();
                 if(document.getElementById('sc-post').classList.contains('show')) this.closePostView();

                 await this.call('deletePost', {pid: pid});
                 this.notif('پست حذف شد', 'suc');
             }
        },

        like: function(pid) {
            const p = this.st.posts.find(x=>x.pid===pid);
            const uid = this.st.user.id;
            const btn = document.getElementById('lb-'+pid);
            let liked = p.likes.includes(uid);
            if(liked) {
                p.likes = p.likes.filter(x=>x!==uid);
                btn.classList.remove('lk');
                btn.querySelector('span').innerHTML = '<i class="ph ph-heart"></i>';
            } else {
                p.likes.push(uid);
                btn.classList.add('lk');
                btn.querySelector('span').innerHTML = '<i class="ph-fill ph-heart"></i>';
            }
            // Simple refresh logic for likes count in the view
            const likesCountDiv = btn.parentElement.parentElement.nextElementSibling;
            if(likesCountDiv && likesCountDiv.innerText.includes('پسند')) {
                likesCountDiv.innerText = `${p.likes.length} پسند`;
            }
            this.call('updatePost', {pid, likes:p.likes, comments:p.comments});
        },
        showLikes: function(pid, e) {
            if(e) e.stopPropagation();
            const p = this.st.posts.find(x=>x.pid===pid);
            if(!p || !p.likes.length) return this.notif('هنوز کسی این پست را لایک نکرده است', 'err');
            
            const b = document.getElementById('ls-bd'); b.innerHTML = '';
            document.getElementById('ls-tt').innerText = 'لایک‌کنندگان';
            
            p.likes.forEach(uid => {
                b.innerHTML += `<div style="margin-bottom:10px">${app.htmlU(uid)}</div>`;
            });
            
            document.getElementById('m-ls').classList.add('show');
        },
        comm: function(pid) {
            this.st.cpid = pid;
            const p = this.st.posts.find(x=>x.pid===pid);
            const b = document.getElementById('cm-bd');
            b.innerHTML = p.comments.length ? '' : '<p style="text-align:center;color:gray;margin-top:20px; font-size: 0.9rem;">هنوز نظری ثبت نشده است.</p>';
            p.comments.forEach(c => {
                b.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee;">
                    ${this.htmlU(c.uid)}
                    <p style="font-size:0.9rem; margin-top:5px; padding-right:52px; color: var(--t);">${app.autoLinker(c.text)}</p>
                </div>`;
            });
            document.getElementById('m-cm').classList.add('show');
        },
        sndC: function(btn) {
            const txt = document.getElementById('cm-in').value.trim();
            if(!txt) return;
            const p = this.st.posts.find(x=>x.pid===this.st.cpid);
            const newCm = {uid:this.st.user.id, text:txt, time: Date.now()};
            p.comments.push(newCm);
            const b = document.getElementById('cm-bd');
            if(b.innerHTML.includes('هنوز نظری')) b.innerHTML='';
            const tempHTML = `<div style="padding:10px; border-bottom:1px solid #eee; opacity: 0.7;">
                    ${this.htmlU(this.st.user.id)}
                    <p style="font-size:0.9rem; margin-top:5px; padding-right:52px;">${this.autoLinker(txt)} <small>(ارسال...)</small></p>
                </div>`;
            b.insertAdjacentHTML('beforeend', tempHTML);
            b.scrollTop=b.scrollHeight;
            document.getElementById('cm-in').value='';
            this.call('updatePost', {pid:p.pid, likes:p.likes, comments:p.comments}).then(()=>{
                this.comm(this.st.cpid); 
            });
        },
        fol: function() {
            const uid = this.st.vid; const me = this.st.user; const u = this.st.users.find(x=>x.id===uid);
            const btn = document.getElementById('b-fl');
            let action = 'follow'; 
            if(me.following.includes(uid)) action = 'unfollow';
            if(action==='follow') {
                if(u.isPrivate) {
                    if (!u.requests.includes(me.id)) u.requests.push(me.id);
                    btn.innerText = 'در انتظار تایید'; btn.className = 'btn btn-o';
                } else {
                    if (!me.following.includes(uid)) me.following.push(uid);
                    if (!u.followers.includes(me.id)) u.followers.push(me.id);
                    btn.innerText = 'دنبال‌میکنید'; btn.className = 'btn btn-o';
                }
            } else {
                me.following = me.following.filter(x=>x!==uid); 
                u.followers = u.followers.filter(x=>x!==me.id); 
                u.requests = u.requests.filter(x=>x!==me.id);
                btn.innerText = 'دنبال کردن'; btn.className = 'btn btn-p';
            }
            document.getElementById('c-fl').innerText = u.followers.length;
            this.call('updateUser', [me, u]);
        },
        
        togProfMenu: function(e) {
            e.stopPropagation();
            const m = document.getElementById('p-mn');
            m.classList.toggle('hide');
            const uid = this.st.vid;
            const blocked = this.st.user.blocked.includes(uid);
            const blkBtn = document.getElementById('mn-blk');
            blkBtn.innerHTML = blocked ? '<i class="ph ph-check"></i> آزاد کردن' : '<i class="ph ph-prohibit"></i> مسدود کردن';
            blkBtn.style.color = blocked ? 'var(--suc-real)' : 'var(--err)';
        },
        
        block: function() {
            const uid = this.st.vid;
            const me = this.st.user;
            if(!me.blocked) me.blocked = [];
            
            if(me.blocked.includes(uid)) {
                me.blocked = me.blocked.filter(id => id !== uid);
                this.notif('کاربر آزاد شد', 'suc');
            } else {
                me.blocked.push(uid);
                me.following = me.following.filter(id => id !== uid);
                me.followers = me.followers.filter(id => id !== uid);
                this.notif('کاربر مسدود شد', 'err');
            }
            
            document.getElementById('p-mn').classList.add('hide');
            if(uid === this.st.vid) this.prof(uid); 
            this.call('updateUser', [me]);
        },
        
        unblockFromSettings: function(uid) {
            this.st.user.blocked = this.st.user.blocked.filter(id => id !== uid);
            this.call('updateUser', [this.st.user]);
            this.sets(); 
            this.notif('کاربر آزاد شد', 'suc');
        },

        msg: function() {
            const reqBox = document.getElementById('req-box');
            const msgBox = document.getElementById('msg-bx');
            reqBox.innerHTML = '';
            msgBox.innerHTML = '';
            
            if (this.st.user.requests && this.st.user.requests.length > 0) {
                reqBox.innerHTML += '<h4 style="margin:15px 5px 10px;color:var(--tg);font-size:0.9rem;">درخواست‌ها</h4>';
                this.st.user.requests.forEach(rid => {
                    const u = this.st.users.find(x => x.id === rid);
                    if (u && !this.st.user.blocked.includes(rid)) {
                        reqBox.innerHTML += `<div class="card flex-bw">${this.htmlU(rid)}<div><button class="btn-s btn-p" onclick="app.ans('${rid}',true)">تایید</button> <button class="btn-s btn-o" onclick="app.ans('${rid}',false)" style="margin-right:5px">حذف</button></div></div>`;
                    }
                });
            }
            
            const blocked = this.st.user.blocked || [];
            const chats = [...new Set(this.st.msgs.filter(x => (x.from === this.st.user.id || x.to === this.st.user.id)).map(x => x.from === this.st.user.id ? x.to : x.from))];
            
            const visibleChats = chats.filter(id => !blocked.includes(id));

            if (visibleChats.length === 0 && (!this.st.user.requests || this.st.user.requests.length === 0)) {
                msgBox.innerHTML = '<div style="text-align:center;padding:50px;color:var(--tg)"><div style="font-size:3rem"><i class="ph ph-chat-teardrop"></i></div><p>صندوق پیام خالی است</p></div>';
            }
            
            visibleChats.forEach(pid => {
                const u = this.st.users.find(x => x.id === pid);
                if (!u) return;

                const conv = this.st.msgs.filter(x => (x.from === this.st.user.id && x.to === pid) || (x.from === pid && x.to === this.st.user.id));
                if (conv.length === 0) return;
                const last = conv.sort((a,b) => b.time - a.time)[0];
                const unread = conv.filter(x => x.from === pid && x.to === this.st.user.id && !x.read).length;
                
                let tick = '';
                if (last.from === this.st.user.id) {
                     if(last.read) tick = '<span class="tik read"><i class="ph-fill ph-checks"></i></span>';
                     else if(last.id && last.id !== 'temp') tick = '<span class="tik sent"><i class="ph ph-check"></i></span>';
                     else tick = '<span class="tik wait"><i class="ph ph-clock"></i></span>';
                }

                let lastMsgText = '...';
                try {
                    const parsed = JSON.parse(last.text);
                    if (parsed.type === 'shared_post') {
                        lastMsgText = 'پست ارسال کرد';
                    } else {
                        lastMsgText = last.text;
                    }
                } catch(e) {
                    lastMsgText = last.text;
                }

                msgBox.innerHTML += `
                <div class="card" onclick="app.chat('${pid}')" style="cursor:pointer; padding: 12px; display:flex; align-items:center; gap:12px; border:none; box-shadow:none; margin-bottom: 5px; background: transparent;" data-chat-id="${u.id}">
                    <div style="flex-shrink:0;">${this.htmlU(u.id).replace('class="u-blk"', '').replace(/<div class="u-in">.*?<\/div>/, '')}</div>
                    <div style="flex:1; overflow:hidden;">
                         <div class="flex-bw">
                            <span style="font-weight:600; font-size:0.95rem;">${u.name}</span>
                            <small style="font-size:0.75rem;color:var(--tg);">${new Date(last.time).toLocaleTimeString('fa-IR', {hour:'2-digit',minute:'2-digit'})}</small>
                         </div>
                         <div class="flex-bw">
                             <p style="color:${unread ? 'var(--t)' : 'var(--tg)'}; font-size:0.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:${unread ? '600':'400'}">
                                ${tick} ${lastMsgText}
                             </p>
                             ${unread > 0 ? `<div style="background:var(--p); color:white; width:20px; height:20px; border-radius:50%; font-size:0.75rem; display:flex; align-items:center; justify-content:center;">${unread}</div>` : ''}
                         </div>
                    </div>
                </div>`;
            });
        },
        
        chat: function(uid) {
            const u = this.st.users.find(x=>x.id===uid);
            if (this.st.user.blocked.includes(uid)) return this.notif('شما این کاربر را مسدود کرده‌اید', 'err');
            if (u.blocked && u.blocked.includes(this.st.user.id)) return this.notif('امکان ارسال پیام وجود ندارد', 'err');

            const hasHistory = this.st.msgs.some(m => (m.from === uid && m.to === this.st.user.id) || (m.from === this.st.user.id && m.to === uid));
            if(!u.allowMsg && !hasHistory && !u.following.includes(this.st.user.id)) return this.notif('امکان ارسال پیام به این کاربر وجود ندارد', 'err');
            
            this.st.cpid = uid;
            document.getElementById('sc-ch').classList.add('show');
            document.getElementById('ch-hd').innerText = u.name;
            document.getElementById('ch-im').src = u.pic || '';
            
            this.rnC();
            
            const unread = this.st.msgs.filter(x=>x.from===uid && x.to===this.st.user.id && !x.read);
            if(unread.length > 0) {
                unread.forEach(m => m.read=true);
                this.bdg();
                this.call('readMsg', {target: uid, me: this.st.user.id});
            }
        },
        
        rnC: function() {
            const b=document.getElementById('ch-bx'); 
            const isAtBottom = (b.scrollHeight - b.scrollTop <= b.clientHeight + 50);
            let newHTML = '';
            
            const ms = this.st.msgs.filter(x=>(x.from==this.st.user.id&&x.to==this.st.cpid)||(x.from==this.st.cpid&&x.to==this.st.user.id));
            ms.sort((a,b)=>a.time-b.time); 

            ms.forEach((x, index)=>{ 
                const mine = x.from===this.st.user.id;
                let tick = '';
                if(mine) {
                     if(x.read) tick = '<span class="tik read"><i class="ph-fill ph-checks"></i></span>';
                     else if(x.id && x.id !== 'temp') tick = '<span class="tik sent"><i class="ph ph-check"></i></span>';
                     else tick = '<span class="tik wait"><i class="ph ph-clock"></i></span>';
                }

                let msgContent = '';
                try {
                    const parsed = JSON.parse(x.text);
                    if (parsed.type === 'shared_post' && parsed.pid) {
                        msgContent = this.htmlSharedPost(parsed.pid);
                    } else {
                        throw new Error("Not a shared post");
                    }
                } catch (e) {
                    if (x.text.length > 500) {
                         const short = x.text.substring(0, 500) + '...';
                         msgContent = `<span id="msg-txt-${index}" data-full="${x.text.replace(/"/g, '&quot;')}">
                            ${this.autoLinker(short)}
                            <br><span class="read-more-msg" onclick="app.readMoreMsg('${index}')">خواندن کامل</span>
                         </span>`;
                    } else {
                        msgContent = this.renderFile(x.text) || this.autoLinker(x.text);
                    }
                }
                
                const elId = `msg-${index}`;
                newHTML += `<div id="${elId}" class="msg-bub ${mine?'msg-me':'msg-ot'} ${(!mine||x.id)?'':'pending'}" 
                    ontouchstart="app.handleTouchStart(event, ${index})" 
                    ontouchend="app.handleTouchEnd(event)" 
                    oncontextmenu="app.handleRightClick(event, ${index})">
                    ${msgContent}
                    <div class="msg-tm">${tick} ${new Date(x.time).toLocaleTimeString('fa-IR', {hour:'2-digit',minute:'2-digit'})}</div>
                </div>`; 
            });

            if(b.innerHTML.length !== newHTML.length || ms.length === 0) {
                b.innerHTML = newHTML;
                if(isAtBottom || ms.some(m => m.id === 'temp')) b.scrollTop=b.scrollHeight;
            } else if (isAtBottom) {
                 if(b.innerHTML !== newHTML) {
                     b.innerHTML = newHTML;
                     b.scrollTop=b.scrollHeight;
                 }
            }
        },
        
        handleTouchStart: function(e, idx) {
            this.longPressTimer = setTimeout(() => {
                this.showMsgOptions(idx);
            }, 600); 
        },
        
        handleTouchEnd: function(e) {
            clearTimeout(this.longPressTimer);
        },
        
        handleRightClick: function(e, idx) {
            e.preventDefault();
            this.showMsgOptions(idx);
        },
        
        showMsgOptions: function(idx) {
            const ms = this.st.msgs.filter(x=>(x.from==this.st.user.id&&x.to==this.st.cpid)||(x.from==this.st.cpid&&x.to==this.st.user.id));
            ms.sort((a,b)=>a.time-b.time);
            const msg = ms[idx];
            if(msg) {
                this.st.selectedMsg = msg;
                document.getElementById('m-mo').classList.add('show');
            }
        },
        
        doCopyMsg: function() {
            if(!this.st.selectedMsg) return;
            const text = this.st.selectedMsg.text;
            if(navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => this.notif('کپی شد', 'suc'));
            } else {
                this.notif('کپی خودکار پشتیبانی نمی‌شود', 'err');
            }
            document.getElementById('m-mo').classList.remove('show');
        },
        
        doDeleteMsg: async function() {
            if(!this.st.selectedMsg) return;
            if(confirm('آیا از حذف این پیام اطمینان دارید؟')) {
                const m = this.st.selectedMsg;
                this.st.msgs = this.st.msgs.filter(msg => msg !== m);
                localStorage.setItem('db', JSON.stringify({users:this.st.users, posts:this.st.posts, msgs:this.st.msgs}));
                this.rnC();
                document.getElementById('m-mo').classList.remove('show');
                
                this.notif('در حال حذف...', 'wait');
                await this.call('deleteMsg', {from: m.from, to: m.to, text: m.text, time: m.time});
                this.notif('پیام حذف شد', 'suc');
            }
        },

        renderFile: function(text) {
            const urlRegex = /^(https?:\/\/[^\s]+)$/i;
            if (!urlRegex.test(text)) return null;

            const url = text.trim();
            const ext = url.split('.').pop().toLowerCase().split('?')[0];
            
            if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(ext)) {
                return `<div class="file-img-container">
                    <img src="${url}" class="file-img" onload="this.style.background='transparent'" onclick="app.viewImg('${url}')">
                </div>`;
            }
            
            if (['mp3', 'wav', 'ogg', 'm4a'].includes(ext)) {
                return `<div class="file-prev">
                    <div class="file-icon"><i class="ph ph-music-note"></i></div>
                    <div style="flex:1">
                         <div class="file-name">فایل صوتی</div>
                         <audio controls src="${url}" style="width:100%; height:30px; margin-top:5px;"></audio>
                    </div>
                </div>`;
            }

            if (['mp4', 'webm', 'mov'].includes(ext)) {
                return `<div class="file-prev" style="display:block">
                     <video src="${url}" controls style="width:100%; border-radius:10px; max-height:200px;"></video>
                </div>`;
            }

            const docs = {
                'pdf': 'ph-file-pdf', 'doc': 'ph-file-doc', 'docx': 'ph-file-doc', 'xls': 'ph-file-xls', 'xlsx': 'ph-file-xls', 'ppt': 'ph-presentation', 'pptx': 'ph-presentation', 'txt': 'ph-file-text', 'zip': 'ph-file-zip', 'rar': 'ph-file-zip'
            };
            
            if (docs[ext]) {
                 return `<a href="${url}" target="_blank" style="text-decoration:none; color:inherit">
                    <div class="file-prev">
                        <div class="file-icon"><i class="ph ${docs[ext]}"></i></div>
                        <div>
                            <div class="file-name">${url.split('/').pop()}</div>
                            <div style="font-size:0.7rem; color:var(--p)">دانلود فایل</div>
                        </div>
                    </div>
                 </a>`;
            }

            return null; 
        },

        sndM: async function() {
            const t = document.getElementById('ch-in').value.trim(); if(!t) return;
            
            const m = {from:this.st.user.id, to:this.st.cpid, text:t, time:Date.now(), read:false, id:'temp'}; 
            this.st.msgs.push(m);
            
            this.rnC();
            document.getElementById('ch-in').value='';

            try {
                const payload = {...m}; delete payload.id;
                await this.call('createMsg', payload);
                m.id = 'sent';
                this.rnC(); 
                localStorage.setItem('db', JSON.stringify({users:this.st.users, posts:this.st.posts, msgs:this.st.msgs}));
            } catch(e) {
                this.notif('خطا در ارسال پیام', 'err');
            }
        },

        notif: (t, s) => { 
            const b=document.getElementById('tst'); 
            let icon = s==='err' ? '<i class="ph ph-warning-circle"></i>' : (s==='wait' ? '<i class="ph ph-hourglass"></i>' : '<i class="ph ph-check-circle"></i>');
            b.innerHTML = icon + ' ' + t; 
            b.style.background = s==='err'?'#ed4956': s==='wait'?'#363636':'#262626';
            b.classList.add('show'); 
            setTimeout(()=>b.classList.remove('show'), 3000); 
        },
        
        autoLinker: function(t) {
            if(!t) return '';
            let text = t;
            const postLinkRegex = new RegExp(location.origin + location.pathname + '\\?p=([a-zA-Z0-9_]+)', 'g');
            text = text.replace(postLinkRegex, (match, pid) => {
                 return `<span class="url-link" onclick="event.preventDefault(); event.stopPropagation(); app.showPost('${pid}')">مشاهده پست</span>`;
            });

            const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\b[A-Z0-9.-]+\.[A-Z]{2,4}\b)/ig;
            text = text.replace(urlRegex, function(url) {
                if(url.includes('?p=')) return url; 
                let href = url;
                if (!href.match(/^[a-zA-Z]+:\/\//)) { href = 'https://' + href; }
                return `<a href="${href}" class="url-link" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()">${url}</a>`;
            });
            
            const mentionRegex = /@(\w+)/g;
            text = text.replace(mentionRegex, (match, username) => {
                const u = this.st.users.find(x => x.id === username.toLowerCase());
                if (u) { return `<span class="ment" onclick="event.stopPropagation();app.nav('pr','${u.id}')">${match}</span>`; }
                return match;
            });
            return text;
        },
        
        bdg: () => {
            const r= (this.st.user.requests && this.st.user.requests.length) || 0;
            const u=this.st.msgs.filter(x=>x.to===this.st.user.id && !x.read).length;
            const b1=document.getElementById('b-nv');
            if(r+u>0) { b1.innerText=r+u; b1.classList.remove('hide'); } else b1.classList.add('hide');
        },

        prof: function(uid) {
            const u = this.st.users.find(x=>x.id===uid);
            if (!u) { return this.notif('کاربر یافت نشد', 'err'); }
            
            const me = this.st.user; 
            this.st.vid = uid; 
            const isMe = uid === me.id;
            const isBlocked = me.blocked.includes(uid);
            
            document.getElementById('bp-bk').classList.toggle('hide', isMe);
            
            // Handle Profile Pic Fallback
            const picCon = document.getElementById('p-pic-con');
            if (u.pic) {
                picCon.innerHTML = `<img id="p-im" class="p-pic" src="${u.pic}" onclick="app.viewImg(this.src)" title="مشاهده تصویر">`;
            } else {
                picCon.innerHTML = `<div class="p-pic-fallback">${u.name[0]}</div>`;
            }

            document.getElementById('p-nm').innerText = u.name; document.getElementById('p-id').innerText = u.id;
            document.getElementById('p-bi').innerHTML = this.autoLinker(u.bio);
            
            const lnk = document.getElementById('p-lnk'); lnk.innerHTML='';
            if(u.web) lnk.innerHTML = `<div><i class="ph ph-link"></i> ${this.autoLinker(u.web)}</div>`;
            
            const ps = this.st.posts.filter(x=>x.uid===uid);
            document.getElementById('c-pt').innerText=ps.length; 
            const fol = Array.isArray(u.followers) ? u.followers : JSON.parse(u.followers||'[]');
            const fing = Array.isArray(u.following) ? u.following : JSON.parse(u.following||'[]');
            document.getElementById('c-fl').innerText=fol.length; 
            document.getElementById('c-fi').innerText=fing.length;
            
            const acts = document.getElementById('p-act');
            if(isMe) {
                acts.classList.add('hide');
                document.getElementById('p-mn-btn').classList.add('hide');
            } else {
                acts.classList.remove('hide');
                document.getElementById('p-mn-btn').classList.remove('hide');
                const b = document.getElementById('b-fl');
                const bMsg = document.getElementById('b-msg');
                
                if(isBlocked) {
                    b.innerText = 'مسدود شده';
                    b.className = 'btn btn-o';
                    b.disabled = true;
                    bMsg.classList.add('hide');
                } else {
                    b.disabled = false;
                    bMsg.classList.remove('hide');
                    if(me.following.includes(uid)) { b.innerText='دنبال‌میکنید'; b.className='btn btn-o'; }
                    else if(u.requests && u.requests.includes(me.id)) { b.innerText='درخواست شده'; b.className='btn btn-o'; }
                    else { b.innerText='دنبال کردن'; b.className='btn btn-p'; }
                    
                    if (!u.allowMsg) {
                         const hasHistory = this.st.msgs.some(m => (m.from === uid && m.to === me.id) || (m.from === me.id && m.to === uid));
                         if (!hasHistory) bMsg.classList.add('hide');
                         else bMsg.classList.remove('hide');
                    }
                }
            }
            const acc = isMe || (!isBlocked && (!u.isPrivate || (u.isPrivate && u.followers.includes(me.id))));
            document.getElementById('p-con').classList.toggle('hide', !acc);
            document.getElementById('p-lck').classList.toggle('hide', acc);
            if(acc) this.flt('all', document.querySelector('#s-pr .chips .chip'));
        },
        flt: function(cat, el) {
            if(el) { document.querySelectorAll('#s-pr .chips .chip').forEach(c=>c.classList.remove('active')); el.classList.add('active'); }
            const c = document.getElementById('p-pts'); c.innerHTML='';
            let p = this.st.posts.filter(x=>x.uid===this.st.vid);
            if(cat!=='all') p = p.filter(x=>x.cat===cat);
            if(p.length===0) c.innerHTML='<div style="text-align:center;padding:40px;color:var(--tg);"><i class="ph ph-camera" style="font-size:3rem;"></i><p style="margin-top:10px;">هیچ پستی موجود نیست</p></div>';
            
            p.sort((a,b)=>b.time-a.time);
            const renderList = p.slice(0, this.st.limit);
            
            renderList.forEach(x=>c.innerHTML+=this.htmlP(x, 'profile'));
        },
        ans: function(uid, ac) {
            const me = this.st.user; me.requests = me.requests.filter(x=>x!==uid);
            const u = this.st.users.find(x=>x.id===uid);
            if(ac) { 
                if (!me.followers.includes(uid)) me.followers.push(uid);
                if (!u.following.includes(me.id)) u.following.push(me.id);
            }
            this.msg(); this.call('updateUser', [me, u]);
        },
        sets: function() {
            const u=this.st.user;
            document.getElementById('st-nm').innerText=u.name; document.getElementById('st-id').innerText=u.id;
            document.getElementById('st-nc').innerText=u.nc; document.getElementById('st-cd').innerText=u.refCode;
            document.getElementById('st-pc').value=u.pic||''; document.getElementById('st-nn').value=u.name;
            document.getElementById('st-bi').value=u.bio||''; document.getElementById('st-ln').value=u.web||'';
            document.getElementById('st-pr').checked=u.isPrivate;
            document.getElementById('st-al').checked=u.allowMsg;
            
            // Set Avatar in Settings
            const avImg = document.getElementById('st-av-img');
            const avPh = document.getElementById('st-av-ph');
            if(u.pic) {
                avImg.src = u.pic;
                avImg.style.display = 'block';
                avPh.style.display = 'none';
            } else {
                avImg.style.display = 'none';
                avPh.style.display = 'flex';
            }

            this.renderCustomCats();
            
            const blkList = document.getElementById('st-blk-list');
            blkList.innerHTML = '';
            if(!u.blocked || u.blocked.length === 0) {
                blkList.innerHTML = '<p style="color:var(--tg); font-size:0.8rem; text-align:center;">لیست خالی است</p>';
            } else {
                u.blocked.forEach(bid => {
                     blkList.innerHTML += `<div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #efefef;">
                        ${this.htmlU(bid).replace('class="u-blk"', 'style="display:flex; gap:10px; align-items:center;"')}
                        <button class="btn-s btn-o" style="color:var(--p); border:1px solid var(--p);" onclick="app.unblockFromSettings('${bid}')">آزاد</button>
                     </div>`;
                });
            }
        },
        sav: async function(btn) {
            const u=this.st.user;
            u.pic=document.getElementById('st-pc').value; u.name=document.getElementById('st-nn').value;
            u.bio=document.getElementById('st-bi').value; u.web=document.getElementById('st-ln').value;
            u.isPrivate=document.getElementById('st-pr').checked;
            u.allowMsg=document.getElementById('st-al').checked;
            btn.innerHTML = '<span class="loading"></span>'; 
            await this.call('updateUser', [u]); 
            this.notif('تنظیمات ذخیره شد', 'suc'); 
            btn.innerHTML='ذخیره تغییرات';
            this.sets(); // refresh view
        },
        share: function(t, id) {
            if (t !== 'post') {
                const url = location.origin + location.pathname + '?u=' + (id || this.st.vid);
                if (navigator.share) {
                    navigator.share({ title: 'پروفایل کاربر', text: 'این پروفایل را ببینید', url: url });
                } else {
                    this.st.shr = { txt: 'لینک پروفایل:', lnk: url };
                    document.getElementById('m-sh').classList.add('show');
                }
                return;
            }
            const post = this.st.posts.find(p => p.pid === id);
            const author = this.st.users.find(u => u.id === post.uid);
            if (!post || !author) return;
            const url = location.origin + location.pathname + '?p=' + id;
            const textToShare = `${post.title}\n\n${post.text}\n\nنویسنده: ${author.name} (@${author.id})\n\nلینک:\n${url}`;
            if (navigator.share) {
                navigator.share({
                    title: `پست از ${author.name}: ${post.title}`,
                    text: textToShare,
                }).catch(err => console.log('Share failed:', err));
            } else {
                this.copyPostLink(id);
                this.notif('مرورگر پشتیبانی نمی‌کند. لینک کپی شد.', 'err');
            }
        },
        copyLink: function() {
            if (navigator.clipboard && this.st.shr.lnk) {
                navigator.clipboard.writeText(this.st.shr.lnk).then(() => {
                    this.notif('لینک کپی شد!', 'suc');
                }, (err) => {
                    this.notif('خطا در کپی', 'err');
                });
            } else {
                prompt('لینک را کپی کنید:', this.st.shr.lnk);
            }
            document.getElementById('m-sh').classList.remove('show');
        },
        doSh: () => { 
            if(navigator.share && app.st.shr.lnk) {
                navigator.share({title:'اشتراک‌گذاری', url:app.st.shr.lnk});
            } else {
                app.notif('عدم پشتیبانی مرورگر', 'err');
            }
            document.getElementById('m-sh').classList.remove('show');
        },
        flP: (v) => {
            const l=document.getElementById('pk-ls');
            const searchTerm = v.toLowerCase().replace('@', '');
            l.innerHTML = app.htmlSkelUser(3);
            setTimeout(() => {
                l.innerHTML='';
                let usersToList = [];
                const recentChatIds = [...new Set(app.st.msgs.filter(x => x.from === app.st.user.id || x.to === app.st.user.id).map(x => x.from === app.st.user.id ? x.to : x.from))];
                let sourceUsers = app.st.users.filter(u => recentChatIds.includes(u.id));
                if (searchTerm === '') { usersToList = sourceUsers; } 
                else { usersToList = sourceUsers.filter(u=> u.id.toLowerCase().includes(searchTerm) || u.name.toLowerCase().includes(searchTerm)); }
                
                if (usersToList.length === 0) {
                    l.innerHTML = '<p style="text-align:center;color:var(--tg);padding:15px;">کاربری یافت نشد.</p>';
                } else {
                    usersToList.forEach(u=>{ 
                        const action = app.st.pickerMode === 'post' ? `app.doSendPost('${u.id}')` : `app.snSh('${u.id}')`;
                        l.innerHTML+=`<div class="card flex-bw">${app.htmlU(u.id)} <button class="btn-s btn-p" onclick="${action}">ارسال</button></div>`;
                    });
                }
            }, 300);
        },
        snSh: (uid) => {
            const m={from:this.st.user.id, to:uid, text:this.st.shr.lnk, time:Date.now(), read:false};
            this.st.msgs.push(m); this.call('createMsg', m); document.getElementById('m-pk').classList.remove('show'); this.notif('ارسال شد', 'suc');
        },
        checkSearch: function(el) {
            let raw = el.value;
            const v = raw.replace(/[@\s]/g, '').toLowerCase();
            if (v.length >= 5) {
                this.nav('sr');
                document.getElementById('sr-inp').value = raw;
                this.doSearch(); 
            }
        },
        doSearch: async function() {
            const el = document.getElementById('sr-inp');
            const v = el.value.replace(/[@\s]/g, '').toLowerCase();
            if (!v) return;
            
            const b = document.getElementById('sr-res');
            b.innerHTML = this.htmlSkelUser(3);
            document.getElementById('sr-more').classList.add('hide');
            
            el.disabled = true;
            const d = await this.call('searchUser', { id: v });
            el.disabled = false;
            
            b.innerHTML = '';
            if (d.status === 'success' && d.users.length > 0) {
                this.st.tempUsers = d.users.filter(u => !this.st.user.blocked.includes(u.id));
                this.st.searchLimit = 10;
                this.renderSearch();
            } else {
                b.innerHTML = '<p style="text-align:center; padding:20px; color:var(--tg);">کاربری یافت نشد.</p>';
            }
        },
        renderSearch: function() {
            const b = document.getElementById('sr-res');
            const list = this.st.tempUsers.slice(0, this.st.searchLimit);
            b.innerHTML = '';
            list.forEach(u => {
                b.innerHTML += `<div class="card">${this.htmlU(u.id)}</div>`;
            });
            if (this.st.tempUsers.length > this.st.searchLimit) { document.getElementById('sr-more').classList.remove('hide'); } 
            else { document.getElementById('sr-more').classList.add('hide'); }
        },
        loadMoreSearch: function() {
            this.st.searchLimit += 10;
            this.renderSearch();
        },
        list: (t) => {
            const u = app.st.users.find(x => x.id === app.st.vid);
            if (!u) return;
            if(t==='posts') return;
            
            let l = (t === 'fol' ? u.followers : u.following);
            if (typeof l === 'string') { try { l = JSON.parse(l); } catch(e) { l = []; } }
            if (!Array.isArray(l)) l = [];
            
            const b = document.getElementById('ls-bd'); 
            b.innerHTML = '';
            
            if(l.length === 0) {
                b.innerHTML = '<p style="text-align:center; padding:20px; color:var(--tg)">خالی</p>';
            } else {
                l.forEach(id => {
                    b.innerHTML += `<div style="margin-bottom:10px">${app.htmlU(id)}</div>`;
                });
            }
            
            document.getElementById('ls-tt').innerText = t==='fol'?'دنبال‌کنندگان':'دنبال‌شوندگان';
            document.getElementById('m-ls').classList.add('show');
        },
        showNotifs: function() {
            localStorage.setItem('lastSeenNotif', Date.now());
            this.updateNotifBadge();

            const b = document.getElementById('nt-bd');
            b.innerHTML = this.htmlSkelUser(4);
            
            const notifications = this.getNotifications();

            b.innerHTML = '';
            if (notifications.length === 0) {
                b.innerHTML = '<div style="text-align:center;padding:50px;color:var(--tg);"><i class="ph ph-bell-slash" style="font-size:3rem;"></i><p>هیچ اعلان جدیدی وجود ندارد.</p></div>';
            } else {
                notifications.slice(0, 10).forEach(n => {
                    const u = this.st.users.find(usr => usr.id === n.uid);
                    if (!u) return;
                    let text = '';
                    let action = `onclick="app.nav('pr', '${u.id}')"`;
                    let icon = '';
                    switch (n.type) {
                        case 'like': text = `پست شما را پسندید: <i>"${n.post.title}"</i>`; action=`onclick="app.showPost('${n.post.pid}')"`; icon='<i class="ph-fill ph-heart" style="color:var(--err)"></i>'; break;
                        case 'comment': text = `نظر داد: <span style="display:block;margin-top:5px;padding:8px;background:#f1f5f9;border-radius:8px;font-size:0.85rem;border:1px solid #e2e8f0;">"${n.text}"</span>`; action=`onclick="app.showPost('${n.post.pid}')"`; icon='<i class="ph-fill ph-chat-circle-dots" style="color:var(--p)"></i>'; break;
                        case 'follow': text = `شما را دنبال کرد.`; icon='<i class="ph-fill ph-user-plus" style="color:var(--p)"></i>'; break;
                        case 'request': text = `درخواست دنبال کردن داد.`; icon='<i class="ph-fill ph-user-circle-plus" style="color:var(--tg)"></i>'; break;
                    }
                    b.innerHTML += `<div class="card" style="padding:12px; font-size:0.9rem; display:flex; gap:12px; cursor:pointer; border:none; border-bottom:1px solid var(--bor); box-shadow:none; border-radius:0; margin:0;" ${action}>
                        <div style="position:relative;">
                            ${this.htmlU(u.id).replace('class="u-blk"', '').replace(/<div class="u-in">.*?<\/div>/, '')}
                            <div style="position:absolute; bottom:-2px; right:-2px; background:white; border-radius:50%; width:20px; height:20px; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 4px rgba(0,0,0,0.1); font-size:12px;">${icon}</div>
                        </div>
                        <div style="flex:1;">
                            <span style="font-weight:bold;">${u.name}</span>
                            <div style="margin-top:4px; color:var(--t); font-size: 0.85rem;">${text}</div>
                        </div>
                    </div>`;
                });
            }
            document.getElementById('m-nt').classList.add('show');
        },
        copyPostLink: function(pid) {
            const url = location.origin + location.pathname + '?p=' + pid;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(url).then(() => { this.notif('لینک کپی شد', 'suc'); });
            } else {
                this.notif('پشتیبانی نمی‌شود', 'err');
                prompt('لینک پست:', url);
            }
        },
        openSendPostModal: function(pid) {
            this.st.postToSend = pid;
            this.st.pickerMode = 'post';
            document.querySelector('#m-pk #pk-tt').innerText = 'ارسال پست به...';
            document.getElementById('m-pk').classList.add('show');
            const searchInput = document.querySelector('#m-pk .inp');
            searchInput.value = '';
            this.flP('');
        },
        doSendPost: function(recipientId) {
            if (!this.st.postToSend) return;
            const msgContent = JSON.stringify({ type: 'shared_post', pid: this.st.postToSend });
            const m = { from: this.st.user.id, to: recipientId, text: msgContent, time: Date.now(), read: false };
            this.st.msgs.push(m);
            this.call('createMsg', m);
            document.getElementById('m-pk').classList.remove('show');
            this.notif('ارسال شد', 'suc');
            this.st.postToSend = null;
            this.st.pickerMode = null;
        },
        filterChats: function(val) {
            const searchTerm = val.toLowerCase().replace('@','');
            const chatItems = document.querySelectorAll('#msg-bx .card');
            chatItems.forEach(item => {
                const chatId = item.dataset.chatId.toLowerCase();
                const user = app.st.users.find(u => u.id === item.dataset.chatId);
                const userName = user ? user.name.toLowerCase() : '';
                if (chatId.includes(searchTerm) || userName.includes(searchTerm)) { item.style.display = 'flex'; } 
                else { item.style.display = 'none'; }
            });
        },
        htmlSkelPost: function(count = 1) {
            let html = '';
            for (let i=0; i < count; i++) {
                html += `<div class="card skel-card">
                    <div class="flex-bw">
                        <div class="u-blk">
                            <div class="sk-av skel"></div>
                            <div>
                                <div class="sk-ln-md skel"></div>
                                <div class="sk-ln-sm skel" style="margin-top:8px"></div>
                            </div>
                        </div>
                    </div>
                    <div class="sk-ln-lg skel"></div>
                    <div class="sk-ln-md skel" style="width:100%; margin-top:12px;"></div>
                    <div class="sk-ln-md skel" style="width:70%; margin-top:8px;"></div>
                </div>`;
            }
            return html;
        },
        htmlSkelUser: function(count = 1) {
            let html = '';
            for (let i=0; i < count; i++) {
                html += `<div class="card">
                    <div class="u-blk">
                        <div class="sk-av skel"></div>
                        <div>
                            <div class="sk-ln-md skel"></div>
                            <div class="sk-ln-sm skel" style="margin-top:8px"></div>
                        </div>
                    </div>
                </div>`;
            }
            return html;
        },
        showInitialSkeletons: function() {
            if (!document.getElementById('scr-app').classList.contains('hide')) {
                document.getElementById('feed').innerHTML = this.htmlSkelPost(3);
            }
        },
        htmlSharedPost: function(pid) {
            const post = this.st.posts.find(p => p.pid === pid);
            if (!post) { return '<div class="msg-post-share" style="opacity:0.7;">پست حذف شده است</div>'; }
            const author = this.st.users.find(u => u.id === post.uid);
            return `
                <div class="msg-post-share" onclick="app.showPost('${pid}')">
                    <div style="display:flex; align-items:center; gap:6px; margin-bottom:5px;">
                        <img src="${author.pic||''}" style="width:20px; height:20px; border-radius:50%; background:#ccc;">
                        <span style="font-weight:bold; font-size:0.8rem;">${author.name}</span>
                    </div>
                    <div class="msg-post-share-title">${post.title}</div>
                    <div class="msg-post-share-text">${post.text}</div>
                </div>
            `;
        },
        getNotifications: function() {
            if (!this.st.user) return [];
            let notifications = [];
            const myPosts = this.st.posts.filter(p => p.uid === this.st.user.id);

            myPosts.forEach(p => {
                (p.likes || []).forEach(like => {
                    const likerId = typeof like === 'object' ? like.uid : like;
                    if (likerId !== this.st.user.id && !this.st.user.blocked.includes(likerId)) {
                         notifications.push({ time: like.time || p.time, type: 'like', uid: likerId, post: p });
                    }
                });
                (p.comments || []).forEach(c => {
                    if (c.uid !== this.st.user.id && !this.st.user.blocked.includes(c.uid)) {
                        notifications.push({ time: c.time || p.time, type: 'comment', uid: c.uid, post: p, text: c.text });
                    }
                });
            });

            const followers = this.st.users.find(u => u.id === this.st.user.id)?.followers || [];
            followers.forEach(uid => {
                 if(!this.st.user.blocked.includes(uid)) notifications.push({ time: Date.now(), type: 'follow', uid: uid });
            });
            
            (this.st.user.requests || []).forEach(uid => {
                if(!this.st.user.blocked.includes(uid)) notifications.push({ time: Date.now(), type: 'request', uid: uid });
            });

            notifications.sort((a, b) => b.time - a.time);
            return notifications;
        },
        updateNotifBadge: function() {
            const lastSeen = parseInt(localStorage.getItem('lastSeenNotif') || '0');
            const notifs = this.getNotifications();
            const newCount = notifs.filter(n => n.time > lastSeen).length;
            const badge = document.getElementById('notif-badge');
            if (newCount > 0) { badge.innerText = newCount; badge.classList.remove('hide'); } 
            else { badge.classList.add('hide'); }
        },
        populateCategories: function() {
            const select = document.getElementById('a-ct');
            select.innerHTML = ''; 
            const defaults = ['📝 عمومی', '📚 کتاب', '🎬 فیلم', '🌐 سایت', '💡 ایده'];
            defaults.forEach(cat => {
                const val = cat.split(' ')[1];
                select.innerHTML += `<option value="${val}">${cat}</option>`;
            });
            if (this.st.user && this.st.user.customCats) {
                this.st.user.customCats.forEach(cat => { select.innerHTML += `<option value="${cat}">${cat}</option>`; });
            }
        },
        renderCustomCats: function() {
            const list = document.getElementById('st-cats-list');
            const countEl = document.getElementById('cat-count');
            const cats = this.st.user.customCats || [];
            list.innerHTML = '';
            countEl.innerText = cats.length;
            cats.forEach(cat => {
                list.innerHTML += `<div class="cat-item flex-bw">${cat} <span style="margin-right:10px; color:var(--err); cursor:pointer;" onclick="app.deleteCat('${cat}')"><i class="ph ph-x"></i></span></div>`;
            });
        },
        addCat: function() {
            const input = document.getElementById('st-new-cat');
            const newCat = input.value.trim();
            if (!this.st.user.customCats) { this.st.user.customCats = []; }
            if (!newCat) return this.notif('نام دسته‌بندی خالی است', 'err');
            if (this.st.user.customCats.length >= 20) return this.notif('محدودیت تعداد دسته‌بندی', 'err');
            if (this.st.user.customCats.includes(newCat)) return this.notif('تکراری است', 'err');
            this.st.user.customCats.push(newCat);
            input.value = '';
            this.renderCustomCats();
            
            this.notif('در حال افزودن...', 'wait');
            this.call('updateUser', [this.st.user]).then(()=>{ this.notif('دسته‌بندی افزوده شد', 'suc'); });
        },
        deleteCat: function(catToDelete) {
            this.st.user.customCats = this.st.user.customCats.filter(cat => cat !== catToDelete);
            this.renderCustomCats();
            
            this.notif('در حال حذف...', 'wait');
            this.call('updateUser', [this.st.user]).then(()=>{ this.notif('دسته‌بندی حذف شد', 'suc'); });
        }
    };
    app.init();
</script>

</body>
</html>
