<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³ÙˆØ´ÛŒØ§Ù„ Ù¾Ù„Ø§Ø³</title>
    <style>
        :root {
            --p: #2563eb; --bg: #f8fafc; --s: #ffffff;
            --t: #0f172a; --tg: #64748b; --bor: #e2e8f0; --err: #ef4444;
            --sh: 0 2px 4px rgba(0,0,0,0.05);
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; -webkit-tap-highlight-color:transparent; outline:none; }
        body { background:var(--bg); color:var(--t); padding-bottom:70px; overflow-x:hidden; user-select:none; }
        .con { max-width:500px; margin:0 auto; padding:15px; }
        .hide { display:none !important; }
        .flex-bw { display:flex; justify-content:space-between; align-items:center; }
        .flex-al { display:flex; align-items:center; gap:10px; }
        
        /* UI Components */
        .card { background:var(--s); border-radius:15px; padding:15px; margin-bottom:12px; box-shadow:var(--sh); border:1px solid var(--bor); position:relative; }
        .inp { width:100%; padding:12px; border:1px solid var(--bor); border-radius:12px; background:var(--bg); font-size:0.95rem; margin-bottom:12px; }
        .btn { width:100%; padding:12px; border-radius:12px; font-weight:bold; cursor:pointer; border:none; transition:0.2s; }
        .btn:active { transform:scale(0.97); }
        .btn-p { background:var(--p); color:white; }
        .btn-o { border:1px solid var(--bor); color:var(--tg); background:transparent; }
        .btn-s { padding:6px 12px; font-size:0.8rem; width:auto; }
        
        /* Loading & Skeleton */
        .loading::after { content:""; position:absolute; left:50%; top:50%; width:20px; height:20px; border:2px solid #fff; border-top-color:transparent; border-radius:50%; animation:rot 0.8s linear infinite; transform:translate(-50%,-50%); }
        @keyframes rot { to { transform:translate(-50%,-50%) rotate(360deg); } }
        
        /* User Avatar */
        .av { width:45px; height:45px; border-radius:50%; object-fit:cover; background:#e2e8f0; border:1px solid var(--bor); }
        .av-s { width:35px; height:35px; }
        .av-l { width:80px; height:80px; }

        /* Nav */
        .nav { position:fixed; bottom:0; left:0; width:100%; background:var(--s); border-top:1px solid var(--bor); display:flex; justify-content:space-around; padding:12px 0; z-index:100; }
        .n-it { font-size:1.6rem; color:#94a3b8; position:relative; cursor:pointer; }
        .n-it.active { color:var(--p); }
        .bdg { position:absolute; top:-3px; right:-5px; background:var(--err); color:white; font-size:0.65rem; padding:2px 5px; border-radius:10px; }

        /* Post */
        .p-nm { font-weight:bold; font-size:0.95rem; }
        .p-id { font-size:0.75rem; color:var(--tg); }
        .p-txt { margin:10px 0; line-height:1.6; white-space:pre-wrap; }
        .p-act { border-top:1px solid var(--bor); padding-top:10px; margin-top:10px; display:flex; gap:20px; color:var(--tg); }
        .act { cursor:pointer; display:flex; align-items:center; gap:5px; }
        .lk-red { color:var(--err); animation:pop 0.3s; }
        @keyframes pop { 50% { transform:scale(1.3); } }
        .ment { color:var(--p); cursor:pointer; font-weight:bold; }

        /* Uploading State */
        .sending { opacity:0.6; pointer-events:none; position:relative; }
        .sending::before { content:"Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„..."; position:absolute; top:5px; left:10px; font-size:0.7rem; color:var(--p); font-weight:bold; }
        .prog { height:3px; background:#e2e8f0; width:100%; margin-top:10px; overflow:hidden; border-radius:2px; display:none; }
        .fill { height:100%; background:var(--p); width:0%; transition:width 0.2s; }

        /* Messages */
        .msg-r { display:flex; gap:10px; padding:10px; border-bottom:1px solid var(--bor); align-items:center; cursor:pointer; }
        .msg-u { font-weight:bold; }
        .msg-l { font-size:0.8rem; color:var(--tg); overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
        .tik { font-size:0.7rem; margin-right:3px; }
        .tik.ok { color:var(--p); }
        .tik.no { color:var(--tg); }

        /* Toast */
        #tst { position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#1e293b; color:white; padding:8px 16px; border-radius:20px; z-index:2000; font-size:0.85rem; opacity:0; pointer-events:none; transition:0.3s; }
        #tst.show { opacity:1; top:30px; }
    </style>
</head>
<body>

    <div id="tst"></div>

    <!-- AUTH -->
    <div id="sc-auth" class="con" style="height:100vh; display:flex; flex-direction:column; justify-content:center;">
        <h1 style="text-align:center; color:var(--p); margin-bottom:30px;">ğŸŒ€ Ø³ÙˆØ´ÛŒØ§Ù„ Ù¾Ù„Ø§Ø³</h1>
        
        <div id="f-log">
            <div class="card">
                <h3 style="text-align:center; margin-bottom:15px">ÙˆØ±ÙˆØ¯</h3>
                <input type="text" id="l-user" class="inp" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ (Ø³ØªÙˆÙ† B)" inputmode="numeric">
                <input type="password" id="l-ps" class="inp" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
                <button class="btn btn-p" onclick="app.login(this)">ÙˆØ±ÙˆØ¯</button>
                <button class="btn btn-o" style="margin-top:10px" onclick="app.guest()">ÙˆØ±ÙˆØ¯ Ù…Ù‡Ù…Ø§Ù†</button>
            </div>
            <p style="text-align:center; color:var(--p); cursor:pointer; margin-top:15px" onclick="toggleAuth()">Ø«Ø¨Øª Ù†Ø§Ù…</p>
        </div>

        <div id="f-reg" class="hide">
            <div class="card">
                <h3 style="text-align:center; margin-bottom:15px">Ø«Ø¨Øª Ù†Ø§Ù…</h3>
                <input type="number" id="r-nc" class="inp" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ" inputmode="numeric">
                <input type="text" id="r-nm" class="inp" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ">
                <input type="text" id="r-us" class="inp" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ (Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)">
                <input type="number" id="r-rf" class="inp" placeholder="Ú©Ø¯ Ù…Ø¹Ø±Ù" inputmode="numeric">
                <input type="password" id="r-ps" class="inp" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
                <button class="btn btn-p" onclick="app.reg(this)">Ø«Ø¨Øª Ù†Ø§Ù…</button>
            </div>
            <p style="text-align:center; color:var(--tg); cursor:pointer; margin-top:15px" onclick="toggleAuth()">Ø¨Ø§Ø²Ú¯Ø´Øª</p>
        </div>
    </div>

    <!-- APP -->
    <div id="sc-app" class="hide">
        
        <!-- HOME -->
        <section id="s-hm" class="con">
            <div class="flex-bw" style="margin-bottom:10px"><h2>Ø®Ø§Ù†Ù‡</h2><div onclick="app.sync(true)" style="cursor:pointer">ğŸ”„</div></div>
            <div id="feed"></div>
            <div id="ldr" style="text-align:center; padding:20px; display:none; color:var(--tg)">...</div>
        </section>

        <!-- EXPLORE / SEARCH -->
        <section id="s-ex" class="con hide">
            <input type="text" class="inp" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ú©Ø§Ø±Ø¨Ø±..." onkeyup="if(event.key==='Enter') app.srch(this.value)">
            <div id="res-bx"></div>
        </section>

        <!-- ADD POST -->
        <section id="s-ad" class="con hide">
            <h2>Ù¾Ø³Øª Ø¬Ø¯ÛŒØ¯</h2>
            <div class="card" id="pub-bx">
                <input type="text" id="p-ti" class="inp" placeholder="Ø¹Ù†ÙˆØ§Ù†">
                <select id="p-ct" class="inp">
                    <option value="Ø¹Ù…ÙˆÙ…ÛŒ">Ø¹Ù…ÙˆÙ…ÛŒ</option>
                    <option value="Ø§Ø®Ø¨Ø§Ø±">Ø§Ø®Ø¨Ø§Ø±</option>
                    <option value="Ø¢Ù…ÙˆØ²Ø´ÛŒ">Ø¢Ù…ÙˆØ²Ø´ÛŒ</option>
                </select>
                <textarea id="p-tx" class="inp" rows="5" placeholder="Ù…ØªÙ†..."></textarea>
                <div class="prog" id="p-prg"><div class="fill" id="p-fil"></div></div>
                <button class="btn btn-p" onclick="app.pub(this)">Ø§Ø±Ø³Ø§Ù„</button>
            </div>
        </section>

        <!-- MESSAGES & REQUESTS -->
        <section id="s-ms" class="con hide">
            <h2>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§</h2>
            <div style="margin:15px 0">
                <div class="card" id="req-bx" style="background:#eff6ff; border-color:#bfdbfe"></div>
            </div>
            <div id="chat-ls"></div>
        </section>

        <!-- CHAT ROOM -->
        <section id="s-ch" class="hide" style="position:fixed; top:0; left:0; right:0; bottom:0; background:var(--bg); z-index:200; display:flex; flex-direction:column">
            <div style="background:var(--s); padding:10px; border-bottom:1px solid var(--bor); display:flex; align-items:center; gap:10px">
                <button class="btn-s btn-o" onclick="document.getElementById('s-ch').classList.add('hide')">â¬…</button>
                <div id="ch-nm" style="font-weight:bold" onclick="app.nav('pr', app.st.cpid)"></div>
            </div>
            <div id="ch-bx" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:8px"></div>
            <div style="padding:10px; background:var(--s); display:flex; gap:5px">
                <input type="text" id="ch-in" class="inp" style="margin:0" placeholder="Ù¾ÛŒØ§Ù…...">
                <button class="btn btn-p" style="width:50px" onclick="app.sndM()">â¤</button>
            </div>
        </section>

        <!-- PROFILE -->
        <section id="s-pr" class="con hide">
            <div class="card">
                <div class="flex-bw">
                    <button class="btn-s btn-o" onclick="app.nav('hm')">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
                    <button class="btn-s btn-o" onclick="app.share()">ğŸ”—</button>
                </div>
                <div style="text-align:center; margin-top:15px">
                    <img id="pr-pic" class="av av-l">
                    <h3 id="pr-nm" style="margin-top:10px"></h3>
                    <div id="pr-id" style="color:var(--tg); font-size:0.9rem"></div>
                    <div id="pr-bio" style="margin:10px 0; font-size:0.9rem; white-space:pre-wrap"></div>
                    <div id="pr-lnk" style="font-size:0.85rem; color:var(--p)"></div>
                </div>
                <div class="flex-bw" style="margin:20px 0; text-align:center">
                    <div><b id="c-po">0</b><br><small>Ù¾Ø³Øª</small></div>
                    <div><b id="c-fl">0</b><br><small>Ø¯Ù†Ø¨Ø§Ù„â€ŒÚ©Ù†Ù†Ø¯Ù‡</small></div>
                    <div><b id="c-fi">0</b><br><small>Ø¯Ù†Ø¨Ø§Ù„â€ŒØ´ÙˆÙ†Ø¯Ù‡</small></div>
                </div>
                <div id="pr-act" class="flex-bw" style="gap:10px"></div>
            </div>
            <div id="pr-feed"></div>
        </section>

        <!-- SETTINGS -->
        <section id="s-st" class="con hide">
            <h2>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h2>
            <div class="card">
                <div style="margin-bottom:10px">Ú©Ø¯ Ù…Ù„ÛŒ: <b id="st-nc"></b></div>
                <div style="margin-bottom:10px">Ú©Ø¯ Ø¯Ø¹ÙˆØª: <b id="st-rf"></b></div>
                <input type="text" id="e-pic" class="inp" placeholder="Ù„ÛŒÙ†Ú© Ø¹Ú©Ø³">
                <input type="text" id="e-nm" class="inp" placeholder="Ù†Ø§Ù…">
                <textarea id="e-bio" class="inp" placeholder="Ø¨ÛŒÙˆ"></textarea>
                <input type="text" id="e-web" class="inp" placeholder="ÙˆØ¨Ø³Ø§ÛŒØª">
                <div class="flex-bw" style="margin:10px 0"><span>Ø®ØµÙˆØµÛŒ</span><input type="checkbox" id="e-pri"></div>
                <div class="flex-bw" style="margin:10px 0"><span>Ù¾ÛŒØ§Ù… Ø¨Ø§Ø²</span><input type="checkbox" id="e-msg"></div>
                <button class="btn btn-p" onclick="app.saveSet()">Ø°Ø®ÛŒØ±Ù‡</button>
                <button class="btn btn-o" style="margin-top:10px; color:red; border-color:red" onclick="localStorage.clear();location.reload()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </section>

        <!-- COMMENTS MODAL -->
        <div id="m-cm" class="hide" style="position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:150; display:flex; align-items:flex-end">
            <div style="background:var(--s); width:100%; max-height:80vh; border-radius:20px 20px 0 0; display:flex; flex-direction:column; animation:up 0.3s">
                <div style="padding:10px; border-bottom:1px solid var(--bor); text-align:center; font-weight:bold">Ù†Ø¸Ø±Ø§Øª <span onclick="document.getElementById('m-cm').classList.add('hide')" style="float:left; cursor:pointer">âœ•</span></div>
                <div id="cm-ls" style="flex:1; overflow-y:auto; padding:15px"></div>
                <div style="padding:10px; border-top:1px solid var(--bor); display:flex; gap:5px">
                    <input type="text" id="cm-in" class="inp" style="margin:0" placeholder="Ù†Ø¸Ø±...">
                    <button class="btn btn-p" style="width:50px" onclick="app.sndC()">âœ“</button>
                </div>
            </div>
        </div>

        <div class="nav">
            <div class="n-it active" id="n-hm" onclick="app.nav('hm')">ğŸ </div>
            <div class="n-it" id="n-ex" onclick="app.nav('ex')">ğŸ”</div>
            <div class="n-it" id="n-ad" onclick="app.nav('ad')">â•</div>
            <div class="n-it" id="n-ms" onclick="app.nav('ms')">ğŸ’¬ <span id="bg-ms" class="bdg hide"></span></div>
            <div class="n-it" id="n-pr" onclick="app.nav('pr')">ğŸ‘¤</div>
            <div class="n-it" id="n-st" onclick="app.nav('st')">âš™ï¸</div>
        </div>
    </div>

    <script>
        // *** Ù„ÛŒÙ†Ú© Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯ ***
        const API = 'https://script.google.com/macros/s/AKfycbyf_X4VQfe1YC95wWXkUkFrHAHDOCTmC6qzzsNCp-O57HvGikcAPZWlPAbS_9_kWrYI/exec';

        const toggleAuth = () => { document.getElementById('f-log').classList.toggle('hide'); document.getElementById('f-reg').classList.toggle('hide'); };

        const app = {
            st: { user:null, users:[], posts:[], msgs:[], cpid:null, guest:false },
            
            init: function() {
                const db = localStorage.getItem('db');
                if(db) { const d=JSON.parse(db); this.st.users=d.users; this.st.posts=d.posts; this.st.msgs=d.msgs; }
                
                const uid = localStorage.getItem('uid');
                if(uid) {
                    const u = this.st.users.find(x=>x.id===uid);
                    if(u) { this.st.user=u; this.start(); this.sync(); }
                    else document.getElementById('sc-auth').classList.remove('hide');
                } else document.getElementById('sc-auth').classList.remove('hide');

                const p = new URLSearchParams(location.search);
                if(p.get('u')) setTimeout(()=>this.nav('pr', p.get('u')), 1000);
            },

            call: async function(act, pl) {
                try {
                    const req = await fetch(API, {
                        method: 'POST',
                        redirect: "follow",
                        headers: {'Content-Type': 'text/plain;charset=utf-8'},
                        body: JSON.stringify({action: act, payload: pl})
                    });
                    return await req.json();
                } catch(e) { return {status:'error'}; }
            },

            sync: async function(m) {
                if(m) app.toast('Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ...');
                const d = await this.call('getAll', {});
                if(d.status==='success') {
                    this.st.users=d.users; this.st.posts=d.posts; this.st.msgs=d.msgs;
                    localStorage.setItem('db', JSON.stringify(d));
                    if(this.st.user && !this.st.guest) this.st.user = this.st.users.find(u=>u.id===this.st.user.id);
                    if(!document.getElementById('s-hm').classList.contains('hide')) this.feed();
                    this.bdg();
                    if(m) app.toast('Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
                }
            },

            // AUTH
            login: async function(btn) {
                const u=document.getElementById('l-user').value, p=document.getElementById('l-ps').value;
                if(!u || !p) return app.toast('Ø®Ø§Ù„ÛŒ');
                btn.classList.add('loading');
                const d = await this.call('login', {user:u, pass:p});
                if(d.status==='success') {
                    this.st.user=d.user;
                    if(document.getElementById('l-rem').checked) localStorage.setItem('uid', d.user.id);
                    this.start(); this.sync();
                } else app.toast(d.msg);
                btn.classList.remove('loading');
            },
            reg: async function(btn) {
                const p={id:document.getElementById('r-us').value.toLowerCase(), user:document.getElementById('r-nc').value, pass:document.getElementById('r-ps').value, name:document.getElementById('r-nm').value, refCode:document.getElementById('r-rf').value};
                if(!p.id || !p.user || !p.pass) return app.toast('Ø®Ø§Ù„ÛŒ');
                btn.classList.add('loading');
                const d = await this.call('register', p);
                if(d.status==='success') { app.toast('Ø«Ø¨Øª Ø´Ø¯'); toggleAuth(); }
                else app.toast(d.msg);
                btn.classList.remove('loading');
            },
            guest: function() {
                this.st.guest=true;
                this.st.user={id:'guest', name:'Ù…Ù‡Ù…Ø§Ù†', followers:[], following:[], requests:[], blocked:[]};
                this.start();
            },
            start: function() {
                document.getElementById('sc-auth').classList.add('hide');
                document.getElementById('sc-app').classList.remove('hide');
                if(this.st.guest) ['n-ad','n-ms','n-st'].forEach(x=>document.getElementById(x).style.display='none');
                this.nav('hm');
            },

            // NAV
            nav: function(p, arg) {
                document.querySelectorAll('section').forEach(x=>x.classList.add('hide'));
                document.querySelectorAll('.n-it').forEach(x=>x.classList.remove('active'));
                if(p==='hm') { document.getElementById('s-hm').classList.remove('hide'); document.getElementById('n-hm').classList.add('active'); this.feed(); }
                else if(p==='ex') document.getElementById('s-ex').classList.remove('hide');
                else if(p==='ad') document.getElementById('s-ad').classList.remove('hide');
                else if(p==='ms') { document.getElementById('s-ms').classList.remove('hide'); this.msList(); }
                else if(p==='pr') { 
                    document.getElementById('s-pr').classList.remove('hide'); 
                    this.prof(arg || this.st.user.id);
                }
                else if(p==='st') { document.getElementById('s-st').classList.remove('hide'); this.setUI(); }
            },

            // FEED & POSTS
            feed: function() {
                const c = document.getElementById('feed'); c.innerHTML='';
                const ps = this.st.posts.sort((a,b)=>b.time-a.time);
                // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨ÛŒâ€ŒÙ†Ù‡Ø§ÛŒØª Ø³Ø§Ø¯Ù‡: ÙØ¹Ù„Ø§ 50 ØªØ§ÛŒ Ø§ÙˆÙ„
                ps.slice(0, 50).forEach(p => c.innerHTML += this.htmlP(p));
            },
            htmlP: function(p) {
                const u = this.st.users.find(x=>x.id===p.uid)||{name:'unknown', pic:''};
                const lk = p.likes.includes(this.st.user.id) ? 'lk-red' : '';
                // Ø­Ù„ Ù…Ø´Ú©Ù„ Ù†Ù…Ø§ÛŒØ´ Ù¾Ø³Øª "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„"
                const sending = p.pid.startsWith('tmp') ? 'sending' : '';
                
                return `<div class="card ${sending}" id="p-${p.pid}">
                    <div class="flex-al" onclick="app.nav('pr','${p.uid}')">
                        <img src="${u.pic||''}" class="av av-s" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iI2NjYyIgZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00czLTEuNzktNC00LTQSOF4Ljc5IDggNG0wIDJjLTIuNjcgMC04IDEuMzQtOCA0djJoMTZ2LTJjMC0yLjY2LTUuMzMtNC04LTR6Ii8+PC9zdmc+'">
                        <div><div class="p-nm">${u.name}</div><div class="p-id">@${u.nc}</div></div>
                    </div>
                    <div class="p-txt">${this.lnk(p.text)}</div>
                    <div class="p-act">
                        <div class="act ${lk}" onclick="app.like('${p.pid}')">â¤ <span id="l-${p.pid}">${p.likes.length}</span></div>
                        <div class="act" onclick="app.comm('${p.pid}')">ğŸ’¬ ${p.comments.length}</div>
                        <div class="act" onclick="app.copyLnk('${p.pid}')">ğŸ”—</div>
                    </div>
                </div>`;
            },
            
            // OPTIMISTIC ACTIONS
            pub: async function(btn) {
                const p = {
                    pid: 'tmp-'+Date.now(), uid: this.st.user.id,
                    title: document.getElementById('p-ti').value,
                    cat: document.getElementById('p-ct').value,
                    text: document.getElementById('p-tx').value,
                    time: Date.now(), likes:[], comments:[]
                };
                if(!p.text) return app.toast('Ù…ØªÙ† Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
                
                // UI
                btn.style.display='none';
                document.getElementById('p-prg').style.display='block';
                setTimeout(()=>document.getElementById('p-fil').style.width='90%', 500);

                // Add temp post
                this.st.posts.unshift(p);
                this.nav('hm'); // Ø¨Ø±Ùˆ Ø¨Ù‡ Ø®Ø§Ù†Ù‡ Ùˆ Ù¾Ø³Øª Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø±Ø§ Ø¨Ø¨ÛŒÙ†

                // Send
                await this.call('createPost', {pid:this.st.user.id+'_'+Date.now(), ...p});
                
                // Finalize
                app.toast('Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯');
                document.getElementById('p-ti').value=''; document.getElementById('p-tx').value='';
                document.getElementById('p-prg').style.display='none';
                document.getElementById('p-fil').style.width='0%';
                btn.style.display='block';
                this.sync(); // Ø±ÙØ±Ø´ ÙˆØ§Ù‚Ø¹ÛŒ
            },
            like: function(pid) {
                const p = this.st.posts.find(x=>x.pid===pid);
                const me = this.st.user.id;
                // Optimistic
                if(p.likes.includes(me)) p.likes = p.likes.filter(x=>x!==me);
                else p.likes.push(me);
                
                // Update UI Element specifically
                const el = document.getElementById('p-'+pid);
                if(el) {
                    const icon = el.querySelector('.act');
                    if(p.likes.includes(me)) icon.classList.add('lk-red'); else icon.classList.remove('lk-red');
                    document.getElementById('l-'+pid).innerText = p.likes.length;
                }
                
                this.call('updatePost', {pid:p.pid, likes:p.likes, comments:p.comments});
            },
            comm: function(pid) {
                this.st.cpid=pid;
                document.getElementById('m-cm').classList.remove('hide');
                this.rnCm();
            },
            rnCm: function() {
                const p = this.st.posts.find(x=>x.pid===this.st.cpid);
                const c = document.getElementById('cm-ls'); c.innerHTML='';
                p.comments.forEach(m => {
                    const u = this.st.users.find(x=>x.id===m.uid);
                    c.innerHTML += `<div style="margin-bottom:10px" onclick="app.nav('pr','${m.uid}')"><b>${u?u.name:'?'}</b>: ${this.lnk(m.text)}</div>`;
                });
            },
            sndC: function() {
                const t = document.getElementById('cm-in').value; if(!t) return;
                const p = this.st.posts.find(x=>x.pid===this.st.cpid);
                p.comments.push({uid:this.st.user.id, text:t});
                document.getElementById('cm-in').value='';
                this.rnCm(); // Update UI
                this.call('updatePost', {pid:p.pid, likes:p.likes, comments:p.comments});
            },

            // MESSAGES & REQUESTS
            msList: function() {
                const reqs = this.st.user.requests;
                const rb = document.getElementById('req-bx');
                rb.innerHTML = reqs.length ? '' : '<small style="padding:10px;display:block">Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</small>';
                reqs.forEach(id => {
                    const u = this.st.users.find(x=>x.id===id);
                    rb.innerHTML += `<div class="flex-bw" style="padding:10px; border-bottom:1px solid #fff">
                        <div class="flex-al" onclick="app.nav('pr','${id}')"><img src="${u.pic}" class="av av-s"> ${u.name}</div>
                        <div><button class="btn-s btn-p" onclick="app.ans('${id}',true)">âœ“</button> <button class="btn-s btn-o" onclick="app.ans('${id}',false)">âœ—</button></div>
                    </div>`;
                });

                const chats = [...new Set(this.st.msgs.filter(x=>x.from===this.st.user.id||x.to===this.st.user.id).map(x=>x.from===this.st.user.id?x.to:x.from))];
                const cl = document.getElementById('chat-ls'); cl.innerHTML='';
                chats.forEach(cid => {
                    const u = this.st.users.find(x=>x.id===cid);
                    const last = this.st.msgs.filter(x=>(x.from===this.st.user.id&&x.to===cid)||(x.from===cid&&x.to===this.st.user.id)).pop();
                    const unseen = this.st.msgs.filter(x=>x.from===cid && x.to===this.st.user.id && !x.read).length;
                    
                    cl.innerHTML += `<div class="msg-r" onclick="app.chat('${cid}')">
                        <img src="${u.pic}" class="av">
                        <div style="flex:1;overflow:hidden">
                            <div class="flex-bw"><span class="msg-u">${u.name}</span> <small style="color:var(--tg)">${new Date(last.time).toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit'})}</small></div>
                            <div class="msg-l">${last.from===this.st.user.id ? '<span class="tik '+(last.read?'ok':'no')+'">âœ“âœ“</span>':''} ${last.text}</div>
                        </div>
                        ${unseen ? `<div class="bdg" style="position:static">${unseen}</div>` : ''}
                    </div>`;
                });
            },
            ans: function(id, ok) {
                const me = this.st.user;
                me.requests = me.requests.filter(x=>x!==id);
                const u = this.st.users.find(x=>x.id===id);
                if(ok) { me.followers.push(id); u.following.push(me.id); }
                this.msList();
                this.call('updateUser', [me, u]);
            },
            chat: function(id) {
                this.st.cpid = id;
                const u = this.st.users.find(x=>x.id===id);
                document.getElementById('ch-nm').innerText = u.name;
                document.getElementById('s-ch').classList.remove('hide');
                this.rnCh();
                // Mark read
                const unread = this.st.msgs.filter(x=>x.from===id && x.to===this.st.user.id && !x.read);
                if(unread.length) {
                    unread.forEach(x=>x.read=true);
                    this.call('createMsg', {readOnlyUpdate:true, ids:unread}); // Simplified logic
                    this.sync(); // For proper update
                }
            },
            rnCh: function() {
                const b = document.getElementById('ch-bx'); b.innerHTML='';
                const ms = this.st.msgs.filter(x=>(x.from===this.st.user.id&&x.to===this.st.cpid)||(x.from===this.st.cpid&&x.to===this.st.user.id));
                ms.forEach(x => {
                    const mine = x.from===this.st.user.id;
                    b.innerHTML += `<div style="align-self:${mine?'flex-end':'flex-start'}; max-width:80%; margin-bottom:5px">
                        <div style="background:${mine?'#dbeafe':'#f1f5f9'}; padding:8px 12px; border-radius:15px; font-size:0.9rem">
                            ${this.lnk(x.text)}
                            <div style="text-align:left; font-size:0.65rem; margin-top:3px; color:var(--tg)">
                                ${new Date(x.time).toLocaleTimeString('fa-IR')}
                                ${mine ? `<span class="tik ${x.read?'ok':'no'}">âœ“âœ“</span>` : ''}
                            </div>
                        </div>
                    </div>`;
                });
                b.scrollTop = b.scrollHeight;
            },
            sndM: function() {
                const t = document.getElementById('ch-in').value; if(!t) return;
                const m = {from:this.st.user.id, to:this.st.cpid, text:t, time:Date.now(), read:false};
                this.st.msgs.push(m);
                document.getElementById('ch-in').value='';
                this.rnCh();
                this.call('createMsg', m).then(d=>{
                    // Server confirmation logic can be added here
                });
            },

            // PROFILE
            prof: function(id) {
                const u = this.st.users.find(x=>x.id===id);
                const me = this.st.user;
                const isMe = id===me.id;
                
                document.getElementById('pr-pic').src = u.pic || '';
                document.getElementById('pr-nm').innerText = u.name;
                document.getElementById('pr-id').innerText = '@'+u.nc;
                document.getElementById('pr-bio').innerHTML = this.lnk(u.bio);
                document.getElementById('pr-lnk').innerText = u.web;
                document.getElementById('c-po').innerText = this.st.posts.filter(x=>x.uid===id).length;
                document.getElementById('c-fl').innerText = u.followers.length;
                document.getElementById('c-fi').innerText = u.following.length;

                const act = document.getElementById('pr-act'); act.innerHTML='';
                if(!isMe) {
                    let txt='Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù†', cls='btn-p';
                    if(me.following.includes(id)) { txt='Ù„ØºÙˆ'; cls='btn-o'; }
                    else if(u.requests.includes(me.id)) { txt='Ø§Ù†ØªØ¸Ø§Ø±'; cls='btn-o'; }
                    
                    act.innerHTML = `<button class="btn ${cls}" onclick="app.fol('${id}')">${txt}</button>
                                     <button class="btn btn-o" onclick="app.chat('${id}')">Ù¾ÛŒØ§Ù…</button>`;
                }

                const canSee = isMe || !u.isPrivate || u.followers.includes(me.id);
                const pf = document.getElementById('pr-feed'); pf.innerHTML='';
                if(canSee) {
                    this.st.posts.filter(x=>x.uid===id).sort((a,b)=>b.time-a.time).forEach(p => pf.innerHTML+=this.htmlP(p));
                } else {
                    pf.innerHTML = '<div style="text-align:center;padding:20px">ğŸ”’ Ø®ØµÙˆØµÛŒ</div>';
                }
            },
            fol: function(id) {
                const u = this.st.users.find(x=>x.id===id);
                const me = this.st.user;
                
                if(me.following.includes(id)) {
                    me.following = me.following.filter(x=>x!==id);
                    u.followers = u.followers.filter(x=>x!==me.id);
                } else if(u.isPrivate) {
                    if(!u.requests.includes(me.id)) u.requests.push(me.id);
                } else {
                    me.following.push(id);
                    u.followers.push(me.id);
                }
                this.prof(id); // UI Update
                this.call('updateUser', [me, u]);
            },

            // HELPERS
            lnk: function(t) {
                if(!t) return '';
                // ØªØ¨Ø¯ÛŒÙ„ @username Ø¨Ù‡ Ù„ÛŒÙ†Ú© (Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ Ú©Ø¯ Ù…Ù„ÛŒ Ø³ØªÙˆÙ† B Ú©Ù‡ Ø¯Ø± Ø¸Ø§Ù‡Ø± nc Ù‡Ø³Øª)
                return t.replace(/@(\w+)/g, (match, id) => {
                    // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¢ÛŒØ¯ÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ (nc)
                    const target = this.st.users.find(x=>x.nc === id);
                    if(target) return `<span class="ment" onclick="event.stopPropagation();app.nav('pr','${target.id}')">${match}</span>`;
                    return match;
                });
            },
            copyLnk: function(pid) {
                const url = window.location.origin + window.location.pathname + '?p=' + pid;
                navigator.clipboard.writeText(url);
                this.toast('Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯');
            },
            share: function() {
                const url = window.location.origin + window.location.pathname + '?u=' + this.st.user.id;
                navigator.clipboard.writeText(url);
                this.toast('Ù„ÛŒÙ†Ú© Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ù¾ÛŒ Ø´Ø¯');
            },
            srch: function(v) {
                const r = document.getElementById('res-bx'); r.innerHTML='';
                if(!v) return;
                this.st.users.filter(x=>x.name.includes(v) || x.nc.includes(v)).forEach(u => {
                    r.innerHTML += `<div class="card flex-al" onclick="app.nav('pr','${u.id}')">
                        <img src="${u.pic}" class="av">
                        <div><b>${u.name}</b><br><small>@${u.nc}</small></div>
                    </div>`;
                });
            },
            setUI: function() {
                const u = this.st.user;
                document.getElementById('st-nc').innerText=u.nc;
                document.getElementById('st-rf').innerText=u.refCode;
                document.getElementById('e-pic').value=u.pic;
                document.getElementById('e-nm').value=u.name;
                document.getElementById('e-bio').value=u.bio;
                document.getElementById('e-web').value=u.web;
                document.getElementById('e-pri').checked=u.isPrivate;
                document.getElementById('e-msg').checked=u.allowMsg;
            },
            saveSet: async function() {
                const u = this.st.user;
                u.pic = document.getElementById('e-pic').value;
                u.name = document.getElementById('e-nm').value;
                u.bio = document.getElementById('e-bio').value;
                u.web = document.getElementById('e-web').value;
                u.isPrivate = document.getElementById('e-pri').checked;
                u.allowMsg = document.getElementById('e-msg').checked;
                app.toast('Ø°Ø®ÛŒØ±Ù‡...');
                await this.call('updateUser', u);
                app.toast('Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
            },
            toast: function(t) {
                const x = document.getElementById('tst');
                x.innerText = t; x.classList.add('show');
                setTimeout(()=>x.classList.remove('show'), 3000);
            },
            bdg: function() {
                const r = this.st.user.requests.length;
                const m = this.st.msgs.filter(x=>x.to===this.st.user.id && !x.read).length;
                const b = document.getElementById('bg-ms');
                if(r+m > 0) { b.innerText=r+m; b.classList.remove('hide'); }
                else b.classList.add('hide');
            }
        };
        app.init();
    </script>
</body>
</html>
