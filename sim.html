<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ</title>
    <style>
        :root {
            --p: #2563eb; --pd: #1e40af; --bg: #f1f5f9; --s: #ffffff;
            --t: #0f172a; --tg: #64748b; --bor: #e2e8f0; --err: #ef4444;
            --sh: 0 4px 6px -1px rgba(0,0,0,0.1); --rad: 16px;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family:-apple-system,BlinkMacSystemFont,Roboto,sans-serif; -webkit-tap-highlight-color:transparent; outline:none; }
        body { background:var(--bg); color:var(--t); padding-bottom:80px; overflow-x:hidden; user-select:none; }
        .con { max-width:550px; margin:0 auto; padding:15px; }
        .hide { display:none !important; }
        .flex-bw { display:flex; justify-content:space-between; align-items:center; }
        
        /* UI */
        .card { background:var(--s); border-radius:var(--rad); padding:15px; margin-bottom:15px; box-shadow:var(--sh); border:1px solid var(--bor); position:relative; }
        .inp { width:100%; padding:12px; border:2px solid var(--bor); border-radius:12px; background:var(--bg); font-size:1rem; margin-bottom:15px; transition:0.3s; }
        .inp:focus { border-color:var(--p); background:var(--s); }
        .btn { width:100%; padding:12px; border-radius:12px; font-weight:bold; font-size:1rem; display:flex; justify-content:center; gap:8px; cursor:pointer; border:none; transition:0.2s; }
        .btn:active { transform:scale(0.98); }
        .btn-p { background:linear-gradient(135deg, var(--p), var(--pd)); color:white; }
        .btn-o { border:2px solid var(--bor); color:var(--tg); background:transparent; }
        .btn-s { padding:6px 12px; font-size:0.85rem; width:auto; }
        .btn-i { font-size:1.4rem; padding:5px; color:var(--t); background:transparent; border:none; cursor:pointer; }
        
        /* Loading */
        .loading { position:relative; color:transparent !important; pointer-events:none; }
        .loading::after { content:""; position:absolute; left:50%; top:50%; width:20px; height:20px; border:3px solid #fff; border-top-color:transparent; border-radius:50%; animation:rot 0.8s linear infinite; transform:translate(-50%,-50%); }
        @keyframes rot { to { transform:translate(-50%,-50%) rotate(360deg); } }

        /* User & Post */
        .u-blk { display:flex; align-items:center; gap:10px; cursor:pointer; }
        .u-img { width:45px; height:45px; border-radius:50%; object-fit:cover; background:#cbd5e1; border:2px solid var(--s); }
        .u-nm { font-weight:700; font-size:0.95rem; }
        .u-id { font-size:0.75rem; color:var(--tg); }
        .p-act { display:flex; gap:20px; margin-top:15px; border-top:1px solid var(--bor); padding-top:10px; color:var(--tg); }
        .act-b { display:flex; align-items:center; gap:5px; cursor:pointer; font-size:0.9rem; }
        .act-b.lk { color:var(--err); animation:pop 0.3s; }
        @keyframes pop { 50% { transform:scale(1.4); } }
        .ment { color:var(--p); font-weight:bold; cursor:pointer; text-decoration:none; }

        /* Nav */
        .nav { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); width:90%; max-width:500px; background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); border-radius:20px; display:flex; justify-content:space-around; padding:10px; box-shadow:0 10px 30px rgba(0,0,0,0.1); border:1px solid rgba(255,255,255,0.5); z-index:900; }
        .n-it { font-size:1.6rem; padding:8px 12px; border-radius:12px; color:#94a3b8; transition:0.3s; position:relative; cursor:pointer; }
        .n-it.active { color:var(--p); background:#e0f2fe; transform:translateY(-3px); }
        .bdg { position:absolute; top:-2px; right:-2px; background:var(--err); color:white; font-size:0.65rem; padding:2px 6px; border-radius:10px; border:2px solid white; }

        /* Prof (Original Style) */
        .p-top { display:flex; align-items:center; gap:15px; margin-bottom:15px; }
        .p-pic { width:80px; height:80px; border-radius:50%; border:3px solid white; box-shadow:0 5px 15px rgba(0,0,0,0.1); object-fit:cover; background:#cbd5e1; }
        .p-sts { flex:1; display:flex; justify-content:space-around; text-align:center; }
        .st-n { font-weight:800; font-size:1.1rem; display:block; }
        .chips { display:flex; gap:8px; overflow-x:auto; padding:5px 0 15px; scrollbar-width:none; }
        .chip { padding:6px 14px; border-radius:20px; background:var(--s); border:1px solid var(--bor); white-space:nowrap; font-size:0.85rem; transition:0.2s; cursor:pointer; }
        .chip.active { background:var(--t); color:white; border-color:var(--t); }

        /* Upload & Ticks */
        .prog { height:4px; background:#e2e8f0; width:100%; margin-top:10px; overflow:hidden; border-radius:2px; display:none; }
        .fill { height:100%; background:linear-gradient(90deg, var(--p), var(--pd)); width:0%; transition:width 0.3s ease-out; }
        .up-msg { font-size:0.8rem; color:green; text-align:center; display:none; margin-top:5px; font-weight:bold; }
        .sending { opacity:0.7; pointer-events:none; }
        .tik { font-size:0.75rem; margin-right:3px; }
        .tik.ok { color:var(--p); }
        .tik.wait { color:var(--tg); }

        /* Toast */
        #tst { position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#1e293b; color:white; padding:10px 20px; border-radius:10px; z-index:2000; font-size:0.9rem; opacity:0; pointer-events:none; transition:0.3s; }
        #tst.show { opacity:1; top:30px; }

        /* Modals */
        .mod-bg { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; display:flex; align-items:flex-end; justify-content:center; backdrop-filter:blur(2px); }
        .mod { background:var(--s); width:100%; max-width:550px; border-radius:25px 25px 0 0; padding:20px; max-height:85vh; overflow-y:auto; animation:up 0.3s; }
        @keyframes up { from { transform:translateY(100%); } to { transform:translateY(0); } }
    </style>
</head>
<body>

    <div id="tst"></div>

    <!-- AUTHENTICATION -->
    <div id="scr-auth" class="con" style="height:100vh; display:flex; flex-direction:column; justify-content:center;">
        <h1 style="text-align:center; color:var(--p); margin-bottom:30px; font-size:2rem;">ğŸŒ€ Ø³ÙˆØ´ÛŒØ§Ù„</h1>
        
        <div id="f-log">
            <div class="card">
                <h2 style="text-align:center; margin-bottom:20px">ÙˆØ±ÙˆØ¯</h2>
                <input type="text" id="l-nc" class="inp" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ (Ø³ØªÙˆÙ† B)" inputmode="numeric">
                <input type="password" id="l-ps" class="inp" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
                <div style="margin-bottom:15px; font-size:0.9rem"><label><input type="checkbox" id="l-rem" checked> Ø°Ø®ÛŒØ±Ù‡ ÙˆØ±ÙˆØ¯</label></div>
                <button class="btn btn-p" onclick="app.login(this)">ÙˆØ±ÙˆØ¯</button>
                <button class="btn btn-o" style="margin-top:10px" onclick="app.guest()">ÙˆØ±ÙˆØ¯ Ù…Ù‡Ù…Ø§Ù†</button>
            </div>
            <p style="text-align:center; color:var(--p); cursor:pointer; margin-top:15px" onclick="app.togAuth()">Ø«Ø¨Øª Ù†Ø§Ù…</p>
        </div>

        <div id="f-reg" class="hide">
            <div class="card">
                <h2 style="text-align:center; margin-bottom:20px">Ø«Ø¨Øª Ù†Ø§Ù…</h2>
                <input type="number" id="r-nc" class="inp" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ (Û±Û° Ø±Ù‚Ù…)" inputmode="numeric">
                <input type="text" id="r-nm" class="inp" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ">
                <input type="text" id="r-us" class="inp" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ (Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)">
                <input type="number" id="r-rf" class="inp" placeholder="Ú©Ø¯ Ù…Ø¹Ø±Ù" inputmode="numeric">
                <input type="password" id="r-ps" class="inp" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
                <button class="btn btn-p" onclick="app.reg(this)">Ø«Ø¨Øª Ù†Ø§Ù…</button>
            </div>
            <p style="text-align:center; color:var(--tg); cursor:pointer; margin-top:15px" onclick="app.togAuth()">Ø¨Ø§Ø²Ú¯Ø´Øª</p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="scr-app" class="hide">
        
        <!-- HOME -->
        <section id="s-hm" class="con">
            <div class="flex-bw" style="margin-bottom:15px"><h2>Ø®Ø§Ù†Ù‡</h2><button class="btn-i" onclick="app.sync(true)">ğŸ”„</button></div>
            <input type="text" class="inp" placeholder="Ø¬Ø³ØªØ¬Ùˆ..." onkeyup="if(event.key==='Enter') app.srch(this.value)" style="border-radius:20px">
            
            <div style="margin-bottom:20px">
                <h4 style="margin-bottom:10px; font-size:0.85rem; color:var(--tg)">Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†â€ŒÙ‡Ø§</h4>
                <div id="new-bx" style="display:flex; gap:10px; overflow-x:auto; padding-bottom:5px"></div>
            </div>
            <div id="feed-up"></div> <!-- Ù…Ø­Ù„ Ù¾Ø³Øª Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ù„ÙˆØ¯ -->
            <div id="feed"></div>
        </section>

        <!-- PROFILE (Ø¨Ø§ Ø¸Ø§Ù‡Ø± Ø§ØµÙ„ÛŒ) -->
        <section id="s-pr" class="con hide">
            <div class="card">
                <div class="flex-bw" style="margin-bottom:15px">
                    <button class="btn-i" id="bp-bk" onclick="app.nav('hm')">â¬…ï¸</button>
                    <h3 id="p-hd"></h3>
                    <button class="btn-i" onclick="document.getElementById('p-mn').classList.toggle('hide')">â‹®</button>
                    <div id="p-mn" class="card hide" style="position:absolute; top:40px; left:10px; width:150px; z-index:10; padding:5px;">
                        <div style="padding:10px; cursor:pointer" onclick="app.share('prof')">ğŸ”— Ø§Ø´ØªØ±Ø§Ú©</div>
                        <div style="padding:10px; color:red; cursor:pointer" onclick="app.block()">ğŸš« Ù…Ø³Ø¯ÙˆØ¯</div>
                    </div>
                </div>
                <div class="p-top">
                    <img id="p-im" class="p-pic" src="">
                    <div class="p-sts">
                        <div onclick="app.list('posts')"><span class="st-n" id="c-pt">0</span><span>Ù¾Ø³Øª</span></div>
                        <div onclick="app.list('fol')"><span class="st-n" id="c-fl">0</span><span>Ø¯Ù†Ø¨Ø§Ù„â€ŒÚ©Ù†Ù†Ø¯Ù‡</span></div>
                        <div onclick="app.list('fing')"><span class="st-n" id="c-fi">0</span><span>Ø¯Ù†Ø¨Ø§Ù„â€ŒØ´ÙˆÙ†Ø¯Ù‡</span></div>
                    </div>
                </div>
                <h3 id="p-nm"></h3>
                <div style="color:var(--tg); font-size:0.9rem; margin-bottom:5px">@<span id="p-id"></span></div>
                <p id="p-bi" style="font-size:0.9rem"></p>
                <div id="p-lnk" style="margin-top:8px; font-size:0.9rem;"></div>
                <div class="flex-bw" id="p-act" style="margin-top:15px; gap:10px">
                    <button id="b-fl" class="btn btn-p" onclick="app.fol()">Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù†</button>
                    <button class="btn btn-o" onclick="app.chat(app.st.vid)">Ù¾ÛŒØ§Ù…</button>
                </div>
            </div>
            <div id="p-con">
                <div class="chips">
                    <span class="chip active" onclick="app.flt('all',this)">Ù‡Ù…Ù‡</span>
                    <span class="chip" onclick="app.flt('book',this)">Ú©ØªØ§Ø¨</span>
                    <span class="chip" onclick="app.flt('movie',this)">ÙÛŒÙ„Ù…</span>
                    <span class="chip" onclick="app.flt('site',this)">Ø³Ø§ÛŒØª</span>
                </div>
                <div id="p-pts"></div>
            </div>
            <div id="p-lck" class="card hide" style="text-align:center; padding:40px;"><h2>ğŸ”’</h2><p>Ø®ØµÙˆØµÛŒ</p></div>
        </section>

        <!-- ADD POST -->
        <section id="s-ad" class="con hide">
            <h2 style="margin-bottom:15px">Ù¾Ø³Øª Ø¬Ø¯ÛŒØ¯</h2>
            <div class="card" id="post-card">
                <input type="text" id="a-ti" class="inp" placeholder="Ø¹Ù†ÙˆØ§Ù†">
                <select id="a-ct" class="inp">
                    <option value="book">Ú©ØªØ§Ø¨</option>
                    <option value="movie">ÙÛŒÙ„Ù…</option>
                    <option value="site">Ø³Ø§ÛŒØª</option>
                </select>
                <textarea id="a-tx" class="inp" rows="6" placeholder="Ù…ØªÙ†..."></textarea>
                <div class="prog" id="p-prg"><div class="fill" id="p-fil"></div></div>
                <div class="up-msg" id="p-msg">Ù¾Ø³Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!</div>
                <button class="btn btn-p" style="margin-top:10px" onclick="app.pub(this)">Ø§Ø±Ø³Ø§Ù„</button>
            </div>
        </section>

        <!-- MESSAGES -->
        <section id="s-ms" class="con hide">
            <div class="flex-bw" style="margin-bottom:15px">
                <h2>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§</h2>
                <div style="display:flex; gap:5px">
                    <span class="chip active" onclick="app.msg('chat')">Ú¯ÙØªÚ¯Ùˆ</span>
                    <span class="chip" onclick="app.msg('req')">Ø¯Ø±Ø®ÙˆØ§Ø³Øª <span id="b-rq" class="bdg hide"></span></span>
                </div>
            </div>
            <div id="msg-bx"></div>
        </section>

        <!-- SETTINGS (Ø¨Ø§ Ø¸Ø§Ù‡Ø± Ø§ØµÙ„ÛŒ) -->
        <section id="s-st" class="con hide">
            <h2>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h2>
            <div class="card" style="background:linear-gradient(135deg, #3b82f6, #2563eb); color:white; margin-top:15px;">
                <div class="flex-bw"><h3 id="st-nm"></h3> <small id="st-id"></small></div>
                <div style="margin-top:10px">Ú©Ø¯ Ù…Ù„ÛŒ: <span id="st-nc"></span></div>
                <div style="margin-top:5px">Ú©Ø¯ Ø¯Ø¹ÙˆØª: <b id="st-cd" style="font-size:1.2rem"></b></div>
            </div>
            <div class="card">
                <input type="text" id="st-pc" class="inp" placeholder="Ù„ÛŒÙ†Ú© Ø¹Ú©Ø³">
                <input type="text" id="st-nn" class="inp" placeholder="Ù†Ø§Ù…">
                <textarea id="st-bi" class="inp" placeholder="Ø¨ÛŒÙˆ"></textarea>
                <input type="text" id="st-ln" class="inp" placeholder="ÙˆØ¨Ø³Ø§ÛŒØª">
                <input type="text" id="st-mn" class="inp" placeholder="Ù…Ù†Ø´Ù†">
                <div class="flex-bw" style="margin-bottom:10px"><span>Ø®ØµÙˆØµÛŒ</span> <input type="checkbox" id="st-pr"></div>
                <div class="flex-bw" style="margin-bottom:20px"><span>Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…</span> <input type="checkbox" id="st-al"></div>
                <button class="btn btn-p" onclick="app.sav(this)">Ø°Ø®ÛŒØ±Ù‡</button>
                <button class="btn btn-o" style="margin-top:10px; color:red; border-color:red" onclick="app.out()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </section>

        <!-- SEARCH -->
        <section id="s-sr" class="con hide">
            <h2>Ù†ØªØ§ÛŒØ¬</h2>
            <button class="btn-s btn-o" onclick="app.nav('hm')">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            <div id="sr-res" style="margin-top:15px"></div>
        </section>

        <div class="nav">
            <div class="n-it active" id="n-hm" onclick="app.nav('hm')">ğŸ </div>
            <div class="n-it" id="n-ad" onclick="app.nav('ad')">â•</div>
            <div class="n-it" id="n-ms" onclick="app.nav('ms')">ğŸ’¬ <span id="b-nv" class="bdg hide"></span></div>
            <div class="n-it" id="n-pr" onclick="app.nav('pr')">ğŸ‘¤</div>
            <div class="n-it" id="n-st" onclick="app.nav('st')">âš™ï¸</div>
        </div>
    </div>

    <!-- MODALS (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) -->
    <div id="m-sh" class="mod-bg hide" onclick="if(event.target==this) this.classList.add('hide')">
        <div class="mod">
            <h3>Ø§Ø´ØªØ±Ø§Ú©</h3>
            <div style="margin-top:20px">
                <button class="btn btn-o" style="margin-bottom:10px" onclick="app.doSh()">ğŸ“¤ Ø¨ÛŒØ±ÙˆÙ†</button>
                <button class="btn btn-o" onclick="app.pkUs()">ğŸ’¬ Ø¯Ø§Ø®Ù„ÛŒ</button>
            </div>
        </div>
    </div>
    <div id="m-pk" class="mod-bg hide" onclick="if(event.target==this) this.classList.add('hide')">
        <div class="mod"><h3>Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡...</h3><input type="text" class="inp" onkeyup="app.flP(this.value)"><div id="pk-ls"></div></div>
    </div>
    <div id="m-ls" class="mod-bg hide" onclick="if(event.target==this) this.classList.add('hide')">
        <div class="mod"><h3 id="ls-tt"></h3><div id="ls-bd" style="margin-top:15px"></div></div>
    </div>
    <div id="m-cm" class="mod-bg hide" onclick="if(event.target==this) this.classList.add('hide')">
        <div class="mod">
            <h3>Ù†Ø¸Ø±Ø§Øª</h3>
            <div id="cm-bd" style="min-height:100px; margin:10px 0;"></div>
            <div class="flex-bw"><input type="text" id="cm-in" class="inp" placeholder="Ù†Ø¸Ø±..." style="width:75%; margin:0"><button class="btn btn-p" style="width:20%" onclick="app.sndC(this)">âœ”</button></div>
        </div>
    </div>
    <div id="sc-ch" class="hide" style="position:fixed; top:0; left:0; right:0; bottom:0; background:var(--bg); z-index:2000; display:flex; flex-direction:column">
        <div class="card" style="margin:0; border-radius:0; border-bottom:1px solid var(--bor); padding:15px; display:flex; align-items:center; gap:10px">
            <button onclick="document.getElementById('sc-ch').classList.add('hide')">â¬…ï¸</button>
            <div style="font-weight:bold" id="ch-hd" onclick="app.nav('pr', app.st.cpid)" style="cursor:pointer"></div>
        </div>
        <div id="ch-bx" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:10px"></div>
        <div style="padding:10px; background:white; display:flex; gap:10px"><input type="text" id="ch-in" class="inp" style="margin:0"><button class="btn btn-p" style="width:50px" onclick="app.sndM()">â¤</button></div>
    </div>

    <script>
        // *** Ù„ÛŒÙ†Ú© Ø¬Ø¯ÛŒØ¯ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯ ***
        const API = 'https://script.google.com/macros/s/AKfycbyf_X4VQfe1YC95wWXkUkFrHAHDOCTmC6qzzsNCp-O57HvGikcAPZWlPAbS_9_kWrYI/exec';

        const app = {
            st: { user:null, users:[], posts:[], msgs:[], vid:null, shr:null, cpid:null, guest:false },
            
            init: function() {
                if(localStorage.getItem('db')) {
                    const db = JSON.parse(localStorage.getItem('db'));
                    this.st.users=db.users; this.st.posts=db.posts; this.st.msgs=db.msgs;
                }
                const uid = localStorage.getItem('uid');
                if(uid) {
                    const u = this.st.users.find(x=>x.id===uid);
                    if(u) { this.st.user=u; this.start(); this.sync(false); }
                    else document.getElementById('scr-auth').classList.remove('hide');
                } else document.getElementById('scr-auth').classList.remove('hide');

                const p = new URLSearchParams(location.search);
                if(p.get('u')) setTimeout(()=>this.nav('pr', p.get('u')), 1500);
                
                // Real-time update via polling
                setInterval(() => { if(!document.getElementById('scr-app').classList.contains('hide')) app.sync(false); }, 5000);
            },

            call: async function(act, pl) {
                try {
                    const res = await fetch(API, {
                        method: 'POST',
                        redirect: "follow",
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action: act, payload: pl })
                    });
                    return await res.json();
                } catch(e) { return {status:'error'}; }
            },

            sync: async function(manual) {
                if(manual) this.msg('Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ...');
                const d = await this.call('getAll', {});
                if(d.status === 'success') {
                    this.st.users=d.users;
                    // Ù‡ÙˆØ´Ù…Ù†Ø¯Ø§Ù†Ù‡ Ù¾Ø³Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ø¢Ù¾Ø¯ÛŒØª Ú©Ù†
                    d.posts.forEach(np => {
                        let op = this.st.posts.find(p=>p.pid===np.pid);
                        if(op) { op.likes=np.likes; op.comments=np.comments; }
                        else this.st.posts.push(np);
                    });
                    this.st.msgs=d.msgs;
                    localStorage.setItem('db', JSON.stringify(d));
                    
                    if(this.st.user && !this.st.guest) {
                        this.st.user = this.st.users.find(u=>u.id===this.st.user.id)||this.st.user;
                        this.bdg();
                        if(!document.getElementById('s-st').classList.contains('hide')) this.sets();
                    }
                    // Ø¢Ù¾Ø¯ÛŒØª ØµÙØ­Ø§Øª Ø¨Ø§Ø²
                    if(!document.getElementById('s-hm').classList.contains('hide')) this.feed();
                    if(!document.getElementById('s-ms').classList.contains('hide')) this.msg('chat');
                    if(!document.getElementById('sc-ch').classList.contains('hide')) this.rnC();
                    
                    if(manual) this.msg('Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
                }
            },

            // AUTH
            togAuth: () => { document.getElementById('f-log').classList.toggle('hide'); document.getElementById('f-reg').classList.toggle('hide'); },
            guest: function() {
                this.st.guest=true;
                this.st.user={id:'guest', name:'Ù…Ù‡Ù…Ø§Ù†', nc:'guest', following:[], followers:[], requests:[], blocked:[], allowMsg:false};
                this.start(); this.msg('Ø­Ø§Ù„Øª Ù…Ù‡Ù…Ø§Ù†');
            },
            login: async function(btn) {
                const nc=document.getElementById('l-nc').value, pass=document.getElementById('l-ps').value;
                if(!nc || !pass) return this.msg('Ù†Ø§Ù‚Øµ');
                btn.classList.add('loading');
                const d = await this.call('login', {nc, pass});
                if(d.status === 'success') {
                    this.st.user = d.user;
                    if(document.getElementById('l-rem').checked) localStorage.setItem('uid', d.user.id);
                    this.start(); this.sync(false);
                } else this.msg(d.msg);
                btn.classList.remove('loading');
            },
            reg: async function(btn) {
                const p = {
                    id:document.getElementById('r-us').value.toLowerCase(), 
                    nc:document.getElementById('r-nc').value,
                    pass:document.getElementById('r-ps').value, 
                    name:document.getElementById('r-nm').value,
                    refCode:document.getElementById('r-rf').value
                };
                if(!p.id || !p.nc || !p.pass || !p.refCode) return this.msg('Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒ');
                btn.classList.add('loading');
                const d = await this.call('register', p);
                if(d.status === 'success') { this.msg('Ø«Ø¨Øª Ø´Ø¯. ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯'); this.togAuth(); }
                else this.msg(d.msg);
                btn.classList.remove('loading');
            },
            out: () => { localStorage.removeItem('uid'); location.reload(); },
            start: function() {
                document.getElementById('scr-auth').classList.add('hide');
                document.getElementById('scr-app').classList.remove('hide');
                if(this.st.guest) ['n-ad','n-ms','n-st'].forEach(i=>document.getElementById(i).style.display='none');
                this.nav('hm');
            },

            // NAVIGATION
            nav: function(p, arg) {
                document.querySelectorAll('section').forEach(s=>s.classList.add('hide'));
                document.querySelectorAll('.n-it').forEach(i=>i.classList.remove('active'));
                
                document.getElementById('sc-ch').classList.add('hide');
                document.getElementById('m-cm').classList.add('hide');

                if(p==='hm') { document.getElementById('s-hm').classList.remove('hide'); document.getElementById('n-hm').classList.add('active'); this.feed(); }
                else if(p==='pr') { 
                    document.getElementById('s-pr').classList.remove('hide'); 
                    if(!arg || (this.st.user && arg===this.st.user.id)) document.getElementById('n-pr').classList.add('active');
                    this.prof(arg||this.st.user.id);
                }
                else if(p==='ad') { document.getElementById('s-ad').classList.remove('hide'); document.getElementById('n-ad').classList.add('active'); }
                else if(p==='ms') { document.getElementById('s-ms').classList.remove('hide'); document.getElementById('n-ms').classList.add('active'); this.msg('chat'); }
                else if(p==='st') { document.getElementById('s-st').classList.remove('hide'); document.getElementById('n-st').classList.add('active'); this.sets(); }
            },

            // FEED & UI
            feed: function() {
                const c = document.getElementById('feed'), nb = document.getElementById('new-bx');
                c.innerHTML=''; nb.innerHTML='';
                
                // Newest Users
                this.st.users.filter(u=>u.id!==this.st.user.id).slice(-5).forEach(u=>{
                    const img = u.pic ? `<img src="${u.pic}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">` : u.name[0];
                    nb.innerHTML += `<div style="min-width:70px;text-align:center;cursor:pointer" onclick="app.nav('pr','${u.id}')">
                        <div style="width:50px;height:50px;border-radius:50%;background:#e2e8f0;margin:auto;display:flex;align-items:center;justify-content:center;overflow:hidden">${img}</div>
                        <div style="font-size:0.7rem;margin-top:4px">${u.name}</div></div>`;
                });
                
                // Uploading Post
                const upBox = document.getElementById('feed-up');
                if(upBox.innerHTML) c.innerHTML = upBox.innerHTML;

                const sh = this.st.posts.filter(p=>{
                    const au = this.st.users.find(u=>u.id===p.uid); if(!au) return false;
                    return !au.isPrivate || this.st.user.following.includes(p.uid) || p.uid===this.st.user.id;
                });
                sh.sort((a,b)=>b.time-a.time).forEach(p=>c.innerHTML+=this.htmlP(p));
            },
            htmlU: (uid) => {
                const u = app.st.users.find(x=>x.id===uid); if(!u) return 'Deleted';
                const i = u.pic ? `<img class="u-img" src="${u.pic}">` : `<div class="u-img" style="display:flex;align-items:center;justify-content:center">${u.name[0]}</div>`;
                return `<div class="u-blk" onclick="event.stopPropagation();app.nav('pr','${u.id}')">${i}<div class="u-in"><div class="u-nm">${u.name}</div><div class="u-id">@${u.id}</div></div></div>`;
            },
            htmlP: (p) => {
                const lk = p.likes.includes(app.st.user.id) ? 'lk' : '';
                return `<div class="card" id="p-${p.pid}"><div class="flex-bw">${app.htmlU(p.uid)} <span style="font-size:0.7rem;background:#e0f2fe;color:#0284c7;padding:2px 8px;border-radius:8px">${p.cat}</span></div>
                    <h4 style="margin-top:10px">${p.title}</h4><p style="margin-top:5px;line-height:1.6;font-size:0.95rem;white-space:pre-wrap">${app.lnk(p.text)}</p>
                    <div class="p-act">
                        <div class="act-b ${lk}" id="lb-${p.pid}" onclick="app.like('${p.pid}')"><span>${lk?'â¤ï¸':'ğŸ¤'}</span> <span id="ln-${p.pid}">${p.likes.length}</span></div>
                        <div class="act-b" onclick="app.comm('${p.pid}')">ğŸ’¬ <span id="cn-${p.pid}">${p.comments.length}</span></div>
                        <div class="act-b" onclick="app.share('post','${p.pid}')">ğŸ”—</div>
                    </div></div>`;
            },

            // ACTIONS
            pub: async function(btn) {
                if(this.st.guest) return this.msg('Ù…Ù‡Ù…Ø§Ù†');
                const p = { pid:this.st.user.id+'_'+Date.now(), uid:this.st.user.id, title:document.getElementById('a-ti').value, cat:document.getElementById('a-ct').value, text:document.getElementById('a-tx').value, time:Date.now() };
                if(!p.title || !p.text) return this.msg('Ø®Ø§Ù„ÛŒ');
                
                btn.style.display='none';
                document.getElementById('p-prg').style.display='block';
                const fill = document.getElementById('p-fil');
                
                setTimeout(()=>fill.style.width='40%', 300);
                setTimeout(()=>fill.style.width='75%', 800);

                const pendingHTML = `<div class="card sending" id="pend-p">
                    <div class="flex-bw">${this.htmlU(this.st.user.id)}</div>
                    <h4>${p.title}</h4><p>${p.text}</p>
                </div>`;
                
                this.nav('hm');
                document.getElementById('feed-up').innerHTML = pendingHTML;

                try {
                    await this.call('createPost', p);
                    fill.style.width='100%';
                    document.getElementById('p-msg').style.display='block';
                    
                    setTimeout(()=>{
                        document.getElementById('a-ti').value=''; document.getElementById('a-tx').value='';
                        document.getElementById('p-prg').style.display='none'; fill.style.width='0%';
                        document.getElementById('p-msg').style.display='none';
                        btn.style.display='block';
                        document.getElementById('feed-up').innerHTML='';
                        
                        this.st.posts.unshift({...p, likes:[], comments:[]});
                        this.feed();
                        this.msg('Ù¾Ø³Øª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ âœ“');
                    }, 1000);
                } catch(e) {
                    btn.style.display='block';
                    this.msg('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„');
                }
            },
            like: function(pid) {
                if(this.st.guest) return this.msg('Ù…Ù‡Ù…Ø§Ù†');
                const p = this.st.posts.find(x=>x.pid===pid);
                const uid = this.st.user.id;
                
                let liked = p.likes.includes(uid);
                if(liked) p.likes = p.likes.filter(x=>x!==uid); else p.likes.push(uid);
                
                const btn = document.getElementById('lb-'+pid);
                const num = document.getElementById('ln-'+pid);
                if(btn) {
                    btn.className = liked ? 'act-b' : 'act-b lk';
                    btn.querySelector('span').innerText = liked ? 'ğŸ¤' : 'â¤ï¸';
                    num.innerText = p.likes.length;
                }
                
                this.call('updatePost', {pid, likes:p.likes, comments:p.comments});
            },
            comm: function(pid) {
                this.st.cpid = pid;
                document.getElementById('m-cm').classList.remove('hide');
                this.rnCm();
            },
            rnCm: function() {
                const p = this.st.posts.find(x=>x.pid===this.st.cpid);
                const c = document.getElementById('cm-bd'); c.innerHTML='';
                if(p.comments.length===0) c.innerHTML='<div style="text-align:center;color:gray">Ø§ÙˆÙ„ÛŒÙ† Ù†Ø¸Ø± Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯</div>';
                p.comments.forEach(m => {
                    const u = this.st.users.find(x=>x.id===m.uid);
                    c.innerHTML += `<div style="background:#f1f5f9;padding:10px;border-radius:10px;margin-top:8px" onclick="app.nav('pr','${m.uid}')"><b>${u?u.name:'?'}</b>: ${app.lnk(m.text)}</div>`;
                });
            },
            sndC: function() {
                if(this.st.guest) return this.msg('Ù…Ù‡Ù…Ø§Ù†');
                const txt = document.getElementById('cm-in').value;
                if(!txt) return;
                
                const p = this.st.posts.find(x=>x.pid===this.st.cpid);
                p.comments.push({uid:this.st.user.id, text:txt});
                
                const c = document.getElementById('cm-bd');
                if(c.innerHTML.includes('Ø§ÙˆÙ„ÛŒÙ†')) c.innerHTML='';
                c.innerHTML += `<div style="background:#f1f5f9;padding:10px;border-radius:10px;margin-top:8px;opacity:0.5"><b>${this.st.user.name}</b>: ${txt} (Ø§Ø±Ø³Ø§Ù„...)</div>`;
                document.getElementById('cm-in').value='';
                c.scrollTop = c.scrollHeight;

                const comCountEl = document.getElementById(`cn-${p.pid}`);
                if(comCountEl) comCountEl.innerText = p.comments.length;

                this.call('updatePost', {pid:p.pid, likes:p.likes, comments:p.comments}).then(()=>{
                    this.rnCm(); 
                });
            },

            // PROFILE
            prof: function(uid) {
                const u = this.st.users.find(x=>x.id===uid);
                const me = this.st.user; this.st.vid = uid; const isMe = uid === me.id;
                document.getElementById('bp-bk').classList.toggle('hide', isMe);
                document.getElementById('p-im').src = u.pic||''; if(!u.pic) document.getElementById('p-im').style.background='#cbd5e1';
                document.getElementById('p-nm').innerText = u.name; document.getElementById('p-id').innerText = '@'+u.id; 
                document.getElementById('p-bi').innerHTML = this.lnk(u.bio);
                
                const lnk = document.getElementById('p-lnk'); lnk.innerHTML='';
                if(u.web) lnk.innerHTML += `<div>ğŸŒ <a href="${u.web}">${u.web}</a></div>`;
                
                const ps = this.st.posts.filter(x=>x.uid===uid);
                document.getElementById('c-pt').innerText=ps.length; document.getElementById('c-fl').innerText=u.followers.length; document.getElementById('c-fi').innerText=u.following.length;
                
                const acts = document.getElementById('p-act');
                if(isMe) acts.classList.add('hide');
                else {
                    acts.classList.remove('hide');
                    const b = document.getElementById('b-fl');
                    if(me.following.includes(uid)) { b.innerText='Ù„ØºÙˆ'; b.className='btn btn-o'; }
                    else if(u.requests.includes(me.id)) { b.innerText='Ø§Ù†ØªØ¸Ø§Ø±'; b.className='btn btn-o'; }
                    else { b.innerText='Ø¯Ù†Ø¨Ø§Ù„'; b.className='btn btn-p'; }
                }
                const acc = isMe || !u.isPrivate || (u.isPrivate && u.followers.includes(me.id));
                document.getElementById('p-con').classList.toggle('hide', !acc);
                document.getElementById('p-lck').classList.toggle('hide', acc);
                if(acc) this.flt('all', document.querySelector('.chip'));
            },
            flt: function(cat, el) {
                document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); el.classList.add('active');
                const c = document.getElementById('p-pts'); c.innerHTML='';
                let p = this.st.posts.filter(x=>x.uid===this.st.vid);
                if(cat!=='all') p = p.filter(x=>x.cat===cat);
                if(p.length===0) c.innerHTML='<p style="text-align:center;padding:20px;color:gray">Ø®Ø§Ù„ÛŒ</p>';
                p.sort((a,b)=>b.time-a.time).forEach(x=>c.innerHTML+=this.htmlP(x));
            },
            fol: function() {
                if(this.st.guest) return this.msg('Ù…Ù‡Ù…Ø§Ù†');
                const uid = this.st.vid; const me = this.st.user; const u = this.st.users.find(x=>x.id===uid);
                let t = 'follow'; if(me.following.includes(uid)) t = 'unfollow';
                if(t==='follow') { if(u.isPrivate) u.requests.push(me.id); else { me.following.push(uid); u.followers.push(me.id); } }
                else { me.following = me.following.filter(x=>x!==uid); u.followers = u.followers.filter(x=>x!==me.id); }
                this.prof(uid);
                this.call('updateUser', [me, u]);
            },

            // MESSAGES & SETTINGS
            msg: function(m) {
                const rb = document.getElementById('msg-bx'); rb.innerHTML='';
                
                if(m==='req') {
                    const reqs = this.st.user.requests;
                    if(reqs.length === 0) rb.innerHTML='<p style="text-align:center">Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</p>';
                    reqs.forEach(rid=>{
                        const u = this.st.users.find(x=>x.id===rid);
                        rb.innerHTML += `<div class="card flex-bw">${this.htmlU(rid)}<div><button class="btn-s btn-p" onclick="app.ans('${rid}',true)">âœ”</button><button class="btn-s btn-o" onclick="app.ans('${rid}',false)">âœ–</button></div></div>`;
                    });
                } else {
                    const ch = [...new Set(this.st.msgs.filter(x=>x.from===this.st.user.id||x.to===this.st.user.id).map(x=>x.from===this.st.user.id?x.to:x.from))];
                    if(ch.length===0) rb.innerHTML='<p style="text-align:center">Ú¯ÙØªÚ¯ÙˆÛŒÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</p>';
                    ch.forEach(pid=>{
                        const u = this.st.users.find(x=>x.id===pid);
                        const last = this.st.msgs.filter(x=>(x.from===this.st.user.id&&x.to===pid)||(x.from===pid&&x.to===this.st.user.id)).pop();
                        const unread = this.st.msgs.filter(x=>x.from===pid && x.to===this.st.user.id && !x.read).length;
                        
                        let tick = '';
                        if(last.from === this.st.user.id) tick = last.read ? '<span class="tik ok">âœ“âœ“</span>' : '<span class="tik wait">âœ“</span>';
                        
                        rb.innerHTML += `<div class="card" onclick="app.chat('${pid}')">
                            <div class="flex-bw">
                                <div class="u-blk"><img class="u-img" src="${u.pic}"> <b>${u.name}</b></div>
                                <small>${new Date(last.time).toLocaleTimeString('fa-IR')}</small>
                            </div>
                            <div class="flex-bw" style="margin-top:5px">
                                <p style="color:gray;font-size:0.9rem;white-space:nowrap;overflow:hidden">${tick} ${last.text}</p>
                                ${unread ? `<span class="bdg" style="position:static">${unread}</span>` : ''}
                            </div>
                        </div>`;
                    });
                }
            },
            ans: function(uid, ac) {
                const me = this.st.user; me.requests = me.requests.filter(x=>x!==uid);
                const u = this.st.users.find(x=>x.id===uid);
                if(ac) { me.followers.push(uid); u.following.push(me.id); }
                this.msg('req'); this.call('updateUser', [me, u]);
            },
            chat: function(uid) {
                if(this.st.guest) return this.msg('Ù…Ù‡Ù…Ø§Ù†');
                const u = this.st.users.find(x=>x.id===uid);
                if(!u.allowMsg && !u.following.includes(this.st.user.id)) return this.msg('Ù¾ÛŒØ§Ù… Ø¨Ø³ØªÙ‡ Ø§Ø³Øª');
                this.st.cpid = uid;
                document.getElementById('sc-ch').classList.remove('hide');
                document.getElementById('ch-hd').innerText = u.name;
                this.rnC();
                
                const unread = this.st.msgs.filter(x=>x.from===uid && x.to===this.st.user.id && !x.read);
                if(unread.length>0) {
                    unread.forEach(m=>m.read=true);
                    this.bdg();
                }
            },
            rnC: function() {
                const b=document.getElementById('ch-bx'); b.innerHTML='';
                const ms = this.st.msgs.filter(x=>(x.from==this.st.user.id&&x.to==this.st.cpid)||(x.from==this.st.cpid&&x.to==this.st.user.id));
                ms.forEach(x=>{ 
                    const mine = x.from===this.st.user.id;
                    const tick = mine ? (x.read ? '<span class="tik ok">âœ“âœ“</span>' : '<span class="tik wait">âœ“</span>') : '';
                    b.innerHTML += `<div style="padding:10px;border-radius:12px;max-width:80%;margin-bottom:5px;${mine?'background:#e0f2fe;align-self:flex-end':'background:white;align-self:flex-start;border:1px solid #ddd'}">
                        ${this.lnk(x.text)}
                        <div style="text-align:${mine?'left':'right'};font-size:0.65rem;color:gray">${tick} ${new Date(x.time).toLocaleTimeString('fa-IR')}</div>
                    </div>`; 
                });
                b.scrollTop=b.scrollHeight;
            },
            sndM: function() {
                const t = document.getElementById('ch-in').value; if(!t) return;
                const m = {from:this.st.user.id, to:this.st.cpid, text:t, time:Date.now(), read:false};
                
                const b = document.getElementById('ch-bx');
                b.innerHTML += `<div style="padding:10px;border-radius:12px;max-width:80%;margin-bottom:5px;background:#e0f2fe;align-self:flex-end;opacity:0.7">
                        ${this.lnk(t)}
                        <div style="text-align:left;font-size:0.65rem;color:gray">ğŸ•‘ ...</div>
                    </div>`;
                b.scrollTop=b.scrollHeight;
                document.getElementById('ch-in').value='';

                this.call('createMsg', m).then(()=>{
                    this.st.msgs.push(m);
                    this.rnC(); 
                });
            },
            sets: function() {
                if(this.st.guest) return document.getElementById('s-st').innerHTML='<p class="card" style="text-align:center">Ù…Ù‡Ù…Ø§Ù†</p>';
                const u=this.st.user;
                document.getElementById('st-nm').innerText=u.name; document.getElementById('st-id').innerText='@'+u.id;
                document.getElementById('st-nc').innerText=u.nc; document.getElementById('st-cd').innerText=u.refCode;
                document.getElementById('st-pc').value=u.pic||''; document.getElementById('st-nn').value=u.name;
                document.getElementById('st-bi').value=u.bio; document.getElementById('st-ln').value=u.web||'';
                document.getElementById('st-mn').value=u.mention||''; document.getElementById('st-pr').checked=u.isPrivate;
                document.getElementById('st-al').checked=u.allowMsg;
            },
            sav: async function(btn) {
                const u=this.st.user;
                u.pic=document.getElementById('st-pc').value; u.name=document.getElementById('st-nn').value;
                u.bio=document.getElementById('st-bi').value; u.web=document.getElementById('st-ln').value;
                u.mention=document.getElementById('st-mn').value; u.isPrivate=document.getElementById('st-pr').checked;
                u.allowMsg=document.getElementById('st-al').checked;
                btn.classList.add('loading'); await this.call('updateUser', u); this.msg('Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯'); btn.classList.remove('loading');
            },
            share: (t, id) => {
                const url = location.origin+location.pathname+(t==='prof'?'?u='+this.st.vid:'?p='+id);
                navigator.clipboard.writeText(url); this.msg('Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯');
            },
            
            // LINK HELPER
            lnk: function(t) {
                if(!t) return '';
                // Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ nc (Ú©Ø¯ Ù…Ù„ÛŒ) Ø¨Ù‡ id Ø§ØµÙ„ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±Ø§ÛŒ Ù„ÛŒÙ†Ú© Ø¯Ù‡ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒØ´ÙˆØ¯
                return t.replace(/@(\w+)/g, (match, id) => {
                    const u = this.st.users.find(x=>x.id===id);
                    if(u) return `<span class="ment" onclick="event.stopPropagation();app.nav('pr','${u.id}')">${match}</span>`;
                    return match;
                });
            },
            
            msg: (t) => { const b=document.getElementById('tst'); b.innerText=t; b.classList.add('show'); setTimeout(()=>b.classList.remove('show'), 3000); },
            bdg: function() {
                const r=this.st.user.requests.length; 
                const u=this.st.msgs.filter(x=>x.to===this.st.user.id&&!x.read).length;
                const b1=document.getElementById('b-nv'); const b2=document.getElementById('b-rq');
                if(r+u>0) { b1.innerText=r+u; b1.classList.remove('hide'); } else b1.classList.add('hide');
                if(b2) { if(r>0) { b2.innerText=r; b2.classList.remove('hide'); } else b2.classList.add('hide'); }
            },
            list: (t) => {
                const u=this.st.users.find(x=>x.id===this.st.vid);
                const l=t==='fol'?u.followers:u.following;
                if(t==='posts') return;
                const b=document.getElementById('ls-bd'); b.innerHTML='';
                l.forEach(id => b.innerHTML+=`<div style="margin-bottom:10px">${app.htmlU(id)}</div>`);
                document.getElementById('ls-tt').innerText=t; document.getElementById('m-ls').classList.remove('hide');
            }
        };
        app.init();
    </script>
</body>
</html>
