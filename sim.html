<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø´Ø¨Ú©Ù‡ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ</title>
    <style>
        :root {
            --primary: #3b82f6; --primary-dark: #2563eb; --bg: #f8fafc; --surface: #ffffff;
            --text: #0f172a; --text-light: #64748b; --border: #e2e8f0; --danger: #ef4444;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.05); --radius: 16px;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; -webkit-tap-highlight-color:transparent; outline:none; }
        body { background:var(--bg); color:var(--text); padding-bottom:85px; overflow-x:hidden; user-select:none; }
        a { text-decoration:none; color:var(--primary); }
        button { border:none; background:none; font-family:inherit; cursor:pointer; }
        .hidden { display:none !important; }
        .container { max-width:550px; margin:0 auto; padding:15px; }
        .flex-between { display:flex; justify-content:space-between; align-items:center; }
        
        /* Modern Elements */
        .card { background:var(--surface); border-radius:var(--radius); padding:16px; margin-bottom:15px; box-shadow:var(--shadow); border:1px solid var(--border); position:relative; overflow:hidden; }
        .inp-mod { width:100%; padding:12px; border:2px solid var(--border); border-radius:12px; font-size:1rem; background:var(--bg); transition:0.3s; margin-bottom:10px; }
        .inp-mod:focus { border-color:var(--primary); background:var(--surface); }
        
        .btn { width:100%; padding:12px; border-radius:12px; font-weight:bold; font-size:1rem; display:flex; justify-content:center; align-items:center; transition:0.2s; gap:8px; }
        .btn:active { transform:scale(0.97); }
        .btn-primary { background:linear-gradient(135deg, var(--primary), var(--primary-dark)); color:white; }
        .btn-outline { border:2px solid var(--border); color:var(--text-light); }
        .btn-sm { padding:6px 12px; font-size:0.85rem; width:auto; }
        .btn-icon { font-size:1.4rem; padding:5px; color:var(--text); }
        
        /* Skeleton Loading (Bone Style) */
        .skeleton { background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .sk-avatar { width:45px; height:45px; border-radius:50%; }
        .sk-line { height:12px; margin-bottom:8px; width:100%; }
        .sk-card { padding:15px; background:white; border-radius:16px; margin-bottom:15px; border:1px solid var(--border); }

        /* Button Loaders */
        .btn-load::after { content:""; width:16px; height:16px; border:2px solid #fff; border-top-color:transparent; border-radius:50%; animation:spin 1s linear infinite; display:block; }
        @keyframes spin { to { transform:rotate(360deg); } }

        /* User Block */
        .u-block { display:flex; align-items:center; gap:10px; cursor:pointer; }
        .u-img { width:45px; height:45px; border-radius:50%; object-fit:cover; background:#cbd5e1; border:2px solid var(--surface); }
        .u-info { line-height:1.2; }
        .u-name { font-weight:700; font-size:0.95rem; }
        .u-id { font-size:0.75rem; color:var(--text-light); }

        /* Nav */
        .nav { position:fixed; bottom:15px; left:50%; transform:translateX(-50%); width:90%; max-width:500px; background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); border-radius:20px; display:flex; justify-content:space-around; padding:10px; box-shadow:0 10px 30px rgba(0,0,0,0.1); border:1px solid rgba(255,255,255,0.5); z-index:900; }
        .nav-item { font-size:1.6rem; padding:8px 12px; border-radius:12px; color:#94a3b8; transition:0.3s; position:relative; }
        .nav-item.active { color:var(--primary); background:#e0f2fe; transform:translateY(-3px); }
        .badge { position:absolute; top:-2px; right:-2px; background:var(--danger); color:white; font-size:0.65rem; padding:2px 6px; border-radius:10px; border:2px solid white; }

        /* Posts */
        .post-act { display:flex; gap:20px; margin-top:15px; border-top:1px solid var(--border); padding-top:10px; color:var(--text-light); }
        .act-btn { display:flex; align-items:center; gap:5px; cursor:pointer; font-size:0.9rem; }
        .act-btn.liked { color:var(--danger); }
        .like-anim { animation: heartPop 0.3s; }
        @keyframes heartPop { 0% { transform:scale(1); } 50% { transform:scale(1.3); } 100% { transform:scale(1); } }

        /* Profile */
        .prof-top { display:flex; align-items:center; gap:15px; margin-bottom:15px; }
        .prof-pic { width:85px; height:85px; border-radius:50%; border:3px solid white; box-shadow:0 5px 15px rgba(0,0,0,0.1); object-fit:cover; }
        .prof-stats { flex:1; display:flex; justify-content:space-around; text-align:center; }
        .stat-n { font-weight:800; font-size:1.1rem; display:block; }
        .stat-l { font-size:0.75rem; color:var(--text-light); }
        .chips { display:flex; gap:8px; overflow-x:auto; padding:5px 0 15px; scrollbar-width:none; }
        .chip { padding:6px 14px; border-radius:20px; background:var(--surface); border:1px solid var(--border); white-space:nowrap; font-size:0.85rem; transition:0.2s; cursor:pointer; }
        .chip.active { background:var(--text); color:white; border-color:var(--text); }

        /* Modals */
        .modal-bg { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; display:flex; align-items:flex-end; justify-content:center; }
        .modal { background:var(--surface); width:100%; max-width:550px; border-radius:25px 25px 0 0; padding:20px; max-height:85vh; overflow-y:auto; animation:slideUp 0.3s; }
        @keyframes slideUp { from { transform:translateY(100%); } to { transform:translateY(0); } }
        
        /* Comments */
        .comm-item { background:#f1f5f9; padding:10px; border-radius:10px; margin-top:8px; font-size:0.9rem; }
        .comm-anim { animation:fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }

        /* New Members Scroll */
        .nm-scroll { display:flex; gap:12px; overflow-x:auto; padding-bottom:10px; scrollbar-width:none; }
        .nm-card { min-width:80px; text-align:center; }

        /* Toast */
        #toast { position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#1e293b; color:white; padding:10px 20px; border-radius:10px; z-index:2000; font-size:0.9rem; opacity:0; pointer-events:none; transition:0.3s; }
        #toast.show { opacity:1; top:30px; }
    </style>
</head>
<body>

    <div id="toast">Ù¾ÛŒØ§Ù… Ø³ÛŒØ³ØªÙ…</div>

    <!-- AUTH SECTION -->
    <div id="auth-box" class="container" style="height:100vh; display:flex; flex-direction:column; justify-content:center;">
        <h1 style="text-align:center; color:var(--primary); margin-bottom:30px; font-size:2rem;">ğŸŒ€ Ø³ÙˆØ´ÛŒØ§Ù„</h1>
        
        <!-- Login -->
        <div id="f-login">
            <div class="card">
                <h2 style="margin-bottom:20px; text-align:center;">ÙˆØ±ÙˆØ¯</h2>
                <input type="number" id="l-nc" class="inp-mod" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ">
                <input type="password" id="l-pass" class="inp-mod" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
                <div class="flex-between" style="margin-bottom:15px; font-size:0.9rem;">
                    <label><input type="checkbox" id="l-rem" checked> Ù…Ø±Ø§ Ø¨Ø®Ø§Ø·Ø± Ø¨Ø³Ù¾Ø§Ø±</label>
                </div>
                <button class="btn btn-primary" onclick="app.login(this)">ÙˆØ±ÙˆØ¯</button>
                <button class="btn btn-outline" style="margin-top:10px" onclick="app.guest()">ÙˆØ±ÙˆØ¯ Ù…Ù‡Ù…Ø§Ù†</button>
            </div>
            <p style="text-align:center; color:var(--primary); cursor:pointer" onclick="app.togAuth()">Ø«Ø¨Øª Ù†Ø§Ù… Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÛŒØ¯</p>
        </div>

        <!-- Register -->
        <div id="f-reg" class="hidden">
            <div class="card">
                <h2 style="margin-bottom:20px; text-align:center;">Ø«Ø¨Øª Ù†Ø§Ù…</h2>
                <input type="number" id="r-nc" class="inp-mod" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ (Û±Û° Ø±Ù‚Ù…)">
                <input type="text" id="r-name" class="inp-mod" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ">
                <input type="text" id="r-user" class="inp-mod" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ (Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)">
                <input type="number" id="r-ref" class="inp-mod" placeholder="Ú©Ø¯ Ù…Ø¹Ø±Ù (Ø§Ù„Ø²Ø§Ù…ÛŒ)">
                <input type="password" id="r-pass" class="inp-mod" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
                <button class="btn btn-primary" style="background:var(--success)" onclick="app.reg(this)">Ø«Ø¨Øª Ù†Ø§Ù…</button>
            </div>
            <p style="text-align:center; color:var(--text-light); cursor:pointer" onclick="app.togAuth()">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ÙˆØ±ÙˆØ¯</p>
        </div>
    </div>

    <!-- APP SECTION -->
    <div id="app-box" class="hidden">
        
        <!-- 1. HOME -->
        <section id="s-home" class="container">
            <div class="flex-between" style="margin-bottom:15px">
                <h2>Ø®Ø§Ù†Ù‡</h2>
                <button class="btn-icon" onclick="app.sync(true)">ğŸ”„</button>
            </div>
            <input type="text" class="inp-mod" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø´Ø¨Ú©Ù‡..." onkeyup="if(event.key==='Enter') app.search(this.value)" style="border-radius:20px; padding:10px 15px;">
            
            <div style="margin-bottom:20px">
                <h4 style="margin-bottom:10px; font-size:0.9rem; color:var(--text-light)">Ø§Ø¹Ø¶Ø§ÛŒ Ø¬Ø¯ÛŒØ¯</h4>
                <div id="new-mem" class="nm-scroll"></div>
            </div>

            <div id="feed"></div>
        </section>

        <!-- 2. PROFILE -->
        <section id="s-prof" class="container hidden">
            <div class="card">
                <div class="flex-between" style="margin-bottom:15px">
                    <button class="btn-icon" id="bp-back" onclick="app.nav('home')">â¬…ï¸</button>
                    <h3 id="p-head"></h3>
                    <button class="btn-icon" onclick="document.getElementById('p-menu').classList.toggle('hidden')">â‹®</button>
                    <div id="p-menu" class="card hidden" style="position:absolute; top:40px; left:10px; width:150px; z-index:10; padding:5px;">
                        <div style="padding:10px; cursor:pointer" onclick="app.share('prof')">ğŸ”— Ø§Ø´ØªØ±Ø§Ú©</div>
                        <div style="padding:10px; color:red; cursor:pointer" onclick="app.block()">ğŸš« Ù…Ø³Ø¯ÙˆØ¯</div>
                    </div>
                </div>

                <div class="prof-top">
                    <img id="p-pic" class="prof-pic" src="">
                    <div class="prof-stats">
                        <div onclick="app.showList('posts')"><span class="stat-n" id="c-post">0</span><span class="stat-l">Ù¾Ø³Øª</span></div>
                        <div onclick="app.showList('followers')"><span class="stat-n" id="c-fol">0</span><span class="stat-l">Ø¯Ù†Ø¨Ø§Ù„â€ŒÚ©Ù†Ù†Ø¯Ù‡</span></div>
                        <div onclick="app.showList('following')"><span class="stat-n" id="c-fing">0</span><span class="stat-l">Ø¯Ù†Ø¨Ø§Ù„â€ŒØ´ÙˆÙ†Ø¯Ù‡</span></div>
                    </div>
                </div>

                <h3 id="p-name"></h3>
                <div style="color:var(--text-light); font-size:0.9rem; margin-bottom:5px">@<span id="p-id"></span></div>
                <p id="p-bio" style="font-size:0.9rem; line-height:1.5"></p>
                <div id="p-links" style="margin-top:5px; font-size:0.9rem;"></div>

                <div class="flex-between" id="p-acts" style="margin-top:15px; gap:10px">
                    <button id="btn-f" class="btn btn-primary" onclick="app.follow()">Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù†</button>
                    <button id="btn-m" class="btn btn-outline" onclick="app.chat(app.st.vid)">Ù¾ÛŒØ§Ù…</button>
                </div>
            </div>

            <div id="p-cont">
                <div class="chips">
                    <span class="chip active" onclick="app.filt('all',this)">Ù‡Ù…Ù‡</span>
                    <span class="chip" onclick="app.filt('book',this)">Ú©ØªØ§Ø¨</span>
                    <span class="chip" onclick="app.filt('movie',this)">ÙÛŒÙ„Ù…</span>
                    <span class="chip" onclick="app.filt('site',this)">Ø³Ø§ÛŒØª</span>
                </div>
                <div id="p-posts"></div>
            </div>
            
            <div id="p-lock" class="card hidden" style="text-align:center; padding:40px;">
                <div style="font-size:3rem">ğŸ”’</div>
                <p>ØµÙØ­Ù‡ Ø®ØµÙˆØµÛŒ</p>
            </div>
        </section>

        <!-- 3. ADD -->
        <section id="s-add" class="container hidden">
            <h2 style="margin-bottom:15px">Ù¾Ø³Øª Ø¬Ø¯ÛŒØ¯</h2>
            <div class="card">
                <input type="text" id="a-tit" class="inp-mod" placeholder="Ø¹Ù†ÙˆØ§Ù†">
                <select id="a-cat" class="inp-mod">
                    <option value="book">Ú©ØªØ§Ø¨</option>
                    <option value="movie">ÙÛŒÙ„Ù…</option>
                    <option value="site">Ø³Ø§ÛŒØª</option>
                </select>
                <textarea id="a-txt" class="inp-mod" rows="6" placeholder="Ù…ØªÙ† Ù¾Ø³Øª..."></textarea>
                <button class="btn btn-primary" onclick="app.post(this)">Ø§Ø±Ø³Ø§Ù„ Ù¾Ø³Øª</button>
            </div>
        </section>

        <!-- 4. MSG -->
        <section id="s-msg" class="container hidden">
            <div class="flex-between" style="margin-bottom:15px">
                <h2>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§</h2>
                <div style="display:flex; gap:5px">
                    <span class="chip active" onclick="app.msgs('chat')">Ú¯ÙØªÚ¯Ùˆ</span>
                    <span class="chip" onclick="app.msgs('req')">Ø¯Ø±Ø®ÙˆØ§Ø³Øª <span id="b-req" class="badge hidden"></span></span>
                </div>
            </div>
            <div id="msg-box"></div>
        </section>

        <!-- 5. SET -->
        <section id="s-set" class="container hidden">
            <h2>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h2>
            <div class="card" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color:white; margin-top:15px;">
                <div class="flex-between"><h3 id="set-dn"></h3> <small id="set-did"></small></div>
                <div style="margin-top:10px">Ú©Ø¯ Ù…Ù„ÛŒ: <span id="set-dnc"></span></div>
                <div style="margin-top:5px; font-weight:bold">Ú©Ø¯ Ø¯Ø¹ÙˆØª: <span id="set-dc" style="font-size:1.2rem"></span></div>
            </div>
            <div class="card">
                <input type="text" id="set-pic" class="inp-mod" placeholder="Ù„ÛŒÙ†Ú© Ø¹Ú©Ø³">
                <input type="text" id="set-n" class="inp-mod" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ">
                <textarea id="set-b" class="inp-mod" placeholder="Ø¨ÛŒÙˆÚ¯Ø±Ø§ÙÛŒ"></textarea>
                <input type="text" id="set-l" class="inp-mod" placeholder="ÙˆØ¨Ø³Ø§ÛŒØª">
                <input type="text" id="set-m" class="inp-mod" placeholder="Ù…Ù†Ø´Ù† (@id)">
                <div class="flex-between" style="margin-bottom:10px"><span>Ø­Ø³Ø§Ø¨ Ø®ØµÙˆØµÛŒ</span> <input type="checkbox" id="set-pr"></div>
                <div class="flex-between" style="margin-bottom:20px"><span>Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…</span> <input type="checkbox" id="set-al"></div>
                <button class="btn btn-primary" onclick="app.save(this)">Ø°Ø®ÛŒØ±Ù‡</button>
                <button class="btn btn-outline" style="margin-top:10px; color:red; border-color:red" onclick="app.out()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </section>

        <!-- SEARCH -->
        <section id="s-srch" class="container hidden">
            <h2>Ù†ØªØ§ÛŒØ¬</h2>
            <button class="btn-sm btn-outline" onclick="app.nav('home')">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            <div id="srch-res" style="margin-top:15px"></div>
        </section>

        <!-- NAV -->
        <div class="nav">
            <div class="nav-item active" id="ni-home" onclick="app.nav('home')">ğŸ </div>
            <div class="nav-item" id="ni-add" onclick="app.nav('add')">â•</div>
            <div class="nav-item" id="ni-msg" onclick="app.nav('msg')">ğŸ’¬ <span id="b-nav" class="badge hidden"></span></div>
            <div class="nav-item" id="ni-prof" onclick="app.nav('prof')">ğŸ‘¤</div>
            <div class="nav-item" id="ni-set" onclick="app.nav('set')">âš™ï¸</div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="m-share" class="modal-bg hidden" onclick="if(event.target==this) this.classList.add('hidden')">
        <div class="modal">
            <h3>Ø§Ø´ØªØ±Ø§Ú©</h3>
            <div style="margin-top:20px">
                <button class="btn btn-outline" style="margin-bottom:10px" onclick="app.doShare()">ğŸ“¤ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±</button>
                <button class="btn btn-outline" onclick="app.pickUser()">ğŸ’¬ Ù…Ø®Ø§Ø·Ø¨ÛŒÙ† Ø¯Ø§Ø®Ù„ÛŒ</button>
            </div>
        </div>
    </div>
    
    <div id="m-pick" class="modal-bg hidden" onclick="if(event.target==this) this.classList.add('hidden')">
        <div class="modal">
            <h3>Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡...</h3>
            <input type="text" class="inp-mod" placeholder="Ø¬Ø³ØªØ¬Ùˆ..." onkeyup="app.filterP(this.value)">
            <div id="pick-list" style="margin-top:10px"></div>
        </div>
    </div>

    <div id="m-list" class="modal-bg hidden" onclick="if(event.target==this) this.classList.add('hidden')">
        <div class="modal"><h3 id="lst-tit"></h3><div id="lst-bod" style="margin-top:15px"></div></div>
    </div>

    <div id="m-comm" class="modal-bg hidden" onclick="if(event.target==this) this.classList.add('hidden')">
        <div class="modal">
            <h3>Ù†Ø¸Ø±Ø§Øª</h3>
            <div id="comm-bod" style="min-height:100px; margin:10px 0;"></div>
            <div class="flex-between">
                <input type="text" id="comm-in" class="inp-mod" placeholder="Ù†Ø¸Ø±..." style="width:75%">
                <button class="btn btn-primary" style="width:20%" onclick="app.sendC(this)">âœ”</button>
            </div>
        </div>
    </div>

    <div id="scr-chat" class="hidden" style="position:fixed; top:0; left:0; right:0; bottom:0; background:var(--bg); z-index:2000; display:flex; flex-direction:column">
        <div class="card" style="margin:0; border-radius:0; border-bottom:1px solid var(--border); padding:15px; display:flex; align-items:center; gap:10px">
            <button onclick="document.getElementById('scr-chat').classList.add('hidden')">â¬…ï¸</button>
            <div style="font-weight:bold" id="c-head"></div>
        </div>
        <div id="c-box" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:10px"></div>
        <div style="padding:10px; background:white; display:flex; gap:10px">
            <input type="text" id="c-in" class="inp-mod" placeholder="Ù¾ÛŒØ§Ù…...">
            <button class="btn btn-primary" style="width:50px" onclick="app.sendM()">â¤</button>
        </div>
    </div>

    <script>
        // *** Ø¢Ø¯Ø±Ø³ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯ ***
        const API = 'https://script.google.com/macros/s/AKfycbxrM04t-xMe1vKeVHDIRqxjD0emHq-hNgIln92CQSjRiJSS_Mp053MNY-kUzrAizyI/exec';

        const app = {
            st: { user:null, users:[], posts:[], msgs:[], vid:null, shr:null, cpid:null, guest:false },
            
            init: async function() {
                // Load Cache
                if(localStorage.getItem('db')) {
                    const db = JSON.parse(localStorage.getItem('db'));
                    this.st.users = db.users || [];
                    this.st.posts = db.posts || [];
                    this.st.msgs = db.msgs || [];
                }
                
                // Login Check
                const uid = localStorage.getItem('uid');
                if(uid) {
                    // Try finding in cache first
                    const u = this.st.users.find(x=>x.id===uid);
                    if(u) {
                        this.st.user = u;
                        this.start();
                    } else {
                        // If not in cache (first load or cleared), show auth but fetch bg
                        document.getElementById('auth-box').classList.remove('hidden');
                    }
                } else {
                    document.getElementById('auth-box').classList.remove('hidden');
                }
                // Background Sync
                this.sync(false);

                // Deep Link
                const p = new URLSearchParams(location.search);
                if(p.get('u')) setTimeout(()=>this.nav('prof', p.get('u')), 1500);
            },

            sync: async function(manual) {
                if(manual) this.toast('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ...');
                try {
                    const res = await fetch(API);
                    const d = await res.json();
                    this.st.users = d.users;
                    this.st.posts = d.posts;
                    this.st.msgs = d.msgs;
                    localStorage.setItem('db', JSON.stringify(d));
                    
                    if(this.st.user && !this.st.guest) {
                        this.st.user = this.st.users.find(u=>u.id===this.st.user.id);
                        this.badge();
                    }
                    if(!document.getElementById('s-home').classList.contains('hidden')) this.feed();
                } catch(e) { if(manual) this.toast('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„'); }
            },

            // --- AUTH ---
            togAuth: () => {
                document.getElementById('f-login').classList.toggle('hidden');
                document.getElementById('f-reg').classList.toggle('hidden');
            },
            guest: function() {
                this.st.guest = true;
                this.st.user = { id:'guest', name:'Ù…Ù‡Ù…Ø§Ù†', following:[], followers:[], requests:[], blocked:[], allowMsg:false };
                this.start();
                this.toast('Ø­Ø§Ù„Øª Ù…Ù‡Ù…Ø§Ù†');
            },
            login: async function(btn) {
                const nc = document.getElementById('l-nc').value;
                const pass = document.getElementById('l-pass').value;
                if(!nc || !pass) return this.toast('Ù†Ø§Ù‚Øµ');
                
                btn.classList.add('btn-load');
                try {
                    const res = await fetch(API, { 
                        method:'POST', 
                        body:JSON.stringify({ action:'login', payload:{nc, pass} }) 
                    });
                    const d = await res.json();
                    if(d.status === 'success') {
                        this.st.user = d.user;
                        if(document.getElementById('l-rem').checked) localStorage.setItem('uid', d.user.id);
                        this.start();
                    } else this.toast(d.msg);
                } catch(e) { this.toast('Ø®Ø·Ø§ Ø§ØªØµØ§Ù„'); }
                btn.classList.remove('btn-load');
            },
            reg: async function(btn) {
                const p = {
                    id: document.getElementById('r-user').value.toLowerCase(),
                    nc: document.getElementById('r-nc').value,
                    pass: document.getElementById('r-pass').value,
                    name: document.getElementById('r-name').value,
                    refCode: document.getElementById('r-ref').value
                };
                if(!p.id || !p.nc || !p.pass || !p.refCode) return this.toast('Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒ');
                
                btn.classList.add('btn-load');
                try {
                    const res = await fetch(API, { 
                        method:'POST', 
                        body:JSON.stringify({ action:'register', payload:p }) 
                    });
                    const d = await res.json();
                    if(d.status === 'success') {
                        this.toast('Ø«Ø¨Øª Ø´Ø¯. ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯');
                        this.togAuth();
                    } else this.toast(d.msg || 'Ø®Ø·Ø§');
                } catch(e) { this.toast('Ø®Ø·Ø§'); }
                btn.classList.remove('btn-load');
            },
            out: () => { localStorage.removeItem('uid'); location.reload(); },
            start: function() {
                document.getElementById('auth-box').classList.add('hidden');
                document.getElementById('app-box').classList.remove('hidden');
                if(this.st.guest) ['ni-add','ni-msg','ni-set'].forEach(i=>document.getElementById(i).style.display='none');
                this.nav('home');
            },

            // --- NAV ---
            nav: function(p, arg) {
                document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
                document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
                
                if(p==='home') {
                    document.getElementById('s-home').classList.remove('hidden');
                    document.getElementById('ni-home').classList.add('active');
                    this.feed();
                } else if(p==='prof') {
                    document.getElementById('s-prof').classList.remove('hidden');
                    if(!arg || (this.st.user && arg===this.st.user.id)) document.getElementById('ni-prof').classList.add('active');
                    this.prof(arg || this.st.user.id);
                } else if(p==='add') {
                    document.getElementById('s-add').classList.remove('hidden');
                    document.getElementById('ni-add').classList.add('active');
                } else if(p==='msg') {
                    document.getElementById('s-msg').classList.remove('hidden');
                    document.getElementById('ni-msg').classList.add('active');
                    this.msgs('chat');
                } else if(p==='set') {
                    document.getElementById('s-set').classList.remove('hidden');
                    document.getElementById('ni-set').classList.add('active');
                    this.sets();
                }
            },

            // --- FEED ---
            feed: function() {
                const c = document.getElementById('feed');
                const nm = document.getElementById('new-mem');
                
                // New Members
                nm.innerHTML = '';
                this.st.users.filter(u=>u.id!==this.st.user.id).slice(-5).forEach(u=>{
                    const img = u.pic ? `<img src="${u.pic}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">` : u.name[0];
                    nm.innerHTML += `<div class="nm-card" onclick="app.nav('prof','${u.id}')"><div style="width:50px;height:50px;border-radius:50%;background:#e2e8f0;margin:auto;display:flex;align-items:center;justify-content:center;overflow:hidden">${img}</div><div style="font-size:0.7rem;margin-top:4px">${u.name}</div></div>`;
                });

                c.innerHTML = '';
                if(this.st.posts.length===0) return c.innerHTML = this.skel();
                
                const show = this.st.posts.filter(p => {
                    const au = this.st.users.find(u=>u.id===p.uid);
                    if(!au) return false;
                    return !au.isPrivate || this.st.user.following.includes(p.uid) || p.uid === this.st.user.id;
                });
                
                show.sort((a,b)=>b.time-a.time).forEach(p => c.innerHTML += this.htmlP(p));
            },
            skel: () => `<div class="sk-card"><div class="flex-between"><div class="sk-avatar skeleton"></div><div style="width:75%"><div class="sk-line skeleton"></div><div class="sk-line skeleton" style="width:50%"></div></div></div><div class="sk-line skeleton" style="height:100px;margin-top:10px"></div></div>`,
            htmlU: (uid) => {
                const u = app.st.users.find(x=>x.id===uid); if(!u) return 'Unk';
                const i = u.pic ? `<img class="u-img" src="${u.pic}">` : `<div class="u-img flex-center">${u.name[0]}</div>`;
                return `<div class="u-block" onclick="event.stopPropagation();app.nav('prof','${u.id}')">${i}<div class="u-info"><div class="u-name">${u.name}</div></div></div>`;
            },
            htmlP: (p) => {
                const lk = p.likes.includes(app.st.user.id) ? 'liked' : '';
                return `<div class="card">
                    <div class="flex-between">${app.htmlU(p.uid)} <span style="font-size:0.7rem;background:#e0f2fe;color:#0284c7;padding:2px 8px;border-radius:8px">${p.cat}</span></div>
                    <h4 style="margin-top:10px">${p.title}</h4>
                    <p style="margin-top:5px;line-height:1.6;font-size:0.95rem">${p.text}</p>
                    <div class="post-act">
                        <div class="act-btn ${lk}" onclick="app.like('${p.pid}')"><span>${lk?'â¤ï¸':'ğŸ¤'}</span> ${p.likes.length}</div>
                        <div class="act-btn" onclick="app.comm('${p.pid}')">ğŸ’¬ ${p.comments.length}</div>
                        <div class="act-btn" onclick="app.share('post','${p.pid}')">ğŸ”—</div>
                    </div>
                </div>`;
            },

            // --- ACTS ---
            post: async function(btn) {
                if(this.st.guest) return this.toast('Ù…Ù‡Ù…Ø§Ù†');
                const p = {
                    pid: this.st.user.id+'_'+Date.now(), uid: this.st.user.id,
                    title: document.getElementById('a-tit').value,
                    cat: document.getElementById('a-cat').value,
                    text: document.getElementById('a-txt').value,
                    time: Date.now()
                };
                if(!p.title || !p.text) return this.toast('Ø®Ø§Ù„ÛŒ');
                
                btn.classList.add('btn-load');
                this.st.posts.unshift({...p, likes:[], comments:[]}); // Optimistic
                await fetch(API, {method:'POST', body:JSON.stringify({action:'createPost', payload:p})});
                btn.classList.remove('btn-load');
                this.nav('home');
            },
            like: function(pid) {
                if(this.st.guest) return this.toast('Ù…Ù‡Ù…Ø§Ù†');
                const p = this.st.posts.find(x=>x.pid===pid);
                const uid = this.st.user.id;
                if(p.likes.includes(uid)) p.likes = p.likes.filter(x=>x!==uid);
                else p.likes.push(uid);
                this.feed(); // Re-render
                fetch(API, {method:'POST', body:JSON.stringify({action:'updatePost', payload:{pid, likes:p.likes, comments:p.comments}})});
            },
            comm: function(pid) {
                this.st.cpid = pid;
                const p = this.st.posts.find(x=>x.pid===pid);
                const b = document.getElementById('comm-bod');
                b.innerHTML = p.comments.length ? '' : '<p style="text-align:center;color:gray">Ø¨Ø¯ÙˆÙ† Ù†Ø¸Ø±</p>';
                p.comments.forEach(c => {
                    const u = this.st.users.find(x=>x.id===c.uid);
                    b.innerHTML += `<div class="comm-item comm-anim"><b>${u?u.name:'?'}</b>: ${c.text}</div>`;
                });
                document.getElementById('m-comm').classList.remove('hidden');
            },
            sendC: function(btn) {
                if(this.st.guest) return this.toast('Ù…Ù‡Ù…Ø§Ù†');
                const txt = document.getElementById('comm-in').value;
                if(!txt) return;
                const p = this.st.posts.find(x=>x.pid===this.st.cpid);
                p.comments.push({uid:this.st.user.id, text:txt});
                this.comm(this.st.cpid);
                document.getElementById('comm-in').value = '';
                btn.classList.add('btn-load');
                fetch(API, {method:'POST', body:JSON.stringify({action:'updatePost', payload:{pid:p.pid, likes:p.likes, comments:p.comments}})}).then(()=>btn.classList.remove('btn-load'));
            },

            // --- PROF ---
            prof: function(uid) {
                const u = this.st.users.find(x=>x.id===uid);
                const me = this.st.user;
                this.st.vid = uid;
                const isMe = uid === me.id;

                document.getElementById('bp-back').classList.toggle('hidden', isMe);
                document.getElementById('p-pic').src = u.pic || ''; 
                if(!u.pic) document.getElementById('p-pic').style.background='#cbd5e1';
                document.getElementById('p-name').innerText = u.name;
                document.getElementById('p-id').innerText = u.id;
                document.getElementById('p-bio').innerText = u.bio;
                
                const lnk = document.getElementById('p-links'); lnk.innerHTML='';
                if(u.web) lnk.innerHTML += `<div>ğŸŒ <a href="${u.web}" target="_blank">${u.web}</a></div>`;
                if(u.mention) lnk.innerHTML += `<div>ğŸ“£ <a href="#" onclick="app.nav('prof','${u.mention}')">@${u.mention}</a></div>`;

                const posts = this.st.posts.filter(x=>x.uid===uid);
                document.getElementById('c-post').innerText = posts.length;
                document.getElementById('c-fol').innerText = u.followers.length;
                document.getElementById('c-fing').innerText = u.following.length;

                const acts = document.getElementById('p-acts');
                if(isMe) acts.classList.add('hidden');
                else {
                    acts.classList.remove('hidden');
                    const b = document.getElementById('btn-f');
                    if(me.following.includes(uid)) { b.innerText='Ù„ØºÙˆ Ø¯Ù†Ø¨Ø§Ù„'; b.className='btn btn-outline'; }
                    else if(u.requests.includes(me.id)) { b.innerText='Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±'; b.className='btn btn-outline'; }
                    else { b.innerText='Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù†'; b.className='btn btn-primary'; }
                }

                const acc = isMe || !u.isPrivate || (u.isPrivate && u.followers.includes(me.id));
                document.getElementById('p-cont').classList.toggle('hidden', !acc);
                document.getElementById('p-lock').classList.toggle('hidden', acc);
                if(acc) this.filt('all', document.querySelector('.chip'));
            },
            filt: function(cat, el) {
                document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
                el.classList.add('active');
                const c = document.getElementById('p-posts'); c.innerHTML='';
                let p = this.st.posts.filter(x=>x.uid===this.st.vid);
                if(cat!=='all') p = p.filter(x=>x.cat===cat);
                if(p.length===0) c.innerHTML='<p style="text-align:center;padding:20px;color:gray">Ø®Ø§Ù„ÛŒ</p>';
                p.sort((a,b)=>b.time-a.time).forEach(x=>c.innerHTML+=this.htmlP(x));
            },
            follow: function() {
                if(this.st.guest) return this.toast('Ù…Ù‡Ù…Ø§Ù†');
                const uid = this.st.vid;
                const me = this.st.user;
                const u = this.st.users.find(x=>x.id===uid);
                
                if(me.following.includes(uid)) {
                    me.following = me.following.filter(x=>x!==uid);
                    u.followers = u.followers.filter(x=>x!==me.id);
                } else {
                    if(u.isPrivate) u.requests.push(me.id);
                    else { me.following.push(uid); u.followers.push(me.id); }
                }
                this.prof(uid);
                fetch(API, {method:'POST', body:JSON.stringify({action:'updateUser', payload:[me, u]})});
            },

            // --- MSG ---
            msgs: function(mode) {
                const c = document.getElementById('msg-box'); c.innerHTML='';
                if(this.st.guest) return c.innerHTML='<p style="text-align:center">Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</p>';
                const me = this.st.user;

                if(mode==='req') {
                    if(me.requests.length===0) c.innerHTML='<p style="text-align:center">Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ Ù†ÛŒØ³Øª</p>';
                    me.requests.forEach(rid=>{
                        c.innerHTML += `<div class="card flex-between">${this.htmlU(rid)}<div><button class="btn-sm btn-primary" onclick="app.ansReq('${rid}',true)">âœ”</button><button class="btn-sm btn-outline" onclick="app.ansReq('${rid}',false)">âœ–</button></div></div>`;
                    });
                } else {
                    const chats = [...new Set(this.st.msgs.filter(m=>m.from===me.id||m.to===me.id).map(m=>m.from===me.id?m.to:m.from))];
                    if(chats.length===0) c.innerHTML='<p style="text-align:center">Ú¯ÙØªÚ¯ÙˆÛŒÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</p>';
                    chats.forEach(pid=>{
                        const last = this.st.msgs.filter(m=>(m.from===me.id&&m.to===pid)||(m.from===pid&&m.to===me.id)).pop();
                        c.innerHTML += `<div class="card" onclick="app.chat('${pid}')"><div class="flex-between">${this.htmlU(pid)}<small>${new Date(last.time).toLocaleTimeString('fa-IR')}</small></div><p style="margin-top:5px;color:gray;font-size:0.9rem">${last.text}</p></div>`;
                    });
                }
            },
            ansReq: function(uid, acc) {
                const me = this.st.user;
                const u = this.st.users.find(x=>x.id===uid);
                me.requests = me.requests.filter(x=>x!==uid);
                if(acc) { me.followers.push(uid); u.following.push(me.id); }
                this.msgs('req');
                fetch(API, {method:'POST', body:JSON.stringify({action:'updateUser', payload:[me, u]})});
            },
            chat: function(uid) {
                if(this.st.guest) return this.toast('Ù…Ù‡Ù…Ø§Ù†');
                const u = this.st.users.find(x=>x.id===uid);
                if(!u.allowMsg && !u.following.includes(this.st.user.id)) return this.toast('Ù¾ÛŒØ§Ù… Ø¨Ø³ØªÙ‡ Ø§Ø³Øª');
                this.st.cpid = uid;
                document.getElementById('scr-chat').classList.remove('hidden');
                document.getElementById('c-head').innerText = u.name;
                this.renC();
            },
            renC: function() {
                const b = document.getElementById('c-box'); b.innerHTML='';
                const ms = this.st.msgs.filter(m=>(m.from==this.st.user.id&&m.to==this.st.cpid)||(m.from==this.st.cpid&&m.to==this.st.user.id));
                ms.forEach(m=>{
                    const cls = m.from===this.st.user.id ? 'background:#e0f2fe;align-self:flex-end' : 'background:white;align-self:flex-start;border:1px solid #ddd';
                    b.innerHTML += `<div style="padding:10px;border-radius:12px;max-width:80%;${cls}">${m.text}</div>`;
                });
                b.scrollTop = b.scrollHeight;
            },
            sendM: function() {
                const t = document.getElementById('c-in').value;
                if(!t) return;
                const m = {from:this.st.user.id, to:this.st.cpid, text:t, time:Date.now(), read:false};
                this.st.msgs.push(m);
                this.renC();
                document.getElementById('c-in').value='';
                fetch(API, {method:'POST', body:JSON.stringify({action:'createMsg', payload:m})});
            },

            // --- SETS ---
            sets: function() {
                if(this.st.guest) return document.getElementById('s-set').innerHTML='<p class="card" style="text-align:center">Ù…Ù‡Ù…Ø§Ù†</p>';
                const u = this.st.user;
                document.getElementById('set-dn').innerText = u.name;
                document.getElementById('set-did').innerText = '@'+u.id;
                document.getElementById('set-dnc').innerText = u.nc;
                document.getElementById('set-dc').innerText = u.refCode;
                
                document.getElementById('set-pic').value = u.pic||'';
                document.getElementById('set-n').value = u.name;
                document.getElementById('set-b').value = u.bio;
                document.getElementById('set-l').value = u.web||'';
                document.getElementById('set-m').value = u.mention||'';
                document.getElementById('set-pr').checked = u.isPrivate;
                document.getElementById('set-al').checked = u.allowMsg;
            },
            save: async function(btn) {
                const u = this.st.user;
                u.pic = document.getElementById('set-pic').value;
                u.name = document.getElementById('set-n').value;
                u.bio = document.getElementById('set-b').value;
                u.web = document.getElementById('set-l').value;
                u.mention = document.getElementById('set-m').value;
                u.isPrivate = document.getElementById('set-pr').checked;
                u.allowMsg = document.getElementById('set-al').checked;
                
                btn.classList.add('btn-load');
                await fetch(API, {method:'POST', body:JSON.stringify({action:'updateUser', payload:u})});
                this.toast('Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
                btn.classList.remove('btn-load');
            },

            // --- UTILS ---
            share: (t, id) => {
                const url = location.origin+location.pathname + (t==='prof'? '?u='+app.st.vid : '?p='+id);
                app.st.shr = {txt:'Check this', lnk:url};
                document.getElementById('m-share').classList.remove('hidden');
            },
            doShare: () => {
                if(navigator.share) navigator.share({title:'Social', url:app.st.shr.lnk});
                else prompt('Copy:', app.st.shr.lnk);
            },
            pickUser: () => {
                document.getElementById('m-share').classList.add('hidden');
                document.getElementById('m-pick').classList.remove('hidden');
            },
            filterP: (v) => {
                const l = document.getElementById('pick-list'); l.innerHTML='';
                app.st.users.filter(u=>u.id.includes(v)&&u.id!==app.st.user.id).forEach(u=>{
                    l.innerHTML += `<div class="card flex-between">${app.htmlU(u.id)} <button class="btn-sm btn-primary" onclick="app.sendShr('${u.id}')">Ø§Ø±Ø³Ø§Ù„</button></div>`;
                });
            },
            sendShr: (uid) => {
                const m = {from:app.st.user.id, to:uid, text:app.st.shr.lnk, time:Date.now(), read:false};
                app.st.msgs.push(m);
                fetch(API, {method:'POST', body:JSON.stringify({action:'createMsg', payload:m})});
                document.getElementById('m-pick').classList.add('hidden');
                app.toast('Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯');
            },
            search: (v) => {
                app.nav('search');
                const b = document.getElementById('srch-res'); b.innerHTML='';
                app.st.users.filter(u=>u.id.includes(v)||u.name.includes(v)).forEach(u=>b.innerHTML+=`<div class="card">${app.htmlU(u.id)}</div>`);
            },
            toast: (t) => {
                const b = document.getElementById('toast'); b.innerText=t; b.classList.add('show');
                setTimeout(()=>b.classList.remove('show'), 3000);
            },
            badge: () => {
                const req = app.st.user.requests.length;
                const ur = app.st.msgs.filter(m=>m.to===app.st.user.id&&!m.read).length;
                const tot = req+ur;
                const b1 = document.getElementById('b-nav');
                const b2 = document.getElementById('b-req');
                if(tot>0) { b1.innerText=tot; b1.classList.remove('hidden'); } else b1.classList.add('hidden');
                if(req>0) { b2.innerText=req; b2.classList.remove('hidden'); } else b2.classList.add('hidden');
            },
            showList: (t) => {
                const u = app.st.users.find(x=>x.id===app.st.vid);
                const l = t==='followers'?u.followers:u.following;
                // If posts, handled differently? No, simplified
                const b = document.getElementById('lst-bod'); b.innerHTML='';
                if(t==='posts') return; // Posts are already shown below
                l.forEach(id => b.innerHTML+=`<div style="margin-bottom:10px">${app.htmlU(id)}</div>`);
                document.getElementById('lst-tit').innerText = t;
                document.getElementById('m-list').classList.remove('hidden');
            }
        };

        app.init();
    </script>
</body>
</html>
