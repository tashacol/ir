<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ</title>
    <style>
        :root {
            --p: #2563eb; --pd: #1e40af; --bg: #f8fafc; --s: #ffffff;
            --t: #0f172a; --tg: #64748b; --bor: #e2e8f0; --err: #ef4444;
            --sh: 0 2px 4px rgba(0,0,0,0.05); --rad: 16px;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; -webkit-tap-highlight-color:transparent; outline:none; }
        body { background:var(--bg); color:var(--t); padding-bottom:75px; overflow-x:hidden; user-select:none; }
        .con { max-width:500px; margin:0 auto; padding:12px; }
        .hide { display:none !important; }
        .flex-bw { display:flex; justify-content:space-between; align-items:center; }
        .flex-al { display:flex; align-items:center; gap:10px; }
        
        /* UI Components */
        .card { background:var(--s); border-radius:var(--rad); padding:15px; margin-bottom:12px; box-shadow:var(--sh); border:1px solid var(--bor); position:relative; }
        
        .inp { width:100%; padding:12px; border:1px solid var(--bor); border-radius:12px; background:var(--bg); font-size:0.95rem; margin-bottom:12px; transition:0.3s; }
        .inp:focus { border-color:var(--p); background:var(--s); }
        .btn { width:100%; padding:12px; border-radius:12px; font-weight:bold; cursor:pointer; border:none; transition:0.2s; }
        .btn:active { transform:scale(0.97); }
        .btn-p { background:var(--p); color:white; }
        .btn-o { border:1px solid var(--bor); color:var(--tg); background:transparent; }
        .btn-s { padding:6px 12px; font-size:0.8rem; width:auto; border-radius:8px; }
        
        /* Loading Spinner */
        .loading { position:relative; color:transparent !important; pointer-events:none; }
        .loading::after { content:""; position:absolute; left:50%; top:50%; width:20px; height:20px; border:3px solid #fff; border-top-color:transparent; border-radius:50%; animation:rot 0.8s linear infinite; transform:translate(-50%,-50%); }
        @keyframes rot { to { transform:translate(-50%,-50%) rotate(360deg); } }
        
        /* User Avatar */
        .av { width:45px; height:45px; border-radius:50%; object-fit:cover; background:#e2e8f0; border:1px solid var(--bor); flex-shrink:0; cursor: pointer; }
        .av-s { width:35px; height:35px; }
        .av-l { width:80px; height:80px; border:3px solid var(--s); box-shadow:var(--sh); }

        /* Navigation */
        .nav { position:fixed; bottom:0; left:0; width:100%; background:rgba(255,255,255,0.95); backdrop-filter:blur(5px); border-top:1px solid var(--bor); display:flex; justify-content:space-around; padding:12px 0; z-index:100; box-shadow:0 -2px 10px rgba(0,0,0,0.03); }
        .n-it { font-size:1.6rem; color:#94a3b8; position:relative; cursor:pointer; transition:0.2s; }
        .n-it.active { color:var(--p); transform:translateY(-3px); }
        .bdg { position:absolute; top:-3px; right:-5px; background:var(--err); color:white; font-size:0.65rem; padding:2px 5px; border-radius:10px; border:2px solid var(--s); }

        /* Prof Styles (Original Look) */
        .p-top { display:flex; align-items:center; gap:15px; margin-bottom:15px; }
        .p-pic { width:80px; height:80px; border-radius:50%; border:3px solid white; box-shadow:0 5px 15px rgba(0,0,0,0.1); object-fit:cover; background:#cbd5e1; }
        .p-sts { flex:1; display:flex; justify-content:space-around; text-align:center; }
        .st-n { font-weight:800; font-size:1.1rem; display:block; }
        .chips { display:flex; gap:8px; overflow-x:auto; padding:5px 0 15px; scrollbar-width:none; }
        .chip { padding:6px 14px; border-radius:20px; background:var(--s); border:1px solid var(--bor); white-space:nowrap; font-size:0.85rem; transition:0.2s; cursor:pointer; }
        .chip.active { background:var(--t); color:white; border-color:var(--t); }

        /* Post Styles */
        .p-hd { display:flex; align-items:center; gap:10px; margin-bottom:10px; cursor:pointer; }
        .p-nm { font-weight:bold; font-size:0.95rem; }
        .p-id { font-size:0.75rem; color:var(--tg); }
        .p-txt { line-height:1.6; white-space:pre-wrap; font-size:0.95rem; }
        .p-act { border-top:1px solid var(--bor); padding-top:10px; margin-top:10px; display:flex; gap:20px; color:var(--tg); }
        .act { cursor:pointer; display:flex; align-items:center; gap:5px; transition:0.2s; }
        .act:active { transform:scale(1.2); }
        .act.lk span { color:var(--err); animation:pop 0.3s; }
        @keyframes pop { 50% { transform:scale(1.4); } }
        .ment { color:var(--p); cursor:pointer; font-weight:bold; text-decoration:none; }

        /* Uploading & Progress */
        .prog { height:4px; background:#e2e8f0; width:100%; margin-top:10px; overflow:hidden; border-radius:2px; display:none; }
        .fill { height:100%; background:linear-gradient(90deg, var(--p), var(--pd)); width:0%; transition:width 0.3s ease-out; }
        .up-msg { font-size:0.8rem; color:green; text-align:center; display:none; margin-top:5px; font-weight:bold; }
        .sending { opacity:0.7; pointer-events:none; position:relative; }
        .sending::after { content:'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...'; position:absolute; top:10px; left:10px; font-size:0.75rem; color:var(--p); }

        /* Messages */
        .msg-r { display:flex; gap:10px; padding:12px; border-bottom:1px solid var(--bor); align-items:center; cursor:pointer; background:var(--s); transition:0.2s; }
        .msg-r:active { background:#f1f5f9; }
        .msg-u { font-weight:bold; font-size:0.95rem; }
        .msg-l { font-size:0.85rem; color:var(--tg); overflow:hidden; white-space:nowrap; text-overflow:ellipsis; max-width:200px; }
        .tik { font-size:0.75rem; margin-right:3px; font-family:sans-serif; }
        .tik.ok { color:var(--p); } /* ØªÛŒÚ© Ø¢Ø¨ÛŒ */
        .tik.wait { color:var(--tg); } /* Ø³Ø§Ø¹Øª */

        /* Toast Notification */
        #tst { position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#1e293b; color:white; padding:10px 20px; border-radius:30px; z-index:2000; font-size:0.85rem; opacity:0; pointer-events:none; transition:0.3s; box-shadow:0 5px 15px rgba(0,0,0,0.2); }
        #tst.show { opacity:1; top:30px; }

        /* Chat Room */
        .ch-bub { max-width:80%; margin-bottom:8px; padding:8px 12px; border-radius:15px; font-size:0.95rem; position:relative; line-height:1.4; }
        .ch-me { align-self:flex-end; background:#dbeafe; border-bottom-left-radius:2px; color:#1e3a8a; }
        .ch-yo { align-self:flex-start; background:#f1f5f9; border-bottom-right-radius:2px; color:var(--t); }
        .ch-tm { font-size:0.65rem; text-align:left; margin-top:4px; opacity:0.7; display:flex; align-items:center; gap:2px; }
    </style>
</head>
<body>

    <div id="tst"></div>

    <!-- AUTH -->
    <div id="scr-auth" class="con" style="height:100vh; display:flex; flex-direction:column; justify-content:center;">
        <h1 style="text-align:center; color:var(--p); margin-bottom:30px; font-size:2rem;">ğŸŒ€ Ø³ÙˆØ´ÛŒØ§Ù„ Ù¾Ù„Ø§Ø³</h1>
        
        <div id="f-log">
            <div class="card">
                <h3 style="text-align:center; margin-bottom:15px">ÙˆØ±ÙˆØ¯</h3>
                <input type="text" id="l-user" class="inp" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ (Ø³ØªÙˆÙ† B)" inputmode="numeric">
                <input type="password" id="l-ps" class="inp" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
                <div style="margin-bottom:15px; font-size:0.9rem"><label><input type="checkbox" id="l-rem" checked> Ø°Ø®ÛŒØ±Ù‡ ÙˆØ±ÙˆØ¯</label></div>
                <button class="btn btn-p" onclick="app.login(this)">ÙˆØ±ÙˆØ¯</button>
                <button class="btn btn-o" style="margin-top:10px" onclick="app.guest()">ÙˆØ±ÙˆØ¯ Ù…Ù‡Ù…Ø§Ù†</button>
            </div>
            <p style="text-align:center; color:var(--p); cursor:pointer; margin-top:15px" onclick="toggleAuth()">Ø«Ø¨Øª Ù†Ø§Ù…</p>
        </div>

        <div id="f-reg" class="hide">
            <div class="card">
                <h3 style="text-align:center; margin-bottom:15px">Ø«Ø¨Øª Ù†Ø§Ù…</h3>
                <input type="number" id="r-nc" class="inp" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ" inputmode="numeric">
                <input type="text" id="r-nm" class="inp" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ">
                <input type="text" id="r-us" class="inp" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ (Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)">
                <input type="number" id="r-rf" class="inp" placeholder="Ú©Ø¯ Ù…Ø¹Ø±Ù" inputmode="numeric">
                <input type="password" id="r-ps" class="inp" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
                <button class="btn btn-p" onclick="app.reg(this)">Ø«Ø¨Øª Ù†Ø§Ù…</button>
            </div>
            <p style="text-align:center; color:var(--tg); cursor:pointer; margin-top:15px" onclick="toggleAuth()">Ø¨Ø§Ø²Ú¯Ø´Øª</p>
        </div>
    </div>

    <!-- APP -->
    <div id="scr-app" class="hide">
        
        <!-- HOME -->
        <section id="s-hm" class="con">
            <div class="flex-bw" style="margin-bottom:10px"><h2>Ø®Ø§Ù†Ù‡</h2><div onclick="app.sync(true)" style="font-size:1.2rem; cursor:pointer">ğŸ”„</div></div>
            <div id="feed-up"></div>
            <div id="feed"></div>
            <div id="ldr" style="text-align:center; padding:20px; color:var(--tg); display:none">...</div>
        </section>

        <!-- EXPLORE -->
        <section id="s-ex" class="con hide">
            <input type="text" class="inp" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ú©Ø§Ø±Ø¨Ø±..." onkeyup="if(event.key==='Enter') app.srch(this.value)">
            <div id="res-bx"></div>
        </section>

        <!-- ADD POST -->
        <section id="s-ad" class="con hide">
            <h2>Ù¾Ø³Øª Ø¬Ø¯ÛŒØ¯</h2>
            <div class="card" id="pub-bx">
                <input type="text" id="p-ti" class="inp" placeholder="Ø¹Ù†ÙˆØ§Ù†">
                <select id="p-ct" class="inp">
                    <option value="Ø¹Ù…ÙˆÙ…ÛŒ">Ø¹Ù…ÙˆÙ…ÛŒ</option>
                    <option value="Ø§Ø®Ø¨Ø§Ø±">Ø§Ø®Ø¨Ø§Ø±</option>
                    <option value="Ø¢Ù…ÙˆØ²Ø´ÛŒ">Ø¢Ù…ÙˆØ²Ø´ÛŒ</option>
                </select>
                <textarea id="p-tx" class="inp" rows="6" placeholder="Ù…ØªÙ†..."></textarea>
                
                <div class="prog" id="p-prg"><div class="fill" id="p-fil"></div></div>
                <div class="up-msg" id="p-msg">Ù¾Ø³Øª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!</div>

                <button class="btn btn-p" style="margin-top:10px" onclick="app.pub(this)">Ø§Ø±Ø³Ø§Ù„</button>
            </div>
        </section>

        <!-- MESSAGES -->
        <section id="s-ms" class="con hide">
            <div class="flex-bw" style="margin-bottom:15px"><h2>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§</h2></div>
            <div id="req-con" style="display:none">
                <h4 style="margin:10px 0; font-size:0.9rem; color:var(--tg)">Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¯ÙˆØ³ØªÛŒ</h4>
                <div id="req-bx"></div>
            </div>
            <div id="chat-ls"></div>
        </section>

        <!-- CHAT ROOM -->
        <section id="s-ch" class="hide" style="position:fixed; top:0; left:0; right:0; bottom:0; background:var(--bg); z-index:200; display:flex; flex-direction:column">
            <div style="background:var(--s); padding:10px; border-bottom:1px solid var(--bor); display:flex; align-items:center; gap:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05)">
                <button class="btn-s btn-o" onclick="document.getElementById('s-ch').classList.add('hide')">â¬…</button>
                <div id="ch-hd" class="flex-al" onclick="app.nav('pr', app.st.cpid)" style="flex:1; cursor:pointer">
                    <img id="ch-av" class="av av-s">
                    <div style="font-weight:bold" id="ch-nm"></div>
                </div>
            </div>
            <div id="ch-bx" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:8px"></div>
            <div style="padding:10px; background:var(--s); display:flex; gap:5px; border-top:1px solid var(--bor)">
                <input type="text" id="ch-in" class="inp" style="margin:0; border-radius:20px" placeholder="Ù¾ÛŒØ§Ù…...">
                <button class="btn btn-p" style="width:50px; border-radius:50%" onclick="app.sndM()">â¤</button>
            </div>
        </section>

        <!-- PROFILE (Ø¸Ø§Ù‡Ø± Ø§ØµÙ„ÛŒ) -->
        <section id="s-pr" class="con hide">
            <div class="card">
                <div class="flex-bw" style="margin-bottom:15px">
                    <button class="btn-i" id="bp-bk" onclick="app.nav('hm')">â¬…ï¸</button>
                    <h3 id="p-hd"></h3>
                    <button class="btn-i" onclick="document.getElementById('p-mn').classList.toggle('hide')">â‹®</button>
                    <div id="p-mn" class="card hide" style="position:absolute; top:40px; left:10px; width:150px; z-index:10; padding:5px;">
                        <div style="padding:10px; cursor:pointer" onclick="app.share('prof')">ğŸ”— Ø§Ø´ØªØ±Ø§Ú©</div>
                        <div style="padding:10px; color:red; cursor:pointer" onclick="app.block()">ğŸš« Ù…Ø³Ø¯ÙˆØ¯</div>
                    </div>
                </div>
                <div class="p-top">
                    <img id="p-im" class="p-pic" src="">
                    <div class="p-sts">
                        <div onclick="app.list('posts')"><span class="st-n" id="c-po">0</span><span>Ù¾Ø³Øª</span></div>
                        <div onclick="app.list('fol')"><span class="st-n" id="c-fl">0</span><span>Ø¯Ù†Ø¨Ø§Ù„â€ŒÚ©Ù†Ù†Ø¯Ù‡</span></div>
                        <div onclick="app.list('fing')"><span class="st-n" id="c-fi">0</span><span>Ø¯Ù†Ø¨Ø§Ù„â€ŒØ´ÙˆÙ†Ø¯Ù‡</span></div>
                    </div>
                </div>
                <h3 id="p-nm"></h3>
                <div style="color:var(--tg); font-size:0.9rem; margin-bottom:5px">@<span id="p-id"></span></div>
                <p id="p-bi" style="font-size:0.9rem"></p>
                <div id="p-lnk" style="margin-top:8px; font-size:0.9rem;"></div>
                <div class="flex-bw" id="p-act" style="margin-top:15px; gap:10px"></div>
            </div>
            <!-- Ú†ÛŒÙ¾Ø³â€ŒÙ‡Ø§ -->
            <div id="p-con">
                <div class="chips">
                    <span class="chip active" onclick="app.flt('all',this)">Ù‡Ù…Ù‡</span>
                    <span class="chip" onclick="app.flt('book',this)">Ú©ØªØ§Ø¨</span>
                    <span class="chip" onclick="app.flt('movie',this)">ÙÛŒÙ„Ù…</span>
                    <span class="chip" onclick="app.flt('site',this)">Ø³Ø§ÛŒØª</span>
                </div>
                <div id="p-pts"></div>
            </div>
            <div id="p-lck" class="card hide" style="text-align:center; padding:40px;"><h2>ğŸ”’</h2><p>Ø®ØµÙˆØµÛŒ</p></div>
        </section>

        <!-- SETTINGS (Ú©Ø§Ø±Øª Ø¢Ø¨ÛŒ Ø§ØµÙ„ÛŒ) -->
        <section id="s-st" class="con hide">
            <h2>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h2>
            <div class="card" style="background:linear-gradient(135deg, #3b82f6, #2563eb); color:white; margin-top:15px;">
                <div class="flex-bw"><h3 id="st-nm"></h3> <small id="st-id"></small></div>
                <div style="margin-top:10px">Ú©Ø¯ Ù…Ù„ÛŒ: <span id="st-nc"></span></div>
                <div style="margin-top:5px">Ú©Ø¯ Ø¯Ø¹ÙˆØª: <b id="st-rf" style="font-size:1.2rem"></b></div>
            </div>
            <div class="card">
                <input type="text" id="e-pic" class="inp" placeholder="Ù„ÛŒÙ†Ú© Ø¹Ú©Ø³">
                <input type="text" id="e-nm" class="inp" placeholder="Ù†Ø§Ù…">
                <textarea id="e-bio" class="inp" placeholder="Ø¨ÛŒÙˆ"></textarea>
                <input type="text" id="e-web" class="inp" placeholder="ÙˆØ¨Ø³Ø§ÛŒØª">
                <input type="text" id="e-men" class="inp" placeholder="Ù…Ù†Ø´Ù†">
                <div class="flex-bw" style="margin-bottom:10px"><span>Ø®ØµÙˆØµÛŒ</span> <input type="checkbox" id="e-pri"></div>
                <div class="flex-bw" style="margin-bottom:20px"><span>Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…</span> <input type="checkbox" id="e-msg"></div>
                <button class="btn btn-p" onclick="app.saveSet()">Ø°Ø®ÛŒØ±Ù‡</button>
                <button class="btn btn-o" style="margin-top:10px; color:red; border-color:red" onclick="app.logout()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </section>

        <!-- COMMENTS MODAL -->
        <div id="m-cm" class="hide" style="position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:150; display:flex; align-items:flex-end">
            <div style="background:var(--s); width:100%; height:70vh; border-radius:20px 20px 0 0; display:flex; flex-direction:column; animation:up 0.3s">
                <div style="padding:15px; border-bottom:1px solid var(--bor); text-align:center; font-weight:bold; position:relative">
                    Ù†Ø¸Ø±Ø§Øª
                    <span onclick="document.getElementById('m-cm').classList.add('hide')" style="position:absolute; left:15px; top:15px; cursor:pointer; font-size:1.2rem">âœ•</span>
                </div>
                <div id="cm-ls" style="flex:1; overflow-y:auto; padding:15px"></div>
                <div style="padding:10px; border-top:1px solid var(--bor); display:flex; gap:5px; background:var(--s)">
                    <input type="text" id="cm-in" class="inp" style="margin:0; border-radius:20px" placeholder="Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...">
                    <button class="btn btn-p" style="width:50px; border-radius:50%" onclick="app.sndC()">âœ“</button>
                </div>
            </div>
        </div>

        <div class="nav">
            <div class="n-it active" id="n-hm" onclick="app.nav('hm')">ğŸ </div>
            <div class="n-it" id="n-ex" onclick="app.nav('ex')">ğŸ”</div>
            <div class="n-it" id="n-ad" onclick="app.nav('ad')">â•</div>
            <div class="n-it" id="n-ms" onclick="app.nav('ms')">ğŸ’¬ <span id="bg-ms" class="bdg hide"></span></div>
            <div class="n-it" id="n-pr" onclick="app.nav('pr')">ğŸ‘¤</div>
            <div class="n-it" id="n-st" onclick="app.nav('st')">âš™ï¸</div>
        </div>
    </div>

    <script>
        // *** Ù„ÛŒÙ†Ú© Ø¬Ø¯ÛŒØ¯ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ***
        const API = 'https://script.google.com/macros/s/AKfycbyf_X4VQfe1YC95wWXkUkFrHAHDOCTmC6qzzsNCp-O57HvGikcAPZWlPAbS_9_kWrYI/exec';

        const toggleAuth = () => { document.getElementById('f-log').classList.toggle('hide'); document.getElementById('f-reg').classList.toggle('hide'); };

        const app = {
            st: { user:null, users:[], posts:[], msgs:[], cpid:null, guest:false, vid:null },
            
            init: function() {
                const db = localStorage.getItem('db');
                if(db) { const d=JSON.parse(db); this.st.users=d.users; this.st.posts=d.posts; this.st.msgs=d.msgs; }
                
                const uid = localStorage.getItem('uid');
                if(uid) {
                    const u = this.st.users.find(x=>x.id===uid);
                    if(u) { this.st.user=u; this.start(); this.sync(); }
                    else document.getElementById('scr-auth').classList.remove('hide');
                } else document.getElementById('scr-auth').classList.remove('hide');

                const p = new URLSearchParams(location.search);
                if(p.get('u')) setTimeout(()=>this.nav('pr', p.get('u')), 1000);

                setInterval(() => { if(!document.getElementById('scr-app').classList.contains('hide')) app.sync(false); }, 5000);
            },

            call: async function(act, pl) {
                try {
                    const res = await fetch(API, {
                        method: 'POST',
                        redirect: "follow",
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action: act, payload: pl })
                    });
                    return await res.json();
                } catch(e) { return {status:'error'}; }
            },

            sync: async function(manual) {
                if(manual) this.msg('Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ...');
                const d = await this.call('getAll', {});
                if(d.status === 'success') {
                    this.st.users=d.users;
                    // Ø§Ø¯ØºØ§Ù… Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù¾Ø³Øªâ€ŒÙ‡Ø§
                    d.posts.forEach(np => {
                        let op = this.st.posts.find(p=>p.pid===np.pid);
                        if(op) { op.likes=np.likes; op.comments=np.comments; }
                        else this.st.posts.push(np);
                    });
                    this.st.msgs=d.msgs;
                    localStorage.setItem('db', JSON.stringify(d));
                    
                    if(this.st.user && !this.st.guest) {
                        this.st.user = this.st.users.find(u=>u.id===this.st.user.id)||this.st.user;
                        this.bdg();
                        // Ø§Ú¯Ø± Ø¯Ø± ØµÙØ­Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‡Ø³ØªÛŒÙ…ØŒ Ø¢Ù¾Ø¯ÛŒØªØ´ Ú©Ù†
                        if(!document.getElementById('s-st').classList.contains('hide')) this.setUI();
                    }
                    if(!document.getElementById('s-hm').classList.contains('hide')) this.feed();
                    if(!document.getElementById('s-ms').classList.contains('hide')) this.msList();
                    if(!document.getElementById('sc-ch').classList.contains('hide')) this.rnC();
                    
                    if(manual) this.msg('Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
                }
            },

            // AUTH
            login: async function(btn) {
                const u=document.getElementById('l-user').value, p=document.getElementById('l-ps').value;
                if(!u || !p) return app.msg('Ù†Ø§Ù‚Øµ');
                btn.classList.add('loading');
                const d = await this.call('login', {user:u, pass:p});
                if(d.status === 'success') {
                    this.st.user = d.user;
                    if(document.getElementById('l-rem').checked) localStorage.setItem('uid', d.user.id);
                    this.start(); this.sync(false);
                } else this.msg(d.msg);
                btn.classList.remove('loading');
            },
            reg: async function(btn) {
                const p = {
                    id:document.getElementById('r-us').value.toLowerCase(), 
                    user:document.getElementById('r-nc').value,
                    pass:document.getElementById('r-ps').value, 
                    name:document.getElementById('r-nm').value,
                    refCode:document.getElementById('r-rf').value
                };
                if(!p.id || !p.user || !p.pass || !p.refCode) return this.msg('Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒ');
                btn.classList.add('loading');
                const d = await this.call('register', p);
                if(d.status === 'success') { this.msg('Ø«Ø¨Øª Ø´Ø¯. ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯'); toggleAuth(); }
                else this.msg(d.msg);
                btn.classList.remove('loading');
            },
            guest: function() {
                this.st.guest=true;
                this.st.user={id:'guest', name:'Ù…Ù‡Ù…Ø§Ù†', nc:'guest', followers:[], following:[], requests:[], blocked:[]};
                this.start(); this.msg('Ø­Ø§Ù„Øª Ù…Ù‡Ù…Ø§Ù†');
            },
            logout: function() { localStorage.removeItem('uid'); location.reload(); },
            start: function() {
                document.getElementById('scr-auth').classList.add('hide');
                document.getElementById('scr-app').classList.remove('hide');
                if(this.st.guest) ['n-ad','n-ms','n-st'].forEach(i=>document.getElementById(i).style.display='none');
                this.nav('hm');
            },

            // NAV
            nav: function(p, arg) {
                document.querySelectorAll('section').forEach(s=>s.classList.add('hide'));
                document.querySelectorAll('.n-it').forEach(i=>i.classList.remove('active'));
                
                document.getElementById('sc-ch').classList.add('hide');
                document.getElementById('m-cm').classList.add('hide');

                if(p==='hm') { document.getElementById('s-hm').classList.remove('hide'); document.getElementById('n-hm').classList.add('active'); this.feed(); }
                else if(p==='ex') document.getElementById('s-ex').classList.remove('hide');
                else if(p==='ad') document.getElementById('s-ad').classList.remove('hide');
                else if(p==='ms') { document.getElementById('s-ms').classList.remove('hide'); document.getElementById('n-ms').classList.add('active'); this.msList(); }
                else if(p==='pr') { 
                    document.getElementById('s-pr').classList.remove('hide'); 
                    if(arg===this.st.user.id) document.getElementById('n-pr').classList.add('active');
                    this.prof(arg||this.st.user.id);
                }
                else if(p==='st') { document.getElementById('s-st').classList.remove('hide'); document.getElementById('n-st').classList.add('active'); this.setUI(); }
            },

            // FEED
            feed: function() {
                const c = document.getElementById('feed'), nb = document.getElementById('new-bx');
                nb.innerHTML='';
                this.st.users.filter(u=>u.id!==this.st.user.id).slice(-5).forEach(u=>{
                    const img = u.pic ? `<img src="${u.pic}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">` : u.name[0];
                    nb.innerHTML += `<div style="min-width:70px;text-align:center;cursor:pointer" onclick="app.nav('pr','${u.id}')">
                        <div style="width:50px;height:50px;border-radius:50%;background:#e2e8f0;margin:auto;display:flex;align-items:center;justify-content:center;overflow:hidden">${img}</div>
                        <div style="font-size:0.7rem;margin-top:4px">${u.name}</div></div>`;
                });
                
                const upBox = document.getElementById('feed-up');
                if(upBox.innerHTML) c.innerHTML = upBox.innerHTML;

                const sh = this.st.posts.filter(p=>{
                    const au = this.st.users.find(u=>u.id===p.uid); if(!au) return false;
                    return !au.isPrivate || this.st.user.following.includes(p.uid) || p.uid===this.st.user.id;
                });
                sh.sort((a,b)=>b.time-a.time).forEach(p=>c.innerHTML+=this.htmlP(p));
            },
            htmlU: (uid) => {
                const u = app.st.users.find(x=>x.id===uid); if(!u) return 'Deleted';
                const i = u.pic ? `<img class="u-img" src="${u.pic}">` : `<div class="u-img" style="display:flex;align-items:center;justify-content:center">${u.name[0]}</div>`;
                return `<div class="u-blk" onclick="event.stopPropagation();app.nav('pr','${u.id}')">${i}<div class="u-in"><div class="u-nm">${u.name}</div><div class="u-id">@${u.nc}</div></div></div>`;
            },
            htmlP: (p) => {
                const lk = p.likes.includes(app.st.user.id) ? 'lk' : '';
                return `<div class="card" id="p-${p.pid}"><div class="p-hd" onclick="app.nav('pr','${p.uid}')">${this.htmlU(p.uid)} <span style="font-size:0.7rem;background:#e0f2fe;color:#0284c7;padding:2px 8px;border-radius:8px">${p.cat}</span></div>
                    <h4 style="margin-top:10px">${p.title}</h4><p style="margin-top:5px;line-height:1.6;font-size:0.95rem;white-space:pre-wrap">${app.lnk(p.text)}</p>
                    <div class="p-act">
                        <div class="act ${lk}" id="lb-${p.pid}" onclick="app.like('${p.pid}')"><span>${lk?'â¤ï¸':'ğŸ¤'}</span> <span id="ln-${p.pid}">${p.likes.length}</span></div>
                        <div class="act" onclick="app.comm('${p.pid}')">ğŸ’¬ ${p.comments.length}</div>
                        <div class="act" onclick="app.copyLnk('${p.pid}')">ğŸ”—</div>
                    </div></div>`;
            },

            // NEW POST
            pub: async function(btn) {
                if(this.st.guest) return this.msg('Ù…Ù‡Ù…Ø§Ù†');
                const p = { pid:this.st.user.id+'_'+Date.now(), uid:this.st.user.id, title:document.getElementById('a-ti').value, cat:document.getElementById('a-ct').value, text:document.getElementById('a-tx').value, time:Date.now() };
                if(!p.title || !p.text) return this.msg('Ø®Ø§Ù„ÛŒ');
                
                btn.style.display='none';
                document.getElementById('p-prg').style.display='block';
                const fill = document.getElementById('p-fil');
                
                setTimeout(()=>fill.style.width='40%', 300);
                setTimeout(()=>fill.style.width='75%', 800);

                const pendingHTML = `<div class="card sending" id="pend-p">
                    <div class="flex-bw">${this.htmlU(this.st.user.id)}</div>
                    <h4>${p.title}</h4><p>${p.text}</p>
                </div>`;
                
                this.nav('hm');
                document.getElementById('feed-up').innerHTML = pendingHTML;

                try {
                    await this.call('createPost', p);
                    fill.style.width='100%';
                    document.getElementById('p-msg').style.display='block';
                    setTimeout(()=>{
                        document.getElementById('a-ti').value=''; document.getElementById('a-tx').value='';
                        document.getElementById('p-prg').style.display='none'; fill.style.width='0%';
                        document.getElementById('p-msg').style.display='none';
                        btn.style.display='block';
                        document.getElementById('feed-up').innerHTML='';
                        this.st.posts.unshift({...p, likes:[], comments:[]});
                        this.feed();
                        this.msg('Ù¾Ø³Øª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ âœ“');
                    }, 1000);
                } catch(e) {
                    btn.style.display='block';
                    this.msg('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„');
                }
            },

            // ACTIONS
            like: function(pid) {
                if(this.st.guest) return this.msg('Ù…Ù‡Ù…Ø§Ù†');
                const p = this.st.posts.find(x=>x.pid===pid);
                const uid = this.st.user.id;
                
                let liked = p.likes.includes(uid);
                if(liked) p.likes = p.likes.filter(x=>x!==uid); else p.likes.push(uid);
                
                const btn = document.getElementById('lb-'+pid);
                const num = document.getElementById('ln-'+pid);
                if(btn) {
                    btn.className = liked ? 'act' : 'act lk';
                    btn.querySelector('span').innerText = liked ? 'ğŸ¤' : 'â¤ï¸';
                    num.innerText = p.likes.length;
                }
                
                this.call('updatePost', {pid, likes:p.likes, comments:p.comments});
            },
            comm: function(pid) {
                this.st.cpid = pid;
                document.getElementById('m-cm').classList.remove('hide');
                this.rnCm();
            },
            rnCm: function() {
                const p = this.st.posts.find(x=>x.pid===this.st.cpid);
                const c = document.getElementById('cm-ls'); c.innerHTML='';
                if(p.comments.length===0) c.innerHTML='<div style="text-align:center;color:gray">Ø§ÙˆÙ„ÛŒÙ† Ù†Ø¸Ø± Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯</div>';
                p.comments.forEach(m => {
                    const u = this.st.users.find(x=>x.id===m.uid);
                    c.innerHTML += `<div style="background:#f1f5f9;padding:10px;border-radius:10px;margin-top:8px" onclick="app.nav('pr','${m.uid}')"><b>${u?u.name:'?'}</b>: ${app.lnk(m.text)}</div>`;
                });
                c.scrollTop = c.scrollHeight;
            },
            sndC: function() {
                if(this.st.guest) return this.msg('Ù…Ù‡Ù…Ø§Ù†');
                const txt = document.getElementById('cm-in').value;
                if(!txt) return;
                
                const p = this.st.posts.find(x=>x.pid===this.st.cpid);
                p.comments.push({uid:this.st.user.id, text:txt});
                document.getElementById('cm-in').value='';
                
                const c = document.getElementById('cm-ls');
                if(c.innerHTML.includes('Ø§ÙˆÙ„ÛŒÙ†')) c.innerHTML='';
                c.innerHTML += `<div style="background:#f1f5f9;padding:10px;border-radius:10px;margin-top:8px;opacity:0.5"><b>${this.st.user.name}</b>: ${txt} (Ø§Ø±Ø³Ø§Ù„...)</div>`;
                c.scrollTop = c.scrollHeight;

                this.call('updatePost', {pid:p.pid, likes:p.likes, comments:p.comments}).then(()=>{
                    this.rnCm(); 
                });
            },

            // MESSAGES
            msList: function() {
                const reqs = this.st.user.requests;
                const rb = document.getElementById('req-bx');
                const rc = document.getElementById('req-con');
                if(reqs.length > 0) {
                    rc.style.display = 'block';
                    rb.innerHTML='';
                    reqs.forEach(id => {
                        const u = this.st.users.find(x=>x.id===id);
                        rb.innerHTML += `<div class="msg-r" style="background:transparent; border:none">
                            <img src="${u.pic}" class="av av-s" onclick="app.nav('pr','${id}')">
                            <div style="flex:1"><b>${u.name}</b><br><small>@${u.nc}</small></div>
                            <div><button class="btn-s btn-p" onclick="app.ans('${id}',true)">ØªØ§ÛŒÛŒØ¯</button> <button class="btn-s btn-o" onclick="app.ans('${id}',false)">Ø±Ø¯</button></div>
                        </div>`;
                    });
                } else {
                    rc.style.display = 'none';
                }

                const chats = [...new Set(this.st.msgs.filter(x=>x.from===this.st.user.id||x.to===this.st.user.id).map(x=>x.from===this.st.user.id?x.to:x.from))];
                const cl = document.getElementById('chat-ls'); cl.innerHTML='';
                if(chats.length===0) cl.innerHTML='<div style="text-align:center;padding:20px;color:gray">Ù¾ÛŒØ§Ù…ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</div>';
                
                chats.forEach(cid => {
                    const u = this.st.users.find(x=>x.id===cid);
                    const last = this.st.msgs.filter(x=>(x.from===this.st.user.id&&x.to===cid)||(x.from===cid&&x.to===this.st.user.id)).pop();
                    const unread = this.st.msgs.filter(x=>x.from===cid && x.to===this.st.user.id && !x.read).length;
                    
                    let tick = '';
                    if(last.from === this.st.user.id) tick = last.read ? '<span class="tik ok">âœ“âœ“</span>' : '<span class="tik wait">âœ“</span>';
                    
                    cl.innerHTML += `<div class="msg-r" onclick="app.chat('${cid}')">
                        <img src="${u.pic}" class="av" onclick="event.stopPropagation();app.nav('pr','${cid}')">
                        <div style="flex:1;overflow:hidden">
                            <div class="flex-bw"><span class="msg-u">${u.name}</span> <small style="color:var(--tg)">${this.time(last.time)}</small></div>
                            <div class="msg-l">${tick} ${last.text}</div>
                        </div>
                        ${unread ? `<span class="bdg" style="position:static">${unread}</span>` : ''}
                    </div>`;
                });
            },
            ans: function(id, ok) {
                const me = this.st.user;
                me.requests = me.requests.filter(x=>x!==id);
                const u = this.st.users.find(x=>x.id===id);
                if(ok) { me.followers.push(id); u.following.push(me.id); }
                this.msList();
                this.call('updateUser', [me, u]);
            },
            chat: function(id) {
                this.st.cpid = id;
                const u = this.st.users.find(x=>x.id===id);
                document.getElementById('ch-nm').innerText = u.name;
                document.getElementById('ch-av').src = u.pic;
                document.getElementById('sc-ch').classList.remove('hide');
                this.rnC();
                
                const unread = this.st.msgs.filter(x=>x.from===id && x.to===this.st.user.id && !x.read);
                if(unread.length>0) {
                    unread.forEach(m=>m.read=true);
                    this.bdg();
                }
            },
            rnC: function() {
                const b=document.getElementById('ch-bx'); b.innerHTML='';
                const ms = this.st.msgs.filter(x=>(x.from===this.st.user.id&&x.to===this.st.cpid)||(x.from===this.st.cpid&&x.to===this.st.user.id));
                ms.forEach(x=>{ 
                    const mine = x.from===this.st.user.id;
                    const tick = mine ? (x.read ? '<span class="tik ok">âœ“âœ“</span>' : '<span class="tik wait">âœ“</span>') : '';
                    b.innerHTML += `<div style="display:flex; flex-direction:column; align-items:${mine?'flex-end':'flex-start'}">
                        <div class="ch-bub ${mine?'ch-me':'ch-yo'}">
                            ${this.lnk(x.text)}
                            <div class="ch-tm">${tick} ${this.time(x.time)}</div>
                        </div>
                    </div>`; 
                });
                b.scrollTop=b.scrollHeight;
            },
            sndM: function() {
                const t = document.getElementById('ch-in').value; if(!t) return;
                const m = {from:this.st.user.id, to:this.st.cpid, text:t, time:Date.now(), read:false};
                
                const b = document.getElementById('ch-bx');
                b.innerHTML += `<div style="display:flex; flex-direction:column; align-items:flex-end; opacity:0.7">
                        <div class="ch-bub ch-me">
                            ${this.lnk(t)}
                            <div class="ch-tm">ğŸ•’ ...</div>
                        </div>
                    </div>`;
                b.scrollTop=b.scrollHeight;
                document.getElementById('ch-in').value='';

                this.call('createMsg', m).then(()=>{
                    this.st.msgs.push(m);
                    this.rnC(); 
                });
            },

            // PROF
            prof: function(uid) {
                const u = this.st.users.find(x=>x.id===uid);
                const me = this.st.user; this.st.vid = uid; const isMe = uid === me.id;
                document.getElementById('bp-bk').classList.toggle('hide', isMe);
                document.getElementById('p-im').src = u.pic||''; if(!u.pic) document.getElementById('p-im').style.background='#cbd5e1';
                document.getElementById('p-nm').innerText = u.name; document.getElementById('p-id').innerText = '@'+u.nc; 
                document.getElementById('p-bi').innerHTML = this.lnk(u.bio);
                
                const lnk = document.getElementById('p-lnk'); lnk.innerHTML='';
                if(u.web) lnk.innerHTML += `<div>ğŸŒ <a href="${u.web}">${u.web}</a></div>`;
                
                const ps = this.st.posts.filter(x=>x.uid===uid);
                document.getElementById('c-pt').innerText=ps.length; document.getElementById('c-fl').innerText=u.followers.length; document.getElementById('c-fi').innerText=u.following.length;
                
                const acts = document.getElementById('p-act');
                if(isMe) acts.classList.add('hide');
                else {
                    acts.classList.remove('hide');
                    const b = document.getElementById('b-fl');
                    if(me.following.includes(uid)) { b.innerText='Ù„ØºÙˆ'; b.className='btn btn-o'; }
                    else if(u.requests.includes(me.id)) { b.innerText='Ø§Ù†ØªØ¸Ø§Ø±'; b.className='btn btn-o'; }
                    else { b.innerText='Ø¯Ù†Ø¨Ø§Ù„'; b.className='btn btn-p'; }
                }
                const acc = isMe || !u.isPrivate || (u.isPrivate && u.followers.includes(me.id));
                document.getElementById('p-con').classList.toggle('hide', !acc);
                document.getElementById('p-lck').classList.toggle('hide', acc);
                if(acc) this.flt('all', document.querySelector('.chip'));
            },
            flt: function(cat, el) {
                document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); el.classList.add('active');
                const c = document.getElementById('p-pts'); c.innerHTML='';
                let p = this.st.posts.filter(x=>x.uid===this.st.vid);
                if(cat!=='all') p = p.filter(x=>x.cat===cat);
                if(p.length===0) c.innerHTML='<p style="text-align:center;padding:20px;color:gray">Ø®Ø§Ù„ÛŒ</p>';
                p.sort((a,b)=>b.time-a.time).forEach(x=>c.innerHTML+=this.htmlP(x));
            },
            fol: function() {
                if(this.st.guest) return this.msg('Ù…Ù‡Ù…Ø§Ù†');
                const uid = this.st.vid; const me = this.st.user; const u = this.st.users.find(x=>x.id===uid);
                let t = 'follow'; if(me.following.includes(uid)) t = 'unfollow';
                if(t==='follow') { if(u.isPrivate) u.requests.push(me.id); else { me.following.push(uid); u.followers.push(me.id); } }
                else { me.following = me.following.filter(x=>x!==uid); u.followers = u.followers.filter(x=>x!==me.id); }
                this.prof(uid);
                this.call('updateUser', [me, u]);
            },

            // LINK HELPER
            lnk: function(t) {
                if(!t) return '';
                return t.replace(/@(\w+)/g, (match, nc) => {
                    const u = this.st.users.find(x=>x.nc===nc);
                    if(u) return `<span class="ment" onclick="event.stopPropagation();app.nav('pr','${u.id}')">${match}</span>`;
                    return match;
                });
            },
            copyLnk: function(pid) {
                const url = window.location.origin + window.location.pathname + '?p=' + pid;
                navigator.clipboard.writeText(url);
                this.msg('Ù„ÛŒÙ†Ú© Ù¾Ø³Øª Ú©Ù¾ÛŒ Ø´Ø¯');
            },
            share: function() {
                const url = window.location.origin + window.location.pathname + '?u=' + this.st.user.id;
                navigator.clipboard.writeText(url);
                this.msg('Ù„ÛŒÙ†Ú© Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ù¾ÛŒ Ø´Ø¯');
            },
            time: function(ms) {
                return new Date(ms).toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit'});
            },
            srch: function(v) {
                const r = document.getElementById('res-bx'); r.innerHTML='';
                if(!v) return;
                this.st.users.filter(x=>x.name.includes(v) || x.nc.includes(v)).forEach(u => {
                    r.innerHTML += `<div class="card flex-al" onclick="app.nav('pr','${u.id}')">
                        <img src="${u.pic}" class="av">
                        <div><b>${u.name}</b><br><small>@${u.nc}</small></div>
                    </div>`;
                });
            },
            setUI: function() {
                const u = this.st.user;
                document.getElementById('st-nc').innerText=u.nc;
                document.getElementById('st-rf').innerText=u.refCode;
                document.getElementById('e-pic').value=u.pic;
                document.getElementById('e-nm').value=u.name;
                document.getElementById('e-bio').value=u.bio;
                document.getElementById('e-web').value=u.web;
                document.getElementById('e-men').value=u.mention;
                document.getElementById('e-pri').checked=u.isPrivate;
                document.getElementById('e-msg').checked=u.allowMsg;
            },
            saveSet: async function() {
                const u = this.st.user;
                u.pic = document.getElementById('e-pic').value;
                u.name = document.getElementById('e-nm').value;
                u.bio = document.getElementById('e-bio').value;
                u.web = document.getElementById('e-web').value;
                u.mention = document.getElementById('e-men').value;
                u.isPrivate = document.getElementById('e-pri').checked;
                u.allowMsg = document.getElementById('e-msg').checked;
                this.msg('Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...');
                await this.call('updateUser', u);
                this.msg('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
            },
            msg: function(t) { const b=document.getElementById('tst'); b.innerText=t; b.classList.add('show'); setTimeout(()=>b.classList.remove('show'), 3000); },
            bdg: function() {
                const r = this.st.user.requests.length;
                const m = this.st.msgs.filter(x=>x.to===this.st.user.id && !x.read).length;
                const b = document.getElementById('bg-ms');
                if(r+m > 0) { b.innerText=r+m; b.classList.remove('hide'); }
                else b.classList.add('hide');
            },
            list: function(t) {
                const u=this.st.users.find(x=>x.id===this.st.vid);
                const l=t==='fol'?u.followers:u.following;
                if(t==='posts') return;
                const b=document.getElementById('ls-bd'); b.innerHTML='';
                l.forEach(id => b.innerHTML+=`<div style="margin-bottom:10px">${app.htmlU(id)}</div>`);
                document.getElementById('ls-tt').innerText=t; document.getElementById('m-ls').classList.remove('hide');
            }
        };
        app.init();
    </script>
</body>
</html>
