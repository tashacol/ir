<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ Ù…ØªÙ†ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #eff6ff;
            --bg: #f3f4f6;
            --white: #ffffff;
            --text: #1f2937;
            --gray: #6b7280;
            --border: #e5e7eb;
            --danger: #ef4444;
            --success: #10b981;
            --cat-book: #10b981; --cat-movie: #f59e0b; --cat-site: #8b5cf6; --cat-soft: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Tahoma, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text); padding-bottom: 80px; overflow-x: hidden; }
        a { text-decoration: none; color: var(--primary); }
        button { font-family: inherit; }

        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        .hidden { display: none !important; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn:active { transform: scale(0.98); }
        .btn-sm { padding: 4px 10px; font-size: 0.8rem; }
        .btn-primary { background: var(--primary); color: var(--white); }
        .btn-danger { background: var(--danger); color: var(--white); }
        .btn-outline { border: 1px solid var(--gray); background: transparent; color: var(--text); }
        .btn-icon { background: transparent; color: var(--text); padding: 5px; font-size: 1.3rem; cursor: pointer; border: none; }
        
        .card { background: var(--white); border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: relative; }
        
        input, select, textarea { width: 100%; padding: 12px; margin: 5px 0 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; background: #fff; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: none; }
        
        .user-block { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .user-avatar-sm { width: 40px; height: 40px; border-radius: 50%; background: var(--border); overflow: hidden; display: flex; align-items: center; justify-content: center; color: var(--gray); font-size: 1.2rem; flex-shrink: 0; border: 1px solid var(--border); }
        .user-avatar-sm img { width: 100%; height: 100%; object-fit: cover; }
        .user-info-text { display: flex; flex-direction: column; line-height: 1.2; }
        .user-name { font-weight: bold; font-size: 0.95rem; color: var(--text); }
        .user-id { font-size: 0.75rem; color: var(--gray); }

        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--white); display: flex; justify-content: space-around; padding: 12px; border-top: 1px solid var(--border); box-shadow: 0 -2px 10px rgba(0,0,0,0.05); max-width: 600px; margin: 0 auto; z-index: 900; }
        .nav-item { cursor: pointer; color: var(--gray); font-size: 1.6rem; position: relative; }
        .nav-item.active { color: var(--primary); }
        .badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; border: 2px solid var(--white); }

        .post-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .post-cat-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; color: white; align-self: flex-start; }
        .post-content { line-height: 1.6; margin: 10px 0; white-space: pre-wrap; word-break: break-word; font-size: 0.95rem; }
        .post-actions { display: flex; gap: 20px; border-top: 1px solid var(--border); padding-top: 10px; color: var(--gray); font-size: 0.9rem; }
        .action-btn { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .action-btn.liked { color: var(--danger); }

        .profile-top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .profile-pic-lg { width: 80px; height: 80px; border-radius: 50%; background: var(--border); overflow: hidden; margin-right: 15px; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: #fff; border: 3px solid var(--white); box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; }
        .profile-pic-lg img { width: 100%; height: 100%; object-fit: cover; }
        .profile-stats { flex: 1; display: flex; justify-content: space-around; text-align: center; }
        .stat-box { cursor: pointer; }
        .stat-val { font-weight: bold; font-size: 1.1rem; display: block; }
        .stat-lbl { font-size: 0.8rem; color: var(--gray); }
        
        .filter-bar { display: flex; gap: 10px; overflow-x: auto; padding: 5px 0 15px; scrollbar-width: none; }
        .filter-chip { padding: 6px 16px; border-radius: 20px; background: var(--white); border: 1px solid var(--border); cursor: pointer; white-space: nowrap; font-size: 0.9rem; transition: 0.2s; }
        .filter-chip.active { background: var(--text); color: var(--white); border-color: var(--text); }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; align-items: flex-end; justify-content: center; }
        .modal-sheet { background: var(--white); width: 100%; max-width: 600px; border-radius: 20px 20px 0 0; padding: 20px; max-height: 80vh; overflow-y: auto; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-weight: bold; font-size: 1.1rem; }
        .share-option { padding: 15px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; cursor: pointer; }
        
        .c-book { background: var(--cat-book); } .c-movie { background: var(--cat-movie); } .c-site { background: var(--cat-site); } .c-soft { background: var(--cat-soft); }
        .b-book { border-right: 4px solid var(--cat-book); } .b-movie { border-right: 4px solid var(--cat-movie); } .b-site { border-right: 4px solid var(--cat-site); } .b-soft { border-right: 4px solid var(--cat-soft); }

        .comment-box { background: #f9fafb; padding: 10px; border-radius: 8px; margin-top: 5px; font-size: 0.9rem; }
        .auth-container { height: 100vh; display: flex; flex-direction: column; justify-content: center; padding: 20px; text-align: center; }
        
        /* Loading Overlay */
        #loading-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background:rgba(255,255,255,0.8); z-index: 3000; display:flex; align-items:center; justify-content:center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- LOADING SPINNER -->
    <div id="loading-overlay" class="hidden"><div class="spinner"></div></div>

    <!-- AUTH SECTION -->
    <div id="auth-section" class="auth-container">
        <h1 style="margin-bottom:20px; color:var(--primary)">Ø´Ø¨Ú©Ù‡ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ</h1>
        <!-- Login -->
        <div id="login-form">
            <div class="card">
                <h3>ÙˆØ±ÙˆØ¯</h3>
                <input type="number" id="login-nc" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ">
                <input type="password" id="login-pass" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
                <button class="btn btn-primary" style="width:100%" onclick="app.login()">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨</button>
            </div>
            <p onclick="app.toggleAuth()" style="cursor:pointer; color:var(--primary)">Ø«Ø¨Øª Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯</p>
        </div>
        <!-- Register -->
        <div id="reg-form" class="hidden">
            <div class="card" style="text-align:right">
                <h3>Ø«Ø¨Øª Ù†Ø§Ù…</h3>
                <label>Ú©Ø¯ Ù…Ù„ÛŒ (Û±Û° Ø±Ù‚Ù…)</label><input type="number" id="reg-nc">
                <label>Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ</label><input type="text" id="reg-name">
                <label>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ (Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)</label><input type="text" id="reg-user">
                <label>Ú©Ø¯ Ù…Ø¹Ø±Ù (Ø§Ù„Ø²Ø§Ù…ÛŒ)</label><input type="number" id="reg-ref-code">
                <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label><input type="password" id="reg-pass">
                <button class="btn btn-success" style="width:100%" onclick="app.register()">Ø«Ø¨Øª Ù†Ø§Ù…</button>
            </div>
            <p onclick="app.toggleAuth()" style="cursor:pointer; color:var(--primary)">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ÙˆØ±ÙˆØ¯</p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="hidden">
        <!-- 1. Home -->
        <section id="home-section" class="container">
            <div class="flex-between" style="margin-bottom:10px">
                <h2 style="margin:0">Ø®Ø§Ù†Ù‡</h2>
                <div style="position:relative">
                    <input type="text" id="global-search" placeholder="Ø¬Ø³ØªØ¬Ùˆ..." style="margin:0; padding:6px; width:150px; border-radius:20px" onkeyup="if(event.key==='Enter') app.search(this.value)">
                </div>
            </div>
            <div style="margin-bottom:15px">
                <small style="color:var(--gray)">Ø§Ø¹Ø¶Ø§ÛŒ Ø¬Ø¯ÛŒØ¯</small>
                <div id="new-members-scroll" style="display:flex; gap:10px; overflow-x:auto; padding:10px 0; scrollbar-width:none"></div>
            </div>
            <div id="feed-container"></div>
        </section>

        <!-- 2. Profile -->
        <section id="profile-section" class="container hidden">
            <div class="card">
                <div class="profile-top-bar">
                    <button class="btn-icon" id="prof-back-btn" onclick="app.nav('home')">â¬…ï¸</button>
                    <div style="font-weight:bold" id="p-header-name">Ù¾Ø±ÙˆÙØ§ÛŒÙ„</div>
                    <div style="position:relative">
                        <button class="btn-icon" onclick="document.getElementById('prof-menu').classList.toggle('hidden')">â‹®</button>
                        <div id="prof-menu" class="card hidden" style="position:absolute; left:0; top:30px; width:180px; z-index:100; padding:5px; text-align:right">
                            <div class="share-option" onclick="app.initShare('profile')">ğŸ”— Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ</div>
                            <div class="share-option" onclick="app.blockUser()" style="color:red">ğŸš« Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù†</div>
                        </div>
                    </div>
                </div>
                <div style="display:flex; align-items:center; margin-bottom:15px">
                    <div class="profile-pic-lg" id="p-pic"></div>
                    <div class="profile-stats">
                        <div class="stat-box"> <span class="stat-val" id="p-post-count">0</span> <span class="stat-lbl">Ù¾Ø³Øª</span> </div>
                        <div class="stat-box" onclick="app.showList('followers')"> <span class="stat-val" id="p-follower-count">0</span> <span class="stat-lbl">Ø¯Ù†Ø¨Ø§Ù„â€ŒÚ©Ù†Ù†Ø¯Ù‡</span> </div>
                        <div class="stat-box" onclick="app.showList('following')"> <span class="stat-val" id="p-following-count">0</span> <span class="stat-lbl">Ø¯Ù†Ø¨Ø§Ù„â€ŒØ´ÙˆÙ†Ø¯Ù‡</span> </div>
                    </div>
                </div>
                <div style="margin-bottom:15px">
                    <h3 id="p-name" style="margin-bottom:2px"></h3>
                    <div style="color:var(--gray); font-size:0.9rem">@<span id="p-id"></span></div>
                    <p id="p-bio" style="margin-top:5px; white-space:pre-wrap"></p>
                    <div id="p-link-area" style="margin-top:5px"></div>
                </div>
                <div class="flex-between" id="prof-actions">
                    <button id="btn-follow" class="btn btn-primary" style="flex:1; margin-left:5px">Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù†</button>
                    <button id="btn-msg" class="btn btn-outline" style="flex:1" onclick="app.openChat(app.state.viewId)">Ù¾ÛŒØ§Ù…</button>
                </div>
            </div>
            <div id="profile-content">
                <div class="filter-bar">
                    <span class="filter-chip active" onclick="app.filterProfilePosts('all', this)">Ù‡Ù…Ù‡</span>
                    <span class="filter-chip" onclick="app.filterProfilePosts('book', this)">Ú©ØªØ§Ø¨</span>
                    <span class="filter-chip" onclick="app.filterProfilePosts('movie', this)">ÙÛŒÙ„Ù…</span>
                    <span class="filter-chip" onclick="app.filterProfilePosts('site', this)">Ø³Ø§ÛŒØª</span>
                    <span class="filter-chip" onclick="app.filterProfilePosts('soft', this)">Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø±</span>
                </div>
                <div id="profile-posts-box"></div>
            </div>
            <div id="private-msg" class="card hidden" style="text-align:center; padding:30px"><h2>ğŸ”’</h2><p>Ø®ØµÙˆØµÛŒ</p></div>
        </section>

        <!-- 3. Add Post -->
        <section id="add-section" class="container hidden">
            <h2>Ù¾Ø³Øª Ø¬Ø¯ÛŒØ¯</h2>
            <div class="card">
                <input type="text" id="new-title" placeholder="Ø¹Ù†ÙˆØ§Ù†">
                <select id="new-cat">
                    <option value="book">Ú©ØªØ§Ø¨</option>
                    <option value="movie">ÙÛŒÙ„Ù…</option>
                    <option value="site">Ø³Ø§ÛŒØª</option>
                    <option value="soft">Ù†Ø±Ù… Ø§ÙØ²Ø§Ø±</option>
                </select>
                <textarea id="new-text" rows="6" placeholder="Ù…ØªÙ†..."></textarea>
                <button class="btn btn-primary" style="width:100%" onclick="app.publishPost()">Ø§Ù†ØªØ´Ø§Ø±</button>
            </div>
        </section>

        <!-- 4. Messages -->
        <section id="msg-section" class="container hidden">
            <div class="flex-between">
                <h2>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§</h2>
                <div style="display:flex; gap:10px">
                    <button class="btn-sm btn-outline" onclick="app.renderMessages('chats')">Ú¯ÙØªÚ¯ÙˆÙ‡Ø§</button>
                    <button class="btn-sm btn-outline" onclick="app.renderMessages('req')">Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§</button>
                </div>
            </div>
            <input type="text" placeholder="Ø¬Ø³ØªØ¬Ùˆ..." onkeyup="app.searchChat(this.value)">
            <div id="msg-list" class="card" style="padding:0"></div>
        </section>

        <!-- 5. Settings -->
        <section id="set-section" class="container hidden">
            <h2>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h2>
            <div class="card" style="background:linear-gradient(135deg, #3b82f6, #1d4ed8); color:white">
                <div class="flex-between"><h3 id="set-card-name"></h3><small id="set-card-id"></small></div>
                <div style="margin-top:10px">Ú©Ø¯ Ù…Ù„ÛŒ: <span id="set-card-nc"></span></div>
                <div>Ú©Ø¯ Ø¯Ø¹ÙˆØª: <span id="set-card-code" style="font-weight:bold; font-size:1.2rem"></span></div>
            </div>
            <div class="card">
                <label>Ø¹Ú©Ø³ (Ù„ÛŒÙ†Ú©)</label><input type="text" id="set-pic">
                <label>Ù†Ø§Ù…</label><input type="text" id="set-name">
                <label>Ø¨ÛŒÙˆÚ¯Ø±Ø§ÙÛŒ</label><textarea id="set-bio"></textarea>
                <label>Ù„ÛŒÙ†Ú©</label><input type="text" id="set-link">
                <label>Ù…Ù†Ø´Ù†</label><input type="text" id="set-mention">
                <div class="flex-between"><label>Ø®ØµÙˆØµÛŒ</label> <input type="checkbox" id="set-private" style="width:auto"></div>
                <div class="flex-between"><label>Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…</label> <input type="checkbox" id="set-msg" style="width:auto"></div>
                <button class="btn btn-primary" style="width:100%" onclick="app.saveSettings()">Ø°Ø®ÛŒØ±Ù‡</button>
                <button class="btn btn-outline" style="width:100%; margin-top:10px; color:red" onclick="app.logout()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </section>

        <!-- 6. Search -->
        <section id="search-section" class="container hidden">
            <h2>Ù†ØªØ§ÛŒØ¬</h2>
            <button class="btn-sm btn-outline" onclick="app.nav('home')">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            <div id="search-results-box" style="margin-top:10px"></div>
        </section>

        <nav class="nav-bar">
            <div class="nav-item active" id="nav-home" onclick="app.nav('home')">ğŸ </div>
            <div class="nav-item" id="nav-add" onclick="app.nav('add')">â•</div>
            <div class="nav-item" id="nav-msg" onclick="app.nav('msg')">ğŸ’¬ <span id="badge-msg" class="badge hidden"></span></div>
            <div class="nav-item" id="nav-prof" onclick="app.nav('prof')">ğŸ‘¤</div>
            <div class="nav-item" id="nav-set" onclick="app.nav('set')">âš™ï¸</div>
        </nav>
    </div>

    <!-- MODALS -->
    <div id="share-modal" class="modal-overlay hidden" onclick="if(event.target==this) this.classList.add('hidden')">
        <div class="modal-sheet">
            <div class="modal-header">Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ</div>
            <div class="share-option" onclick="app.shareExternal()"><span>ğŸ“¤</span> Ø§Ø±Ø³Ø§Ù„ Ù„ÛŒÙ†Ú©</div>
            <div class="share-option" onclick="app.shareInternal()"><span>ğŸ’¬</span> Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø®Ù„ÛŒ</div>
            <div class="share-option" onclick="document.getElementById('share-modal').classList.add('hidden')"><span style="color:red">âœ–</span> Ù„ØºÙˆ</div>
        </div>
    </div>
    <div id="user-picker-modal" class="modal-overlay hidden" onclick="if(event.target==this) this.classList.add('hidden')">
        <div class="modal-sheet">
            <div class="modal-header">Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡...</div>
            <input type="text" placeholder="Ø¬Ø³ØªØ¬Ùˆ..." onkeyup="app.filterPicker(this.value)">
            <div id="picker-list"></div>
        </div>
    </div>
    <div id="list-modal" class="modal-overlay hidden" onclick="if(event.target==this) this.classList.add('hidden')">
        <div class="modal-sheet"><div class="modal-header" id="list-title">Ù„ÛŒØ³Øª</div><div id="list-content"></div></div>
    </div>
    <div id="chat-modal" class="hidden" style="position:fixed; top:0; left:0; right:0; bottom:0; background:white; z-index:2000; display:flex; flex-direction:column">
        <div class="card" style="margin:0; border-radius:0; border-bottom:1px solid var(--border); padding:10px; display:flex; align-items:center; justify-content:space-between">
            <div style="font-weight:bold" id="chat-header-name"></div>
            <button class="btn-sm btn-outline" onclick="document.getElementById('chat-modal').classList.add('hidden')">Ø¨Ø³ØªÙ†</button>
        </div>
        <div id="chat-msgs" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:10px; background:var(--bg)"></div>
        <div style="padding:10px; background:white; border-top:1px solid var(--border); display:flex; gap:10px">
            <input type="text" id="chat-input" placeholder="Ù¾ÛŒØ§Ù…..." style="margin:0">
            <button class="btn btn-primary" onclick="app.sendChatMsg()">Ø§Ø±Ø³Ø§Ù„</button>
        </div>
    </div>

    <script>
        // *** Ø§ÛŒÙ†Ø¬Ø§ Ø±Ø§ Ø¨Ø§ Ù„ÛŒÙ†Ú© Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø®ÙˆØ¯ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯ ***
        const API_URL = 'https://script.google.com/macros/s/AKfycbxrM04t-xMe1vKeVHDIRqxjD0emHq-hNgIln92CQSjRiJSS_Mp053MNY-kUzrAizyI/exec'; 

        const app = {
            data: { users: [], posts: [], msgs: [], user: null },
            state: { viewId: null, shareData: null, chatPartner: null },

            init: async function() {
                const uid = sessionStorage.getItem('uid');
                if(!uid) {
                    document.getElementById('auth-section').classList.remove('hidden');
                    return;
                }
                await this.refreshData(); // Fetch from Sheet
                
                const u = this.data.users.find(x => x.id === uid);
                if(u) {
                    this.data.user = u;
                    this.showApp();
                    
                    // Deep Linking
                    const p = new URLSearchParams(location.search);
                    if(p.get('p')) setTimeout(()=>alert('Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø³Øª: '+p.get('p')), 1000); 
                    if(p.get('u')) setTimeout(()=>this.nav('prof', p.get('u')), 1000);
                    
                    setInterval(() => this.refreshData(true), 10000); // Poll every 10s
                } else {
                    document.getElementById('auth-section').classList.remove('hidden');
                }
            },

            refreshData: async function(bg = false) {
                if(!bg) document.getElementById('loading-overlay').classList.remove('hidden');
                try {
                    const res = await fetch(API_URL);
                    const d = await res.json();
                    this.data.users = d.users;
                    this.data.posts = d.posts;
                    this.data.msgs = d.msgs;
                    if(this.data.user) {
                        this.data.user = this.data.users.find(u => u.id === this.data.user.id);
                        this.updateBadges();
                        // Real-time chat update
                        if(!document.getElementById('chat-modal').classList.contains('hidden')) this.renderChatMsgs();
                    }
                } catch(e) { console.error(e); }
                if(!bg) document.getElementById('loading-overlay').classList.add('hidden');
            },

            api: async function(action, payload) {
                // Optimistic UI updates could happen here, but for safety we wait
                document.getElementById('loading-overlay').classList.remove('hidden');
                try {
                    await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors', // Important for GAS
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ action: action, payload: payload })
                    });
                    // Since no-cors returns opaque response, we assume success and refresh
                    await this.refreshData(true); 
                } catch(e) { alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·'); }
                document.getElementById('loading-overlay').classList.add('hidden');
            },

            // --- AUTH ---
            toggleAuth: () => {
                document.getElementById('login-form').classList.toggle('hidden');
                document.getElementById('reg-form').classList.toggle('hidden');
            },
            register: function() {
                const u = {
                    id: document.getElementById('reg-user').value.toLowerCase(),
                    nc: document.getElementById('reg-nc').value,
                    pass: document.getElementById('reg-pass').value,
                    name: document.getElementById('reg-name').value,
                    refCode: document.getElementById('reg-ref-code').value
                };
                if(!u.id || !u.nc || !u.pass) return alert('Ù†Ø§Ù‚Øµ');
                this.api('register', u).then(() => {
                    alert('Ø«Ø¨Øª Ø´Ø¯. ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯');
                    this.toggleAuth();
                });
            },
            login: function() {
                const nc = document.getElementById('login-nc').value;
                const pass = document.getElementById('login-pass').value;
                // Login logic must happen client side after fetch, or via a special server call
                // Since we fetch all users, we check locally
                const u = this.data.users.find(x => x.nc === nc && x.pass === pass);
                if(u) {
                    sessionStorage.setItem('uid', u.id);
                    location.reload();
                } else alert('Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØºÙ„Ø· Ø§Ø³Øª');
            },
            logout: () => { sessionStorage.clear(); location.reload(); },

            showApp: function() {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                this.nav('home');
            },

            // --- NAV ---
            nav: function(page, arg) {
                ['home','profile','add','msg','set','search'].forEach(s => document.getElementById(s+'-section').classList.add('hidden'));
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                
                if(page === 'home') {
                    document.getElementById('home-section').classList.remove('hidden');
                    document.getElementById('nav-home').classList.add('active');
                    this.renderFeed();
                } else if(page === 'prof') {
                    document.getElementById('profile-section').classList.remove('hidden');
                    if(!arg || arg === this.data.user.id) document.getElementById('nav-prof').classList.add('active');
                    this.renderProfile(arg || this.data.user.id);
                } else if(page === 'add') {
                    document.getElementById('add-section').classList.remove('hidden');
                    document.getElementById('nav-add').classList.add('active');
                } else if(page === 'msg') {
                    document.getElementById('msg-section').classList.remove('hidden');
                    document.getElementById('nav-msg').classList.add('active');
                    this.renderMessages('chats');
                } else if(page === 'set') {
                    document.getElementById('set-section').classList.remove('hidden');
                    document.getElementById('nav-set').classList.add('active');
                    this.renderSettings();
                } else if(page === 'search') {
                    document.getElementById('search-section').classList.remove('hidden');
                }
            },

            // --- RENDERERS ---
            renderUser: function(uid, sub='') {
                const u = this.data.users.find(x => x.id === uid);
                if(!u) return 'Unk';
                const pic = u.pic ? `<img src="${u.pic}">` : u.name[0];
                return `<div class="user-block" onclick="event.stopPropagation();app.nav('prof','${u.id}')">
                    <div class="user-avatar-sm">${pic}</div>
                    <div class="user-info-text"><span class="user-name">${u.name}</span><span class="user-id">@${u.id} ${sub}</span></div>
                </div>`;
            },

            renderFeed: function() {
                const con = document.getElementById('feed-container');
                con.innerHTML = '';
                const me = this.data.user;
                // Suggestions
                const scr = document.getElementById('new-members-scroll');
                scr.innerHTML = '';
                this.data.users.filter(u=>u.id!==me.id && !me.following.includes(u.id))
                    .sort(()=>0.5-Math.random()).slice(0,5).forEach(u=>{
                         const pic = u.pic ? `<img src="${u.pic}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">` : u.name[0];
                         scr.innerHTML += `<div style="min-width:70px;text-align:center" onclick="app.nav('prof','${u.id}')">
                            <div style="width:40px;height:40px;border-radius:50%;background:#ddd;margin:auto;display:flex;align-items:center;justify-content:center;overflow:hidden">${pic}</div>
                            <div style="font-size:0.7rem">${u.name}</div>
                         </div>`;
                    });

                // Posts
                let posts = this.data.posts.filter(p => me.following.includes(p.uid) || p.uid === me.id);
                posts.sort((a,b)=>b.time-a.time);
                posts.forEach(p => con.innerHTML += this.postHTML(p));
            },

            postHTML: function(p) {
                const catMap = {book:'Ú©ØªØ§Ø¨', movie:'ÙÛŒÙ„Ù…', site:'Ø³Ø§ÛŒØª', soft:'Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø±'};
                const liked = p.likes.includes(this.data.user.id) ? 'liked' : '';
                return `<div class="card b-${p.cat}">
                    <div class="post-header">${this.renderUser(p.uid, new Date(p.time).toLocaleDateString('fa-IR'))} <span class="post-cat-badge c-${p.cat}">${catMap[p.cat]}</span></div>
                    <h4>${p.title}</h4><div class="post-content">${p.text}</div>
                    <div class="post-actions">
                        <div class="action-btn ${liked}" onclick="app.doLike('${p.pid}')">â¤ï¸ ${p.likes.length}</div>
                        <div class="action-btn" onclick="document.getElementById('c-${p.pid}').classList.toggle('hidden')">ğŸ’¬ ${p.comments.length}</div>
                        <div class="action-btn" onclick="app.initShare('post','${p.pid}')">ğŸ”—</div>
                    </div>
                    <div id="c-${p.pid}" class="hidden" style="margin-top:10px">
                        <div id="cl-${p.pid}">${p.comments.map(c=>`<div class="comment-box">${this.renderUser(c.uid)}: ${c.text}</div>`).join('')}</div>
                        <div style="display:flex;gap:5px;margin-top:5px"><input id="ci-${p.pid}" type="text"><button class="btn btn-primary" onclick="app.doComment('${p.pid}')">âœ”</button></div>
                    </div>
                </div>`;
            },

            // --- ACTIONS ---
            publishPost: function() {
                const p = {
                    pid: this.data.user.id + '_' + Date.now(),
                    uid: this.data.user.id,
                    title: document.getElementById('new-title').value,
                    cat: document.getElementById('new-cat').value,
                    text: document.getElementById('new-text').value,
                    time: Date.now()
                };
                if(!p.title || !p.text) return;
                this.api('createPost', p).then(()=> {
                    alert('Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯'); 
                    document.getElementById('new-title').value='';
                    document.getElementById('new-text').value='';
                    this.nav('home');
                });
            },
            doLike: function(pid) {
                const p = this.data.posts.find(x => x.pid === pid);
                const me = this.data.user.id;
                if(p.likes.includes(me)) p.likes = p.likes.filter(x=>x!==me);
                else p.likes.push(me);
                // Optimistic update locally? No, wait for server sync to be safe, or complex logic.
                // Sending whole arrays back to sheet via updatePost
                this.api('updatePost', { pid: pid, likes: p.likes, comments: p.comments });
            },
            doComment: function(pid) {
                const txt = document.getElementById('ci-'+pid).value;
                if(!txt) return;
                const p = this.data.posts.find(x => x.pid === pid);
                p.comments.push({uid: this.data.user.id, text: txt});
                this.api('updatePost', { pid: pid, likes: p.likes, comments: p.comments });
            },

            // --- PROFILE ---
            renderProfile: function(uid) {
                const me = this.data.user;
                const u = this.data.users.find(x => x.id === uid);
                this.state.viewId = uid;
                const isMe = uid === me.id;

                document.getElementById('prof-back-btn').classList.toggle('hidden', isMe);
                document.getElementById('p-pic').innerHTML = u.pic ? `<img src="${u.pic}">` : u.name[0];
                document.getElementById('p-name').innerText = u.name;
                document.getElementById('p-id').innerText = u.id;
                document.getElementById('p-bio').innerText = u.bio;
                
                // Links
                const lArea = document.getElementById('p-link-area');
                lArea.innerHTML = '';
                if(u.web) lArea.innerHTML += `<div>ğŸŒ <a href="${u.web}">${u.web}</a></div>`;
                if(u.mention) lArea.innerHTML += `<div>ğŸ“£ <span onclick="app.nav('prof','${u.mention}')">@${u.mention}</span></div>`;

                // Stats
                const ups = this.data.posts.filter(p=>p.uid===uid);
                document.getElementById('p-post-count').innerText = ups.length;
                document.getElementById('p-follower-count').innerText = u.followers.length;
                document.getElementById('p-following-count').innerText = u.following.length;

                // Actions
                const acts = document.getElementById('prof-actions');
                if(isMe) acts.classList.add('hidden');
                else {
                    acts.classList.remove('hidden');
                    const bf = document.getElementById('btn-follow');
                    if(me.following.includes(uid)) { bf.innerText='Ø¯Ù†Ø¨Ø§Ù„ Ø´Ø¯Ù‡'; bf.className='btn btn-outline'; bf.onclick=()=>this.actFollow(uid, 'unfollow'); }
                    else if(u.requests.includes(me.id)) { bf.innerText='Ù„ØºÙˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øª'; bf.className='btn btn-outline'; bf.onclick=()=>this.actFollow(uid, 'cancel'); }
                    else { bf.innerText='Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù†'; bf.className='btn btn-primary'; bf.onclick=()=>this.actFollow(uid, 'follow'); }
                    
                    document.getElementById('btn-msg').classList.toggle('hidden', !u.allowMsg);
                }

                // Privacy
                const access = isMe || !u.isPrivate || (u.isPrivate && u.followers.includes(me.id));
                document.getElementById('profile-content').classList.toggle('hidden', !access);
                document.getElementById('private-msg').classList.toggle('hidden', access);
                
                if(access) this.filterProfilePosts('all', document.querySelector('.filter-chip'));
            },

            actFollow: function(uid, type) {
                const me = this.data.user;
                const target = this.data.users.find(x=>x.id===uid);
                
                if(type === 'follow') {
                    if(target.isPrivate) target.requests.push(me.id);
                    else { me.following.push(uid); target.followers.push(me.id); }
                } else if(type === 'unfollow') {
                    me.following = me.following.filter(x=>x!==uid);
                    target.followers = target.followers.filter(x=>x!==me.id);
                } else {
                    target.requests = target.requests.filter(x=>x!==me.id);
                }
                
                // Update BOTH users
                this.api('updateUser', [me, target]);
            },

            filterProfilePosts: function(cat, el) {
                document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active'));
                el.classList.add('active');
                const box = document.getElementById('profile-posts-box');
                box.innerHTML = '';
                let ps = this.data.posts.filter(p=>p.uid===this.state.viewId);
                if(cat!=='all') ps = ps.filter(p=>p.cat===cat);
                ps.sort((a,b)=>b.time-a.time);
                ps.forEach(p=>box.innerHTML+=this.postHTML(p));
            },

            // --- MESSAGES ---
            renderMessages: function(tab) {
                const list = document.getElementById('msg-list');
                list.innerHTML = '';
                const me = this.data.user;

                if(tab === 'req') {
                    me.requests.forEach(rid => {
                        list.innerHTML += `<div style="padding:10px;border-bottom:1px solid #eee;display:flex;justify-content:space-between">
                            ${this.renderUser(rid)}
                            <div><button class="btn-sm btn-success" onclick="app.resReq('${rid}',true)">âœ”</button>
                            <button class="btn-sm btn-danger" onclick="app.resReq('${rid}',false)">âœ–</button></div>
                        </div>`;
                    });
                } else {
                    const partners = new Set();
                    this.data.msgs.forEach(m => {
                        if(m.from===me.id) partners.add(m.to);
                        if(m.to===me.id) partners.add(m.from);
                    });
                    partners.forEach(pid => {
                        const msgs = this.data.msgs.filter(m=>(m.from==me.id&&m.to==pid)||(m.from==pid&&m.to==me.id));
                        const last = msgs.sort((a,b)=>b.time-a.time)[0];
                        list.innerHTML += `<div style="padding:10px;border-bottom:1px solid #eee;cursor:pointer" onclick="app.openChat('${pid}')">
                            ${this.renderUser(pid, last.text.substring(0,15)+'...')}
                        </div>`;
                    });
                }
            },
            resReq: function(uid, acc) {
                const me = this.data.user;
                const u = this.data.users.find(x=>x.id===uid);
                me.requests = me.requests.filter(x=>x!==uid);
                if(acc) { me.followers.push(uid); u.following.push(me.id); }
                this.api('updateUser', [me, u]);
            },
            openChat: function(uid) {
                this.state.chatPartner = uid;
                document.getElementById('chat-modal').classList.remove('hidden');
                document.getElementById('chat-header-name').innerText = uid;
                this.renderChatMsgs();
                // Mark read logic would go here
            },
            renderChatMsgs: function() {
                const pid = this.state.chatPartner;
                const me = this.data.user.id;
                const msgs = this.data.msgs.filter(m=>(m.from==me&&m.to==pid)||(m.from==pid&&m.to==me));
                const box = document.getElementById('chat-msgs');
                box.innerHTML = msgs.sort((a,b)=>a.time-b.time).map(m=> {
                    const bg = m.from===me ? 'var(--primary-light)' : 'white';
                    const al = m.from===me ? 'flex-end' : 'flex-start';
                    return `<div style="align-self:${al};background:${bg};padding:8px;border-radius:8px;max-width:80%;border:1px solid #eee">${m.text}</div>`;
                }).join('');
                box.scrollTop = box.scrollHeight;
            },
            sendChatMsg: function() {
                const txt = document.getElementById('chat-input').value;
                if(!txt) return;
                const m = { from: this.data.user.id, to: this.state.chatPartner, text: txt, time: Date.now(), read: false };
                this.api('createMsg', m).then(()=> {
                    document.getElementById('chat-input').value = '';
                    this.renderChatMsgs();
                });
            },

            // --- SHARE ---
            initShare: function(type, id) {
                const url = location.origin + location.pathname;
                if(type==='profile') this.state.shareData = { text: 'Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ù†', link: url+'?u='+(this.state.viewId||this.data.user.id) };
                else this.state.shareData = { text: 'Ø§ÛŒÙ† Ù¾Ø³Øª Ø±Ø§ Ø¨Ø¨ÛŒÙ†ÛŒØ¯', link: url+'?p='+id };
                document.getElementById('share-modal').classList.remove('hidden');
            },
            shareExternal: function() {
                const d = this.state.shareData;
                if(navigator.share) navigator.share({title:'Share', text:d.text, url:d.link});
                else prompt('Copy link:', d.link);
            },
            shareInternal: function() {
                document.getElementById('share-modal').classList.add('hidden');
                document.getElementById('user-picker-modal').classList.remove('hidden');
                this.filterPicker('');
            },
            filterPicker: function(val) {
                const l = document.getElementById('picker-list');
                l.innerHTML = '';
                this.data.users.filter(u=>u.id!==this.data.user.id && u.id.includes(val)).forEach(u=>{
                    l.innerHTML += `<div style="padding:10px;border-bottom:1px solid #eee;display:flex;justify-content:space-between">
                        ${u.name} <button class="btn-sm btn-primary" onclick="app.doShareInt('${u.id}')">Ø§Ø±Ø³Ø§Ù„</button>
                    </div>`;
                });
            },
            doShareInt: function(uid) {
                const m = { from: this.data.user.id, to: uid, text: this.state.shareData.link, time: Date.now(), read: false };
                this.api('createMsg', m);
                document.getElementById('user-picker-modal').classList.add('hidden');
                alert('Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯');
            },

            // --- SETTINGS ---
            renderSettings: function() {
                const u = this.data.user;
                document.getElementById('set-card-name').innerText = u.name;
                document.getElementById('set-card-id').innerText = '@'+u.id;
                document.getElementById('set-card-nc').innerText = u.nc;
                document.getElementById('set-card-code').innerText = u.refCode;
                document.getElementById('set-pic').value = u.pic||'';
                document.getElementById('set-name').value = u.name;
                document.getElementById('set-bio').value = u.bio;
                document.getElementById('set-link').value = u.web||'';
                document.getElementById('set-mention').value = u.mention||'';
                document.getElementById('set-private').checked = u.isPrivate;
                document.getElementById('set-msg').checked = u.allowMsg;
            },
            saveSettings: function() {
                const u = this.data.user;
                u.pic = document.getElementById('set-pic').value;
                u.name = document.getElementById('set-name').value;
                u.bio = document.getElementById('set-bio').value;
                u.web = document.getElementById('set-link').value;
                u.mention = document.getElementById('set-mention').value;
                u.isPrivate = document.getElementById('set-private').checked;
                u.allowMsg = document.getElementById('set-msg').checked;
                this.api('updateUser', u).then(()=>alert('Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯'));
            },
            
            showList: function(type) {
                const u = this.data.users.find(x=>x.id===this.state.viewId);
                const l = type==='followers'?u.followers:u.following;
                document.getElementById('list-title').innerText=type;
                const c = document.getElementById('list-content'); c.innerHTML='';
                l.forEach(id => c.innerHTML+=`<div style="padding:10px">${this.renderUser(id)}</div>`);
                document.getElementById('list-modal').classList.remove('hidden');
            },
            search: function(q) {
                this.nav('search');
                const b = document.getElementById('search-results-box'); b.innerHTML='';
                this.data.users.filter(u=>u.id.includes(q)||u.name.includes(q)).forEach(u=>b.innerHTML+=`<div class="card">${this.renderUser(u.id)}</div>`);
            },
            updateBadges: function() {
                const u = this.data.msgs.filter(m=>m.to===this.data.user.id && !m.read).length + this.data.user.requests.length;
                const b = document.getElementById('badge-msg');
                if(u>0) { b.innerText=u; b.classList.remove('hidden'); } else b.classList.add('hidden');
            }
        };

        app.init();
    </script>
</body>
</html>
