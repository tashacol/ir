 
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sosial sim</title>
    
    <!-- Modern Font: Vazirmatn -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    
    <!-- Modern Icons: Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root {
            /* Palette: Modern & Professional */
            --p: #2563eb;      /* Primary Blue (Vibrant) */
            --pd: #1d4ed8;     /* Primary Dark */
            --bg: #f3f4f6;     /* Background (Light Gray) */
            --s: #ffffff;      /* Surface (White) */
            --t: #111827;      /* Text Main (Almost Black) */
            --tg: #6b7280;     /* Text Gray */
            --bor: #e5e7eb;    /* Border */
            --err: #ef4444;    /* Error/Like Red */
            --suc: #10b981;    /* Success Green */
            --sh: 0 4px 20px -2px rgba(0,0,0,0.06); /* Ultra Smooth Shadow */
            --rad: 16px;       /* Modern Smooth Radius */
            --font-main: 'Vazirmatn', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family: var(--font-main); -webkit-tap-highlight-color:transparent; outline:none; }
        body { background:var(--bg); color:var(--t); padding-bottom:80px; overflow-x:hidden; user-select:none; font-size: 14px; line-height: 1.5; }
        .con { max-width:480px; margin:0 auto; padding:15px; min-height:100vh; }
        .hide { display:none !important; }
        .flex-bw { display:flex; justify-content:space-between; align-items:center; }
        .flex-c { display:flex; flex-direction:column; }
        
        /* Typography */
        h1, h2, h3, h4 { font-weight: 800; color: var(--t); letter-spacing: -0.5px; }
        
        /* Modern UI Components */
        .card { 
            background:var(--s); 
            border-radius:var(--rad); 
            padding:18px; 
            margin-bottom:15px; 
            box-shadow:var(--sh); 
            border:1px solid rgba(255,255,255,0.5); 
            position:relative; 
            transition:transform 0.2s ease, box-shadow 0.2s ease; 
        }
        .card:active { transform: scale(0.995); }

        /* Modern Input */
        .inp { 
            width:100%; 
            padding:14px 16px; 
            border:1px solid var(--bor); 
            border-radius:12px; 
            background:#f9fafb; 
            font-size:0.95rem; 
            margin-bottom:12px; 
            transition:0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            color: var(--t);
            font-weight: 500;
        }
        .inp:focus { border-color:var(--p); background:var(--s); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        textarea.inp { resize: none; }

        /* Modern Buttons */
        .btn { 
            width:100%; 
            padding:12px; 
            border-radius:12px; 
            font-weight:700; 
            font-size:1rem; 
            display:flex; 
            justify-content:center; 
            align-items:center; 
            gap:8px; 
            cursor:pointer; 
            border:none; 
            transition:0.2s; 
        }
        .btn:active { transform: scale(0.96); }
        .btn-p { 
            background:linear-gradient(135deg, var(--p), var(--pd)); 
            color:white; 
            box-shadow: 0 4px 12px rgba(37,99,235,0.3);
        }
        .btn-o { border:1.5px solid var(--bor); color:var(--t); background:transparent; font-weight: 600; }
        .btn-s { padding:6px 14px; font-size:0.85rem; width:auto; border-radius:8px; }
        .btn-i { font-size:1.6rem; padding:4px; color:var(--t); background:transparent; border:none; cursor:pointer; display:flex; align-items:center; transition: color 0.2s; }
        .btn-i:hover { color: var(--p); }
        
        /* Password Toggle */
        .pwd-wrap { position: relative; margin-bottom: 12px; }
        .pwd-wrap .inp { margin-bottom: 0; }
        .pwd-tog { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); cursor: pointer; color:var(--tg); z-index:5; font-size: 1.3rem; display:flex; align-items:center;}

        /* Loading Spinner */
        .loading { position:relative; color:transparent !important; pointer-events:none; }
        .loading::after { content:""; position:absolute; left:50%; top:50%; width:22px; height:22px; border:2.5px solid #fff; border-top-color:transparent; border-radius:50%; animation:rot 0.8s linear infinite; transform:translate(-50%,-50%); }
        @keyframes rot { to { transform:translate(-50%,-50%) rotate(360deg); } }

        /* Skeleton */
        .skel { background:linear-gradient(90deg, #f3f4f6 25%, #ffffff 50%, #f3f4f6 75%); background-size:200% 100%; animation:shm 1.5s infinite; border-radius:6px; }
        @keyframes shm { 0% { background-position:200% 0; } 100% { background-position:-200% 0; } }
        .sk-av { width:48px; height:48px; border-radius:50%; }
        .sk-ln-sm { height:12px; width:40%; border-radius:6px; }
        .sk-ln-md { height:12px; width:60%; border-radius:6px; }
        .skel-card .flex-bw { margin-bottom: 15px; }

        /* Avatar */
        .u-blk { display:flex; align-items:center; gap:12px; cursor:pointer; }
        .u-img { width:46px; height:46px; border-radius:50%; object-fit:cover; background:#e5e7eb; border:2px solid var(--s); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .u-nm { font-weight:700; font-size:0.95rem; color:var(--t); }
        .u-id { font-size:0.8rem; color:var(--tg); }

        /* Bottom Nav (Fixed & Improved) */
        .nav { 
            position:fixed; bottom:20px; left:50%; transform:translateX(-50%); 
            width:90%; max-width:440px;
            background:rgba(255,255,255,0.9); 
            backdrop-filter:blur(12px); 
            -webkit-backdrop-filter:blur(12px);
            border-radius:24px;
            border:1px solid rgba(255,255,255,0.4); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display:flex; justify-content:space-around; align-items: center;
            padding:12px 10px; z-index:900; 
        }
        .n-it { 
            font-size:1.8rem; 
            color:#9ca3af; /* Inactive Color */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            position:relative; 
            cursor:pointer; 
            display:flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            border-radius: 12px;
        }
        /* Active State - NOT HIDDEN */
        .n-it.active { 
            color: var(--p); /* Primary Blue */
            background: rgba(37,99,235,0.08);
            transform: translateY(-2px);
        }
        .n-it.active i { font-weight: fill; } 
        .n-it i { font-weight: regular; }
        
        .bdg { position:absolute; top:4px; right:4px; background:var(--err); color:white; font-size:0.6rem; padding:2px 6px; border-radius:10px; border:2px solid var(--s); font-weight:bold; min-width:18px; text-align:center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        /* Profile Header */
        .p-top { display:flex; align-items:center; gap:20px; margin-bottom:15px; }
        .p-pic { width:85px; height:85px; border-radius:50%; border:3px solid var(--s); box-shadow: 0 4px 10px rgba(0,0,0,0.1); object-fit:cover; background:#e5e7eb; cursor: pointer; }
        .p-sts { flex:1; display:flex; justify-content:space-around; text-align:center; }
        .st-n { font-weight:800; font-size:1.2rem; display:block; color:var(--t); }
        .st-l { font-size:0.85rem; color:var(--tg); }
        
        .chips { display:flex; gap:8px; overflow-x:auto; padding:5px 0 15px; scrollbar-width:none; }
        .chip { padding:8px 18px; border-radius:12px; background:var(--s); border:1px solid var(--bor); white-space:nowrap; font-size:0.9rem; transition:0.2s; cursor:pointer; color:var(--tg); font-weight:600; }
        .chip.active { background:var(--t); color:white; border-color:var(--t); transform: scale(1.02); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        
        .p-pic-fallback { width:85px; height:85px; border-radius:50%; border:3px solid var(--s); box-shadow: 0 4px 10px rgba(0,0,0,0.1); background:linear-gradient(135deg,#f09433,#bc1888); display: flex; align-items: center; justify-content: center; font-size: 2.2rem; color: white; font-weight: bold; cursor: pointer; }

        /* Feed Post */
        .p-act { display:flex; justify-content:space-between; align-items:center; margin-top:12px; padding-top:12px; border-top: 1px solid #f3f4f6; }
        .p-act-left { display: flex; gap: 18px; }
        .act-b { display:flex; align-items:center; gap:5px; cursor:pointer; font-size:1.6rem; color: var(--t); transition:0.2s; }
        .act-b:active { transform: scale(0.9); }
        .act-b:hover { color: var(--p); }
        .act-b.lk { color:var(--err); }
        .act-b.lk:hover { color: var(--err); }
        .act-b.lk i { font-weight: fill; animation: pop 0.3s; }
        @keyframes pop { 50% { transform:scale(1.2); } }
        
        .ment { color:var(--p); font-weight:700; cursor:pointer; text-decoration:none; }
        .url-link { color: var(--p); text-decoration: none; font-weight: 600; cursor: pointer; }
        .post-opts-btn { font-size:1.4rem; color:var(--tg); cursor:pointer; position:absolute; left:16px; top:16px; padding: 5px; }
        
        .p-menu { position: absolute; left: 16px; top: 45px; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border:1px solid var(--bor); z-index: 100; overflow: hidden; display: none; width: 140px; animation: fadeIn 0.15s ease; }
        .p-menu.show { display: block; }
        .p-menu-item { padding: 12px; font-size: 0.95rem; cursor: pointer; transition: 0.1s; display: flex; align-items: center; gap: 10px; color: var(--t); font-weight: 500; }
        .p-menu-item:hover { background: #f9fafb; }
        .p-menu-item.del { color: var(--err); }

        /* Upload */
        .prog-c { position:relative; height:6px; background:#e5e7eb; width:100%; margin-top:15px; border-radius:3px; overflow:hidden; display:none; }
        .fill { height:100%; background:var(--p); width:0%; transition:width 0.4s ease-out; }
        .up-msg { font-size:0.9rem; color:var(--suc); text-align:center; display:none; margin-top:10px; font-weight:700; animation:fadeIn 0.5s; }
        .sending { opacity:0.8; pointer-events:none; border:none; background:#fff; }

        /* Chat */
        .tik { font-size:0.85rem; margin-right:4px; vertical-align:middle; display:inline-flex; }
        .tik.wait { color:#cbd5e1; }
        .tik.sent { color:#9ca3af; }
        .tik.read { color:#2563eb; }
        
        .msg-bub { padding:12px 16px; border-radius:20px; max-width:82%; margin-bottom:8px; position:relative; word-wrap:break-word; font-size: 0.95rem; line-height: 1.5; user-select: none; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .msg-me { background:linear-gradient(135deg, #3b82f6, #2563eb); color:white; align-self:flex-end; border-bottom-left-radius:20px; border-bottom-right-radius:4px; }
        .msg-me .url-link, .msg-me .ment { color: white; text-decoration: underline; }
        .msg-me.pending { opacity: 0.7; }
        .msg-ot { background:white; color:var(--t); align-self:flex-start; border-bottom-left-radius:4px; border:1px solid var(--bor); }
        .msg-tm { font-size:0.7rem; margin-top:4px; display:flex; align-items:center; justify-content:flex-end; opacity:0.8; gap: 3px; font-weight: 500; }
        
        /* Modals */
        .mod-bg { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index:3000; display:flex; align-items:flex-end; justify-content:center; opacity:0; pointer-events:none; transition:0.3s; }
        .mod-bg.show { opacity:1; pointer-events:all; }
        .mod { background:var(--s); width:100%; max-width:480px; border-radius:24px 24px 0 0; padding:25px; max-height:85vh; overflow-y:auto; transform:translateY(100%); transition:transform 0.3s cubic-bezier(0.165, 0.84, 0.44, 1); box-shadow: 0 -10px 40px rgba(0,0,0,0.1); }
        .mod-bg.show .mod { transform:translateY(0); }
        
        /* Settings Page Modernization */
        .set-grp { background: var(--s); border: 1px solid var(--bor); border-radius: 16px; overflow: hidden; margin-bottom: 25px; box-shadow: var(--sh); }
        .set-it { padding: 18px; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; justify-content: space-between; font-size: 1rem; transition: 0.2s; }
        .set-it:active { background: #f9fafb; }
        .set-it:last-child { border-bottom: none; }
        .set-it label { display: flex; align-items: center; gap: 12px; width: 100%; cursor: pointer; font-weight: 500; }
        .set-it i { font-size: 1.5rem; color: var(--tg); }
        
        /* Toast */
        #tst { position:fixed; top:20px; left:50%; transform:translateX(-50%) translateY(-100px); background:#1f2937; color:white; padding:12px 24px; border-radius:50px; z-index:4000; font-size:0.95rem; opacity:0; transition:0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display:flex; align-items:center; gap:10px; box-shadow:0 10px 25px rgba(0,0,0,0.2); font-weight: 600; }
        #tst.show { opacity:1; transform:translateX(-50%) translateY(0); }
        #tst i { font-size: 1.3rem; }

        /* Shared Post in Chat */
        .msg-post-share { border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; padding: 12px; cursor: pointer; background-color: rgba(255,255,255,0.15); margin: -4px -4px 4px -4px; }
        .msg-me .msg-post-share { background-color: rgba(255,255,255,0.25); border: none; }
        .msg-post-share .u-nm { font-size: 0.85rem; opacity: 0.95; font-weight: bold; }
        .msg-post-share-title { font-weight: 700; margin-top: 6px; font-size: 0.95rem; }
        .msg-post-share-text { font-size: 0.8rem; opacity: 0.85; margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Other Screens */
        #sc-ch, #sc-post { position:fixed; top:0; left:0; right:0; bottom:0; background:var(--bg); z-index:2000; display:flex; flex-direction:column; transform:translateX(100%); transition:transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #sc-ch.show, #sc-post.show { transform:translateX(0); }
        .chat-input-area { padding:12px 15px; background:var(--s); display:flex; gap:12px; border-top:1px solid var(--bor); align-items: flex-end; padding-bottom: 25px; box-shadow: 0 -2px 10px rgba(0,0,0,0.03); }
        
        /* New Box (Suggested Users) */
        #new-bx { display:flex; gap:12px; overflow-x:auto; padding:5px; scrollbar-width:none; }

        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
    </style>
</head>
<body>

<div id="tst"><i class="ph ph-info"></i> <span>پیام</span></div>

<!-- AUTHENTICATION -->
<div id="scr-auth" class="con" style="height:100vh; display:flex; flex-direction:column; justify-content:center; position:relative; z-index:10; background: linear-gradient(180deg, var(--bg) 0%, #e0f2fe 100%);">
    <div style="text-align:center; margin-bottom:40px; animation:pop 1s;">
        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--p), var(--pd)); border-radius: 20px; margin: 0 auto 15px auto; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(37,99,235,0.4);">
             <i class="ph ph-chats-circle" style="font-size: 3rem; color: white;"></i>
        </div>
        <h1 style="font-family: 'Segoe UI', sans-serif; font-size: 2.5rem; letter-spacing: -1.5px; color: var(--p);">Sosial sim</h1>
        <p style="color: var(--tg); font-size: 1rem;">شبکه اجتماعی نسل جدید</p>
    </div>

<div id="f-log">
    <div class="card" style="padding: 30px 25px; border: none; box-shadow: 0 15px 40px rgba(0,0,0,0.08);">
        <input type="text" id="l-nc" class="inp" placeholder="کد ملی" inputmode="numeric">
        <div class="pwd-wrap">
            <input type="password" id="l-ps" class="inp" placeholder="رمز عبور">
            <span class="pwd-tog" onclick="app.togPwd('l-ps', this)"><i class="ph ph-eye"></i></span>
        </div>
        <div style="margin-bottom:25px; font-size:0.9rem; color:var(--tg)"><label style="display:flex; align-items:center; gap:10px; cursor: pointer;"><input type="checkbox" id="l-rem" checked style="transform: scale(1.2);"> مرا به خاطر بسپار</label></div>
        <button class="btn btn-p" onclick="app.login(this)">ورود به حساب</button>
    </div>
    <div style="text-align:center; margin-top:25px;">
        <span style="color:var(--tg); font-size: 0.95rem;">حساب کاربری ندارید؟</span>
        <span style="color:var(--p); cursor:pointer; font-weight:700; margin-right: 5px;" onclick="app.togAuth()">ثبت نام کنید</span>
    </div>
</div>

<div id="f-reg" class="hide">
    <div class="card" style="padding: 30px 25px; border: none; box-shadow: 0 15px 40px rgba(0,0,0,0.08);">
        <h2 style="text-align:center; margin-bottom:25px;">ایجاد حساب کاربری</h2>
        <input type="number" id="r-nc" class="inp" placeholder="کد ملی (۱۰ رقم)" inputmode="numeric">
        <input type="text" id="r-nm" class="inp" placeholder="نام نمایشی (فارسی)">
        <input type="text" id="r-us" class="inp" placeholder="نام کاربری (انگلیسی)">
        <input type="number" id="r-rf" class="inp" placeholder="کد معرف (اختیاری)" inputmode="numeric">
        <div class="pwd-wrap">
            <input type="password" id="r-ps" class="inp" placeholder="رمز عبور (حداقل ۸ رقم)">
            <span class="pwd-tog" onclick="app.togPwd('r-ps', this)"><i class="ph ph-eye"></i></span>
        </div>
        <button class="btn btn-p" onclick="app.reg(this)">تکمیل ثبت نام</button>
    </div>
    <div style="text-align:center; margin-top:25px;">
        <span style="color:var(--p); cursor:pointer; font-weight:700;" onclick="app.togAuth()">بازگشت به ورود</span>
    </div>
</div>
</div>

<!-- MAIN APP -->
<div id="scr-app" class="hide">

<!-- HOME FEED -->
<section id="s-hm" class="con" style="padding-top: 10px;">
    <div class="flex-bw" style="margin-bottom:20px; padding:0 5px">
        <h2 style="font-family: 'Segoe UI', sans-serif; font-size:1.8rem; letter-spacing: -1px; color: var(--p);">Sosial sim</h2>
        <div style="font-size:1.8rem; cursor:pointer; position:relative; display: flex; color: var(--t);" onclick="app.showNotifs()">
            <i class="ph ph-bell"></i>
            <span id="notif-badge" class="bdg hide" style="top:0; right:0;"></span>
        </div> 
    </div>
    
    <div style="position: relative; margin-bottom: 25px;">
        <i class="ph ph-magnifying-glass" style="position: absolute; right: 15px; top: 14px; color: var(--tg); font-size: 1.2rem;"></i>
        <input type="text" id="hm-sr" class="inp" placeholder="جستجوی کاربر..." onkeyup="app.checkSearch(this)" style="border-radius:14px; border:none; background:white; padding-right: 45px; margin-bottom: 0; box-shadow: var(--sh);">
    </div>
    
    <div style="margin-bottom:25px;">
        <h4 style="margin-bottom:10px; font-size:0.95rem; color:var(--tg); padding-right: 5px;">پیشنهاد برای شما</h4>
        <div id="new-bx"></div>
    </div>

    <div id="feed-up"></div> 
    <div id="feed"></div>
    <div id="feed-ldr" style="text-align:center; padding:30px; display:none"><span class="loading" style="color:var(--tg)!important"></span></div>
    <button id="hm-more" class="btn btn-o hide" style="border:none; color:var(--p); background: rgba(37,99,235,0.05);" onclick="app.loadOldPosts()">مشاهده پست‌های قدیمی‌تر</button>
</section>

<!-- PROFILE -->
<section id="s-pr" class="con hide">
    <div style="background:var(--s); margin:-15px -15px 15px -15px; padding:20px 20px; border-bottom:1px solid var(--bor); border-radius: 0 0 30px 30px; box-shadow: var(--sh);">
        <div class="flex-bw" style="margin-bottom:25px">
            <button class="btn-i" id="bp-bk" onclick="app.nav('hm')"><i class="ph ph-arrow-right"></i></button>
            <h3 id="p-hd" style="font-size:1.1rem; font-weight: 800;"></h3>
            <button class="btn-i" id="p-mn-btn" onclick="app.togProfMenu(event)"><i class="ph ph-dots-three-vertical" style="font-weight: bold;"></i></button>
            
            <div id="p-mn" class="p-menu">
                <div class="p-menu-item" onclick="app.share('prof')"><i class="ph ph-share-network"></i> اشتراک‌گذاری</div>
                <div id="mn-blk" class="p-menu-item del" onclick="app.block()"><i class="ph ph-prohibit"></i> مسدود کردن</div>
            </div>
        </div>
        
        <div class="p-top">
            <div id="p-pic-con"></div>
            <div class="p-sts">
                <div onclick="app.list('posts')"><span class="st-n" id="c-pt">0</span><span class="st-l">پست</span></div>
                <div onclick="app.list('fol')"><span class="st-n" id="c-fl">0</span><span class="st-l">دنبال‌کننده</span></div>
                <div onclick="app.list('fing')"><span class="st-n" id="c-fi">0</span><span class="st-l">دنبال‌شونده</span></div>
            </div>
        </div>
        
        <div style="margin-top: 15px;">
            <h3 id="p-nm" style="font-size: 1.3rem;"></h3>
            <div style="color:var(--tg); font-size:0.95rem; margin-bottom:8px; font-weight: 500;" dir="ltr">@<span id="p-id"></span></div>
            <p id="p-bi" style="font-size:0.95rem; line-height:1.6; color:var(--t); white-space: pre-wrap;"></p>
            <div id="p-lnk" style="margin-top:8px; font-size:0.95rem; color:var(--pd); font-weight: 600;"></div>
            
            <div class="flex-bw" id="p-act" style="margin-top:20px; gap:10px; border-top: none; padding-top: 0;">
                <button id="b-fl" class="btn btn-p" onclick="app.fol()">دنبال کردن</button>
                <button id="b-msg" class="btn btn-o" onclick="app.chat(app.st.vid)">پیام</button>
            </div>
        </div>
    </div>

    <div id="p-con">
        <div class="chips" style="padding: 0 5px 20px 5px;">
            <span class="chip active" onclick="app.flt('all',this)">همه پست‌ها</span>
            <span class="chip" onclick="app.flt('book',this)">کتاب</span>
            <span class="chip" onclick="app.flt('movie',this)">فیلم</span>
            <span class="chip" onclick="app.flt('site',this)">سایت</span>
        </div>
        <div id="p-pts" style="padding-bottom:20px"></div>
    </div>
    <div id="p-lck" class="card hide" style="text-align:center; padding:60px 20px; border:none; box-shadow:none; background: transparent;">
        <i class="ph ph-lock-key" style="font-size: 5rem; color: var(--tg); opacity: 0.5;"></i>
        <h3 style="margin-top: 20px; color: var(--t);">این حساب خصوصی است</h3>
        <p style="color:var(--tg); font-size: 1rem; margin-top: 10px;">برای مشاهده پست‌ها و فعالیت‌ها باید این کاربر را دنبال کنید.</p>
    </div>
</section>

<!-- ADD POST -->
<section id="s-ad" class="con hide">
    <div class="flex-bw" style="margin-bottom: 25px;">
         <h2 id="a-header" style="font-size: 1.5rem;">پست جدید</h2>
         <button style="color:var(--p); font-weight:bold; cursor:pointer; font-size: 1rem; background: none; border: none;" id="btn-pub" onclick="app.pub(this)">انتشار</button>
    </div>
    
    <div class="card" id="post-card" style="padding:20px; border:none; box-shadow:none; background:transparent;">
        <div style="display:flex; gap: 15px; margin-bottom: 20px;">
             <div class="u-img" style="width: 55px; height: 55px; flex-shrink: 0; display:flex; align-items:center; justify-content:center; background:#f3f4f6;" id="add-post-av"><i class="ph ph-user"></i></div>
             <textarea id="a-tx" class="inp" rows="6" placeholder="چه چیزی در ذهن دارید؟..." style="border:none; background:transparent; padding: 10px 0; font-size: 1.1rem;"></textarea>
        </div>
        
        <div style="border-top: 1px solid var(--bor); padding-top: 20px;">
             <input type="text" id="a-ti" class="inp" placeholder="عنوان پست (اختیاری)" style="border:none; border-bottom: 1px solid var(--bor); border-radius: 0; padding-left:0; padding-right:0; background: transparent;">
             
             <div class="flex-bw" style="margin-top: 20px;">
                 <label style="color:var(--t); font-weight:700; display: flex; align-items: center; gap: 8px;"><i class="ph ph-tag" style="font-size: 1.2rem; color: var(--tg);"></i> دسته‌بندی</label>
                 <select id="a-ct" class="inp" style="width: auto; margin:0; border:none; color:var(--p); font-weight:bold; background: transparent; cursor: pointer;"></select>
             </div>
        </div>

        <div class="prog-c" id="p-prg"><div class="fill" id="p-fil"></div></div>
        <div class="up-msg" id="p-msg"><i class="ph ph-check-circle"></i> آپلود موفقیت‌آمیز بود!</div>
        
        <button class="btn btn-o" style="margin-top:30px; display:none; border-color: var(--err); color: var(--err);" id="btn-cncl-edit" onclick="app.cancelEdit()">لغو ویرایش</button>
    </div>
</section>

<!-- MESSAGES -->
<section id="s-ms" class="con hide">
    <div class="flex-bw" style="margin-bottom:25px">
        <h2 style="font-size: 1.6rem;">پیام‌ها</h2>
        <div style="background: var(--s); padding: 8px; border-radius: 50%; box-shadow: var(--sh);">
            <i class="ph ph-pencil-simple" style="font-size: 1.5rem; color: var(--p);"></i>
        </div>
    </div>
    <div style="position: relative; margin-bottom: 25px;">
        <i class="ph ph-magnifying-glass" style="position: absolute; right: 15px; top: 14px; color: var(--tg); font-size: 1.2rem;"></i>
        <input type="text" class="inp" placeholder="جستجوی گفتگو..." onkeyup="app.filterChats(this.value)" style="border-radius:14px; border:none; background:white; padding-right: 45px; margin-bottom: 0; box-shadow: var(--sh);">
    </div>
    
    <div id="req-box"></div> 
    <div id="msg-bx"></div>
</section>

<!-- SETTINGS (MODERNIZED) -->
<section id="s-st" class="con hide">
    <h2 style="margin-bottom:25px; font-size: 1.6rem;">تنظیمات</h2>
    
    <!-- Profile Card -->
    <div class="set-grp" style="text-align: center; padding: 30px 20px; position: relative; overflow: visible;">
        <div style="width: 90px; height: 90px; margin: 0 auto 15px auto; position: relative;">
            <img id="st-av-img" src="" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; background: #f3f4f6; display:none; border: 4px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
            <div id="st-av-ph" style="width: 100%; height: 100%; border-radius: 50%; background: #f3f4f6; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: var(--tg); border: 4px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1);"><i class="ph ph-user"></i></div>
            <div style="position: absolute; bottom: 0; right: 0; background: var(--p); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white;"><i class="ph ph-camera"></i></div>
        </div>
        <h3 id="st-nm" style="font-size: 1.4rem;"></h3>
        <div id="st-id" style="color: var(--tg); font-size: 1rem; font-weight: 500;" dir="ltr"></div>
        <div style="margin-top: 10px; font-size: 0.85rem; background: #e0f2fe; color: var(--pd); display: inline-block; padding: 4px 10px; border-radius: 8px; font-weight: 600;">کد دعوت: <span id="st-cd"></span></div>
    </div>

    <!-- Account Edit -->
    <h4 style="margin: 20px 10px 12px; font-size: 0.95rem; color: var(--tg); text-transform: uppercase; letter-spacing: 0.5px;">اطلاعات حساب</h4>
    <div class="set-grp">
        <div class="set-it">
            <input type="text" id="st-pc" class="inp" placeholder="لینک تصویر پروفایل" style="margin:0; border:none; background:transparent;">
            <i class="ph ph-image"></i>
        </div>
        <div class="set-it">
            <input type="text" id="st-nn" class="inp" placeholder="نام نمایشی" style="margin:0; border:none; background:transparent;">
            <i class="ph ph-user-circle"></i>
        </div>
        <div class="set-it">
            <textarea id="st-bi" class="inp" placeholder="بیوگرافی" rows="1" style="margin:0; border:none; background:transparent;"></textarea>
            <i class="ph ph-text-aa"></i>
        </div>
        <div class="set-it">
            <input type="text" id="st-ln" class="inp" placeholder="وب‌سایت" style="margin:0; border:none; background:transparent;">
            <i class="ph ph-link"></i>
        </div>
    </div>

    <!-- Privacy & Settings -->
    <h4 style="margin: 20px 10px 12px; font-size: 0.95rem; color: var(--tg); text-transform: uppercase; letter-spacing: 0.5px;">امنیت و حریم خصوصی</h4>
    <div class="set-grp">
        <div class="set-it">
            <label><i class="ph ph-lock-key"></i> حساب خصوصی</label>
            <input type="checkbox" id="st-pr" style="transform:scale(1.3); accent-color: var(--p);">
        </div>
        <div class="set-it">
            <label><i class="ph ph-chat-teardrop-dots"></i> دریافت پیام از همه</label>
            <input type="checkbox" id="st-al" style="transform:scale(1.3); accent-color: var(--p);">
        </div>
    </div>

    <!-- Custom Categories -->
    <h4 style="margin: 20px 10px 12px; font-size: 0.95rem; color: var(--tg); text-transform: uppercase; letter-spacing: 0.5px;">دسته‌بندی‌ها (<span id="cat-count">0</span>/20)</h4>
    <div class="set-grp" style="padding: 20px;">
        <div id="st-cats-list" style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:15px;"></div>
        <div class="flex-bw" style="gap:10px;">
            <input type="text" id="st-new-cat" class="inp" placeholder="افزودن دسته جدید..." maxlength="10" style="margin:0;">
            <button class="btn btn-s btn-p" style="height: 46px; width: 46px; border-radius: 12px;" onclick="app.addCat()"><i class="ph ph-plus" style="font-size: 1.2rem;"></i></button>
        </div>
    </div>

    <!-- Blocked Users -->
    <h4 style="margin: 20px 10px 12px; font-size: 0.95rem; color: var(--tg); text-transform: uppercase; letter-spacing: 0.5px;">لیست سیاه</h4>
    <div class="set-grp" style="padding: 0;">
        <div id="st-blk-list" style="max-height:180px; overflow-y:auto; padding: 10px;"></div>
    </div>

    <div style="margin-top: 30px; display: flex; flex-direction: column; gap: 12px;">
        <button class="btn btn-p" onclick="app.sav(this)">ذخیره تغییرات</button>
        <button class="btn btn-o" style="color:var(--err); border-color:var(--bor); background: white;" onclick="app.out()">خروج از حساب</button>
    </div>
</section>

<!-- SEARCH RESULTS -->
<section id="s-sr" class="con hide">
    <div class="flex-bw" style="margin-bottom: 25px;">
        <button class="btn-i" onclick="app.nav('hm')"><i class="ph ph-arrow-right"></i></button>
        <h3>جستجو</h3>
        <div style="width: 32px;"></div>
    </div>
    
    <div class="flex-bw" style="gap:10px; margin-bottom: 20px;">
        <input type="text" id="sr-inp" class="inp" placeholder="شناسه کاربری را وارد کنید..." style="margin:0">
        <button class="btn btn-p" style="width:auto; padding: 0 15px;" onclick="app.doSearch()"><i class="ph ph-magnifying-glass" style="font-size: 1.2rem;"></i></button>
    </div>
    
    <div id="sr-res"></div>
    <button id="sr-more" class="btn btn-o hide" onclick="app.loadMoreSearch()">نمایش نتایج بیشتر</button>
</section>

<!-- SINGLE POST VIEW -->
<div id="sc-post">
    <div class="con">
         <div class="flex-bw" style="margin-bottom:15px; border-bottom:1px solid var(--bor); padding-bottom:15px;">
            <button class="btn-i" onclick="app.closePostView()"><i class="ph ph-arrow-right"></i></button>
            <h3 style="font-size: 1.1rem;">جزییات پست</h3>
            <div style="width:30px"></div>
        </div>
        <div id="sc-post-content"></div>
    </div>
</div>

<!-- BOTTOM NAV -->
<div class="nav">
    <div class="n-it active" id="n-hm" onclick="app.nav('hm')"><i class="ph ph-house"></i></div>
    <div class="n-it" id="n-ad" onclick="app.nav('ad')"><i class="ph ph-plus-circle"></i></div>
    <div class="n-it" id="n-ms" onclick="app.nav('ms')"><i class="ph ph-chat-teardrop-text"></i> <span id="b-nv" class="bdg hide"></span></div>
    <div class="n-it" id="n-pr" onclick="app.nav('pr')"><i class="ph ph-user"></i></div>
    <div class="n-it" id="n-st" onclick="app.nav('st')"><i class="ph ph-gear"></i></div>
</div>
</div>

<!-- MODALS -->
<div id="m-sh" class="mod-bg" onclick="if(event.target==this) this.classList.remove('show')">
    <div class="mod">
        <h3 style="text-align: center; margin-bottom: 25px;">اشتراک‌گذاری</h3>
        <div class="set-grp">
             <div class="set-it" onclick="app.copyLink()" style="cursor: pointer;">
                 <label><i class="ph ph-link"></i> کپی کردن لینک</label>
                 <i class="ph ph-caret-left" style="font-size: 1rem;"></i>
             </div>
             <div class="set-it" onclick="app.doSh()" style="cursor: pointer;">
                 <label><i class="ph ph-share-network"></i> ارسال به برنامه دیگر</label>
                 <i class="ph ph-caret-left" style="font-size: 1rem;"></i>
             </div>
        </div>
    </div>
</div>

<div id="m-pk" class="mod-bg" onclick="if(event.target==this) this.classList.remove('show')">
    <div class="mod">
        <h3 id="pk-tt" style="margin-bottom: 15px;">ارسال به...</h3>
        <div style="position: relative;">
            <i class="ph ph-magnifying-glass" style="position: absolute; right: 12px; top: 12px; color: var(--tg);"></i>
            <input type="text" class="inp" onkeyup="app.flP(this.value)" placeholder="جستجو در مخاطبین..." style="padding-right: 35px;">
        </div>
        <div id="pk-ls" style="max-height:300px; overflow-y:auto; margin-top:10px"></div>
    </div>
</div>

<div id="m-ls" class="mod-bg" onclick="if(event.target==this) this.classList.remove('show')">
    <div class="mod">
        <h3 id="ls-tt" style="margin-bottom: 15px;">لیست</h3>
        <div id="ls-bd" style="max-height:400px; overflow-y:auto"></div>
    </div>
</div>

<div id="m-cm" class="mod-bg" onclick="if(event.target==this) this.classList.remove('show')">
    <div class="mod" style="height: 80vh; max-height: 80vh; display: flex; flex-direction: column; padding: 0;">
        <div style="padding: 18px; border-bottom: 1px solid var(--bor); text-align: center; background: white; border-radius: 24px 24px 0 0;"><h3>نظرات</h3></div>
        <div id="cm-bd" style="flex: 1; overflow-y:auto; padding: 15px; background: #f9fafb;"></div>
        <div class="chat-input-area" style="padding-bottom: 25px; padding-top: 15px; background: white;">
            <div style="width: 42px; height: 42px; border-radius: 50%; background: #f3f4f6; display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; border: 1px solid var(--bor);" id="cm-av">
                <i class="ph ph-user"></i>
            </div>
            <textarea id="cm-in" class="chat-textarea" placeholder="نظر خود را بنویسید..." style="height:46px; min-height:46px; border-radius: 23px; padding: 12px 18px; border: 1px solid var(--bor); background: #f9fafb;"></textarea>
            <button class="btn btn-p" style="width:auto; border-radius: 50%; width: 46px; height: 46px; padding: 0;" onclick="app.sndC(this)"><i class="ph ph-paper-plane-right" style="font-size: 1.3rem;"></i></button>
        </div>
    </div>
</div>

<div id="m-nt" class="mod-bg" onclick="if(event.target==this) this.classList.remove('show')">
    <div class="mod">
        <h3 style="margin-bottom: 20px;">اعلان‌ها</h3>
        <div id="nt-bd" style="max-height:450px; overflow-y:auto"></div>
    </div>
</div>

<div id="m-mo" class="mod-bg" onclick="if(event.target==this) this.classList.remove('show')">
    <div class="mod">
        <div class="set-grp" style="margin-bottom: 0;">
            <div class="set-it" onclick="app.doCopyMsg()" style="cursor: pointer;">
                <label><i class="ph ph-copy"></i> کپی متن پیام</label>
            </div>
            <div class="set-it" onclick="app.doDeleteMsg()" style="cursor: pointer; color: var(--err);">
                <label style="color: var(--err);"><i class="ph ph-trash"></i> حذف پیام</label>
            </div>
        </div>
    </div>
</div>

<div id="m-img" class="mod-bg" onclick="this.classList.remove('show')" style="z-index: 5000; background: rgba(0,0,0,0.95);">
    <img id="img-vw" src="" onclick="event.stopPropagation()" style="border-radius: 8px; border: none; box-shadow: 0 10px 50px rgba(0,0,0,0.5); max-height: 90vh; max-width: 95vw;">
</div>

<!-- CHAT SCREEN -->
<div id="sc-ch">
    <div class="flex-bw" style="padding:15px; border-bottom:1px solid var(--bor); background:rgba(255,255,255,0.9); backdrop-filter:blur(10px)">
        <div style="display: flex; align-items: center; gap: 12px;">
            <button class="btn-i" onclick="document.getElementById('sc-ch').classList.remove('show')"><i class="ph ph-arrow-right"></i></button>
            <div id="ch-inf" style="cursor:pointer; display:flex; align-items:center; gap:10px" onclick="app.nav('pr', app.st.cpid)">
                <img id="ch-im" src="" style="width:40px; height:40px; border-radius:50%; background:#f3f4f6; object-fit: cover; border: 1px solid var(--bor);">
                <div>
                    <div style="font-weight:700; font-size:1rem" id="ch-hd"></div>
                    <div style="font-size:0.75rem; color:var(--suc); display: flex; align-items: center; gap: 4px;"><div style="width: 6px; height: 6px; background: var(--suc); border-radius: 50%;"></div> آنلاین</div>
                </div>
            </div>
        </div>
        <i class="ph ph-info" style="font-size: 1.6rem; color: var(--t);"></i>
    </div>
    
    <div id="ch-bx" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:4px; background:var(--bg);"></div>
    
    <div class="chat-input-area">
        <div style="width: 42px; height: 42px; border-radius: 50%; background: var(--p); display: flex; align-items: center; justify-content: center; flex-shrink: 0; cursor: pointer; box-shadow: 0 4px 10px rgba(37,99,235,0.3);">
             <i class="ph ph-camera" style="color: white; font-size: 1.3rem;"></i>
        </div>
        <textarea id="ch-in" class="chat-textarea" placeholder="نوشتن پیام..." style="border-radius: 22px; padding: 12px 18px; background: #f3f4f6; border: 1px solid transparent; font-size: 0.95rem;"></textarea>
        <button class="btn" style="width:auto; color: var(--p); padding: 0 5px 8px 5px; background: transparent; font-weight: 800; font-size: 1rem;" onclick="app.sndM()">ارسال</button>
    </div>
</div>

<script>
    // ************************************************************
    // *********************** IMPORTANT **************************
    // REPLACE THIS URL WITH YOUR NEW DEPLOYMENT URL
    // ************************************************************
    const API_URL = 'https://script.google.com/macros/s/AKfycbyf_X4VQfe1YC95wWXkUkFrHAHDOCTmC6qzzsNCp-O57HvGikcAPZWlPAbS_9_kWrYI/exec';

    const app = {
        st: { user:null, users:[], posts:[], msgs:[], vid:null, shr:null, cpid:null, guest:false, page:1, limit:20, syncing:false, postToSend: null, pickerMode: null, searchLimit: 10, tempUsers: [], isLoadingOld: false, editingPost: null, selectedMsg: null },
        longPressTimer: null,
        
        init: async function() {
            this.showInitialSkeletons();
            if(localStorage.getItem('db')) {
                const db = JSON.parse(localStorage.getItem('db'));
                this.st.users=db.users||[]; this.st.posts=db.posts||[]; this.st.msgs=db.msgs||[];
            }
            const uid = localStorage.getItem('uid');
            if(uid) {
                const u = this.st.users.find(x=>x.id===uid);
                if(u) { 
                    this.st.user=u; 
                    if(!this.st.user.blocked) this.st.user.blocked = [];
                    this.start(); this.sync(true); 
                }
                else { document.getElementById('scr-auth').classList.remove('hide'); }
            } else {
                document.getElementById('scr-auth').classList.remove('hide');
            }

            const p = new URLSearchParams(location.search);
            const showUser = p.get('u');
            const showPost = p.get('p');

            setTimeout(() => {
                if (showUser) { this.nav('pr', showUser); } 
                else if (showPost) { this.showPost(showPost); }
            }, 1500);

            setInterval(() => { 
                if(!document.getElementById('scr-app').classList.contains('hide')) {
                    const inChat = document.getElementById('sc-ch').classList.contains('show');
                    if (inChat || !app.st.syncing) {
                        app.sync(false);
                    }
                }
            }, 3000);
            
            window.onscroll = () => {
                if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
                    const isHome = !document.getElementById('s-hm').classList.contains('hide');
                    const isProfile = !document.getElementById('s-pr').classList.contains('hide');
                    
                    if (isHome || isProfile) {
                        if(this.st.limit < this.st.posts.length) {
                            this.st.limit += 20;
                            if(isHome) this.feed();
                            if(isProfile) this.flt(document.querySelector('.chip.active') ? (document.querySelector('.chip.active').innerText.includes('همه') ? 'all' : document.querySelector('.chip.active').getAttribute('data-cat')) : 'all', null);
                        } else if (isHome && !this.st.isLoadingOld) {
                            document.getElementById('hm-more').classList.remove('hide');
                        }
                    }
                }
            };
            
            window.addEventListener('popstate', (event) => {
                if (!event.state || !event.state.pid) { document.getElementById('sc-post').classList.remove('show'); } 
                else if (event.state.pid) { this.showPost(event.state.pid, false); }
            });
            
            document.addEventListener('click', function(event) {
                const menu = document.getElementById('p-mn');
                const btn = document.getElementById('p-mn-btn');
                if (!menu.classList.contains('hide') && !menu.contains(event.target) && event.target !== btn) {
                    menu.classList.add('hide');
                }
                document.querySelectorAll('.p-menu').forEach(m => {
                    if(!m.contains(event.target)) m.classList.remove('show');
                });
            });
        },

        call: async function(act, pl) {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    redirect: "follow",
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: act, payload: pl })
                });
                return await res.json();
            } catch(e) { console.error(e); return {status:'error'}; }
        },

        sync: async function(initial) {
            if(this.st.syncing) return;
            this.st.syncing = true;
            const d = await this.call('getAll', {});
            this.st.syncing = false;
            
            if(d.status === 'success') {
                this.st.users = d.users;
                d.posts.forEach(np => {
                    const idx = this.st.posts.findIndex(p=>p.pid===np.pid);
                    if(idx !== -1) { 
                        this.st.posts[idx] = np;
                    } else {
                        if (!this.st.posts.find(p=>p.pid===np.pid)) this.st.posts.unshift(np);
                    }
                });
                
                d.msgs.forEach(nm => {
                    const exists = this.st.msgs.find(m => m.from===nm.from && m.to===nm.to && m.time===nm.time);
                    if(!exists) {
                        this.st.msgs.push(nm);
                    } else {
                        if (exists.read !== nm.read) {
                           exists.read = nm.read;
                        }
                    }
                });

                if(document.getElementById('sc-ch').classList.contains('show')) {
                     this.rnC(); 
                }

                localStorage.setItem('db', JSON.stringify({users:this.st.users, posts:this.st.posts, msgs:this.st.msgs}));
                if(this.st.user && !this.st.guest) {
                    const freshMe = this.st.users.find(u=>u.id===this.st.user.id);
                    if(freshMe) {
                        this.st.user = freshMe;
                        if(!this.st.user.blocked) this.st.user.blocked = [];
                    }
                    this.bdg();
                    this.updateNotifBadge();
                }
                if(!document.getElementById('s-hm').classList.contains('hide')) this.feed(); 
                if(!document.getElementById('s-ms').classList.contains('hide')) this.msg();
            }
        },
        
        loadOldPosts: async function() {
            this.st.isLoadingOld = true;
            const btn = document.getElementById('hm-more');
            btn.innerHTML = '<span class="loading"></span>';
            const lastPost = this.st.posts[this.st.posts.length - 1];
            const lastTime = lastPost ? lastPost.time : Date.now();
            const d = await this.call('getMorePosts', { lastTime: lastTime });
            if (d.status === 'success' && d.posts.length > 0) {
                let count = 0;
                d.posts.forEach(op => {
                    if (!this.st.posts.find(p => p.pid === op.pid)) {
                        this.st.posts.push(op);
                        count++;
                    }
                });
                if (count > 0) {
                    this.st.limit += 20;
                    this.feed();
                    this.notif(count + ' پست قدیمی‌تر بارگیری شد', 'suc');
                } else {
                    this.notif('پست قدیمی‌تری وجود ندارد', 'err');
                    btn.classList.add('hide');
                }
            } else {
                this.notif('پست دیگری یافت نشد', 'err');
                btn.classList.add('hide');
            }
            btn.innerHTML = 'مشاهده پست‌های قدیمی‌تر';
            this.st.isLoadingOld = false;
        },

        togAuth: () => { document.getElementById('f-log').classList.toggle('hide'); document.getElementById('f-reg').classList.toggle('hide'); },
        
        togPwd: (id, el) => {
            const inp = document.getElementById(id);
            if (inp.type === 'password') {
                inp.type = 'text';
                el.innerHTML = '<i class="ph ph-eye-slash"></i>';
            } else {
                inp.type = 'password';
                el.innerHTML = '<i class="ph ph-eye"></i>';
            }
        },

        login: async function(btn) {
            const nc=document.getElementById('l-nc').value, pass=document.getElementById('l-ps').value;
            if(!nc || !pass) return this.notif('لطفا اطلاعات را کامل وارد کنید', 'err');
            btn.innerHTML = '<span class="loading"></span>';
            const d = await this.call('login', {nc, pass});
            if(d.status === 'success') {
                this.st.user = d.user;
                if(!this.st.user.blocked) this.st.user.blocked = [];
                if(document.getElementById('l-rem').checked) localStorage.setItem('uid', d.user.id);
                this.start(); this.sync(true);
            } else { this.notif(d.msg, 'err'); btn.innerHTML='ورود به حساب'; }
        },
        reg: async function(btn) {
            const p = {
                id:document.getElementById('r-us').value.toLowerCase(), 
                nc:document.getElementById('r-nc').value,
                pass:document.getElementById('r-ps').value, 
                name:document.getElementById('r-nm').value,
                refCode:document.getElementById('r-rf').value
            };
            if(!p.id || !p.nc || !p.pass) return this.notif('همه فیلدها الزامی است', 'err');
            if(p.nc.length !== 10) return this.notif('کد ملی باید ۱۰ رقم باشد', 'err');
            
            btn.innerHTML = '<span class="loading"></span>';
            const d = await this.call('register', p);
            if(d.status === 'success') { this.notif('ثبت نام موفقیت آمیز بود', 'suc'); this.togAuth(); }
            else { this.notif(d.msg, 'err'); btn.innerHTML='تکمیل ثبت نام'; }
        },
        out: () => { 
            localStorage.clear(); 
            this.st = { user:null, users:[], posts:[], msgs:[], vid:null, shr:null, cpid:null, guest:false, page:1, limit:20, syncing:false, postToSend: null, pickerMode: null, searchLimit: 10, tempUsers: [], isLoadingOld: false, editingPost: null, selectedMsg: null };
            location.reload(); 
        },
        start: function() {
            document.getElementById('scr-auth').classList.add('hide');
            document.getElementById('scr-app').classList.remove('hide');
            this.nav('hm');
            // update profile pic in add post
            const me = this.st.user;
            if(me.pic) document.getElementById('add-post-av').innerHTML = `<img src="${me.pic}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
            if(me.pic) document.getElementById('cm-av').innerHTML = `<img src="${me.pic}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
        },

        nav: function(p, arg) {
            document.querySelectorAll('section').forEach(s=>s.classList.add('hide'));
            // Reset all icons to default state
            document.querySelectorAll('.n-it').forEach(i=>{
                i.classList.remove('active');
                const icon = i.querySelector('i');
                // Ensure classlist contains default icon, remove fill version if present
                if (icon.className.includes('-fill')) {
                    icon.className = icon.className.replace('-fill', '');
                }
            });
            document.getElementById('sc-ch').classList.remove('show');
            document.getElementById('sc-post').classList.remove('show');
            document.querySelector('#m-cm').classList.remove('show');

            if(p==='hm') { 
                document.getElementById('s-hm').classList.remove('hide'); 
                const n = document.getElementById('n-hm');
                n.classList.add('active');
                n.querySelector('i').className += '-fill';
                document.getElementById('hm-sr').value = ''; 
                if (this.st.posts.length === 0) { document.getElementById('feed').innerHTML = this.htmlSkelPost(3); }
                else { this.feed(); }
            }
            else if(p==='pr') { 
                document.getElementById('s-pr').classList.remove('hide'); 
                if(!arg || (this.st.user && arg===this.st.user.id)) {
                    const n = document.getElementById('n-pr');
                    n.classList.add('active');
                    n.querySelector('i').className += '-fill';
                }
                document.getElementById('p-pts').innerHTML = this.htmlSkelPost(2);
                this.prof(arg||this.st.user.id);
            }
            else if(p==='ad') { 
                document.getElementById('s-ad').classList.remove('hide'); 
                const n = document.getElementById('n-ad');
                n.classList.add('active');
                n.querySelector('i').className += '-fill';
                this.populateCategories(); 
                this.cancelEdit(false);
            }
            else if(p==='ms') { 
                document.getElementById('s-ms').classList.remove('hide'); 
                const n = document.getElementById('n-ms');
                n.classList.add('active');
                n.querySelector('i').className += '-fill';
                document.getElementById('msg-bx').innerHTML = this.htmlSkelUser(3);
                this.msg(); 
            }
            else if(p==='st') { 
                document.getElementById('s-st').classList.remove('hide'); 
                const n = document.getElementById('n-st');
                n.classList.add('active');
                n.querySelector('i').className += '-fill';
                this.sets(); 
            }
             else if(p==='sr') { document.getElementById('s-sr').classList.remove('hide'); }
        },

        feed: function() {
            const c = document.getElementById('feed'), nb = document.getElementById('new-bx');
            nb.innerHTML='';
            
            const blocked = this.st.user.blocked || [];
            this.st.users.filter(u=>u.id!==this.st.user.id && !blocked.includes(u.id)).slice(-6).forEach(u=>{
                const img = u.pic ? `<img src="${u.pic}" style="width:100%;height:100%;object-fit:cover;border-radius:50%; border:2px solid var(--p); padding:2px;">` : `<div style="width:100%;height:100%;background:#f3f4f6;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold; border:2px solid var(--p); color:var(--tg); font-size: 1.2rem;">${u.name[0]}</div>`;
                nb.innerHTML += `<div style="min-width:75px;text-align:center;cursor:pointer" onclick="app.nav('pr','${u.id}')">
                    <div style="width:64px;height:64px;margin:auto">${img}</div>
                    <div style="font-size:0.8rem;margin-top:6px;overflow:hidden;text-overflow:ellipsis;color:var(--t);font-weight:500;">${u.name.split(' ')[0]}</div></div>`;
            });

            let visiblePosts = this.st.posts.filter(p=>{
                const au = this.st.users.find(u=>u.id===p.uid); if(!au) return false;
                if (blocked.includes(au.id)) return false; 
                if (au.blocked && au.blocked.includes(this.st.user.id)) return false; 
                return !au.isPrivate || this.st.user.following.includes(p.uid) || p.uid===this.st.user.id;
            });
            
            visiblePosts.sort((a,b)=>b.time-a.time);
            
            const renderList = visiblePosts.slice(0, this.st.limit);
            let html = '';
            renderList.forEach(p => html += this.htmlP(p, 'feed'));
            
            if(c.innerHTML !== html) c.innerHTML = html;
            
            if(visiblePosts.length > this.st.limit) document.getElementById('feed-ldr').style.display='block';
            else document.getElementById('feed-ldr').style.display='none';
        },
        
        showPost: function(pid, pushState = true) {
            if (this.st.posts.length === 0) { setTimeout(() => this.showPost(pid, pushState), 500); return; }
            const post = this.st.posts.find(p => p.pid === pid);
            if (!post) { this.notif('پست مورد نظر یافت نشد', 'err'); return; }
            
            const author = this.st.users.find(u => u.id === post.uid);
            if (author && (this.st.user.blocked.includes(author.id) || (author.blocked && author.blocked.includes(this.st.user.id)))) {
                 this.notif('پست قابل نمایش نیست', 'err'); return;
            }

            const canView = !author || author.id === this.st.user.id || !author.isPrivate || (author.isPrivate && this.st.user.following.includes(author.id));

            if (!canView) {
                this.nav('pr', author.id); this.notif('این پست خصوصی است', 'err'); return;
            }

            document.getElementById('sc-ch').classList.remove('show');
            document.getElementById('m-nt').classList.remove('show');
            document.getElementById('m-ls').classList.remove('show');
            document.getElementById('m-pk').classList.remove('show');

            const postScreen = document.getElementById('sc-post');
            const postContent = document.getElementById('sc-post-content');
            
            postContent.innerHTML = this.htmlP(post, 'view');
            postScreen.classList.add('show');
            
            if (pushState) {
                const url = new URL(window.location);
                url.searchParams.set('p', pid);
                window.history.pushState({pid: pid}, '', url);
            }
        },

        closePostView: function() {
            document.getElementById('sc-post').classList.remove('show');
            const url = new URL(window.location);
            url.searchParams.delete('p');
            window.history.pushState({}, '', url);
            this.nav('hm');
        },
        
        viewImg: function(src) {
            if(!src || src.includes('undefined')) return;
            document.getElementById('img-vw').src = src;
            document.getElementById('m-img').classList.add('show');
        },

        htmlU: (uid) => {
            const u = app.st.users.find(x=>x.id===uid); if(!u) return 'کاربر حذف شده';
            const i = u.pic ? `<img class="u-img" src="${u.pic}">` : `<div class="u-img" style="display:flex;align-items:center;justify-content:center;background:#f3f4f6;color:var(--tg); font-size:1.4rem;"><i class="ph ph-user"></i></div>`;
            return `<div class="u-blk" onclick="event.stopPropagation();app.nav('pr','${u.id}')">${i}<div class="u-in"><div class="u-nm">${u.name}</div><div class="u-id">@${u.id}</div></div></div>`;
        },
        
        htmlP: (p, ctx) => {
            const lk = p.likes.includes(app.st.user.id) ? 'lk' : '';
            const heartIcon = lk ? '<i class="ph-fill ph-heart"></i>' : '<i class="ph ph-heart"></i>';

            let contentHtml = '';
            const maxLength = 500;
            if (p.text.length > maxLength) {
                const shortText = p.text.substring(0, maxLength) + '... ';
                contentHtml = `
                    <span id="txt-s-${p.pid}">${app.autoLinker(shortText)}<b style="cursor:pointer;color:var(--tg);display:inline-block;margin-right:5px;" onclick="app.readMore('${p.pid}')">بیشتر</b></span>
                    <span id="txt-f-${p.pid}" class="hide">${app.autoLinker(p.text)}</span>
                `;
            } else {
                contentHtml = app.autoLinker(p.text);
            }

            const postDate = new Date(p.time).toLocaleDateString('fa-IR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });

            let menuBtn = '';
            if(p.uid === app.st.user.id && ctx !== 'feed') {
                menuBtn = `
                <div class="post-opts-btn" onclick="event.stopPropagation(); document.getElementById('pm-${p.pid}').classList.toggle('show')"><i class="ph ph-dots-three"></i></div>
                <div id="pm-${p.pid}" class="p-menu">
                    <div class="p-menu-item" onclick="app.startEditPost('${p.pid}')"><i class="ph ph-pencil"></i> ویرایش</div>
                    <div class="p-menu-item del" onclick="app.doDeletePost('${p.pid}')"><i class="ph ph-trash"></i> حذف</div>
                </div>
                `;
            }

            return `<div class="card" id="p-${p.pid}" style="padding: 0; overflow: visible;">
                ${menuBtn}
                <div class="flex-bw" style="padding: 15px; ${p.uid === app.st.user.id && ctx !== 'feed' ? 'margin-right:30px' : ''}">
                    ${app.htmlU(p.uid)} 
                    <div style="text-align:left">
                        <span style="font-size:0.75rem;background:#f3f4f6;color:var(--t);padding:6px 12px;border-radius:8px; font-weight:600;">${p.cat||'عمومی'}</span>
                    </div>
                </div>
                
                <div style="padding: 0 18px 8px 18px;">
                    <h4 style="font-size:1.1rem; margin-bottom: 10px; line-height: 1.4;">${p.title}</h4>
                    <p style="line-height:1.7;font-size:1rem;white-space:pre-wrap;color:var(--t);text-align:right;direction:rtl;display:block;unicode-bidi:embed;">${contentHtml}</p>
                    <div style="font-size:0.8rem; color:var(--tg); text-align:right; margin-top:12px;">${postDate}</div>
                </div>

                <div style="padding: 8px 18px 15px 18px;">
                    <div class="p-act">
                        <div class="p-act-left">
                            <div class="act-b ${lk}" id="lb-${p.pid}"><span onclick="app.like('${p.pid}')">${heartIcon}</span></div>
                            <div class="act-b" onclick="app.comm('${p.pid}')"><i class="ph ph-chat-circle"></i></div>
                            <div class="act-b" onclick="app.openSendPostModal('${p.pid}')"><i class="ph ph-paper-plane-tilt"></i></div>
                        </div>
                        <div class="act-b" onclick="app.share('post','${p.pid}')"><i class="ph ph-bookmark"></i></div>
                    </div>
                    <div style="margin-top: 10px; font-weight: 700; font-size: 0.95rem; cursor: pointer; color: var(--t);" onclick="app.showLikes('${p.pid}', event)">${p.likes.length} پسند</div>
                    ${p.comments.length > 0 ? `<div style="margin-top: 6px; color: var(--tg); font-size: 0.9rem; cursor: pointer; font-weight: 500;" onclick="app.comm('${p.pid}')">مشاهده همه ${p.comments.length} نظر</div>` : ''}
                </div>
            </div>`;
        },

        readMore: function(pid) {
            document.getElementById('txt-s-' + pid).classList.add('hide');
            document.getElementById('txt-f-' + pid).classList.remove('hide');
        },
        readMoreMsg: function(id) {
            const el = document.getElementById('msg-txt-' + id);
            const fullText = el.getAttribute('data-full');
            el.innerHTML = app.autoLinker(fullText);
        },

        pub: async function(btn) {
            const title = document.getElementById('a-ti').value;
            const cat = document.getElementById('a-ct').value;
            const text = document.getElementById('a-tx').value;
            
            if(!text) return this.notif('متن پست الزامی است', 'err');
            
            if(this.st.editingPost) {
                const pid = this.st.editingPost;
                const p = this.st.posts.find(x => x.pid === pid);
                p.title = title; p.cat = cat; p.text = text;
                
                localStorage.setItem('db', JSON.stringify({users:this.st.users, posts:this.st.posts, msgs:this.st.msgs}));
                
                this.notif('در حال اعمال تغییرات...', 'wait');
                btn.innerHTML = '<span class="loading"></span>';
                await this.call('editPostContent', { pid: pid, uid: this.st.user.id, title, cat, text });
                
                this.notif('پست ویرایش شد', 'suc');
                this.cancelEdit();
                this.nav('hm');
                this.feed();
                return;
            }

            const p = { 
                pid: this.st.user.id + '_' + Date.now(), 
                uid: this.st.user.id, 
                title: title, 
                cat: cat, 
                text: text, 
                time: Date.now(),
                likes: [], comments: [] 
            };

            this.nav('hm');
            window.scrollTo(0,0);
            const upBox = document.getElementById('feed-up');
            upBox.innerHTML = `
                <div class="card sending" style="border:none; box-shadow: none;">
                    <div class="flex-bw">${this.htmlU(p.uid)}</div>
                    <div class="prog-c" style="display:block"><div class="fill" style="width:0%"></div></div>
                    <div class="up-msg" style="color:var(--p)">در حال آپلود...</div>
                </div>
            `;
            const fill = upBox.querySelector('.fill');
            setTimeout(()=>fill.style.width='30%', 100);
            setTimeout(()=>fill.style.width='70%', 800);
            try {
                this.notif('در حال ارسال...', 'wait');
                await this.call('createPost', { ...p, likes:[], comments:[] });
                fill.style.width='100%';
                upBox.querySelector('.up-msg').innerText = 'ارسال شد';
                upBox.querySelector('.up-msg').style.display = 'block';
                this.st.posts.unshift(p);
                localStorage.setItem('db', JSON.stringify({users:this.st.users, posts:this.st.posts, msgs:this.st.msgs}));
                
                document.getElementById('a-ti').value=''; document.getElementById('a-tx').value='';
                setTimeout(() => {
                    upBox.innerHTML = '';
                    this.feed();
                    this.notif('پست منتشر شد', 'suc');
                }, 1500);
            } catch(e) {
                upBox.innerHTML = '<div class="card" style="color:red">خطا در ارسال پست. لطفا اینترنت را بررسی کنید.</div>';
            }
        },
        
        startEditPost: function(pid) {
            const p = this.st.posts.find(x => x.pid === pid);
            if(!p) return;
            this.st.editingPost = pid;
            this.nav('ad');
            document.getElementById('a-ti').value = p.title;
            document.getElementById('a-ct').value = p.cat;
            document.getElementById('a-tx').value = p.text;
            document.getElementById('btn-pub').innerText = 'ذخیره';
            document.getElementById('a-header').innerText = 'ویرایش پست';
            document.getElementById('btn-cncl-edit').style.display = 'block';
        },
        
        cancelEdit: function(goBack=true) {
            this.st.editingPost = null;
            document.getElementById('a-ti').value = '';
            document.getElementById('a-ct').value = ''; 
            document.getElementById('a-tx').value = '';
            document.getElementById('btn-pub').innerText = 'انتشار';
            document.getElementById('a-header').innerText = 'پست جدید';
            document.getElementById('btn-cncl-edit').style.display = 'none';
            if(goBack) this.nav('hm');
        },
        
        doDeletePost: async function(pid) {
             if(confirm('آیا از حذف این پست اطمینان دارید؟')) {
                 this.notif('در حال حذف پست...', 'wait');
                 this.st.posts = this.st.posts.filter(p => p.pid !== pid);
                 localStorage.setItem('db', JSON.stringify({users:this.st.users, posts:this.st.posts, msgs:this.st.msgs}));
                 
                 if(document.getElementById('p-'+pid)) document.getElementById('p-'+pid).remove();
                 if(document.getElementById('sc-post').classList.contains('show')) this.closePostView();

                 await this.call('deletePost', {pid: pid});
                 this.notif('پست حذف شد', 'suc');
             }
        },

        like: function(pid) {
            const p = this.st.posts.find(x=>x.pid===pid);
            const uid = this.st.user.id;
            const btn = document.getElementById('lb-'+pid);
            let liked = p.likes.includes(uid);
            if(liked) {
                p.likes = p.likes.filter(x=>x!==uid);
                btn.classList.remove('lk');
                btn.querySelector('span').innerHTML = '<i class="ph ph-heart"></i>';
            } else {
                p.likes.push(uid);
                btn.classList.add('lk');
                btn.querySelector('span').innerHTML = '<i class="ph-fill ph-heart"></i>';
            }
            // Simple refresh logic for likes count in the view
            const likesCountDiv = btn.parentElement.parentElement.nextElementSibling;
            if(likesCountDiv && likesCountDiv.innerText.includes('پسند')) {
                likesCountDiv.innerText = `${p.likes.length} پسند`;
            }
            this.call('updatePost', {pid, likes:p.likes, comments:p.comments});
        },
        showLikes: function(pid, e) {
            if(e) e.stopPropagation();
            const p = this.st.posts.find(x=>x.pid===pid);
            if(!p || !p.likes.length) return this.notif('هنوز کسی این پست را لایک نکرده است', 'err');
            
            const b = document.getElementById('ls-bd'); b.innerHTML = '';
            document.getElementById('ls-tt').innerText = 'لایک‌کنندگان';
            
            p.likes.forEach(uid => {
                b.innerHTML += `<div style="margin-bottom:10px">${app.htmlU(uid)}</div>`;
            });
            
            document.getElementById('m-ls').classList.add('show');
        },
        comm: function(pid) {
            this.st.cpid = pid;
            const p = this.st.posts.find(x=>x.pid===pid);
            const b = document.getElementById('cm-bd');
            b.innerHTML = p.comments.length ? '' : '<div style="text-align:center;color:var(--tg);margin-top:30px; font-size: 0.9rem;"><i class="ph ph-chat-teardrop-dots" style="font-size:2rem;"></i><p>هنوز نظری ثبت نشده است.</p></div>';
            p.comments.forEach(c => {
                b.innerHTML += `<div style="padding:10px; border-bottom:1px solid #f3f4f6;">
                    ${this.htmlU(c.uid)}
                    <p style="font-size:0.95rem; margin-top:5px; padding-right:58px; color: var(--t);">${app.autoLinker(c.text)}</p>
                </div>`;
            });
            document.getElementById('m-cm').classList.add('show');
        },
        sndC: function(btn) {
            const txt = document.getElementById('cm-in').value.trim();
            if(!txt) return;
            const p = this.st.posts.find(x=>x.pid===this.st.cpid);
            const newCm = {uid:this.st.user.id, text:txt, time: Date.now()};
            p.comments.push(newCm);
            const b = document.getElementById('cm-bd');
            if(b.innerHTML.includes('هنوز نظری')) b.innerHTML='';
            const tempHTML = `<div style="padding:10px; border-bottom:1px solid #f3f4f6; opacity: 0.7;">
                    ${this.htmlU(this.st.user.id)}
                    <p style="font-size:0.95rem; margin-top:5px; padding-right:58px;">${this.autoLinker(txt)} <small>(ارسال...)</small></p>
                </div>`;
            b.insertAdjacentHTML('beforeend', tempHTML);
            b.scrollTop=b.scrollHeight;
            document.getElementById('cm-in').value='';
            this.call('updatePost', {pid:p.pid, likes:p.likes, comments:p.comments}).then(()=>{
                this.comm(this.st.cpid); 
            });
        },
        fol: function() {
            const uid = this.st.vid; const me = this.st.user; const u = this.st.users.find(x=>x.id===uid);
            const btn = document.getElementById('b-fl');
            let action = 'follow'; 
            if(me.following.includes(uid)) action = 'unfollow';
            if(action==='follow') {
                if(u.isPrivate) {
                    if (!u.requests.includes(me.id)) u.requests.push(me.id);
                    btn.innerText = 'در انتظار تایید'; btn.className = 'btn btn-o';
                } else {
                    if (!me.following.includes(uid)) me.following.push(uid);
                    if (!u.followers.includes(me.id)) u.followers.push(me.id);
                    btn.innerText = 'دنبال‌میکنید'; btn.className = 'btn btn-o';
                }
            } else {
                me.following = me.following.filter(x=>x!==uid); 
                u.followers = u.followers.filter(x=>x!==me.id); 
                u.requests = u.requests.filter(x=>x!==me.id);
                btn.innerText = 'دنبال کردن'; btn.className = 'btn btn-p';
            }
            document.getElementById('c-fl').innerText = u.followers.length;
            this.call('updateUser', [me, u]);
        },
        
        togProfMenu: function(e) {
            e.stopPropagation();
            const m = document.getElementById('p-mn');
            m.classList.toggle('hide');
            const uid = this.st.vid;
            const blocked = this.st.user.blocked.includes(uid);
            const blkBtn = document.getElementById('mn-blk');
            blkBtn.innerHTML = blocked ? '<i class="ph ph-check"></i> آزاد کردن' : '<i class="ph ph-prohibit"></i> مسدود کردن';
            blkBtn.style.color = blocked ? 'var(--suc)' : 'var(--err)';
        },
        
        block: function() {
            const uid = this.st.vid;
            const me = this.st.user;
            if(!me.blocked) me.blocked = [];
            
            if(me.blocked.includes(uid)) {
                me.blocked = me.blocked.filter(id => id !== uid);
                this.notif('کاربر آزاد شد', 'suc');
            } else {
                me.blocked.push(uid);
                me.following = me.following.filter(id => id !== uid);
                me.followers = me.followers.filter(id => id !== uid);
                this.notif('کاربر مسدود شد', 'err');
            }
            
            document.getElementById('p-mn').classList.add('hide');
            if(uid === this.st.vid) this.prof(uid); 
            this.call('updateUser', [me]);
        },
        
        unblockFromSettings: function(uid) {
            this.st.user.blocked = this.st.user.blocked.filter(id => id !== uid);
            this.call('updateUser', [this.st.user]);
            this.sets(); 
            this.notif('کاربر آزاد شد', 'suc');
        },

        msg: function() {
            const reqBox = document.getElementById('req-box');
            const msgBox = document.getElementById('msg-bx');
            reqBox.innerHTML = '';
            msgBox.innerHTML = '';
            
            if (this.st.user.requests && this.st.user.requests.length > 0) {
                reqBox.innerHTML += '<h4 style="margin:15px 5px 10px;color:var(--tg);font-size:0.9rem;">درخواست‌ها</h4>';
                this.st.user.requests.forEach(rid => {
                    const u = this.st.users.find(x => x.id === rid);
                    if (u && !this.st.user.blocked.includes(rid)) {
                        reqBox.innerHTML += `<div class="card flex-bw">${this.htmlU(rid)}<div><button class="btn-s btn-p" onclick="app.ans('${rid}',true)">تایید</button> <button class="btn-s btn-o" onclick="app.ans('${rid}',false)" style="margin-right:5px">حذف</button></div></div>`;
                    }
                });
            }
            
            const blocked = this.st.user.blocked || [];
            const chats = [...new Set(this.st.msgs.filter(x => (x.from === this.st.user.id || x.to === this.st.user.id)).map(x => x.from === this.st.user.id ? x.to : x.from))];
            
            const visibleChats = chats.filter(id => !blocked.includes(id));

            if (visibleChats.length === 0 && (!this.st.user.requests || this.st.user.requests.length === 0)) {
                msgBox.innerHTML = '<div style="text-align:center;padding:50px;color:var(--tg)"><div style="font-size:3rem"><i class="ph ph-chat-teardrop"></i></div><p>صندوق پیام خالی است</p></div>';
            }
            
            visibleChats.forEach(pid => {
                const u = this.st.users.find(x => x.id === pid);
                if (!u) return;

                const conv = this.st.msgs.filter(x => (x.from === this.st.user.id && x.to === pid) || (x.from === pid && x.to === this.st.user.id));
                if (conv.length === 0) return;
                const last = conv.sort((a,b) => b.time - a.time)[0];
                const unread = conv.filter(x => x.from === pid && x.to === this.st.user.id && !x.read).length;
                
                let tick = '';
                if (last.from === this.st.user.id) {
                     if(last.read) tick = '<span class="tik read"><i class="ph-fill ph-checks"></i></span>';
                     else if(last.id && last.id !== 'temp') tick = '<span class="tik sent"><i class="ph ph-check"></i></span>';
                     else tick = '<span class="tik wait"><i class="ph ph-clock"></i></span>';
                }

                let lastMsgText = '...';
                try {
                    const parsed = JSON.parse(last.text);
                    if (parsed.type === 'shared_post') {
                        lastMsgText = 'پست ارسال کرد';
                    } else {
                        lastMsgText = last.text;
                    }
                } catch(e) {
                    lastMsgText = last.text;
                }

                msgBox.innerHTML += `
                <div class="card" onclick="app.chat('${pid}')" style="cursor:pointer; padding: 12px; display:flex; align-items:center; gap:12px; border:none; box-shadow:none; margin-bottom: 5px; background: transparent;" data-chat-id="${u.id}">
                    <div style="flex-shrink:0;">${this.htmlU(u.id).replace('class="u-blk"', '').replace(/<div class="u-in">.*?<\/div>/, '')}</div>
                    <div style="flex:1; overflow:hidden;">
                         <div class="flex-bw">
                            <span style="font-weight:700; font-size:0.95rem;">${u.name}</span>
                            <small style="font-size:0.75rem;color:var(--tg); font-weight:500;">${new Date(last.time).toLocaleTimeString('fa-IR', {hour:'2-digit',minute:'2-digit'})}</small>
                         </div>
                         <div class="flex-bw">
                             <p style="color:${unread ? 'var(--t)' : 'var(--tg)'}; font-size:0.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:${unread ? '600':'400'}">
                                ${tick} ${lastMsgText}
                             </p>
                             ${unread > 0 ? `<div style="background:var(--p); color:white; width:20px; height:20px; border-radius:50%; font-size:0.75rem; display:flex; align-items:center; justify-content:center;">${unread}</div>` : ''}
                         </div>
                    </div>
                </div>`;
            });
        },
        
        chat: function(uid) {
            const u = this.st.users.find(x=>x.id===uid);
            if (this.st.user.blocked.includes(uid)) return this.notif('شما این کاربر را مسدود کرده‌اید', 'err');
            if (u.blocked && u.blocked.includes(this.st.user.id)) return this.notif('امکان ارسال پیام وجود ندارد', 'err');

            const hasHistory = this.st.msgs.some(m => (m.from === uid && m.to === this.st.user.id) || (m.from === this.st.user.id && m.to === uid));
            if(!u.allowMsg && !hasHistory && !u.following.includes(this.st.user.id)) return this.notif('امکان ارسال پیام به این کاربر وجود ندارد', 'err');
            
            this.st.cpid = uid;
            document.getElementById('sc-ch').classList.add('show');
            document.getElementById('ch-hd').innerText = u.name;
            document.getElementById('ch-im').src = u.pic || '';
            
            this.rnC();
            
            const unread = this.st.msgs.filter(x=>x.from===uid && x.to===this.st.user.id && !x.read);
            if(unread.length > 0) {
                unread.forEach(m => m.read=true);
                this.bdg();
                this.call('readMsg', {target: uid, me: this.st.user.id});
            }
        },
        
        rnC: function() {
            const b=document.getElementById('ch-bx'); 
            const isAtBottom = (b.scrollHeight - b.scrollTop <= b.clientHeight + 50);
            let newHTML = '';
            
            const ms = this.st.msgs.filter(x=>(x.from==this.st.user.id&&x.to==this.st.cpid)||(x.from==this.st.cpid&&x.to==this.st.user.id));
            ms.sort((a,b)=>a.time-b.time); 

            ms.forEach((x, index)=>{ 
                const mine = x.from===this.st.user.id;
                let tick = '';
                if(mine) {
                     if(x.read) tick = '<span class="tik read"><i class="ph-fill ph-checks"></i></span>';
                     else if(x.id && x.id !== 'temp') tick = '<span class="tik sent"><i class="ph ph-check"></i></span>';
                     else tick = '<span class="tik wait"><i class="ph ph-clock"></i></span>';
                }

                let msgContent = '';
                try {
                    const parsed = JSON.parse(x.text);
                    if (parsed.type === 'shared_post' && parsed.pid) {
                        msgContent = this.htmlSharedPost(parsed.pid);
                    } else {
                        throw new Error("Not a shared post");
                    }
                } catch (e) {
                    if (x.text.length > 500) {
                         const short = x.text.substring(0, 500) + '...';
                         msgContent = `<span id="msg-txt-${index}" data-full="${x.text.replace(/"/g, '&quot;')}">
                            ${this.autoLinker(short)}
                            <br><span class="read-more-msg" onclick="app.readMoreMsg('${index}')">خواندن کامل</span>
                         </span>`;
                    } else {
                        msgContent = this.renderFile(x.text) || this.autoLinker(x.text);
                    }
                }
                
                const elId = `msg-${index}`;
                newHTML += `<div id="${elId}" class="msg-bub ${mine?'msg-me':'msg-ot'} ${(!mine||x.id)?'':'pending'}" 
                    ontouchstart="app.handleTouchStart(event, ${index})" 
                    ontouchend="app.handleTouchEnd(event)" 
                    oncontextmenu="app.handleRightClick(event, ${index})">
                    ${msgContent}
                    <div class="msg-tm">${tick} ${new Date(x.time).toLocaleTimeString('fa-IR', {hour:'2-digit',minute:'2-digit'})}</div>
                </div>`; 
            });

            if(b.innerHTML.length !== newHTML.length || ms.length === 0) {
                b.innerHTML = newHTML;
                if(isAtBottom || ms.some(m => m.id === 'temp')) b.scrollTop=b.scrollHeight;
            } else if (isAtBottom) {
                 if(b.innerHTML !== newHTML) {
                     b.innerHTML = newHTML;
                     b.scrollTop=b.scrollHeight;
                 }
            }
        },
        
        handleTouchStart: function(e, idx) {
            this.longPressTimer = setTimeout(() => {
                this.showMsgOptions(idx);
            }, 600); 
        },
        
        handleTouchEnd: function(e) {
            clearTimeout(this.longPressTimer);
        },
        
        handleRightClick: function(e, idx) {
            e.preventDefault();
            this.showMsgOptions(idx);
        },
        
        showMsgOptions: function(idx) {
            const ms = this.st.msgs.filter(x=>(x.from==this.st.user.id&&x.to==this.st.cpid)||(x.from==this.st.cpid&&x.to==this.st.user.id));
            ms.sort((a,b)=>a.time-b.time);
            const msg = ms[idx];
            if(msg) {
                this.st.selectedMsg = msg;
                document.getElementById('m-mo').classList.add('show');
            }
        },
        
        doCopyMsg: function() {
            if(!this.st.selectedMsg) return;
            const text = this.st.selectedMsg.text;
            if(navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => this.notif('کپی شد', 'suc'));
            } else {
                this.notif('کپی خودکار پشتیبانی نمی‌شود', 'err');
            }
            document.getElementById('m-mo').classList.remove('show');
        },
        
        doDeleteMsg: async function() {
            if(!this.st.selectedMsg) return;
            if(confirm('آیا از حذف این پیام اطمینان دارید؟')) {
                const m = this.st.selectedMsg;
                this.st.msgs = this.st.msgs.filter(msg => msg !== m);
                localStorage.setItem('db', JSON.stringify({users:this.st.users, posts:this.st.posts, msgs:this.st.msgs}));
                this.rnC();
                document.getElementById('m-mo').classList.remove('show');
                
                this.notif('در حال حذف...', 'wait');
                await this.call('deleteMsg', {from: m.from, to: m.to, text: m.text, time: m.time});
                this.notif('پیام حذف شد', 'suc');
            }
        },

        renderFile: function(text) {
            const urlRegex = /^(https?:\/\/[^\s]+)$/i;
            if (!urlRegex.test(text)) return null;

            const url = text.trim();
            const ext = url.split('.').pop().toLowerCase().split('?')[0];
            
            if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(ext)) {
                return `<div class="file-img-container">
                    <img src="${url}" class="file-img" onload="this.style.background='transparent'" onclick="app.viewImg('${url}')">
                </div>`;
            }
            
            if (['mp3', 'wav', 'ogg', 'm4a'].includes(ext)) {
                return `<div class="file-prev">
                    <div class="file-icon"><i class="ph ph-music-note"></i></div>
                    <div style="flex:1">
                         <div class="file-name">فایل صوتی</div>
                         <audio controls src="${url}" style="width:100%; height:30px; margin-top:5px;"></audio>
                    </div>
                </div>`;
            }

            if (['mp4', 'webm', 'mov'].includes(ext)) {
                return `<div class="file-prev" style="display:block">
                     <video src="${url}" controls style="width:100%; border-radius:10px; max-height:200px;"></video>
                </div>`;
            }

            const docs = {
                'pdf': 'ph-file-pdf', 'doc': 'ph-file-doc', 'docx': 'ph-file-doc', 'xls': 'ph-file-xls', 'xlsx': 'ph-file-xls', 'ppt': 'ph-presentation', 'pptx': 'ph-presentation', 'txt': 'ph-file-text', 'zip': 'ph-file-zip', 'rar': 'ph-file-zip'
            };
            
            if (docs[ext]) {
                 return `<a href="${url}" target="_blank" style="text-decoration:none; color:inherit">
                    <div class="file-prev">
                        <div class="file-icon"><i class="ph ${docs[ext]}"></i></div>
                        <div>
                            <div class="file-name">${url.split('/').pop()}</div>
                            <div style="font-size:0.7rem; color:var(--p)">دانلود فایل</div>
                        </div>
                    </div>
                 </a>`;
            }

            return null; 
        },

        sndM: async function() {
            const t = document.getElementById('ch-in').value.trim(); if(!t) return;
            
            const m = {from:this.st.user.id, to:this.st.cpid, text:t, time:Date.now(), read:false, id:'temp'}; 
            this.st.msgs.push(m);
            
            this.rnC();
            document.getElementById('ch-in').value='';

            try {
                const payload = {...m}; delete payload.id;
                await this.call('createMsg', payload);
                m.id = 'sent';
                this.rnC(); 
                localStorage.setItem('db', JSON.stringify({users:this.st.users, posts:this.st.posts, msgs:this.st.msgs}));
            } catch(e) {
                this.notif('خطا در ارسال پیام', 'err');
            }
        },

        notif: (t, s) => { 
            const b=document.getElementById('tst'); 
            let icon = s==='err' ? '<i class="ph ph-warning-circle"></i>' : (s==='wait' ? '<i class="ph ph-hourglass"></i>' : '<i class="ph ph-check-circle"></i>');
            b.innerHTML = icon + ' ' + t; 
            b.style.background = s==='err'?'#ef4444': s==='wait'?'#1f2937':'#1f2937';
            b.classList.add('show'); 
            setTimeout(()=>b.classList.remove('show'), 3000); 
        },
        
        autoLinker: function(t) {
            if(!t) return '';
            let text = t;
            const postLinkRegex = new RegExp(location.origin + location.pathname + '\\?p=([a-zA-Z0-9_]+)', 'g');
            text = text.replace(postLinkRegex, (match, pid) => {
                 return `<span class="url-link" onclick="event.preventDefault(); event.stopPropagation(); app.showPost('${pid}')">مشاهده پست</span>`;
            });

            const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\b[A-Z0-9.-]+\.[A-Z]{2,4}\b)/ig;
            text = text.replace(urlRegex, function(url) {
                if(url.includes('?p=')) return url; 
                let href = url;
                if (!href.match(/^[a-zA-Z]+:\/\//)) { href = 'https://' + href; }
                return `<a href="${href}" class="url-link" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()">${url}</a>`;
            });
            
            const mentionRegex = /@(\w+)/g;
            text = text.replace(mentionRegex, (match, username) => {
                const u = this.st.users.find(x => x.id === username.toLowerCase());
                if (u) { return `<span class="ment" onclick="event.stopPropagation();app.nav('pr','${u.id}')">${match}</span>`; }
                return match;
            });
            return text;
        },
        
        bdg: () => {
            const r= (this.st.user.requests && this.st.user.requests.length) || 0;
            const u=this.st.msgs.filter(x=>x.to===this.st.user.id && !x.read).length;
            const b1=document.getElementById('b-nv');
            if(r+u>0) { b1.innerText=r+u; b1.classList.remove('hide'); } else b1.classList.add('hide');
        },

        prof: function(uid) {
            const u = this.st.users.find(x=>x.id===uid);
            if (!u) { return this.notif('کاربر یافت نشد', 'err'); }
            
            const me = this.st.user; 
            this.st.vid = uid; 
            const isMe = uid === me.id;
            const isBlocked = me.blocked.includes(uid);
            
            document.getElementById('bp-bk').classList.toggle('hide', isMe);
            
            // Handle Profile Pic Fallback
            const picCon = document.getElementById('p-pic-con');
            if (u.pic) {
                picCon.innerHTML = `<img id="p-im" class="p-pic" src="${u.pic}" onclick="app.viewImg(this.src)" title="مشاهده تصویر">`;
            } else {
                picCon.innerHTML = `<div class="p-pic-fallback">${u.name[0]}</div>`;
            }

            document.getElementById('p-nm').innerText = u.name; document.getElementById('p-id').innerText = u.id;
            document.getElementById('p-bi').innerHTML = this.autoLinker(u.bio);
            
            const lnk = document.getElementById('p-lnk'); lnk.innerHTML='';
            if(u.web) lnk.innerHTML = `<div><i class="ph ph-link"></i> ${this.autoLinker(u.web)}</div>`;
            
            const ps = this.st.posts.filter(x=>x.uid===uid);
            document.getElementById('c-pt').innerText=ps.length; 
            const fol = Array.isArray(u.followers) ? u.followers : JSON.parse(u.followers||'[]');
            const fing = Array.isArray(u.following) ? u.following : JSON.parse(u.following||'[]');
            document.getElementById('c-fl').innerText=fol.length; 
            document.getElementById('c-fi').innerText=fing.length;
            
            const acts = document.getElementById('p-act');
            if(isMe) {
                acts.classList.add('hide');
                document.getElementById('p-mn-btn').classList.add('hide');
            } else {
                acts.classList.remove('hide');
                document.getElementById('p-mn-btn').classList.remove('hide');
                const b = document.getElementById('b-fl');
                const bMsg = document.getElementById('b-msg');
                
                if(isBlocked) {
                    b.innerText = 'مسدود شده';
                    b.className = 'btn btn-o';
                    b.disabled = true;
                    bMsg.classList.add('hide');
                } else {
                    b.disabled = false;
                    bMsg.classList.remove('hide');
                    if(me.following.includes(uid)) { b.innerText='دنبال‌میکنید'; b.className='btn btn-o'; }
                    else if(u.requests && u.requests.includes(me.id)) { b.innerText='درخواست شده'; b.className='btn btn-o'; }
                    else { b.innerText='دنبال کردن'; b.className='btn btn-p'; }
                    
                    if (!u.allowMsg) {
                         const hasHistory = this.st.msgs.some(m => (m.from === uid && m.to === me.id) || (m.from === me.id && m.to === uid));
                         if (!hasHistory) bMsg.classList.add('hide');
                         else bMsg.classList.remove('hide');
                    }
                }
            }
            const acc = isMe || (!isBlocked && (!u.isPrivate || (u.isPrivate && u.followers.includes(me.id))));
            document.getElementById('p-con').classList.toggle('hide', !acc);
            document.getElementById('p-lck').classList.toggle('hide', acc);
            if(acc) this.flt('all', document.querySelector('#s-pr .chips .chip'));
        },
        flt: function(cat, el) {
            if(el) { document.querySelectorAll('#s-pr .chips .chip').forEach(c=>c.classList.remove('active')); el.classList.add('active'); }
            const c = document.getElementById('p-pts'); c.innerHTML='';
            let p = this.st.posts.filter(x=>x.uid===this.st.vid);
            if(cat!=='all') p = p.filter(x=>x.cat===cat);
            if(p.length===0) c.innerHTML='<div style="text-align:center;padding:40px;color:var(--tg);"><i class="ph ph-camera" style="font-size:3rem;"></i><p style="margin-top:10px;">هیچ پستی موجود نیست</p></div>';
            
            p.sort((a,b)=>b.time-a.time);
            const renderList = p.slice(0, this.st.limit);
            
            renderList.forEach(x=>c.innerHTML+=this.htmlP(x, 'profile'));
        },
        addCat: function() {
            const input = document.getElementById('st-new-cat');
            const newCat = input.value.trim();
            if (!this.st.user.customCats) { this.st.user.customCats = []; }
            if (!newCat) return this.notif('نام دسته‌بندی خالی است', 'err');
            if (this.st.user.customCats.length >= 20) return this.notif('محدودیت تعداد دسته‌بندی', 'err');
            if (this.st.user.customCats.includes(newCat)) return this.notif('تکراری است', 'err');
            this.st.user.customCats.push(newCat);
            input.value = '';
            this.renderCustomCats();
            
            this.notif('در حال افزودن...', 'wait');
            this.call('updateUser', [this.st.user]).then(()=>{ this.notif('دسته‌بندی افزوده شد', 'suc'); });
        },
        deleteCat: function(catToDelete) {
            this.st.user.customCats = this.st.user.customCats.filter(cat => cat !== catToDelete);
            this.renderCustomCats();
            
            this.notif('در حال حذف...', 'wait');
            this.call('updateUser', [this.st.user]).then(()=>{ this.notif('دسته‌بندی حذف شد', 'suc'); });
        }
    };
    app.init();
</script>

</body>
</html>
