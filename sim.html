<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³ÙˆØ´ÛŒØ§Ù„ Ù¾Ù„Ø§Ø³</title>
    <style>
        :root {
            --p: #2563eb; --pd: #1e40af; --bg: #f8fafc; --s: #ffffff;
            --t: #0f172a; --tg: #64748b; --bor: #e2e8f0; --err: #ef4444;
            --sh: 0 2px 4px rgba(0,0,0,0.05); --rad: 16px;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; -webkit-tap-highlight-color:transparent; outline:none; }
        body { background:var(--bg); color:var(--t); padding-bottom:75px; overflow-x:hidden; user-select:none; }
        .con { max-width:500px; margin:0 auto; padding:12px; }
        .hide { display:none !important; }
        .flex-bw { display:flex; justify-content:space-between; align-items:center; }
        .flex-al { display:flex; align-items:center; gap:10px; }
        
        /* UI Components */
        .card { background:var(--s); border-radius:var(--rad); padding:15px; margin-bottom:12px; box-shadow:var(--sh); border:1px solid var(--bor); position:relative; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .inp { width:100%; padding:12px; border:1px solid var(--bor); border-radius:12px; background:var(--bg); font-size:0.95rem; margin-bottom:12px; transition:0.3s; }
        .inp:focus { border-color:var(--p); background:var(--s); }
        .btn { width:100%; padding:12px; border-radius:12px; font-weight:bold; cursor:pointer; border:none; transition:0.2s; }
        .btn:active { transform:scale(0.97); }
        .btn-p { background:var(--p); color:white; }
        .btn-o { border:1px solid var(--bor); color:var(--tg); background:transparent; }
        .btn-s { padding:6px 12px; font-size:0.8rem; width:auto; border-radius:8px; }
        
        /* Loading Spinner */
        .loading { position:relative; color:transparent !important; pointer-events:none; }
        .loading::after { content:""; position:absolute; left:50%; top:50%; width:20px; height:20px; border:3px solid #fff; border-top-color:transparent; border-radius:50%; animation:rot 0.8s linear infinite; transform:translate(-50%,-50%); }
        @keyframes rot { to { transform:translate(-50%,-50%) rotate(360deg); } }
        
        /* User Avatar */
        .av { width:45px; height:45px; border-radius:50%; object-fit:cover; background:#e2e8f0; border:1px solid var(--bor); flex-shrink:0; }
        .av-s { width:35px; height:35px; }
        .av-l { width:80px; height:80px; border:3px solid var(--s); box-shadow:var(--sh); }

        /* Navigation */
        .nav { position:fixed; bottom:0; left:0; width:100%; background:rgba(255,255,255,0.95); backdrop-filter:blur(5px); border-top:1px solid var(--bor); display:flex; justify-content:space-around; padding:12px 0; z-index:100; box-shadow:0 -2px 10px rgba(0,0,0,0.03); }
        .n-it { font-size:1.6rem; color:#94a3b8; position:relative; cursor:pointer; transition:0.2s; }
        .n-it.active { color:var(--p); transform:translateY(-3px); }
        .bdg { position:absolute; top:-3px; right:-5px; background:var(--err); color:white; font-size:0.65rem; padding:2px 5px; border-radius:10px; border:2px solid var(--s); }

        /* Post Styles */
        .p-hd { display:flex; align-items:center; gap:10px; margin-bottom:10px; cursor:pointer; }
        .p-nm { font-weight:bold; font-size:0.95rem; }
        .p-id { font-size:0.75rem; color:var(--tg); }
        .p-txt { line-height:1.6; white-space:pre-wrap; font-size:0.95rem; }
        .p-act { border-top:1px solid var(--bor); padding-top:10px; margin-top:10px; display:flex; gap:20px; color:var(--tg); }
        .act { cursor:pointer; display:flex; align-items:center; gap:5px; transition:0.2s; }
        .act:active { transform:scale(1.2); }
        .act.lk span { color:var(--err); animation:pop 0.3s; }
        @keyframes pop { 50% { transform:scale(1.4); } }
        .ment { color:var(--p); cursor:pointer; font-weight:bold; text-decoration:none; }

        /* Uploading & Progress */
        .sending { opacity:0.7; pointer-events:none; position:relative; }
        .prog { height:4px; background:#e2e8f0; width:100%; margin-top:10px; overflow:hidden; border-radius:2px; display:none; }
        .fill { height:100%; background:linear-gradient(90deg, var(--p), var(--pd)); width:0%; transition:width 0.3s ease-out; }
        .up-msg { font-size:0.8rem; color:green; text-align:center; display:none; margin-top:5px; font-weight:bold; }

        /* Messages */
        .msg-r { display:flex; gap:10px; padding:12px; border-bottom:1px solid var(--bor); align-items:center; cursor:pointer; background:var(--s); transition:0.2s; }
        .msg-r:active { background:#f1f5f9; }
        .msg-u { font-weight:bold; font-size:0.95rem; }
        .msg-l { font-size:0.85rem; color:var(--tg); overflow:hidden; white-space:nowrap; text-overflow:ellipsis; max-width:200px; }
        .tik { font-size:0.75rem; margin-right:3px; font-family:sans-serif; }
        .tik.ok { color:var(--p); }
        .tik.no { color:var(--tg); } /* Ø³Ø§Ø¹Øª ÛŒØ§ ØªÛŒÚ© Ø®Ø§Ú©Ø³ØªØ±ÛŒ */

        /* Toast Notification */
        #tst { position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#1e293b; color:white; padding:10px 20px; border-radius:30px; z-index:2000; font-size:0.85rem; opacity:0; pointer-events:none; transition:0.3s; box-shadow:0 5px 15px rgba(0,0,0,0.2); }
        #tst.show { opacity:1; top:30px; }

        /* Profile Header */
        .prof-bg { text-align:center; padding-bottom:10px; }
        .prof-st { display:flex; justify-content:space-around; margin:15px 0; text-align:center; }
        .prof-n { font-size:1.1rem; font-weight:bold; }
        .prof-l { font-size:0.8rem; color:var(--tg); }

        /* Chat Room */
        .ch-bub { max-width:80%; margin-bottom:8px; padding:8px 12px; border-radius:15px; font-size:0.95rem; position:relative; line-height:1.4; }
        .ch-me { align-self:flex-end; background:#dbeafe; border-bottom-left-radius:2px; color:#1e3a8a; }
        .ch-yo { align-self:flex-start; background:#f1f5f9; border-bottom-right-radius:2px; color:var(--t); }
        .ch-tm { font-size:0.65rem; text-align:left; margin-top:4px; opacity:0.7; display:flex; align-items:center; gap:2px; }
    </style>
</head>
<body>

    <div id="tst"></div>

    <!-- AUTHENTICATION -->
    <div id="sc-auth" class="con" style="height:100vh; display:flex; flex-direction:column; justify-content:center;">
        <h1 style="text-align:center; color:var(--p); margin-bottom:30px; font-size:2rem;">ğŸŒ€ Ø³ÙˆØ´ÛŒØ§Ù„ Ù¾Ù„Ø§Ø³</h1>
        
        <div id="f-log">
            <div class="card">
                <h3 style="text-align:center; margin-bottom:15px">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨</h3>
                <input type="text" id="l-user" class="inp" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ (Ø³ØªÙˆÙ† B)" inputmode="numeric">
                <input type="password" id="l-ps" class="inp" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
                <div style="margin-bottom:15px; font-size:0.9rem"><label><input type="checkbox" id="l-rem" checked> Ù…Ø±Ø§ Ø¨Ø®Ø§Ø·Ø± Ø¨Ø³Ù¾Ø§Ø±</label></div>
                <button class="btn btn-p" onclick="app.login(this)">ÙˆØ±ÙˆØ¯</button>
                <button class="btn btn-o" style="margin-top:10px" onclick="app.guest()">ÙˆØ±ÙˆØ¯ Ù…Ù‡Ù…Ø§Ù†</button>
            </div>
            <p style="text-align:center; color:var(--p); cursor:pointer; margin-top:15px" onclick="toggleAuth()">Ø§ÛŒØ¬Ø§Ø¯ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÛŒØ¯</p>
        </div>

        <div id="f-reg" class="hide">
            <div class="card">
                <h3 style="text-align:center; margin-bottom:15px">Ø«Ø¨Øª Ù†Ø§Ù…</h3>
                <input type="number" id="r-nc" class="inp" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ (Û±Û° Ø±Ù‚Ù…)" inputmode="numeric">
                <input type="text" id="r-nm" class="inp" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ">
                <input type="text" id="r-us" class="inp" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ (Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)">
                <input type="number" id="r-rf" class="inp" placeholder="Ú©Ø¯ Ù…Ø¹Ø±Ù" inputmode="numeric">
                <input type="password" id="r-ps" class="inp" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
                <button class="btn btn-p" onclick="app.reg(this)">Ø«Ø¨Øª Ù†Ø§Ù…</button>
            </div>
            <p style="text-align:center; color:var(--tg); cursor:pointer; margin-top:15px" onclick="toggleAuth()">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ÙˆØ±ÙˆØ¯</p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="sc-app" class="hide">
        
        <!-- 1. HOME FEED -->
        <section id="s-hm" class="con">
            <div class="flex-bw" style="margin-bottom:10px"><h2>Ø®Ø§Ù†Ù‡</h2><div onclick="app.sync(true)" style="font-size:1.2rem; cursor:pointer">ğŸ”„</div></div>
            <div id="feed-up" style="display:none;"></div> <!-- For uploading post -->
            <div id="feed"></div>
            <div id="ldr" style="text-align:center; padding:20px; color:var(--tg); display:none">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
        </section>

        <!-- 2. EXPLORE -->
        <section id="s-ex" class="con hide">
            <input type="text" class="inp" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ú©Ø§Ø±Ø¨Ø± (Ù†Ø§Ù… ÛŒØ§ Ú©Ø¯Ù…Ù„ÛŒ)..." onkeyup="if(event.key==='Enter') app.srch(this.value)">
            <div id="res-bx"></div>
        </section>

        <!-- 3. ADD POST -->
        <section id="s-ad" class="con hide">
            <h2>Ù¾Ø³Øª Ø¬Ø¯ÛŒØ¯</h2>
            <div class="card" id="pub-bx">
                <input type="text" id="p-ti" class="inp" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù¾Ø³Øª">
                <select id="p-ct" class="inp">
                    <option value="Ø¹Ù…ÙˆÙ…ÛŒ">Ø¹Ù…ÙˆÙ…ÛŒ</option>
                    <option value="Ø§Ø®Ø¨Ø§Ø±">Ø§Ø®Ø¨Ø§Ø±</option>
                    <option value="Ø¢Ù…ÙˆØ²Ø´ÛŒ">Ø¢Ù…ÙˆØ²Ø´ÛŒ</option>
                </select>
                <textarea id="p-tx" class="inp" rows="6" placeholder="Ù…ØªÙ† Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
                
                <!-- Upload Progress -->
                <div class="prog" id="p-prg"><div class="fill" id="p-fil"></div></div>
                <div class="up-msg" id="p-msg">Ù¾Ø³Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!</div>

                <button class="btn btn-p" style="margin-top:10px" onclick="app.pub(this)">Ø§Ø±Ø³Ø§Ù„</button>
            </div>
        </section>

        <!-- 4. MESSAGES -->
        <section id="s-ms" class="con hide">
            <h2>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§</h2>
            <!-- Friend Requests Section -->
            <div id="req-con" style="margin-bottom:15px; display:none">
                <h4 style="margin:10px 0; font-size:0.9rem; color:var(--tg)">Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¯ÙˆØ³ØªÛŒ</h4>
                <div class="card" id="req-bx" style="background:#eff6ff; border-color:#bfdbfe; padding:0"></div>
            </div>
            
            <!-- Chat List -->
            <div id="chat-ls"></div>
        </section>

        <!-- CHAT ROOM (OVERLAY) -->
        <section id="s-ch" class="hide" style="position:fixed; top:0; left:0; right:0; bottom:0; background:var(--bg); z-index:200; display:flex; flex-direction:column">
            <div style="background:var(--s); padding:10px; border-bottom:1px solid var(--bor); display:flex; align-items:center; gap:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05)">
                <button class="btn-s btn-o" onclick="document.getElementById('s-ch').classList.add('hide')">â¬…</button>
                <div id="ch-hd" class="flex-al" onclick="app.nav('pr', app.st.cpid)" style="flex:1; cursor:pointer">
                    <img id="ch-av" class="av av-s">
                    <div style="font-weight:bold" id="ch-nm"></div>
                </div>
            </div>
            <div id="ch-bx" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:8px"></div>
            <div style="padding:10px; background:var(--s); display:flex; gap:5px; border-top:1px solid var(--bor)">
                <input type="text" id="ch-in" class="inp" style="margin:0; border-radius:20px" placeholder="Ù¾ÛŒØ§Ù…...">
                <button class="btn btn-p" style="width:50px; border-radius:50%" onclick="app.sndM()">â¤</button>
            </div>
        </section>

        <!-- 5. PROFILE -->
        <section id="s-pr" class="con hide">
            <div class="card">
                <div class="flex-bw">
                    <button class="btn-s btn-o" onclick="app.nav('hm')">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
                    <button class="btn-s btn-o" onclick="app.share()">ğŸ”— Ú©Ù¾ÛŒ Ù„ÛŒÙ†Ú©</button>
                </div>
                <div class="prof-bg">
                    <img id="pr-pic" class="av av-l">
                    <h3 id="pr-nm" style="margin-top:10px"></h3>
                    <div id="pr-id" style="color:var(--tg); font-size:0.9rem"></div>
                    <div id="pr-bio" style="margin:10px 0; font-size:0.9rem; white-space:pre-wrap"></div>
                    <div id="pr-lnk" style="font-size:0.85rem; color:var(--p); cursor:pointer" onclick="window.open(this.innerText)"></div>
                </div>
                <div class="prof-st">
                    <div onclick="app.shL('p')"><b id="c-po">0</b><br><small>Ù¾Ø³Øª</small></div>
                    <div onclick="app.shL('f')"><b id="c-fl">0</b><br><small>Ø¯Ù†Ø¨Ø§Ù„â€ŒÚ©Ù†Ù†Ø¯Ù‡</small></div>
                    <div onclick="app.shL('i')"><b id="c-fi">0</b><br><small>Ø¯Ù†Ø¨Ø§Ù„â€ŒØ´ÙˆÙ†Ø¯Ù‡</small></div>
                </div>
                <div id="pr-act" class="flex-bw" style="gap:10px; justify-content:center"></div>
            </div>
            <div id="pr-feed"></div>
        </section>

        <!-- 6. SETTINGS -->
        <section id="s-st" class="con hide">
            <h2>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h2>
            <div class="card">
                <div style="margin-bottom:10px">Ú©Ø¯ Ù…Ù„ÛŒ: <b id="st-nc"></b></div>
                <div style="margin-bottom:10px">Ú©Ø¯ Ø¯Ø¹ÙˆØª: <b id="st-rf"></b></div>
                <hr style="border:0; border-top:1px solid #eee; margin:10px 0">
                <label>Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„:</label>
                <input type="text" id="e-pic" class="inp" placeholder="Ù„ÛŒÙ†Ú© Ø¹Ú©Ø³">
                <label>Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ:</label>
                <input type="text" id="e-nm" class="inp" placeholder="Ù†Ø§Ù…">
                <label>Ø¨ÛŒÙˆÚ¯Ø±Ø§ÙÛŒ:</label>
                <textarea id="e-bio" class="inp" placeholder="Ø¨ÛŒÙˆ"></textarea>
                <label>ÙˆØ¨Ø³Ø§ÛŒØª:</label>
                <input type="text" id="e-web" class="inp" placeholder="ÙˆØ¨Ø³Ø§ÛŒØª">
                <label>Ø¢ÛŒØ¯ÛŒ Ù…Ù†Ø´Ù†:</label>
                <input type="text" id="e-men" class="inp" placeholder="Ù…Ø«Ù„Ø§ dadgostar">
                <div class="flex-bw" style="margin:10px 0"><span>Ø­Ø³Ø§Ø¨ Ø®ØµÙˆØµÛŒ</span><input type="checkbox" id="e-pri"></div>
                <div class="flex-bw" style="margin:10px 0"><span>Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…</span><input type="checkbox" id="e-msg"></div>
                <button class="btn btn-p" onclick="app.saveSet()">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
                <button class="btn btn-o" style="margin-top:10px; color:red; border-color:red" onclick="app.logout()">Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨</button>
            </div>
        </section>

        <!-- COMMENTS MODAL -->
        <div id="m-cm" class="hide" style="position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:150; display:flex; align-items:flex-end">
            <div style="background:var(--s); width:100%; height:70vh; border-radius:20px 20px 0 0; display:flex; flex-direction:column; animation:up 0.3s">
                <div style="padding:15px; border-bottom:1px solid var(--bor); text-align:center; font-weight:bold; position:relative">
                    Ù†Ø¸Ø±Ø§Øª
                    <span onclick="document.getElementById('m-cm').classList.add('hide')" style="position:absolute; left:15px; top:15px; cursor:pointer; font-size:1.2rem">âœ•</span>
                </div>
                <div id="cm-ls" style="flex:1; overflow-y:auto; padding:15px"></div>
                <div style="padding:10px; border-top:1px solid var(--bor); display:flex; gap:5px; background:var(--s)">
                    <input type="text" id="cm-in" class="inp" style="margin:0; border-radius:20px" placeholder="Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...">
                    <button class="btn btn-p" style="width:50px; border-radius:50%" onclick="app.sndC()">âœ“</button>
                </div>
            </div>
        </div>

        <!-- BOTTOM NAV -->
        <div class="nav">
            <div class="n-it active" id="n-hm" onclick="app.nav('hm')">ğŸ </div>
            <div class="n-it" id="n-ex" onclick="app.nav('ex')">ğŸ”</div>
            <div class="n-it" id="n-ad" onclick="app.nav('ad')">â•</div>
            <div class="n-it" id="n-ms" onclick="app.nav('ms')">ğŸ’¬ <span id="bg-ms" class="bdg hide"></span></div>
            <div class="n-it" id="n-pr" onclick="app.nav('pr')">ğŸ‘¤</div>
            <div class="n-it" id="n-st" onclick="app.nav('st')">âš™ï¸</div>
        </div>
    </div>

    <script>
        // *** Ù„ÛŒÙ†Ú© Ø¬Ø¯ÛŒØ¯ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯ ***
        const API = 'https://script.google.com/macros/s/AKfycbyf_X4VQfe1YC95wWXkUkFrHAHDOCTmC6qzzsNCp-O57HvGikcAPZWlPAbS_9_kWrYI/exec';

        const toggleAuth = () => { document.getElementById('f-log').classList.toggle('hide'); document.getElementById('f-reg').classList.toggle('hide'); };

        const app = {
            st: { user:null, users:[], posts:[], msgs:[], cpid:null, guest:false },
            
            init: function() {
                const db = localStorage.getItem('db');
                if(db) { const d=JSON.parse(db); this.st.users=d.users; this.st.posts=d.posts; this.st.msgs=d.msgs; }
                
                const uid = localStorage.getItem('uid');
                if(uid) {
                    const u = this.st.users.find(x=>x.id===uid);
                    if(u) { this.st.user=u; this.start(); this.sync(); }
                    else document.getElementById('sc-auth').classList.remove('hide');
                } else document.getElementById('sc-auth').classList.remove('hide');

                // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ…
                const p = new URLSearchParams(location.search);
                if(p.get('u')) setTimeout(()=>this.nav('pr', p.get('u')), 1000);
                if(p.get('p')) setTimeout(()=>{
                    // Ø¨Ø±Ø§ÛŒ Ù¾Ø³Øª Ø®Ø§Øµ (Ø³Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡: Ø±ÙØªÙ† Ø¨Ù‡ Ø®Ø§Ù†Ù‡ Ùˆ Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ù¾Ø³Øª)
                    this.nav('hm');
                    // Ø¯Ø± Ù†Ø³Ø®Ù‡ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¨Ø§ÛŒØ¯ Ù…ÙˆØ¯Ø§Ù„ Ù¾Ø³Øª Ø¨Ø§Ø² Ø´ÙˆØ¯
                }, 1000);

                // Infinite Scroll Simulation
                window.onscroll = () => {
                    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
                        // Ù…Ù†Ø·Ù‚ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨ÛŒØ´ØªØ± Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯
                        // Ú†ÙˆÙ† Ù‡Ù…Ù‡ Ø¯ÛŒØªØ§ ÙØ¹Ù„Ø§ Ù„ÙˆÚ©Ø§Ù„ Ø§Ø³ØªØŒ Ù†ÛŒØ§Ø²ÛŒ Ù†ÛŒØ³Øª
                    }
                };
            },

            // CORE API CALL
            call: async function(act, pl) {
                try {
                    const res = await fetch(API, {
                        method: 'POST',
                        redirect: "follow",
                        headers: {'Content-Type': 'text/plain;charset=utf-8'},
                        body: JSON.stringify({action: act, payload: pl})
                    });
                    return await res.json();
                } catch(e) { return {status:'error'}; }
            },

            sync: async function(m) {
                if(m) app.toast('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ...');
                const d = await this.call('getAll', {});
                if(d.status==='success') {
                    this.st.users=d.users; this.st.posts=d.posts; this.st.msgs=d.msgs;
                    localStorage.setItem('db', JSON.stringify(d));
                    if(this.st.user && !this.st.guest) this.st.user = this.st.users.find(u=>u.id===this.st.user.id);
                    if(!document.getElementById('s-hm').classList.contains('hide')) this.feed();
                    if(!document.getElementById('s-ms').classList.contains('hide')) this.msList();
                    this.bdg();
                    if(m) app.toast('Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯');
                }
            },

            // AUTH
            login: async function(btn) {
                const u=document.getElementById('l-user').value, p=document.getElementById('l-ps').value;
                if(!u || !p) return app.toast('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ø§Ù‚Øµ Ø§Ø³Øª');
                btn.classList.add('loading');
                const d = await this.call('login', {user:u, pass:p});
                if(d.status==='success') {
                    this.st.user=d.user;
                    if(document.getElementById('l-rem').checked) localStorage.setItem('uid', d.user.id);
                    this.start(); this.sync();
                } else app.toast(d.msg);
                btn.classList.remove('loading');
            },
            reg: async function(btn) {
                const p={id:document.getElementById('r-us').value.toLowerCase(), user:document.getElementById('r-nc').value, pass:document.getElementById('r-ps').value, name:document.getElementById('r-nm').value, refCode:document.getElementById('r-rf').value};
                if(!p.id || !p.user || !p.pass) return app.toast('ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒØ³Øª');
                btn.classList.add('loading');
                const d = await this.call('register', p);
                if(d.status==='success') { app.toast('Ø«Ø¨Øª Ù†Ø§Ù… Ù…ÙˆÙÙ‚. ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯'); toggleAuth(); }
                else app.toast(d.msg);
                btn.classList.remove('loading');
            },
            guest: function() {
                this.st.guest=true;
                this.st.user={id:'guest', name:'Ù…Ù‡Ù…Ø§Ù†', nc:'guest', followers:[], following:[], requests:[], blocked:[]};
                this.start();
            },
            logout: function() { localStorage.removeItem('uid'); location.reload(); },
            start: function() {
                document.getElementById('sc-auth').classList.add('hide');
                document.getElementById('sc-app').classList.remove('hide');
                if(this.st.guest) ['n-ad','n-ms','n-st'].forEach(x=>document.getElementById(x).style.display='none');
                this.nav('hm');
            },

            // NAVIGATION
            nav: function(p, arg) {
                document.querySelectorAll('section').forEach(x=>x.classList.add('hide'));
                document.querySelectorAll('.n-it').forEach(x=>x.classList.remove('active'));
                
                // Hide Modals
                document.getElementById('s-ch').classList.add('hide');
                document.getElementById('m-cm').classList.add('hide');

                if(p==='hm') { document.getElementById('s-hm').classList.remove('hide'); document.getElementById('n-hm').classList.add('active'); this.feed(); }
                else if(p==='ex') document.getElementById('s-ex').classList.remove('hide');
                else if(p==='ad') document.getElementById('s-ad').classList.remove('hide');
                else if(p==='ms') { document.getElementById('s-ms').classList.remove('hide'); document.getElementById('n-ms').classList.add('active'); this.msList(); }
                else if(p==='pr') { 
                    document.getElementById('s-pr').classList.remove('hide'); 
                    if(arg===this.st.user.id) document.getElementById('n-pr').classList.add('active');
                    this.prof(arg || this.st.user.id);
                }
                else if(p==='st') { document.getElementById('s-st').classList.remove('hide'); document.getElementById('n-st').classList.add('active'); this.setUI(); }
            },

            // 1. HOME FEED
            feed: function() {
                const c = document.getElementById('feed'); c.innerHTML='';
                // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾Ø³Øª Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ù„ÙˆØ¯ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
                const upBox = document.getElementById('feed-up');
                if(upBox.innerHTML) c.innerHTML = upBox.innerHTML;

                const ps = this.st.posts.sort((a,b)=>b.time-a.time);
                ps.slice(0, 50).forEach(p => c.innerHTML += this.htmlP(p));
            },
            htmlP: function(p) {
                const u = this.st.users.find(x=>x.id===p.uid)||{name:'Ú©Ø§Ø±Ø¨Ø± Ø­Ø°Ù Ø´Ø¯Ù‡', pic:''};
                const lk = p.likes.includes(this.st.user.id) ? 'lk' : '';
                return `<div class="card" id="p-${p.pid}">
                    <div class="p-hd" onclick="app.nav('pr','${p.uid}')">
                        <img src="${u.pic||''}" class="av av-s" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iI2NjYyIgZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00czLTEuNzktNC00LTQSOF4Ljc5IDggNG0wIDJjLTIuNjcgMC04IDEuMzQtOCA0djJoMTZ2LTJjMC0yLjY2LTUuMzMtNC04LTR6Ii8+PC9zdmc+'">
                        <div><div class="p-nm">${u.name}</div><div class="p-id">@${u.nc}</div></div>
                    </div>
                    <div class="p-txt">${this.lnk(p.text)}</div>
                    <div class="p-act">
                        <div class="act ${lk}" onclick="app.like('${p.pid}')"><span>${lk?'â¤':'ğŸ¤'}</span> <span id="l-${p.pid}">${p.likes.length}</span></div>
                        <div class="act" onclick="app.comm('${p.pid}')">ğŸ’¬ ${p.comments.length}</div>
                        <div class="act" onclick="app.copyLnk('${p.pid}')">ğŸ”—</div>
                    </div>
                </div>`;
            },

            // 2. CREATE POST (Optimistic & Background Upload)
            pub: async function(btn) {
                const p = {
                    pid: 'tmp-'+Date.now(), uid: this.st.user.id,
                    title: document.getElementById('p-ti').value,
                    cat: document.getElementById('p-ct').value,
                    text: document.getElementById('p-tx').value,
                    time: Date.now(), likes:[], comments:[]
                };
                if(!p.text) return app.toast('Ù…ØªÙ† Ù¾Ø³Øª Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
                
                // UI: Start Upload Animation
                btn.style.display='none';
                document.getElementById('p-prg').style.display='block';
                const fill = document.getElementById('p-fil');
                
                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø± Ø´Ø¯Ù† Ù†ÙˆØ§Ø±
                setTimeout(()=>fill.style.width='40%', 200);
                setTimeout(()=>fill.style.width='75%', 800);

                // Add to feed immediately (top) as "Sending..."
                const sendingHTML = `<div class="card sending" id="sending-post">
                    <div class="p-hd"><img src="${this.st.user.pic}" class="av av-s"><div><div class="p-nm">${this.st.user.name}</div></div></div>
                    <div class="p-txt">${p.text}</div>
                    <div style="font-size:0.8rem;color:var(--p)">Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...</div>
                </div>`;
                
                // Go to home and show pending post
                this.nav('hm');
                const feed = document.getElementById('feed');
                feed.insertAdjacentHTML('afterbegin', sendingHTML);

                // Send to Server
                try {
                    await this.call('createPost', {pid:this.st.user.id+'_'+Date.now(), ...p});
                    
                    // Success UI
                    const pendingEl = document.getElementById('sending-post');
                    if(pendingEl) pendingEl.remove(); // Remove temp UI
                    
                    // Add real post to local data
                    this.st.posts.unshift(p);
                    this.feed(); // Re-render real feed
                    
                    // Reset Form
                    document.getElementById('p-ti').value=''; document.getElementById('p-tx').value='';
                    document.getElementById('p-prg').style.display='none'; fill.style.width='0%';
                    btn.style.display='block';
                    app.toast('Ù¾Ø³Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù…Ù†ØªØ´Ø± Ø´Ø¯');
                    
                } catch(e) {
                    app.toast('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾Ø³Øª');
                    btn.style.display='block';
                }
            },

            // 3. ACTIONS (Optimistic)
            like: function(pid) {
                const p = this.st.posts.find(x=>x.pid===pid);
                const me = this.st.user.id;
                
                // Update Local
                let isL = p.likes.includes(me);
                if(isL) p.likes = p.likes.filter(x=>x!==me);
                else p.likes.push(me);
                
                // Update DOM Instantly
                const el = document.getElementById('p-'+pid);
                if(el) {
                    const icn = el.querySelector('.act span');
                    const cnt = el.querySelector('#l-'+pid);
                    icn.innerText = isL ? 'ğŸ¤' : 'â¤';
                    el.querySelector('.act').classList.toggle('lk');
                    cnt.innerText = p.likes.length;
                }
                
                // Send Background
                this.call('updatePost', {pid:p.pid, likes:p.likes, comments:p.comments});
            },
            comm: function(pid) {
                this.st.cpid=pid;
                document.getElementById('m-cm').classList.remove('hide');
                this.rnCm();
            },
            rnCm: function() {
                const p = this.st.posts.find(x=>x.pid===this.st.cpid);
                const c = document.getElementById('cm-ls'); c.innerHTML='';
                if(p.comments.length===0) c.innerHTML='<div style="text-align:center;color:gray">Ø§ÙˆÙ„ÛŒÙ† Ù†Ø¸Ø± Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯</div>';
                p.comments.forEach(m => {
                    const u = this.st.users.find(x=>x.id===m.uid);
                    c.innerHTML += `<div style="margin-bottom:10px" onclick="app.nav('pr','${m.uid}')"><b>${u?u.name:'?'}</b>: ${this.lnk(m.text)}</div>`;
                });
                c.scrollTop = c.scrollHeight;
            },
            sndC: function() {
                const t = document.getElementById('cm-in').value; if(!t) return;
                const p = this.st.posts.find(x=>x.pid===this.st.cpid);
                p.comments.push({uid:this.st.user.id, text:t});
                document.getElementById('cm-in').value='';
                
                // Update DOM
                const c = document.getElementById('cm-ls');
                if(c.innerHTML.includes('Ø§ÙˆÙ„ÛŒÙ†')) c.innerHTML='';
                c.innerHTML += `<div style="margin-bottom:10px; opacity:0.5"><b>${this.st.user.name}</b>: ${t} (Ø§Ø±Ø³Ø§Ù„...)</div>`;
                c.scrollTop = c.scrollHeight;

                this.call('updatePost', {pid:p.pid, likes:p.likes, comments:p.comments}).then(()=>{
                    this.rnCm(); // Refresh to remove opacity
                    // Update comment count on post card
                    const cnt = document.querySelector(`#p-${p.pid} .act:nth-child(2)`);
                    if(cnt) cnt.innerText = `ğŸ’¬ ${p.comments.length}`;
                });
            },

            // 4. MESSAGES & REQUESTS (Updated Logic)
            msList: function() {
                // Requests
                const reqs = this.st.user.requests;
                const rb = document.getElementById('req-bx');
                const rc = document.getElementById('req-con');
                if(reqs.length > 0) {
                    rc.style.display = 'block';
                    rb.innerHTML='';
                    reqs.forEach(id => {
                        const u = this.st.users.find(x=>x.id===id);
                        rb.innerHTML += `<div class="msg-r" style="background:transparent; border:none">
                            <img src="${u.pic}" class="av av-s" onclick="app.nav('pr','${id}')">
                            <div style="flex:1"><b>${u.name}</b><br><small>@${u.nc}</small></div>
                            <div><button class="btn-s btn-p" onclick="app.ans('${id}',true)">ØªØ§ÛŒÛŒØ¯</button> <button class="btn-s btn-o" onclick="app.ans('${id}',false)">Ø±Ø¯</button></div>
                        </div>`;
                    });
                } else {
                    rc.style.display = 'none';
                }

                // Chats
                const chats = [...new Set(this.st.msgs.filter(x=>x.from===this.st.user.id||x.to===this.st.user.id).map(x=>x.from===this.st.user.id?x.to:x.from))];
                const cl = document.getElementById('chat-ls'); cl.innerHTML='';
                if(chats.length===0) cl.innerHTML='<div style="text-align:center;padding:20px;color:gray">Ù¾ÛŒØ§Ù…ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</div>';
                
                chats.forEach(cid => {
                    const u = this.st.users.find(x=>x.id===cid);
                    const last = this.st.msgs.filter(x=>(x.from===this.st.user.id&&x.to===cid)||(x.from===cid&&x.to===this.st.user.id)).pop();
                    const unseen = this.st.msgs.filter(x=>x.from===cid && x.to===this.st.user.id && !x.read).length;
                    
                    // ØªÛŒÚ© ÙˆØ¶Ø¹ÛŒØª Ù¾ÛŒØ§Ù…
                    let tick = '';
                    if(last.from === this.st.user.id) {
                        tick = last.read ? '<span class="tik ok">âœ“âœ“</span>' : '<span class="tik no">âœ“</span>';
                    }

                    cl.innerHTML += `<div class="msg-r" onclick="app.chat('${cid}')">
                        <img src="${u.pic}" class="av" onclick="event.stopPropagation();app.nav('pr','${cid}')">
                        <div style="flex:1;overflow:hidden">
                            <div class="flex-bw"><span class="msg-u">${u.name}</span> <small style="color:var(--tg)">${this.time(last.time)}</small></div>
                            <div class="msg-l">${tick} ${last.text}</div>
                        </div>
                        ${unseen ? `<div class="bdg" style="position:static">${unseen}</div>` : ''}
                    </div>`;
                });
            },
            ans: function(id, ok) {
                const me = this.st.user;
                me.requests = me.requests.filter(x=>x!==id);
                const u = this.st.users.find(x=>x.id===id);
                if(ok) { me.followers.push(id); u.following.push(me.id); }
                this.msList();
                this.call('updateUser', [me, u]);
            },
            chat: function(id) {
                this.st.cpid = id;
                const u = this.st.users.find(x=>x.id===id);
                document.getElementById('ch-nm').innerText = u.name;
                document.getElementById('ch-av').src = u.pic;
                document.getElementById('s-ch').classList.remove('hide');
                this.rnCh();
                
                // Mark read logic
                const unread = this.st.msgs.filter(x=>x.from===id && x.to===this.st.user.id && !x.read);
                if(unread.length > 0) {
                    unread.forEach(m => m.read = true);
                    this.bdg(); // Update badge immediately
                    // Send update to server (assuming createMsg handles updates or just create logic for simplicity here)
                    // Note: In a real app, you'd have a 'markRead' API. Here we just update local state visually.
                }
            },
            rnCh: function() {
                const b = document.getElementById('ch-bx'); b.innerHTML='';
                const ms = this.st.msgs.filter(x=>(x.from===this.st.user.id&&x.to===this.st.cpid)||(x.from===this.st.cpid&&x.to===this.st.user.id));
                ms.forEach(x => {
                    const mine = x.from===this.st.user.id;
                    const tick = mine ? (x.read ? '<span class="tik ok">âœ“âœ“</span>' : '<span class="tik no">âœ“</span>') : '';
                    
                    b.innerHTML += `<div style="display:flex; flex-direction:column; align-items:${mine?'flex-end':'flex-start'}">
                        <div class="ch-bub ${mine?'ch-me':'ch-yo'}">
                            ${this.lnk(x.text)}
                            <div class="ch-tm">${tick} ${this.time(x.time)}</div>
                        </div>
                    </div>`;
                });
                b.scrollTop = b.scrollHeight;
            },
            sndM: function() {
                const t = document.getElementById('ch-in').value; if(!t) return;
                const m = {from:this.st.user.id, to:this.st.cpid, text:t, time:Date.now(), read:false};
                
                // Optimistic Append
                const b = document.getElementById('ch-bx');
                b.innerHTML += `<div style="display:flex; flex-direction:column; align-items:flex-end">
                        <div class="ch-bub ch-me" style="opacity:0.7">
                            ${this.lnk(t)}
                            <div class="ch-tm">ğŸ•’ ${this.time(Date.now())}</div>
                        </div>
                    </div>`;
                b.scrollTop = b.scrollHeight;
                document.getElementById('ch-in').value='';

                // Send
                this.call('createMsg', m).then(() => {
                    this.st.msgs.push(m);
                    this.rnCh(); // Re-render with correct tick
                });
            },

            // 5. PROFILE & UTILS
            prof: function(id) {
                const u = this.st.users.find(x=>x.id===id);
                const me = this.st.user;
                const isMe = id===me.id;
                
                document.getElementById('pr-pic').src = u.pic || '';
                document.getElementById('pr-nm').innerText = u.name;
                document.getElementById('pr-id').innerText = '@'+u.nc;
                document.getElementById('pr-bio').innerHTML = this.lnk(u.bio);
                document.getElementById('pr-lnk').innerText = u.web;
                document.getElementById('c-po').innerText = this.st.posts.filter(x=>x.uid===id).length;
                document.getElementById('c-fl').innerText = u.followers.length;
                document.getElementById('c-fi').innerText = u.following.length;

                const act = document.getElementById('pr-act'); act.innerHTML='';
                if(!isMe) {
                    let txt='Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù†', cls='btn-p';
                    if(me.following.includes(id)) { txt='Ù„ØºÙˆ Ø¯Ù†Ø¨Ø§Ù„'; cls='btn-o'; }
                    else if(u.requests.includes(me.id)) { txt='Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ø¯Ù‡'; cls='btn-o'; }
                    
                    act.innerHTML = `<button class="btn ${cls}" style="flex:1" onclick="app.fol('${id}')">${txt}</button>
                                     <button class="btn btn-o" style="flex:1" onclick="app.chat('${id}')">Ù¾ÛŒØ§Ù…</button>`;
                } else {
                    act.innerHTML = `<button class="btn btn-o" style="flex:1" onclick="app.nav('st')">ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ù…Ø§ÛŒÙ‡</button>`;
                }

                const canSee = isMe || !u.isPrivate || u.followers.includes(me.id);
                const pf = document.getElementById('pr-feed'); pf.innerHTML='';
                if(canSee) {
                    this.st.posts.filter(x=>x.uid===id).sort((a,b)=>b.time-a.time).forEach(p => pf.innerHTML+=this.htmlP(p));
                } else {
                    pf.innerHTML = '<div style="text-align:center;padding:30px;color:gray">ğŸ”’ Ø§ÛŒÙ† Ø­Ø³Ø§Ø¨ Ø®ØµÙˆØµÛŒ Ø§Ø³Øª</div>';
                }
            },
            fol: function(id) {
                const u = this.st.users.find(x=>x.id===id);
                const me = this.st.user;
                
                if(me.following.includes(id)) {
                    me.following = me.following.filter(x=>x!==id);
                    u.followers = u.followers.filter(x=>x!==me.id);
                } else if(u.isPrivate) {
                    if(!u.requests.includes(me.id)) u.requests.push(me.id);
                } else {
                    me.following.push(id);
                    u.followers.push(me.id);
                }
                this.prof(id);
                this.call('updateUser', [me, u]);
            },

            // HELPER FUNCTIONS
            lnk: function(t) {
                if(!t) return '';
                // ØªØ¨Ø¯ÛŒÙ„ Ù…Ù†Ø´Ù† @username Ø¨Ù‡ Ù„ÛŒÙ†Ú© Ù¾Ø±ÙˆÙØ§ÛŒÙ„ (Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø³ØªÙˆÙ† B/nc)
                return t.replace(/@(\w+)/g, (match, nc) => {
                    const target = this.st.users.find(x=>x.nc === nc);
                    if(target) return `<span class="ment" onclick="event.stopPropagation();app.nav('pr','${target.id}')">${match}</span>`;
                    return match;
                });
            },
            copyLnk: function(pid) {
                const url = window.location.origin + window.location.pathname + '?p=' + pid;
                navigator.clipboard.writeText(url);
                app.toast('Ù„ÛŒÙ†Ú© Ù¾Ø³Øª Ú©Ù¾ÛŒ Ø´Ø¯');
            },
            share: function() {
                const url = window.location.origin + window.location.pathname + '?u=' + this.st.user.id;
                navigator.clipboard.writeText(url);
                app.toast('Ù„ÛŒÙ†Ú© Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ù¾ÛŒ Ø´Ø¯');
            },
            time: function(ms) {
                return new Date(ms).toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit'});
            },
            srch: function(v) {
                const r = document.getElementById('res-bx'); r.innerHTML='';
                if(!v) return;
                this.st.users.filter(x=>x.name.includes(v) || x.nc.includes(v)).forEach(u => {
                    r.innerHTML += `<div class="card flex-al" onclick="app.nav('pr','${u.id}')">
                        <img src="${u.pic}" class="av">
                        <div><b>${u.name}</b><br><small>@${u.nc}</small></div>
                    </div>`;
                });
            },
            setUI: function() {
                const u = this.st.user;
                document.getElementById('st-nc').innerText=u.nc;
                document.getElementById('st-rf').innerText=u.refCode;
                document.getElementById('e-pic').value=u.pic;
                document.getElementById('e-nm').value=u.name;
                document.getElementById('e-bio').value=u.bio;
                document.getElementById('e-web').value=u.web;
                document.getElementById('e-men').value=u.mention;
                document.getElementById('e-pri').checked=u.isPrivate;
                document.getElementById('e-msg').checked=u.allowMsg;
            },
            saveSet: async function() {
                const u = this.st.user;
                u.pic = document.getElementById('e-pic').value;
                u.name = document.getElementById('e-nm').value;
                u.bio = document.getElementById('e-bio').value;
                u.web = document.getElementById('e-web').value;
                u.mention = document.getElementById('e-men').value;
                u.isPrivate = document.getElementById('e-pri').checked;
                u.allowMsg = document.getElementById('e-msg').checked;
                app.toast('Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...');
                await this.call('updateUser', u);
                app.toast('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
            },
            toast: function(t) {
                const x = document.getElementById('tst');
                x.innerText = t; x.classList.add('show');
                setTimeout(()=>x.classList.remove('show'), 3000);
            },
            bdg: function() {
                const r = this.st.user.requests.length;
                const m = this.st.msgs.filter(x=>x.to===this.st.user.id && !x.read).length;
                const b = document.getElementById('bg-ms');
                if(r+m > 0) { b.innerText=r+m; b.classList.remove('hide'); }
                else b.classList.add('hide');
            }
        };
        app.init();
    </script>
</body>
</html>
