<div id="searchForm">
    <div class="form-group">
      <input type="tel" id="searchInput" placeholder="کد ملی خود را وارد کنید" maxlength="10" />
    </div>
    <button id="searchBtn"><i class="fas fa-search"></i>جستجو</button>
</div>

<div id="loadingMsg">در حال بارگذاری اطلاعات، لطفاً صبر کنید...</div>
<div id="errorMsg"></div>

<div id="resultsContainer">
    <div class="user-info-card" id="userInfo"></div>

    <div class="progress-section">
        <div class="progress-bar">
            <div class="progress-bar-fill"></div>
        </div>
        <p class="progress-text"></p>
    </div>

    <ul class="status-timeline" id="statusTimeline"></ul>
    <div class="action-buttons" id="actionButtons"></div>
</div>

  </div>

  <script>
    // === URLs and Constants ===
    const url1 = 'https://docs.google.com/spreadsheets/d/1c0g7deSI0y-QP4nQNux-l07_cumu3A6Gy0OolnhZWdU/export?format=xlsx';
    const url2 = 'https://docs.google.com/spreadsheets/d/1QSRAGajWtCWHJHsU-u4dRW85nq2hCGySKqtZQL0iTjY/export?format=xlsx';
    const driveFolderLink = 'https://drive.google.com/drive/folders/1-pUvCoHflHaLVIcSZJ3nR471I-HEEbn-';
    
    // === DOM Elements ===
    const loadingMsg = document.getElementById('loadingMsg');
    const errorMsg = document.getElementById('errorMsg');
    const resultsContainer = document.getElementById('resultsContainer');
    const userInfo = document.getElementById('userInfo');
    const actionButtons = document.getElementById('actionButtons');
    const statusTimeline = document.getElementById('statusTimeline');
    const input = document.getElementById('searchInput');
    const btn = document.getElementById('searchBtn');
    const searchForm = document.getElementById('searchForm');
    const progressBarFill = document.querySelector('.progress-bar-fill');
    const progressText = document.querySelector('.progress-text');
    
    // === Data Storage ===
    let allData = [], sheet2Data = [];

    // === Data Fetching (Optimized Handling) ===
    const dataLoadingPromise = Promise.all([
        fetch(url1).then(res => res.arrayBuffer()),
        fetch(url2).then(res => res.arrayBuffer())
    ]).then(([buffer1, buffer2]) => {
        const workbook1 = XLSX.read(buffer1, { type: 'array' });
        allData = XLSX.utils.sheet_to_json(workbook1.Sheets[workbook1.SheetNames[0]], { header: 1 }).slice(1);
        
        const workbook2 = XLSX.read(buffer2, { type: 'array' });
        sheet2Data = XLSX.utils.sheet_to_json(workbook2.Sheets[workbook2.SheetNames[0]], { header: 1 }).slice(1);
    }).catch(err => {
        console.error("خطا در بارگذاری فایل‌های اکسل:", err);
        showError("خطا در ارتباط با سرور. لطفاً اتصال اینترنت خود را بررسی کرده و مجدداً تلاش کنید.");
        throw err; // Re-throw to be caught by later promises
    });

    // === Event Listeners ===
    window.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const nationalId = urlParams.get('id');

        loadingMsg.style.display = 'block';
        searchForm.style.display = 'none';

        dataLoadingPromise.then(() => {
            loadingMsg.style.display = 'none';
            searchForm.style.display = 'block';
            if (nationalId) {
                input.value = nationalId;
                performSearch();
            }
        }).catch(() => {
            loadingMsg.style.display = 'none';
        });
    });

    btn.addEventListener('click', performSearch);
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            performSearch();
        }
    });

    // === Core Functions ===
    function showError(message) {
        errorMsg.textContent = message;
        errorMsg.style.display = 'block';
    }

    function performSearch() {
        resultsContainer.style.display = 'none';
        errorMsg.style.display = 'none';

        const userInput = input.value.trim();
        if (!/^\d{10}$/.test(userInput)) {
            return showError("لطفاً یک کد ملی معتبر ۱۰ رقمی وارد کنید.");
        }

        const searchTerm = userInput.replace(/^0+/, '');
        const projectRecord = allData.find(row => row && row[4] && (row[4].toString().replace(/^0+/, '') === searchTerm));
        const registrationInfo = sheet2Data.find(row => row && row[1] && (row[1].toString().replace(/^0+/, '') === searchTerm));

        if (!registrationInfo) {
            return showError("کد ملی وارد شده در سامانه ثبت نام یافت نشد.");
        }
        
        // --- Data Extraction ---
        const studentName = registrationInfo[0] || 'دانشجوی گرامی';
        const courseName = registrationInfo[2] || 'نامشخص';
        const startDate = registrationInfo[4];
        const projectLink = projectRecord?.[9];
        const certLink = projectRecord?.[15];

        // --- START: ویرایش اصلی - محاسبه تاریخ پایان دوره و بررسی شرط ۸۵ روز ---
        let isCoursePeriodOver = false;
        let courseEndDateInfo = ''; 

        if (startDate && typeof startDate === 'string' && startDate.trim() !== '') {
            try {
                // استفاده از jalali-moment برای مدیریت تاریخ شمسی
                // فرمت jYYYY/jM/jD برای پشتیبانی از ماه‌ها و روزهای تک‌رقمی (مثل 1403/5/1) استفاده می‌شود
                const startDateMoment = jalaliMoment(startDate, 'jYYYY/jM/jD');
                if (startDateMoment.isValid()) {
                    // محاسبه تاریخ پایان دوره: ۸۵ روز بعد از تاریخ شروع
                    const endDateMoment = startDateMoment.clone().add(85, 'days');
                    const now = jalaliMoment();
                    
                    // بررسی اینکه آیا امروز بعد از تاریخ پایان دوره است یا خیر
                    isCoursePeriodOver = now.isAfter(endDateMoment);
                    
                    // آماده‌سازی متن برای نمایش تاریخ پایان دوره به کاربر
                    courseEndDateInfo = `تاریخ مورد نیاز برای دسترسی: ${endDateMoment.format('jYYYY/jMM/jDD')}`;
                }
            } catch (e) {
                console.error("خطا در پردازش تاریخ شروع دوره:", e);
                // در صورت خطا، برای اطمینان شرط را false در نظر می‌گیریم
            }
        } else {
            // اگر تاریخ شروع ثبت نشده باشد، فرض می‌کنیم دوره تمام شده تا محتوا نمایش داده شود
            isCoursePeriodOver = true; 
        }
        // --- END: ویرایش اصلی ---

        // --- Status Calculation ---
        const statuses = {
            registered: {
                completed: !!registrationInfo,
                title: "ثبت نام اولیه",
                details: startDate ? `تاریخ شروع: ${startDate}` : "تکمیل شده"
            },
            courseFinished: {
                completed: !!projectRecord,
                title: "اتمام دوره",
                details: projectRecord ? "تکمیل شده" : "در حال برگزاری"
            },
            projectSent: {
                completed: projectLink && projectLink.trim() !== '',
                title: "ارسال پروژه",
                details: projectLink ? "پروژه ارسال شده" : "در انتظار ارسال"
            },
            certificateIssued: {
                completed: certLink && certLink.trim() !== '',
                title: "صدور گواهی",
                details: certLink ? `شماره گواهی: ${projectRecord?.[11] || 'نامشخص'}` : "در انتظار صدور"
            }
        };

        // --- UI Updates ---
        updateUserInfo(studentName, courseName, userInput);
        updateProgressBar(statuses);
        updateTimeline(statuses);
        // ارسال نتیجه بررسی تاریخ به تابع دکمه‌ها
        updateActionButtons(projectLink, certLink, !!registrationInfo, isCoursePeriodOver, courseEndDateInfo);

        resultsContainer.style.display = 'block';
    }
    
    function updateUserInfo(name, course, id) {
        userInfo.innerHTML = `
            <h2>${name}</h2>
            <p>${course} (کد ملی: ${id})</p>
        `;
    }

    function updateProgressBar(statuses) {
        const statusValues = Object.values(statuses);
        const completedCount = statusValues.filter(s => s.completed).length;
        const totalCount = statusValues.length;
        const percentage = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;

        progressBarFill.style.width = `${percentage}%`;
        progressText.textContent = `پیشرفت شما: ${Math.round(percentage)}% (${completedCount} از ${totalCount} مرحله تکمیل شده)`;
    }

    function updateTimeline(statuses) {
        statusTimeline.innerHTML = '';
        for (const key in statuses) {
            const status = statuses[key];
            const li = document.createElement('li');
            li.className = `timeline-item ${status.completed ? 'completed' : 'pending'}`;
            
            const iconClass = status.completed ? 'fa-check' : 'fa-hourglass-half';
            
            li.innerHTML = `
                <div class="timeline-icon"><i class="fas ${iconClass}"></i></div>
                <div class="timeline-content">
                    <h3>${status.title}</h3>
                    <p>${status.details}</p>
                </div>
            `;
            statusTimeline.appendChild(li);
        }
    }

    // --- START: ویرایش اصلی - تابع نمایش شرطی دکمه‌ها ---
    function updateActionButtons(projectLink, certLink, hasRegistered, isCoursePeriodOver, courseEndDateInfo) {
        let buttonsHTML = '';
        
        if (isCoursePeriodOver) {
            // اگر ۸۵ روز گذشته باشد، دکمه‌ها را در صورت وجود لینک نمایش بده
            if (projectLink) {
                buttonsHTML += `<a href="${projectLink}" target="_blank" class="action-btn project-link"><i class="fas fa-file-alt"></i>مشاهده پروژه</a>`;
            }
            if (certLink) {
                buttonsHTML += `<a href="${certLink}" target="_blank" class="action-btn cert-link"><i class="fas fa-certificate"></i>دانلود گواهی</a>`;
            }
            if (hasRegistered) {
                buttonsHTML += `<a href="${driveFolderLink}" target="_blank" class="action-btn drive-link"><i class="fas fa-book-open"></i>مشاهده جزوات</a>`;
            }
        } else {
            // اگر هنوز ۸۵ روز نگذشته باشد، پیام مربوطه را نمایش بده
            let message = `<div style="text-align: center; color: var(--text-muted); background-color: var(--input-bg); padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0;">
                               <p style="margin: 0; line-height: 1.6;">
                                   دانشجوی گرامی، دسترسی به گواهینامه، پروژه و جزوات پس از اتمام دوره ۸۵ روزه امکان‌پذیر خواهد بود.
                               </p>`;
            
            // اگر تاریخ پایان دوره محاسبه شده باشد، آن را برای شفافیت بیشتر نمایش بده
            if (courseEndDateInfo) {
                 message += `<p style="margin: 8px 0 0; font-weight: bold; color: var(--primary-blue);">${courseEndDateInfo}</p>`;
            }
            
            message += `</div>`;
            buttonsHTML = message;
        }
        
        actionButtons.innerHTML = buttonsHTML;
    }
    // --- END: ویرایش اصلی ---
  </script>

</body>
</html>
