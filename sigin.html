   <!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ثبت نام دوره مربیگری نوجوان | موسسه تعالی</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root { /* ... استایل‌ها بدون تغییر ... */ }
        /* << ویرایش: استایل‌های جدید برای مودال >> */
        #terms-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6);
            display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px);
        }
        #terms-modal .modal-content {
            background: white; padding: 2.5rem; border-radius: var(--radius-md); width: 90%; max-width: 500px;
            animation: fadeIn 0.4s forwards;
        }
        #terms-modal h2 { margin-top: 0; }
        #terms-modal ul { text-align: right; padding-right: 1.5rem; margin-bottom: 2rem; line-height: 2; }
        #terms-modal ul li { margin-bottom: 0.5rem; }
        #terms-modal button { width: 100%; }
        /* (سایر استایل‌ها در اینجا قرار دارند و بدون تغییر باقی مانده‌اند) */
    </style>
</head>
<body>

    <div class="container">
        <!-- ... سایر view ها ... -->
        <div id="form-view" class="view">
            <div id="form-header">
                <!-- ... -->
            </div>
            <form id="registration-form">
                <!-- << ویرایش: افزودن فیلد مخفی برای توکن کپچا >> -->
                <input type="hidden" id="captchaToken">
                <!-- ... سایر فیلدهای فرم ... -->
            </form>
        </div>
        <!-- ... -->
    </div>
    
    <!-- << ویرایش: بازگرداندن مودال شرایط و قوانین >> -->
    <div id="terms-modal">
        <div class="modal-content">
            <h2>شرایط ثبت‌نام در دوره</h2>
            <p>کاربر گرامی، ثبت‌نام در این دوره مختص افراد واجد شرایط زیر می‌باشد:</p>
            <ul>
                <li>دانشجویان خواهر و برادر دارای مدرک کارشناسی</li>
                <li>طلاب خواهر و برادر دارای مدرک سطح یک</li>
                <li>حافظان قرآن کریم دارای مدرک حفظ کل</li>
                <li>داشتن حداقل سن ۲۰ سال تمام</li>
            </ul>
            <button id="accept-terms-btn" class="btn">شرایط را خوانده و می‌پذیرم</button>
        </div>
    </div>

    <!-- ... المان تایمر ... -->
    
<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx9JEjBH7WoXgZPhTqsUaXoyO1t26h3wUH9ChYMFxIXswfPotZ825z8h9xdJt5orNc/exec"; // <<<<<< لینک اسکریپت

const views = { /* ... بدون تغییر ... */ };
// ... تعریف المان‌ها ...
const termsModal = document.getElementById('terms-modal'); // << ویرایش: تعریف مودال
const acceptTermsBtn = document.getElementById('accept-terms-btn'); // << ویرایش: تعریف دکمه مودال

function handleStatusResponse(response) {
    switch (response.status) {
        // ... سایر case ها ...
        case 'OPEN':
            // << ویرایش: ابتدا مودال را نمایش بده >>
            document.getElementById('form-title').innerHTML = `ثبت‌نام ${response.courseName}`;
            document.getElementById('course-start-date-info').innerHTML = `تاریخ شروع دوره: <strong>${response.courseStartDateFa}</strong>`;
            document.getElementById('capacity-info').innerHTML = `ظرفیت باقی‌مانده: <strong>${response.remainingCapacity} نفر</strong>`;
            moveCountdownTimer('form-countdown-container');
            startCountdown(response.targetDate, 'زمان باقی‌مانده تا پایان مهلت ثبت‌نام');
            
            // << ویرایش: تنظیم کپچا از سرور >>
            document.getElementById('captcha-question').textContent = response.captchaQuestion;
            document.getElementById('captchaToken').value = response.captchaToken;
            
            termsModal.style.display = 'flex'; // نمایش مودال
            break;
        // ... سایر case ها ...
    }
}

// ... سایر توابع جاوا اسکریپت ...

// << ویرایش: رویداد کلیک برای دکمه پذیرش شرایط >>
acceptTermsBtn.addEventListener('click', () => {
    termsModal.style.display = 'none';
    switchView('form'); // حالا فرم را نمایش بده
});

registrationForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    // ...
    
    // << ویرایش: ساختار جدید formData برای ارسال به سرور >>
    const formData = {
        fullName: document.getElementById('fullName').value,
        nationalId: document.getElementById('nationalId').value,
        dob: `${year}/${month}/${day}`,
        phone: document.getElementById('phone').value,
        education: document.getElementById('education').value,
        captchaAnswer: document.getElementById('captcha').value,
        captchaToken: document.getElementById('captchaToken').value
    };

    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST', body: JSON.stringify(formData),
            headers: { 'Content-Type': 'application/json' }, redirect: 'follow'
        });
        const result = await response.json();
        if (result.status === 'success') {
            document.getElementById('success-message').innerHTML = result.message;
            switchView('success');
        } else {
            formError.innerHTML = result.message || 'خطایی رخ داده است. لطفاً دوباره تلاش کنید.';
            formError.style.display = 'block';
            // اگر خطا مربوط به کپچا بود، صفحه را برای دریافت کپچای جدید رفرش می‌کنیم
            if (result.message.includes("امنیتی")) {
                setTimeout(() => window.location.reload(), 2000);
            }
        }
    } catch (error) {
        // ...
    } finally {
        submitBtn.disabled = false;
        // ...
    }
});
</script>

</body>
</html>```
