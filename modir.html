 <!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1400">
    <title>پنل مدیریت جامع - موسسه تعالی</title>
    <meta name="robots" content="noindex, nofollow">
    <meta name="googlebot" content="noindex, nofollow">
    <meta name="bingbot" content="noindex, nofollow">
    <link rel="canonical" href="https://script.google.com/macros/s/AKfycbxfuZC2sz7UihlH0DYwgjkfqqOTAKHtmcQvUEGwKs4MZQzkkUDRvhvgwwimxGQLK16s/exec" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700;800&display=swap');
    
    /* Light Mode Variables (Default) */
    :root {
        --primary: #0d6efd;
        --primary-light: #e7f3ff;
        --primary-dark: #0056b3;
        --text-dark: #212529;
        --text-light: #6c757d;
        --text-on-dark: #ffffff;
        --bg-main: #f8f9fa;
        --bg-card: #ffffff;
        --border-color: #e9ecef;
        --success: #198754;
        --danger: #dc3545;
        --warning: #ffc107;
        --info: #0dcaf0;
        --shadow: 0 4px 25px rgba(0,0,0,0.08);
        --radius-lg: 16px;
        --radius-md: 12px;
        --transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    /* Dark Mode Variables */
    html.dark-mode {
        --primary: #5b90f7; --primary-light: #1e3a8a; --primary-dark: #004085;
        --text-dark: #e0e0e0; --text-light: #a0a0a0; --text-on-dark: #ffffff;
        --bg-main: #1a202c; --bg-card: #2d3748; --border-color: #4a5568;
        --shadow: 0 4px 25px rgba(0,0,0,0.4);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body { 
        font-family: 'Vazirmatn', sans-serif; 
        background-color: var(--bg-main); 
        color: var(--text-dark);
        min-width: 1400px;
        transition: background-color var(--transition), color var(--transition);
    }
    html.modal-open, body.modal-open { overflow: hidden; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes modal-pop-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

    .page-loader { position: fixed; inset: 0; background: var(--bg-main); display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s, visibility 0.5s; }
    .page-loader.hidden { opacity: 0; visibility: hidden; }
    .page-loader .spinner { width: 40px; height: 40px; border: 4px solid var(--primary-light); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    
    #login-view { 
        display: flex; align-items: center; justify-content: center; min-height: 100vh; 
        padding: 20px; animation: fadeIn 0.5s; background-image: url('https://tashacol.ir/123.jpg');
        background-size: cover; background-position: center; background-repeat: no-repeat;
    }
    .login-container { width: 100%; max-width: 420px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); padding: 40px; border-radius: var(--radius-lg); box-shadow: var(--shadow); text-align: center; }
    .login-container .logo-image { max-width: 180px; margin-bottom: 25px; }
    .login-container h1 { font-size: 1.8rem; margin-bottom: 8px; color: #212529; }
    .login-container p { color: #6c757d; margin-bottom: 30px; }
    .input-wrapper { position: relative; margin-bottom: 20px; }
    .input-icon { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); color: var(--text-light); }
    .form-input { width: 100%; padding: 14px 50px 14px 15px; border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem; outline: none; transition: var(--transition); background: var(--bg-main); color: var(--text-dark); }
    .form-input:focus { border-color: var(--primary); background: var(--bg-card); box-shadow: 0 0 0 3px var(--primary-light); }
    .btn-login { width: 100%; padding: 14px; font-size: 1.1rem; font-weight: 500; background: var(--primary); color: var(--text-on-dark); border: none; border-radius: var(--radius-md); cursor: pointer; transition: var(--transition); position: relative; min-height: 52px; display: flex; align-items: center; justify-content: center; }
    .btn-login:hover:not(:disabled) { background: var(--primary-dark); }
    .btn-login.loading .spinner { opacity: 1; }
    .btn-login .spinner { width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3); border-top-color: var(--text-on-dark); border-radius: 50%; animation: spin 0.8s linear infinite; position: absolute; opacity: 0; transition: var(--transition); }
    #login-error-msg { margin-top: 15px; color: var(--danger); min-height: 20px; font-weight: 500; }
    .grecaptcha-badge { visibility: hidden; }
    
    #dashboard-view { display: none; padding-top: 70px; }
    /* ... (تمام استایل‌های دیگر بدون تغییر در اینجا قرار می‌گیرند) ... */
    /* ... The rest of your CSS styles go here, unchanged ... */
    /* ... Paste all your previous <style> content here ... */
    #toast-container {
        position: fixed;
        top: 90px; /* Below the header */
        left: 30px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
        direction: ltr; /* Ensure toasts appear correctly */
    }
    .toast {
        background-color: var(--bg-card);
        color: var(--text-dark);
        padding: 15px 20px;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow);
        border-right: 5px solid var(--primary);
        display: flex;
        align-items: center;
        gap: 15px;
        opacity: 0;
        transform: translateX(100%);
        animation: toast-in 0.5s forwards;
        min-width: 350px;
    }
    @keyframes toast-in {
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    .toast.hide {
        animation: toast-out 0.5s forwards;
    }
    @keyframes toast-out {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(120%);
        }
    }
    .toast .toast-icon {
        font-size: 1.5rem;
    }
    .toast span {
        font-family: 'Vazirmatn', sans-serif;
        font-weight: 500;
        direction: rtl;
        text-align: right;
        width: 100%;
    }
    .toast.success { border-right-color: var(--success); }
    .toast.success .toast-icon { color: var(--success); }
    .toast.error { border-right-color: var(--danger); }
    .toast.error .toast-icon { color: var(--danger); }
    .toast.info { border-right-color: var(--info); }
    .toast.info .toast-icon { color: var(--info); }
    </style>
</head>
<body>

<div class="page-loader" id="pageLoader"><div class="spinner"></div></div>

<div id="login-view">
    <div class="login-container">
        <img src="https://tashacol.ir/1754843708220.png" alt="موسسه تعالی" class="logo-image">
        <h1>پنل مدیریت موسسه</h1>
        <p>ویژه مدیر عامل موسسه</p>
        <form id="loginForm" onsubmit="event.preventDefault(); handleLoginAttempt();">
            <div class="input-wrapper"><i class="fas fa-user input-icon"></i><input type="number" id="username" class="form-input" placeholder="نام کاربری" required></div>
            <div class="input-wrapper"><i class="fas fa-lock input-icon"></i><input type="password" id="password" class="form-input" placeholder="رمز عبور" required></div>
            <!-- ElEMENT reCAPTCHA به صورت نامرئی -->
            <div id="recaptcha-container"></div>
            <button class="btn-login" id="loginButton"><span class="btn-text">ورود</span><div class="spinner"></div></button>
        </form>
        <p id="login-error-msg"></p>
    </div>
</div>

<div id="dashboard-view">
    <!-- ... (تمام محتوای داشبورد شما بدون تغییر در اینجا قرار می‌گیرد) ... -->
    <!-- ... Your entire #dashboard-view HTML content goes here, unchanged ... -->
</div>

<!-- Modals -->
<!-- ... (تمام مودال‌های شما بدون تغییر در اینجا قرار می‌گیرند) ... -->
<!-- ... All your modal HTML structures go here, unchanged ... -->

<div id="toast-container"></div>

<!-- کتابخانه reCAPTCHA گوگل -->
<script src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoad&render=explicit" async defer></script>

<script>
    // ==========================================================
    //  هسته جاوا اسکریپت امن شده با reCAPTCHA و سیستم توکن سرور-ساید
    // ==========================================================
    document.addEventListener('DOMContentLoaded', () => {
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx9CkeNu_sxo2L6t6eES76JCl85ZqYoldKtawQohi-qepMkQoEhTqlZYtiiOYFEXA0o/exec"; 
        const RECAPTCHA_SITE_KEY = '6Lc1vqkrAAAAAHLHbzPMzlREvKwgHDNSmakrB-aq';

        // --- متغیرهای سراسری برای مدیریت جلسه ---
        let sessionToken = null;
        let recaptchaWidgetId;
        
        // ... (تمام Element selectors شما بدون تغییر در اینجا قرار می‌گیرند) ...
        const pageLoader = document.getElementById('pageLoader'), loginView = document.getElementById('login-view'), dashboardView = document.getElementById('dashboard-view');
        const loginForm = document.getElementById('loginForm'), loginButton = document.getElementById('loginButton'), logoutButton = document.getElementById('logoutButton'), loginErrorMsg = document.getElementById('login-error-msg');
        // ... and so on for all your other element selectors

        // --- توابع کمکی ---
        const showToast = (message, type = 'info') => { /* ... (کد تابع showToast بدون تغییر) ... */ };
        // ... (سایر توابع کمکی شما مانند renderSkeleton, renderPagination و ...) ...

        // ==========================================================
        //  بخش جدید: مدیریت کامل ارتباطات امن با سرور
        // ==========================================================

        /**
         * تابع اصلی برای ارسال تمام درخواست‌ها به سرور به صورت امن
         * @param {object} payload داده‌ای که باید به سرور ارسال شود (شامل action و سایر پارامترها)
         * @returns {Promise<object>} پاسخ JSON از سرور
         */
        const secureFetch = async (payload) => {
            // برای تمام درخواست‌ها به جز لاگین، توکن جلسه را اضافه کن
            if (payload.action !== 'ceoLogin') {
                if (!sessionToken) {
                    console.error("Session token is missing.");
                    handleLogout(); // اگر توکن نبود، کاربر را خارج کن
                    throw new Error("جلسه شما نامعتبر است.");
                }
                payload.token = sessionToken;
            }

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // برای جلوگیری از preflight CORS
                    body: JSON.stringify(payload),
                    redirect: 'follow'
                });

                if (!response.ok) {
                    throw new Error('خطای شبکه در برقراری ارتباط با سرور.');
                }
                
                const result = await response.json();

                // مدیریت خطای احراز هویت از سمت سرور
                if (result.authError) {
                    console.error("Authentication error from server:", result.message);
                    handleLogout(); // توکن نامعتبر است، کاربر را خارج کن
                    throw new Error(result.message);
                }

                if (result.error && !result.authError) {
                   throw new Error(result.message);
                }
                
                return result;

            } catch (error) {
                console.error(`Secure fetch failed for action "${payload.action}":`, error);
                // پرتاب مجدد خطا تا در جای دیگر مدیریت شود
                throw error;
            }
        };

        // ==========================================================
        //  بخش جدید: مدیریت ورود و reCAPTCHA
        // ==========================================================
        
        // تابع callback برای زمانی که API گوگل بارگذاری می‌شود
        window.onRecaptchaLoad = function() {
          if (document.getElementById('recaptcha-container')) {
              recaptchaWidgetId = grecaptcha.render('recaptcha-container', {
                'sitekey' : RECAPTCHA_SITE_KEY,
                'callback' : onLoginRecaptchaSuccess,
                'error-callback': onRecaptchaError,
                'size' : 'invisible'
              });
          }
        };
        
        // در صورت بروز خطا در reCAPTCHA
        const onRecaptchaError = () => {
            showToast('خطا در اعتبارسنجی reCAPTCHA. لطفاً اینترنت خود را بررسی و صفحه را رفرش کنید.', 'error');
            loginButton.classList.remove('loading');
            loginButton.disabled = false;
        };

        // شروع فرآیند ورود با کلیک روی دکمه
        window.handleLoginAttempt = () => {
            if (!loginForm.checkValidity()) {
                loginForm.reportValidity();
                return;
            }
            loginErrorMsg.textContent = '';
            loginButton.classList.add('loading');
            loginButton.disabled = true;
            grecaptcha.execute(recaptchaWidgetId);
        };
        
        // این تابع پس از تأیید موفقیت‌آمیز reCAPTCHA توسط گوگل فراخوانی می‌شود
        async function onLoginRecaptchaSuccess(recaptchaToken) {
            try {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                const result = await secureFetch({
                    action: 'ceoLogin',
                    username: username,
                    password: password,
                    recaptchaToken: recaptchaToken
                });

                if (result.success && result.token) {
                    // موفقیت‌آمیز! توکن را ذخیره کن و داشبورد را راه‌اندازی کن
                    sessionStorage.setItem('sessionToken', result.token);
                    sessionStorage.setItem('ceoInfo', JSON.stringify(result.data));
                    sessionToken = result.token;
                    initDashboard(result.data);
                } else {
                    // اگر سرور خطای دیگری برگرداند
                    throw new Error(result.message || 'اطلاعات ورود نامعتبر است.');
                }
            } catch (error) {
                loginErrorMsg.textContent = error.message;
            } finally {
                loginButton.classList.remove('loading');
                loginButton.disabled = false;
                grecaptcha.reset(recaptchaWidgetId);
            }
        }
        
        // ==========================================================
        //  بازنویسی توابع fetch داده‌ها برای استفاده از secureFetch
        // ==========================================================

        const fetchPaginatedData = async (config) => {
            const { action, page, pageSize, startDateEl, endDateEl, tableBody, paginationContainer, renderFunction, navHandler, filterBtn, searchParams } = config;
            filterBtn.classList.add('loading'); filterBtn.disabled = true;
            
            const payload = { action, page, pageSize };
            if (startDateEl && startDateEl.value) payload.startDate = startDateEl.value;
            if (endDateEl && endDateEl.value) payload.endDate = endDateEl.value;
            if (searchParams) { Object.assign(payload, searchParams); }
            
            // ... (بخش رندر کردن اسکلت بدون تغییر) ...

            try {
                const result = await secureFetch(payload);
                // ... (بخش رندر کردن داده‌ها و صفحه‌بندی بدون تغییر) ...
            } catch (error) {
                // ... (بخش مدیریت خطا بدون تغییر) ...
            } finally {
                filterBtn.classList.remove('loading'); filterBtn.disabled = false;
            }
        };

        const fetchNonPaginatedData = async (action, renderFunc, container) => {
            // ... (بخش رندر اسکلت بدون تغییر) ...
            
            try {
                const result = await secureFetch({ action });
                const dataToRender = result.data || result;
                renderFunc(dataToRender);
            } catch (error) {
                // ... (بخش مدیریت خطا) ...
            }
        };
        
        // ... (تمام توابع fetch شما مانند fetchTransactions, fetchCourses و غیره، بدون تغییر در منطق داخلی آن‌ها باقی می‌مانند،
        // زیرا اکنون همه از fetchPaginatedData یا fetchNonPaginatedData استفاده می‌کنند که خودشان امن شده‌اند.)

        // ==========================================================
        //  منطق اصلی برنامه و مدیریت جلسه
        // ==========================================================
        
        const initDashboard = (ceoInfo) => {
            // ... (کد این تابع بدون تغییر باقی می‌ماند) ...
            // ceoNameDropdown.textContent = ceoInfo.name;
            // ...
            loginView.style.display = 'none';
            dashboardView.style.display = 'block';
            pageLoader.classList.add('hidden');
            refreshDashboard(); 
        };

        const handleLogout = async () => {
            if (sessionToken) {
                try {
                    // به سرور اطلاع بده تا توکن را باطل کند (اختیاری ولی امن‌تر)
                    await secureFetch({ action: 'logout' });
                } catch(e) {
                    console.warn("Could not notify server of logout. Clearing session locally.");
                }
            }
            sessionStorage.clear();
            sessionToken = null;
            location.reload();
        };
        
        logoutButton.addEventListener('click', handleLogout);

        // --- شروع برنامه ---
        const checkSession = () => {
            const storedToken = sessionStorage.getItem('sessionToken');
            const storedCeoInfo = sessionStorage.getItem('ceoInfo');

            if (storedToken && storedCeoInfo) {
                sessionToken = storedToken;
                try {
                    const ceoInfo = JSON.parse(storedCeoInfo);
                    initDashboard(ceoInfo);
                } catch (e) {
                    // اگر اطلاعات ذخیره شده خراب بود، پاک کن و به صفحه لاگین برو
                    handleLogout();
                }
            } else {
                pageLoader.classList.add('hidden');
                loginView.style.display = 'flex';
            }
            loadThemePreference();
        };

        checkSession(); // شروع برنامه با بررسی جلسه
    });
</script>


</body>
</html>
