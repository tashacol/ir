<!DOCTYPE html>  
<html lang="fa" dir="rtl">
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1400">
    <meta name="robots" content="noindex, nofollow">
    <title>پنل مدیریت جامع - موسسه تعالی</title>
    <meta name="googlebot" content="noindex, nofollow">
    <meta name="bingbot" content="noindex, nofollow">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* CSS styles remain exactly the same as you provided... */
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700;800&display=swap');
    :root { --primary: #0d6efd; --primary-light: #e7f3ff; --primary-dark: #0056b3; --text-dark: #212529; --text-light: #6c757d; --text-on-dark: #ffffff; --bg-main: #f8f9fa; --bg-card: #ffffff; --border-color: #e9ecef; --success: #198754; --danger: #dc3545; --warning: #ffc107; --info: #0dcaf0; --shadow: 0 4px 25px rgba(0,0,0,0.08); --radius-lg: 16px; --radius-md: 12px; --transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
    html.dark-mode { --primary: #5b90f7; --primary-light: #1e3a8a; --primary-dark: #004085; --text-dark: #e0e0e0; --text-light: #a0a0a0; --text-on-dark: #ffffff; --bg-main: #1a202c; --bg-card: #2d3748; --border-color: #4a5568; --shadow: 0 4px 25px rgba(0,0,0,0.4); }
    * { margin: 0; padding: 0; box-sizing: border-box; } html { scroll-behavior: smooth; }
    body { font-family: 'Vazirmatn', sans-serif; background-color: var(--bg-main); color: var(--text-dark); min-width: 1400px; transition: background-color var(--transition), color var(--transition); }
    html.modal-open, body.modal-open { overflow: hidden; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } } @keyframes spin { to { transform: rotate(360deg); } } @keyframes modal-pop-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    
    /* === START: QUANTUM LOADER STYLES === */
    @keyframes nucleus-pulse {
        0% { transform: scale(1); box-shadow: 0 0 10px #66d9ef, 0 0 20px #66d9ef, 0 0 40px #66d9ef; }
        50% { transform: scale(1.1); box-shadow: 0 0 20px #a6e22e, 0 0 40px #a6e22e, 0 0 80px #a6e22e; }
        100% { transform: scale(1); box-shadow: 0 0 10px #66d9ef, 0 0 20px #66d9ef, 0 0 40px #66d9ef; }
    }
    @keyframes electron-orbit-1 { to { transform: rotate3d(1, 1, 1, 360deg); } }
    @keyframes electron-orbit-2 { to { transform: rotate3d(-1, 1, 1, 360deg); } }
    @keyframes electron-orbit-3 { to { transform: rotate3d(1, -1, 1, 360deg); } }

    .page-loader { 
        position: fixed; 
        inset: 0; 
        background: rgba(13, 22, 35, 0.9);
        backdrop-filter: blur(10px);
        display: flex; 
        flex-direction: column;
        align-items: center; 
        justify-content: center; 
        z-index: 9999; 
        transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
        opacity: 1;
        visibility: visible;
    }
    .page-loader.hidden { 
        opacity: 0; 
        visibility: hidden; 
    }
    .page-loader p {
        color: #e0e0e0;
        margin-top: 50px;
        font-size: 1.3rem;
        font-weight: 500;
        text-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
    }
    .quantum-loader-container {
        perspective: 1000px;
    }
    .atom {
        position: relative;
        width: 150px;
        height: 150px;
        transform-style: preserve-3d;
    }
    .atom::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        background: #fff;
        transform: translate(-50%, -50%);
        animation: nucleus-pulse 2s infinite ease-in-out;
    }
    .electron {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: 3px solid #66d9ef;
        border-radius: 50%;
        transform-style: preserve-3d;
    }
    .electron::before {
        content: '';
        position: absolute;
        top: 50%;
        left: -6px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: #a6e22e;
        box-shadow: 0 0 15px #a6e22e;
        transform: translateY(-50%);
    }
    .electron:nth-child(1) { animation: electron-orbit-1 2s linear infinite; }
    .electron:nth-child(2) { animation: electron-orbit-2 3s linear infinite; border-color: #f92672; }
    .electron:nth-child(2)::before { background-color: #f92672; box-shadow: 0 0 15px #f92672; }
    .electron:nth-child(3) { animation: electron-orbit-3 4s linear infinite; border-color: #ae81ff; }
    .electron:nth-child(3)::before { background-color: #ae81ff; box-shadow: 0 0 15px #ae81ff; }
    /* === END: QUANTUM LOADER STYLES === */

    #login-view { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; animation: fadeIn 0.5s; background-image: url('https://tashacol.ir/123.jpg'); background-size: cover; background-position: center; background-repeat: no-repeat; }
    .login-container { width: 100%; max-width: 420px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); padding: 40px; border-radius: var(--radius-lg); box-shadow: var(--shadow); text-align: center; }
    .login-container .logo-image { max-width: 180px; margin-bottom: 25px; } .login-container h1 { font-size: 1.8rem; margin-bottom: 8px; color: #212529; } .login-container p { color: #6c757d; margin-bottom: 30px; } .input-wrapper { position: relative; margin-bottom: 20px; } .input-icon { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); color: var(--text-light); }
    .form-input { width: 100%; padding: 14px 50px 14px 15px; border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem; outline: none; transition: var(--transition); background: var(--bg-main); color: var(--text-dark); }
    .form-input:focus { border-color: var(--primary); background: var(--bg-card); box-shadow: 0 0 0 3px var(--primary-light); }
    
    /* === START: LOADING BUTTON CSS FIX === */
    .btn-login { width: 100%; padding: 14px; font-size: 1.1rem; font-weight: 500; background: var(--primary); color: var(--text-on-dark); border: none; border-radius: var(--radius-md); cursor: pointer; transition: var(--transition); position: relative; min-height: 52px; display: flex; align-items: center; justify-content: center; }
    .btn-login:hover:not(:disabled) { background: var(--primary-dark); }
    /* Hide the spinner by default */
    .btn-login .spinner { position: absolute; width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3); border-top-color: var(--text-on-dark); border-radius: 50%; animation: spin 0.8s linear infinite; visibility: hidden; opacity: 0; }
    /* When loading, show the spinner */
    .btn-login.loading .spinner { visibility: visible; opacity: 1; }
    /* When loading, hide the text */
    .btn-login.loading .btn-text { visibility: hidden; }
    /* === END: LOADING BUTTON CSS FIX === */

    #login-error-msg { margin-top: 15px; color: var(--danger); min-height: 20px; font-weight: 500; }
    #dashboard-view { display: none; padding-top: 70px; }
    .dashboard-header { background: var(--bg-card); padding: 0 30px; height: 70px; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow); position: fixed; top: 0; right: 0; left: 0; z-index: 100; transition: background-color var(--transition), box-shadow var(--transition); }
    .header-logo, .user-profile-trigger { cursor: pointer; } .header-logo { display: flex; align-items: center; color: var(--text-dark); font-weight: 700; font-size: 1.2rem; } .header-logo i { margin-left: 10px; color: var(--primary); } .header-controls { display: flex; align-items: center; }
    .icon-button { background: none; border: none; font-size: 1.5rem; color: var(--text-light); cursor: pointer; margin-right: 15px; transition: var(--transition); display: flex; align-items: center; justify-content: center; padding: 5px; border-radius: 50%; }
    .icon-button:hover { color: var(--primary); background-color: var(--primary-light); }
    .icon-button.loading i { animation: spin 1s linear infinite; } .user-profile-trigger { display: flex; align-items: center; }
    .user-profile-trigger .avatar { width: 40px; height: 40px; background: var(--primary-light); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
    .dropdown { position: relative; }
    .dropdown-menu { display: none; position: absolute; background-color: var(--bg-card); min-width: 300px; box-shadow: var(--shadow); border-radius: var(--radius-md); z-index: 101; margin-top: 15px; border: 1px solid var(--border-color); animation: fadeIn 0.2s; transition: background-color var(--transition), border-color var(--transition), box-shadow var(--transition); }
    .dropdown-menu.show { display: block; } .user-profile-trigger + .dropdown-menu { left: 0; } .header-logo + .dropdown-menu { right: 0; }
    .dropdown-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); text-align: center; } .dropdown-header h4 { margin: 0; font-size: 1.1rem; } .dropdown-header p { margin: 5px 0 0; color: var(--text-light); font-size: 0.9rem; } .dropdown-list { list-style: none; padding: 10px; } .dropdown-list li { padding: 10px 15px; font-size: 0.95rem; color: var(--text-light); display: flex; align-items: center; } .dropdown-list li i { width: 24px; text-align: center; margin-left: 10px; color: var(--primary); }
    .dropdown-logout-btn { width: calc(100% - 20px); margin: 10px; background: var(--danger); color: #fff; border:none; padding: 10px; border-radius: 8px; cursor:pointer; font-family: inherit; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .main-container { max-width: 1400px; margin: 30px auto; padding: 0 30px; animation: fadeIn 0.5s; }
    .section-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; } .full-width-section { margin-bottom: 30px; }
    .card { background: var(--bg-card); border-radius: var(--radius-lg); box-shadow: var(--shadow); padding: 25px; display: flex; flex-direction: column; transition: background-color var(--transition), box-shadow var(--transition), border-color var(--transition); }
    .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
    .card-header .title-part { display: flex; align-items: center;} .card-header .icon { color: var(--primary); font-size: 1.5rem; margin-left: 15px; } .card-header h2 { font-size: 1.3rem; margin: 0; }
    .financial-stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; } .stat-item { padding: 20px; border-radius: var(--radius-md); background: var(--bg-main); transition: background-color var(--transition); } .stat-item .label { display: flex; align-items: center; color: var(--text-light); margin-bottom: 8px; } .stat-item .label i { margin-left: 8px; font-size: 1.1rem; } .stat-item .value { font-size: 1.7rem; font-weight: 700; } .stat-item .value small { font-size: 1rem; font-weight: 400; color: var(--text-light); } .stat-item.income .value { color: var(--success); } .stat-item.expense .value { color: var(--danger); }
    .table-responsive { overflow-x: auto; min-height: 250px; } .data-table { width: 100%; border-collapse: collapse; text-align: right; }
    .data-table td { padding: 15px 10px; border-bottom: 1px solid var(--border-color); white-space: nowrap; transition: border-color var(--transition); }
    .data-table th { font-weight: 700; color: var(--primary); font-size: 0.9rem; padding: 15px 10px; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
    .data-table tbody tr:last-child td { border-bottom: none; } .data-table .amount { font-weight: 500; } .data-table .amount.positive { color: var(--success); } .data-table .amount.negative { color: var(--danger); }
    .data-table .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 500; color: #fff; text-align: center; display: inline-block; min-width: 80px; }
    .status-badge.active { background-color: var(--success); } .status-badge.finished { background-color: var(--border-color); color: var(--text-light); } .status-badge.upcoming { background-color: var(--primary); }
    .cost-icon { font-size: 1.2rem; color: var(--warning); cursor: pointer; transition: transform 0.2s; } .cost-icon:hover { transform: scale(1.15); }
    .filter-controls { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
    .filter-controls label { font-size: 0.9rem; color: var(--text-light); white-space: nowrap; }
    .filter-controls .form-input { padding: 8px 12px; height: 40px; width: 150px; background-color: var(--bg-main); }
    .filter-controls button { padding: 8px 20px; height: 40px; background: var(--primary-light); color: var(--primary); font-weight: 500; border: none; border-radius: var(--radius-md); cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 8px;}
    .filter-controls button:hover { background: var(--primary); color: #fff; }
    .filter-controls button .spinner { width: 16px; height: 16px; border: 2px solid; border-radius: 50%; border-right-color: transparent; animation: spin 0.8s linear infinite; display: none; }
    .filter-controls button.loading .spinner { display: block; } .filter-controls button.loading .btn-text { display: none; }
    .pagination-controls { margin-top: 20px; display: flex; justify-content: space-between; align-items: center; }
    .pagination-controls button { padding: 8px 20px; background: var(--primary-light); color: var(--primary); font-weight: 500; border: none; border-radius: 8px; cursor: pointer; transition: var(--transition); }
    .pagination-controls button:hover:not(:disabled) { background: var(--primary); color: #fff; }
    .pagination-controls button:disabled { background: var(--border-color); color: var(--text-light); cursor: not-allowed; }
    .pagination-info { font-size: 0.9rem; color: var(--text-light); font-weight: 500; }
    .add-course-btn { background-color: var(--primary); color: var(--text-on-dark); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition); box-shadow: var(--shadow); }
    .add-course-btn:hover { background-color: var(--primary-dark); transform: scale(1.1); }
    .staff-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
    .staff-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 20px; display: flex; flex-direction: column; transition: var(--transition); }
    .staff-card:hover { transform: translateY(-5px); box-shadow: var(--shadow); }
    .staff-header { display: flex; align-items: center; margin-bottom: 15px; } .staff-avatar { width: 50px; height: 50px; border-radius: 50%; background: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.5rem; margin-left: 15px; flex-shrink: 0; }
    .staff-title .name { font-weight: 700; font-size: 1.1rem; } .staff-title .role { font-size: 0.9rem; color: var(--primary); }
    .staff-info { list-style: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); font-size: 0.95rem; color: var(--text-light); flex-grow: 1; }
    .staff-info li { display: flex; align-items: center; margin-bottom: 10px; } .staff-info li i { margin-left: 10px; width: 18px; text-align: center; }
    .staff-card .btn-login { margin-top: auto; padding: 10px; }
    .action-card-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; } .action-card-grid-four { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
    .action-card { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-decoration: none; color: var(--text-dark); background: var(--bg-main); border-radius: var(--radius-md); transition: var(--transition); }
    .action-card:hover { transform: translateY(-5px); background: var(--primary-light); color: var(--primary); } .action-card .icon { font-size: 2.5rem; margin-bottom: 10px; color: var(--primary); }
    .action-card span { font-weight: 500; text-align: center; font-size: 1rem; }
    .skeleton { animation: skeleton-loading 1.5s linear infinite alternate; background-color: var(--border-color); }
    @keyframes skeleton-loading { from { background-color: var(--border-color); } to { background-color: var(--primary-light); } }
    .skeleton-text { width: 100%; height: 1em; border-radius: 4px; } .skeleton-avatar { width: 50px; height: 50px; border-radius: 50%; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); animation: fadeIn 0.3s; }
    .modal-overlay.show { display: flex; } .modal-box { background: var(--bg-card); padding: 30px; border-radius: var(--radius-lg); width: 90%; max-width: 500px; box-shadow: var(--shadow); position: relative; transition: background-color var(--transition), box-shadow var(--transition); }
    .modal-overlay.show .modal-box { animation: modal-pop-in 0.3s ease-out; }
    .modal-close-btn { position: absolute; top: 15px; left: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); }
    .modal-list { list-style: none; padding: 10px 0; } .modal-list li { padding: 12px 0; font-size: 0.95rem; color: var(--text-light); display: flex; align-items: center; border-bottom: 1px solid var(--border-color); }
    .modal-list li:last-child { border-bottom: none; } .modal-list li i { width: 24px; text-align: center; margin-left: 10px; color: var(--primary); } .modal-header { text-align: center; margin-bottom: 20px; }
    .modal-header .avatar { width: 60px; height: 60px; border-radius: 50%; background: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto 15px; }
    .modal-header h4 { font-size: 1.2rem; } .modal-header p { color: var(--text-light); }
    .form-group { margin-bottom: 20px; } .form-group label { display: block; font-weight: 500; margin-bottom: 8px; color: var(--text-light); }
    .form-group .form-input, .form-group .form-select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: var(--radius-md); background-color: var(--bg-main); color: var(--text-dark); }
    .form-group-inline { display: flex; gap: 10px; } .form-group-inline > * { flex-grow: 1; } .radio-group { display: flex; gap: 20px; margin-top: 10px; }
    .radio-group label { display: flex; align-items: center; gap: 8px; cursor: pointer; } #add-course-cost-value-wrapper { display: none; margin-top: 15px; }
    .modal-submit-btn { width: 100%; padding: 14px; font-size: 1.1rem; font-weight: 500; background: var(--success); color: var(--text-on-dark); border: none; border-radius: var(--radius-md); cursor: pointer; transition: var(--transition); position: relative; min-height: 52px; display: flex; align-items: center; justify-content: center; margin-top: 10px; }
    .modal-submit-btn:hover:not(:disabled) { background: #157347; }
    .modal-submit-btn .spinner { width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3); border-top-color: var(--text-on-dark); border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
    .modal-submit-btn.loading .spinner { display: block; } .modal-submit-btn.loading .btn-text { display: none; }
    .modal-actions { display: flex; gap: 15px; margin-top: 20px; }
    .modal-action-btn { flex-grow: 1; padding: 12px; font-size: 1rem; font-weight: 500; background: var(--primary-light); color: var(--primary); border: none; border-radius: var(--radius-md); cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 8px; font-family: 'Vazirmatn', sans-serif; }
    .modal-action-btn:hover { background: var(--primary); color: var(--text-on-dark); }
    .modal-action-btn.success { background: var(--success); color: var(--text-on-dark); } .modal-divider { border: none; height: 1px; background-color: var(--border-color); margin: 25px 0; transition: background-color var(--transition); }
    .modal-downloads { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; align-items: center; }
    .modal-download-btn { padding: 12px; border-radius: var(--radius-md); background: var(--bg-main); border: 1px solid var(--border-color); color: var(--text-light); text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; transition: var(--transition); font-weight: 500; text-align: center; }
    .modal-download-btn:hover { background: var(--border-color); color: var(--text-dark); border-color: var(--text-light); }
    .modal-download-btn.icon-only { font-size: 1.5rem; }
    .letter-text-btn { background: none; border: 1px solid var(--primary); color: var(--primary); border-radius: var(--radius-md); padding: 6px 12px; font-size: 0.9rem; font-family: inherit; cursor: pointer; transition: var(--transition); display: inline-flex; align-items: center; gap: 6px; }
    .letter-text-btn:hover { background: var(--primary-light); }
    .data-table td .letter-text-btn i { margin: 0; }
    .modal-content-text-wrapper { background-color: var(--bg-main); padding: 15px; border-radius: var(--radius-md); margin-top: 10px; border: 1px solid var(--border-color); }
    .modal-content-text-wrapper p { max-height: 40vh; overflow-y: auto; line-height: 2; text-align: justify; color: var(--text-dark); padding-left: 10px; }
    .approved-course-accordion .course-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background-color: var(--bg-main); border: 1px solid var(--border-color); border-radius: var(--radius-md); cursor: pointer; transition: var(--transition); margin-bottom: 10px; }
    .approved-course-accordion .course-header:hover { border-color: var(--primary); background-color: var(--primary-light); }
    .course-header-info { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; width: 100%; font-weight: 500; }
    .course-header-info span { color: var(--text-light); font-size: 0.9rem; } .course-header-info strong { color: var(--text-dark); font-weight: 700; } .accordion-arrow { transition: transform 0.3s; font-size: 1.2rem; color: var(--text-light); }
    .course-header.active .accordion-arrow { transform: rotate(180deg); color: var(--primary); }
    .student-list-container { background: var(--bg-card); border: 1px solid var(--border-color); border-top: none; padding: 0 20px; border-bottom-left-radius: var(--radius-md); border-bottom-right-radius: var(--radius-md); max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding 0.4s ease-out; }
    .student-list-container.show { max-height: 1000px; padding: 20px; }
    .student-list-container .data-table th, .student-list-container .data-table td { text-align: center; } .student-list-container .data-table th { background-color: var(--bg-main); }
    .student-list-container .table-responsive { min-height: auto; }
    .cert-status-icon { font-size: 1.5rem; color: var(--success); cursor: pointer; transition: transform 0.2s; text-decoration: none; display: inline-block; }
    .cert-status-icon:hover { transform: scale(1.1); } .cert-status-text { font-size: 0.9rem; font-weight: 500; color: var(--warning); }
    @media print { body * { visibility: hidden; } #letter-content-modal, #letter-content-modal * { visibility: visible; } #letter-content-modal { position: absolute; left: 0; top: 0; width: 100%; height: auto; box-shadow: none; border: none; } .modal-box { box-shadow: none !important; border: 1px solid #ccc; width: 100% !important; max-width: 100% !important; padding: 20px; } .modal-close-btn, .modal-actions { display: none !important; } .modal-overlay.show { background: none; align-items: flex-start; } }
    #toast-container { position: fixed; top: 90px; left: 30px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; direction: ltr; }
    .toast { background-color: var(--bg-card); color: var(--text-dark); padding: 15px 20px; border-radius: var(--radius-md); box-shadow: var(--shadow); border-right: 5px solid var(--primary); display: flex; align-items: center; gap: 15px; opacity: 0; transform: translateX(100%); animation: toast-in 0.5s forwards; min-width: 350px; }
    @keyframes toast-in { to { opacity: 1; transform: translateX(0); } } .toast.hide { animation: toast-out 0.5s forwards; }
    @keyframes toast-out { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(120%); } }
    .toast .toast-icon { font-size: 1.5rem; } .toast span { font-family: 'Vazirmatn', sans-serif; font-weight: 500; direction: rtl; text-align: right; width: 100%; }
    .toast.success { border-right-color: var(--success); } .toast.success .toast-icon { color: var(--success); } .toast.error { border-right-color: var(--danger); } .toast.error .toast-icon { color: var(--danger); } .toast.info { border-right-color: var(--info); } .toast.info .toast-icon { color: var(--info); }
    /* Added for reCAPTCHA badge to be compliant with Google's policies */
    .grecaptcha-badge { visibility: hidden; }
</style>
</head>
<body>

<!-- === START: EDITED HTML FOR QUANTUM LOADER === -->
<div class="page-loader" id="pageLoader">
    <div class="quantum-loader-container">
        <div class="atom">
            <div class="electron"></div>
            <div class="electron"></div>
            <div class="electron"></div>
        </div>
    </div>
    <p>در حال برسی اطلاعات</p>
</div>
<!-- === END: EDITED HTML FOR QUANTUM LOADER === -->

<div id="login-view">
    <div class="login-container">
        <img src="https://tashacol.ir/1754843708220.png" alt="موسسه تعالی" class="logo-image">
        <h1>پنل مدیریت موسسه</h1>
        <p>ویژه مدیر عامل موسسه</p>
        <form id="loginForm" onsubmit="event.preventDefault(); handleLogin();">
            <div class="input-wrapper"><i class="fas fa-user input-icon"></i><input type="number" id="username" class="form-input" placeholder="نام کاربری" required></div>
            <div class="input-wrapper"><i class="fas fa-lock input-icon"></i><input type="password" id="password" class="form-input" placeholder="رمز عبور" required></div>
            <button class="btn-login" id="loginButton"><span class="btn-text">ورود</span><div class="spinner"></div></button>
        </form>
        <p id="login-error-msg"></p>
    </div>
</div>

<div id="dashboard-view">
    <!-- The entire dashboard view HTML remains unchanged -->
    <header class="dashboard-header">
        <div class="header-logo" id="info-modal-trigger" title="اطلاعات موسسه"><i class="fas fa-landmark-dome"></i><span>داشبورد مدیریت</span></div>
        <div class="header-controls">
            <button id="theme-toggle-btn" class="icon-button" title="تغییر حالت نمایش"><i class="fas fa-moon"></i></button>
            <button id="refresh-dashboard-btn" class="icon-button" title="به‌روزرسانی داده‌ها"><i class="fas fa-sync-alt"></i></button>
            <div class="dropdown">
                <div class="user-profile-trigger" id="user-dropdown-trigger"><div class="avatar"><i class="fas fa-user-tie"></i></div></div>
                <div id="user-dropdown" class="dropdown-menu">
                    <div class="dropdown-header"><h4 id="ceo-name-dropdown"></h4><p>مدیرعامل موسسه</p></div>
                    <ul class="dropdown-list"><li><i class="fas fa-id-card-clip"></i>کاربر: <span id="ceo-nid-dropdown"></span></li></ul>
                    <button id="logoutButton" class="dropdown-logout-btn"><i class="fas fa-sign-out-alt"></i><span>خروج از حساب</span></button>
                </div>
            </div>
        </div>
    </header>
    <main class="main-container">
        <!-- All cards and sections remain unchanged -->
        <div class="full-width-section"> <div class="card"> <div class="card-header"><div class="title-part"><i class="fas fa-wallet icon"></i><h2>خلاصه وضعیت مالی</h2></div></div> <div class="financial-stats-grid" id="financial-stats-container"></div> </div> </div>
        <div class="section-grid"> <div class="main-column"> <div class="card" style="height:100%;"> <div class="card-header"> <div class="title-part"><i class="fas fa-tasks icon"></i><h2>وضعیت دوره‌ها</h2></div> <button class="add-course-btn" id="add-course-btn" title="افزودن دوره جدید"><i class="fas fa-plus"></i></button> </div> <div class="filter-controls"> <label for="courses-start-date">از تاریخ:</label><input type="date" id="courses-start-date" class="form-input"> <label for="courses-end-date">تا تاریخ:</label><input type="date" id="courses-end-date" class="form-input"> <button id="courses-filter-btn"><span class="btn-text">اعمال فیلتر</span><div class="spinner"></div></button> </div> <div class="table-responsive" style="flex-grow:1;"> <table class="data-table"> <thead><tr><th>نام دوره</th><th>شناسه دوره</th><th>تاریخ شروع</th><th>وضعیت</th><th>هزینه</th></tr></thead> <tbody id="courses-table-body"></tbody> </table> </div> <div class="pagination-controls" id="courses-pagination"></div> </div> </div> <div class="sidebar-column"> <div class="card" style="height: 100%;"> <div class="card-header"><div class="title-part"><i class="fas fa-database icon"></i><h2>داده‌های موسسه</h2></div></div> <div id="data-links-list"></div> </div> </div> </div>
        <div class="full-width-section"> <div class="card"> <div class="card-header"><div class="title-part"><i class="fas fa-cogs icon"></i><h2>خدمات و استعلامات</h2></div></div> <div class="action-card-grid-four" id="services-links-container"></div> </div> </div>
        <div class="full-width-section"> <div class="card"> <div class="card-header"><div class="title-part"><i class="fas fa-file-signature icon"></i><h2>اقدامات سریع</h2></div></div> <div class="action-card-grid-four"> <a href="https://tashacol.github.io/ir/crte.html" target="_blank" class="action-card"><div class="icon"><i class="fas fa-building-user"></i></div><span>نامه سوابق مؤسسه</span></a> <a href="https://tashacol.github.io/ir/jahadi.html" target="_blank" class="action-card"><div class="icon"><i class="fas fa-people-carry-box"></i></div><span>نامه سوابق جهادی</span></a> <a href="https://tashacol.ir/vdaneshjo.html" target="_blank" class="action-card"><div class="icon"><i class="fas fa-user-graduate"></i></div><span>وضعیت دانشجو</span></a> <a id="quick-action-issue-letter" href="#" target="_blank" class="action-card"><div class="icon"><i class="fas fa-file-medical-alt"></i></div><span>نامه آزاد</span></a> </div> </div> </div>
        <div class="full-width-section"> <div class="card"> <div class="card-header"><div class="title-part"><i class="fas fa-receipt icon"></i><h2>ریز تراکنش‌ها</h2></div></div> <div class="filter-controls"> <label for="transactions-start-date">از تاریخ:</label><input type="date" id="transactions-start-date" class="form-input"> <label for="transactions-end-date">تا تاریخ:</label><input type="date" id="transactions-end-date" class="form-input"> <button id="transactions-filter-btn"><span class="btn-text">اعمال فیلتر</span><div class="spinner"></div></button> </div> <div class="table-responsive"> <table class="data-table"> <thead><tr><th>تاریخ</th><th>حسابدار</th><th>درآمد</th><th>مخارج</th><th>سود</th><th>ضرر</th></tr></thead> <tbody id="transactions-table-body"></tbody> </table> </div> <div class="pagination-controls" id="transactions-pagination"></div> </div> </div>
        <div class="full-width-section"> <div class="card"> <div class="card-header"> <div class="title-part"><i class="fas fa-chalkboard-teacher icon"></i><h2>دوره‌های عمومی تائید شده</h2></div> </div> <div class="filter-controls"> <input type="number" id="approved-courses-master-search" class="form-input" placeholder="جستجوی کد ملی استاد..."> <input type="number" id="approved-courses-student-search" class="form-input" placeholder="جستجوی کد ملی دانشجو..."> <button id="approved-courses-filter-btn"><span class="btn-text">جستجو</span><div class="spinner"></div></button> </div> <div id="approved-courses-container"></div> <div class="pagination-controls" id="approved-courses-pagination"></div> </div> </div>
        <div class="full-width-section"> <div class="card"> <div class="card-header"> <div class="title-part"><i class="fas fa-award icon"></i><h2>گواهی های صادره دوره جامع تربیت نوجوان</h2></div> </div> <div class="filter-controls"> <input type="number" id="general-certs-nid-search" class="form-input" placeholder="جستجوی کد ملی..."> <input type="text" id="general-certs-num-search" class="form-input" placeholder="جستجوی شماره گواهی..."> <button id="general-certs-filter-btn"><span class="btn-text">جستجو</span><div class="spinner"></div></button> </div> <div class="table-responsive"> <table class="data-table"> <thead> <tr><th>ردیف</th><th>نام</th><th>کد ملی</th><th>نام دوره</th><th>تاریخ صدور</th><th>شماره گواهی</th><th>مشاهده</th></tr> </thead> <tbody id="general-certs-table-body"></tbody> </table> </div> <div class="pagination-controls" id="general-certs-pagination"></div> </div> </div>
        <div class="full-width-section"> <div class="card"> <div class="card-header"> <div class="title-part"><i class="fas fa-envelope-open-text icon"></i><h2>نامه‌های صادر شده</h2></div> </div> <div class="filter-controls"> <label for="letters-start-date">از تاریخ:</label><input type="date" id="letters-start-date" class="form-input"> <label for="letters-end-date">تا تاریخ:</label><input type="date" id="letters-end-date" class="form-input"> <button id="letters-filter-btn"><span class="btn-text">اعمال فیلتر</span><div class="spinner"></div></button> </div> <div class="table-responsive"> <table class="data-table"> <thead> <tr><th>موضوع نامه</th><th>تاریخ صدور</th><th>شماره نامه</th><th>نام اداره</th><th>متن نامه</th></tr> </thead> <tbody id="letters-table-body"></tbody> </table> </div> <div class="pagination-controls" id="letters-pagination"></div> </div> </div>
        <div class="full-width-section"><div class="card"><div class="card-header"><div class="title-part"><i class="fas fa-users-cog icon"></i><h2>کادر اجرایی</h2></div></div><div class="staff-grid" id="staff-list-container"></div></div></div>
    </main>
</div>
<div class="modal-overlay" id="info-modal"> <div class="modal-box"> <button class="modal-close-btn"><i class="fas fa-times"></i></button> <div class="card-header" style="border:none; margin-bottom:10px; padding:0; justify-content:center;"><i class="fas fa-landmark-dome icon"></i><h2>اطلاعات موسسه تعالی</h2></div> <ul class="modal-list" id="info-text-list"> <li><i class="fas fa-id-card"></i> شناسه ملی: 14013770611</li><li><i class="fas fa-barcode"></i> کد شناسایی: 31605007</li><li><i class="fas fa-file-contract"></i> شماره مجوز: 1403136/32273</li><li><i class="fas fa-hashtag"></i> شماره ثبت: 391</li><li><i class="fas fa-envelope"></i> ایمیل رسمی: irtashacol@gmail.com</li><li><i class="fas fa-envelope-open-text"></i> ایمیل دبیرخانه: Tashaccol@gmail.com</li><li><i class="fas fa-globe"></i> وبسایت: Tashacol.ir</li><li><i class="fab fa-telegram"></i> ایتا: @irtaali</li> </ul> <div class="modal-actions"><button id="copy-info-btn" class="modal-action-btn"><i class="fas fa-copy"></i> کپی متن</button><button id="share-info-btn" class="modal-action-btn"><i class="fas fa-share-alt"></i> ارسال</button></div> <hr class="modal-divider"> <div class="modal-downloads"> <a href="https://drive.google.com/file/d/1oxNCsEachQQU8_HM763wtvBkjjUHqNgz/view?usp=drivesdk" target="_blank" class="modal-download-btn"><i class="fas fa-file-alt"></i> دانلود اساسنامه</a> <a href="https://drive.google.com/file/d/1B-k4vE1LklC8BGe4vWjfoU7CXEtPriz1/view?usp=drivesdk" target="_blank" class="modal-download-btn icon-only" title="دانلود روزنامه رسمی"><i class="fas fa-newspaper"></i></a> <a href="https://drive.google.com/file/d/15megHPfI3Afq47nIOYiVV_E3dhLbrBDn/view?usp=drivesdk" target="_blank" class="modal-download-btn icon-only" title="دانلود بنر معرفی"><i class="fas fa-image"></i></a> </div> </div> </div>
<div class="modal-overlay" id="letter-content-modal"> <div class="modal-box" style="max-width: 650px;"> <button class="modal-close-btn"><i class="fas fa-times"></i></button> <div class="modal-header" style="justify-content: flex-start; align-items: center; margin-bottom: 5px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);"><i class="fas fa-file-alt icon"></i> <div> <h4 style="font-size: 1.2rem; margin: 0;">متن نامه</h4> <p style="text-align: right; margin-top: 8px; font-size: 0.9rem; color: var(--text-light);">شماره: <span id="modal-letter-number"></span> | تاریخ: <span id="modal-letter-date"></span></p> </div> </div> <div class="modal-content-text-wrapper"><p id="modal-letter-text-content"></p></div> <div class="modal-actions"><button id="copy-letter-text-btn" class="modal-action-btn"><i class="fas fa-copy"></i> کپی متن</button><button id="print-letter-btn" class="modal-action-btn"><i class="fas fa-print"></i> چاپ</button></div> </div> </div>
<div class="modal-overlay" id="add-course-modal"> <div class="modal-box"> <button class="modal-close-btn"><i class="fas fa-times"></i></button> <div class="modal-header" style="text-align: right; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 25px;"><h4 style="font-size: 1.2rem;">افزودن دوره جدید</h4></div> <form id="add-course-form"> <div class="form-group"><label for="add-course-name">نام دوره</label><input type="text" id="add-course-name" class="form-input" required></div> <div class="form-group"> <label>تاریخ شروع</label> <div class="form-group-inline"> <input type="text" id="add-course-year" class="form-input" placeholder="سال" readonly> <select id="add-course-month" class="form-select" required></select> <select id="add-course-day" class="form-select" required></select> </div> </div> <div class="form-group"> <label>هزینه</label> <div class="radio-group"><label><input type="radio" name="cost-type" value="free" checked> رایگان</label><label><input type="radio" name="cost-type" value="paid"> دارای هزینه</label></div> <div id="add-course-cost-value-wrapper"> <label for="add-course-cost-value" style="font-size: 0.9em; margin-top: 10px;">مبلغ را به ریال وارد کنید</label> <input type="number" id="add-course-cost-value" class="form-input" placeholder="مثال: 500000"> </div> </div> <div class="form-group"><label for="add-course-participants">تعداد شرکت کنندگان</label><input type="number" id="add-course-participants" class="form-input" required></div> <button type="submit" class="modal-submit-btn" id="add-course-submit-btn"><span class="btn-text">افزودن دوره</span><div class="spinner"></div></button> </form> </div> </div>
<div id="toast-container"></div>

<!-- Google reCAPTCHA v2 Invisible Badge Script -->
<script src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoad&render=explicit" async defer></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // ==========================================================
        //  پیکربندی و متغیرهای اصلی (با مکانیزم امنیتی جدید)
        // ==========================================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx9CkeNu_sxo2L6t6eES76JCl85ZqYoldKtawQohi-qepMkQoEhTqlZYtiiOYFEXA0o/exec"; 
        const RECAPTCHA_SITE_KEY = '6Lc1vqkrAAAAAHLHbzPMzlREvKwgHDNSmakrB-aq';

        const CACHE_DURATION = 12 * 3600 * 1000;
        const COURSES_PAGE_SIZE = 4;
        const TRANSACTIONS_PAGE_SIZE = 5;
        const LETTERS_PAGE_SIZE = 7;
        const APPROVED_COURSES_PAGE_SIZE = 5;
        const GENERAL_CERTS_PAGE_SIZE = 5; 

        // متغیر برای نگهداری توکن امنیتی در زمان اجرای برنامه
        let sessionToken = null;
        let recaptchaWidgetId;

        // --- Element selectors (unchanged) ---
        const pageLoader = document.getElementById('pageLoader'), loginView = document.getElementById('login-view'), dashboardView = document.getElementById('dashboard-view');
        const loginButton = document.getElementById('loginButton'), logoutButton = document.getElementById('logoutButton'), loginErrorMsg = document.getElementById('login-error-msg');
        const ceoNameDropdown = document.getElementById('ceo-name-dropdown'), ceoNidDropdown = document.getElementById('ceo-nid-dropdown');
        const financialStatsContainer = document.getElementById('financial-stats-container');
        const staffListContainer = document.getElementById('staff-list-container');
        const dataLinksList = document.getElementById('data-links-list');
        const servicesLinksContainer = document.getElementById('services-links-container');
        const infoModal = document.getElementById('info-modal'), infoModalTrigger = document.getElementById('info-modal-trigger'), infoModalCloseBtn = infoModal.querySelector('.modal-close-btn');
        const userDropdown = document.getElementById('user-dropdown'), userDropdownTrigger = document.getElementById('user-dropdown-trigger');
        const refreshDashboardBtn = document.getElementById('refresh-dashboard-btn');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const htmlElement = document.documentElement;
        const transactionsTableBody = document.getElementById('transactions-table-body'), transactionsPagination = document.getElementById('transactions-pagination'), transactionsFilterBtn = document.getElementById('transactions-filter-btn'), transactionsStartDate = document.getElementById('transactions-start-date'), transactionsEndDate = document.getElementById('transactions-end-date');
        const coursesTableBody = document.getElementById('courses-table-body'), coursesPagination = document.getElementById('courses-pagination'), coursesFilterBtn = document.getElementById('courses-filter-btn'), coursesStartDate = document.getElementById('courses-start-date'), coursesEndDate = document.getElementById('courses-end-date');
        const lettersTableBody = document.getElementById('letters-table-body'), lettersPagination = document.getElementById('letters-pagination'), lettersFilterBtn = document.getElementById('letters-filter-btn'), lettersStartDate = document.getElementById('letters-start-date'), lettersEndDate = document.getElementById('letters-end-date'), letterContentModal = document.getElementById('letter-content-modal'), letterContentModalText = document.getElementById('modal-letter-text-content'), letterContentModalCloseBtn = letterContentModal.querySelector('.modal-close-btn'), modalLetterNumber = document.getElementById('modal-letter-number'), modalLetterDate = document.getElementById('modal-letter-date'), copyLetterTextBtn = document.getElementById('copy-letter-text-btn'), printLetterBtn = document.getElementById('print-letter-btn');
        const approvedCoursesContainer = document.getElementById('approved-courses-container'), approvedCoursesPagination = document.getElementById('approved-courses-pagination'), approvedCoursesFilterBtn = document.getElementById('approved-courses-filter-btn'), approvedCoursesMasterSearch = document.getElementById('approved-courses-master-search'), approvedCoursesStudentSearch = document.getElementById('approved-courses-student-search');
        const generalCertsTableBody = document.getElementById('general-certs-table-body'), generalCertsPagination = document.getElementById('general-certs-pagination'), generalCertsFilterBtn = document.getElementById('general-certs-filter-btn'), generalCertsNidSearch = document.getElementById('general-certs-nid-search'), generalCertsNumSearch = document.getElementById('general-certs-num-search');
        const addCourseBtn = document.getElementById('add-course-btn'), addCourseModal = document.getElementById('add-course-modal'), addCourseModalCloseBtn = addCourseModal.querySelector('.modal-close-btn'), addCourseForm = document.getElementById('add-course-form'), addCourseSubmitBtn = document.getElementById('add-course-submit-btn'), addCourseCostWrapper = document.getElementById('add-course-cost-value-wrapper'), costTypeRadios = document.querySelectorAll('input[name="cost-type"]'), addCourseYear = document.getElementById('add-course-year'), addCourseMonth = document.getElementById('add-course-month'), addCourseDay = document.getElementById('add-course-day');

        // ==========================================================
        //  توابع کمکی و هسته برنامه (Helper & Core Functions)
        // ==========================================================

        const setCache = (key, data) => sessionStorage.setItem(key, JSON.stringify({ data, timestamp: new Date().getTime() }));
        const getCache = (key) => {
            const itemStr = sessionStorage.getItem(key); if (!itemStr) return null;
            const item = JSON.parse(itemStr);
            if (key !== 'ceoInfo') { // Only dashboard data expires
                const isExpired = (new Date().getTime() - item.timestamp) > CACHE_DURATION;
                if (isExpired) { sessionStorage.removeItem(key); return null; }
            }
            return item.data;
        };

        const showToast = (message, type = 'info') => {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            let iconClass = 'fa-info-circle';
            if (type === 'success') iconClass = 'fa-check-circle';
            if (type === 'error') iconClass = 'fa-times-circle';
            toast.innerHTML = `<i class="fas ${iconClass} toast-icon"></i><span>${message}</span>`;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('hide');
                toast.addEventListener('animationend', () => toast.remove());
            }, 4000);
        };

        const handleLogout = () => {
            sessionToken = null;
            sessionStorage.clear();
            location.reload();
        };

        // --- Data Fetching and Rendering (Now Secured with POST and Token) ---
        const secureFetch = async (payload) => {
            // Add the session token to every request except login
            if (payload.action !== 'ceoLogin') {
                if (!sessionToken) {
                    showToast('نشست شما نامعتبر است. لطفاً وارد شوید.', 'error');
                    handleLogout();
                    throw new Error("No session token.");
                }
                payload.token = sessionToken;
            }

            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Required for Apps Script e.postData
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error('خطای شبکه در برقراری ارتباط با سرور.');
            const result = await response.json();

            // Global handling for authorization errors
            if (result.authError) {
                showToast(result.message, 'error');
                handleLogout();
                throw new Error("Authorization failed.");
            }
            if (result.error) throw new Error(result.message);
            return result;
        };
        
        const fetchPaginatedData = async (config) => {
            const { action, page, pageSize, startDateEl, endDateEl, tableBody, paginationContainer, renderFunction, navHandler, filterBtn, searchParams } = config;
            filterBtn.classList.add('loading'); filterBtn.disabled = true;

            const payload = { action, page, pageSize };
            if (startDateEl && startDateEl.value) payload.startDate = startDateEl.value;
            if (endDateEl && endDateEl.value) payload.endDate = endDateEl.value;
            if (searchParams) { Object.assign(payload, searchParams); }

            let container = tableBody || approvedCoursesContainer;
            if (action === 'getApprovedCourses') { renderAccordionSkeleton(pageSize, container); } 
            else if (tableBody) { const cols = tableBody.previousElementSibling.rows[0].cells.length; renderSkeleton(pageSize, cols, tableBody); }
            if (paginationContainer) paginationContainer.innerHTML = '';
            
            try {
                const result = await secureFetch(payload);
                if (result.data && result.data.length > 0) { renderFunction(result.data, container, page, pageSize); } 
                else { const cols = tableBody ? tableBody.previousElementSibling.rows[0].cells.length : 1; const message = `<tr><td colspan="${cols}" style="text-align:center; padding: 40px 0; color: var(--text-light);">موردی برای نمایش یافت نشد.</td></tr>`; container.innerHTML = (action === 'getApprovedCourses') ? `<p style="text-align:center; padding: 40px 0; color: var(--text-light);">موردی برای نمایش یافت نشد.</p>` : message; }
                if (paginationContainer) renderPagination(paginationContainer, result.currentPage, result.totalPages, navHandler);
            } catch (error) {
                if (error.message !== "Authorization failed." && error.message !== "No session token.") {
                    const cols = tableBody ? tableBody.previousElementSibling.rows[0].cells.length : 1; 
                    const errorMessage = `<tr><td colspan="${cols}" style="text-align:center; padding: 40px 0; color:var(--danger);">${error.message}</td></tr>`; 
                    container.innerHTML = (action === 'getApprovedCourses') ? `<p style="text-align:center; padding: 40px 0; color:var(--danger);">${error.message}</p>` : errorMessage; 
                    if (paginationContainer) paginationContainer.innerHTML = '';
                }
            } finally { filterBtn.classList.remove('loading'); filterBtn.disabled = false; }
        };

        const fetchNonPaginatedData = async (action, cacheKey, renderFunc, container) => {
            let secondaryContainer = null;
            if (action === 'getDashboardLinks') secondaryContainer = document.getElementById('services-links-container');
            
            // Skeletons remain unchanged...
            if(container) { if (action === 'getFinancialSummary') { container.innerHTML = Array(4).fill('').map(() => `<div class="stat-item"><div class="skeleton skeleton-text" style="width: 60%; height: 1.2rem; margin-bottom: 10px;"></div><div class="skeleton skeleton-text" style="width: 80%; height: 2rem;"></div></div>`).join(''); } else if (action === 'getStaff') { container.innerHTML = Array(3).fill('').map(() => `<div class="staff-card"><div class="staff-header"><div class="skeleton skeleton-avatar"></div><div class="staff-title" style="flex:1;"><div class="skeleton skeleton-text" style="width: 60%;"></div><div class="skeleton skeleton-text" style="width: 40%; margin-top:8px;"></div></div></div><ul class="staff-info">${Array(2).fill('<li><div class="skeleton skeleton-text"></div></li>').join('')}</ul></div>`).join(''); } else if (action === 'getDashboardLinks') { const skeletonHtmlFour = Array(4).fill('').map(() => `<a href="#" class="action-card skeleton"><div class="skeleton skeleton-text" style="width:80%; height:1.5rem;"></div></a>`).join(''); container.innerHTML = skeletonHtmlFour; if (secondaryContainer) secondaryContainer.innerHTML = skeletonHtmlFour; } }

            const cachedData = getCache(cacheKey);
            if (cachedData) { renderFunc(cachedData); return; }

            try {
                const result = await secureFetch({ action });
                const dataToRender = result.data || result;
                setCache(cacheKey, dataToRender);
                renderFunc(dataToRender);
            } catch (error) {
                if (error.message !== "Authorization failed." && error.message !== "No session token.") {
                  const errorHtml = `<p style="text-align:center; color:var(--danger); padding:20px 0;">${error.message}</p>`;
                  if(container) container.innerHTML = errorHtml;
                  if(secondaryContainer) secondaryContainer.innerHTML = errorHtml;
                }
            }
        };

        const renderSkeleton = (rows, cols, container) => { container.innerHTML = Array(rows).fill('').map(() => `<tr>${Array(cols).fill('<td><div class="skeleton skeleton-text"></div></td>').join('')}</tr>`).join(''); };
        const renderAccordionSkeleton = (rows, container) => { container.innerHTML = Array(rows).fill('').map(() => `<div class="approved-course-accordion"><div class="course-header" style="margin-bottom: 10px;"><div class="course-header-info"><span><div class="skeleton skeleton-text" style="width: 80%;"></div></span><span><div class="skeleton skeleton-text" style="width: 70%;"></div></span><span><div class="skeleton skeleton-text" style="width: 60%;"></div></span></div><i class="fas fa-chevron-down accordion-arrow"></i></div></div>`).join(''); };
        const renderPagination = (container, currentPage, totalPages, navHandler) => { if (totalPages <= 1) { container.innerHTML = ''; return; } container.innerHTML = `<button class="prev-btn" ${currentPage === 1 ? 'disabled' : ''}>قبلی</button><span class="pagination-info">صفحه ${currentPage} از ${totalPages}</span><button class="next-btn" ${currentPage === totalPages ? 'disabled' : ''}>بعدی</button>`; container.querySelector('.prev-btn').addEventListener('click', () => navHandler(currentPage - 1)); container.querySelector('.next-btn').addEventListener('click', () => navHandler(currentPage + 1)); };
        
        // --- All render functions (renderTransactions, renderCourses, etc.) remain unchanged ---
        const fetchTransactions = (page = 1) => { fetchPaginatedData({ action: 'getFinancials', page, pageSize: TRANSACTIONS_PAGE_SIZE, startDateEl: transactionsStartDate, endDateEl: transactionsEndDate, tableBody: transactionsTableBody, paginationContainer: transactionsPagination, renderFunction: renderTransactions, navHandler: fetchTransactions, filterBtn: transactionsFilterBtn }); }; const renderTransactions = (data, container) => { container.innerHTML = data.map(t => `<tr><td>${t.date}</td><td>${t.accountant}</td><td class="amount positive">${t.income}</td><td class="amount negative">${t.expenses}</td><td class="amount positive">${t.profit}</td><td class="amount negative">${t.loss}</td></tr>`).join(''); }; const fetchCourses = (page = 1) => { fetchPaginatedData({ action: 'getCourseStatuses', page, pageSize: COURSES_PAGE_SIZE, startDateEl: coursesStartDate, endDateEl: coursesEndDate, tableBody: coursesTableBody, paginationContainer: coursesPagination, renderFunction: renderCourses, navHandler: fetchCourses, filterBtn: coursesFilterBtn }); }; const renderCourses = (data, container) => { const statusClasses = { 'جاری': 'active', 'اتمام': 'finished', 'نام‌نویسی': 'upcoming' }; container.innerHTML = data.map(course => `<tr><td>${course.name}</td><td>${course.code}</td><td>${course.startDate}</td><td><span class="status-badge ${statusClasses[course.status] || ''}">${course.status}</span></td><td style="text-align:center;"><i class="fas fa-coins cost-icon" data-cost="${course.cost}" title="نمایش هزینه"></i></td></tr>`).join(''); }; const fetchLetters = (page = 1) => { fetchPaginatedData({ action: 'getIssuedLetters', page, pageSize: LETTERS_PAGE_SIZE, startDateEl: lettersStartDate, endDateEl: lettersEndDate, tableBody: lettersTableBody, paginationContainer: lettersPagination, renderFunction: renderLetters, navHandler: fetchLetters, filterBtn: lettersFilterBtn }); }; const renderLetters = (data, container) => { container.innerHTML = data.map(letter => { const encodedText = encodeURIComponent(letter.letterText); return `<tr><td>${letter.subject}</td><td>${letter.issueDate}</td><td>${letter.letterNumber}</td><td>${letter.department}</td><td><button class="letter-text-btn" data-text="${encodedText}" data-number="${letter.letterNumber}" data-date="${letter.issueDate}"><i class="fas fa-bars"></i> متن نامه</button></td></tr>`; }).join(''); container.querySelectorAll('.letter-text-btn').forEach(btn => { btn.addEventListener('click', event => { const { text, number, date } = event.currentTarget.dataset; modalLetterNumber.textContent = number; modalLetterDate.textContent = date; letterContentModalText.textContent = decodeURIComponent(text); letterContentModal.classList.add('show'); document.body.classList.add('modal-open'); }); }); }; const fetchApprovedCourses = (page = 1) => { const searchParams = { masterNid: approvedCoursesMasterSearch.value, studentNid: approvedCoursesStudentSearch.value }; fetchPaginatedData({ action: 'getApprovedCourses', page, pageSize: APPROVED_COURSES_PAGE_SIZE, paginationContainer: approvedCoursesPagination, renderFunction: renderApprovedCourses, navHandler: fetchApprovedCourses, filterBtn: approvedCoursesFilterBtn, searchParams: searchParams }); }; const renderApprovedCourses = (data, container) => { container.innerHTML = data.map(course => { let studentsHtml = `<div class="student-list-container"><div class="table-responsive"><table class="data-table"><thead><tr><th>ردیف</th><th>نام و نام خانوادگی</th><th>کد ملی</th><th>وضعیت گواهی</th></tr></thead><tbody>`; if(course.students && course.students.length > 0) { course.students.forEach((student, index) => { let statusHtml = ''; if (student.certStatus === '5') { statusHtml = `<a href="https://tashacol.ir/equran.html?id=${student.nationalId}" target="_blank" title="مشاهده گواهینامه" class="cert-status-icon"><i class="fas fa-check-circle"></i></a>`; } else if (student.certStatus === '2') { statusHtml = `<span class="cert-status-text">در حال بررسی</span>`; } studentsHtml += `<tr><td>${index + 1}</td><td>${student.name}</td><td>${student.nationalId}</td><td>${statusHtml}</td></tr>`; }); } else { studentsHtml += `<tr><td colspan="4" style="text-align:center; padding: 20px;">قرآن‌آموزی برای این دوره ثبت نشده است.</td></tr>`; } studentsHtml += '</tbody></table></div></div>'; return `<div class="approved-course-accordion"><div class="course-header"><div class="course-header-info"><span>نام دوره: <strong>${course.courseName || 'نامشخص'}</strong></span><span>نام استاد: <strong>${course.masterName}</strong></span><span>تاریخ شروع: <strong>${course.startDate}</strong></span></div><i class="fas fa-chevron-down accordion-arrow"></i></div>${studentsHtml}</div>`; }).join(''); container.querySelectorAll('.course-header').forEach(header => { header.addEventListener('click', () => { const content = header.nextElementSibling; header.classList.toggle('active'); content.classList.toggle('show'); }); }); }; const fetchGeneralCertificates = (page = 1) => { const searchParams = { nationalId: generalCertsNidSearch.value, certNumber: generalCertsNumSearch.value }; fetchPaginatedData({ action: 'getGeneralCertificates', page, pageSize: GENERAL_CERTS_PAGE_SIZE, tableBody: generalCertsTableBody, paginationContainer: generalCertsPagination, renderFunction: renderGeneralCertificates, navHandler: fetchGeneralCertificates, filterBtn: generalCertsFilterBtn, searchParams: searchParams }); }; const renderGeneralCertificates = (data, container, page, pageSize) => { const startIndex = (page - 1) * pageSize; container.innerHTML = data.map((cert, index) => { const certLinkHtml = cert.link ? `<a href="${cert.link}" target="_blank" title="مشاهده گواهینامه" class="cert-status-icon"><i class="fas fa-check-circle"></i></a>` : ''; return `<tr><td>${startIndex + index + 1}</td><td>${cert.name}</td><td>${cert.nationalId}</td><td>${cert.courseName}</td><td>${cert.issueDate}</td><td>${cert.certNumber}</td><td style="text-align:center;">${certLinkHtml}</td></tr>`; }).join(''); }; const renderFinancialSummary = (data) => { financialStatsContainer.innerHTML = `<div class="stat-item income"><div class="label"><i class="fas fa-arrow-up"></i><span>درآمد کل</span></div><p class="value">${data.totalIncome || '0'}<small> تومان</small></p></div><div class="stat-item expense"><div class="label"><i class="fas fa-arrow-down"></i><span>هزینه کل</span></div><p class="value">${data.totalExpenses || '0'}<small> تومان</small></p></div><div class="stat-item"><div class="label"><i class="fas fa-chart-line"></i><span>سود کل</span></div><p class="value">${data.totalProfit || '0'}<small> تومان</small></p></div><div class="stat-item"><div class="label"><i class="fas fa-balance-scale-left"></i><span>ضرر کل</span></div><p class="value">${data.totalLoss || '0'}<small> تومان</small></p></div>`; }; const renderStaff = (data) => { staffListContainer.innerHTML = data.map(staff => `<div class="staff-card"><div class="staff-header"><div class="staff-avatar">${staff.name.charAt(0)}</div><div class="staff-title"><div class="name">${staff.name}</div><div class="role">${staff.role}</div></div></div><ul class="staff-info"><li><i class="fas fa-id-card"></i><span>${staff.nationalId}</span></li><li><i class="fas fa-calendar-alt"></i><span>شروع: ${staff.startDate}</span></li></ul><a href="tel:${staff.phone}" class="btn-login"><i class="fas fa-phone" style="margin-left: 8px;"></i> تماس</a></div>`).join(''); };
        const renderDataLinks = (links) => {
            const quickActionIssueLetter = document.getElementById('quick-action-issue-letter');
            if (quickActionIssueLetter) { quickActionIssueLetter.href = links.issueLetter || '#'; }
            dataLinksList.innerHTML = `
                <div class="action-card-grid" style="margin-bottom: 20px;">
                    <a href="${links.students || '#'}" target="_blank" class="action-card"><div class="icon"><i class="fas fa-graduation-cap"></i></div><span>لیست دانشجویان</span></a>
                    <a href="${links.registrations || '#'}" target="_blank" class="action-card"><div class="icon"><i class="fas fa-user-plus"></i></div><span>ثبت نام کنندگان</span></a>
                </div>
                <div class="action-card-grid">
                    <a href="${links.members || '#'}" target="_blank" class="action-card"><div class="icon"><i class="fas fa-users"></i></div><span>اعضای موسسه</span></a>
                    <a href="${links.feedback || '#'}" target="_blank" class="action-card"><div class="icon"><i class="fas fa-comments"></i></div><span>نظرات</span></a>
                </div>`;
            if (servicesLinksContainer) { 
                servicesLinksContainer.innerHTML = `<a href="https://tashacol.ir/Info.html" target="_blank" class="action-card"><div class="icon"><i class="fas fa-person-chalkboard"></i></div><span>دوره تربیت نوجوان</span></a><a href="https://tashacol.github.io/ir/panel.html" target="_blank" class="action-card"><div class="icon"><i class="fas fa-user-graduate"></i></div><span>کاربری دانشجویان</span></a><a href="https://tashacol.ir/estelamat.html" target="_blank" class="action-card"><div class="icon"><i class="fas fa-search-plus"></i></div><span>استعلامات</span></a><a href="https://tashacol.ir/mo.html" target="_blank" class="action-card"><div class="icon"><i class="fas fa-user-check"></i></div><span>کاربری کادر</span></a>`; 
            }
        };

        // --- Core Application Logic (Now with Secure Functions) ---
        const refreshDashboard = async () => {
            refreshDashboardBtn.classList.add('loading'); refreshDashboardBtn.disabled = true;
            Object.keys(sessionStorage).forEach(key => { if(key !== 'ceoInfo') sessionStorage.removeItem(key) });
            try {
                await Promise.all([
                    fetchNonPaginatedData('getFinancialSummary', 'financialSummaryData', renderFinancialSummary, financialStatsContainer),
                    fetchTransactions(1), fetchCourses(1), fetchLetters(1), fetchApprovedCourses(1), fetchGeneralCertificates(1),
                    fetchNonPaginatedData('getStaff', 'staffData', renderStaff, staffListContainer),
                    fetchNonPaginatedData('getDashboardLinks', 'dashboardLinks', renderDataLinks, dataLinksList)
                ]);
                showToast("داشبورد با موفقیت به‌روزرسانی شد.", "success");
            } catch (error) {
                console.error("Error refreshing dashboard:", error);
            } finally {
                refreshDashboardBtn.classList.remove('loading');
                refreshDashboardBtn.disabled = false;
            }
        };

        const initDashboard = (ceoInfo) => {
            ceoNameDropdown.textContent = ceoInfo.name;
            ceoNidDropdown.textContent = ceoInfo.nationalId;
            loginView.style.display = 'none';
            dashboardView.style.display = 'block';
            pageLoader.classList.add('hidden');
            refreshDashboard();
        };

        const loadThemePreference = () => { const preferredTheme = localStorage.getItem('theme'); if (preferredTheme === 'dark') { htmlElement.classList.add('dark-mode'); themeToggleBtn.querySelector('i').classList.replace('fa-moon', 'fa-sun'); } else { htmlElement.classList.remove('dark-mode'); themeToggleBtn.querySelector('i').classList.replace('fa-sun', 'fa-moon'); } };
        const toggleTheme = () => { htmlElement.classList.toggle('dark-mode'); const isDarkMode = htmlElement.classList.contains('dark-mode'); localStorage.setItem('theme', isDarkMode ? 'dark' : 'light'); themeToggleBtn.querySelector('i').classList.toggle('fa-moon', !isDarkMode); themeToggleBtn.querySelector('i').classList.toggle('fa-sun', isDarkMode); };
        
        // ==========================================================
        //  بخش ورود امن با reCAPTCHA
        // ==========================================================
        
        // Called when reCAPTCHA library is loaded
        window.onRecaptchaLoad = () => {
            recaptchaWidgetId = grecaptcha.render(loginButton, {
                'sitekey' : RECAPTCHA_SITE_KEY,
                'callback' : onRecaptchaSuccess, // This function will be called with the token
                'size': 'invisible'
            });
        };

        // This function is triggered by the form's onsubmit event
        window.handleLogin = () => {
            loginErrorMsg.textContent = '';
            loginButton.classList.add('loading');
            loginButton.disabled = true;
            // Execute the reCAPTCHA challenge. If successful, onRecaptchaSuccess will be called.
            grecaptcha.execute(recaptchaWidgetId);
        };
        
        // This is the reCAPTCHA callback function. It receives the token.
        async function onRecaptchaSuccess(recaptchaToken) {
            // ========================= START: EDIT =========================
            pageLoader.classList.remove('hidden'); // نمایش لودر تمام-صفحه
            // ========================== END: EDIT ==========================
            try {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                const result = await secureFetch({
                    action: 'ceoLogin',
                    username,
                    password,
                    recaptchaToken
                });

                if (result.success) { 
                    sessionToken = result.token; // Store the secure token
                    setCache('ceoInfo', result.data); 
                    initDashboard(result.data); 
                } else { 
                    loginErrorMsg.textContent = result.message || 'اطلاعات ورود نامعتبر است.'; 
                }
            } catch (error) { 
                loginErrorMsg.textContent = error.message || 'خطا در ارتباط با سرور.'; 
            } finally { 
                // ========================= START: EDIT =========================
                // این خط تضمین می‌کند که در صورت بروز خطا، لودر حتما پنهان شود
                pageLoader.classList.add('hidden');
                // ========================== END: EDIT ==========================
                loginButton.classList.remove('loading'); 
                loginButton.disabled = false;
                grecaptcha.reset(recaptchaWidgetId); // Reset for next login attempt
            }
        }

        // --- Event Listeners (Unchanged logic, just secured underneath) ---
        logoutButton.addEventListener('click', handleLogout);
        transactionsFilterBtn.addEventListener('click', () => fetchTransactions(1)); coursesFilterBtn.addEventListener('click', () => fetchCourses(1)); lettersFilterBtn.addEventListener('click', () => fetchLetters(1)); approvedCoursesFilterBtn.addEventListener('click', () => fetchApprovedCourses(1)); generalCertsFilterBtn.addEventListener('click', () => fetchGeneralCertificates(1)); refreshDashboardBtn.addEventListener('click', refreshDashboard); themeToggleBtn.addEventListener('click', toggleTheme);
        coursesTableBody.addEventListener('click', (e) => { if (e.target.classList.contains('cost-icon')) { const cost = e.target.dataset.cost; if (cost.toLowerCase() === 'رایگان') { showToast('این دوره رایگان است.', 'info'); } else { showToast(`هزینه این دوره مبلغ ${cost} ریال تعیین شده است.`, 'info'); } } });
        addCourseBtn.addEventListener('click', () => { setupAddCourseModal(); addCourseModal.classList.add('show'); document.body.classList.add('modal-open'); });
        addCourseModalCloseBtn.addEventListener('click', () => closeModal(addCourseModal));
        costTypeRadios.forEach(radio => { radio.addEventListener('change', () => { addCourseCostWrapper.style.display = (radio.value === 'paid') ? 'block' : 'none'; }); });
        addCourseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            addCourseSubmitBtn.classList.add('loading'); addCourseSubmitBtn.disabled = true;
            const payload = {
                action: 'addNewCourse',
                courseName: document.getElementById('add-course-name').value.trim(),
                startDate: `${addCourseYear.value}/${String(addCourseMonth.value).padStart(2, '0')}/${String(addCourseDay.value).padStart(2, '0')}`,
                cost: (document.querySelector('input[name="cost-type"]:checked').value === 'paid') ? document.getElementById('add-course-cost-value').value || '0' : 'رایگان',
                participantCount: document.getElementById('add-course-participants').value
            };
            if (!payload.courseName || !payload.participantCount) { showToast('لطفاً تمام فیلدهای الزامی را پر کنید.', 'error'); addCourseSubmitBtn.classList.remove('loading'); addCourseSubmitBtn.disabled = false; return; }
            try {
                await secureFetch(payload);
                showToast('دوره جدید با موفقیت اضافه شد!', 'success');
                closeModal(addCourseModal);
                addCourseForm.reset(); addCourseCostWrapper.style.display = 'none';
                fetchCourses(1);
            } catch (error) {
                showToast('خطا در افزودن دوره: ' + error.message, 'error');
            } finally {
                addCourseSubmitBtn.classList.remove('loading'); addCourseSubmitBtn.disabled = false;
            }
        });
        const updateDateValidation = () => { const today = new Date(); const todayJalali = today.toLocaleDateString('fa-IR-u-nu-latn').split('/'); const currentJalaliMonth = parseInt(todayJalali[1], 10); const currentJalaliDay = parseInt(todayJalali[2], 10); const selectedMonth = parseInt(addCourseMonth.value, 10); for (const dayOption of addCourseDay.options) { const dayValue = parseInt(dayOption.value, 10); dayOption.disabled = (selectedMonth === currentJalaliMonth && dayValue < currentJalaliDay); } if (parseInt(addCourseDay.value) < currentJalaliDay && selectedMonth === currentJalaliMonth) { addCourseDay.value = currentJalaliDay; } };
        const setupAddCourseModal = () => { const today = new Date(); const todayJalali = today.toLocaleDateString('fa-IR-u-nu-latn').split('/'); const currentJalaliYear = todayJalali[0]; const currentJalaliMonth = parseInt(todayJalali[1], 10); addCourseYear.value = currentJalaliYear; let monthOptions = ''; for(let i = 1; i <= 12; i++) { const disabled = i < currentJalaliMonth ? 'disabled' : ''; monthOptions += `<option value="${i}" ${disabled}>${i}</option>`; } addCourseMonth.innerHTML = monthOptions; addCourseMonth.value = currentJalaliMonth; addCourseDay.innerHTML = Array.from({length: 31}, (_, i) => `<option value="${i + 1}">${i + 1}</option>`).join(''); updateDateValidation(); };
        addCourseMonth.addEventListener('change', updateDateValidation);
        const closeModal = (modal) => { modal.classList.remove('show'); if (!document.querySelector('.modal-overlay.show')) { document.body.classList.remove('modal-open'); } };
        infoModalTrigger.addEventListener('click', () => { infoModal.classList.add('show'); document.body.classList.add('modal-open'); });
        infoModalCloseBtn.addEventListener('click', () => closeModal(infoModal));
        userDropdownTrigger.addEventListener('click', (e) => { e.stopPropagation(); userDropdown.classList.toggle('show'); });
        letterContentModalCloseBtn.addEventListener('click', () => closeModal(letterContentModal));
        copyLetterTextBtn.addEventListener('click', () => { navigator.clipboard.writeText(letterContentModalText.textContent).then(() => { const originalHTML = copyLetterTextBtn.innerHTML; copyLetterTextBtn.innerHTML = '<i class="fas fa-check"></i> کپی شد!'; copyLetterTextBtn.classList.add('success'); setTimeout(() => { copyLetterTextBtn.innerHTML = originalHTML; copyLetterTextBtn.classList.remove('success'); }, 2000); }).catch(err => console.error('Error copying text: ', err)); });
        printLetterBtn.addEventListener('click', () => { window.print(); });
        document.addEventListener('click', (e) => { if (e.target.closest('.dropdown') || e.target.closest('.icon-button')) return; userDropdown.classList.remove('show'); if (e.target.classList.contains('modal-overlay')) { closeModal(e.target); } });
        const copyInfoBtn = document.getElementById('copy-info-btn'), shareInfoBtn = document.getElementById('share-info-btn'); const getInfoText = () => `اطلاعات موسسه تعالی\n\nشناسه ملی: 14013770611\nکد شناسایی: 31605007\nشماره مجوز: 1403136/32273\nشماره ثبت: 391\nایمیل رسمی: irtashacol@gmail.com\nایمیل دبیرخانه: Tashaccol@gmail.com\nوبسایت: Tashacol.ir\nایتا: @irtaali`; if (!navigator.share) { shareInfoBtn.style.display = 'none'; copyInfoBtn.style.width = '100%'; } copyInfoBtn.addEventListener('click', () => { navigator.clipboard.writeText(getInfoText()).then(() => { const originalHTML = copyInfoBtn.innerHTML; copyInfoBtn.innerHTML = '<i class="fas fa-check"></i> کپی شد!'; copyInfoBtn.classList.add('success'); copyInfoBtn.disabled = true; setTimeout(() => { copyInfoBtn.innerHTML = originalHTML; copyInfoBtn.classList.remove('success'); copyInfoBtn.disabled = false; }, 2000); }).catch(err => { console.error('Failed to copy text: ', err); showToast('خطا در کپی کردن متن.', 'error'); }); }); if (navigator.share) { shareInfoBtn.addEventListener('click', async () => { const shareData = { title: 'اطلاعات موسسه تعالی', text: getInfoText(), }; try { await navigator.share(shareData); } catch (err) { console.error('Share failed:', err); } }); }
        
        // --- Application Initialization ---
        const cachedCeoInfo = getCache('ceoInfo');
        if (cachedCeoInfo && cachedCeoInfo.token) {
            sessionToken = cachedCeoInfo.token; // Restore token from session cache if available
            initDashboard(cachedCeoInfo.data);
        } else {
            sessionStorage.clear();
            pageLoader.classList.add('hidden');
            loginView.style.display = 'flex';
        }
        loadThemePreference();
    });
</script>

</body>
</html>
