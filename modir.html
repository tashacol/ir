 <!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1400">
    <title>پنل مدیریت جامع - موسسه تعالی</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700;800&display=swap');
        :root {
            --primary: #0d6efd; --primary-light: #e7f3ff; --primary-dark: #0056b3;
            --text-dark: #212529; --text-light: #6c757d; --text-on-dark: #ffffff;
            --bg-main: #f8f9fa; --bg-card: #ffffff; --border-color: #e9ecef;
            --success: #198754; --danger: #dc3545; --warning: #ffc107; --info: #0dcaf0;
            --shadow: 0 4px 25px rgba(0,0,0,0.08);
            --radius-lg: 16px; --radius-md: 12px; --transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Vazirmatn', sans-serif; 
            background-color: var(--bg-main); 
            color: var(--text-dark);
            min-width: 1400px;
        }
        html.modal-open, body.modal-open { overflow: hidden; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes modal-pop-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        .page-loader { position: fixed; inset: 0; background: var(--bg-main); display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s, visibility 0.5s; }
        .page-loader.hidden { opacity: 0; visibility: hidden; }
        .page-loader .spinner { width: 40px; height: 40px; border: 4px solid var(--primary-light); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        
        #login-view { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; animation: fadeIn 0.5s; }
        .login-container { width: 100%; max-width: 420px; background: var(--bg-card); padding: 40px; border-radius: var(--radius-lg); box-shadow: var(--shadow); text-align: center; }
        .login-container .logo { color: var(--primary); font-size: 3rem; margin-bottom: 20px; }
        .login-container h1 { font-size: 1.8rem; margin-bottom: 8px; }
        .login-container p { color: var(--text-light); margin-bottom: 30px; }
        .input-wrapper { position: relative; margin-bottom: 20px; }
        .input-icon { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); color: var(--text-light); }
        .form-input { width: 100%; padding: 14px 50px 14px 15px; border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem; outline: none; transition: var(--transition); background: #fafbfc; }
        .form-input:focus { border-color: var(--primary); background: var(--bg-card); box-shadow: 0 0 0 3px var(--primary-light); }
        .btn-login { width: 100%; padding: 14px; font-size: 1.1rem; font-weight: 500; background: var(--primary); color: var(--text-on-dark); border: none; border-radius: var(--radius-md); cursor: pointer; transition: var(--transition); position: relative; min-height: 52px; display: flex; align-items: center; justify-content: center; }
        .btn-login:hover:not(:disabled) { background: var(--primary-dark); }
        .btn-login.loading .spinner { opacity: 1; }
        .btn-login .spinner { width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3); border-top-color: var(--text-on-dark); border-radius: 50%; animation: spin 0.8s linear infinite; position: absolute; opacity: 0; transition: var(--transition); }
        #login-error-msg { margin-top: 15px; color: var(--danger); min-height: 20px; font-weight: 500; }
        
        #dashboard-view { display: none; padding-top: 70px; }
        .dashboard-header { background: var(--bg-card); padding: 0 30px; height: 70px; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow); position: fixed; top: 0; right: 0; left: 0; z-index: 100; }
        .header-logo, .user-profile-trigger { cursor: pointer; }
        .header-logo { display: flex; align-items: center; color: var(--text-dark); font-weight: 700; font-size: 1.2rem; }
        .header-logo i { margin-left: 10px; color: var(--primary); }

        .header-controls { /* New style for grouping header controls */
            display: flex;
            align-items: center;
        }
        .icon-button { /* New style for refresh button */
            background: none;
            border: none;
            font-size: 1.5rem; /* Match other icons */
            color: var(--text-light); /* Subtle color */
            cursor: pointer;
            margin-right: 15px; /* Spacing from user profile */
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px; /* Make it clickable area larger */
            border-radius: 50%; /* Make it round */
        }
        .icon-button:hover {
            color: var(--primary);
            background-color: var(--primary-light);
        }
        .icon-button.loading i {
            animation: spin 1s linear infinite; /* Reuse spin animation */
        }

        .user-profile-trigger { display: flex; align-items: center; }
        .user-profile-trigger .avatar { width: 40px; height: 40px; background: var(--primary-light); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        
        .dropdown { position: relative; }
        .dropdown-menu { display: none; position: absolute; background-color: var(--bg-card); min-width: 300px; box-shadow: var(--shadow); border-radius: var(--radius-md); z-index: 101; margin-top: 15px; border: 1px solid var(--border-color); animation: fadeIn 0.2s; }
        .dropdown-menu.show { display: block; }
        .user-profile-trigger + .dropdown-menu { left: 0; }
        .header-logo + .dropdown-menu { right: 0; }
        .dropdown-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); text-align: center; }
        .dropdown-header h4 { margin: 0; font-size: 1.1rem; }
        .dropdown-header p { margin: 5px 0 0; color: var(--text-light); font-size: 0.9rem; }
        .dropdown-list { list-style: none; padding: 10px; }
        .dropdown-list li { padding: 10px 15px; font-size: 0.95rem; color: var(--text-light); display: flex; align-items: center; }
        .dropdown-list li i { width: 24px; text-align: center; margin-left: 10px; color: var(--primary); }
        .dropdown-logout-btn { width: calc(100% - 20px); margin: 10px; background: var(--danger); color: #fff; border:none; padding: 10px; border-radius: 8px; cursor:pointer; font-family: inherit; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 8px; }

        .main-container { max-width: 1400px; margin: 30px auto; padding: 0 30px; animation: fadeIn 0.5s; }
        /* Increased gap for better spacing */
        .section-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 40px; 
            margin-bottom: 40px; /* Added: Increased bottom margin for this section */
        }
        /* Increased margin-bottom for better spacing between full-width sections */
        .full-width-section { margin-bottom: 40px; }
        
        .card { background: var(--bg-card); border-radius: var(--radius-lg); box-shadow: var(--shadow); padding: 25px; display: flex; flex-direction: column; }
        .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .card-header .title-part { display: flex; align-items: center;}
        .card-header .icon { color: var(--primary); font-size: 1.5rem; margin-left: 15px; }
        .card-header h2 { font-size: 1.3rem; margin: 0; }
        
        /* Increased gap for better spacing */
        .financial-stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px; }
        .stat-item { padding: 20px; border-radius: var(--radius-md); background: var(--bg-main); }
        .stat-item .label { display: flex; align-items: center; color: var(--text-light); margin-bottom: 8px; }
        .stat-item .label i { margin-left: 8px; font-size: 1.1rem; }
        .stat-item .value { font-size: 1.7rem; font-weight: 700; }
        .stat-item .value small { font-size: 1rem; font-weight: 400; color: var(--text-light); }
        .stat-item.income .value { color: var(--success); }
        .stat-item.expense .value { color: var(--danger); }
        
        .table-responsive { overflow-x: auto; min-height: 250px; /* برای جلوگیری از پرش صفحه هنگام بارگیری */ }
        .data-table { width: 100%; border-collapse: collapse; text-align: right; }
        .data-table th, .data-table td { padding: 15px 10px; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        .data-table th { font-weight: 500; color: var(--text-light); font-size: 0.9rem; }
        .data-table tbody tr:last-child td { border-bottom: none; }
        .data-table .amount { font-weight: 500; }
        .data-table .amount.positive { color: var(--success); }
        .data-table .amount.negative { color: var(--danger); }
        .data-table .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 500; color: #fff; text-align: center; display: inline-block; min-width: 80px; }
        .status-badge.active { background-color: var(--success); }
        .status-badge.finished { background-color: #e9ecef; color: #6c757d; }
        .status-badge.upcoming { background-color: var(--primary); }

        .filter-controls { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-controls label { font-size: 0.9rem; color: var(--text-light); white-space: nowrap; }
        .filter-controls .form-input { padding: 8px 12px; height: 40px; width: 150px; background-color: var(--bg-main); }
        .filter-controls button { padding: 8px 20px; height: 40px; background: var(--primary-light); color: var(--primary); font-weight: 500; border: none; border-radius: var(--radius-md); cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 8px;}
        .filter-controls button:hover { background: var(--primary); color: #fff; }
        .filter-controls button .spinner { width: 16px; height: 16px; border: 2px solid; border-radius: 50%; border-right-color: transparent; animation: spin 0.8s linear infinite; display: none; }
        .filter-controls button.loading .spinner { display: block; }
        .filter-controls button.loading .btn-text { display: none; }


        .pagination-controls { margin-top: 20px; display: flex; justify-content: space-between; align-items: center; }
        .pagination-controls button { padding: 8px 20px; background: var(--primary-light); color: var(--primary); font-weight: 500; border: none; border-radius: 8px; cursor: pointer; transition: var(--transition); }
        .pagination-controls button:hover:not(:disabled) { background: var(--primary); color: #fff; }
        .pagination-controls button:disabled { background: #e9ecef; color: #adb5bd; cursor: not-allowed; }
        .pagination-info { font-size: 0.9rem; color: var(--text-light); font-weight: 500; }

        /* Increased gap for better spacing */
        .staff-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }
        .staff-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 20px; display: flex; flex-direction: column; transition: var(--transition); }
        .staff-card:hover { transform: translateY(-5px); box-shadow: var(--shadow); }
        .staff-header { display: flex; align-items: center; margin-bottom: 15px; }
        .staff-avatar { width: 50px; height: 50px; border-radius: 50%; background: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.5rem; margin-left: 15px; flex-shrink: 0; }
        .staff-title .name { font-weight: 700; font-size: 1.1rem; }
        .staff-title .role { font-size: 0.9rem; color: var(--primary); }
        .staff-info { list-style: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); font-size: 0.95rem; color: var(--text-light); flex-grow: 1; }
        .staff-info li { display: flex; align-items: center; margin-bottom: 10px; }
        .staff-info li i { margin-left: 10px; width: 18px; text-align: center; }
        .staff-card .btn-login { margin-top: auto; padding: 10px; }

        /* Increased gap for better spacing */
        .action-card-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; }
        .action-card { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-decoration: none; color: var(--text-dark); background: var(--bg-main); border-radius: var(--radius-md); transition: var(--transition); }
        .action-card:hover { transform: translateY(-5px); background: var(--primary-light); color: var(--primary); }
        .action-card .icon { font-size: 2.5rem; margin-bottom: 10px; color: var(--primary); }
        .action-card span { font-weight: 500; text-align: center; font-size: 1rem; }

        .skeleton { animation: skeleton-loading 1.5s linear infinite alternate; background-color: #e9ecef; }
        @keyframes skeleton-loading { from { background-color: #f1f3f5; } to { background-color: #e9ecef; } }
        .skeleton-text { width: 100%; height: 1em; border-radius: 4px; }
        .skeleton-avatar { width: 50px; height: 50px; border-radius: 50%; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); animation: fadeIn 0.3s; }
        .modal-overlay.show { display: flex; }
        .modal-box { background: var(--bg-card); padding: 30px; border-radius: var(--radius-lg); width: 90%; max-width: 500px; box-shadow: var(--shadow); position: relative; }
        .modal-overlay.show .modal-box { animation: modal-pop-in 0.3s ease-out; }
        .modal-close-btn { position: absolute; top: 15px; left: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); }
        .modal-list { list-style: none; padding: 10px 0; }
        .modal-list li { padding: 12px 0; font-size: 0.95rem; color: var(--text-light); display: flex; align-items: center; border-bottom: 1px solid var(--border-color); }
        .modal-list li:last-child { border-bottom: none; }
        .modal-list li i { width: 24px; text-align: center; margin-left: 10px; color: var(--primary); }
        .modal-header { text-align: center; margin-bottom: 20px; }
        .modal-header .avatar { width: 60px; height: 60px; border-radius: 50%; background: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto 15px; }
        .modal-header h4 { font-size: 1.2rem; }
        .modal-header p { color: var(--text-light); }

        /* --- Persian Date Picker Styles --- */
        .persian-date-picker-modal {
            position: fixed; /* Changed from absolute to fixed for better positioning */
            background-color: #fff;
            border-radius: 12px;
            box-shadow: var(--shadow); /* Using defined shadow variable */
            width: 280px;
            padding: 15px;
            box-sizing: border-box;
            z-index: 1000;
            display: none;
            flex-direction: column;
            border: 1px solid var(--border-color); /* Using defined border color */
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            opacity: 0;
            transform: translateY(10px);
        }

        .persian-date-picker-modal.show {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }

        .picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color); /* Using defined border color */
        }

        .picker-header .nav-btn {
            background: var(--primary); /* Changed to primary color variable */
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
        }

        .picker-header .nav-btn:hover {
            background-color: var(--primary-dark); /* Changed to primary-dark color variable */
        }

        .picker-header .month-select,
        .picker-header .year-select {
            padding: 5px 8px;
            border-radius: 6px;
            border: 1px solid var(--border-color); /* Using defined border color */
            font-family: 'Vazirmatn', sans-serif;
            font-size: 1rem;
            margin: 0 5px;
            text-align: center;
            background-color: var(--bg-main); /* Using defined background color */
            cursor: pointer;
            flex-grow: 1;
        }
        .picker-header .month-select:focus,
        .picker-header .year-select:focus {
            outline: none;
            border-color: var(--primary); /* Changed to primary color variable */
        }

        .picker-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--text-light); /* Using defined text-light color */
            font-size: 0.9rem;
        }

        .picker-weekdays span {
            padding: 5px 0;
        }

        .picker-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .picker-days .day {
            padding: 8px 0;
            text-align: center;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-size: 0.95rem;
            color: var(--text-dark); /* Using defined text-dark color */
        }

        .picker-days .day:hover {
            background-color: var(--primary-light); /* Changed to primary-light color variable */
        }

        .picker-days .day.empty {
            background-color: transparent;
            cursor: default;
            color: #ccc;
        }

        .picker-days .day.selected {
            background-color: var(--primary); /* Changed to primary color variable */
            color: white;
            font-weight: 500;
        }

        .picker-days .day.current-day:not(.selected) {
            background-color: var(--primary-light); /* Changed to primary-light color variable */
            border: 1px solid var(--primary); /* Changed to primary color variable */
            color: var(--primary); /* Changed to primary color variable */
            font-weight: 500;
        }
        .picker-days .day.current-day.selected {
            background-color: var(--primary);
            color: white;
            font-weight: 500;
        }
    </style>
</head>
<body>

    <div class="page-loader" id="pageLoader"><div class="spinner"></div></div>

    <div id="login-view">
        <div class="login-container">
            <i class="fas fa-shield-alt logo"></i>
            <h1>پنل مدیریت موسسه</h1>
            <p>لطفاً با حساب کاربری مدیرعامل وارد شوید.</p>
            <form id="loginForm" onsubmit="event.preventDefault(); handleLogin();">
                <div class="input-wrapper"><i class="fas fa-user input-icon"></i><input type="number" id="username" class="form-input" placeholder="نام کاربری" required></div>
                <div class="input-wrapper"><i class="fas fa-lock input-icon"></i><input type="password" id="password" class="form-input" placeholder="رمز عبور" required></div>
                <button class="btn-login" id="loginButton"><span class="btn-text">ورود</span><div class="spinner"></div></button>
            </form>
            <p id="login-error-msg"></p>
        </div>
    </div>

    <div id="dashboard-view">
        <header class="dashboard-header">
            <div class="header-logo" id="info-modal-trigger" title="اطلاعات موسسه"><i class="fas fa-landmark-dome"></i><span>داشبورد مدیریت</span></div>
            
            <div class="header-controls">
                <button id="refresh-dashboard-btn" class="icon-button" title="به‌روزرسانی داده‌ها"><i class="fas fa-sync-alt"></i></button>
                <div class="dropdown">
                    <div class="user-profile-trigger" id="user-dropdown-trigger">
                        <div class="avatar"><i class="fas fa-user-tie"></i></div>
                    </div>
                    <div id="user-dropdown" class="dropdown-menu">
                        <div class="dropdown-header"><h4 id="ceo-name-dropdown"></h4><p>مدیرعامل موسسه</p></div>
                        <ul class="dropdown-list"><li><i class="fas fa-id-card-clip"></i> کد ملی: <span id="ceo-nid-dropdown"></span></li></ul>
                        <button id="logoutButton" class="dropdown-logout-btn"><i class="fas fa-sign-out-alt"></i><span>خروج از حساب</span></button>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-container">
            <div class="full-width-section">
                <div class="card">
                    <div class="card-header"><div class="title-part"><i class="fas fa-wallet icon"></i><h2>خلاصه وضعیت مالی</h2></div></div>
                    <div class="financial-stats-grid" id="financial-stats-container">
                        <!-- Financial Stats will be loaded here -->
                    </div>
                </div>
            </div>
            <div class="section-grid">
                <div class="main-column">
                    <div class="card" style="height:100%;">
                        <div class="card-header"><div class="title-part"><i class="fas fa-tasks icon"></i><h2>وضعیت دوره‌ها</h2></div></div>
                        <div class="filter-controls">
                            <label for="courses-start-date">از تاریخ:</label><input type="text" id="courses-start-date" class="form-input persian-date-picker" placeholder="تاریخ را انتخاب کنید">
                            <label for="courses-end-date">تا تاریخ:</label><input type="text" id="courses-end-date" class="form-input persian-date-picker" placeholder="تاریخ را انتخاب کنید">
                            <button id="courses-filter-btn"><span class="btn-text">اعمال فیلتر</span><div class="spinner"></div></button>
                        </div>
                        <div class="table-responsive" style="flex-grow:1;">
                            <table class="data-table">
                                <thead><tr><th>نام دوره</th><th>کد دوره</th><th>تاریخ شروع</th><th>وضعیت</th></tr></thead>
                                <tbody id="courses-table-body"></tbody>
                            </table>
                        </div>
                        <div class="pagination-controls" id="courses-pagination"></div>
                    </div>
                </div>
                <div class="sidebar-column" style="display:flex; flex-direction:column; gap:30px;">
                    <div class="card"><div class="card-header"><div class="title-part"><i class="fas fa-file-signature icon"></i><h2>اقدامات سریع</h2></div></div><div class="action-card-grid"><a href="https://tashacol.github.io/ir/crte.html" target="_blank" class="action-card"><div class="icon"><i class="fas fa-building-user"></i></div><span>تائید سوابق مؤسسه</span></a><a href="https://tashacol.github.io/ir/jahadi.html" target="_blank" class="action-card"><div class="icon"><i class="fas fa-people-carry-box"></i></div><span>تائید سوابق جهادی</span></a></div></div>
                    <div class="card"><div class="card-header"><div class="title-part"><i class="fas fa-database icon"></i><h2>داده‌های موسسه</h2></div></div><div class="action-card-grid" id="data-links-list"></div></div>
                </div>
            </div>
            <div class="full-width-section">
                <div class="card">
                    <div class="card-header"><div class="title-part"><i class="fas fa-receipt icon"></i><h2>ریز تراکنش‌ها</h2></div></div>
                    <div class="filter-controls">
                        <label for="transactions-start-date">از تاریخ:</label><input type="text" id="transactions-start-date" class="form-input persian-date-picker" placeholder="تاریخ را انتخاب کنید">
                        <label for="transactions-end-date">تا تاریخ:</label><input type="text" id="transactions-end-date" class="form-input persian-date-picker" placeholder="تاریخ را انتخاب کنید">
                        <button id="transactions-filter-btn"><span class="btn-text">اعمال فیلتر</span><div class="spinner"></div></button>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead><tr><th>تاریخ</th><th>حسابدار</th><th>درآمد</th><th>مخارج</th><th>سود</th><th>ضرر</th></tr></thead>
                            <tbody id="transactions-table-body"></tbody>
                        </table>
                    </div>
                    <div class="pagination-controls" id="transactions-pagination"></div>
                </div>
            </div>
            <div class="full-width-section"><div class="card"><div class="card-header"><div class="title-part"><i class="fas fa-users-cog icon"></i><h2>کادر اجرایی</h2></div></div><div class="staff-grid" id="staff-list-container"></div></div></div>
        </main>
    </div>

    <div class="modal-overlay" id="info-modal"><div class="modal-box"><button class="modal-close-btn"><i class="fas fa-times"></i></button><div class="card-header" style="border:none;margin-bottom:10px;padding:0;justify-content:center;"><i class="fas fa-landmark-dome icon"></i><h2>اطلاعات موسسه تعالی</h2></div><ul class="modal-list"><li><i class="fas fa-id-card"></i> شناسه ملی: 14013770611</li><li><i class="fas fa-barcode"></i> کد شناسایی: 31605007</li><li><i class="fas fa-file-contract"></i> شماره مجوز: 1403136/32273</li><li><i class="fas fa-hashtag"></i> شماره ثبت: 391</li><li><i class="fas fa-envelope"></i> ایمیل رسمی: irtashacol@gmail.com</li><li><i class="fas fa-envelope-open-text"></i> ایمیل دبیرخانه: Tashaccol@gmail.com</li><li><i class="fas fa-globe"></i> وبسایت: Tashacol.ir</li><li><i class="fab fa-telegram"></i> ایتا: @irtaali</li></ul></div></div>
    
    <!-- Persian Date Picker HTML Element (outside main content) -->
    <div id="persianDatePicker" class="persian-date-picker-modal">
        <div class="picker-header">
            <!-- Icons for navigation buttons -->
            <button class="nav-btn prev-month"><i class="fas fa-chevron-right"></i></button>
            <select class="month-select"></select>
            <select class="year-select"></select>
            <button class="nav-btn next-month"><i class="fas fa-chevron-left"></i></button>
        </div>
        <div class="picker-weekdays">
            <span>ش</span>
            <span>ی</span>
            <span>د</span>
            <span>س</span>
            <span>چ</span>
            <span>پ</span>
            <span>ج</span>
        </div>
        <div class="picker-days">
            <!-- روزها اینجا با جاوااسکریپت پر می‌شوند -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ** مهم: SCRIPT_URL را با URL جدیدی که پس از Deploy کردن اسکریپت Apps Script دریافت می‌کنید، جایگزین کنید. **
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzyFTXag_5BScHtBEN63BoN8L_o1EEGdZiCcsBcIQWb6J2QMx65rSFGZmIW44vSKybyuw/exec"; 
            const CACHE_DURATION = 3600 * 1000;
            const TRANSACTIONS_PAGE_SIZE = 5;
            const COURSES_PAGE_SIZE = 7;

            // --- Element selectors ---
            const pageLoader = document.getElementById('pageLoader'), loginView = document.getElementById('login-view'), dashboardView = document.getElementById('dashboard-view');
            const loginButton = document.getElementById('loginButton'), logoutButton = document.getElementById('logoutButton'), loginErrorMsg = document.getElementById('login-error-msg');
            const ceoNameDropdown = document.getElementById('ceo-name-dropdown'), ceoNidDropdown = document.getElementById('ceo-nid-dropdown');
            const financialStatsContainer = document.getElementById('financial-stats-container');
            const staffListContainer = document.getElementById('staff-list-container'), dataLinksList = document.getElementById('data-links-list');
            const infoModal = document.getElementById('info-modal'), infoModalTrigger = document.getElementById('info-modal-trigger'), infoModalCloseBtn = infoModal.querySelector('.modal-close-btn');
            const userDropdown = document.getElementById('user-dropdown'), userDropdownTrigger = document.getElementById('user-dropdown-trigger');
            const refreshDashboardBtn = document.getElementById('refresh-dashboard-btn');

            // --- Transactions Elements ---
            const transactionsTableBody = document.getElementById('transactions-table-body');
            const transactionsPagination = document.getElementById('transactions-pagination');
            const transactionsFilterBtn = document.getElementById('transactions-filter-btn');
            const transactionsStartDate = document.getElementById('transactions-start-date');
            const transactionsEndDate = document.getElementById('transactions-end-date');
            
            // --- Courses Elements ---
            const coursesTableBody = document.getElementById('courses-table-body');
            const coursesPagination = document.getElementById('courses-pagination');
            const coursesFilterBtn = document.getElementById('courses-filter-btn');
            const coursesStartDate = document.getElementById('courses-start-date');
            const coursesEndDate = document.getElementById('courses-end-date');
            
            // --- Helper Functions ---
            const setCache = (key, data) => localStorage.setItem(key, JSON.stringify({ data, timestamp: new Date().getTime() }));
            const getCache = (key) => {
                const itemStr = localStorage.getItem(key); if (!itemStr) return null;
                const item = JSON.parse(itemStr);
                const isExpired = (new Date().getTime() - item.timestamp) > CACHE_DURATION;
                if (isExpired) { localStorage.removeItem(key); return null; }
                return item.data;
            };

            const renderSkeleton = (rows, cols, container) => {
                container.innerHTML = Array(rows).fill('').map(() => `<tr>${Array(cols).fill('<td><div class="skeleton skeleton-text"></div></td>').join('')}</tr>`).join('');
            };

            const renderPagination = (container, currentPage, totalPages, navHandler) => {
                if (totalPages <= 0) {
                    container.innerHTML = `<p class="pagination-info" style="text-align: center; width: 100%;">داده‌ای برای نمایش یافت نشد.</p>`;
                    return;
                }
                container.innerHTML = `
                    <button class="prev-btn" ${currentPage === 1 ? 'disabled' : ''}>قبلی</button>
                    <span class="pagination-info">صفحه ${currentPage} از ${totalPages}</span>
                    <button class="next-btn" ${currentPage === totalPages ? 'disabled' : ''}>بعدی</button>
                `;
                container.querySelector('.prev-btn').addEventListener('click', () => navHandler(currentPage - 1));
                container.querySelector('.next-btn').addEventListener('click', () => navHandler(currentPage + 1));
            };
            
            // --- Data Fetching and Rendering ---
            const fetchPaginatedData = async (config) => {
                const { action, page, pageSize, startDateEl, endDateEl, tableBody, paginationContainer, renderFunction, navHandler, filterBtn } = config;
                
                filterBtn.classList.add('loading');
                filterBtn.disabled = true;
                const cols = tableBody.previousElementSibling.rows[0].cells.length; // Get column count from header
                renderSkeleton(pageSize, cols, tableBody);
                paginationContainer.innerHTML = ''; // Clear pagination controls during load

                let url = `${SCRIPT_URL}?action=${action}&page=${page}&pageSize=${pageSize}`;
                
                // Convert Persian dates to Gregorian YYYY-MM-DD for backend
                if (startDateEl && startDateEl.value) {
                    const persianDateStr = toEnglishDigits(startDateEl.value); // Convert string with Persian digits to English digits
                    const parts = persianDateStr.split('/').map(Number);
                    if (parts.length === 3 && !isNaN(parts[0]) && !isNaN(parts[1]) && !isNaN(parts[2])) {
                        const [gy, gm, gd] = jalali_to_gregorian(parts[0], parts[1], parts[2]);
                        const formattedGregorian = `${gy}-${String(gm).padStart(2, '0')}-${String(gd).padStart(2, '0')}`;
                        url += `&startDate=${formattedGregorian}`;
                    }
                }
                if (endDateEl && endDateEl.value) {
                    const persianDateStr = toEnglishDigits(endDateEl.value); // Convert string with Persian digits to English digits
                    const parts = persianDateStr.split('/').map(Number);
                    if (parts.length === 3 && !isNaN(parts[0]) && !isNaN(parts[1]) && !isNaN(parts[2])) {
                        const [gy, gm, gd] = jalali_to_gregorian(parts[0], parts[1], parts[2]);
                        const formattedGregorian = `${gy}-${String(gm).padStart(2, '0')}-${String(gd).padStart(2, '0')}`;
                        url += `&endDate=${formattedGregorian}`;
                    }
                }
                
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('خطای شبکه در برقراری ارتباط با سرور.');
                    const result = await response.json();
                    if (result.error) throw new Error(result.message);
                    
                    if(result.data && result.data.length > 0) {
                        renderFunction(result.data, tableBody);
                    } else {
                        tableBody.innerHTML = `<tr><td colspan="${cols}" style="text-align:center; padding: 40px 0; color: var(--text-light);">موردی برای نمایش در این بازه زمانی یافت نشد.</td></tr>`;
                    }
                    renderPagination(paginationContainer, result.currentPage, result.totalPages, navHandler);

                } catch (error) {
                    tableBody.innerHTML = `<tr><td colspan="${cols}" style="text-align:center; padding: 40px 0; color:var(--danger);">${error.message}</td></tr>`;
                    paginationContainer.innerHTML = ''; // Clear pagination on error
                } finally {
                    filterBtn.classList.remove('loading');
                    filterBtn.disabled = false;
                }
            };

            const fetchTransactions = (page = 1) => {
                fetchPaginatedData({
                    action: 'getFinancials', page, pageSize: TRANSACTIONS_PAGE_SIZE,
                    startDateEl: transactionsStartDate, endDateEl: transactionsEndDate,
                    tableBody: transactionsTableBody, paginationContainer: transactionsPagination,
                    renderFunction: renderTransactions, navHandler: fetchTransactions,
                    filterBtn: transactionsFilterBtn
                });
            };
            const renderTransactions = (data, container) => {
                container.innerHTML = data.map(t => `
                    <tr><td>${t.date}</td><td>${t.accountant}</td><td class="amount positive">${t.income}</td>
                    <td class="amount negative">${t.expenses}</td><td class="amount positive">${t.profit}</td>
                    <td class="amount negative">${t.loss}</td></tr>`).join('');
            };

            const fetchCourses = (page = 1) => {
                fetchPaginatedData({
                    action: 'getCourseStatuses', page, pageSize: COURSES_PAGE_SIZE,
                    startDateEl: coursesStartDate, endDateEl: coursesEndDate,
                    tableBody: coursesTableBody, paginationContainer: coursesPagination,
                    renderFunction: renderCourses, navHandler: fetchCourses,
                    filterBtn: coursesFilterBtn
                });
            };
            const renderCourses = (data, container) => {
                const statusClasses = { 'جاری': 'active', 'اتمام': 'finished', 'نام‌نویسی': 'upcoming' };
                container.innerHTML = data.map(course => `
                    <tr><td>${course.name}</td><td>${course.code}</td><td>${course.startDate}</td>
                    <td><span class="status-badge ${statusClasses[course.status] || ''}">${course.status}</span></td></tr>`).join('');
            };

            // This function is for data that does NOT need pagination (e.g., summary, staff, links)
            const fetchNonPaginatedData = async (action, cacheKey, renderFunc, container) => {
                if(container) { // Add skeleton loading for these sections as well
                    if (action === 'getFinancialSummary') {
                        container.innerHTML = Array(4).fill('').map(() => `<div class="stat-item"><div class="skeleton skeleton-text" style="width: 60%; height: 1.2rem; margin-bottom: 10px;"></div><div class="skeleton skeleton-text" style="width: 80%; height: 2rem;"></div></div>`).join('');
                    } else if (action === 'getStaff') {
                         container.innerHTML = Array(3).fill('').map(() => `<div class="staff-card"><div class="staff-header"><div class="skeleton skeleton-avatar"></div><div class="staff-title" style="flex:1;"><div class="skeleton skeleton-text" style="width: 60%;"></div><div class="skeleton skeleton-text" style="width: 40%; margin-top:8px;"></div></div></div><ul class="staff-info">${Array(2).fill('<li><div class="skeleton skeleton-text"></div></li>').join('')}</ul></div>`).join('');
                    } else if (action === 'getDashboardLinks') {
                        container.innerHTML = Array(4).fill('').map(() => `<a href="#" class="action-card skeleton"><div class="skeleton skeleton-text" style="width:80%; height:1.5rem;"></div></a>`).join('');
                    }
                }
                const cachedData = getCache(cacheKey); if (cachedData) { renderFunc(cachedData); return; }
                try {
                    const response = await fetch(`${SCRIPT_URL}?action=${action}`);
                    const result = await response.json();
                    if (result.error) throw new Error(result.message);
                    const dataToRender = result.data || result; // Ensure 'data' field is always used
                    setCache(cacheKey, dataToRender);
                    renderFunc(dataToRender);
                } catch (error) { if(container) container.innerHTML = `<p style="text-align:center; color:var(--danger);">${error.message}</p>`; }
            };

            // Render function for financial summary
            const renderFinancialSummary = (data) => {
                 financialStatsContainer.innerHTML = `
                    <div class="stat-item income"><div class="label"><i class="fas fa-arrow-up"></i><span>درآمد کل</span></div><p class="value">${data.totalIncome || '0'}<small> تومان</small></p></div>
                    <div class="stat-item expense"><div class="label"><i class="fas fa-arrow-down"></i><span>هزینه کل</span></div><p class="value">${data.totalExpenses || '0'}<small> تومان</small></p></div>
                    <div class="stat-item"><div class="label"><i class="fas fa-chart-line"></i><span>سود کل</span></div><p class="value">${data.totalProfit || '0'}<small> تومان</small></p></div>
                    <div class="stat-item"><div class="label"><i class="fas fa-balance-scale-left"></i><span>ضرر کل</span></div><p class="value">${data.totalLoss || '0'}<small> تومان</small></p></div>`;
            };
            const renderStaff = (data) => {
                staffListContainer.innerHTML = data.map(staff => `
                    <div class="staff-card">
                        <div class="staff-header"><div class="staff-avatar">${staff.name.charAt(0)}</div><div class="staff-title"><div class="name">${staff.name}</div><div class="role">${staff.role}</div></div></div>
                        <ul class="staff-info">
                            <li><i class="fas fa-id-card"></i><span>${staff.nationalId}</span></li>
                            <li><i class="fas fa-calendar-alt"></i><span>شروع: ${staff.startDate}</span></li>
                        </ul>
                        <a href="tel:${staff.phone}" class="btn-login"><i class="fas fa-phone" style="margin-left: 8px;"></i> تماس</a>
                    </div>`).join('');
            };
            const renderDataLinks = (links) => {
                dataLinksList.innerHTML = `
                    <a href="${links.students}" target="_blank" class="action-card"><div class="icon"><i class="fas fa-graduation-cap"></i></div><span>لیست دانشجویان</span></a>
                    <a href="${links.registrations}" target="_blank" class="action-card"><div class="icon"><i class="fas fa-user-plus"></i></div><span>ثبت نام کنندگان</span></a>
                    <a href="${links.members}" target="_blank" class="action-card"><div class="icon"><i class="fas fa-users"></i></div><span>اعضای موسسه</span></a>
                    <a href="${links.feedback}" target="_blank" class="action-card"><div class="icon"><i class="fas fa-comments"></i></div><span>نظرات</span></a>`;
            };

            // NEW: Function to refresh all dashboard data
            const refreshDashboard = async () => {
                refreshDashboardBtn.classList.add('loading');
                refreshDashboardBtn.disabled = true;

                // Clear relevant cache keys to force fresh data from server
                localStorage.removeItem('financialSummaryData');
                localStorage.removeItem('financialsData'); 
                localStorage.removeItem('courseStatusesData');
                localStorage.removeItem('staffData');
                localStorage.removeItem('dashboardLinks');

                try {
                    // Re-fetch all data sections
                    await Promise.all([
                        fetchNonPaginatedData('getFinancialSummary', 'financialSummaryData', renderFinancialSummary, financialStatsContainer),
                        fetchTransactions(1), // Reset transactions to page 1
                        fetchCourses(1),     // Reset courses to page 1
                        fetchNonPaginatedData('getStaff', 'staffData', renderStaff, staffListContainer),
                        fetchNonPaginatedData('getDashboardLinks', 'dashboardLinks', renderDataLinks, dataLinksList)
                    ]);
                    console.log("Dashboard data refreshed successfully!");
                } catch (error) {
                    console.error("Error refreshing dashboard:", error);
                    // You might want a more prominent error message for the user if a full refresh fails
                } finally {
                    refreshDashboardBtn.classList.remove('loading');
                    refreshDashboardBtn.disabled = false;
                }
            };

            const initDashboard = (ceoInfo) => {
                ceoNameDropdown.textContent = ceoInfo.name;
                ceoNidDropdown.textContent = ceoInfo.nationalId;
                loginView.style.display = 'none';
                dashboardView.style.display = 'block';
                pageLoader.classList.add('hidden');
                
                // Initial data load for all sections
                refreshDashboard(); // Use the refresh function for initial load too
            };

            // Event Listeners
            transactionsFilterBtn.addEventListener('click', () => fetchTransactions(1));
            coursesFilterBtn.addEventListener('click', () => fetchCourses(1));
            refreshDashboardBtn.addEventListener('click', refreshDashboard);

            window.handleLogin = async () => {
                loginErrorMsg.textContent = '';
                loginButton.classList.add('loading');
                loginButton.disabled = true;
                try {
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    const response = await fetch(`${SCRIPT_URL}?action=ceoLogin&username=${username}&password=${password}`);
                    const result = await response.json();
                    if (result.found) { setCache('ceoInfo', result.data); initDashboard(result.data); } 
                    else { loginErrorMsg.textContent = result.message || 'اطلاعات ورود نامعتبر است.'; }
                } catch (error) { loginErrorMsg.textContent = 'خطا در ارتباط با سرور.'; } 
                finally { loginButton.classList.remove('loading'); loginButton.disabled = false; }
            };
            
            logoutButton.addEventListener('click', () => { localStorage.clear(); location.reload(); });
            
            const closeModal = (modal) => modal.classList.remove('show');
            infoModalTrigger.addEventListener('click', () => infoModal.classList.add('show'));
            infoModalCloseBtn.addEventListener('click', () => closeModal(infoModal));
            userDropdownTrigger.addEventListener('click', (e) => { e.stopPropagation(); userDropdown.classList.toggle('show'); });
            document.addEventListener('click', (e) => {
                // بستن تقویم و دراپ‌داون‌ها با کلیک در خارج از آن‌ها
                if (!datePicker.contains(e.target) && !e.target.classList.contains('persian-date-picker')) {
                    hideCalendar();
                }
                if (!userDropdown.contains(e.target) && !userDropdownTrigger.contains(e.target)) {
                    userDropdown.classList.remove('show');
                }
                if (e.target === infoModal) closeModal(infoModal);
            });
            
            const cachedCeoInfo = getCache('ceoInfo');
            if (cachedCeoInfo) {
                initDashboard(cachedCeoInfo);
            } else {
                pageLoader.classList.add('hidden');
                loginView.style.display = 'flex';
            }


            // --- JAVASCRIPT FUNCTIONS FOR PERSIAN DATE PICKER (FIXED & IMPROVED) ---
            // These functions are imported from jalaali-js library for accuracy.
            // ** دقت: توابع تبدیل تاریخ از کتابخانه jalaali-js (ورژن 1.2.0) کپی شده‌اند تا از صحت آنها اطمینان حاصل شود. **

            /*
              Converts a Gregorian date to a Jalaali date
              @param gy  {number} Gregorian year (e.g. 2024)
              @param gm  {number} Gregorian month (1-12)
              @param gd  {number} Gregorian day (1-31)
              @returns {Array<number>} [Jalaali year, Jalaali month, Jalaali day]
            */
            function gregorian_to_jalali(gy, gm, gd) {
              var g_d_m = [0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
              var j_d_m = [0, 31, 31, 31, 31, 31, 31, 30, 30, 30, 30, 30, 29];
              var gy2 = gy - 1600;
              var gm2 = gm - 1;
              var gd2 = gd - 1;

              var g_day_no =
                365 * gy2 +
                Math.floor((gy2 + 3) / 4) -
                Math.floor((gy2 + 99) / 100) +
                Math.floor((gy2 + 399) / 400);
              for (var i = 0; i < gm2; ++i) g_day_no += g_d_m[i];
              if (gm2 > 1 && gregorian_is_leap(gy)) g_day_no += 1;
              g_day_no += gd2;

              var j_day_no = g_day_no - 79;

              var j_np = Math.floor(j_day_no / 12053); // 12053 = 365*33 + 11*3 + 3*1 + 0*0 + 1
              j_day_no %= 12053;

              var jy = 979 + 33 * j_np + 4 * Math.floor(j_day_no / 1461); // 1461 = 365*4 + 1
              j_day_no %= 1461;

              if (j_day_no >= 366) {
                jy += Math.floor((j_day_no - 1) / 365);
                j_day_no = (j_day_no - 1) % 365;
              }

              for (var i = 0; i < 11 && j_day_no >= j_d_m[i]; ++i) j_day_no -= j_d_m[i];
              var jm = i + 1;
              var jd = j_day_no + 1;

              return [jy, jm, jd];
            }

            /*
              Converts a Jalaali date to a Gregorian date
              @param jy  {number} Jalaali year (e.g. 1403)
              @param jm  {number} Jalaali month (1-12)
              @param jd  {number} Jalaali day (1-31)
              @returns {Array<number>} [Gregorian year, Gregorian month, Gregorian day]
            */
            function jalali_to_gregorian(jy, jm, jd) {
              var g_d_m = [0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
              var j_d_m = [0, 31, 31, 31, 31, 31, 31, 30, 30, 30, 30, 30, 29];
              var jy2 = jy - 979;
              var jm2 = jm - 1;
              var jd2 = jd - 1;

              var j_day_no =
                365 * jy2 +
                Math.floor(jy2 / 33) * 8 +
                Math.floor(((jy2 % 33) + 3) / 4);
              for (var i = 0; i < jm2; ++i) j_day_no += j_d_m[i];
              j_day_no += jd2;

              var g_day_no = j_day_no + 79;

              var g_np = Math.floor(g_day_no / 146097); // 146097 = 365*400 + 97
              g_day_no %= 146097;

              var gy = 1600 + 400 * g_np;
              if (g_day_no >= 36525) {
                // 36525 = 365*100 + 25
                gy += Math.floor((g_day_no - 1) / 36524) * 100; // 36524 = 365*100 + 24
                g_day_no = (g_day_no - 1) % 36524;
              }
              gy += Math.floor(g_day_no / 1461) * 4; // 1461 = 365*4 + 1
              g_day_no %= 1461;

              if (g_day_no >= 366) {
                gy += Math.floor((g_day_no - 1) / 365);
                g_day_no = (g_day_no - 1) % 365;
              }
              var gm = 0;
              for (var i = 0; i < 12; ++i) {
                if (g_d_m[i] + (i === 1 && gregorian_is_leap(gy) ? 1 : 0) > g_day_no) break;
                g_day_no -= g_d_m[i] + (i === 1 && gregorian_is_leap(gy) ? 1 : 0);
                gm++;
              }
              var gd = g_day_no + 1;

              return [gy, gm + 1, gd]; // gm+1 for 1-indexed month
            }

            /*
              Checks if a given Gregorian year is a leap year
              @param year {number} Gregorian year
              @returns {boolean} True if leap year, false otherwise
            */
            function gregorian_is_leap(year) {
              return (year % 4 === 0 && year % 100 !== 0) || year % 400 === 0;
            }

            /*
              Checks if a given Jalaali year is a leap year
              @param jy {number} Jalaali year
              @returns {boolean} True if leap year, false otherwise
            */
            // JALAALI_LEAP_CYCLES is defined here to be inside the function scope or global as per original jalaali.js structure.
            // For simplicity and self-containment, placing it globally or within its usage scope.
            const JALAALI_LEAP_CYCLES = [
                -61, 9, 38, 109, 118, 127, 166, 175, 184, 202, 211, 220, 239, 248, 257, 286, 295, 304, 322,
                331, 340, 349, 358, 367, 376, 385, 394, 403, 416, 429, 442, 455, 468, 481, 494, 507, 520,
                533, 546, 559, 572, 585, 598, 611, 624, 637, 650, 663, 676, 689, 702, 715, 728, 741, 754,
                767, 780, 793, 806, 819, 832, 845, 858, 871, 884, 897, 910, 923, 936, 949, 962, 975,
                988, 1001, 1014, 1027, 1040, 1053, 1066, 1079, 1092, 1105, 1118, 1131, 1144, 1157, 1170,
                1183, 1196, 1209, 1222, 1235, 1248, 1261, 1274, 1287, 1300, 1313, 1326, 1339, 1352, 1365,
                1378, 1391, 1404, 1417, 1430, 1443, 1456, 1469, 1482, 1495, 1508, 1521, 1534, 1547, 1560,
                1573, 1586, 1599, 1612, 1625, 1638, 1651, 1664, 1677, 1690, 1703, 1716, 1729, 1742, 1755,
                1768, 1781, 1794, 1807, 1820, 1833, 1846, 1859, 1872, 1885, 1898, 1911, 1924, 1937, 1950,
                1963, 1976, 1989, 2002, 2015, 2028, 2041, 2054, 2067, 2080, 2093, 2106, 2119, 2132, 2145,
                2158, 2171, 2184, 2197, 2210, 2223, 2236, 2249, 2262, 2275, 2288, 2301, 2314, 2327, 2340,
                2353, 2366, 2379, 2392, 2405, 2418, 2431, 2444, 2457, 2470, 2483, 2496, 2509, 2522, 2535,
                2548, 2561, 2574, 2587, 2600, 2613, 2626, 2639, 2652, 2665, 2678, 2691, 2704, 2717, 2730,
                2743, 2756, 2769, 2782, 2795, 2808, 2821, 2834, 2847, 2860, 2873, 2886, 2899, 2912, 2925,
                2938, 2951, 2964, 2977, 2990, 3003, 3016, 3029, 3042, 3055, 3068, 3081, 3094, 3107, 3120,
                3133, 3146, 3159, 3172, 3185, 3198, 3211, 3224, 3237, 3250, 3263, 3276, 3289, 3302, 3315,
                3328, 3341, 3354, 3367, 3380, 3393, 3406, 3419, 3432, 3445, 3458, 3471, 3484, 3497, 3510,
                3523, 3536, 3549, 3562, 3575, 3588, 3601, 3614, 3627, 3640, 3653, 3666, 3679, 3692, 3705,
                3718, 3731, 3744, 3757, 3770, 3783, 3796, 3809, 3822, 3835, 3848, 3861, 3874, 3887, 3900,
                3913, 3926, 3939, 3952, 3965, 3978, 3991, 4004, 4017, 4030, 4043, 4056, 4069, 4082, 4095,
                4108, 4121, 4134, 4147, 4160, 4173, 4186, 4199, 4212, 4225, 4238, 4251, 4264, 4277, 4290,
                4303, 4316, 4329, 4342, 4355, 4368, 4381, 4394, 4407, 4420, 4433, 4446, 4459, 4472, 4485,
                4498, 4511, 4524, 4537, 4550, 4563, 4576, 4589, 4602, 4615, 4628, 4641, 4654, 4667, 4680,
                4693, 4706, 4719, 4732, 4745, 4758, 4771, 4784, 4797, 4810, 4823, 4836, 4849, 4862, 4875,
                4888, 4901, 4914, 4927, 4940, 4953, 4966, 4979, 4992, 5005, 5018, 5031, 5044, 5057, 5070,
                5083, 5096, 5109, 5122, 5135, 5148, 5161, 5174, 5187, 5200, 5213, 5226, 5239, 5252, 5265,
                5278, 5291, 5304, 5317, 5330, 5343, 5356, 5369, 5382, 5395, 5408, 5421, 5434, 5447, 5460,
                5473, 5486, 5499, 5512, 5525, 5538, 5551, 5564, 5577, 5590, 5603, 5616, 5629, 5642, 5655,
                5668, 5681, 5694, 5707, 5720, 5733, 5746, 5759, 5772, 5785, 5798, 5811, 5824, 5837, 5850,
                5863, 5876, 5889, 5902, 5915, 5928, 5941, 5954, 5967, 5980, 5993, 6006, 6019, 6032, 6045,
                6058, 6071, 6084, 6097, 6110, 6123, 6136, 6149, 6162, 6175, 6188, 6201, 6214, 6227, 6240,
                6253, 6266, 6279, 6292, 6305, 6318, 6331, 6344, 6357, 6370, 6383, 6396, 6409, 6422, 6435,
                6448, 6461, 6474, 6487, 6500, 6513, 6526, 6539, 6552, 6565, 6578, 6591, 6604, 6617, 6630,
                6643, 6656, 6669, 6682, 6695, 6708, 6721, 6734, 6747, 6760, 6773, 6786, 6799, 6812, 6825,
                6838, 6851, 6864, 6877, 6890, 6903, 6916, 6929, 6942, 6955, 6968, 6981, 6994, 7007, 7020,
                7033, 7046, 7059, 7072, 7085, 7098, 7111, 7124, 7137, 7150, 7163, 7176, 7189, 7202, 7215,
                7228, 7241, 7254, 7267, 7280, 7293, 7306, 7319, 7332, 7345, 7358, 7371, 7384, 7397, 7410,
                7423, 7436, 7449, 7462, 7475, 7488, 7501, 7514, 7527, 7540, 7553, 7566, 7579, 7592, 7605,
                7618, 7631, 7644, 7657, 7670, 7683, 7696, 7709, 7722, 7735, 7748, 7761, 7774, 7787, 7800,
                7813, 7826, 7839, 7852, 7865, 7878, 7891, 7904, 7917, 7930, 7943, 7956, 7969, 7982, 7995,
                8008, 8021, 8034, 8047, 8060, 8073, 8086, 8099, 8112, 8125, 8138, 8151, 8164, 8177, 8190,
                8203, 8216, 8229, 8242, 8255, 8268, 8281, 8294, 8307, 8320, 8333, 8346, 8359, 8372, 8385,
                8398, 8411, 8424, 8437, 8450, 8463, 8476, 8489, 8502, 8515, 8528, 8541, 8554, 8567, 8580,
                8593, 8606, 8619, 8632, 8645, 8658, 8671, 8684, 8697, 8710, 8723, 8736, 8749, 8762, 8775,
                8788, 8801, 8814, 8827, 8840, 8853, 8866, 8879, 8892, 8905, 8918, 8931, 8944, 8957, 8970,
                8983, 8996, 9009, 9022, 9035, 9048, 9061, 9074, 9087, 9100, 9113, 9126, 9139, 9152, 9165,
                9178, 9191, 9204, 9217, 9230, 9243, 9256, 9269, 9282, 9295, 9308, 9321, 9334, 9347, 9360,
                9373, 9386, 9399, 9412, 9425, 9438, 9451, 9464, 9477, 9490, 9503, 9516, 9529, 9542, 9555,
                9568, 9581, 9594, 9607, 9620, 9633, 9646, 9659, 9672, 9685, 9698, 9711, 9724, 9737, 9750,
                9763, 9776, 9789, 9802, 9815, 9828, 9841, 9854, 9867, 9880, 9893, 9906, 9919, 9932, 9945,
                9958, 9971, 9984, 9997, 10010, 10023, 10036, 10049, 10062, 10075, 10088, 10101, 10114,
                10127, 10140, 10153, 10166, 10179, 10192, 10205, 10218, 10231, 10244, 10257, 10270, 10283,
                10296, 10309, 10322, 10335, 10348, 10361, 10374, 10387, 10400, 10413, 10426, 10439, 10452,
                10465, 10478, 10491, 10504, 10517, 10530, 10543, 10556, 10569, 10582, 10595, 10608, 10621,
                10634, 10647, 10660, 10673, 10686, 10699, 10712, 10725, 10738, 10751, 10764, 10777, 10790,
                10803, 10816, 10829, 10842, 10855, 10868, 10881, 10894, 10907, 10920, 10933, 10946, 10959,
                10972, 10985, 10998, 11011, 11024, 11037, 11050, 11063, 11076, 11089, 11102, 11115, 11128,
                11141, 11154, 11167, 11180, 11193, 11206, 11219, 11232, 11245, 11258, 11271, 11284, 11297,
                11310, 11323, 11336, 11349, 11362, 11375, 11388, 11401, 11414, 11427, 11440, 11453, 11466,
                11479, 11492, 11505, 11518, 11531, 11544, 11557, 11570, 11583, 11596, 11609, 11622, 11635,
                11648, 11661, 11674, 11687, 11700, 11713, 11726, 11739, 11752, 11765, 11778, 11791, 11804,
                11817, 11830, 11843, 11856, 11869, 11882, 11895, 11908, 11921, 11934, 11947, 11960, 11973,
                11986, 11999, 12012, 12025, 12038
            ];
            function jalaali_is_leap(jy) {
              var leapJ = JALAALI_LEAP_CYCLES[Math.floor(jy / 33) % 33];
              return (jy % 33 === leapJ || jy % 33 === leapJ - 1);
            }

            // --- تبدیل اعداد به فارسی و برعکس (بدون تغییر) ---
            const toPersianDigits = (num) => {
                const persian = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
                return num.toString().split('').map(digit => persian[parseInt(digit)] || digit).join('');
            };

            const toEnglishDigits = (str) => {
                const persian = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
                let englishStr = '';
                for (let i = 0; i < str.length; i++) {
                    const char = str[i];
                    const index = persian.indexOf(char);
                    if (index !== -1) {
                        englishStr += index;
                    } else {
                        englishStr += char;
                    }
                }
                return englishStr;
            };

            // --- عناصر DOM تقویم ---
            const datePicker = document.getElementById('persianDatePicker');
            const monthSelect = datePicker.querySelector('.month-select');
            const yearSelect = datePicker.querySelector('.year-select');
            const prevMonthBtn = datePicker.querySelector('.prev-month');
            const nextMonthBtn = datePicker.querySelector('.next-month');
            const daysGrid = datePicker.querySelector('.picker-days');

            // --- متغیرهای حالت تقویم ---
            let currentJalaliDate = []; // [سال, ماه, روز] جلالی برای نمایش تقویم (روز اینجا روی 1 تنظیم می‌شود)
            let selectedInput = null; // فیلد ورودی که تقویم به آن متصل شده
            let selectedJalaliDate = []; // [سال, ماه, روز] جلالی انتخاب شده و در فیلد ورودی نمایش داده می‌شود

            const persianMonths = [
                'فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور',
                'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'
            ];

            // --- توابع اصلی تقویم ---

            function populateMonthYearSelects() {
                // پر کردن ماه ها
                monthSelect.innerHTML = '';
                persianMonths.forEach((monthName, index) => {
                    const option = document.createElement('option');
                    option.value = index + 1;
                    option.textContent = monthName;
                    monthSelect.appendChild(option);
                });

                // پر کردن سال ها
                yearSelect.innerHTML = '';
                const currentYear = currentJalaliDate[0];
                // بازه سال‌ها را کمی بزرگ‌تر می‌کنیم تا انتخاب راحت‌تر باشد
                const startYear = currentYear - 100; 
                const endYear = currentYear + 100; 

                for (let year = startYear; year <= endYear; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = toPersianDigits(year);
                    yearSelect.appendChild(option);
                }

                // انتخاب مقدار فعلی در دراپ‌داون‌ها
                monthSelect.value = currentJalaliDate[1];
                yearSelect.value = currentJalaliDate[0];
            }

            function renderCalendar() {
                daysGrid.innerHTML = ''; // پاک کردن روزهای قبلی

                const [currentYear, currentMonth] = currentJalaliDate;
                // تعداد روزهای ماه جاری شمسی
                const j_d_m_local = [0, 31, 31, 31, 31, 31, 31, 30, 30, 30, 30, 30, 29];
                const daysInMonth = j_d_m_local[currentMonth] + (currentMonth === 12 && jalaali_is_leap(currentYear) ? 1 : 0);
                
                // گرفتن اولین روز هفته میلادی (0=یکشنبه, ..., 6=شنبه) برای روز اول ماه شمسی جاری
                // دقت: `gMonth - 1` برای Date constructor صحیح است زیرا ماه ها در آن 0-indexed هستند.
                const [gYear, gMonth, gDay] = jalali_to_gregorian(currentYear, currentMonth, 1);
                const firstDayOfWeekGregorian = new Date(gYear, gMonth - 1, gDay).getDay(); // 0 = یکشنبه, 1 = دوشنبه, ... 6 = شنبه
                
                // در تقویم شمسی، شنبه اولین روز هفته است.
                // تعداد خانه‌های خالی قبل از شروع ماه شمسی را محاسبه می‌کنیم.
                // اگر روز اول میلادی شنبه باشد (getDay() = 6)، 0 خانه خالی.
                // اگر روز اول میلادی یکشنبه باشد (getDay() = 0)، 1 خانه خالی (برای شنبه).
                // این فرمول (firstDayOfWeekGregorian + 1) % 7 به درستی این منطق را پیاده‌سازی می‌کند.
                const emptyDaysCount = (firstDayOfWeekGregorian + 1) % 7; 

                // اضافه کردن خانه های خالی قبل از شروع ماه
                for (let i = 0; i < emptyDaysCount; i++) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.classList.add('day', 'empty');
                    daysGrid.appendChild(emptyDiv);
                }

                // گرفتن تاریخ امروز جلالی برای علامت‌گذاری دایره آبی
                const today = new Date();
                let [todayJYear, todayJMonth, todayJDay] = gregorian_to_jalali(today.getFullYear(), today.getMonth() + 1, today.getDate());

                // اضافه کردن روزهای ماه
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.classList.add('day');
                    dayDiv.textContent = toPersianDigits(day);
                    dayDiv.dataset.day = day; // برای ذخیره روز جهت انتخاب

                    // علامت گذاری روز جاری (دایره آبی)
                    if (currentYear === todayJYear && currentMonth === todayJMonth && day === todayJDay) {
                        dayDiv.classList.add('current-day');
                    }

                    // علامت گذاری روز انتخاب شده
                    if (selectedJalaliDate[0] === currentYear &&
                        selectedJalaliDate[1] === currentMonth &&
                        selectedJalaliDate[2] === day) {
                        dayDiv.classList.add('selected');
                    }

                    dayDiv.addEventListener('click', () => selectDate(day));
                    daysGrid.appendChild(dayDiv);
                }
            }

            function navigateMonth(offset) {
                let [year, month] = currentJalaliDate; // روز مهم نیست، فقط ماه و سال
                month += offset;
                if (month > 12) {
                    month = 1;
                    year++;
                } else if (month < 1) {
                    month = 12;
                    year--;
                }
                currentJalaliDate = [year, month, 1]; // همیشه روز را روی 1 تنظیم می‌کنیم.
                selectedJalaliDate = []; // وقتی ماه یا سال را تغییر می‌دهیم، انتخاب قبلی پاک شود
                populateMonthYearSelects(); 
                renderCalendar();
            }

            function selectDate(day) {
                const [year, month] = currentJalaliDate;
                selectedJalaliDate = [year, month, day];
                // افزودن صفر به اول اعداد تک رقمی برای فرمت صحیح تاریخ شمسی
                const formattedDate = `${toPersianDigits(year)}/${toPersianDigits(month).padStart(2, '۰')}/${toPersianDigits(day).padStart(2, '۰')}`; 
                if (selectedInput) {
                    selectedInput.value = formattedDate;
                    hideCalendar();
                }
            }

            function showCalendar(inputElement) {
                selectedInput = inputElement;
                datePicker.classList.add('show');

                // Positioning logic (improved)
                const inputRect = inputElement.getBoundingClientRect();
                const pickerWidth = datePicker.offsetWidth;
                const pickerHeight = datePicker.offsetHeight;

                let topPosition = inputRect.bottom + 10;
                // If picker goes off screen below, try to place it above
                if (topPosition + pickerHeight > window.innerHeight) {
                    topPosition = inputRect.top - pickerHeight - 10;
                    // If still off screen (or very high up), center vertically as a fallback
                    if (topPosition < 0) {
                        topPosition = (window.innerHeight - pickerHeight) / 2;
                        if (topPosition < 10) topPosition = 10; // Ensure at least 10px from top
                    }
                }
                datePicker.style.top = `${topPosition}px`;

                // Try to align with input's right edge, or fallback to left alignment
                let desiredRightFromViewport = window.innerWidth - inputRect.right;
                let potentialPickerLeftEdge = inputRect.right - pickerWidth;

                if (potentialPickerLeftEdge < 0) { // If aligning to right would make it go off left
                    datePicker.style.right = 'auto'; // Disable right positioning
                    let leftPosition = inputRect.left;
                    // If aligning to left makes it go off right, adjust
                    if (leftPosition + pickerWidth > window.innerWidth) {
                        leftPosition = window.innerWidth - pickerWidth - 10;
                        if (leftPosition < 0) leftPosition = 10; // Ensure at least 10px from left
                    }
                    datePicker.style.left = `${leftPosition}px`;
                } else {
                    datePicker.style.left = 'auto'; // Disable left positioning
                    datePicker.style.right = `${desiredRightFromViewport}px`;
                }

                // Try to read existing date from input and set calendar
                const inputValue = selectedInput.value;
                if (inputValue) {
                    const englishValue = toEnglishDigits(inputValue);
                    const parts = englishValue.split('/').map(Number);

                    // Validate date parts
                    if (parts.length === 3 && 
                        !isNaN(parts[0]) && parts[0] > 1000 && parts[0] < 1600 && // Basic year validation for Jalali
                        !isNaN(parts[1]) && parts[1] >= 1 && parts[1] <= 12 &&
                        !isNaN(parts[2]) && parts[2] >= 1 && parts[2] <= 31) { // Max day is 31, actual will be checked by render
                        
                        selectedJalaliDate = parts;
                        currentJalaliDate = [parts[0], parts[1], 1]; // Display the month of the selected date, set day to 1
                    } else {
                        // If date format is incorrect or invalid, set to today
                        setCalendarToToday();
                    }
                } else {
                    // If input is empty, set to today
                    setCalendarToToday();
                }

                populateMonthYearSelects(); // Always re-populate and set current values
                renderCalendar();
            }

            function setCalendarToToday() {
                const today = new Date();
                currentJalaliDate = gregorian_to_jalali(today.getFullYear(), today.getMonth() + 1, today.getDate());
                currentJalaliDate[2] = 1; // برای نمایش ماه جاری، روز را روی 1 تنظیم کنید.
                selectedJalaliDate = []; // هیچ روزی در ابتدا انتخاب نشده است تا کاربر کلیک کند.
            }

            function hideCalendar() {
                datePicker.classList.remove('show');
                selectedInput = null;
                selectedJalaliDate = []; // Reset selected date
            }

            // --- شنونده های رویداد برای تقویم ---

            // رویداد کلیک روی دکمه های ناوبری
            prevMonthBtn.addEventListener('click', () => navigateMonth(-1));
            nextMonthBtn.addEventListener('click', () => navigateMonth(1));

            // رویداد تغییر ماه و سال از طریق دراپ‌داون
            monthSelect.addEventListener('change', (event) => {
                currentJalaliDate[1] = parseInt(event.target.value);
                selectedJalaliDate = []; // وقتی ماه یا سال را تغییر می‌دهیم، انتخاب قبلی پاک شود
                renderCalendar();
            });
            yearSelect.addEventListener('change', (event) => {
                currentJalaliDate[0] = parseInt(event.target.value);
                selectedJalaliDate = []; // وقتی ماه یا سال را تغییر می‌دهیم، انتخاب قبلی پاک شود
                renderCalendar();
            });

            document.querySelectorAll('.persian-date-picker').forEach(input => {
                input.addEventListener('click', (event) => {
                    showCalendar(event.target);
                });
                // جلوگیری از تایپ مستقیم در فیلد (اختیاری، ولی برای تقویم انتخابگر توصیه می‌شود)
                input.addEventListener('keydown', (event) => {
                    event.preventDefault();
                });
            });

            // بستن تقویم با کلیک بیرون از آن (همراه با سایر دراپ‌داون‌ها)
            document.addEventListener('click', (event) => {
                // اطمینان از اینکه کلیک روی خود تقویم یا فیلد ورودی نیست
                if (!datePicker.contains(event.target) && !event.target.classList.contains('persian-date-picker')) {
                    hideCalendar();
                }
            });

            // مقداردهی اولیه تقویم با تاریخ امروز میلادی (برای زمانی که هیچ تاریخی انتخاب نشده)
            setCalendarToToday(); 
            populateMonthYearSelects(); 
        });
    </script>
</body>
</html>
