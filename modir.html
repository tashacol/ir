 <!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1400">
    <title>پنل مدیریت جامع - موسسه تعالی</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700;800&display=swap');
        :root {
            --primary: #0d6efd; --primary-light: #e7f3ff; --primary-dark: #0056b3;
            --text-dark: #212529; --text-light: #6c757d; --text-on-dark: #ffffff;
            --bg-main: #f8f9fa; --bg-card: #ffffff; --border-color: #e9ecef;
            --success: #198754; --danger: #dc3545; --warning: #ffc107; --info: #0dcaf0;
            --shadow: 0 4px 25px rgba(0,0,0,0.08);
            --radius-lg: 16px; --radius-md: 12px; --transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Vazirmatn', sans-serif; 
            background-color: var(--bg-main); 
            color: var(--text-dark);
            min-width: 1400px;
        }
        html.modal-open, body.modal-open { overflow: hidden; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes modal-pop-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        .page-loader { position: fixed; inset: 0; background: var(--bg-main); display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s, visibility 0.5s; }
        .page-loader.hidden { opacity: 0; visibility: hidden; }
        .page-loader .spinner { width: 40px; height: 40px; border: 4px solid var(--primary-light); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        
        #login-view { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; animation: fadeIn 0.5s; }
        .login-container { width: 100%; max-width: 420px; background: var(--bg-card); padding: 40px; border-radius: var(--radius-lg); box-shadow: var(--shadow); text-align: center; }
        .login-container .logo { color: var(--primary); font-size: 3rem; margin-bottom: 20px; }
        .login-container h1 { font-size: 1.8rem; margin-bottom: 8px; }
        .login-container p { color: var(--text-light); margin-bottom: 30px; }
        .input-wrapper { position: relative; margin-bottom: 20px; }
        .input-icon { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); color: var(--text-light); }
        .form-input { width: 100%; padding: 14px 50px 14px 15px; border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem; outline: none; transition: var(--transition); background: #fafbfc; }
        .form-input:focus { border-color: var(--primary); background: var(--bg-card); box-shadow: 0 0 0 3px var(--primary-light); }
        .btn-login { width: 100%; padding: 14px; font-size: 1.1rem; font-weight: 500; background: var(--primary); color: var(--text-on-dark); border: none; border-radius: var(--radius-md); cursor: pointer; transition: var(--transition); position: relative; min-height: 52px; display: flex; align-items: center; justify-content: center; }
        .btn-login:hover:not(:disabled) { background: var(--primary-dark); }
        .btn-login.loading .spinner { opacity: 1; }
        .btn-login .spinner { width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3); border-top-color: var(--text-on-dark); border-radius: 50%; animation: spin 0.8s linear infinite; position: absolute; opacity: 0; transition: var(--transition); }
        #login-error-msg { margin-top: 15px; color: var(--danger); min-height: 20px; font-weight: 500; }
        
        #dashboard-view { display: none; padding-top: 70px; }
        .dashboard-header { background: var(--bg-card); padding: 0 30px; height: 70px; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow); position: fixed; top: 0; right: 0; left: 0; z-index: 100; }
        .header-logo, .user-profile-trigger { cursor: pointer; }
        .header-logo { display: flex; align-items: center; color: var(--text-dark); font-weight: 700; font-size: 1.2rem; }
        .header-logo i { margin-left: 10px; color: var(--primary); }

        .header-controls { /* New style for grouping header controls */
            display: flex;
            align-items: center;
        }
        .icon-button { /* New style for refresh button */
            background: none;
            border: none;
            font-size: 1.5rem; /* Match other icons */
            color: var(--text-light); /* Subtle color */
            cursor: pointer;
            margin-right: 15px; /* Spacing from user profile */
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px; /* Make it clickable area larger */
            border-radius: 50%; /* Make it round */
        }
        .icon-button:hover {
            color: var(--primary);
            background-color: var(--primary-light);
        }
        .icon-button.loading i {
            animation: spin 1s linear infinite; /* Reuse spin animation */
        }

        .user-profile-trigger { display: flex; align-items: center; }
        .user-profile-trigger .avatar { width: 40px; height: 40px; background: var(--primary-light); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        
        .dropdown { position: relative; }
        .dropdown-menu { display: none; position: absolute; background-color: var(--bg-card); min-width: 300px; box-shadow: var(--shadow); border-radius: var(--radius-md); z-index: 101; margin-top: 15px; border: 1px solid var(--border-color); animation: fadeIn 0.2s; }
        .dropdown-menu.show { display: block; }
        .user-profile-trigger + .dropdown-menu { left: 0; }
        .header-logo + .dropdown-menu { right: 0; }
        .dropdown-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); text-align: center; }
        .dropdown-header h4 { margin: 0; font-size: 1.1rem; }
        .dropdown-header p { margin: 5px 0 0; color: var(--text-light); font-size: 0.9rem; }
        .dropdown-list { list-style: none; padding: 10px; }
        .dropdown-list li { padding: 10px 15px; font-size: 0.95rem; color: var(--text-light); display: flex; align-items: center; }
        .dropdown-list li i { width: 24px; text-align: center; margin-left: 10px; color: var(--primary); }
        .dropdown-logout-btn { width: calc(100% - 20px); margin: 10px; background: var(--danger); color: #fff; border:none; padding: 10px; border-radius: 8px; cursor:pointer; font-family: inherit; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 8px; }

        .main-container { max-width: 1400px; margin: 30px auto; padding: 0 30px; animation: fadeIn 0.5s; }
        /* Increased gap for better spacing */
        .section-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 40px; 
            margin-bottom: 40px; /* Added: Increased bottom margin for this section */
        }
        /* Increased margin-bottom for better spacing between full-width sections */
        .full-width-section { margin-bottom: 40px; }
        
        .card { background: var(--bg-card); border-radius: var(--radius-lg); box-shadow: var(--shadow); padding: 25px; display: flex; flex-direction: column; }
        .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .card-header .title-part { display: flex; align-items: center;}
        .card-header .icon { color: var(--primary); font-size: 1.5rem; margin-left: 15px; }
        .card-header h2 { font-size: 1.3rem; margin: 0; }
        
        /* Increased gap for better spacing */
        .financial-stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px; }
        .stat-item { padding: 20px; border-radius: var(--radius-md); background: var(--bg-main); }
        .stat-item .label { display: flex; align-items: center; color: var(--text-light); margin-bottom: 8px; }
        .stat-item .label i { margin-left: 8px; font-size: 1.1rem; }
        .stat-item .value { font-size: 1.7rem; font-weight: 700; }
        .stat-item .value small { font-size: 1rem; font-weight: 400; color: var(--text-light); }
        .stat-item.income .value { color: var(--success); }
        .stat-item.expense .value { color: var(--danger); }
        
        .table-responsive { overflow-x: auto; min-height: 250px; /* برای جلوگیری از پرش صفحه هنگام بارگیری */ }
        .data-table { width: 100%; border-collapse: collapse; text-align: right; }
        .data-table th, .data-table td { padding: 15px 10px; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        .data-table th { font-weight: 500; color: var(--text-light); font-size: 0.9rem; }
        .data-table tbody tr:last-child td { border-bottom: none; }
        .data-table .amount { font-weight: 500; }
        .data-table .amount.positive { color: var(--success); }
        .data-table .amount.negative { color: var(--danger); }
        .data-table .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 500; color: #fff; text-align: center; display: inline-block; min-width: 80px; }
        .status-badge.active { background-color: var(--success); }
        .status-badge.finished { background-color: #e9ecef; color: #6c757d; }
        .status-badge.upcoming { background-color: var(--primary); }

        .filter-controls { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-controls label { font-size: 0.9rem; color: var(--text-light); white-space: nowrap; }
        .filter-controls .form-input { padding: 8px 12px; height: 40px; width: 150px; background-color: var(--bg-main); }
        .filter-controls button { padding: 8px 20px; height: 40px; background: var(--primary-light); color: var(--primary); font-weight: 500; border: none; border-radius: var(--radius-md); cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 8px;}
        .filter-controls button:hover { background: var(--primary); color: #fff; }
        .filter-controls button .spinner { width: 16px; height: 16px; border: 2px solid; border-radius: 50%; border-right-color: transparent; animation: spin 0.8s linear infinite; display: none; }
        .filter-controls button.loading .spinner { display: block; }
        .filter-controls button.loading .btn-text { display: none; }


        .pagination-controls { margin-top: 20px; display: flex; justify-content: space-between; align-items: center; }
        .pagination-controls button { padding: 8px 20px; background: var(--primary-light); color: var(--primary); font-weight: 500; border: none; border-radius: 8px; cursor: pointer; transition: var(--transition); }
        .pagination-controls button:hover:not(:disabled) { background: var(--primary); color: #fff; }
        .pagination-controls button:disabled { background: #e9ecef; color: #adb5bd; cursor: not-allowed; }
        .pagination-info { font-size: 0.9rem; color: var(--text-light); font-weight: 500; }

        /* Increased gap for better spacing */
        .staff-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }
        .staff-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 20px; display: flex; flex-direction: column; transition: var(--transition); }
        .staff-card:hover { transform: translateY(-5px); box-shadow: var(--shadow); }
        .staff-header { display: flex; align-items: center; margin-bottom: 15px; }
        .staff-avatar { width: 50px; height: 50px; border-radius: 50%; background: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.5rem; margin-left: 15px; flex-shrink: 0; }
        .staff-title .name { font-weight: 700; font-size: 1.1rem; }
        .staff-title .role { font-size: 0.9rem; color: var(--primary); }
        .staff-info { list-style: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); font-size: 0.95rem; color: var(--text-light); flex-grow: 1; }
        .staff-info li { display: flex; align-items: center; margin-bottom: 10px; }
        .staff-info li i { margin-left: 10px; width: 18px; text-align: center; }
        .staff-card .btn-login { margin-top: auto; padding: 10px; }

        /* Increased gap for better spacing */
        .action-card-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; }
        .action-card { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-decoration: none; color: var(--text-dark); background: var(--bg-main); border-radius: var(--radius-md); transition: var(--transition); }
        .action-card:hover { transform: translateY(-5px); background: var(--primary-light); color: var(--primary); }
        .action-card .icon { font-size: 2.5rem; margin-bottom: 10px; color: var(--primary); }
        .action-card span { font-weight: 500; text-align: center; font-size: 1rem; }

        .skeleton { animation: skeleton-loading 1.5s linear infinite alternate; background-color: #e9ecef; }
        @keyframes skeleton-loading { from { background-color: #f1f3f5; } to { background-color: #e9ecef; } }
        .skeleton-text { width: 100%; height: 1em; border-radius: 4px; }
        .skeleton-avatar { width: 50px; height: 50px; border-radius: 50%; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); animation: fadeIn 0.3s; }
        .modal-overlay.show { display: flex; }
        .modal-box { background: var(--bg-card); padding: 30px; border-radius: var(--radius-lg); width: 90%; max-width: 500px; box-shadow: var(--shadow); position: relative; }
        .modal-overlay.show .modal-box { animation: modal-pop-in 0.3s ease-out; }
        .modal-close-btn { position: absolute; top: 15px; left: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); }
        .modal-list { list-style: none; padding: 10px 0; }
        .modal-list li { padding: 12px 0; font-size: 0.95rem; color: var(--text-light); display: flex; align-items: center; border-bottom: 1px solid var(--border-color); }
        .modal-list li:last-child { border-bottom: none; }
        .modal-list li i { width: 24px; text-align: center; margin-left: 10px; color: var(--primary); }
        .modal-header { text-align: center; margin-bottom: 20px; }
        .modal-header .avatar { width: 60px; height: 60px; border-radius: 50%; background: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto 15px; }
        .modal-header h4 { font-size: 1.2rem; }
        .modal-header p { color: var(--text-light); }

        /* --- Persian Date Picker Styles --- */
        .persian-date-picker-modal {
            position: fixed; /* Changed from absolute to fixed for better positioning */
            background-color: #fff;
            border-radius: 12px;
            box-shadow: var(--shadow); /* Using defined shadow variable */
            width: 280px;
            padding: 15px;
            box-sizing: border-box;
            z-index: 1000;
            display: none;
            flex-direction: column;
            border: 1px solid var(--border-color); /* Using defined border color */
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            opacity: 0;
            transform: translateY(10px);
        }

        .persian-date-picker-modal.show {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }

        .picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color); /* Using defined border color */
        }

        .picker-header .nav-btn {
            background: var(--primary); /* Changed to primary color variable */
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
        }

        .picker-header .nav-btn:hover {
            background-color: var(--primary-dark); /* Changed to primary-dark color variable */
        }

        .picker-header .month-select,
        .picker-header .year-select {
            padding: 5px 8px;
            border-radius: 6px;
            border: 1px solid var(--border-color); /* Using defined border color */
            font-family: 'Vazirmatn', sans-serif;
            font-size: 1rem;
            margin: 0 5px;
            text-align: center;
            background-color: var(--bg-main); /* Using defined background color */
            cursor: pointer;
            flex-grow: 1;
        }
        .picker-header .month-select:focus,
        .picker-header .year-select:focus {
            outline: none;
            border-color: var(--primary); /* Changed to primary color variable */
        }

        .picker-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--text-light); /* Using defined text-light color */
            font-size: 0.9rem;
        }

        .picker-weekdays span {
            padding: 5px 0;
        }

        .picker-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .picker-days .day {
            padding: 8px 0;
            text-align: center;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-size: 0.95rem;
            color: var(--text-dark); /* Using defined text-dark color */
        }

        .picker-days .day:hover {
            background-color: var(--primary-light); /* Changed to primary-light color variable */
        }

        .picker-days .day.empty {
            background-color: transparent;
            cursor: default;
            color: #ccc;
        }

        .picker-days .day.selected {
            background-color: var(--primary); /* Changed to primary color variable */
            color: white;
            font-weight: 500;
        }

        .picker-days .day.current-day:not(.selected) {
            background-color: var(--primary-light); /* Changed to primary-light color variable */
            border: 1px solid var(--primary); /* Changed to primary color variable */
            color: var(--primary); /* Changed to primary color variable */
            font-weight: 500;
        }
        .picker-days .day.current-day.selected {
            background-color: var(--primary);
            color: white;
            font-weight: 500;
        }
    </style>
</head>
<body>

    <div class="page-loader" id="pageLoader"><div class="spinner"></div></div>

    <div id="login-view">
        <div class="login-container">
            <i class="fas fa-shield-alt logo"></i>
            <h1>پنل مدیریت موسسه</h1>
            <p>لطفاً با حساب کاربری مدیرعامل وارد شوید.</p>
            <form id="loginForm" onsubmit="event.preventDefault(); handleLogin();">
                <div class="input-wrapper"><i class="fas fa-user input-icon"></i><input type="number" id="username" class="form-input" placeholder="نام کاربری" required></div>
                <div class="input-wrapper"><i class="fas fa-lock input-icon"></i><input type="password" id="password" class="form-input" placeholder="رمز عبور" required></div>
                <button class="btn-login" id="loginButton"><span class="btn-text">ورود</span><div class="spinner"></div></button>
            </form>
            <p id="login-error-msg"></p>
        </div>
    </div>

    <div id="dashboard-view">
        <header class="dashboard-header">
            <div class="header-logo" id="info-modal-trigger" title="اطلاعات موسسه"><i class="fas fa-landmark-dome"></i><span>داشبورد مدیریت</span></div>
            
            <div class="header-controls">
                <button id="refresh-dashboard-btn" class="icon-button" title="به‌روزرسانی داده‌ها"><i class="fas fa-sync-alt"></i></button>
                <div class="dropdown">
                    <div class="user-profile-trigger" id="user-dropdown-trigger">
                        <div class="avatar"><i class="fas fa-user-tie"></i></div>
                    </div>
                    <div id="user-dropdown" class="dropdown-menu">
                        <div class="dropdown-header"><h4 id="ceo-name-dropdown"></h4><p>مدیرعامل موسسه</p></div>
                        <ul class="dropdown-list"><li><i class="fas fa-id-card-clip"></i> کد ملی: <span id="ceo-nid-dropdown"></span></li></ul>
                        <button id="logoutButton" class="dropdown-logout-btn"><i class="fas fa-sign-out-alt"></i><span>خروج از حساب</span></button>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-container">
            <div class="full-width-section">
                <div class="card">
                    <div class="card-header"><div class="title-part"><i class="fas fa-wallet icon"></i><h2>خلاصه وضعیت مالی</h2></div></div>
                    <div class="financial-stats-grid" id="financial-stats-container">
                        <!-- Financial Stats will be loaded here -->
                    </div>
                </div>
            </div>
            <div class="section-grid">
                <div class="main-column">
                    <div class="card" style="height:100%;">
                        <div class="card-header"><div class="title-part"><i class="fas fa-tasks icon"></i><h2>وضعیت دوره‌ها</h2></div></div>
                        <div class="filter-controls">
                            <label for="courses-start-date">از تاریخ:</label><input type="text" id="courses-start-date" class="form-input persian-date-picker" placeholder="تاریخ را انتخاب کنید">
                            <label for="courses-end-date">تا تاریخ:</label><input type="text" id="courses-end-date" class="form-input persian-date-picker" placeholder="تاریخ را انتخاب کنید">
                            <button id="courses-filter-btn"><span class="btn-text">اعمال فیلتر</span><div class="spinner"></div></button>
                        </div>
                        <div class="table-responsive" style="flex-grow:1;">
                            <table class="data-table">
                                <thead><tr><th>نام دوره</th><th>کد دوره</th><th>تاریخ شروع</th><th>وضعیت</th></tr></thead>
                                <tbody id="courses-table-body"></tbody>
                            </table>
                        </div>
                        <div class="pagination-controls" id="courses-pagination"></div>
                    </div>
                </div>
                <div class="sidebar-column" style="display:flex; flex-direction:column; gap:30px;">
                    <div class="card"><div class="card-header"><div class="title-part"><i class="fas fa-file-signature icon"></i><h2>اقدامات سریع</h2></div></div><div class="action-card-grid"><a href="https://tashacol.github.io/ir/crte.html" target="_blank" class="action-card"><div class="icon"><i class="fas fa-building-user"></i></div><span>تائید سوابق مؤسسه</span></a><a href="https://tashacol.github.io/ir/jahadi.html" target="_blank" class="action-card"><div class="icon"><i class="fas fa-people-carry-box"></i></div><span>تائید سوابق جهادی</span></a></div></div>
                    <div class="card"><div class="card-header"><div class="title-part"><i class="fas fa-database icon"></i><h2>داده‌های موسسه</h2></div></div><div class="action-card-grid" id="data-links-list"></div></div>
                </div>
            </div>
            <div class="full-width-section">
                <div class="card">
                    <div class="card-header"><div class="title-part"><i class="fas fa-receipt icon"></i><h2>ریز تراکنش‌ها</h2></div></div>
                    <div class="filter-controls">
                        <label for="transactions-start-date">از تاریخ:</label><input type="text" id="transactions-start-date" class="form-input persian-date-picker" placeholder="تاریخ را انتخاب کنید">
                        <label for="transactions-end-date">تا تاریخ:</label><input type="text" id="transactions-end-date" class="form-input persian-date-picker" placeholder="تاریخ را انتخاب کنید">
                        <button id="transactions-filter-btn"><span class="btn-text">اعمال فیلتر</span><div class="spinner"></div></button>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead><tr><th>تاریخ</th><th>حسابدار</th><th>درآمد</th><th>مخارج</th><th>سود</th><th>ضرر</th></tr></thead>
                            <tbody id="transactions-table-body"></tbody>
                        </table>
                    </div>
                    <div class="pagination-controls" id="transactions-pagination"></div>
                </div>
            </div>
            <div class="full-width-section"><div class="card"><div class="card-header"><div class="title-part"><i class="fas fa-users-cog icon"></i><h2>کادر اجرایی</h2></div></div><div class="staff-grid" id="staff-list-container"></div></div></div>
        </main>
    </div>

    <div class="modal-overlay" id="info-modal"><div class="modal-box"><button class="modal-close-btn"><i class="fas fa-times"></i></button><div class="card-header" style="border:none;margin-bottom:10px;padding:0;justify-content:center;"><i class="fas fa-landmark-dome icon"></i><h2>اطلاعات موسسه تعالی</h2></div><ul class="modal-list"><li><i class="fas fa-id-card"></i> شناسه ملی: 14013770611</li><li><i class="fas fa-barcode"></i> کد شناسایی: 31605007</li><li><i class="fas fa-file-contract"></i> شماره مجوز: 1403136/32273</li><li><i class="fas fa-hashtag"></i> شماره ثبت: 391</li><li><i class="fas fa-envelope"></i> ایمیل رسمی: irtashacol@gmail.com</li><li><i class="fas fa-envelope-open-text"></i> ایمیل دبیرخانه: Tashaccol@gmail.com</li><li><i class="fas fa-globe"></i> وبسایت: Tashacol.ir</li><li><i class="fab fa-telegram"></i> ایتا: @irtaali</li></ul></div></div>
    
    <!-- Persian Date Picker HTML Element (outside main content) -->
    <div id="persianDatePicker" class="persian-date-picker-modal">
        <div class="picker-header">
            <!-- Icons for navigation buttons -->
            <button class="nav-btn prev-month"><i class="fas fa-chevron-right"></i></button>
            <select class="month-select"></select>
            <select class="year-select"></select>
            <button class="nav-btn next-month"><i class="fas fa-chevron-left"></i></button>
        </div>
        <div class="picker-weekdays">
            <span>ش</span>
            <span>ی</span>
            <span>د</span>
            <span>س</span>
            <span>چ</span>
            <span>پ</span>
            <span>ج</span>
        </div>
        <div class="picker-days">
            <!-- روزها اینجا با جاوااسکریپت پر می‌شوند -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ** مهم: SCRIPT_URL را با URL جدیدی که پس از Deploy کردن اسکریپت Apps Script دریافت می‌کنید، جایگزین کنید. **
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzyFTXag_5BScHtBEN63BoN8L_o1EEGdZiCcsBcIQWb6J2QMx65rSFGZmIW44vSKybyuw/exec"; 
            const CACHE_DURATION = 3600 * 1000;
            const TRANSACTIONS_PAGE_SIZE = 5;
            const COURSES_PAGE_SIZE = 7;

            // --- Element selectors ---
            const pageLoader = document.getElementById('pageLoader'), loginView = document.getElementById('login-view'), dashboardView = document.getElementById('dashboard-view');
            const loginButton = document.getElementById('loginButton'), logoutButton = document.getElementById('logoutButton'), loginErrorMsg = document.getElementById('login-error-msg');
            const ceoNameDropdown = document.getElementById('ceo-name-dropdown'), ceoNidDropdown = document.getElementById('ceo-nid-dropdown');
            const financialStatsContainer = document.getElementById('financial-stats-container');
            const staffListContainer = document.getElementById('staff-list-container'), dataLinksList = document.getElementById('data-links-list');
            const infoModal = document.getElementById('info-modal'), infoModalTrigger = document.getElementById('info-modal-trigger'), infoModalCloseBtn = infoModal.querySelector('.modal-close-btn');
            const userDropdown = document.getElementById('user-dropdown'), userDropdownTrigger = document.getElementById('user-dropdown-trigger');
            const refreshDashboardBtn = document.getElementById('refresh-dashboard-btn');

            // --- Transactions Elements ---
            const transactionsTableBody = document.getElementById('transactions-table-body');
            const transactionsPagination = document.getElementById('transactions-pagination');
            const transactionsFilterBtn = document.getElementById('transactions-filter-btn');
            const transactionsStartDate = document.getElementById('transactions-start-date');
            const transactionsEndDate = document.getElementById('transactions-end-date');
            
            // --- Courses Elements ---
            const coursesTableBody = document.getElementById('courses-table-body');
            const coursesPagination = document.getElementById('courses-pagination');
            const coursesFilterBtn = document.getElementById('courses-filter-btn');
            const coursesStartDate = document.getElementById('courses-start-date');
            const coursesEndDate = document.getElementById('courses-end-date');
            
            // --- Helper Functions ---
            const setCache = (key, data) => localStorage.setItem(key, JSON.stringify({ data, timestamp: new Date().getTime() }));
            const getCache = (key) => {
                const itemStr = localStorage.getItem(key); if (!itemStr) return null;
                const item = JSON.parse(itemStr);
                const isExpired = (new Date().getTime() - item.timestamp) > CACHE_DURATION;
                if (isExpired) { localStorage.removeItem(key); return null; }
                return item.data;
            };

            const renderSkeleton = (rows, cols, container) => {
                container.innerHTML = Array(rows).fill('').map(() => `<tr>${Array(cols).fill('<td><div class="skeleton skeleton-text"></div></td>').join('')}</tr>`).join('');
            };

            const renderPagination = (container, currentPage, totalPages, navHandler) => {
                if (totalPages <= 0) {
                    container.innerHTML = `<p class="pagination-info" style="text-align: center; width: 100%;">داده‌ای برای نمایش یافت نشد.</p>`;
                    return;
                }
                container.innerHTML = `
                    <button class="prev-btn" ${currentPage === 1 ? 'disabled' : ''}>قبلی</button>
                    <span class="pagination-info">صفحه ${currentPage} از ${totalPages}</span>
                    <button class="next-btn" ${currentPage === totalPages ? 'disabled' : ''}>بعدی</button>
                `;
                container.querySelector('.prev-btn').addEventListener('click', () => navHandler(currentPage - 1));
                container.querySelector('.next-btn').addEventListener('click', () => navHandler(currentPage + 1));
            };
            
            // --- Data Fetching and Rendering ---
            const fetchPaginatedData = async (config) => {
                const { action, page, pageSize, startDateEl, endDateEl, tableBody, paginationContainer, renderFunction, navHandler, filterBtn } = config;
                
                filterBtn.classList.add('loading');
                filterBtn.disabled = true;
                const cols = tableBody.previousElementSibling.rows[0].cells.length; // Get column count from header
                renderSkeleton(pageSize, cols, tableBody);
                paginationContainer.innerHTML = ''; // Clear pagination controls during load

                let url = `${SCRIPT_URL}?action=${action}&page=${page}&pageSize=${pageSize}`;
                
                // Convert Persian dates to Gregorian YYYY-MM-DD for backend
                if (startDateEl && startDateEl.value) {
                    const persianDateStr = toEnglishDigits(startDateEl.value); // Convert string with Persian digits to English digits
                    const parts = persianDateStr.split('/').map(Number);
                    if (parts.length === 3 && !isNaN(parts[0]) && !isNaN(parts[1]) && !isNaN(parts[2])) {
                        const [gy, gm, gd] = jalali_to_gregorian(parts[0], parts[1], parts[2]);
                        const formattedGregorian = `${gy}-${String(gm).padStart(2, '0')}-${String(gd).padStart(2, '0')}`;
                        url += `&startDate=${formattedGregorian}`;
                    }
                }
                if (endDateEl && endDateEl.value) {
                    const persianDateStr = toEnglishDigits(endDateEl.value); // Convert string with Persian digits to English digits
                    const parts = persianDateStr.split('/').map(Number);
                    if (parts.length === 3 && !isNaN(parts[0]) && !isNaN(parts[1]) && !isNaN(parts[2])) {
                        const [gy, gm, gd] = jalali_to_gregorian(parts[0], parts[1], parts[2]);
                        const formattedGregorian = `${gy}-${String(gm).padStart(2, '0')}-${String(gd).padStart(2, '0')}`;
                        url += `&endDate=${formattedGregorian}`;
                    }
                }
                
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('خطای شبکه در برقراری ارتباط با سرور.');
                    const result = await response.json();
                    if (result.error) throw new Error(result.message);
                    
                    if(result.data && result.data.length > 0) {
                        renderFunction(result.data, tableBody);
                    } else {
                        tableBody.innerHTML = `<tr><td colspan="${cols}" style="text-align:center; padding: 40px 0; color: var(--text-light);">موردی برای نمایش در این بازه زمانی یافت نشد.</td></tr>`;
                    }
                    renderPagination(paginationContainer, result.currentPage, result.totalPages, navHandler);

                } catch (error) {
                    tableBody.innerHTML = `<tr><td colspan="${cols}" style="text-align:center; padding: 40px 0; color:var(--danger);">${error.message}</td></tr>`;
                    paginationContainer.innerHTML = ''; // Clear pagination on error
                } finally {
                    filterBtn.classList.remove('loading');
                    filterBtn.disabled = false;
                }
            };

            const fetchTransactions = (page = 1) => {
                fetchPaginatedData({
                    action: 'getFinancials', page, pageSize: TRANSACTIONS_PAGE_SIZE,
                    startDateEl: transactionsStartDate, endDateEl: transactionsEndDate,
                    tableBody: transactionsTableBody, paginationContainer: transactionsPagination,
                    renderFunction: renderTransactions, navHandler: fetchTransactions,
                    filterBtn: transactionsFilterBtn
                });
            };
            const renderTransactions = (data, container) => {
                container.innerHTML = data.map(t => `
                    <tr><td>${t.date}</td><td>${t.accountant}</td><td class="amount positive">${t.income}</td>
                    <td class="amount negative">${t.expenses}</td><td class="amount negative">${t.profit}</td>
                    <td class="amount positive">${t.loss}</td></tr>`).join('');
            };

            const fetchCourses = (page = 1) => {
                fetchPaginatedData({
                    action: 'getCourseStatuses', page, pageSize: COURSES_PAGE_SIZE,
                    startDateEl: coursesStartDate, endDateEl: coursesEndDate,
                    tableBody: coursesTableBody, paginationContainer: coursesPagination,
                    renderFunction: renderCourses, navHandler: fetchCourses,
                    filterBtn: coursesFilterBtn
                });
            };
            const renderCourses = (data, container) => {
                const statusClasses = { 'جاری': 'active', 'اتمام': 'finished', 'نام‌نویسی': 'upcoming' };
                container.innerHTML = data.map(course => `
                    <tr><td>${course.name}</td><td>${course.code}</td><td>${course.startDate}</td>
                    <td><span class="status-badge ${statusClasses[course.status] || ''}">${course.status}</span></td></tr>`).join('');
            };

            // This function is for data that does NOT need pagination (e.g., summary, staff, links)
            const fetchNonPaginatedData = async (action, cacheKey, renderFunc, container) => {
                if(container) { // Add skeleton loading for these sections as well
                    if (action === 'getFinancialSummary') {
                        container.innerHTML = Array(4).fill('').map(() => `<div class="stat-item"><div class="skeleton skeleton-text" style="width: 60%; height: 1.2rem; margin-bottom: 10px;"></div><div class="skeleton skeleton-text" style="width: 80%; height: 2rem;"></div></div>`).join('');
                    } else if (action === 'getStaff') {
                         container.innerHTML = Array(3).fill('').map(() => `<div class="staff-card"><div class="staff-header"><div class="skeleton skeleton-avatar"></div><div class="staff-title" style="flex:1;"><div class="skeleton skeleton-text" style="width: 60%;"></div><div class="skeleton skeleton-text" style="width: 40%; margin-top:8px;"></div></div></div><ul class="staff-info">${Array(2).fill('<li><div class="skeleton skeleton-text"></div></li>').join('')}</ul></div>`).join('');
                    } else if (action === 'getDashboardLinks') {
                        container.innerHTML = Array(4).fill('').map(() => `<a href="#" class="action-card skeleton"><div class="skeleton skeleton-text" style="width:80%; height:1.5rem;"></div></a>`).join('');
                    }
                }
                const cachedData = getCache(cacheKey); if (cachedData) { renderFunc(cachedData); return; }
                try {
                    const response = await fetch(`${SCRIPT_URL}?action=${action}`);
                    const result = await response.json();
                    if (result.error) throw new Error(result.message);
                    const dataToRender = result.data || result; // Ensure 'data' field is always used
                    setCache(cacheKey, dataToRender);
                    renderFunc(dataToRender);
                } catch (error) { if(container) container.innerHTML = `<p style="text-align:center; color:var(--danger);">${error.message}</p>`; }
            };

            // Render function for financial summary
            const renderFinancialSummary = (data) => {
                 financialStatsContainer.innerHTML = `
                    <div class="stat-item income"><div class="label"><i class="fas fa-arrow-up"></i><span>درآمد کل</span></div><p class="value">${data.totalIncome || '0'}<small> تومان</small></p></div>
                    <div class="stat-item expense"><div class="label"><i class="fas fa-arrow-down"></i><span>هزینه کل</span></div><p class="value">${data.totalExpenses || '0'}<small> تومان</small></p></div>
                    <div class="stat-item"><div class="label"><i class="fas fa-chart-line"></i><span>سود کل</span></div><p class="value">${data.totalProfit || '0'}<small> تومان</small></p></div>
                    <div class="stat-item"><div class="label"><i class="fas fa-balance-scale-left"></i><span>ضرر کل</span></div><p class="value">${data.totalLoss || '0'}<small> تومان</small></p></div>`;
            };
            const renderStaff = (data) => {
                staffListContainer.innerHTML = data.map(staff => `
                    <div class="staff-card">
                        <div class="staff-header"><div class="staff-avatar">${staff.name.charAt(0)}</div><div class="staff-title"><div class="name">${staff.name}</div><div class="role">${staff.role}</div></div></div>
                        <ul class="staff-info">
                            <li><i class="fas fa-id-card"></i><span>${staff.nationalId}</span></li>
                            <li><i class="fas fa-calendar-alt"></i><span>شروع: ${staff.startDate}</span></li>
                        </ul>
                        <a href="tel:${staff.phone}" class="btn-login"><i class="fas fa-phone" style="margin-left: 8px;"></i> تماس</a>
                    </div>`).join('');
            };
            const renderDataLinks = (links) => {
                dataLinksList.innerHTML = `
                    <a href="${links.students}" target="_blank" class="action-card"><div class="icon"><i class="fas fa-graduation-cap"></i></div><span>لیست دانشجویان</span></a>
                    <a href="${links.registrations}" target="_blank" class="action-card"><div class="icon"><i class="fas fa-user-plus"></i></div><span>ثبت نام کنندگان</span></a>
                    <a href="${links.members}" target="_blank" class="action-card"><div class="icon"><i class="fas fa-users"></i></div><span>اعضای موسسه</span></a>
                    <a href="${links.feedback}" target="_blank" class="action-card"><div class="icon"><i class="fas fa-comments"></i></div><span>نظرات</span></a>`;
            };

            // NEW: Function to refresh all dashboard data
            const refreshDashboard = async () => {
                refreshDashboardBtn.classList.add('loading');
                refreshDashboardBtn.disabled = true;

                // Clear relevant cache keys to force fresh data from server
                localStorage.removeItem('financialSummaryData');
                localStorage.removeItem('financialsData'); 
                localStorage.removeItem('courseStatusesData');
                localStorage.removeItem('staffData');
                localStorage.removeItem('dashboardLinks');

                try {
                    // Re-fetch all data sections
                    await Promise.all([
                        fetchNonPaginatedData('getFinancialSummary', 'financialSummaryData', renderFinancialSummary, financialStatsContainer),
                        fetchTransactions(1), // Reset transactions to page 1
                        fetchCourses(1),     // Reset courses to page 1
                        fetchNonPaginatedData('getStaff', 'staffData', renderStaff, staffListContainer),
                        fetchNonPaginatedData('getDashboardLinks', 'dashboardLinks', renderDataLinks, dataLinksList)
                    ]);
                    console.log("Dashboard data refreshed successfully!");
                } catch (error) {
                    console.error("Error refreshing dashboard:", error);
                    // You might want a more prominent error message for the user if a full refresh fails
                } finally {
                    refreshDashboardBtn.classList.remove('loading');
                    refreshDashboardBtn.disabled = false;
                }
            };

            const initDashboard = (ceoInfo) => {
                ceoNameDropdown.textContent = ceoInfo.name;
                ceoNidDropdown.textContent = ceoInfo.nationalId;
                loginView.style.display = 'none';
                dashboardView.style.display = 'block';
                pageLoader.classList.add('hidden');
                
                // Initial data load for all sections
                refreshDashboard(); // Use the refresh function for initial load too
            };

            // Event Listeners
            transactionsFilterBtn.addEventListener('click', () => fetchTransactions(1));
            coursesFilterBtn.addEventListener('click', () => fetchCourses(1));
            refreshDashboardBtn.addEventListener('click', refreshDashboard);

            window.handleLogin = async () => {
                loginErrorMsg.textContent = '';
                loginButton.classList.add('loading');
                loginButton.disabled = true;
                try {
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    const response = await fetch(`${SCRIPT_URL}?action=ceoLogin&username=${username}&password=${password}`);
                    const result = await response.json();
                    if (result.found) { setCache('ceoInfo', result.data); initDashboard(result.data); } 
                    else { loginErrorMsg.textContent = result.message || 'اطلاعات ورود نامعتبر است.'; }
                } catch (error) { loginErrorMsg.textContent = 'خطا در ارتباط با سرور.'; } 
                finally { loginButton.classList.remove('loading'); loginButton.disabled = false; }
            };
            
            logoutButton.addEventListener('click', () => { localStorage.clear(); location.reload(); });
            
            const closeModal = (modal) => modal.classList.remove('show');
            infoModalTrigger.addEventListener('click', () => infoModal.classList.add('show'));
            infoModalCloseBtn.addEventListener('click', () => closeModal(infoModal));
            userDropdownTrigger.addEventListener('click', (e) => { e.stopPropagation(); userDropdown.classList.toggle('show'); });
            document.addEventListener('click', (e) => {
                if (e.target.closest('.dropdown') || e.target.closest('.icon-button')) return;
                userDropdown.classList.remove('show');
                if (e.target === infoModal) closeModal(infoModal);
            });
            
            const cachedCeoInfo = getCache('ceoInfo');
            if (cachedCeoInfo) {
                initDashboard(cachedCeoInfo);
            } else {
                pageLoader.classList.add('hidden');
                loginView.style.display = 'flex';
            }


            // --- JAVASCRIPT FUNCTIONS FOR PERSIAN DATE PICKER (FIXED & IMPROVED) ---

            // Jalaali-JS constants and helper functions
            const G_DAYS_IN_MONTH = [0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            const J_DAYS_IN_MONTH = [0, 31, 31, 31, 31, 31, 31, 30, 30, 30, 30, 30, 29];

            const JALAALI_LEAP_CYCLES = [
                -61, 9, 38, 109, 118, 127, 166, 175, 184, 202, 211, 220, 239, 248, 257, 286, 295, 304, 322,
                331, 340, 349, 358, 367, 376, 385, 394, 403, 416, 429, 429, 442, 455, 468, 481, 494, 507,
                520, 533, 546, 559, 572, 585, 598, 611, 624, 637, 650, 663, 676, 689, 702, 715, 728, 741,
                754, 767, 780, 793, 806, 819, 832, 845, 858, 871, 884, 897, 910, 923, 936, 949, 962, 975,
                988, 1001, 1014, 1027, 1040, 1053, 1066, 1079, 1092, 1105, 1118, 1131, 1144, 1157, 1170,
                1183, 1196, 1209, 1222, 1235, 1248, 1261, 1274, 1287, 1300, 1313, 1326, 1339, 1352, 1365,
                1378, 1391, 1404, 1417, 1430, 1443, 1456, 1469, 1482, 1495, 1508, 1521, 1534, 1547, 1560,
                1573, 1586, 1599, 1612, 1625, 1638, 1651, 1664, 1677, 1690, 1703, 1716, 1729, 1742, 1755,
                1768, 1781, 1794, 1807, 1820, 1833, 1846, 1859, 1872, 1885, 1898, 1911, 1924, 1937, 1950,
                1963, 1976, 1989, 2002, 2015, 2028, 2041, 2054, 2067, 2080, 2093, 2106, 2119, 2132, 2145,
                2158, 2171, 2184, 2197, 2210, 2223, 2236, 2249, 2262, 2275, 2288, 2301, 2314, 2327, 2340,
                2353, 2366, 2379, 2392, 2405, 2418, 2431, 2444, 2457, 2470, 2483, 2496, 2509, 2522, 2535,
                2548, 2561, 2574, 2587, 2600, 2613, 2626, 2639, 2652, 2665, 2678, 2691, 2704, 2717, 2730,
                2743, 2756, 2769, 2782, 2795, 2808, 2821, 2834, 2847, 2860, 2873, 2886, 2899, 2912, 2925,
                2938, 2951, 2964, 2977, 2990, 3003, 3016, 3029, 3042, 3055, 3068, 3081, 3094, 3107, 3120,
                3133, 3146, 3159, 3172, 3185, 3198, 3211, 3224, 3237, 3250, 3263, 3276, 3289, 3302, 3315,
                3328, 3341, 3354, 3367, 3380, 3393, 3406, 3419, 3432, 3445, 3458, 3471, 3484, 3497, 3510,
                3523, 3536, 3549, 3562, 3575, 3588, 3601, 3614, 3627, 3640, 3653, 3666, 3679, 3692, 3705,
                3718, 3731, 3744, 3757, 3770, 3783, 3796, 3809, 3822, 3835, 3848, 3861, 3874, 3887, 3900,
                3913, 3926, 3939, 3952, 3965, 3978, 3991, 4004, 4017, 4030, 4043, 4056, 4069, 4082, 4095,
                4108, 4121, 4134, 4147, 4160, 4173, 4186, 4199, 4212, 4225, 4238, 4251, 4264, 4277, 4290,
                4303, 4316, 4329, 4342, 4355, 4368, 4381, 4394, 4407, 4420, 4433, 4446, 4459, 4472, 4485,
                4498, 4511, 4524, 4537, 4550, 4563, 4576, 4589, 4602, 4615, 4628, 4641, 4654, 4667, 4680,
                4693, 4706, 4719, 4732, 4745, 4758, 4771, 4784, 4797, 4810, 4823, 4836, 4849, 4862, 4875,
                4888, 4901, 4914, 4927, 4940, 4953, 4966, 4979, 4992, 5005, 5018, 5031, 5044, 5057, 5070,
                5083, 5096, 5109, 5122, 5135, 5148, 5161, 5174, 5187, 5200, 5213, 5226, 5239, 5252, 5265,
                5278, 5291, 5304, 5317, 5330, 5343, 5356, 5369, 5382, 5395, 5408, 5421, 5434, 5447, 5460,
                5473, 5486, 5499, 5512, 5525, 5538, 5551, 5564, 5577, 5590, 5603, 5616, 5629, 5642, 5655,
                5668, 5681, 5694, 5707, 5720, 5733, 5746, 5759, 5772, 5785, 5798, 5811, 5824, 5837, 5850,
                5863, 5876, 5889, 5902, 5915, 5928, 5941, 5954, 5967, 5980, 5993, 6006, 6019, 6032, 6045,
                6058, 6071, 6084, 6097, 6110, 6123, 6136, 6149, 6162, 6175, 6188, 6191, 6204, 6217, 6230,
                6243, 6256, 6269, 6282, 6295, 6308, 6321, 6334, 6347, 6360, 6373, 6386, 6399, 6412, 6425,
                6438, 6451, 6464, 6477, 6490, 6503, 6516, 6529, 6542, 6555, 6568, 6581, 6594, 6607, 6620,
                6633, 6646, 6659, 6672, 6685, 6698, 6711, 6724, 6737, 6750, 6763, 6776, 6789, 6802, 6815,
                6828, 6841, 6854, 6867, 6880, 6893, 6906, 6919, 6932, 6945, 6958, 6971, 6984, 6997, 7010,
                7023, 7036, 7049, 7062, 7075, 7088, 7101, 7114, 7127, 7140, 7153, 7166, 7179, 7192, 7205,
                7218, 7231, 7244, 7257, 7270, 7283, 7296, 7309, 7322, 7335, 7348, 7361, 7374, 7387, 7400,
                7413, 7426, 7439, 7452, 7465, 7478, 7491, 7504, 7517, 7530, 7543, 7556, 7569, 7582, 7595,
                7608, 7621, 7634, 7647, 7660, 7673, 7686, 7699, 7712, 7725, 7738, 7751, 7764, 7777, 7790,
                7803, 7816, 7829, 7842, 7855, 7868, 7881, 7894, 7907, 7920, 7933, 7946, 7959, 7972, 7985,
                7998, 8011, 8024, 8037, 8050, 8063, 8076, 8089, 8102, 8115, 8128, 8141, 8154, 8167, 8180,
                8193, 8206, 8219, 8232, 8245, 8258, 8271, 8284, 8297, 8310, 8323, 8336, 8349, 8362, 8375,
                8388, 8401, 8414, 8427, 8440, 8453, 8466, 8479, 8492, 8505, 8518, 8531, 8544, 8557, 8570,
                8583, 8596, 8609, 8622, 8635, 8648, 8661, 8674, 8687, 8700, 8713, 8726, 8739, 8752, 8765,
                8778, 8791, 8804, 8817, 8830, 8843, 8856, 8869, 8882, 8895, 8908, 8921, 8934, 8947, 8960,
                8973, 8986, 8999, 9012, 9025, 9038, 9051, 9064, 9077, 9090, 9103, 9116, 9129, 9142, 9155,
                9168, 9181, 9194, 9207, 9220, 9233, 9246, 9259, 9272, 9285, 9298, 9311, 9324, 9337, 9350,
                9363, 9376, 9389, 9402, 9415, 9428, 9441, 9454, 9467, 9480, 9493, 9506, 9519, 9532, 9545,
                9558, 9571, 9584, 9597, 9610, 9623, 9636, 9649, 9662, 9675, 9688, 9701, 9714, 9727, 9740,
                9753, 9766, 9779, 9792, 9805, 9818, 9831, 9844, 9857, 9870, 9883, 9896, 9909, 9922, 9935,
                9948, 9961, 9974, 9987, 10000, 10013, 10026, 10039, 10052, 10065, 10078, 10091, 10104,
                10117, 10130, 10143, 10156, 10169, 10182, 10195, 10208, 10221, 10234, 10247, 10260, 10273,
                10286, 10299, 10312, 10325, 10338, 10351, 10364, 10377, 10390, 10403, 10416, 10429, 10442,
                10455, 10468, 10481, 10494, 10507, 10520, 10533, 10546, 10559, 10572, 10585, 10598, 10611,
                10624, 10637, 10650, 10663, 10676, 10689, 10702, 10715, 10728, 10741, 10754, 10767, 10780,
                10793, 10806, 10819, 10832, 10845, 10858, 10871, 10884, 10897, 10910, 10923, 10936, 10949,
                10962, 10975, 10988, 11001, 11014, 11027, 11040, 11053, 11066, 11079, 11092, 11105, 11118,
                11131, 11144, 11157, 11170, 11183, 11196, 11209, 11222, 11235, 11248, 11261, 11274, 11287,
                11300, 11313, 11326, 11339, 11352, 11365, 11378, 11391, 11404, 11417, 11430, 11443, 11456,
                11469, 11482, 11495, 11508, 11521, 11534, 11547, 11560, 11573, 11586, 11599, 11612, 11625,
                11638, 11651, 11664, 11677, 11690, 11703, 11716, 11729, 11742, 11755, 11768, 11781, 11794,
                11807, 11820, 11833, 11846, 11859, 11872, 11885, 11898, 11911, 11924, 11937, 11950, 11963,
                11976, 11989, 12002, 12015, 12028
            ];

            function g_is_leap(year) {
              return ((year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0));
            }

            function j_is_leap(jy) {
              const leapJ = JALAALI_LEAP_CYCLES[Math.floor(jy / 33) % 33];
              return (jy % 33 === leapJ || jy % 33 === leapJ - 1);
            }

            // Gregorian to Jalali (based on jalaali-js toJalaali)
            const gregorian_to_jalali = (gy, gm, gd) => {
                gy = parseInt(gy);
                gm = parseInt(gm);
                gd = parseInt(gd);

                let gy2 = gy - 1600;
                let gm2 = gm - 1; // 0-indexed month
                let gd2 = gd - 1; // 0-indexed day

                let g_day_no = 365 * gy2 + Math.floor((gy2 + 3) / 4) - Math.floor((gy2 + 99) / 100) + Math.floor((gy2 + 399) / 400);
                for (let i = 0; i < gm2; ++i) g_day_no += G_DAYS_IN_MONTH[i];
                if (gm2 > 1 && g_is_leap(gy))
                    g_day_no += 1;
                g_day_no += gd2;

                let j_day_no = g_day_no - 79;

                let j_np = Math.floor(j_day_no / 12053);
                j_day_no %= 12053;

                let jy = 979 + 33 * j_np + 4 * Math.floor(j_day_no / 1461);
                j_day_no %= 1461;

                if (j_day_no >= 366) {
                    jy += Math.floor((j_day_no - 1) / 365);
                    j_day_no = (j_day_no - 1) % 365;
                }

                let jm;
                for (jm = 0; jm < 11 && j_day_no >= J_DAYS_IN_MONTH[jm]; ++jm)
                    j_day_no -= J_DAYS_IN_MONTH[jm];
                jm += 1; // 1-indexed month
                let jd = j_day_no + 1; // 1-indexed day

                return [jy, jm, jd];
            };

            // Jalali to Gregorian (based on jalaali-js toGregorian)
            const jalali_to_gregorian = (jy, jm, jd) => {
                jy = parseInt(jy);
                jm = parseInt(jm);
                jd = parseInt(jd);

                const g_d_m_temp = [...G_DAYS_IN_MONTH]; 

                let j_day_no = (365 * (jy - 979)) + Math.floor((jy - 979) / 33) * 8 + Math.floor(((jy - 979) % 33 + 3) / 4);
                for (let i = 0; i < jm - 1; ++i) j_day_no += J_DAYS_IN_MONTH[i];
                j_day_no += jd - 1;

                let g_day_no = j_day_no + 79;

                let gy_res = 1600 + 400 * Math.floor(g_day_no / 146097);
                g_day_no %= 146097;

                if (g_day_no >= 36525) {
                    gy_res += 100 * Math.floor((g_day_no - 1) / 36524);
                    g_day_no = (g_day_no - 1) % 36524;
                }

                gy_res += 4 * Math.floor(g_day_no / 1461);
                g_day_no %= 1461;

                if (g_day_no >= 366) {
                    gy_res += Math.floor((g_day_no - 1) / 365);
                    g_day_no = (g_day_no - 1) % 365;
                }

                if (g_is_leap(gy_res)) {
                    g_d_m_temp[2] = 29;
                }

                let gm_res;
                for (gm_res = 0; g_day_no >= g_d_m_temp[gm_res]; ++gm_res)
                    g_day_no -= g_d_m_temp[gm_res];
                gm_res += 1; // 1-indexed month
                let gd_res = g_day_no + 1; // 1-indexed day

                return [gy_res, gm_res, gd_res];
            };

            // --- تبدیل اعداد به فارسی و برعکس ---
            const toPersianDigits = (num) => {
                const persian = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
                return num.toString().split('').map(digit => persian[parseInt(digit)] || digit).join('');
            };

            const toEnglishDigits = (str) => {
                const persian = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
                let englishStr = '';
                for (let i = 0; i < str.length; i++) {
                    const char = str[i];
                    const index = persian.indexOf(char);
                    if (index !== -1) {
                        englishStr += index;
                    } else {
                        englishStr += char;
                    }
                }
                return englishStr;
            };

            // --- عناصر DOM تقویم ---
            const datePicker = document.getElementById('persianDatePicker');
            const monthSelect = datePicker.querySelector('.month-select');
            const yearSelect = datePicker.querySelector('.year-select');
            const prevMonthBtn = datePicker.querySelector('.prev-month');
            const nextMonthBtn = datePicker.querySelector('.next-month');
            const daysGrid = datePicker.querySelector('.picker-days');

            // --- متغیرهای حالت تقویم ---
            let currentJalaliDate = []; // [سال, ماه, روز] جلالی برای نمایش تقویم (روز اینجا مهم نیست، فقط ماه و سال)
            let selectedInput = null; // فیلد ورودی که تقویم به آن متصل شده
            let selectedJalaliDate = []; // [سال, ماه, روز] جلالی انتخاب شده و در فیلد ورودی نمایش داده می‌شود

            const persianMonths = [
                'فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور',
                'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'
            ];

            // --- توابع اصلی تقویم ---

            function populateMonthYearSelects() {
                // پر کردن ماه ها
                monthSelect.innerHTML = '';
                persianMonths.forEach((monthName, index) => {
                    const option = document.createElement('option');
                    option.value = index + 1;
                    option.textContent = monthName;
                    monthSelect.appendChild(option);
                });

                // پر کردن سال ها
                yearSelect.innerHTML = '';
                const currentYear = currentJalaliDate[0];
                const startYear = currentYear - 50; // 50 سال قبل از سال جاری
                const endYear = currentYear + 50; // 50 سال بعد از سال جاری

                for (let year = startYear; year <= endYear; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = toPersianDigits(year);
                    yearSelect.appendChild(option);
                }

                // انتخاب مقدار فعلی در دراپ‌داون‌ها
                monthSelect.value = currentJalaliDate[1];
                yearSelect.value = currentJalaliDate[0];
            }

            function renderCalendar() {
                daysGrid.innerHTML = ''; // پاک کردن روزهای قبلی

                const [currentYear, currentMonth, currentDayPlaceholder] = currentJalaliDate;
                // J_DAYS_IN_MONTH آرایه ۱-اینکسد است (ماه ۱ در ایندکس ۱)
                const daysInMonth = J_DAYS_IN_MONTH[currentMonth] + (currentMonth === 12 && j_is_leap(currentYear) ? 1 : 0);
                
                // بروزرسانی دراپ‌داون‌ها (اطمینان از همگام بودن)
                monthSelect.value = currentMonth;
                yearSelect.value = currentYear;

                // گرفتن اولین روز هفته میلادی (0=یکشنبه, ..., 6=شنبه) برای روز اول ماه شمسی جاری
                const [gYear, gMonth, gDay] = jalali_to_gregorian(currentYear, currentMonth, 1);
                const firstDayOfWeekGregorian = new Date(gYear, gMonth - 1, gDay).getDay(); // 0 = یکشنبه, 1 = دوشنبه, ... 6 = شنبه
                
                // در تقویم شمسی، شنبه اولین روز هفته است.
                // اگر روز اول ماه میلادی:
                // شنبه (6) باشد -> 0 خانه خالی نیاز داریم
                // یکشنبه (0) باشد -> 1 خانه خالی نیاز داریم
                // دوشنبه (1) باشد -> 2 خانه خالی نیاز داریم
                // ...
                // جمعه (5) باشد -> 6 خانه خالی نیاز داریم
                const emptyDaysCount = (firstDayOfWeekGregorian + 1) % 7; 

                // اضافه کردن خانه های خالی قبل از شروع ماه
                for (let i = 0; i < emptyDaysCount; i++) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.classList.add('day', 'empty');
                    daysGrid.appendChild(emptyDiv);
                }

                // گرفتن تاریخ امروز جلالی برای علامت‌گذاری دایره آبی
                const today = new Date();
                let [todayJYear, todayJMonth, todayJDay] = gregorian_to_jalali(today.getFullYear(), today.getMonth() + 1, today.getDate());

                // **** رفع مشکل "تقویم یک روز جلوتر است" ****
                // با توجه به گزارش کاربر که دایره آبی یک روز جلوتر است،
                // روز شمسی محاسبه شده برای تاریخ فعلی را یک روز به عقب می‌بریم.
                // این عمل باید با در نظر گرفتن جابجایی ماه و سال انجام شود.
                /* --- START OF DELETED CODE BLOCK --- */
                /*
                if (todayJDay === 1) {
                    // اگر روز محاسبه شده 1 است، به آخرین روز ماه قبل برمی‌گردیم
                    todayJMonth--;
                    if (todayJMonth < 1) {
                        todayJMonth = 12; // به اسفند ماه برگرد
                        todayJYear--;
                    }
                    // پیدا کردن تعداد روزهای ماه جدید (ماه قبل)
                    // J_DAYS_IN_MONTH یک آرایه ۱-اینکسد برای ماه‌ها است (مانند فروردین که ایندکس ۱ است)
                    todayJDay = J_DAYS_IN_MONTH[todayJMonth] + (todayJMonth === 12 && j_is_leap(todayJYear) ? 1 : 0);
                } else {
                    // اگر روز 1 نیست، فقط یک روز کم می‌کنیم
                    todayJDay--;
                }
                */
                /* --- END OF DELETED CODE BLOCK --- */
                // *****************************************

                // اضافه کردن روزهای ماه
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.classList.add('day');
                    dayDiv.textContent = toPersianDigits(day);
                    dayDiv.dataset.day = day; // برای ذخیره روز جهت انتخاب

                    // علامت گذاری روز جاری (دایره آبی)
                    // این قسمت حالا از todayJYear, todayJMonth, todayJDay تصحیح شده استفاده می‌کند
                    if (currentYear === todayJYear && currentMonth === todayJMonth && day === todayJDay) {
                        dayDiv.classList.add('current-day');
                    }

                    // علامت گذاری روز انتخاب شده
                    if (selectedJalaliDate[0] === currentYear &&
                        selectedJalaliDate[1] === currentMonth &&
                        selectedJalaliDate[2] === day) {
                        dayDiv.classList.add('selected');
                    }

                    dayDiv.addEventListener('click', () => selectDate(day));
                    daysGrid.appendChild(dayDiv);
                }
            }

            function navigateMonth(offset) {
                let [year, month, day] = currentJalaliDate;
                month += offset;
                if (month > 12) {
                    month = 1;
                    year++;
                } else if (month < 1) {
                    month = 12;
                    year--;
                }
                currentJalaliDate = [year, month, day];
                populateMonthYearSelects(); // بروزرسانی دراپ‌داون‌ها
                renderCalendar();
            }

            function selectDate(day) {
                const [year, month] = currentJalaliDate;
                selectedJalaliDate = [year, month, day];
                const formattedDate = `${toPersianDigits(year)}/${toPersianDigits(month).padStart(2, '۰')}/${toPersianDigits(day).padStart(2, '۰')}`; // Add padding for single digits
                if (selectedInput) {
                    selectedInput.value = formattedDate;
                    hideCalendar();
                }
            }

            function showCalendar(inputElement) {
                selectedInput = inputElement;
                datePicker.classList.add('show');

                const inputRect = inputElement.getBoundingClientRect();
                const pickerWidth = datePicker.offsetWidth;
                const pickerHeight = datePicker.offsetHeight;

                let topPosition = inputRect.bottom + 10;
                if (topPosition + pickerHeight > window.innerHeight) {
                    topPosition = inputRect.top - pickerHeight - 10;
                    if (topPosition < 0) {
                        topPosition = (window.innerHeight - pickerHeight) / 2;
                        if (topPosition < 10) topPosition = 10;
                    }
                }
                datePicker.style.top = `${topPosition}px`;

                let desiredRightFromViewport = window.innerWidth - inputRect.right;
                let potentialPickerLeftEdge = inputRect.right - pickerWidth;

                if (potentialPickerLeftEdge < 0) {
                    datePicker.style.right = 'auto';
                    let leftPosition = inputRect.left;
                    if (leftPosition + pickerWidth > window.innerWidth) {
                        leftPosition = window.innerWidth - pickerWidth - 10;
                        if (leftPosition < 0) leftPosition = 10;
                    }
                    datePicker.style.left = `${leftPosition}px`;
                } else {
                    datePicker.style.left = 'auto';
                    datePicker.style.right = `${desiredRightFromViewport}px`;
                }

                // Try to read existing date from input and set calendar
                const inputValue = selectedInput.value;
                if (inputValue) {
                    const englishValue = toEnglishDigits(inputValue);
                    const parts = englishValue.split('/').map(Number);

                    if (parts.length === 3 && !isNaN(parts[0]) && !isNaN(parts[1]) && !isNaN(parts[2])) {
                        selectedJalaliDate = parts;
                        currentJalaliDate = [parts[0], parts[1], 1]; // Display the month of the selected date
                    } else {
                        // If date format is incorrect, set to today
                        setCalendarToToday();
                    }
                } else {
                    // If input is empty, set to today
                    setCalendarToToday();
                }

                populateMonthYearSelects();
                renderCalendar();
            }

            function setCalendarToToday() {
                const today = new Date();
                currentJalaliDate = gregorian_to_jalali(today.getFullYear(), today.getMonth() + 1, today.getDate());
                currentJalaliDate[2] = 1; // برای نمایش ماه جاری، روز را روی 1 تنظیم کنید.
                selectedJalaliDate = []; // هیچ روزی در ابتدا انتخاب نشده است تا کاربر کلیک کند.
            }

            function hideCalendar() {
                datePicker.classList.remove('show');
                selectedInput = null;
                selectedJalaliDate = []; // Reset selected date
            }

            // --- شنونده های رویداد برای تقویم ---

            // رویداد کلیک روی دکمه های ناوبری
            prevMonthBtn.addEventListener('click', () => navigateMonth(-1));
            nextMonthBtn.addEventListener('click', () => navigateMonth(1));

            // رویداد تغییر ماه و سال از طریق دراپ‌داون
            monthSelect.addEventListener('change', (event) => {
                currentJalaliDate[1] = parseInt(event.target.value);
                renderCalendar();
            });
            yearSelect.addEventListener('change', (event) => {
                currentJalaliDate[0] = parseInt(event.target.value);
                renderCalendar();
            });

            document.querySelectorAll('.persian-date-picker').forEach(input => {
                input.addEventListener('click', (event) => {
                    showCalendar(event.target);
                });
                // جلوگیری از تایپ مستقیم در فیلد (اختیاری)
                input.addEventListener('keydown', (event) => {
                    event.preventDefault();
                });
            });

            // بستن تقویم با کلیک بیرون از آن
            document.addEventListener('click', (event) => {
                if (!datePicker.contains(event.target) && !event.target.classList.contains('persian-date-picker')) {
                    hideCalendar();
                }
            });

            // مقداردهی اولیه تقویم با تاریخ امروز میلادی (برای زمانی که هیچ تاریخی انتخاب نشده)
            setCalendarToToday(); // This call is made once during DOMContentLoaded
            populateMonthYearSelects(); // Populate dropdowns for the first time
        });
    </script>
</body>
</html>
