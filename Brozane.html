<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±ÛŒØ²ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡</title>
    <!-- ÙÙˆÙ†Øª ÙˆØ²ÛŒØ±Ù…ØªÙ† -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ HTML2Canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;       /* Ù†ÛŒÙ„ÛŒ Ù…Ø¯Ø±Ù† */
            --primary-dark: #4338ca;
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 16px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Vazirmatn', system-ui, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: var(--text-main);
            font-size: 14px;
            padding-bottom: 140px;
        }

        /* --- Loading Overlays --- */
        #loadingBar {
            position: fixed; top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, var(--primary), #ec4899, var(--primary));
            background-size: 200% 100%; z-index: 10001; display: none;
            animation: loadingAnim 1.5s infinite linear;
        }
        @keyframes loadingAnim { 0% {background-position: 100% 0;} 100% {background-position: -100% 0;} }

        #processingMsg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95); z-index: 10000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--primary);
            border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { to {transform: rotate(360deg);} }

        /* --- Toolbar --- */
        .toolbar {
            background: var(--surface); padding: 20px; border-radius: var(--radius);
            box-shadow: var(--shadow); margin-bottom: 24px; border: 1px solid white;
            display: flex; flex-direction: column; gap: 16px;
        }
        .toolbar-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        
        .brand { 
            font-weight: 900; font-size: 20px; color: var(--primary); 
            display: flex; align-items: center; gap: 10px; letter-spacing: -0.5px;
        }
        
        .input-group { display: flex; gap: 12px; flex-wrap: wrap; width: 100%; }
        .input-modern {
            padding: 12px 16px; border: 1px solid var(--border); border-radius: 12px;
            font-family: inherit; background: #f1f5f9; transition: 0.3s; flex: 1; min-width: 220px;
            font-size: 14px;
        }
        .input-modern:focus { background: #fff; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }

        /* Buttons */
        .btn {
            padding: 10px 18px; border: none; border-radius: 12px; cursor: pointer;
            font-family: inherit; font-weight: 700; font-size: 13px; color: white;
            display: flex; align-items: center; gap: 8px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 12px rgba(0,0,0,0.1); }
        .btn:active { transform: translateY(0); }
        .btn svg { width: 18px; height: 18px; stroke-width: 2.5px; }

        .btn-primary { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .btn-dark { background: linear-gradient(135deg, #334155, #1e293b); }
        .btn-purple { background: linear-gradient(135deg, #a855f7, #7e22ce); }
        .btn-orange { background: linear-gradient(135deg, #f97316, #c2410c); }
        .btn-teal { background: linear-gradient(135deg, #14b8a6, #0f766e); }
        .btn-blue { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        
        .mode-toggle { background: #e2e8f0; color: var(--text-muted); border: 1px solid #cbd5e1; box-shadow: none; }
        .mode-toggle.active { background: var(--primary); color: white; border-color: transparent; box-shadow: var(--shadow); }

        /* --- Table --- */
        .planner-wrapper {
            background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow);
            overflow: auto; position: relative; border: 1px solid var(--border);
            max-height: 75vh;
        }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; min-width: 900px; }
        
        thead th {
            background: #1e293b; color: white; padding: 16px; position: sticky; top: 0; z-index: 20;
            border-right: 1px solid #334155; font-weight: 700; font-size: 14px;
        }
        
        /* Ø¯Ú©Ù…Ù‡ Ú©Ù¾ÛŒ Ø¯Ø± Ù‡Ø¯Ø± */
        .copy-col-btn { 
            background: rgba(255,255,255,0.1); border-radius: 8px; padding: 4px 8px; 
            cursor: pointer; float: left; transition:0.2s; font-size: 12px; display:flex; align-items:center;
        }
        .copy-col-btn:hover { background: rgba(255,255,255,0.3); }
        
        th:first-child, td:first-child {
            width: 120px; background: #f8fafc; color: var(--text-muted); font-weight: 800; font-size: 12px;
            position: sticky; right: 0; z-index: 30; border-left: 2px solid #e2e8f0; text-align: center;
            line-height: 1.5; letter-spacing: normal;
        }
        td { border: 1px solid #f1f5f9; text-align: center; height: 40px; padding: 0; vertical-align: middle; }

        /* Task Cell */
        td.task-cell {
            color: white; padding: 4px 8px; font-size: 12px; cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.2); position: relative;
            transition: filter 0.2s; border-radius: 4px;
        }
        td.task-cell:hover { filter: brightness(1.1); z-index: 5; box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        
        .task-inner {
            display: flex; flex-direction: column; justify-content: center; height: 100%;
            pointer-events: none; text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            white-space: normal; line-height: 1.4;
        }
        .task-title { font-weight: 800; margin-bottom: 2px; font-size: 13px; }
        .task-time-range { font-size: 10px; opacity: 0.9; font-weight: 500; background: rgba(0,0,0,0.2); border-radius: 4px; padding: 1px 6px; width: fit-content; margin: 0 auto; }

        /* Selection */
        body.selection-mode td.empty-cell { cursor: crosshair; }
        .selected-cell { background-color: #c7d2fe !important; }

        /* --- Modals --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.7); z-index: 2000;
            justify-content: center; align-items: center; backdrop-filter: blur(8px);
        }
        .modal {
            background: white; padding: 24px; border-radius: 24px; width: 90%; max-width: 450px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); display: flex; flex-direction: column; gap: 16px;
            animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 90vh; 
            overflow-y: auto; 
        }
        @keyframes pop { from {transform: scale(0.9); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        
        .modal-header { display: flex; justify-content: space-between; border-bottom: 1px solid #f1f5f9; padding-bottom: 16px; align-items: center; }
        .modal-header h3 { margin: 0; font-size: 18px; color: #1e293b; display:flex; align-items:center; gap:8px; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #94a3b8; transition: 0.2s; }
        .close-btn:hover { color: var(--danger); transform: rotate(90deg); }
        
        .copy-list { display: flex; flex-direction: column; gap: 8px; max-height: 250px; overflow-y: auto; }
        .copy-item {
            display: flex; align-items: center; gap: 12px; padding: 12px;
            background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0; cursor: pointer; transition: 0.2s;
        }
        .copy-item:hover { background: #f1f5f9; border-color: var(--primary); }
        .copy-item input { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); }

        /* Modern Extras List */
        .extras-list { list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto; }
        .extra-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px; border-bottom: 1px solid #f1f5f9; background: #fff; 
            margin-bottom: 8px; border-radius: 12px; border: 1px solid #e2e8f0;
            transition: 0.2s;
        }
        .extra-row:hover { border-color: #cbd5e1; transform: translateX(-2px); }
        .extra-content { display: flex; align-items: center; gap: 10px; flex: 1; font-weight: 500; }
        
        .extra-controls { display: flex; gap: 6px; align-items: center; }
        .extra-btn {
            background: #f1f5f9; border: none; cursor: pointer; font-size: 14px; padding: 6px; 
            border-radius: 8px; color: var(--text-muted); transition: 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .extra-btn:hover { background: #e2e8f0; color: var(--text-main); }
        .extra-btn.active { background: #e0e7ff; color: var(--primary); }
        .extra-btn.delete { background: #fee2e2; color: var(--danger); }
        .extra-btn.delete:hover { background: #fecaca; }

        /* Custom Checkbox for Checklist */
        .custom-chk {
            width: 24px; height: 24px; border-radius: 6px; border: 2px solid #cbd5e1;
            display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;
            color: white; flex-shrink: 0;
        }
        .custom-chk.checked { background: var(--success); border-color: var(--success); }
        .custom-chk svg { width: 16px; height: 16px; display: none; }
        .custom-chk.checked svg { display: block; }

        .color-options { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; }
        .color-dot { width: 36px; height: 36px; border-radius: 50%; cursor: pointer; border: 3px solid #fff; box-shadow: 0 0 0 1px #cbd5e1; transition: transform 0.2s; }
        .color-dot:hover { transform: scale(1.1); }
        .color-dot.active { box-shadow: 0 0 0 3px var(--primary); transform: scale(1.1); }

        .chart-container { display: flex; justify-content: center; padding: 30px; background: #f8fafc; border-radius: 16px; margin-bottom: 10px; }
        .chart-legend { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; }
        .legend-item { font-size: 12px; display: flex; align-items: center; gap: 6px; background: #fff; padding: 6px 12px; border-radius: 20px; border: 1px solid #e2e8f0; font-weight: 600; }

        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø¨Ø®Ø´ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ */
        .template-card {
            border: 2px solid var(--border); border-radius: 12px; padding: 16px; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; gap: 15px; background: #fff;
        }
        .template-card:hover { border-color: var(--primary); background: #f8fafc; transform: translateY(-2px); }
        .template-icon {
            width: 48px; height: 48px; border-radius: 12px; background: #e0e7ff; color: var(--primary);
            display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0;
        }
        .template-info h4 { margin: 0 0 4px 0; color: #1e293b; font-size: 16px; }
        .template-info p { margin: 0; color: #64748b; font-size: 12px; line-height: 1.5; }

        /* --- PRINT & EXPORT STYLES --- */
        #print-area { display: none; }

        .export-mode, .export-mode * {
            letter-spacing: normal !important;
            word-spacing: normal !important;
        }

        .export-mode {
            background: white;
            padding: 30px;
            font-family: 'Vazirmatn', sans-serif;
            width: 1000px; 
            margin: 0 auto;
            color: #0f172a;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
        }
        
        .export-mode .copy-col-btn {
            display: none !important;
        }

        .print-header {
            display: flex; justify-content: space-between; align-items: flex-end;
            border-bottom: 4px solid var(--primary); padding-bottom: 20px; margin-bottom: 30px;
        }
        .print-title h1 { margin: 0; font-size: 42px; color: var(--primary-dark); font-weight: 900; }
        .print-meta { text-align: left; display: flex; flex-direction: column; gap: 8px; }
        .print-meta div { font-size: 16px; color: #475569; font-weight: 600; display: flex; align-items: center; gap: 8px; justify-content: flex-end; }

        .print-grid-top {
            display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 30px;
        }
        .print-box {
            border: 2px solid #e2e8f0; border-radius: 16px; padding: 20px;
            background-color: #f8fafc;
        }
        .print-box h4 {
            margin: 0 0 15px 0; border-bottom: 2px solid #cbd5e1; padding-bottom: 8px;
            font-size: 22px; color: #1e293b; font-weight: 800; display: flex; align-items: center; gap: 10px;
        }
        .print-items { list-style: none; padding: 0; margin: 0; font-size: 18px; columns: 2; gap: 20px; }
        .print-items li { margin-bottom: 10px; break-inside: avoid; display: flex; align-items: center; gap: 8px; font-weight: 500; }

        .print-table-container table {
            border: 1px solid #cbd5e1; width: 100%; border-collapse: collapse; page-break-inside: auto;
        }
        .print-table-container th {
            background-color: #f1f5f9 !important; color: #1e293b !important;
            border: 1px solid #cbd5e1; padding: 12px; font-size: 18px; text-align: center; font-weight: bold;
            -webkit-print-color-adjust: exact; print-color-adjust: exact;
        }
        .print-table-container tr td:first-child {
            background-color: #f8fafc !important; color: #475569 !important;
            border: 1px solid #cbd5e1; font-weight: bold; text-align: center; font-size: 16px;
            -webkit-print-color-adjust: exact; print-color-adjust: exact; width: 120px;
        }
        .print-table-container td {
            border: 1px solid #e2e8f0; height: 35px; padding: 0;
            page-break-inside: avoid !important; 
        }
        
        .print-table-container td.print-split-cell {
            text-align: center; vertical-align: middle; padding: 6px;
            color: white !important;
            -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;
        }
        .print-table-container .task-title { font-size: 16px; font-weight: 900; display: block; margin-bottom: 4px; color: white !important; }
        .print-table-container .task-time-range { font-size: 14px; border-bottom: 1px solid rgba(255,255,255,0.6); margin-bottom: 4px; display: inline-block; padding: 0 5px; color: white !important; }

        .print-footer {
            margin-top: 30px; border: 3px dashed #cbd5e1; padding: 25px;
            border-radius: 16px; background: #fff; page-break-inside: avoid;
        }
        .print-note-text { font-size: 18px; white-space: pre-wrap; line-height: 1.8; color: #334155; }

        @media print {
            @page { size: A4 portrait; margin: 15mm; } 
            body { 
                background: white; padding: 0; margin: 0; 
                -webkit-print-color-adjust: exact; print-color-adjust: exact; 
                height: auto !important; 
            }
            .no-print, .toolbar, .copy-col-btn, #mainTableWrapper { display: none !important; }
            #print-area { 
                display: block !important; width: 100%; transform: none; 
                overflow: visible !important; height: auto !important; position: static !important;
            }
            .export-mode { width: 100%; padding: 0; } 
            
            table { min-width: auto !important; width: 100% !important; page-break-inside: auto; border-collapse: collapse; }
            tr { page-break-inside: avoid !important; page-break-after: auto; }
            thead { display: table-header-group; }
            tfoot { display: table-footer-group; }
            .print-box { page-break-inside: avoid; }
            
            .print-table-container th { font-size: 14px !important; padding: 8px !important; }
            .print-table-container tr td:first-child { font-size: 13px !important; width: 80px !important; }
            .print-table-container .task-title { font-size: 13px !important; color: white !important; }
            .print-table-container .task-time-range { font-size: 11px !important; border-bottom: 1px solid rgba(255,255,255,0.6) !important; color: white !important; }
        }
    </style>
</head>
<body>

<div id="loadingBar"></div>
<div id="processingMsg">
    <div class="spinner"></div>
    <h3 style="color:#1e293b; margin:0;">Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯...</h3>
    <p id="procTxt" style="color:#64748b; margin-top:10px;">Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</p>
</div>

<!-- Print / Export Container -->
<div id="print-area" class="export-mode">
    <div class="print-header">
        <div class="print-title" style="text-align: right;">
            <h1 id="printTitleDisplay">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ</h1>
        </div>
        <div class="print-meta">
            <div id="printUserDisplay">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                <span id="printUserText"></span>
            </div>
            <div id="printDateDisplay">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                <span id="printDateText"></span>
            </div>
        </div>
    </div>

    <div class="print-grid-top">
        <div class="print-box">
            <h4>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                Ù†Ú©Ø§Øª Ùˆ Ø§Ù„Ø²Ø§Ù…Ø§Øª
            </h4>
            <ul class="print-items" id="printReqList"></ul>
        </div>
        <div class="print-box">
            <h4>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
                Ú†Ú©â€ŒÙ„ÛŒØ³Øª
            </h4>
            <ul class="print-items" id="printChkList"></ul>
        </div>
    </div>

    <div id="printTableContainer" class="print-table-container"></div>

    <div class="print-footer" id="printFooter" style="display:none;">
        <h5 style="margin:0 0 10px 0; font-size:20px; display:flex; align-items:center; gap:8px;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
            ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§:
        </h5>
        <div class="print-note-text" id="printNoteText"></div>
    </div>
</div>

<!-- Main Toolbar -->
<div class="toolbar no-print">
    <div class="toolbar-header">
        <div class="brand" id="pageBrandTitle">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            Ù¾Ù„Ù†Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn" style="background: linear-gradient(135deg, #10b981, #059669); font-weight: 800;" onclick="openTemplatesModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ
            </button>
            <button class="btn mode-toggle" id="selectModeBtn" onclick="toggleSelectMode()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                <span id="modeText">Ø­Ø§Ù„Øª Ø§Ø³Ú©Ø±ÙˆÙ„</span>
            </button>
        </div>
    </div>

    <div class="input-group">
        <input type="text" id="headerTitleInput" class="input-modern" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø¨Ø±Ù†Ø§Ù…Ù‡ (Ù…Ø«Ù„Ø§Ù‹: Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ø·Ø§Ù„Ø¹Ø§ØªÛŒ)" oninput="updateHeader(this.value)">
        <input type="text" id="userNameInput" class="input-modern" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§ (Ø¨Ø±Ø§ÛŒ Ú†Ø§Ù¾)" oninput="updateUserName(this.value)">
    </div>

    <div class="toolbar-header">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn btn-purple" onclick="openModal('extrasModal'); renderExtras();">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
                Ø§Ù„Ø²Ø§Ù…Ø§Øª / Ù„ÛŒØ³Øª
            </button>
            <button class="btn btn-orange" onclick="openModal('noteModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                ÛŒØ§Ø¯Ø¯Ø§Ø´Øª
            </button>
            <button class="btn btn-dark" onclick="openStats()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
                Ø¢Ù…Ø§Ø± ğŸ“Š
            </button>
        </div>
        <div style="flex:1"></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn btn-teal" onclick="openShareModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ
            </button>
            <button class="btn btn-blue" onclick="downloadAsImage()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¹Ú©Ø³
            </button>
            <button class="btn btn-success" onclick="exportData()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„
            </button>
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ
            </button>
            <input type="file" id="fileInput" hidden onchange="importData(this)">
            <button class="btn btn-dark" onclick="printApp()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                Ú†Ø§Ù¾
            </button>
            <button class="btn btn-danger" onclick="clearAll()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                Ø­Ø°Ù Ú©Ù„
            </button>
        </div>
    </div>
</div>

<!-- Main Table -->
<div class="planner-wrapper" id="mainTableWrapper">
    <table id="plannerTable">
        <thead><tr id="tableHeader"><th>Ø²Ù…Ø§Ù†</th></tr></thead>
        <tbody id="plannerBody"></tbody>
    </table>
</div>

<!-- Modals -->

<!-- Templates Modal -->
<div class="modal-overlay" id="templatesModal">
    <div class="modal">
        <div class="modal-header">
            <h3>Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯</h3>
            <button class="close-btn" onclick="closeModal('templatesModal')">&times;</button>
        </div>
        <p style="font-size: 13px; color: var(--text-muted); line-height: 1.6; margin-top:0;">
            ÛŒÚ© Ø§Ù„Ú¯Ùˆ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯. (ØªÙˆØ¬Ù‡: Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ù„Ú¯Ùˆ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡ ÙØ¹Ù„ÛŒ Ø´Ù…Ø§ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯ Ùˆ Ù‚Ø§Ø¨Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø³Øª).
        </p>
        <div style="display:flex; flex-direction:column; gap:12px;">
            <div class="template-card" onclick="applyTemplate('student')">
                <div class="template-icon">ğŸ“</div>
                <div class="template-info">
                    <h4>Ø§Ù„Ú¯ÙˆÛŒ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒÛŒ (Ù¾ÙˆÛŒØ§ Ùˆ Ø¬Ø§Ù…Ø¹)</h4>
                    <p>Ø´Ø§Ù…Ù„ Ø®ÙˆØ§Ø¨ (Û²Û³ ØªØ§ Û¶)ØŒ Ø¢Ù…Ø§Ø¯Ú¯ÛŒ ØµØ¨Ø­Ú¯Ø§Ù‡ÛŒØŒ Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ (Û· ØªØ§ Û±Û´)ØŒ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¹Ù…ÛŒÙ‚ØŒ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ø²Ø¨Ø§Ù† Ùˆ Ø§Ø³ØªØ±Ø§Ø­Øª.</p>
                </div>
            </div>
            <div class="template-card" onclick="applyTemplate('employee')">
                <div class="template-icon">ğŸ’¼</div>
                <div class="template-info">
                    <h4>Ø§Ù„Ú¯ÙˆÛŒ Ú©Ø§Ø±Ù…Ù†Ø¯ / Ø´Ø§ØºÙ„</h4>
                    <p>Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ù…Ø·Ø§Ø¨Ù‚ Ø§ÛŒØ±Ø§Ù†: Ø®ÙˆØ§Ø¨ ØªØ§ Ûµ:Û³Û°ØŒ ØªØ§ÛŒÙ… Ú©Ø§Ø±ÛŒ Ù…ØªÙ…Ø±Ú©Ø² (Û· ØªØ§ Û±Û´)ØŒ Ø§Ø³ØªØ±Ø§Ø­Øª Ø¹ØµØ±ØŒ ØªÙˆØ³Ø¹Ù‡ ÙØ±Ø¯ÛŒ Ùˆ ÙˆÙ‚Øª Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡.</p>
                </div>
            </div>
            <div class="template-card" onclick="applyTemplate('school')">
                <div class="template-icon">ğŸ’</div>
                <div class="template-info">
                    <h4>Ø§Ù„Ú¯ÙˆÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² (Ù…Ø¯Ø±Ø³Ù‡)</h4>
                    <p>Ø®ÙˆØ§Ø¨ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø´Ø±ÙˆØ¹ Ù…Ø¯Ø±Ø³Ù‡ Ø±Ø§Ø³ Û· ØµØ¨Ø­ ØªØ§ Û±Û³:Û³Û°ØŒ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø¯Ù‚ÛŒÙ‚ Ø¨Ø±Ø§ÛŒ ØªÚ©Ø§Ù„ÛŒÙ (Û±Ûµ:Û³Û° ØªØ§ Û±Û¸:Û³Û°) Ùˆ Ø²Ù…Ø§Ù† Ø¢Ø²Ø§Ø¯.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Choice -->
<div class="modal-overlay" id="shareModal">
    <div class="modal">
        <div class="modal-header"><h3>Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆØ´ Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ</h3><button class="close-btn" onclick="closeModal('shareModal')">&times;</button></div>
        <p style="color:var(--text-muted); font-weight:500;">Ù…Ø§ÛŒÙ„ÛŒØ¯ Ú©Ø¯Ø§Ù… Ù†Ø³Ø®Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø´ÙˆØ¯ØŸ</p>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <!-- ØªØºÛŒÛŒØ± Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ø¯Ù‡: Ø§Ø±Ø³Ø§Ù„ ØªØµÙˆÛŒØ± Ø¯Ø± Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ø¬Ø§ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ Ø§Ø±Ø³Ø§Ù„ Ù…ØªÙ† Ø¯Ø§Ø¯ -->
            <button class="btn btn-blue" onclick="executeShare('text')" style="justify-content:center;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                Ø§Ø±Ø³Ø§Ù„ Ù…ØªÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡
            </button>
            <button class="btn btn-success" onclick="executeShare('json')" style="justify-content:center;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
                Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† (JSON)
            </button>
        </div>
    </div>
</div>

<!-- Copy Modal -->
<div class="modal-overlay" id="copyModal">
    <div class="modal">
        <div class="modal-header"><h3>Ú©Ù¾ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ <span id="copySourceLabel" style="color:var(--primary)"></span></h3><button class="close-btn" onclick="closeModal('copyModal')">&times;</button></div>
        <div style="font-size:13px; color:var(--text-muted);">Ø±ÙˆØ²Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯Ø± Ø¢Ù†â€ŒÙ‡Ø§ Ú©Ù¾ÛŒ Ø´ÙˆØ¯:</div>
        <div id="copyTargetList" class="copy-list"></div>
        <button class="btn btn-primary" style="justify-content:center; margin-top:10px;" onclick="executeCopy()">ØªØ§ÛŒÛŒØ¯ Ùˆ Ú©Ù¾ÛŒ</button>
    </div>
</div>

<!-- Single Copy -->
<div class="modal-overlay" id="singleCopyModal">
    <div class="modal">
        <div class="modal-header"><h3>Ú©Ù¾ÛŒ Ø§ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª Ø¨Ù‡...</h3><button class="close-btn" onclick="closeModal('singleCopyModal')">&times;</button></div>
        <div style="font-size:13px; color:var(--text-muted);">Ø±ÙˆØ² Ù…Ù‚ØµØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</div>
        <div id="singleCopyTargetList" class="copy-list"></div>
    </div>
</div>

<!-- Extras -->
<div class="modal-overlay" id="extrasModal">
    <div class="modal">
        <div class="modal-header"><h3>Ø§Ù„Ø²Ø§Ù…Ø§Øª Ùˆ Ù„ÛŒØ³Øª</h3><button class="close-btn" onclick="closeModal('extrasModal')">&times;</button></div>
        <div style="display:flex; gap:10px; border-bottom:1px solid #e2e8f0; padding-bottom:10px;">
            <button class="btn btn-purple" style="flex:1; justify-content:center;" onclick="switchTab('req')">ğŸ”¸ Ù†Ú©Ø§Øª</button>
            <button class="btn btn-dark" style="flex:1; justify-content:center;" onclick="switchTab('chk')">â–«ï¸ Ú†Ú©â€ŒÙ„ÛŒØ³Øª</button>
        </div>
        <div id="tab-req">
            <div style="display:flex; gap:8px; margin-top:10px;"><input type="text" id="reqInput" class="input-modern" placeholder="Ù†Ú©ØªÙ‡ Ø¬Ø¯ÛŒØ¯..."><button class="btn btn-success" onclick="addItem('req')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button></div>
            <ul class="extras-list" id="reqListUi" style="margin-top:10px;"></ul>
        </div>
        <div id="tab-chk" style="display:none">
            <div style="display:flex; gap:8px; margin-top:10px;"><input type="text" id="chkInput" class="input-modern" placeholder="Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯..."><button class="btn btn-success" onclick="addItem('chk')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button></div>
            <ul class="extras-list" id="chkListUi" style="margin-top:10px;"></ul>
        </div>
    </div>
</div>

<!-- Task -->
<div class="modal-overlay" id="taskModal">
    <div class="modal">
        <div class="modal-header"><h3>Ù…Ø¯ÛŒØ±ÛŒØª ÙØ¹Ø§Ù„ÛŒØª</h3><button class="close-btn" onclick="closeModal('taskModal')">&times;</button></div>
        <input type="hidden" id="taskId"><input type="hidden" id="taskDay">
        <div><label class="form-label">Ø³Ø§Ø¹Øª Ø´Ø±ÙˆØ¹</label><select id="inpStart" class="input-modern" onchange="updateEndOptions()"></select></div>
        <div><label class="form-label">Ø¹Ù†ÙˆØ§Ù†</label><input type="text" id="inpName" class="input-modern" autofocus></div>
        <div><label class="form-label">Ø³Ø§Ø¹Øª Ù¾Ø§ÛŒØ§Ù†</label><select id="inpEnd" class="input-modern"></select></div>
        <div><label class="form-label">Ø±Ù†Ú¯</label><div class="color-options" id="colorPalette"></div><input type="color" id="customColor" style="margin-top:10px; width:100%; height:40px; border:none; border-radius:10px; cursor:pointer;"></div>
        <div style="display:flex; justify-content:space-between; margin-top:10px; flex-wrap:wrap; gap:8px;">
            <button class="btn btn-danger" id="btnDeleteTask" onclick="deleteTask()" style="display:none">Ø­Ø°Ù</button>
            <button class="btn btn-teal" id="btnCopyTask" onclick="openSingleCopyModal()" style="display:none">Ú©Ù¾ÛŒ Ø¨Ù‡...</button>
            <div style="flex:1"></div>
            <button class="btn btn-dark" onclick="closeModal('taskModal')">Ù„ØºÙˆ</button>
            <button class="btn btn-primary" onclick="saveTask()">Ø«Ø¨Øª</button>
        </div>
    </div>
</div>

<!-- Note -->
<div class="modal-overlay" id="noteModal">
    <div class="modal">
        <div class="modal-header"><h3>ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§</h3><button class="close-btn" onclick="closeModal('noteModal')">&times;</button></div>
        <textarea id="noteText" class="input-modern" rows="10"></textarea>
        <div style="display:flex; align-items:center; gap:8px; font-size:13px;">
            <input type="checkbox" id="notePrintCheck" style="width:18px; height:18px; accent-color:var(--primary);"> <label for="notePrintCheck">Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ÛŒ Ú†Ø§Ù¾</label>
        </div>
        <div style="display:flex; justify-content:flex-end;"><button class="btn btn-success" onclick="saveNote()">Ø°Ø®ÛŒØ±Ù‡</button></div>
    </div>
</div>

<!-- Stats -->
<div class="modal-overlay" id="statsModal">
    <div class="modal">
        <div class="modal-header"><h3>Ø¢Ù…Ø§Ø±</h3><button class="close-btn" onclick="closeModal('statsModal')">&times;</button></div>
        <div class="chart-container" id="chartArea"></div>
        <div class="chart-legend" id="chartLegend"></div>
    </div>
</div>

<script>
    const persianDigits =['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
    function toFaDigits(str) {
        return String(str).replace(/[0-9]/g, w => persianDigits[w]);
    }

    const DAYS =[
        {id:'sat', l:'Ø´Ù†Ø¨Ù‡'}, {id:'sun', l:'ÛŒÚ©Ø´Ù†Ø¨Ù‡'}, {id:'mon', l:'Ø¯ÙˆØ´Ù†Ø¨Ù‡'},
        {id:'tue', l:'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡'}, {id:'wed', l:'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡'}, {id:'thu', l:'Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡'}, {id:'fri', l:'Ø¬Ù…Ø¹Ù‡'}
    ];
    const COLORS =['#6366f1', '#10b981', '#ef4444', '#f97316', '#a855f7', '#06b6d4', '#ec4899', '#64748b'];
    const TIMELINE =[];
    for(let h=0; h<24; h++) for(let m=0; m<60; m+=15) TIMELINE.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`);
    TIMELINE.push("24:00");

    let appData = {
        tasks:[], header: "", userName: "", note: {text:"", print:false},
        reqs:[{t:"Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù…ÙˆØ± Ù…Ø§Ù„ÛŒ", s:true}],
        chks:[{t:"Ø®Ø±ÛŒØ¯ Ù‡ÙØªÚ¯ÛŒ", s:true, c:false}]
    };

    let isSelect=false, isDrag=false, selStart=null, selCurr=null;
    let pendingCopySource = null; 
    let currentEditingTask = null;

    function getTemplateTasks(type) {
        const tasks =[];
        let idCounter = Date.now();
        const addT = (d, s, dur, n, c) => tasks.push({id: idCounter++, day: d, startStr: s, duration: dur, name: n, color: c});
        
        DAYS.forEach(dayObj => {
            const d = dayObj.id;
            const isWeekend = (d === 'thu' || d === 'fri');
            
            if(type === 'student') {
                addT(d, "00:00", 24, "Ø®ÙˆØ§Ø¨ Ùˆ Ø§Ø³ØªØ±Ø§Ø­Øª ğŸŒ™", "#64748b"); 
                addT(d, "06:00", 4, "Ø¨ÛŒØ¯Ø§Ø±ÛŒØŒ ÙˆØ±Ø²Ø´ Ø³Ø¨Ú© Ùˆ ØµØ¨Ø­Ø§Ù†Ù‡ â˜€ï¸", "#f97316");
                if(!isWeekend) {
                    addT(d, "07:00", 28, "Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ ğŸ›ï¸", "#6366f1");
                    addT(d, "14:00", 6, "Ù†Ø§Ù‡Ø§Ø± Ùˆ Ø§Ø³ØªØ±Ø§Ø­Øª ğŸ±", "#ec4899");
                    addT(d, "15:30", 14, "Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¹Ù…ÛŒÙ‚ / Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ ğŸ“š", "#10b981");
                    addT(d, "19:00", 6, "Ú©Ù„Ø§Ø³ Ø²Ø¨Ø§Ù† / Ù…Ù‡Ø§Ø±Øª Ø¬Ø¯ÛŒØ¯ ğŸ—£ï¸", "#a855f7");
                    addT(d, "20:30", 10, "Ø´Ø§Ù…ØŒ ØªÙØ±ÛŒØ­ Ùˆ Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ ğŸ“±", "#06b6d4");
                    addT(d, "23:00", 4, "Ø¢Ù…Ø§Ø¯Ù‡ Ø³Ø§Ø²ÛŒ Ø®ÙˆØ§Ø¨ ğŸŒ™", "#64748b");
                } else {
                    addT(d, "08:00", 16, "Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¹Ù‚Ø¨â€ŒØ§ÙØªØ§Ø¯Ù‡â€ŒÙ‡Ø§ ğŸ“–", "#10b981");
                    addT(d, "12:00", 12, "Ø®Ø±ÛŒØ¯ØŒ ØªÙØ±ÛŒØ­ Ø¨ÛŒØ±ÙˆÙ† Ùˆ Ø¯ÙˆØ³ØªØ§Ù† ğŸ•ï¸", "#ec4899");
                    addT(d, "15:00", 8, "Ù†Ø§Ù‡Ø§Ø± Ùˆ Ø§Ø³ØªØ±Ø§Ø­Øª Ø·ÙˆÙ„Ø§Ù†ÛŒ ğŸ±", "#64748b");
                    addT(d, "17:00", 16, "Ø³Ø±Ú¯Ø±Ù…ÛŒØŒ ÙÛŒÙ„Ù…ØŒ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡ ğŸ¬", "#a855f7");
                    addT(d, "21:00", 8, "Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ù‡ÙØªÙ‡ Ø¢ÛŒÙ†Ø¯Ù‡ ğŸ“", "#f97316");
                    addT(d, "23:00", 4, "Ø¢Ù…Ø§Ø¯Ù‡ Ø³Ø§Ø²ÛŒ Ø®ÙˆØ§Ø¨ ğŸŒ™", "#64748b");
                }
            }
            else if(type === 'employee') {
                addT(d, "00:00", 22, "Ø®ÙˆØ§Ø¨ Ø¹Ù…ÛŒÙ‚ ğŸŒ™", "#64748b");
                if(!isWeekend) {
                    addT(d, "05:30", 3, "Ø¨ÛŒØ¯Ø§Ø±ÛŒØŒ Ø¯ÙˆØ´ Ùˆ ØµØ¨Ø­Ø§Ù†Ù‡ â˜•", "#f97316");
                    addT(d, "06:15", 3, "Ù…Ø³ÛŒØ± Ø±ÙØª ğŸš—", "#06b6d4");
                    addT(d, "07:00", 28, "ØªØ§ÛŒÙ… Ú©Ø§Ø±ÛŒ Ù…ØªÙ…Ø±Ú©Ø² ğŸ’¼", "#6366f1");
                    addT(d, "14:00", 3, "Ù…Ø³ÛŒØ± Ø¨Ø±Ú¯Ø´Øª ğŸš—", "#06b6d4");
                    addT(d, "14:45", 7, "Ù†Ø§Ù‡Ø§Ø± Ùˆ Ø§Ø³ØªØ±Ø§Ø­Øª Ø¨Ø¹Ø¯ Ø§Ø² Ú©Ø§Ø± ğŸ›‹ï¸", "#ec4899");
                    addT(d, "16:30", 8, "ØªÙˆØ³Ø¹Ù‡ ÙØ±Ø¯ÛŒ / Ù¾Ø±ÙˆÚ˜Ù‡ Ø´Ø®ØµÛŒ ğŸš€", "#10b981");
                    addT(d, "18:30", 12, "Ø´Ø§Ù… Ùˆ ÙˆÙ‚Øª Ø¨Ø§ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡ ğŸ‘¨â€ğŸ‘©â€ğŸ‘§", "#a855f7");
                    addT(d, "21:30", 8, "Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©ØªØ§Ø¨ / Ø¢Ø±Ø§Ù…Ø´ ğŸ“–", "#ef4444");
                    addT(d, "23:30", 2, "Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ§Ø¨ ğŸŒ™", "#64748b");
                } else {
                    addT(d, "05:30", 8, "Ø®ÙˆØ§Ø¨ Ø¹Ù…ÛŒÙ‚ ğŸŒ™", "#64748b");
                    addT(d, "07:30", 10, "ÙˆØ±Ø²Ø´ / Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø¹Ù‚Ø¨â€ŒØ§ÙØªØ§Ø¯Ù‡ ğŸƒâ€â™‚ï¸", "#10b981");
                    addT(d, "10:00", 16, "ØªÙ…ÛŒØ²Ú©Ø§Ø±ÛŒ Ùˆ Ø§Ù…ÙˆØ± Ù…Ù†Ø²Ù„ ğŸ§¹", "#06b6d4");
                    addT(d, "14:00", 8, "Ù†Ø§Ù‡Ø§Ø± ÙˆÛŒÚ˜Ù‡ Ùˆ Ø§Ø³ØªØ±Ø§Ø­Øª ğŸ±", "#ec4899");
                    addT(d, "16:00", 20, "Ù…Ù‡Ù…Ø§Ù†ÛŒØŒ ØªÙØ±ÛŒØ­ Ø®Ø§Ø±Ø¬ Ø§Ø² Ø®Ø§Ù†Ù‡ ğŸŒ³", "#a855f7");
                    addT(d, "21:00", 10, "ÙÛŒÙ„Ù… Ùˆ Ø±ÛŒÙ„Ú©Ø³ ğŸ“º", "#6366f1");
                    addT(d, "23:30", 2, "Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ§Ø¨ ğŸŒ™", "#64748b");
                }
            }
            else if(type === 'school') {
                addT(d, "00:00", 24, "Ø®ÙˆØ§Ø¨ ğŸŒ™", "#64748b");
                if(!isWeekend) {
                    addT(d, "06:00", 2, "Ø¨ÛŒØ¯Ø§Ø±ÛŒØŒ ØµØ¨Ø­Ø§Ù†Ù‡ Ù…Ù‚ÙˆÛŒ ğŸ³", "#f97316");
                    addT(d, "06:30", 2, "Ù…Ø³ÛŒØ± Ù…Ø¯Ø±Ø³Ù‡ ğŸšŒ", "#06b6d4");
                    addT(d, "07:00", 26, "Ù…Ø¯Ø±Ø³Ù‡ Ùˆ Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ ğŸ’", "#6366f1");
                    addT(d, "13:30", 2, "Ù…Ø³ÛŒØ± Ø¨Ø±Ú¯Ø´Øª ğŸšŒ", "#06b6d4");
                    addT(d, "14:00", 6, "Ù†Ø§Ù‡Ø§Ø± Ùˆ Ø§Ø³ØªØ±Ø§Ø­Øª ğŸ²", "#ec4899");
                    addT(d, "15:30", 12, "Ø§Ù†Ø¬Ø§Ù… ØªÚ©Ø§Ù„ÛŒÙ Ù…Ø¯Ø±Ø³Ù‡ âœï¸", "#10b981");
                    addT(d, "18:30", 4, "Ù…ÛŒØ§Ù†â€ŒÙˆØ¹Ø¯Ù‡ Ùˆ Ø§Ø³ØªØ±Ø§Ø­Øª ğŸ¥ª", "#f97316");
                    addT(d, "19:30", 6, "Ù¾ÛŒØ´â€ŒØ®ÙˆØ§Ù†ÛŒ ÙØ±Ø¯Ø§ / Ø²Ø¨Ø§Ù† ğŸ“˜", "#a855f7");
                    addT(d, "21:00", 4, "Ø´Ø§Ù…ØŒ ØªÙ„ÙˆÛŒØ²ÛŒÙˆÙ† Ùˆ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡ ğŸ“º", "#ef4444");
                    addT(d, "22:00", 8, "Ø¢Ù…Ø§Ø¯Ù‡ Ø³Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ø¨ ğŸŒ™", "#64748b");
                } else {
                    addT(d, "06:00", 8, "Ø®ÙˆØ§Ø¨ ğŸŒ™", "#64748b");
                    addT(d, "08:00", 12, "Ù…Ø±ÙˆØ± Ø¯Ø±ÙˆØ³ Ù‡ÙØªÙ‡ Ú¯Ø°Ø´ØªÙ‡ ğŸ“š", "#10b981");
                    addT(d, "11:00", 10, "Ú©Ù„Ø§Ø³ ÙÙˆÙ‚â€ŒØ¨Ø±Ù†Ø§Ù…Ù‡ / ÙˆØ±Ø²Ø´ âš½", "#06b6d4");
                    addT(d, "13:30", 6, "Ù†Ø§Ù‡Ø§Ø± Ùˆ Ø§Ø³ØªØ±Ø§Ø­Øª ğŸ²", "#ec4899");
                    addT(d, "15:00", 12, "Ø¨Ø§Ø²ÛŒ ÙˆÛŒØ¯Ø¦ÙˆÛŒÛŒ / Ø³Ø±Ú¯Ø±Ù…ÛŒ ğŸ®", "#f97316");
                    addT(d, "18:00", 16, "Ø¯ÙˆØ±Ù‡Ù…ÛŒ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡ / ØªÙØ±ÛŒØ­ ğŸ‰", "#a855f7");
                    addT(d, "22:00", 8, "Ø¢Ù…Ø§Ø¯Ù‡ Ø³Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ø¨ ğŸŒ™", "#64748b");
                }
            }
        });
        return tasks;
    }

    function openTemplatesModal() { openModal('templatesModal'); }

    function applyTemplate(type) {
        if(!confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø§Ø¹Ù…Ø§Ù„ Ø§ÛŒÙ† Ø§Ù„Ú¯ÙˆØŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ ÙØ¹Ù„ÛŒ Ø´Ù…Ø§ Ø±Ø§ Ù¾Ø§Ú© Ùˆ Ø¨Ø§ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†Ø¯.")) return;
        
        let headerTitle = "Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±ÛŒØ²ÛŒ";
        if(type === 'student') headerTitle = "Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ø·Ø§Ù„Ø¹Ø§ØªÛŒ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒÛŒ";
        if(type === 'employee') headerTitle = "Ø¨Ø±Ù†Ø§Ù…Ù‡ Ú©Ø§Ø±ÛŒ Ùˆ ØªÙˆØ³Ø¹Ù‡ ÙØ±Ø¯ÛŒ";
        if(type === 'school') headerTitle = "Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ø¯Ø±Ø³Ù‡ Ùˆ ØªÚ©Ø§Ù„ÛŒÙ";

        appData.tasks = getTemplateTasks(type);
        
        if(type === 'student') {
            appData.reqs =[{t:"Ú¯ÙˆØ´ÛŒ Ø¯ÙˆØ± Ø§Ø² Ø¯Ø³ØªØ±Ø³ Ù‡Ù†Ú¯Ø§Ù… Ù…Ø·Ø§Ù„Ø¹Ù‡", s:true}, {t:"Ù…Ø±ÙˆØ± ÙÙ„Ø´â€ŒÚ©Ø§Ø±Øªâ€ŒÙ‡Ø§ Ø´Ø¨â€ŒÙ‡Ø§", s:true}];
            appData.chks =[{t:"Ø§Ù†Ø¬Ø§Ù… ØªÚ©Ø§Ù„ÛŒÙ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡", s:true, c:false}, {t:"Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡", s:true, c:false}];
        } else if(type === 'employee') {
            appData.reqs =[{t:"Ù¾Ø§Ø³Ø® Ù†Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ø§ÛŒÙ…ÛŒÙ„ Ú©Ø§Ø±ÛŒ Ø¨Ø¹Ø¯ Ø§Ø² Ø³Ø§Ø¹Øª 18", s:true}, {t:"Ù†ÙˆØ´ÛŒØ¯Ù† Ø¢Ø¨ Ú©Ø§ÙÛŒ Ø¯Ø± Ø´Ø±Ú©Øª", s:true}];
            appData.chks =[{t:"Ø®Ø±ÛŒØ¯ Ù…Ø§ÛŒØ­ØªØ§Ø¬ Ù…Ù†Ø²Ù„", s:true, c:false}, {t:"ØªÙ…Ø§Ø³ Ø¨Ø§ ÙˆØ§Ù„Ø¯ÛŒÙ†", s:true, c:false}];
        } else {
            appData.reqs =[{t:"Ø¢Ù…Ø§Ø¯Ù‡ Ú©Ø±Ø¯Ù† Ú©ÛŒÙ Ù…Ø¯Ø±Ø³Ù‡ Ø´Ø¨ Ù‚Ø¨Ù„", s:true}, {t:"Ø®ÙˆØ§Ø¨ Ø±Ø£Ø³ Ø³Ø§Ø¹Øª 10:00", s:true}];
            appData.chks =[{t:"Ø§Ù†Ø¬Ø§Ù… Ù¾ÛŒÚ© Ø¢Ø¯ÛŒÙ†Ù‡", s:true, c:false}, {t:"Ù…Ø±ØªØ¨ Ú©Ø±Ø¯Ù† Ø§ØªØ§Ù‚", s:true, c:false}];
        }

        updateHeader(headerTitle);
        saveData(); renderTable(); closeModal('templatesModal');
        alert("Ø§Ù„Ú¯ÙˆÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯. Ø­Ø§Ù„Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¢Ù† Ø±Ø§ Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ Ú©Ù†ÛŒØ¯.");
    }

    function showLoader(msg) { 
        document.getElementById('procTxt').innerText = msg || 'Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´';
        document.getElementById('processingMsg').style.display = 'flex'; 
    }
    function hideLoader() { document.getElementById('processingMsg').style.display = 'none'; }
    function showBar() { document.getElementById('loadingBar').style.display = 'block'; }
    function hideBar() { document.getElementById('loadingBar').style.display = 'none'; }

    function init() {
        const saved = localStorage.getItem('finalProPlannerV10');
        if(saved) {
            try {
                const d = JSON.parse(saved);
                if(Array.isArray(d)) appData.tasks = d; else appData = {...appData, ...d};
            } catch(e){}
        }

        updateHeader(appData.header || "");
        document.getElementById('userNameInput').value = appData.userName || "";
        
        const startSel = document.getElementById('inpStart');
        TIMELINE.slice(0, -1).forEach(t => startSel.add(new Option(toFaDigits(t), t)));

        const pal = document.getElementById('colorPalette');
        COLORS.forEach(c => {
            const dot = document.createElement('div');
            dot.className='color-dot'; dot.style.background=c;
            dot.onclick=()=>{
                document.getElementById('customColor').value=c;
                document.querySelectorAll('.color-dot').forEach(el=>el.classList.remove('active'));
                dot.classList.add('active');
            };
            pal.appendChild(dot);
        });

        renderHeader(); renderTable(); setupTouch();
    }

    function renderHeader() {
        const tr = document.getElementById('tableHeader');
        while(tr.children.length>1) tr.removeChild(tr.lastChild);
        DAYS.forEach(d=>{
            const th=document.createElement('th');
            th.innerHTML=`<div style="display:flex;justify-content:center;gap:5px;align-items:center;">
                <span class="copy-col-btn" onclick="openCopyModal('${d.id}')" title="Ú©Ù¾ÛŒ Ú©Ù„ Ø±ÙˆØ²">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    Ú©Ù¾ÛŒ
                </span>
                ${d.l}
            </div>`;
            tr.appendChild(th);
        });
    }

    function renderTable() {
        const b = document.getElementById('plannerBody'); b.innerHTML='';
        const occ = {}; DAYS.forEach(d=>occ[d.id]=new Array(TIMELINE.length).fill(false));

        for(let idx=0; idx < TIMELINE.length - 1; idx++) {
            const time = TIMELINE[idx];
            const nextTime = TIMELINE[idx+1];
            const tr = document.createElement('tr');
            const tdTime = document.createElement('td'); 
            tdTime.innerText = `${toFaDigits(time)} ØªØ§ ${toFaDigits(nextTime)}`; 
            tr.appendChild(tdTime);

            DAYS.forEach(day => {
                if(occ[day.id][idx]) return;
                const task = appData.tasks.find(t=>t.day===day.id && t.startStr===time);

                if(task) {
                    const td = document.createElement('td');
                    td.rowSpan = task.duration; td.className='task-cell';
                    td.style.backgroundColor=task.color;
                    const endIdx = idx + task.duration;
                    const endStr = TIMELINE[endIdx];
                    td.innerHTML=`<div class="task-inner"><span class="task-time-range">${toFaDigits(task.startStr)} ØªØ§ ${toFaDigits(endStr)}</span><span class="task-title">${task.name}</span></div>`;
                    td.onclick=(e)=>{e.stopPropagation(); openTaskModal(task);};
                    td.draggable=true;
                    td.ondragstart=(e)=>{e.dataTransfer.setData('tid', task.id);};
                    tr.appendChild(td);
                    for(let i=1; i<task.duration; i++) if(idx+i<TIMELINE.length) occ[day.id][idx+i]=true;
                } else {
                    const td = document.createElement('td');
                    td.className='empty-cell'; td.dataset.d=day.id; td.dataset.i=idx;
                    td.ondragover=(e)=>e.preventDefault();
                    td.ondrop=(e)=>handleDrop(e, day.id, time);
                    tr.appendChild(td);
                }
            });
            b.appendChild(tr);
        }
    }

    function updateEndOptions() {
        const startVal = document.getElementById('inpStart').value;
        const sIdx = TIMELINE.indexOf(startVal);
        const endSel = document.getElementById('inpEnd');
        endSel.innerHTML = '';
        for (let i = sIdx + 1; i < TIMELINE.length; i++) {
            const time = TIMELINE[i];
            const duration = i - sIdx;
            let durationText = "";
            const totalMin = duration * 15;
            if(totalMin < 60) durationText = `${toFaDigits(totalMin)} Ø¯Ù‚ÛŒÙ‚Ù‡`;
            else {
                const h = Math.floor(totalMin/60);
                const m = totalMin%60;
                durationText = `${toFaDigits(h)} Ø³Ø§Ø¹Øª` + (m>0 ? ` Ùˆ ${toFaDigits(m)} Ø¯Ù‚ÛŒÙ‚Ù‡` : "");
            }
            endSel.add(new Option(`${toFaDigits(time)} | ${durationText}`, duration));
        }
    }

    function preparePrintDOM() {
        document.getElementById('printTitleDisplay').innerText = appData.header || "Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ";
        document.getElementById('printUserText').innerText = appData.userName ? `Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±: ${appData.userName}` : "Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±: Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡";
        document.getElementById('printDateText').innerText = `ØªØ§Ø±ÛŒØ®: ${toFaDigits(new Date().toLocaleDateString('fa-IR'))}`;

        const rL = document.getElementById('printReqList'); rL.innerHTML='';
        appData.reqs.filter(x=>x.s).forEach(x => rL.innerHTML+=`<li><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg> ${x.t}</li>`);
        
        const cL = document.getElementById('printChkList'); cL.innerHTML='';
        appData.chks.filter(x=>x.s).forEach(x => {
            const icon = x.c ? 
                `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>` : 
                `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#cbd5e1" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>`;
            cL.innerHTML+=`<li>${icon} ${x.t}</li>`;
        });

        const tblCont = document.getElementById('printTableContainer');
        tblCont.innerHTML = '<table><thead><tr id="printTableHeader"><th>Ø²Ù…Ø§Ù†</th></tr></thead><tbody id="printTableBody"></tbody></table>';
        
        const pHead = document.getElementById('printTableHeader');
        DAYS.forEach(d => {
            const th = document.createElement('th');
            th.innerText = d.l;
            pHead.appendChild(th);
        });

        const pBody = document.getElementById('printTableBody');
        const occ = {}; 
        DAYS.forEach(d => occ[d.id] = { active: false, remaining: 0, taskObj: null });

        for(let idx = 0; idx < TIMELINE.length - 1; idx++) {
            const time = TIMELINE[idx];
            const nextTime = TIMELINE[idx+1];
            const tr = document.createElement('tr');
            
            const tdTime = document.createElement('td');
            tdTime.innerText = `${toFaDigits(time)} ØªØ§ ${toFaDigits(nextTime)}`;
            tr.appendChild(tdTime);

            DAYS.forEach(day => {
                const state = occ[day.id];
                const task = appData.tasks.find(t => t.day === day.id && t.startStr === time);
                
                if (task) {
                    state.active = true;
                    state.remaining = task.duration;
                    state.taskObj = task;
                }

                const td = document.createElement('td');

                if (state.active) {
                    const tObj = state.taskObj;
                    td.style.backgroundColor = tObj.color;
                    td.className = 'print-split-cell';
                    
                    const isFirst = (state.remaining === tObj.duration);
                    const isLast = (state.remaining === 1);

                    if(isFirst && isLast) {
                        td.style.border = '2px solid #ffffff';
                    } else if (isFirst) {
                        td.style.borderTop = '2px solid #ffffff';
                        td.style.borderRight = '2px solid #ffffff';
                        td.style.borderLeft = '2px solid #ffffff';
                        td.style.borderBottom = 'none';
                    } else if (isLast) {
                        td.style.borderBottom = '2px solid #ffffff';
                        td.style.borderRight = '2px solid #ffffff';
                        td.style.borderLeft = '2px solid #ffffff';
                        td.style.borderTop = 'none';
                    } else {
                        td.style.borderRight = '2px solid #ffffff';
                        td.style.borderLeft = '2px solid #ffffff';
                        td.style.borderTop = 'none';
                        td.style.borderBottom = 'none';
                    }

                    if (isFirst && isLast) {
                        const endIdx = TIMELINE.indexOf(tObj.startStr) + tObj.duration;
                        const endStr = TIMELINE[endIdx] ? TIMELINE[endIdx] : "24:00";
                        td.innerHTML = `<span class="task-title">${tObj.name}</span><br><span class="task-time-range">${toFaDigits(tObj.startStr)} ØªØ§ ${toFaDigits(endStr)}</span>`;
                    } else if (isFirst) {
                        td.innerHTML = `<span class="task-title">${tObj.name}</span>`;
                    } else if (isLast) {
                        const endIdx = TIMELINE.indexOf(tObj.startStr) + tObj.duration;
                        const endStr = TIMELINE[endIdx] ? TIMELINE[endIdx] : "24:00";
                        td.innerHTML = `<span class="task-time-range">${toFaDigits(tObj.startStr)} ØªØ§ ${toFaDigits(endStr)}</span>`;
                    } else {
                        td.innerHTML = `&nbsp;`; 
                    }

                    state.remaining--;
                    if (state.remaining <= 0) {
                        state.active = false;
                        state.taskObj = null;
                    }
                } else {
                    td.innerHTML = `&nbsp;`;
                }
                tr.appendChild(td);
            });
            pBody.appendChild(tr);
        }

        const ftr = document.getElementById('printFooter');
        if(appData.note.print && appData.note.text) {
            ftr.style.display = 'block';
            document.getElementById('printNoteText').innerText = appData.note.text;
        } else { ftr.style.display = 'none'; }
    }

    function openShareModal() { document.getElementById('shareModal').style.display = 'flex'; }

    // ØªØºÛŒÛŒØ± Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ø¯Ù‡: Ø§ÙØ²ÙˆØ¯Ù† Ù‚Ø§Ø¨Ù„ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ù…ØªÙ† (Text)
    async function executeShare(type) {
        closeModal('shareModal');
        if (type === 'json') shareBackupFile();
        else if (type === 'image') shareImage(); // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø¨Ù‡ Ù‡ÛŒÚ† ÙˆØ¬Ù‡ Ø­Ø°Ù Ù†Ø´Ø¯Ù‡ ØªØ§ Ù‚ÙˆØ§Ù†ÛŒÙ† Ù†Ù‚Øµ Ù†Ø´ÙˆØ¯
        else if (type === 'text') shareTextSchedule(); // ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø³ÛŒØ³ØªÙ… Ø¬Ø¯ÛŒØ¯ ØªÙˆÙ„ÛŒØ¯ Ù…ØªÙ†
    }

    // --- Ø³ÛŒØ³ØªÙ… Ø¬Ø¯ÛŒØ¯: Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ùˆ Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ù…ØªÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡ ---
    async function shareTextSchedule() {
        showLoader("Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…ØªÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡...");
        
        setTimeout(async () => {
            let textOutput = `ğŸ“… ${appData.header || 'Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ'}\n`;
            if (appData.userName) textOutput += `ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: ${appData.userName}\n`;
            textOutput += `\n`; // Ø®Ø· Ø®Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø²ÛŒØ¨Ø§ÛŒÛŒ

            // Ø¨Ø±Ø±Ø³ÛŒ Ø±ÙˆØ² Ø¨Ù‡ Ø±ÙˆØ²
            DAYS.forEach(day => {
                // Ø¯Ø±ÛŒØ§ÙØª ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù‡Ù…Ø§Ù† Ø±ÙˆØ²
                let dayTasks = appData.tasks.filter(t => t.day === day.id);
                
                if (dayTasks.length > 0) {
                    textOutput += `ğŸŸ¢ ${day.l}:\n`;
                    
                    // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§ Ø§Ø² 00:00 Ø¨Ù‡ Ø¨Ø§Ù„Ø§
                    dayTasks.sort((a, b) => a.startStr.localeCompare(b.startStr));
                    
                    // Ù‚Ø§Ù„Ø¨â€ŒØ¨Ù†Ø¯ÛŒ Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§ Ùˆ ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§
                    dayTasks.forEach(t => {
                        let sIdx = TIMELINE.indexOf(t.startStr);
                        let eIdx = sIdx + t.duration;
                        let endStr = TIMELINE[eIdx] ? TIMELINE[eIdx] : "24:00";
                        
                        // Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù‚Ø§Ù„Ø¨ Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ Ø´Ù…Ø§ Ø¨Ø§ Ø§Ø¹Ø¯Ø§Ø¯ ÙØ§Ø±Ø³ÛŒ
                        textOutput += `${toFaDigits(t.startStr)} ØªØ§ ${toFaDigits(endStr)} = ${t.name}\n`;
                    });
                    textOutput += `\n`; // ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† Ø±ÙˆØ²Ù‡Ø§
                }
            });

            // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Web Share API Ù…ÙˆØ¨Ø§ÛŒÙ„/Ø³ÛŒØ³ØªÙ…â€ŒØ¹Ø§Ù…Ù„
            if (navigator.canShare) {
                try {
                    await navigator.share({ 
                        title: appData.header || 'Ø¨Ø±Ù†Ø§Ù…Ù‡', 
                        text: textOutput 
                    });
                } catch (e) { 
                    console.log("Ø§Ø´ØªØ±Ø§Ú© Ù„ØºÙˆ Ø´Ø¯."); 
                }
            } else {
                // Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ (Ù…Ø«Ù„Ø§Ù‹ Ø¯Ø± Ø¨Ø±Ø®ÛŒ Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ±Ù‡Ø§)ØŒ Ú©Ù¾ÛŒ Ø¯Ø± Ú©Ù„ÛŒÙ¾â€ŒØ¨ÙˆØ±Ø¯
                try {
                    await navigator.clipboard.writeText(textOutput);
                    alert("Ù…ØªÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª Ú©Ø§Ù…Ù„ Ú©Ù¾ÛŒ Ø´Ø¯. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¢Ù† Ø±Ø§ Ù¾ÛŒØ³Øª (Paste) Ú©Ù†ÛŒØ¯.");
                } catch(e) {
                    alert("Ø®Ø·Ø§ Ø¯Ø± Ø³ÛŒØ³ØªÙ… Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø±.");
                }
            }
            hideLoader();
        }, 600);
    }

    // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¯Ø³Øªâ€ŒÙ†Ø®ÙˆØ±Ø¯Ù‡ Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡ ØªØ§ Ø§Ú¯Ø± Ø¯Ø± Ø¢ÛŒÙ†Ø¯Ù‡ Ø§Ø² Ø¯Ú©Ù…Ù‡ Ø¯ÛŒÚ¯Ø± ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø´Ø¯ Ú©Ø§Ø± Ú©Ù†Ø¯
    async function shareImage() {
        showLoader("Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ± Ø¨Ø§Ú©ÛŒÙÛŒØª...");
        const element = document.getElementById('print-area');
        preparePrintDOM();
        element.style.display = 'block';
        element.style.position = 'absolute'; element.style.top = '0'; element.style.left = '-9999px';
        setTimeout(() => {
            html2canvas(element, { scale: 3, useCORS: true, backgroundColor: '#ffffff' }).then(async canvas => {
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], `${appData.header || 'Plan'}.png`, { type: "image/png" });
                    const text = `ğŸ“… Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ ${appData.userName || ''}\nğŸ“… ØªØ§Ø±ÛŒØ®: ${toFaDigits(new Date().toLocaleDateString('fa-IR'))}`;
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        try { await navigator.share({ files:[file], title: 'Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ', text: text }); }
                        catch (e) { console.log(e); }
                    } else {
                        const link = document.createElement('a'); link.download = `${appData.header || 'Plan'}.png`;
                        link.href = canvas.toDataURL(); link.click();
                    }
                    element.style.display = 'none'; hideLoader();
                });
            }).catch(() => { alert("Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ø¹Ú©Ø³"); element.style.display = 'none'; hideLoader(); });
        }, 800);
    }

    async function shareBackupFile() {
        showLoader("Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„...");
        if(document.getElementById('noteText')) appData.note.text = document.getElementById('noteText').value;
        
        setTimeout(async () => {
            const jsonStr = JSON.stringify(appData, null, 2);
            const fileName = `${appData.header || 'backup'}.json`;
            const file = new File([jsonStr], fileName, {type: "application/json"});
            const text = `ğŸ“… ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† (JSON)\nğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: ${appData.userName || 'Ù†Ø§Ù…Ø´Ø®Øµ'}`;
            
            if (navigator.canShare && navigator.canShare({ files:[file] })) {
                try { await navigator.share({ files:[file], title: 'Backup', text: text }); } 
                catch (error) { console.log("Share cancelled"); }
            } else {
                exportData(); 
            }
            hideLoader();
        }, 500);
    }

    function downloadAsImage() {
        showLoader("Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªØµÙˆÛŒØ± Ø¨Ø§Ú©ÛŒÙÛŒØª...");
        const element = document.getElementById('print-area');
        preparePrintDOM();
        element.style.display = 'block';
        element.style.position = 'absolute'; element.style.top = '0'; element.style.left = '-9999px';
        
        setTimeout(() => {
            html2canvas(element, { scale: 3, useCORS: true, backgroundColor: '#ffffff' }).then(canvas => {
                const link = document.createElement('a');
                link.download = `${appData.header || 'Plan'}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                element.style.display = 'none'; element.style.position = 'static'; hideLoader();
            });
        }, 800);
    }

    function toggleExtraVis(type, i) {
        if(type==='req') appData.reqs[i].s = !appData.reqs[i].s;
        else appData.chks[i].s = !appData.chks[i].s;
        saveData(); renderExtras();
    }

    function handleDrop(e, day, time) {
        e.preventDefault(); const tid=e.dataTransfer.getData('tid');
        const task=appData.tasks.find(t=>t.id==tid); if(!task)return;
        const sIdx=TIMELINE.indexOf(time);
        if(sIdx+task.duration >= TIMELINE.length) return alert("Ø²Ù…Ø§Ù† Ù†Ø§Ú©Ø§ÙÛŒ");
        const conf=appData.tasks.some(t=>{if(t.id==tid || t.day!==day)return false; const tS=TIMELINE.indexOf(t.startStr); return (sIdx<tS+t.duration && sIdx+task.duration>tS);});
        if(!conf) { task.day=day; task.startStr=time; saveData(); renderTable(); } else alert("ØªØ¯Ø§Ø®Ù„!");
    }

    function toggleSelectMode() {
        isSelect=!isSelect;
        const btn=document.getElementById('selectModeBtn'); const txt=document.getElementById('modeText');
        if(isSelect) {document.body.classList.add('selection-mode'); btn.classList.add('active'); txt.innerText="Ø­Ø§Ù„Øª Ø§Ù†ØªØ®Ø§Ø¨ ÙØ¹Ø§Ù„";}
        else {document.body.classList.remove('selection-mode'); btn.classList.remove('active'); txt.innerText="Ø­Ø§Ù„Øª Ø§Ø³Ú©Ø±ÙˆÙ„"; clearSel();}
    }
    function setupTouch() {
        const t=document.getElementById('plannerTable');
        const start=(e)=>{if(!isSelect)return; const c=e.target.closest('td.empty-cell'); if(!c)return; e.preventDefault(); isDrag=true; selStart={d:c.dataset.d, i:parseInt(c.dataset.i)}; selCurr={...selStart}; highlight();};
        const move=(e)=>{if(!isDrag)return; const el=document.elementFromPoint(e.clientX||e.touches[0].clientX, e.clientY||e.touches[0].clientY); if(!el)return; const c=el.closest('td.empty-cell'); if(c&&c.dataset.d===selStart.d){selCurr={d:selStart.d, i:parseInt(c.dataset.i)}; highlight();}};
        const end=()=>{if(!isDrag)return; isDrag=false; if(selStart&&selCurr){const s=Math.min(selStart.i,selCurr.i), dur=Math.max(selStart.i,selCurr.i)-s+1; openTaskModal(null,{d:selStart.d,s:TIMELINE[s],dur});} clearSel();};
        t.addEventListener('mousedown',start); t.addEventListener('touchstart',start,{passive:false});
        window.addEventListener('mousemove',move); window.addEventListener('touchmove',move,{passive:false});
        window.addEventListener('mouseup',end); window.addEventListener('touchend',end);
    }
    function highlight(){document.querySelectorAll('.selected-cell').forEach(e=>e.classList.remove('selected-cell')); if(!selStart||!selCurr)return; const s=Math.min(selStart.i,selCurr.i), e=Math.max(selStart.i,selCurr.i); for(let i=s;i<=e;i++) {const td=document.querySelector(`td.empty-cell[data-d="${selStart.d}"][data-i="${i}"]`); if(td)td.classList.add('selected-cell');}}
    function clearSel(){selStart=null; selCurr=null; document.querySelectorAll('.selected-cell').forEach(e=>e.classList.remove('selected-cell'));}

    function openTaskModal(task, fresh) {
        openModal('taskModal'); const del=document.getElementById('btnDeleteTask');
        const startEl = document.getElementById('inpStart');
        const endEl = document.getElementById('inpEnd');
        const copyBtn = document.getElementById('btnCopyTask');
        if(task) {
            currentEditingTask = task;
            document.getElementById('taskId').value=task.id; document.getElementById('taskDay').value=task.day;
            startEl.value=task.startStr;
            updateEndOptions();
            endEl.value = task.duration;
            document.getElementById('inpName').value=task.name;
            document.getElementById('customColor').value=task.color;
            del.style.display='block';
            copyBtn.style.display='block';
        } else {
            currentEditingTask = null;
            document.getElementById('taskId').value=''; document.getElementById('taskDay').value=fresh.d;
            startEl.value=fresh.s;
            updateEndOptions();
            endEl.value = fresh.dur;
            document.getElementById('inpName').value='';
            document.getElementById('customColor').value='#6366f1';
            del.style.display='none';
            copyBtn.style.display='none';
        }
    }
    function saveTask() {
        const id=document.getElementById('taskId').value, day=document.getElementById('taskDay').value;
        const name=document.getElementById('inpName').value.trim();
        const color=document.getElementById('customColor').value;
        const startVal = document.getElementById('inpStart').value;
        const durVal = parseInt(document.getElementById('inpEnd').value);
        if(!name) return alert("Ù†Ø§Ù… Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª");
        const sIdx = TIMELINE.indexOf(startVal);
        if(sIdx + durVal >= TIMELINE.length) return alert("Ø²Ù…Ø§Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±");
        const conf=appData.tasks.some(t=>{
            if(t.id==id||t.day!==day)return false; 
            const tS=TIMELINE.indexOf(t.startStr); 
            return (sIdx<tS+t.duration && sIdx+durVal>tS);
        });
        if(conf) return alert("ØªØ¯Ø§Ø®Ù„ Ø²Ù…Ø§Ù†ÛŒ");
        if(id){const ix=appData.tasks.findIndex(t=>t.id==id); if(ix!==-1) appData.tasks[ix]={...appData.tasks[ix],name,startStr:startVal,duration:durVal,color};}
        else appData.tasks.push({id:Date.now(),day,startStr:startVal,duration:durVal,name,color});
        saveData(); renderTable(); closeModal('taskModal');
    }
    function deleteTask(){const id=document.getElementById('taskId').value; if(confirm("Ø­Ø°ÙØŸ")){appData.tasks=appData.tasks.filter(t=>t.id!=id); saveData(); renderTable(); closeModal('taskModal');}}

    function switchTab(t){document.getElementById('tab-req').style.display=t==='req'?'block':'none'; document.getElementById('tab-chk').style.display=t==='chk'?'block':'none';}
    
    function renderExtras() {
        const rL=document.getElementById('reqListUi'); rL.innerHTML='';
        appData.reqs.forEach((r,i)=>{
            rL.innerHTML+=`
            <li class="extra-row">
                <div class="extra-content">ğŸ”¸ ${r.t}</div>
                <div class="extra-controls">
                    <button class="extra-btn" onclick="moveExtra('req', ${i}, -1)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"></polyline></svg></button>
                    <button class="extra-btn" onclick="moveExtra('req', ${i}, 1)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg></button>
                    <button class="extra-btn" onclick="editExtra('req', ${i})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                    <button class="extra-btn ${r.s?'active':''}" onclick="toggleExtraVis('req',${i})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></button>
                    <button class="extra-btn delete" onclick="delEx('req',${i})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                </div>
            </li>`;
        });
        const cL=document.getElementById('chkListUi'); cL.innerHTML='';
        appData.chks.forEach((c,i)=>{
            cL.innerHTML+=`
            <li class="extra-row">
                <div class="extra-content">
                    <div class="custom-chk ${c.c?'checked':''}" onclick="togChk(${i})">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    </div>
                    ${c.t}
                </div>
                <div class="extra-controls">
                    <button class="extra-btn" onclick="moveExtra('chk', ${i}, -1)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"></polyline></svg></button>
                    <button class="extra-btn" onclick="moveExtra('chk', ${i}, 1)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg></button>
                    <button class="extra-btn" onclick="editExtra('chk', ${i})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                    <button class="extra-btn ${c.s?'active':''}" onclick="toggleExtraVis('chk',${i})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></button>
                    <button class="extra-btn delete" onclick="delEx('chk',${i})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                </div>
            </li>`;
        });
    }

    function addItem(t){const i=document.getElementById(t+'Input'); if(i.value){if(t==='req')appData.reqs.push({t:i.value,s:true}); else appData.chks.push({t:i.value,s:true,c:false}); i.value=''; saveData(); renderExtras();}}
    function delEx(t,i){if(t==='req')appData.reqs.splice(i,1); else appData.chks.splice(i,1); saveData(); renderExtras();}
    function togChk(i){appData.chks[i].c=!appData.chks[i].c; saveData(); renderExtras();}
    function editExtra(type, i) {const arr = type === 'req' ? appData.reqs : appData.chks; const newVal = prompt("ÙˆÛŒØ±Ø§ÛŒØ´:", arr[i].t); if (newVal) { arr[i].t = newVal; saveData(); renderExtras(); }}
    function moveExtra(type, i, dir) {
        const arr = type === 'req' ? appData.reqs : appData.chks;
        if (dir === -1 && i > 0) { [arr[i], arr[i-1]] = [arr[i-1], arr[i]]; } 
        else if (dir === 1 && i < arr.length - 1) { [arr[i], arr[i+1]] = [arr[i+1], arr[i]]; }
        saveData(); renderExtras();
    }

    function saveNote(){
        appData.note.text=document.getElementById('noteText').value; 
        appData.note.print=document.getElementById('notePrintCheck').checked; 
        saveData(); closeModal('noteModal');
    }
    
    function openStats(){
        openModal('statsModal'); const a=document.getElementById('chartArea'), l=document.getElementById('chartLegend');
        a.innerHTML=''; l.innerHTML=''; const s={}; let tot=0;
        appData.tasks.forEach(t=>{s[t.color]=(s[t.color]||0)+t.duration; tot+=t.duration;});
        if(tot===0){a.innerHTML='Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù†ÛŒØ³Øª'; return;}
        let g=[], curr=0;
        Object.keys(s).forEach(c=>{const d=(s[c]/tot)*360; g.push(`${c} ${curr}deg ${curr+d}deg`); curr+=d; l.innerHTML+=`<div class="legend-item"><div style="width:10px;height:10px;border-radius:50%;background:${c}"></div> ${toFaDigits(((s[c]*15)/60).toFixed(1))}h</div>`;});
        const ch=document.createElement('div'); ch.style.width='150px'; ch.style.height='150px'; ch.style.borderRadius='50%'; ch.style.background=`conic-gradient(${g.join(', ')})`; a.appendChild(ch);
    }

    function openCopyModal(sourceId) {
        pendingCopySource = sourceId;
        const sourceDay = DAYS.find(d => d.id === sourceId);
        document.getElementById('copySourceLabel').innerText = sourceDay.l;
        const list = document.getElementById('copyTargetList');
        list.innerHTML = '';
        DAYS.filter(d => d.id !== sourceId).forEach(d => {
            list.innerHTML += `<label class="copy-item"><input type="checkbox" value="${d.id}" class="copy-checkbox">${d.l}</label>`;
        });
        openModal('copyModal');
    }

    function executeCopy() {
        const checkboxes = document.querySelectorAll('.copy-checkbox:checked');
        if(checkboxes.length === 0) { alert("Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø±ÙˆØ² Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯."); return; }
        const targetIds = Array.from(checkboxes).map(cb => cb.value);
        if(!confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`)) return;
        closeModal('copyModal'); showBar();
        setTimeout(() => {
            const sourceTasks = appData.tasks.filter(t => t.day === pendingCopySource);
            appData.tasks = appData.tasks.filter(t => !targetIds.includes(t.day));
            targetIds.forEach(targetId => {
                sourceTasks.forEach(t => { appData.tasks.push({ ...t, id: Date.now() + Math.random(), day: targetId }); });
            });
            saveData(); renderTable(); hideBar();
        }, 300);
    }

    function openSingleCopyModal() {
        if(!currentEditingTask) return;
        closeModal('taskModal');
        const list = document.getElementById('singleCopyTargetList'); list.innerHTML = '';
        DAYS.forEach(d => {
            if (d.id !== currentEditingTask.day) {
                list.innerHTML += `<label class="copy-item" onclick="executeSingleCopy('${d.id}')"><span style="flex:1">${d.l}</span><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></label>`;
            }
        });
        document.getElementById('singleCopyModal').style.display = 'flex';
    }

    function executeSingleCopy(targetDayId) {
        if(!currentEditingTask) return;
        const t = currentEditingTask;
        const sIdx = TIMELINE.indexOf(t.startStr);
        const conflict = appData.tasks.some(existing => {
            if (existing.day !== targetDayId) return false;
            const existStartIdx = TIMELINE.indexOf(existing.startStr);
            return (sIdx < existStartIdx + existing.duration && sIdx + t.duration > existStartIdx);
        });
        if (conflict) { alert(`Ø¯Ø± Ø±ÙˆØ² Ù…Ù‚ØµØ¯ ØªØ¯Ø§Ø®Ù„ Ø²Ù…Ø§Ù†ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯.`); return; }
        appData.tasks.push({ ...t, id: Date.now() + Math.random(), day: targetDayId });
        saveData(); renderTable(); closeModal('singleCopyModal'); showBar(); setTimeout(hideBar, 300);
    }

    function openModal(id){document.getElementById(id).style.display='flex'; if(id==='noteModal'){document.getElementById('noteText').value=appData.note.text; document.getElementById('notePrintCheck').checked=appData.note.print;}}
    function closeModal(id){document.getElementById(id).style.display='none';}
    function saveData(){localStorage.setItem('finalProPlannerV10', JSON.stringify(appData));}
    
    function updateHeader(v){
        appData.header=v; document.title = v || "Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ"; 
        document.getElementById('headerTitleInput').value = v;
        document.querySelector('.brand').innerHTML = `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>${v || "Ù¾Ù„Ù†Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯"}`;
        saveData();
    }
    function updateUserName(v){appData.userName=v; saveData();}
    function clearAll(){if(confirm("Ø­Ø°Ù Ú©Ø§Ù…Ù„ØŸ")){localStorage.removeItem('finalProPlannerV10'); location.reload();}}
    
    function exportData(){
        const b=new Blob([JSON.stringify(appData, null, 2)],{type:'application/json'}); 
        const a=document.createElement('a'); 
        a.href=URL.createObjectURL(b); 
        a.download=`${appData.header || 'plan'}.json`; 
        a.click();
    }
    
    function importData(i){const f=i.files[0]; const r=new FileReader(); r.onload=e=>{try{const d=JSON.parse(e.target.result); if(d.tasks||Array.isArray(d)){if(Array.isArray(d))appData.tasks=d; else appData=d; saveData(); location.reload();}}catch(x){alert("ÙØ§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø±");}}; if(f)r.readAsText(f);}

    function printApp() {
        const fileName = prompt("Ù†Ø§Ù… ÙØ§ÛŒÙ„ Ø®Ø±ÙˆØ¬ÛŒ:", appData.header || "Ø¨Ø±Ù†Ø§Ù…Ù‡");
        if(fileName === null) return;
        const originalTitle = document.title;
        document.title = fileName;
        preparePrintDOM();
        const element = document.getElementById('print-area');
        element.style.display = 'block';
        setTimeout(() => {
            window.print();
            element.style.display = 'none';
            document.title = originalTitle;
        }, 100);
    }

    init();
</script>
</body>
</html>
