<script>
    // دستور چهارم: به‌روزرسانی ثابت‌ها
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyhU2ha6ypcNg2_bFeiiu6WFgHvqrb9zWcfkuxPxVq2alBY7-zkbMNXJPwdN4gcoxCb3Q/exec';
    const PANEL_URLS = { researcher: '#', professor: '#', admin: '#' };
    const JOURNAL_NAME = "نشریه تعالی نوجوان";

    let allIssues = [];
    let allArticles = [];
    let visibleIssuesCount = 5;

    document.addEventListener('DOMContentLoaded', () => {
        loadPublicationData();
        // NOTE: The following line was intentionally removed to allow the links in the HTML to work correctly as per your request.
        // Object.keys(PANEL_URLS).forEach(key => { document.getElementById(`${key}-link`).href = PANEL_URLS[key]; });
        
        const loginMenuBtn = document.getElementById('login-menu-btn');
        const loginDropdownMenu = document.getElementById('login-dropdown-menu');
        
        const filterBtn = document.getElementById('search-filter-btn');
        const filterDropdown = document.getElementById('search-filter-dropdown');
        
        loginMenuBtn.addEventListener('click', e => { 
            e.stopPropagation(); 
            loginDropdownMenu.classList.toggle('visible'); 
        });

        filterBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            filterDropdown.classList.toggle('visible');
            filterBtn.classList.toggle('active');
        });

        document.addEventListener('click', (e) => {
            if (!loginMenuBtn.contains(e.target) && !loginDropdownMenu.contains(e.target)) {
                loginDropdownMenu.classList.remove('visible');
            }
            if (!filterBtn.contains(e.target) && !filterDropdown.contains(e.target)) {
                filterDropdown.classList.remove('visible');
                filterBtn.classList.remove('active');
            }
        });

        document.getElementById('search-button').addEventListener('click', triggerSearch);
        document.getElementById('search-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') triggerSearch(); });
    });

    async function callApi(action, params = {}) {
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action, params }) });
            if (!response.ok) throw new Error('خطا در ارتباط با سرور. لطفاً اتصال اینترنت خود را بررسی کنید.');
            const data = await response.json();
            if (data.status === 'error') throw new Error(data.message);
            return data;
        } catch (error) {
            document.getElementById('issues-container').innerHTML = `<div class="card" style="text-align:center;"><p><strong>خطا:</strong> ${error.message}</p></div>`;
            return null;
        }
    }

    async function loadPublicationData() {
        const response = await callApi('getPublicationData');
        const loadingOverlay = document.getElementById('loading-overlay');
        if (response?.status === 'success') {
            allIssues = response.data.issues.sort((a, b) => b.issueNumber - a.issueNumber);
            allArticles = response.data.allArticles;
            const articlesByIssue = groupArticlesByIssue(allArticles);
            renderIssues(allIssues, articlesByIssue);
        }
        loadingOverlay.style.opacity = '0';
        setTimeout(() => {
            loadingOverlay.style.display = 'none';
            document.getElementById('page-wrapper').style.opacity = '1';
        }, 500);
    }
    
    function groupArticlesByIssue(articles) {
        return articles.reduce((acc, article) => {
            (acc[article.issueNumber] = acc[article.issueNumber] || []).push(article);
            return acc;
        }, {});
    }

    function renderIssues(issues, articlesByIssue) {
        const container = document.getElementById('issues-container');
        const issuesToRender = issues.slice(0, visibleIssuesCount);
        container.innerHTML = issuesToRender.map((issue, index) => {
            const articles = articlesByIssue[issue.issueNumber] || [];
            if (articles.length === 0) return '';
            return `
                <details class="issue-accordion" ${index === 0 ? 'open' : ''}>
                    <summary class="issue-header">
                        <div class="issue-title">
                            <h3>شماره ${issue.issueNumber}</h3>
                            <span>تاریخ نشر: ${formatDate(issue.publishDate)}</span>
                        </div>
                        <div class="issue-actions"><button class="btn btn-secondary" onclick="downloadIssuePDF(event, '${issue.issueNumber}')"><span class="btn-text"><i class="fas fa-book"></i> دانلود کل شماره</span></button></div>
                    </summary>
                    <div class="article-list">
                        ${articles.map(article => `
                            <article class="article-card">
                                <h4 class="article-title" onclick="showArticleModal('${article.articleId}')">${article.title}</h4>
                                <p class="article-meta"><strong>نویسنده:</strong> ${article.researcherName || 'نامشخص'} | <strong>استاد راهنما:</strong> ${article.supervisorName || 'نامشخص'}</p>
                            </article>`).join('')}
                    </div>
                </details>`;
        }).join('') || `<div class="card" style="text-align:center;"><p>هیچ مقاله‌ای مطابق با جستجوی شما یافت نشد.</p></div>`;

        const loadMoreContainer = document.getElementById('load-more-container');
        if (visibleIssuesCount < issues.length) {
            loadMoreContainer.innerHTML = `<button id="load-more-btn" class="btn btn-secondary">نمایش شماره‌های قدیمی‌تر</button>`;
            document.getElementById('load-more-btn').onclick = () => { visibleIssuesCount += 5; renderIssues(issues, articlesByIssue); };
        } else {
            loadMoreContainer.innerHTML = '';
        }
    }
    
    async function triggerSearch() {
        const searchButton = document.getElementById('search-button');
        searchButton.classList.add('btn-loading');

        const searchTerm = document.getElementById('search-input').value.trim();
        const categories = Array.from(document.querySelectorAll('input[name="search-category"]:checked')).map(cb => cb.value);
        
        let articlesToDisplay;

        if (!searchTerm) {
            articlesToDisplay = allArticles;
        } else {
            const response = await callApi('searchArticles', { searchTerm, categories });
            articlesToDisplay = response?.status === 'success' ? response.data.articles : [];
        }
        
        const articlesByIssue = groupArticlesByIssue(articlesToDisplay);
        const relevantIssues = allIssues.filter(issue => articlesByIssue[issue.issueNumber] && articlesByIssue[issue.issueNumber].length > 0);
        
        visibleIssuesCount = 5;
        renderIssues(searchTerm ? relevantIssues : allIssues, articlesByIssue);

        searchButton.classList.remove('btn-loading');
    }

    // دستور چهارم: به‌روزرسانی و تکمیل محتوای مودال "درباره ما"
    function showAboutModal(event) {
        event.preventDefault();
        showModal(
            `<div class="modal-header"><h2>درباره نشریه تعالی نوجوان</h2><button class="modal-close-button" onclick="closeModal()">&times;</button></div>
             <div class="modal-body">
                <p><strong>نشریه تعالی نوجوان</strong>، وابسته به <strong>مؤسسه تعالی اندیشه و رشد</strong>، یک نشریه تخصصی با هدف ایجاد بستری مناسب برای رشد و شکوفایی استعدادهای علمی و پژوهشی نوجوانان و جوانان در حوزه‌های علوم انسانی و اسلامی است. این نشریه تلاش دارد تا با انتشار مقالات و دستاوردهای پژوهشی این عزیزان، فرهنگ تحقیق و نوآوری را در جامعه ترویج دهد.</p>
                <h4>اهداف و چشم‌انداز:</h4>
                <ul>
                    <li>شناسایی و حمایت از استعدادهای برتر در زمینه‌های علمی و پژوهشی.</li>
                    <li>ایجاد انگیزه و علاقه به تحقیق و پژوهش در میان نسل جوان.</li>
                    <li>انتشار آثار علمی-پژوهشی استاندارد و کمک به ارتقای سطح علمی جامعه.</li>
                    <li>فراهم آوردن زمینه‌ای برای تبادل نظر و هم‌اندیشی میان پژوهشگران جوان و اساتید مجرب.</li>
                    <li>تبدیل شدن به یک مرجع معتبر برای پژوهش‌های نوجوانان در سطح کشور.</li>
                </ul>
                <p>ما باور داریم که با سرمایه‌گذاری بر روی توانمندی‌های نسل جدید، می‌توانیم آینده‌ای روشن‌تر برای جامعه علمی کشور رقم بزنیم.</p>
             </div>`
        );
    }

    function showIssuesModal(event) {
        event.preventDefault();
        let content = `<div class="modal-header"><h2>آرشیو شماره‌ها</h2><button class="modal-close-button" onclick="closeModal()">&times;</button></div><div class="modal-body">`;
        if (allIssues.length > 0) {
            content += `<table style="width:100%; border-collapse: collapse; text-align: right;"><thead><tr style="background-color: var(--bg-main);"><th style="padding:12px; border:1px solid #ddd;">شماره</th><th style="padding:12px; border:1px solid #ddd;">تاریخ انتشار</th><th style="padding:12px; border:1px solid #ddd;">دانلود کامل</th></tr></thead><tbody>`;
            allIssues.forEach(issue => {
                content += `<tr><td style="padding:10px; border:1px solid #ddd;">${issue.issueNumber}</td><td style="padding:10px; border:1px solid #ddd;">${formatDate(issue.publishDate)}</td>
                <td style="text-align:center; padding:10px; border:1px solid #ddd;"><button class="btn btn-secondary" style="padding: 5px 12px;" onclick="downloadIssuePDF(event, '${issue.issueNumber}')">PDF <i class="fa fa-download"></i></button></td></tr>`;
            });
            content += `</tbody></table>`;
        } else { content += `<p>شماره‌ای برای نمایش وجود ندارد.</p>`; }
        showModal(content + `</div>`);
    }
    
    function showArticleModal(articleId) {
        const articlePool = allArticles;
        const d = articlePool.find(a => String(a.articleId) === String(articleId));
        if (d) {
            const modalHtml = `
                <div class="modal-header">
                    <h2>${d.title || 'بدون عنوان'}</h2>
                    <button class="modal-close-button" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body-meta">
                    <p><strong>نویسنده:</strong> ${d.researcherName || 'نامشخص'}</p>
                    <p><strong>وابستگی سازمانی:</strong> ${d.researcherAffiliation || 'ثبت نشده'}</p>
                    <p><strong>استاد راهنما:</strong> ${d.supervisorName || 'نامشخص'}</p>
                    <p><strong>تاریخ پذیرش:</strong> ${formatDate(d.acceptanceDate) || 'ثبت نشده'} | <strong>تاریخ نشر:</strong> ${formatDate(d.publishDate) || 'ثبت نشده'}</p>
                </div>
                <div class="modal-body">
                    <h4>چکیده</h4>
                    <p>${d.abstract || 'موجود نیست'}</p>
                    <p><strong>کلیدواژه‌ها:</strong> ${d.keywords || 'موجود نیست'}</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="showFullArticleContent('${articleId}')"><span class="btn-text">مشاهده متن کامل مقاله</span></button>
                    <button class="btn btn-accent" onclick="handleDownloadPDF(this, '${d.articleId}')"><span class="btn-text">دانلود فایل PDF</span></button>
                </div>`;
            showModal(modalHtml);
        } else {
            showToast('خطا: اطلاعات مقاله یافت نشد.');
        }
    }
    
    function showFullArticleContent(articleId) {
        const d = allArticles.find(a => String(a.articleId) === String(articleId));
        if (d) {
             const fullContentHtml = `
                <div class="modal-header">
                    <h2>${d.title || 'بدون عنوان'}</h2>
                    <button class="modal-close-button" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body" style="font-size: 1.05rem; line-height: 2.1;">
                    <h4>مقدمه</h4>
                    <div style="white-space: pre-wrap;">${d.introduction || 'موجود نیست'}</div><hr style="margin: 20px 0;">
                    <h4>متن اصلی</h4>
                    <div style="white-space: pre-wrap;">${d.body || 'موجود نیست'}</div><hr style="margin: 20px 0;">
                    <h4>نتیجه‌گیری</h4>
                    <div style="white-space: pre-wrap;">${d.conclusion || 'موجود نیست'}</div><hr style="margin: 20px 0;">
                    <h4>منابع</h4>
                    <div style="white-space: pre-wrap;">${d.references || 'موجود نیست'}</div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-accent" onclick="handleDownloadPDF(this, '${d.articleId}')"><span class="btn-text">دانلود فایل PDF</span></button>
                </div>`;
            updateModal(fullContentHtml);
        }
    }
    
    async function downloadIssuePDF(event, issueNumber) {
        event.stopPropagation();
        const button = event.target.closest('button');
        if (button) button.classList.add('btn-loading');
        showToast('در حال آماده‌سازی فایل PDF کل شماره...');

        try {
            const response = await callApi('generatePdfForIssue', { issueNumber: issueNumber });
            if (response && response.status === 'success') {
                downloadBase64File(response.data);
            } else {
                showToast('خطا در تولید PDF: ' + (response ? response.message : 'پاسخی از سرور دریافت نشد.'));
            }
        } catch (error) {
            console.error("Issue PDF Download Error:", error);
            showToast('یک خطای غیرمنتظره هنگام دانلود رخ داد.');
        } finally {
            if (button) button.classList.remove('btn-loading');
            setTimeout(hideToast, 3000);
        }
    }

    async function handleDownloadPDF(button, articleId) {
        if (button) button.classList.add('btn-loading');
        showToast('در حال آماده‌سازی فایل PDF مقاله...');

        try {
            const response = await callApi('generatePdfFromArticle', { articleId: articleId });
            if (response && response.status === 'success') {
                downloadBase64File(response.data);
            } else {
                showToast('خطا در تولید PDF: ' + (response ? response.message : 'پاسخی از سرور دریافت نشد.'));
            }
        } catch (error) {
            console.error("PDF Download Error:", error);
            showToast('یک خطای غیرمنتظره هنگام دانلود رخ داد.');
        } finally {
            if (button) button.classList.remove('btn-loading');
            setTimeout(hideToast, 3000);
        }
    }
    
    function downloadBase64File({ filename, mimeType, content }) {
        const byteCharacters = atob(content);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: mimeType });

        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function showModal(content) {
        document.getElementById('modal-container').innerHTML = `<div class="modal-overlay visible" id="main-modal" onclick="if(event.target.id === 'main-modal') closeModal()"><div class="modal-content">${content}</div></div>`;
        document.body.classList.add('modal-open');
    }
    function updateModal(content) {
        const modal = document.querySelector('#main-modal .modal-content');
        if (modal) modal.innerHTML = content;
    }
    function closeModal() {
        const modal = document.getElementById('main-modal');
        if (modal) {
            modal.classList.remove('visible');
            setTimeout(() => {
                modal.remove();
                document.body.classList.remove('modal-open');
            }, 300);
        }
    }
    function formatDate(dateString) {
        if (!dateString) return 'نامشخص';
        try {
            return new Date(dateString).toLocaleDateString('fa-IR', { year: 'numeric', month: 'long', day: 'numeric' });
        } catch(e) {
            return 'نامشخص';
        }
    }
    
    let toastTimeout;
    function showToast(message) {
        const toast = document.getElementById('toast-notification');
        toast.textContent = message;
        toast.classList.add('show');
        clearTimeout(toastTimeout);
    }
    function hideToast() {
        const toast = document.getElementById('toast-notification');
        toast.classList.remove('show');
    }

</script>

</body>
</html>
