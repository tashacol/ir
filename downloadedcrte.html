<!DOCTYPE html> 
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دریافت گواهی دوره جامع تربیت نوجوان</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- افزودن اسکریپت Google reCAPTCHA -->
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <style> 
        :root {
            --font-main: 'Vazirmatn', sans-serif;
            --primary-color: #0c4a6e;
            --secondary-color: #075985;
            --accent-color: #38bdf8;
            --light-bg: #f8fafc;
            --container-bg: #ffffff;
            --dark-text: #1e293b;
            --light-text: #64748b;
            --border-color: #e2e8f0;
            --danger-color: #dc2626;
            --success-color: #16a34a;
            --info-color: #00BCD4;
            --warning-color: #f59e0b;
            --shadow: 0 4px 25px rgba(0,0,0,0.08);
            --radius-lg: 16px;
            --radius-md: 12px;
            --transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-main);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            background-image: url('https://tashacol.ir/123.jpg');
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: var(--dark-text);
        }
        .container {
            background-color: var(--container-bg);
            padding: 40px;
            border-radius: var(--radius-lg);
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05), 0 10px 10px -5px rgba(0,0,0,0.04);
            width: 100%;
            max-width: 420px;
            text-align: center;
            box-sizing: border-box;
        }
        .logo-container { margin-bottom: 1.5rem; }
        .logo-container .fa-award { font-size: 3rem; color: var(--primary-color); }
        h2 { font-size: 1.8rem; margin-top: 0; margin-bottom: 2rem; color: var(--primary-color); font-weight: 700; }
        .form-group { margin-bottom: 1.5rem; text-align: right; position: relative; }
        label { display: block; margin-bottom: 0.5rem; color: var(--light-text); font-weight: 500; }
        .input-wrapper { position: relative; margin-bottom: 20px; }
        .input-icon { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); color: var(--light-text); }
        .form-input { width: 100%; text-align: center; padding: 12px 15px; border: 1px solid #a8b3c2; border-radius: var(--radius-md); font-size: 1rem; font-family: var(--font-main); outline: none; transition: var(--transition); }
        .form-input:focus { border-color: var(--secondary-color); box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.3); }
        .btn { position:relative; background-color: var(--secondary-color); color: white; padding: 12px 30px; border: none; border-radius: var(--radius-md); cursor: pointer; font-size: 1rem; font-family: var(--font-main); transition: all 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; width: 100%; }
        .btn:hover:not(:disabled) { background-color: var(--primary-color); transform: translateY(-2px); }
        .btn:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .loader { width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #message-area { margin-top: 1.5rem; padding: 1rem; border-radius: 12px; font-weight: 500; display: none; word-wrap: break-word; }
        .message-success { background-color: #E8F5E9; color: #1B5E20; border: 1px solid #A5D6A7; }
        .message-error { background-color: #FFEBEE; color: #C62828; border: 1px solid #EF9A9A; }
        .message-info { background-color: #E1F5FE; color: #01579B; border: 1px solid #81D4FA; }
        #actions-area, #confirmation-area { margin-top: 1.5rem; display: none; flex-direction: column; gap: 0.75rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="logo-container">
        <i class="fas fa-award"></i>
    </div>

    <div id="form-container">
        <h2>گواهی تربیت نوجوان</h2>
        <form id="certificate-form">
            <div class="form-group">
                <label for="nationalId">کد ملی</label>
                <div class="input-wrapper">
                     <i class="fas fa-id-card input-icon"></i>
                     <input type="text" id="nationalId" class="form-input" inputmode="numeric" pattern="[0-9]*" required autocomplete="off" placeholder="کد ملی خود را وارد کنید">
                </div>
            </div>
             <!-- دکمه ارسال که reCAPTCHA به آن متصل می‌شود -->
            <button type="submit" id="btn-submit" class="btn">
                <span id="button-text">بررسی وجود گواهی</span>
                <div class="loader" id="loader-submit"></div>
            </button>
        </form>
    </div>

    <div id="message-area"></div>

    <div id="confirmation-area">
         <p id="confirmation-message" style="margin-bottom: 1rem;"></p>
         <button id="btn-confirm-fetch" class="btn" style="background-color: var(--success-color);">
            <span id="confirm-button-text">بله، گواهی را دریافت کن</span>
            <div class="loader" id="loader-confirm"></div>
        </button>
    </div>

    <div id="actions-area">
        <button id="btn-download" class="btn"><i class="fas fa-download"></i> دانلود</button>
        <button id="btn-view" class="btn" style="background-color: var(--success-color);"><i class="fas fa-eye"></i> مشاهده</button>
        <button id="btn-share" class="btn" style="background-color: var(--info-color);"><i class="fas fa-share-alt"></i> اشتراک گذاری</button>
    </div>
</div>

<!-- عنصر reCAPTCHA نامرئی -->
<div id="recaptcha-container"></div>


<script>
    // آدرس وب اپلیکیشن شما در Google Apps Script
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxVlFUJ90SyDxwJshRQ1MQMM06DKb10bj6I_sJmMtNQCyj2_SfLekocmAeTzmL0p-LGxg/exec";
    // کلید سایت (Site Key) مربوط به Google reCAPTCHA
    const RECAPTCHA_SITE_KEY = "6Lc1vqkrAAAAAHLHbzPMzlREvKwgHDNSmakrB-aq";
    
    // متغیرهایی برای نگهداری اطلاعات فایل و توکن امن
    let fileToProcess = null;
    let secureToken = null; // برای نگهداری توکن JWT دریافتی از سرور

    // دریافت عناصر DOM
    const formContainer = document.getElementById('form-container');
    const certificateForm = document.getElementById('certificate-form');
    const nationalIdInput = document.getElementById('nationalId');
    const submitButton = document.getElementById('btn-submit');
    const buttonText = document.getElementById('button-text');
    const loaderSubmit = document.getElementById('loader-submit');
    const messageArea = document.getElementById('message-area');
    
    const confirmationArea = document.getElementById('confirmation-area');
    const confirmationMessage = document.getElementById('confirmation-message');
    const confirmFetchBtn = document.getElementById('btn-confirm-fetch');
    const confirmButtonText = document.getElementById('confirm-button-text');
    const loaderConfirm = document.getElementById('loader-confirm');
    
    const actionsArea = document.getElementById('actions-area');
    const downloadBtn = document.getElementById('btn-download');
    const viewBtn = document.getElementById('btn-view');
    const shareBtn = document.getElementById('btn-share');

    /**
     * تابع عمومی برای ارسال درخواست به API سمت سرور
     */
    async function apiCall(body) {
        try {
            const response = await fetch(SCRIPT_URL, { 
                method: 'POST', 
                mode: 'cors', 
                // برای جلوگیری از مشکلات CORS، هدر زیر را حذف می‌کنیم
                // headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body) 
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return await response.json();
        } catch (error) {
            console.error("API Call failed:", error);
            showMessage('خطا در ارتباط با سرور. لطفاً اتصال اینترنت خود را بررسی کنید و دوباره تلاش نمایید.', 'error');
            return null; // بازگرداندن null در صورت خطا
        }
    }
    
    /**
     * نمایش پیام به کاربر
     */
    function showMessage(message, type) {
        messageArea.textContent = message;
        messageArea.className = `message-${type}`;
        messageArea.style.display = 'block';
    }

    /**
     * مدیریت وضعیت لودینگ دکمه ارسال فرم
     */
    function setSubmitLoadingState(isLoading) {
        submitButton.disabled = isLoading;
        buttonText.style.display = isLoading ? 'none' : 'inline';
        loaderSubmit.style.display = isLoading ? 'inline-block' : 'none';
    }

    /**
     * مدیریت وضعیت لودینگ دکمه تایید دریافت فایل
     */
    function setConfirmLoadingState(isLoading) {
        confirmFetchBtn.disabled = isLoading;
        confirmButtonText.style.display = isLoading ? 'none' : 'inline';
        loaderConfirm.style.display = isLoading ? 'inline-block' : 'none';
    }

    /**
     * تابع callback که پس از موفقیت‌آمیز بودن reCAPTCHA اجرا می‌شود
     * این تابع توکن reCAPTCHA را به سرور برای اعتبارسنجی ارسال می‌کند
     */
    async function onRecaptchaSuccess(recaptchaToken) {
        setSubmitLoadingState(true);
        messageArea.style.display = 'none';

        const formData = {
            action: 'checkExistence',
            nationalId: nationalIdInput.value,
            recaptchaToken: recaptchaToken // ارسال توکن reCAPTCHA
        };
        
        const response = await apiCall(formData);
        
        if (response && response.status === 'exists') {
            secureToken = response.token; // ذخیره توکن امن دریافتی از سرور
            formContainer.style.display = 'none';
            messageArea.style.display = 'none';
            confirmationMessage.textContent = response.message;
            confirmationArea.style.display = 'flex';
        } else if(response) {
            showMessage(response.message || 'پاسخ نامعتبر از سرور دریافت شد.', 'error');
        }
        
        setSubmitLoadingState(false);
        // ریست کردن reCAPTCHA برای تلاش بعدی
        grecaptcha.reset(recaptchaWidgetId);
    }
    
    /**
     * رویداد ارسال فرم اصلی
     */
    certificateForm.addEventListener('submit', function(event) {
        event.preventDefault();
        // اجرای reCAPTCHA به صورت برنامه‌نویسی
        grecaptcha.execute(recaptchaWidgetId);
    });

    /**
     * مرحله 2: دریافت فایل گواهی پس از تایید کاربر با استفاده از توکن امن
     */
    confirmFetchBtn.addEventListener('click', async () => {
        setConfirmLoadingState(true);
        confirmationArea.style.display = 'none';
        showMessage('گواهی در حال دریافت است، لطفاً منتظر بمانید...', 'info');

        const formData = {
            action: 'getFile',
            token: secureToken // ارسال توکن امن به جای کد ملی
        };

        const response = await apiCall(formData);

        if (response && response.status === 'success') {
            showMessage('گواهی شما با موفقیت یافت شد. می‌توانید فایل خود را دانلود، مشاهده یا اشتراک‌گذاری کنید.', 'success');
            actionsArea.style.display = 'flex';
            
            fileToProcess = {
                name: response.fileName,
                type: response.mimeType,
                data: response.data
            };
        } else {
            showMessage(response.message || 'خطا در دریافت فایل.', 'error');
            // در صورت خطا، کاربر را به فرم اصلی برمی‌گردانیم
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        }
        
        setConfirmLoadingState(false);
    });
    
    // --- توابع مربوط به عملیات روی فایل (دانلود، مشاهده، اشتراک‌گذاری) ---

    function b64toBlob(b64Data, contentType = '', sliceSize = 512) {
        const byteCharacters = atob(b64Data);
        const byteArrays = [];
        for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
            const slice = byteCharacters.slice(offset, offset + sliceSize);
            const byteNumbers = new Array(slice.length);
            for (let i = 0; i < slice.length; i++) { byteNumbers[i] = slice.charCodeAt(i); }
            byteArrays.push(new Uint8Array(byteNumbers));
        }
        return new Blob(byteArrays, { type: contentType });
    }

    function triggerDownload() {
        if (!fileToProcess) return;
        const link = document.createElement('a');
        const blob = b64toBlob(fileToProcess.data, fileToProcess.type);
        link.href = URL.createObjectURL(blob);
        link.download = fileToProcess.name;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    downloadBtn.addEventListener('click', triggerDownload);

    viewBtn.addEventListener('click', () => {
        if (fileToProcess) {
            const blob = b64toBlob(fileToProcess.data, fileToProcess.type);
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        }
    });

    shareBtn.addEventListener('click', async () => {
        if (!fileToProcess || !navigator.share) return;
        try {
            const blob = b64toBlob(fileToProcess.data, fileToProcess.type);
            const file = new File([blob], fileToProcess.name, { type: fileToProcess.type });
            await navigator.share({
                title: 'گواهینامه دوره آموزشی',
                text: 'گواهی نامه دوره آموزشی شما.',
                files: [file]
            });
        } catch (err) {
            console.error('Error sharing file:', err);
            showMessage('خطا در هنگام اشتراک گذاری فایل.', 'error');
        }
    });
    
    // --- آماده‌سازی reCAPTCHA پس از بارگذاری کامل صفحه ---
    let recaptchaWidgetId;
    var onloadCallback = function() {
        recaptchaWidgetId = grecaptcha.render('recaptcha-container', {
            'sitekey': RECAPTCHA_SITE_KEY,
            'callback': onRecaptchaSuccess, // تابع callback برای موفقیت
            'size': 'invisible' // استفاده از نوع نامرئی
        });
    };
    
    // فراخوانی تابع آماده‌سازی reCAPTCHA
    window.onload = onloadCallback;

    document.addEventListener('DOMContentLoaded', () => {
        if (typeof navigator.share === "undefined") {
            shareBtn.style.display = 'none';
        }
    });

</script>

</body>
</html>
