<!DOCTYPE html>
<html lang="fa" dir="rtl"> 
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دریافت گواهی دیجیتال</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        
        :root {
            --font-main: 'Vazirmatn', sans-serif;
            --primary-color: #0c4a6e; 
            --secondary-color: #075985; 
            --accent-color: #38bdf8;
            --container-bg: #ffffff; 
            --dark-text: #1e293b; 
            --light-text: #64748b;
            --border-color: #e2e8f0; 
            --danger-color: #dc2626; 
            --success-color: #16a34a; 
            --info-color: #00BCD4;
            --radius-lg: 16px; 
            --radius-md: 12px;
            --transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --captcha-bg: #E8F5E9;
            --captcha-text: #2E7D32;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; padding: 1rem;
            background-image: url('https://tashacol.ir/123.jpg');
            background-size: cover; background-position: center;
            background-attachment: fixed; color: var(--dark-text);
        }
        
        .container {
            background-color: var(--container-bg); padding: 40px;
            border-radius: var(--radius-lg);
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05), 0 10px 10px -5px rgba(0,0,0,0.04);
            width: 100%; max-width: 420px; text-align: center;
        }
        
        .logo-container { margin-bottom: 1.5rem; }
        .logo-container .fa-award { font-size: 3rem; color: var(--primary-color); }

        h2 { font-size: 1.8rem; margin-bottom: 2rem; color: var(--primary-color); font-weight: 700; }
        .form-group { margin-bottom: 1.5rem; text-align: right; }
        label { display: block; margin-bottom: 0.5rem; color: var(--light-text); font-weight: 500; }
        
        .input-wrapper { position: relative; }
        .input-icon { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); color: var(--light-text); }
        .form-input {
            width: 100%; text-align: center; padding: 12px 15px; border: 1px solid #a8b3c2;
            border-radius: var(--radius-md); font-size: 1rem; font-family: var(--font-main);
            outline: none; transition: var(--transition);
        }
        .form-input:focus { border-color: var(--secondary-color); box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.3); }
        
        .captcha-label {
            font-size: 1.2rem; font-weight: bold; color: var(--captcha-text);
            display: flex; align-items: center; justify-content: center;
            gap: 0.5rem; margin-bottom: 0.75rem; padding: 12px;
            background-color: var(--captcha-bg); border-radius: var(--radius-md);
        }
        
        .btn { 
            background-color: var(--secondary-color); color: white; padding: 12px 30px; 
            border: none; border-radius: var(--radius-md); cursor: pointer; font-size: 1rem; 
            font-family: var(--font-main); transition: all 0.3s; display: inline-flex; 
            align-items: center; justify-content: center; gap: 8px; text-decoration: none; width: 100%;
        }
        .btn:hover:not(:disabled) { background-color: var(--primary-color); transform: translateY(-2px); }
        .btn:disabled { background-color: #94a3b8; cursor: not-allowed; }
        
        .loader { width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #message-area { margin-top: 1.5rem; padding: 1rem; border-radius: 12px; font-weight: 500; display: none; word-wrap: break-word; }
        .message-success { background-color: #E8F5E9; color: #1B5E20; border: 1px solid #A5D6A7;}
        .message-error { background-color: #FFEBEE; color: #C62828; border: 1px solid #EF9A9A;}
        
        #actions-area { margin-top: 1.5rem; display: none; flex-direction: column; gap: 0.75rem; }

        /* <<<< استایل‌های جدید برای مودال و لودر تمام صفحه >>>> */
        #main-loader-container { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(8px); z-index: 20; display: none; flex-direction: column; justify-content: center; align-items: center; color: white;}
        #main-loader-container .loader { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--accent-color); }
        #main-loader-container p { margin-top: 1rem; font-size: 1.2rem; font-weight: 700; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; z-index: 30; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 2rem; border-radius: var(--radius-lg); width: 90%; max-width: 400px; text-align: center; box-shadow: 0 5px 25px rgba(0,0,0,0.2); }
        .modal-content p { font-size: 1.1rem; line-height: 1.8; margin-bottom: 2rem; }
        .modal-buttons { display: flex; gap: 1rem; }
        .modal-button { flex-grow: 1; padding: 12px; border-radius: var(--radius-md); border: none; font-family: var(--font-main); font-size: 1rem; font-weight: 700; cursor: pointer; transition: transform 0.2s; }
        .modal-button:hover { transform: translateY(-2px); }
        #btn-confirm-download { background-color: var(--success-color); color: white; }
        #btn-cancel-download { background-color: #f1f5f9; color: var(--dark-text); }
    </style>
</head>
<body>

    <div class="container">
        <!-- <<<< المان‌های جدید برای مودال و لودر >>>> -->
        <div id="main-loader-container">
            <div class="loader"></div>
            <p id="loader-text">لطفاً صبر کنید...</p>
        </div>
        <div class="modal-overlay" id="confirm-modal">
            <div class="modal-content">
                <p id="modal-message"></p>
                <div class="modal-buttons">
                    <button id="btn-cancel-download" class="modal-button">انصراف</button>
                    <button id="btn-confirm-download" class="modal-button">بله، بارگیری شود</button>
                </div>
            </div>
        </div>

        <div id="form-container">
            <div class="logo-container"> <i class="fas fa-award"></i> </div>
            <h2>دریافت گواهی دیجیتال</h2>
            <form id="certificate-form">
                <div class="form-group">
                    <label for="nationalId">کد ملی</label>
                    <div class="input-wrapper">
                         <i class="fas fa-id-card input-icon"></i>
                         <input type="text" id="nationalId" class="form-input" inputmode="numeric" pattern="\d{10}" title="کد ملی باید ۱۰ رقم باشد" required autocomplete="off" placeholder="کد ملی خود را وارد کنید">
                    </div>
                </div>
                <div class="form-group">
                    <label class="captcha-label" for="captcha-answer" id="captcha-question">
                        <i class="fas fa-shield-halved"></i>
                        <span>درحال دریافت سوال امنیتی...</span>
                    </label>
                    <div class="input-wrapper">
                        <i class="fas fa-calculator input-icon"></i>
                        <input type="number" id="captcha-answer" class="form-input" required placeholder="پاسخ را اینجا وارد کنید" autocomplete="off">
                    </div>
                </div>
                <button type="submit" id="btn-submit" class="btn">
                    <span id="button-text">بررسی</span>
                    <div class="loader"></div>
                </button>
            </form>
        </div>
        <div id="message-area"></div>
        <div id="actions-area">
            <button id="btn-download" class="btn"><i class="fas fa-download"></i> دانلود</button>
            <button id="btn-view" class="btn" style="background-color: var(--success-color);"><i class="fas fa-eye"></i> مشاهده</button>
            <button id="btn-share" class="btn" style="background-color: var(--info-color);"><i class="fas fa-share-alt"></i> اشتراک گذاری</button>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzW24IsCte0hvUcfh07y3uzweq0XNnG_Xe1EhS0Kh-2sIEotu6GRf5BXQs_pRav0FBeNw/exec"; // <<<< آدرس اسکریپت خود را اینجا قرار دهید
        
        // <<<< متغیرهای جدید برای مدیریت وضعیت دو مرحله‌ای >>>>
        let fileInfo = null;
        let fileBlob = null;
        let questionId = null;

        const formContainer = document.getElementById('form-container');
        const certificateForm = document.getElementById('certificate-form');
        const submitButton = document.getElementById('btn-submit');
        const buttonText = document.getElementById('button-text');
        const loader = submitButton.querySelector('.loader');
        const messageArea = document.getElementById('message-area');
        const captchaAnswerInput = document.getElementById('captcha-answer');
        const captchaQuestionEl = document.getElementById('captcha-question').querySelector('span');

        const mainLoader = document.getElementById('main-loader-container');
        const loaderText = document.getElementById('loader-text');
        const confirmModal = document.getElementById('confirm-modal');
        const modalMessage = document.getElementById('modal-message');
        const btnConfirmDownload = document.getElementById('btn-confirm-download');
        const btnCancelDownload = document.getElementById('btn-cancel-download');
        
        const actionsArea = document.getElementById('actions-area');
        const downloadBtn = document.getElementById('btn-download');
        const viewBtn = document.getElementById('btn-view');
        const shareBtn = document.getElementById('btn-share');
        
        function b64toBlob(b64Data, contentType = '') { /* ... بدون تغییر ... */ }
        
        async function apiCall(body, showButtonLoader = true) {
            if (showButtonLoader) setLoadingState(true);
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8', },
                    body: JSON.stringify(body)
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    throw new Error(errorData?.message || `خطای شبکه: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                showMessage(error.message || 'خطا در ارتباط با سرور.', 'error');
                return null;
            } finally {
                if (showButtonLoader) setLoadingState(false);
            }
        }

        async function getNewCaptcha() {
            captchaQuestionEl.textContent = 'درحال دریافت...';
            const response = await apiCall({ action: 'getCaptcha' }, false); // لودر دکمه را نشان نده
            if (response && response.status === 'success') {
                captchaQuestionEl.textContent = response.question;
                questionId = response.questionId;
            } else {
                captchaQuestionEl.textContent = 'خطا';
            }
        }
        
        function showMessage(message, type) { /* ... بدون تغییر ... */ }
        function setLoadingState(isLoading) { /* ... بدون تغییر ... */ }
        function showMainLoader(text) { loaderText.textContent = text; mainLoader.style.display = 'flex'; }
        function hideMainLoader() { mainLoader.style.display = 'none'; }
        
        // <<<< ویرایش کلیدی: رویداد submit فرم برای مرحله ۱ >>>>
        certificateForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            messageArea.style.display = 'none';
            actionsArea.style.display = 'none';

            const formData = {
                action: 'verify',
                nationalId: document.getElementById('nationalId').value,
                captchaAnswer: captchaAnswerInput.value,
                questionId: questionId
            };
            
            const response = await apiCall(formData);
            
            if (response && response.status === 'verified') {
                fileInfo = {
                    fileId: response.fileId,
                    fileName: response.fileName,
                    nationalId: document.getElementById('nationalId').value
                };
                modalMessage.innerHTML = `گواهی برای کد ملی <strong>${fileInfo.nationalId}</strong> یافت شد. آیا مایل به بارگیری آن هستید؟`;
                confirmModal.style.display = 'flex';
            } else {
                await getNewCaptcha(); // اگر خطا بود، کپچای جدید بگیر
            }
            captchaAnswerInput.value = '';
        });
        
        // <<<< ویرایش کلیدی: رویداد کلیک دکمه تایید برای مرحله ۲ >>>>
        btnConfirmDownload.addEventListener('click', async () => {
            confirmModal.style.display = 'none';
            showMainLoader('در حال آماده‌سازی فایل...');
            
            const response = await apiCall({ action: 'getFileContent', fileId: fileInfo.fileId }, false);
            
            hideMainLoader();
            
            if (response && response.status === 'success') {
                fileBlob = b64toBlob(response.data, response.mimeType);
                fileInfo.type = response.mimeType;
                
                formContainer.style.display = 'none';
                showMessage('فایل با موفقیت آماده شد. اکنون می‌توانید آن را دانلود، مشاهده یا اشتراک‌گذاری کنید.', 'success');
                actionsArea.style.display = 'flex';
            }
        });
        
        btnCancelDownload.addEventListener('click', () => { confirmModal.style.display = 'none'; });

        downloadBtn.addEventListener('click', () => { /* ... بدون تغییر ... */ });
        viewBtn.addEventListener('click', () => { /* ... بدون تغییر ... */ });
        shareBtn.addEventListener('click', async () => { /* ... بدون تغییر ... */ });

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof navigator.share === "undefined") shareBtn.style.display = 'none';
            getNewCaptcha();
        });

        // توابع دیگر که تغییری نکرده‌اند
        function b64toBlob(b64Data, contentType = '', sliceSize = 512) { const byteCharacters = atob(b64Data); const byteArrays = []; for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) { const slice = byteCharacters.slice(offset, offset + sliceSize); const byteNumbers = new Array(slice.length); for (let i = 0; i < slice.length; i++) { byteNumbers[i] = slice.charCodeAt(i); } byteArrays.push(new Uint8Array(byteNumbers)); } return new Blob(byteArrays, { type: contentType }); }
        function showMessage(message, type) { messageArea.innerHTML = message; messageArea.className = `message-${type}`; messageArea.style.display = 'block'; }
        function setLoadingState(isLoading) { submitButton.disabled = isLoading; buttonText.style.display = isLoading ? 'none' : 'inline'; loader.style.display = isLoading ? 'inline-block' : 'none'; }
        function triggerDownload() { if (!fileBlob) return; const url = URL.createObjectURL(fileBlob); const a = document.createElement('a'); a.href = url; a.download = fileInfo.fileName; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
        downloadBtn.addEventListener('click', triggerDownload);
        viewBtn.addEventListener('click', () => { if (fileBlob) { const url = URL.createObjectURL(fileBlob); window.open(url, '_blank'); } });
        shareBtn.addEventListener('click', async () => { if (!fileBlob || !navigator.share) return; try { const file = new File([fileBlob], fileInfo.fileName, { type: fileInfo.type }); await navigator.share({ title: 'گواهینامه دوره آموزشی', files: [file] }); } catch (err) { console.error('Error sharing:', err); } });
    </script>
</body>
</html>
