 <!-- این بخش HTML را در صفحه سایت خود قرار دهید -->
<div id="certificate-app-container">
    <!-- Login View -->
    <div id="login-view">
      <h1>ورود مدیر</h1>
      <div id="login-message" class="message" style="display:none;"></div>
      <div class="form-group">
        <label for="username">نام کاربری</label>
        <input type="text" id="username">
      </div>
      <div class="form-group">
        <label for="password">رمز عبور</label>
        <input type="password" id="password">
      </div>
      <button class="btn btn-primary" id="login-btn">ورود</button>
    </div>

    <!-- Main View -->
    <div id="main-view" style="display:none;">
      <h1>لیست درخواست‌های گواهی</h1>
      <div id="main-message" class="message" style="display:none;"></div>
      <div id="student-list">
        <div class="loader"></div>
      </div>
    </div>
</div>

<!-- استایل‌ها را می‌توانید در فایل CSS اصلی سایت خود قرار دهید -->
<style>
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
    :root { --primary-color: #0d6efd; --secondary-color: #6c757d; --success-color: #198754; --danger-color: #dc3545; --light-color: #f8f9fa; --dark-color: #212529; --border-color: #dee2e6; }
    #certificate-app-container { font-family: 'Vazirmatn', sans-serif; direction: rtl; max-width: 900px; margin: auto; }
    h1 { text-align: center; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input[type="text"], input[type="password"] { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; }
    .btn { display: inline-block; width: 100%; padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; text-align: center; font-size: 16px; position: relative; }
    .btn-primary { background-color: var(--primary-color); color: #fff; }
    .accordion-header { background-color: #e9ecef; padding: 15px; margin-top: 20px; cursor: pointer; border: 1px solid var(--border-color); font-weight: bold; }
    .accordion-content { padding: 0 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .student-row { display: grid; grid-template-columns: 30px 1fr 1fr 1fr 80px 80px; gap: 10px; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
    .action-btn { padding: 6px 10px; border: none; border-radius: 4px; color: #fff; cursor: pointer; font-size: 14px; text-decoration: none; text-align: center; display: block; }
    .btn-view { background-color: var(--secondary-color); }
    .btn-issue { background-color: var(--success-color); }
    .loader, .btn-loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
    .btn-loader { width: 16px; height: 16px; border-width: 2px; display: inline-block; vertical-align: middle; margin: 0; }
    .message { padding: 15px; margin: 15px 0; border-radius: 4px; text-align: center; }
    .message.error { background-color: #f8d7da; color: #842029; }
    .message.success { background-color: #d1e7dd; color: #0f5132; }
</style>

<!-- این کد جاوا اسکریپت را در تگ <script> در انتهای صفحه سایت خود قرار دهید -->
<script>
document.addEventListener('DOMContentLoaded', () => {

    // آدرس Web App خود را اینجا قرار دهید
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxz1vcnpSq6ozCtLLFiccStLFFql-pLXhobj2aa0QLtVEJUHecyprOGZG5ReUfDLiiG/exec";

    const loginView = document.getElementById('login-view');
    const mainView = document.getElementById('main-view');
    const loginBtn = document.getElementById('login-btn');
    const studentListDiv = document.getElementById('student-list');
    const loginMsg = document.getElementById('login-message');
    const mainMsg = document.getElementById('main-message');

    // تابع اصلی برای تمام درخواست‌های API
    async function apiCall(action, payload) {
        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'cors', // مهم
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8', // Apps Script با این هدر بهتر کار می‌کند
                },
                body: JSON.stringify({ action, payload })
            });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            return { success: false, error: error.message };
        }
    }

    // --- توابع مدیریت UI ---
    
    function showLoader(button, show = true) {
        button.disabled = show;
        if(show){
            button.innerHTML = '<div class="btn-loader"></div>';
        } else {
            button.innerHTML = button.dataset.originalText || 'دکمه';
        }
    }

    function showMessage(element, text, isError = true) {
        element.className = 'message ' + (isError ? 'error' : 'success');
        element.textContent = text;
        element.style.display = 'block';
    }

    // --- توابع رویدادها ---

    loginBtn.addEventListener('click', async () => {
        loginBtn.dataset.originalText = loginBtn.innerHTML;
        showLoader(loginBtn);
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        const result = await apiCall('login', { username, password });
        
        showLoader(loginBtn, false);
        if (result.success && result.data.isLoggedIn) {
            loginView.style.display = 'none';
            mainView.style.display = 'block';
            fetchStudents();
        } else {
            showMessage(loginMsg, result.error || 'نام کاربری یا رمز عبور اشتباه است.');
        }
    });

    async function fetchStudents() {
        studentListDiv.innerHTML = '<div class="loader"></div>';
        const result = await apiCall('getStudents', {});
        
        studentListDiv.innerHTML = '';
        if (result.success) {
            const groupedData = result.data;
            if (groupedData.length === 0) {
                 studentListDiv.innerHTML = '<p style="text-align:center;">هیچ درخواست در انتظاری وجود ندارد.</p>';
                 return;
            }
            
            groupedData.forEach(group => {
                const header = document.createElement('div');
                header.className = 'accordion-header';
                header.textContent = `درخواست‌های روز: ${group.date}`;
                
                const content = document.createElement('div');
                content.className = 'accordion-content';

                group.students.forEach(student => {
                    const row = document.createElement('div');
                    row.className = 'student-row';
                    row.innerHTML = `
                        <div>${group.students.indexOf(student) + 1}</div>
                        <div>${student.name || '---'}</div>
                        <div>${student.nationalId || '---'}</div>
                        <div>${student.courseName || '---'}</div>
                        <div><a href="${student.projectUrl || '#'}" target="_blank" class="action-btn btn-view">پروژه</a></div>
                        <div><button class="action-btn btn-issue">صدور</button></div>
                    `;
                    const issueBtn = row.querySelector('.btn-issue');
                    issueBtn.addEventListener('click', () => handleIssueCertificate(student, issueBtn));
                    content.appendChild(row);
                });

                studentListDiv.appendChild(header);
                studentListDiv.appendChild(content);

                header.addEventListener('click', () => {
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                    }
                });
            });
        } else {
            showMessage(mainMsg, result.error || 'خطا در دریافت لیست دانشجویان.');
        }
    }

    async function handleIssueCertificate(studentData, button) {
        button.dataset.originalText = button.innerHTML;
        showLoader(button);

        const result = await apiCall('issueCertificate', { studentData });

        if (result.success) {
            showMessage(mainMsg, result.message, false);
        } else {
            showMessage(mainMsg, result.error || 'خطا در صدور گواهی.', true);
        }
        
        setTimeout(fetchStudents, 2000); // رفرش لیست
    }
});
</script>
