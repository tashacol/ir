<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پرتال اساتید قرآن</title>
    <style>
        :root { --primary-color: #2c7a7b; --secondary-color: #1a5f7a; --light-bg: #f0f5f9; --white: #ffffff; --dark-text: #333; --border-color: #dce4e8; --danger-color: #e74c3c; --warning-color: #f39c12; }
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--light-bg); margin: 0; padding: 20px; color: var(--dark-text); line-height: 1.6; }
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        .container { max-width: 950px; margin: auto; background: var(--white); padding: 30px; border-radius: 12px; box-shadow: 0 6px 15px rgba(0,0,0,0.08); }
        h1, h2, h3 { color: var(--primary-color); text-align: center; }
        h2 { border-bottom: 2px solid var(--secondary-color); padding-bottom: 10px; margin-bottom: 25px;}
        .hidden { display: none !important; }
        #login-section, #dashboard-section { transition: opacity 0.5s; }
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 0.95em; }
        input[type="text"], input[type="password"] { width: calc(100% - 22px); padding: 11px; border: 1px solid var(--border-color); border-radius: 6px; transition: border-color 0.3s, box-shadow 0.3s; }
        input[type="text"]:focus, input[type="password"]:focus { border-color: var(--primary-color); box-shadow: 0 0 5px rgba(44, 122, 123, 0.3); outline: none;}
        button { background-color: var(--primary-color); color: white; padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-family: 'Vazirmatn', sans-serif; transition: background-color 0.3s; }
        button:hover { background-color: var(--secondary-color); }
        button.secondary { background-color: #6c757d; }
        button.secondary:hover { background-color: #5a6268; }
        button.edit-btn { background-color: var(--warning-color); }
        button.edit-btn:hover { background-color: #e67e22; }
        button.delete-btn { background-color: var(--danger-color); }
        button.delete-btn:hover { background-color: #c0392b; }
        .card-actions { display: flex; gap: 10px; margin-top: 20px; }
        #error-message { color: var(--danger-color); text-align: center; margin-top: 15px; font-weight: bold; }
        #welcome-message { font-size: 1.3em; margin-bottom: 25px; background: #e8f3f3; padding: 15px; border-radius: 8px; border-right: 5px solid var(--primary-color); }
        .course-card { background: #fafafa; border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; margin-bottom: 25px; }
        .course-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;}
        .student-list table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .student-list th, .student-list td { padding: 12px; border: 1px solid #e1e1e1; text-align: right; }
        .student-list th { background-color: #f2f2f2; font-weight: bold; }
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; padding: 25px; border: 1px solid #888; width: 90%; max-width: 550px; border-radius: 10px; animation: slide-down 0.4s; }
        @keyframes slide-down { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-btn { color: #aaa; float: left; font-size: 32px; font-weight: bold; cursor: pointer; line-height: 1; }
        select { padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); margin: 0 5px; }
        #add-student-form-fields { border: 1px dashed var(--border-color); padding: 15px; margin-top: 15px; border-radius: 8px; background: #fdfdfd; }
        #temp-student-list li { padding: 8px 12px; border-bottom: 1px solid #eee; list-style-type: decimal-leading-zero; }
        #temp-student-list li:nth-child(odd) { background-color: #f9f9f9; }
        .loader-modal { position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-color: rgba(255,255,255,0.8); }
        .loader-text { font-size: 1.2em; font-weight: bold; color: var(--primary-color); }
    </style>
</head>
<body>

    <div class="container">
        <!-- بخش ورود -->
        <div id="login-section">
            <h1>پرتال اساتید قرآن کریم</h1>
            <form id="login-form">
                <div class="form-group">
                    <label for="nationalId">کد ملی:</label>
                    <input type="text" id="nationalId" name="nationalId" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">رمز عبور:</label>
                    <input type="password" id="password" name="password" required autocomplete="current-password">
                </div>
                <button type="submit">ورود</button>
                <p id="error-message" class="hidden"></p>
            </form>
        </div>

        <!-- بخش داشبورد -->
        <div id="dashboard-section" class="hidden">
            <div id="welcome-message"></div>
            <button id="btn-create-course">ایجاد دوره جدید</button>
            <hr style="margin: 25px 0; border: none; border-top: 1px solid var(--border-color);">
            <h2>دوره‌های من</h2>
            <div id="courses-container"></div>
        </div>
    </div>
    
    <!-- مودال ایجاد دوره جدید -->
    <div id="create-course-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('create-course-modal')">&times;</span>
            <h3>ایجاد دوره جدید</h3>
            <p><strong>نام دوره:</strong> روخوانی و روانخوانی قرآن کریم</p>
            <div class="form-group">
                <label>تاریخ شروع دوره:</label>
                <select id="start-day"></select>
                <select id="start-month"></select>
                <select id="start-year" disabled></select>
            </div>
            <button id="btn-submit-course">تایید و ایجاد دوره</button>
        </div>
    </div>

    <!-- مودال ویرایش دوره -->
    <div id="edit-course-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('edit-course-modal')">&times;</span>
            <h3>ویرایش تاریخ دوره <span id="edit-modal-course-id" style="color: var(--secondary-color);"></span></h3>
            <div class="form-group">
                <label>تاریخ شروع جدید:</label>
                <select id="edit-start-day"></select>
                <select id="edit-start-month"></select>
                <select id="edit-start-year" disabled></select>
            </div>
            <button id="btn-submit-edit-course">ذخیره تغییرات</button>
        </div>
    </div>

    <!-- مودال افزودن قرآن آموز -->
    <div id="add-student-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('add-student-modal')">&times;</span>
            <h3>افزودن قرآن آموز به دوره <span id="modal-course-id" style="color: var(--secondary-color);"></span></h3>
            <div id="add-student-form-fields">
                 <div class="form-group">
                    <label for="student-name">نام و نام خانوادگی قرآن آموز:</label>
                    <input type="text" id="student-name">
                </div>
                <div class="form-group">
                    <label for="student-nationalId">کد ملی قرآن آموز:</label>
                    <input type="text" id="student-nationalId">
                </div>
                <button id="btn-add-to-list" class="secondary">افزودن به لیست موقت</button>
            </div>
            
            <h4>لیست موقت قرآن آموزان</h4>
            <ul id="temp-student-list"></ul>
            <button id="btn-save-student-list">ذخیره نهایی لیست در شیت</button>
        </div>
    </div>
    
    <div id="loader" class="loader-modal hidden"><p class="loader-text">لطفاً صبر کنید...</p></div>

<script>
    // ##################################################################################
    // # مهم: لطفاً URL وب اپلیکیشن خود را که از گوگل اسکریپت دریافت کرده‌اید،      #
    // # در اینجا جایگزین کنید.                                                      #
    // ##################################################################################
    const SCRIPT_URL = "YOUR_WEB_APP_URL"; 
    
    // --- متغیرهای سراسری ---
    let loggedInInstructorId = null;
    let loggedInInstructorName = null;
    let tempStudents = [];
    let currentCourseIdForAddingStudents = null;
    let currentCourseIdForEditing = null;

    async function callAppsScript(action, params = {}) {
        showLoader(true);
        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                redirect: 'follow', // دنبال کردن ریدایرکت‌ها
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action, params }),
            });
            const result = await response.json();
            showLoader(false);
            return result;
        } catch (error) {
            showLoader(false);
            console.error('خطا در ارتباط با Google Script:', error);
            alert('خطا در ارتباط با سرور. لطفاً اتصال اینترنت خود را بررسی کرده و دوباره تلاش کنید.');
            return { success: false, message: error.message };
        }
    }

    // --- مدیریت رویدادهای اصلی ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('btn-create-course').addEventListener('click', showCreateCourseModal);
        document.getElementById('btn-submit-course').addEventListener('click', handleCreateCourse);
        document.getElementById('btn-submit-edit-course').addEventListener('click', handleEditCourse);
        document.getElementById('btn-add-to-list').addEventListener('click', addStudentToTempList);
        document.getElementById('btn-save-student-list').addEventListener('click', saveStudentList);
    });

    function showLoader(show) { document.getElementById('loader').classList.toggle('hidden', !show); }

    async function handleLogin(event) {
        event.preventDefault();
        const nationalId = document.getElementById('nationalId').value;
        const password = document.getElementById('password').value;
        const response = await callAppsScript('checkLogin', { nationalId, password });
        if (response.success) {
            loggedInInstructorId = nationalId;
            loggedInInstructorName = response.name;
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            document.getElementById('welcome-message').innerHTML = `<strong>${response.name}</strong> عزیز، خوش آمدید.`;
            fetchDashboardData();
        } else {
            const errorP = document.getElementById('error-message');
            errorP.innerText = response.message || "خطای نامشخص در ورود.";
            errorP.classList.remove('hidden');
        }
    }

    async function fetchDashboardData() {
        const response = await callAppsScript('getInstructorDashboardData', { instructorId: loggedInInstructorId });
        if(response.success){
             renderCourses(response.data);
        } else {
            alert("خطا در دریافت اطلاعات داشبورد: " + response.message);
        }
    }

    function renderCourses(courses) {
        const container = document.getElementById('courses-container');
        container.innerHTML = '';
        if (!courses || courses.length === 0) {
            container.innerHTML = '<p style="text-align: center;">شما هنوز هیچ دوره‌ای ایجاد نکرده‌اید.</p>';
            return;
        }
        courses.forEach(course => {
            const card = document.createElement('div');
            card.className = 'course-card';
            card.id = `course-${course.courseId}`;
            let studentsHtml = '<p style="text-align: center; color: #777;">هنوز قرآن‌آموزی برای این دوره ثبت نشده است.</p>';
            if (course.students.length > 0) {
                studentsHtml = `<div class="student-list"><table><thead><tr><th>نام و نام خانوادگی</th><th>کد ملی</th><th>مجموع نمره</th></tr></thead><tbody>${course.students.map(s => `<tr><td>${s.name || ''}</td><td>${s.nationalId || ''}</td><td>${s.totalScore || 'ثبت نشده'}</td></tr>`).join('')}</tbody></table></div>`;
            }
            card.innerHTML = `
                <div class="course-header">
                    <h3>دوره: روخوانی و روانخوانی قرآن کریم (کد: ${course.courseId})</h3>
                    <span style="font-weight: bold; color: #555;">تاریخ شروع: ${course.startDate}</span>
                </div>
                <h4>لیست قرآن آموزان</h4>
                ${studentsHtml}
                <div class="card-actions">
                    <button onclick="showAddStudentModal('${course.courseId}')">افزودن قرآن آموز</button>
                    <button class="edit-btn" onclick="showEditCourseModal('${course.courseId}', '${course.startDate}')">ویرایش دوره</button>
                    <button class="delete-btn" onclick="promptDeleteCourse('${course.courseId}')">حذف دوره</button>
                </div>
            `;
            container.appendChild(card);
        });
    }
    
    function populateDatePicker(dayId, monthId, yearId) {
        const daySelect = document.getElementById(dayId);
        const monthSelect = document.getElementById(monthId);
        const yearSelect = document.getElementById(yearId);
        if (daySelect.options.length > 1) return;
        daySelect.innerHTML = '';
        for (let i = 1; i <= 31; i++) daySelect.innerHTML += `<option value="${i}">${i}</option>`;
        monthSelect.innerHTML = '';
        const months = ["فروردین", "اردیبهشت", "خرداد", "تیر", "مرداد", "شهریور", "مهر", "آبان", "آذر", "دی", "بهمن", "اسفند"];
        months.forEach((month, index) => monthSelect.innerHTML += `<option value="${index + 1}">${month}</option>`);
        const currentPersianYear = new Date().toLocaleDateString('fa-IR-u-nu-latn').split('/')[0];
        yearSelect.innerHTML = `<option value="${currentPersianYear}">${currentPersianYear}</option>`;
    }

    function showCreateCourseModal() {
        populateDatePicker('start-day', 'start-month', 'start-year');
        document.getElementById('create-course-modal').classList.remove('hidden');
    }

    async function handleCreateCourse() {
        const day = document.getElementById('start-day').value;
        const month = document.getElementById('start-month').value;
        const year = document.getElementById('start-year').value;
        const startDate = `${year}/${month.toString().padStart(2, '0')}/${day.toString().padStart(2, '0')}`;
        const response = await callAppsScript('createNewCourse', { instructorId: loggedInInstructorId, startDate });
        closeModal('create-course-modal');
        if (response.success) {
            alert('دوره با موفقیت ایجاد شد!');
            fetchDashboardData();
        } else {
            alert('خطا در ایجاد دوره: ' + response.message);
        }
    }

    function showAddStudentModal(courseId) {
        currentCourseIdForAddingStudents = courseId;
        document.getElementById('modal-course-id').innerText = courseId;
        tempStudents = [];
        renderTempStudentList();
        document.getElementById('student-name').value = '';
        document.getElementById('student-nationalId').value = '';
        document.getElementById('add-student-modal').classList.remove('hidden');
        document.getElementById('student-name').focus();
    }
    
    function addStudentToTempList() {
        const nameInput = document.getElementById('student-name');
        const nationalIdInput = document.getElementById('student-nationalId');
        const name = nameInput.value.trim();
        const nationalId = nationalIdInput.value.trim();
        if (name && nationalId) {
            if (tempStudents.some(s => s.nationalId === nationalId)) {
                alert('این کد ملی قبلاً به لیست اضافه شده است.');
                return;
            }
            tempStudents.push({ name, nationalId });
            renderTempStudentList();
            nameInput.value = '';
            nationalIdInput.value = '';
            nameInput.focus();
        } else {
            alert('لطفاً نام و کد ملی قرآن آموز را وارد کنید.');
        }
    }
    
    function renderTempStudentList() {
        const listElement = document.getElementById('temp-student-list');
        listElement.innerHTML = '';
        tempStudents.forEach((student) => {
            const li = document.createElement('li');
            li.innerText = `${student.name} - کد ملی: ${student.nationalId}`;
            listElement.appendChild(li);
        });
    }
    
    async function saveStudentList() {
        if (tempStudents.length === 0) {
            alert('هیچ قرآن‌آموزی برای ذخیره در لیست وجود ندارد.');
            return;
        }
        const response = await callAppsScript('addStudentsToCourse', { courseId: currentCourseIdForAddingStudents, students: tempStudents, instructorName: loggedInInstructorName });
        if (response.success) {
            alert(response.message);
            closeModal('add-student-modal');
            fetchDashboardData();
        } else {
            alert('خطا: ' + response.message);
        }
    }
    
    function promptDeleteCourse(courseId) {
        if (confirm(`آیا از حذف کامل دوره با کد ${courseId} و تمام قرآن‌آموزان آن اطمینان دارید؟ این عملیات غیرقابل بازگشت است.`)) {
            handleDeleteCourse(courseId);
        }
    }

    async function handleDeleteCourse(courseId) {
        const response = await callAppsScript('deleteCourse', { courseId });
        alert(response.message);
        if (response.success) {
            fetchDashboardData();
        }
    }

    function showEditCourseModal(courseId, currentDate) {
        currentCourseIdForEditing = courseId;
        populateDatePicker('edit-start-day', 'edit-start-month', 'edit-start-year');
        document.getElementById('edit-modal-course-id').innerText = courseId;
        try {
            const [year, month, day] = currentDate.split('/');
            document.getElementById('edit-start-day').value = parseInt(day, 10);
            document.getElementById('edit-start-month').value = parseInt(month, 10);
            // سال در حال حاضر ثابت است و تغییر نمی‌کند
        } catch (e) {
            console.error("تاریخ با فرمت نامعتبر:", currentDate);
        }
        document.getElementById('edit-course-modal').classList.remove('hidden');
    }

    async function handleEditCourse() {
        const day = document.getElementById('edit-start-day').value;
        const month = document.getElementById('edit-start-month').value;
        const year = document.getElementById('edit-start-year').value;
        const newDate = `${year}/${month.toString().padStart(2, '0')}/${day.toString().padStart(2, '0')}`;
        
        const response = await callAppsScript('editCourse', { courseId: currentCourseIdForEditing, newDate });

        alert(response.message);
        if(response.success){
            closeModal('edit-course-modal');
            fetchDashboardData();
        }
    }
    
    function closeModal(modalId) { document.getElementById(modalId).classList.add('hidden'); }
</script>
</body>
</html>
