<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1200, initial-scale=1.0">
    <title>پرتال اساتید قرآن کریم</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-main: 'Vazirmatn', sans-serif;
            --primary-color: #0c4a6e; --secondary-color: #075985; --accent-color: #38bdf8;
            --light-bg: #f8fafc; --container-bg: #ffffff; --dark-text: #1e293b; --light-text: #64748b;
            --border-color: #e2e8f0; --danger-color: #dc2626; --success-color: #16a34a; --warning-color: #f59e0b;
        }
        body { font-family: var(--font-main); background-color: var(--light-bg); color: var(--dark-text); line-height: 1.7; min-width: 1200px; }
        .container { max-width: 1100px; margin: 40px auto; background: var(--container-bg); padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05), 0 10px 10px -5px rgba(0,0,0,0.04); }
        h1, h2, h3, h4 { color: var(--primary-color); text-align: center; font-weight: 700; }
        .hidden { display: none !important; }

        /* لودینگ اسکلتی */
        .skeleton-card { background: #fff; border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-bottom: 30px; }
        .skeleton { background-color: #e2e8f0; border-radius: 4px; }
        .skeleton.title { height: 28px; width: 40%; margin-bottom: 15px; } .skeleton.text { height: 16px; width: 70%; margin-bottom: 10px; }
        .skeleton.table-head { height: 40px; width: 100%; margin-top: 20px; } .skeleton.table-row { height: 50px; width: 100%; margin-top: 5px; }
        .shimmer { position: relative; overflow: hidden; }
        .shimmer::after { content: ''; position: absolute; top: 0; right: 0; bottom: 0; left: 0; transform: translateX(-100%); background-image: linear-gradient(90deg, rgba(255,255,255,0) 0, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%); animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 100% { transform: translateX(100%); } }

        /* دکمه‌ها و لودینگ */
        button { position: relative; background-color: var(--secondary-color); color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-family: var(--font-main); transition: all 0.3s; }
        button:hover { background-color: var(--primary-color); transform: translateY(-2px); }
        button .btn-text { transition: opacity 0.2s; }
        button .spinner { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; opacity: 0; }
        button.loading .btn-text { opacity: 0; }
        button.loading .spinner { opacity: 1; }
        button:disabled { background-color: var(--light-text); cursor: not-allowed; transform: none; }
        @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }

        .course-card table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .course-card th, .course-card td { padding: 15px; border-bottom: 1px solid var(--border-color); text-align: right; vertical-align: middle; }
        
        /* وضعیت گواهی */
        .status-pill { padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; }
        .status-pill.rejected { background-color: #fee2e2; color: #b91c1c; }
        .status-pill.pending { background-color: #fef3c7; color: #b45309; }
        .status-pill.issued { background-color: #dcfce7; color: #15803d; }
        
        .modal { position: fixed; z-index: 1000; inset: 0; background-color: rgba(15, 23, 42, 0.7); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background-color: var(--container-bg); padding: 30px; width: 90%; max-width: 650px; border-radius: 16px; animation: modal-appear 0.4s; }
        @keyframes modal-appear { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); }
    </style>
</head>
<body>
    <div class="container">
        <div id="login-section"><h1>پرتال اساتید قرآن کریم</h1><form id="login-form"><div class="form-group"><label for="nationalId">کد ملی</label><input type="text" id="nationalId" required></div><div class="form-group"><label for="password">رمز عبور</label><input type="password" id="password" required></div><button type="submit"><span class="btn-text">ورود</span><span class="spinner"></span></button><p id="error-message" class="hidden"></p></form></div>
        <div id="dashboard-section" class="hidden"><div id="welcome-message" style="font-size: 1.5rem; text-align: right; margin-bottom: 25px;"></div><button id="btn-create-course"><span class="btn-text">ایجاد دوره جدید</span><span class="spinner"></span></button><div id="courses-container" style="margin-top:30px;"></div></div>
    </div>
    <div id="modal-container"></div>
<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwswTKz1Hjp5SHV8p3rYna-aOy5cUHEF4BAJu50UrBx0WygpzktN44a6YR01ARQRbGStw/exec";
    let loggedInInstructorId = null, loggedInInstructorName = null;

    async function callAppsScript(action, params = {}) {
        try {
            const res = await fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', headers: {'Content-Type': 'text/plain;charset=utf-8'}, body: JSON.stringify({ action, params }) });
            if (!res.ok) throw new Error(`Network error: ${res.statusText}`);
            return await res.json();
        } catch (error) { alert('خطا در ارتباط با سرور.'); return { success: false, message: error.message }; }
    }

    const setButtonLoading = (button, isLoading) => {
        if (!button) return;
        button.classList.toggle('loading', isLoading);
        button.disabled = isLoading;
    };
    
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('btn-create-course').addEventListener('click', showCreateCourseModal);
    });

    async function handleLogin(event) {
        event.preventDefault();
        const loginButton = event.target.querySelector('button');
        setButtonLoading(loginButton, true);
        const nationalId = document.getElementById('nationalId').value, password = document.getElementById('password').value;
        const res = await callAppsScript('checkLogin', { nationalId, password });
        setButtonLoading(loginButton, false);
        if (res.success) {
            loggedInInstructorId = nationalId; loggedInInstructorName = res.name;
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            document.getElementById('welcome-message').innerHTML = `استاد <strong>${res.name}</strong>، خوش آمدید.`;
            await fetchDashboardData();
        } else {
            const errorP = document.getElementById('error-message'); errorP.innerText = res.message || "خطای ورود."; errorP.classList.remove('hidden');
        }
    }
    
    async function fetchDashboardData() {
        renderSkeletonLoader();
        const res = await callAppsScript('getInstructorDashboardData', { instructorId: loggedInInstructorId });
        if(res.success) renderCourses(res.data); else { document.getElementById('courses-container').innerHTML = ''; alert("خطا در دریافت اطلاعات: " + res.message); }
    }

    function renderSkeletonLoader() {
        let skeletonHTML = '';
        for (let i = 0; i < 2; i++) { skeletonHTML += `<div class="skeleton-card shimmer"><div class="skeleton title"></div><div class="skeleton text"></div><div class="skeleton table-head"></div><div class="skeleton table-row"></div></div>`; }
        document.getElementById('courses-container').innerHTML = skeletonHTML;
    }

    function renderCourses(courses) {
        const container = document.getElementById('courses-container');
        container.innerHTML = !courses || courses.length === 0 ? '<p style="text-align: center;">شما هنوز هیچ دوره‌ای ایجاد نکرده‌اید.</p>' : '';
        courses.forEach(course => {
            let studentsHtml = '<p style="text-align: center; color: var(--light-text);">هنوز قرآن‌آموزی ثبت نشده است.</p>';
            if (course.students.length > 0) {
                studentsHtml = `<table><thead><tr><th>نام</th><th>کد ملی</th><th>نمره</th><th>گواهی</th><th>عملیات</th></tr></thead><tbody>
                    ${course.students.map(s => {
                        const hasScore = s.totalScore && s.totalScore != '0';
                        const scoreDisplay = !hasScore ? `<button class="icon-btn" onclick="showGradingModal(event, '${course.courseId}', '${course.startDate}', '${s.name}', '${s.nationalId}')">ثبت نمره</button>` : `<strong>${s.totalScore}</strong>`;
                        let certStatusHtml = '';
                        switch(s.certificateStatus) {
                            case '0': certStatusHtml = '<span class="status-pill rejected">مردود</span>'; break;
                            case '2': certStatusHtml = '<span class="status-pill pending">بررسی</span>'; break;
                            case '5': certStatusHtml = '<span class="status-pill issued">صدور</span>'; break;
                        }
                        return `<tr><td>${s.name||''}</td><td>${s.nationalId||''}</td><td>${scoreDisplay}</td><td>${certStatusHtml}</td>
                            <td><button class="icon-btn" onclick="showEditStudentModal(event, '${course.courseId}', '${s.name}', '${s.nationalId}')" ${hasScore ? 'disabled' : ''}>ویرایش</button></td></tr>`
                    }).join('')}</tbody></table>`;
            }
            container.innerHTML += `<div class="course-card"><div class="course-header"><h4>دوره روخوانی (کد: ${course.courseId})</h4><span>تاریخ شروع: ${course.startDate}</span></div>${studentsHtml}<div class="course-actions"><button onclick="showAddStudentModal(event, '${course.courseId}')">افزودن قرآن آموز</button><button onclick="showEditDateModal(event, '${course.courseId}')">ویرایش تاریخ</button><button class="danger" onclick="showDeleteConfirmationModal(event, '${course.courseId}')">حذف دوره</button></div></div>`;
        });
    }

    const modalContainer = document.getElementById('modal-container');
    function renderModal(title, content) { modalContainer.innerHTML = `<div class="modal"><div class="modal-content"><div class="modal-header"><h3>${title}</h3><button style="background:none; border:none; font-size:1.5rem; cursor:pointer;" onclick="closeAllModals()">×</button></div>${content}</div></div>`; }
    function closeAllModals() { modalContainer.innerHTML = ''; }
    
    // **خواسته دوم: اعتبارسنجی تاریخ (انتخاب تاریخ قبل از امروز ممکن نیست)**
    function populateDatePicker() {
        let opts = { d: '', m: '', y: ''};
        const today = new Date();
        const currentJalali = new Intl.DateTimeFormat('fa-IR-u-nu-latn').format(today).split('/');
        const [currentYear, currentMonth, currentDay] = currentJalali.map(Number);
        
        const year = currentYear;
        opts.y = `<option value="${year}">${year}</option>`;
        
        ["فروردین","اردیبهشت","خرداد","تیر","مرداد","شهریور","مهر","آبان","آذر","دی","بهمن","اسفند"].forEach((m, i) => {
            const month = i + 1;
            opts.m += `<option value="${month}" ${month < currentMonth ? 'disabled' : ''}>${m}</option>`;
        });

        for (let i = 1; i <= 31; i++) {
            opts.d += `<option value="${i}" ${i < currentDay ? 'disabled' : ''}>${i}</option>`;
        }
        
        let datePickerHtml = `<select id="date-month">${opts.m}</select><select id="date-day">${opts.d}</select><select id="date-year" disabled>${opts.y}</select>`;
        
        setTimeout(() => { // Add event listener after elements are in DOM
            document.getElementById('date-month').addEventListener('change', (e) => {
                const daySelect = document.getElementById('date-day');
                daySelect.innerHTML = '';
                const selectedMonth = parseInt(e.target.value);
                for (let i = 1; i <= 31; i++) {
                    const disabled = (selectedMonth === currentMonth && i < currentDay) ? 'disabled' : '';
                    daySelect.innerHTML += `<option value="${i}" ${disabled}>${i}</option>`;
                }
            });
        }, 0);
        return datePickerHtml;
    }
    
    function showCreateCourseModal() { renderModal('ایجاد دوره جدید', `<div class="form-group"><label>تاریخ شروع</label>${populateDatePicker()}</div><button onclick="handleCreateCourse(event)">ایجاد دوره</button>`); }
    async function handleCreateCourse(event) {
        const button = event.target; setButtonLoading(button, true);
        const date = `${document.getElementById('date-year').value}/${document.getElementById('date-month').value.padStart(2,'0')}/${document.getElementById('date-day').value.padStart(2,'0')}`;
        const res = await callAppsScript('createNewCourse', { instructorId: loggedInInstructorId, startDate: date });
        setButtonLoading(button, false);
        if (res.success) { alert('دوره ایجاد شد!'); fetchDashboardData(); } else alert('خطا: ' + res.message); closeAllModals();
    }
    function showEditDateModal(event, courseId) { renderModal('ویرایش تاریخ دوره', `<div class="form-group"><label>تاریخ جدید</label>${populateDatePicker()}</div><button onclick="handleUpdateCourseDate(event, '${courseId}')">ذخیره</button>`); }
    async function handleUpdateCourseDate(event, courseId) {
        const button = event.target; setButtonLoading(button, true);
        const newDate = `${document.getElementById('date-year').value}/${document.getElementById('date-month').value.padStart(2, '0')}/${document.getElementById('date-day').value.padStart(2, '0')}`;
        const res = await callAppsScript('updateCourseDate', { courseId, newDate });
        setButtonLoading(button, false);
        if (res.success) { alert(res.message); fetchDashboardData(); } else alert("خطا: " + res.message); closeAllModals();
    }
    function showDeleteConfirmationModal(event, courseId) { renderModal('تایید حذف دوره', `<p>آیا از حذف این دوره مطمئنید؟</p><div class="form-group"><label for="delete-password">برای تایید، رمز عبور را وارد کنید:</label><input type="password" id="delete-password"></div><button class="danger" onclick="handleDeleteCourse(event, '${courseId}')">حذف کن</button>`); }
    async function handleDeleteCourse(event, courseId) {
        const button = event.target; setButtonLoading(button, true);
        const password = document.getElementById('delete-password').value; if (!password) { alert("رمز عبور الزامی است."); setButtonLoading(button, false); return; }
        const res = await callAppsScript('deleteCourse', { courseId, instructorId: loggedInInstructorId, password });
        setButtonLoading(button, false);
        if (res.success) { alert(res.message); fetchDashboardData(); } else alert("خطا: " + res.message); closeAllModals();
    }

    function showAddStudentModal(event, courseId) { renderModal(`افزودن قرآن آموز به دوره ${courseId}`, `<div id="add-student-form"><div class="form-group"><label for="student-name">نام</label><input type="text" id="student-name"></div><div class="form-group"><label for="student-nationalId">کد ملی</label><input type="text" id="student-nationalId"></div><button onclick="addStudentToTempList(event)">افزودن به لیست</button></div><h4>لیست موقت</h4><ul id="temp-student-list"></ul><br><button onclick="saveStudentList(event, '${courseId}')">ذخیره نهایی لیست</button>`); }
    function addStudentToTempList(event) { const name = document.getElementById('student-name'), nid = document.getElementById('student-nationalId'); if (name.value.trim() && nid.value.trim()) { if (window.tempStudents.some(s => s.nationalId === nid.value.trim())) { alert('کد ملی تکراری است.'); return; } window.tempStudents.push({ name: name.value.trim(), nationalId: nid.value.trim() }); document.getElementById('temp-student-list').innerHTML = window.tempStudents.map(s => `<li>${s.name} - ${s.nationalId}</li>`).join(''); name.value = ''; nid.value = ''; name.focus(); } else alert('نام و کد ملی الزامی است.'); }
    async function saveStudentList(event, courseId) {
        const button = event.target; setButtonLoading(button, true);
        if (!window.tempStudents || window.tempStudents.length === 0) { alert('لیست خالی است.'); setButtonLoading(button, false); return; }
        const res = await callAppsScript('addStudentsToCourse', { courseId, students: window.tempStudents, instructorName: loggedInInstructorName });
        setButtonLoading(button, false);
        if (res.success) { alert(res.message); fetchDashboardData(); } else alert('خطا: ' + res.message); closeAllModals();
    }
    function showEditStudentModal(event, courseId, name, nid) { renderModal('ویرایش قرآن آموز', `<div class="form-group"><label for="edit-student-name">نام</label><input type="text" id="edit-student-name" value="${name}"></div><div class="form-group"><label for="edit-student-nationalId">کد ملی</label><input type="text" id="edit-student-nationalId" value="${nid}"></div><button onclick="handleUpdateStudent(event, '${courseId}', '${nid}')">ذخیره</button>`); }
    async function handleUpdateStudent(event, courseId, originalNid) {
        const button = event.target; setButtonLoading(button, true);
        const newName = document.getElementById('edit-student-name').value.trim(), newNid = document.getElementById('edit-student-nationalId').value.trim();
        if(!newName || !newNid) { alert("فیلدها نباید خالی باشند."); setButtonLoading(button, false); return;}
        const res = await callAppsScript('updateStudentInfo', { courseId, originalNationalId: originalNid, newName, newNationalId: newNid });
        setButtonLoading(button, false);
        if (res.success) { alert(res.message); fetchDashboardData(); } else alert("خطا: " + res.message); closeAllModals();
    }
    
    function showGradingModal(event, courseId, courseStartDate, studentName, studentNationalId) {
        const parts = courseStartDate.split('/'); const startDate = new Date(parts[0], parts[1] - 1, parts[2]);
        if (isNaN(startDate.getTime()) || (new Date() - startDate) / (1000*60*60*24) < 25) {
            alert(`نمره‌دهی هنوز امکان‌پذیر نیست. باید حداقل ۲۵ روز از شروع دوره گذشته باشد.\n(تاریخ شروع دوره: ${courseStartDate})`); return;
        }
        const content = `<p><strong>نام:</strong> ${studentName}</p><p><strong>کد ملی:</strong> ${studentNationalId}</p><hr>
            <div class="form-group"><label>صحت حروف (از بیست نمره)</label><input type="number" id="g1" min="0" max="20"></div><div class="form-group"><label>صحت حرکات (از بیست نمره)</label><input type="number" id="g2" min="0" max="20"></div>
            <div class="form-group"><label>حروف ناخوانا (از بیست نمره)</label><input type="number" id="g3" min="0" max="20"></div><div class="form-group"><label>وقف و ابتدا (از بیست نمره)</label><input type="number" id="g4" min="0" max="20"></div>
            <div class="form-group"><label>التقاء ساکنین (از بیست نمره)</label><input type="number" id="g5" min="0" max="20"></div><button onclick="handleGradeSubmission(event, '${courseId}', '${studentNationalId}')">تایید و ارسال نمرات</button>`;
        renderModal('ثبت نمره', content);
    }
    async function handleGradeSubmission(event, courseId, studentNid) {
        const button = event.target; setButtonLoading(button, true);
        const grades = {};
        for(let i=1; i<=5; i++) { const val = document.getElementById(`g${i}`).value; if(val==='' || isNaN(val) || val<0 || val>20) { alert(`نمره باید عددی بین 0 و 20 باشد.`); setButtonLoading(button, false); return; } grades[`g${i}`] = Number(val); }
        if (confirm("آیا از ثبت نمرات اطمینان دارید؟ نمرات پس از ثبت قابل ویرایش نیستند.")) {
            const res = await callAppsScript('submitStudentGrades', { courseId, studentNationalId: studentNid, grades });
            if (res.success) { alert(res.message); fetchDashboardData(); } else alert("خطا: " + res.message); closeAllModals();
        } else { setButtonLoading(button, false); }
    }
</script>
</body>
</html>
