<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1200, initial-scale=1.0">
    <title>پرتال اساتید قرآن کریم</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-main: 'Vazirmatn', sans-serif;
            --primary-color: #0c4a6e; --secondary-color: #075985; --accent-color: #38bdf8;
            --light-bg: #f8fafc; --container-bg: #ffffff; --dark-text: #1e293b; --light-text: #64748b;
            --border-color: #e2e8f0; --danger-color: #dc2626; --success-color: #16a34a; --warning-color: #f59e0b;
        }
        body { font-family: var(--font-main); background-color: var(--light-bg); color: var(--dark-text); line-height: 1.7; min-width: 1200px; }
        .container { max-width: 1100px; margin: 40px auto; background: var(--container-bg); padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05), 0 10px 10px -5px rgba(0,0,0,0.04); }
        h1, h2, h3, h4 { color: var(--primary-color); text-align: center; font-weight: 700; }
        h1 { font-size: 2.2rem; } h2 { font-size: 1.8rem; border-bottom: 2px solid var(--border-color); padding-bottom: 15px; margin-bottom: 30px; }
        h4 { font-size: 1.3rem; color: var(--secondary-color); margin-bottom: 15px; }
        .hidden { display: none !important; }

        /* Skeleton Loading */
        .skeleton-card { background: #fff; border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-bottom: 30px; }
        .skeleton { background-color: #e2e8f0; border-radius: 4px; } .skeleton.title { height: 28px; width: 40%; margin-bottom: 15px; }
        .skeleton.text { height: 16px; width: 70%; margin-bottom: 10px; } .skeleton.table-head { height: 40px; width: 100%; margin-top: 20px; }
        .skeleton.table-row { height: 50px; width: 100%; margin-top: 5px; } .shimmer { position: relative; overflow: hidden; }
        .shimmer::after { content: ''; position: absolute; top: 0; right: 0; bottom: 0; left: 0; transform: translateX(-100%); background-image: linear-gradient(90deg, rgba(255,255,255,0) 0, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%); animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 100% { transform: translateX(100%); } }

        /* Forms & Buttons */
        .form-group { margin-bottom: 20px; } label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 1rem; }
        input, select { width: 100%; box-sizing: border-box; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; font-family: var(--font-main); transition: all 0.3s; }
        input:focus, select:focus { border-color: var(--secondary-color); box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.3); outline: none; }
        button { position:relative; background-color: var(--secondary-color); color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-family: var(--font-main); transition: all 0.3s; }
        button:hover:not(:disabled) { background-color: var(--primary-color); transform: translateY(-2px); }
        button:disabled { background-color: #94a3b8; cursor: not-allowed; }
        button.danger { background-color: var(--danger-color); } button.danger:hover:not(:disabled) { background-color: #b91c1c; }
        .btn-loading .btn-text { visibility: hidden; }
        .btn-loading::after { content: ''; position: absolute; width: 20px; height: 20px; top: 0; left: 0; right: 0; bottom: 0; margin: auto; border: 3px solid transparent; border-top-color: #ffffff; border-radius: 50%; animation: button-loading-spinner 1s ease infinite; }
        @keyframes button-loading-spinner { from { transform: rotate(0turn); } to { transform: rotate(1turn); } }

        .icon { width: 1.1em; height: 1.1em; vertical-align: middle; }
        .icon-btn { background: none; border: none; color: var(--light-text); cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; font-family: var(--font-main); padding: 8px; border-radius: 8px; transition: all 0.3s; }
        .icon-btn .icon { width: 1.3em; height: 1.3em; } .icon-btn:hover:not(:disabled) { color: var(--secondary-color); background-color: #f0f9ff; }
        .icon-btn.delete-btn:hover:not(:disabled) { color: var(--danger-color); background-color: #fee2e2; }

        .course-card { background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-bottom: 30px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .course-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .course-card table { width: 100%; border-collapse: collapse; margin-top: 20px; } .course-card th, .course-card td { padding: 15px; border-bottom: 1px solid var(--border-color); text-align: right; vertical-align: middle; }
        .course-card th { background-color: var(--light-bg); font-size: 1rem; } .course-card tr:last-child td { border-bottom: none; }
        .course-actions { display: flex; align-items: center; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px dashed var(--border-color); }
        
        /* خواسته اول: استایل مودال‌های سفارشی */
        .custom-modal-overlay { position: fixed; z-index: 2000; inset: 0; background-color: rgba(15, 23, 42, 0.7); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .custom-modal-content { background-color: var(--container-bg); padding: 30px; width: 90%; max-width: 450px; border-radius: 16px; text-align: center; animation: modal-appear 0.4s; }
        @keyframes modal-appear { from { transform: scale(0.9) translateY(10px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
        .custom-modal-icon { margin-bottom: 15px; } .custom-modal-icon .icon { width: 4em; height: 4em; }
        .custom-modal-message { font-size: 1.2rem; color: var(--dark-text); margin-bottom: 25px; line-height: 1.8; }
        .custom-modal-actions { display: flex; justify-content: center; gap: 15px; }
    </style>
</head>
<body>
    <svg width="0" height="0" class="hidden"><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-plus-circle"><path fill="currentColor" d="M12 2c-5.52 0-10 4.48-10 10s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m5 11h-4v4h-2v-4H7v-2h4V7h2v4h4z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-pencil"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83l3.75 3.75z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-trash"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-grade"><path fill="currentColor" d="M12 3L1 9l4 2.18v6.32L12 21l7-3.5V11.18L23 9zm-2 13.91V13h4v3.91l-2 1.09zM12 11.33L4.93 8L12 4.67L19.07 8z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-modal-success"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m-2 15l-5-5l1.41-1.41L10 14.17l7.59-7.59L19 8z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-modal-error"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m1 15h-2v-2h2zm0-4h-2V7h2z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-modal-confirm"><path fill="currentColor" d="M1 21h22L12 2zM13 18h-2v-2h2zm0-4h-2v-4h2z"/></symbol></svg>
    <div class="container">
        <div id="login-section"><h1>پرتال اساتید قرآن کریم</h1><form id="login-form"><div class="form-group"><label for="nationalId">کد ملی</label><input type="text" id="nationalId" required></div><div class="form-group"><label for="password">رمز عبور</label><input type="password" id="password" required></div><button type="submit"><span class="btn-text">ورود</span></button><p id="error-message" class="hidden"></p></form></div>
        <div id="dashboard-section" class="hidden"><div id="welcome-message"></div><button id="btn-create-course"><span class="btn-text">ایجاد دوره جدید</span></button><div id="courses-container"></div></div>
    </div>
    <div id="modal-container"></div>
<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwswTKz1Hjp5SHV8p3rYna-aOy5cUHEF4BAJu50UrBx0WygpzktN44a6YR01ARQRbGStw/exec";
    let loggedInInstructorId = null, loggedInInstructorName = null; let currentCourseId = null, currentStudentOriginalId = null;
    
    // --- Helper Functions ---
    async function callAppsScript(action, params = {}, button = null) { if(button) setButtonLoading(button, true); try { const res = await fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', headers: {'Content-Type': 'text/plain;charset=utf-8'}, body: JSON.stringify({ action, params }) }); if (!res.ok) throw new Error(`Network error: ${res.statusText}`); return await res.json(); } catch (error) { showCustomAlert('خطا در ارتباط با سرور.', 'error'); return { success: false, message: error.message }; } finally { if(button) setButtonLoading(button, false); } }
    function setButtonLoading(button, isLoading) { const target = button.closest('button'); if(!target) return; if(isLoading) { target.disabled = true; target.classList.add('btn-loading'); } else { target.disabled = false; target.classList.remove('btn-loading'); } }
    function jalaliToGregorian(jy, jm, jd) { let sal_a, gy, gm, gd, days; jy += 1595; days = -355668 + (365 * jy) + (~~(jy / 33) * 8) + ~~(((jy % 33) + 3) / 4) + jd + ((jm < 7) ? (jm - 1) * 31 : ((jm - 7) * 30) + 186); gy = 400 * ~~(days / 146097); days %= 146097; if (days > 36524) { gy += 100 * ~~(--days / 36524); days %= 36524; if (days >= 365) days++; } gy += 4 * ~~(days / 1461); days %= 1461; if (days > 365) { gy += ~~((days - 1) / 365); days = (days - 1) % 365; } gd = days + 1; sal_a = [0, 31, ((gy % 4 === 0 && gy % 100 !== 0) || (gy % 400 === 0)) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]; for (gm = 0; gm < 13 && gd > sal_a[gm]; gm++) gd -= sal_a[gm]; return new Date(gy, gm - 1, gd); }
    function getTodayJalaliString() { const p2e = s => s.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d)); return p2e(new Date().toLocaleDateString('fa-IR', {year: 'numeric', month: '2-digit', day: '2-digit'})); }
    
    // --- Custom Alert System ---
    function showCustomAlert(message, type = 'info', onConfirm = null) {
        const icons = { success: '#icon-modal-success', error: '#icon-modal-error', confirm: '#icon-modal-confirm' };
        const colors = { success: 'var(--success-color)', error: 'var(--danger-color)', confirm: 'var(--warning-color)' };
        
        let actionsHtml = `<button id="custom-modal-ok">متوجه شدم</button>`;
        if (type === 'confirm') { actionsHtml = `<button id="custom-modal-yes" class="danger">بله، تایید</button><button id="custom-modal-no">خیر</button>`; }
        
        const modalHtml = `<div class="custom-modal-overlay" id="custom-modal">
            <div class="custom-modal-content">
                ${icons[type] ? `<div class="custom-modal-icon" style="color:${colors[type]};"><svg class="icon"><use href="${icons[type]}"></use></svg></div>` : ''}
                <div class="custom-modal-message">${message}</div>
                <div class="custom-modal-actions">${actionsHtml}</div>
            </div></div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        if (type === 'confirm') {
            document.getElementById('custom-modal-yes').onclick = () => { if(onConfirm) onConfirm(); document.getElementById('custom-modal').remove(); };
            document.getElementById('custom-modal-no').onclick = () => document.getElementById('custom-modal').remove();
        } else {
            document.getElementById('custom-modal-ok').onclick = () => document.getElementById('custom-modal').remove();
        }
    }

    // --- Core Logic ---
    document.addEventListener('DOMContentLoaded', () => { document.getElementById('login-form').addEventListener('submit', handleLogin); document.getElementById('btn-create-course').addEventListener('click', e => showCreateCourseModal(e.target)); });
    
    async function handleLogin(event) {
        event.preventDefault(); renderSkeletonLoader();
        const res = await callAppsScript('checkLogin', { nationalId: document.getElementById('nationalId').value, password: document.getElementById('password').value }, event.target);
        if (res.success) { loggedInInstructorId = document.getElementById('nationalId').value; loggedInInstructorName = res.name; document.getElementById('login-section').classList.add('hidden'); document.getElementById('dashboard-section').classList.remove('hidden'); document.getElementById('welcome-message').innerHTML = `استاد <strong>${res.name}</strong>، خوش آمدید.`; await fetchDashboardData();
        } else { const errorP = document.getElementById('error-message'); errorP.innerText = res.message || "خطای ورود."; errorP.classList.remove('hidden'); document.getElementById('courses-container').innerHTML = ''; }
    }

    async function fetchDashboardData() { renderSkeletonLoader(); const res = await callAppsScript('getInstructorDashboardData', { instructorId: loggedInInstructorId }); if(res.success) renderCourses(res.data); else showCustomAlert(res.message, 'error'); }
    function renderSkeletonLoader() { let skeletonHTML = ''; for (let i = 0; i < 2; i++) { skeletonHTML += `<div class="skeleton-card shimmer"><div class="skeleton title"></div><div class="skeleton text"></div><div class="skeleton table-head"></div><div class="skeleton table-row"></div><div class="skeleton table-row"></div></div>`; } document.getElementById('courses-container').innerHTML = skeletonHTML; }

    function renderCourses(courses) { const container = document.getElementById('courses-container'); container.innerHTML = !courses || courses.length === 0 ? '<p style="text-align: center;">شما هنوز هیچ دوره‌ای ایجاد نکرده‌اید.</p>' : ''; const todayJalali = getTodayJalaliString(); courses.forEach(course => { const isCourseStarted = course.startDate <= todayJalali; let studentsHtml = '<p style="text-align: center; color: var(--light-text);">هنوز قرآن‌آموزی ثبت نشده است.</p>'; if (course.students.length > 0) { studentsHtml = `<table><thead><tr><th>نام</th><th>کد ملی</th><th>نمره کل</th><th>وضعیت گواهی</th><th>عملیات</th></tr></thead><tbody> ${course.students.map(s => { const hasGrade = s.totalScore && s.totalScore != '0'; const scoreButton = !hasGrade ? `<button class="icon-btn" onclick="showGradingModal(event, '${course.courseId}', '${course.startDate}', '${s.name}', '${s.nationalId}')"><svg class="icon"><use href="#icon-grade"></use></svg><span class="btn-text">ثبت نمره</span></button>` : `<strong>${s.totalScore}</strong>`; const editButton = !hasGrade ? `<button class="icon-btn" onclick="showEditStudentModal(event, '${course.courseId}', '${s.name}', '${s.nationalId}')"><svg class="icon"><use href="#icon-pencil"></use></svg></button>` : ''; let certStatusText = ''; switch(s.certificateStatus) { case '0': certStatusText = 'مردود'; break; case '2': certStatusText = 'بررسی'; break; case '5': certStatusText = 'صدور'; break; } return `<tr><td>${s.name||''}</td><td>${s.nationalId||''}</td><td>${scoreButton}</td><td>${certStatusText}</td><td>${editButton}</td></tr>` }).join('')}</tbody></table>`; } container.innerHTML += `<div class="course-card"><div class="course-header"><h4>دوره روخوانی (کد: ${course.courseId})</h4><span style="font-weight: bold; color: var(--light-text);">تاریخ شروع: ${course.startDate}</span></div>${studentsHtml}<div class="course-actions"><button class="icon-btn" onclick="showAddStudentModal(event, '${course.courseId}')"><svg class="icon"><use href="#icon-plus-circle"></use></svg><span class="btn-text">افزودن قرآن آموز</span></button><button class="icon-btn" onclick="showEditDateModal(event, '${course.courseId}')" ${isCourseStarted ? 'disabled title="امکان ویرایش تاریخ پس از شروع دوره وجود ندارد"' : ''}><svg class="icon"><use href="#icon-pencil"></use></svg><span class="btn-text">ویرایش تاریخ</span></button><button class="icon-btn delete-btn" onclick="showDeleteConfirmationModal(event, '${course.courseId}')"><svg class="icon"><use href="#icon-trash"></use></svg><span class="btn-text">حذف دوره</span></button></div></div>`; }); }

    // --- Modal Handlers ---
    const modalContainer = document.getElementById('modal-container'); function renderModal(title, content) { modalContainer.innerHTML = `<div class="modal"><div class="modal-content"><div class="modal-header"><h3>${title}</h3><button class="close-btn" onclick="closeAllModals()">×</button></div>${content}</div></div>`; } function closeAllModals() { modalContainer.innerHTML = ''; }
    function populateDatePicker(prefix = 'start') { let opts = { d: '', m: '', y: ''}; for (let i = 1; i <= 31; i++) opts.d += `<option value="${i}">${i}</option>`; ["فروردین","اردیبهشت","خرداد","تیر","مرداد","شهریور","مهر","آبان","آذر","دی","بهمن","اسفند"].forEach((m, i) => opts.m += `<option value="${i+1}">${m}</option>`); opts.y = `<option value="${new Date().toLocaleDateString('fa-IR-u-nu-latn').split('/')[0]}">${new Date().toLocaleDateString('fa-IR-u-nu-latn').split('/')[0]}</option>`; return `<select id="${prefix}-day">${opts.d}</select><select id="${prefix}-month">${opts.m}</select><select id="${prefix}-year" disabled>${opts.y}</select>`; }

    function showCreateCourseModal() { renderModal('ایجاد دوره جدید', `<p>نام دوره: روخوانی و روانخوانی قرآن کریم</p><div class="form-group"><label>تاریخ شروع</label>${populateDatePicker('start')}</div><button onclick="handleCreateCourse(event)"><span class="btn-text">ایجاد دوره</span></button>`); }
    async function handleCreateCourse(event) { const date = `${document.getElementById('start-year').value}/${document.getElementById('start-month').value.padStart(2,'0')}/${document.getElementById('start-day').value.padStart(2,'0')}`; if (date < getTodayJalaliString()) { showCustomAlert("تاریخ انتخابی نمی‌تواند در گذشته باشد.", 'error'); return; } const res = await callAppsScript('createNewCourse', { instructorId: loggedInInstructorId, startDate: date }, event.target); if (res.success) { showCustomAlert('دوره با موفقیت ایجاد شد!', 'success'); fetchDashboardData(); } else showCustomAlert('خطا: ' + res.message, 'error'); closeAllModals(); }
    function showEditDateModal(event, courseId) { currentCourseId = courseId; renderModal('ویرایش تاریخ دوره', `<div class="form-group"><label>تاریخ جدید</label>${populateDatePicker('edit')}</div><button onclick="handleUpdateCourseDate(event)"><span class="btn-text">ذخیره</span></button>`); }
    async function handleUpdateCourseDate(event) { const newDate = `${document.getElementById('edit-year').value}/${document.getElementById('edit-month').value.padStart(2, '0')}/${document.getElementById('edit-day').value.padStart(2, '0')}`; if (newDate < getTodayJalaliString()) { showCustomAlert("تاریخ انتخابی نمی‌تواند در گذشته باشد.", 'error'); return; } const res = await callAppsScript('updateCourseDate', { courseId: currentCourseId, newDate }, event.target); if (res.success) { showCustomAlert(res.message, 'success'); fetchDashboardData(); } else showCustomAlert("خطا: " + res.message, 'error'); closeAllModals(); }
    function showDeleteConfirmationModal(event, courseId) { currentCourseId = courseId; showCustomAlert('آیا از حذف این دوره و تمام قرآن‌آموزان آن اطمینان دارید؟ این عمل غیرقابل بازگشت است.', 'confirm', () => handleDeleteCourse(event)); }
    async function handleDeleteCourse(event) { const { value: password } = await Swal.fire({ title: 'برای تایید، رمز عبور را وارد کنید', input: 'password', inputPlaceholder: 'رمز عبور', inputAttributes: { autocapitalize: 'off', autocorrect: 'off' }, showCancelButton: true, cancelButtonText: 'انصراف' }); if (!password) return; const res = await callAppsScript('deleteCourse', { courseId: currentCourseId, instructorId: loggedInInstructorId, password }, document.querySelector('.swal2-confirm')); if (res.success) { showCustomAlert(res.message, 'success'); fetchDashboardData(); } else showCustomAlert("خطا: " + res.message, 'error'); }
    function showAddStudentModal(event, courseId) { currentCourseId = courseId; renderModal(`افزودن قرآن آموز به دوره ${courseId}`, `<div id="add-student-form"><div class="form-group"><label for="student-name">نام</label><input type="text" id="student-name"></div><div class="form-group"><label for="student-nationalId">کد ملی (۱۰ رقم)</label><input type="tel" pattern="[0-9]{10}" maxlength="10" inputmode="numeric" id="student-nationalId"></div><button onclick="addStudentToTempList()"><span class="btn-text">افزودن به لیست</span></button></div><h4>لیست موقت</h4><ul id="temp-student-list"></ul><br><button onclick="saveStudentList(event)"><span class="btn-text">ذخیره نهایی لیست</span></button>`); }
    
    // --- National ID Validation ---
    function addStudentToTempList() { const name = document.getElementById('student-name'), nid = document.getElementById('student-nationalId'); const tempStudents = window.tempStudents || []; if (!/^\d{10}$/.test(nid.value)) { showCustomAlert('کد ملی باید یک عدد ۱۰ رقمی باشد.', 'error'); return; } if (name.value.trim() && nid.value.trim()) { if (tempStudents.some(s => s.nationalId === nid.value.trim())) { showCustomAlert('این کد ملی قبلاً به لیست موقت اضافه شده است.', 'error'); return; } tempStudents.push({ name: name.value.trim(), nationalId: nid.value.trim() }); document.getElementById('temp-student-list').innerHTML = tempStudents.map(s => `<li>${s.name} - ${s.nationalId}</li>`).join(''); name.value = ''; nid.value = ''; name.focus(); window.tempStudents = tempStudents; } else showCustomAlert('نام و کد ملی الزامی است.', 'error'); }
    async function saveStudentList(event) { const tempStudents = window.tempStudents; if (!tempStudents || tempStudents.length === 0) { showCustomAlert('لیست خالی است.', 'error'); return; } const res = await callAppsScript('addStudentsToCourse', { courseId: currentCourseId, students: tempStudents, instructorName: loggedInInstructorName }, event.target); if (res.success) { showCustomAlert(res.message, 'success'); fetchDashboardData(); } else showCustomAlert(res.message, 'error'); closeAllModals(); window.tempStudents = []; }

    function showEditStudentModal(event, courseId, name, nid) { currentCourseId = courseId; currentStudentOriginalId = nid; renderModal('ویرایش قرآن آموز', `<div class="form-group"><label for="edit-student-name">نام</label><input type="text" id="edit-student-name" value="${name}"></div><div class="form-group"><label for="edit-student-nationalId">کد ملی (۱۰ رقم)</label><input type="tel" pattern="[0-9]{10}" maxlength="10" inputmode="numeric" id="edit-student-nationalId" value="${nid}"></div><button onclick="handleUpdateStudent(event)"><span class="btn-text">ذخیره</span></button>`); }
    async function handleUpdateStudent(event) { const newName = document.getElementById('edit-student-name').value.trim(), newNid = document.getElementById('edit-student-nationalId').value.trim(); if (!/^\d{10}$/.test(newNid)) { showCustomAlert('کد ملی باید یک عدد ۱۰ رقمی باشد.', 'error'); return; } if(!newName || !newNid) { showCustomAlert("فیلدها نباید خالی باشند.", 'error'); return;} const res = await callAppsScript('updateStudentInfo', { courseId: currentCourseId, originalNationalId: currentStudentOriginalId, newName, newNationalId: newNid }, event.target); if (res.success) { showCustomAlert(res.message, 'success'); fetchDashboardData(); } else showCustomAlert(res.message, 'error'); closeAllModals(); }

    function showGradingModal(event, courseId, courseStartDate, studentName, studentNationalId) {
        const [jy, jm, jd] = courseStartDate.split('/').map(Number); const startDateGregorian = jalaliToGregorian(jy, jm, jd); const today = new Date(); startDateGregorian.setHours(0,0,0,0); today.setHours(0,0,0,0); const diffTime = today - startDateGregorian; const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        if (diffDays < 25) { showCustomAlert(`نمره‌دهی هنوز امکان‌پذیر نیست. شما باید حداقل ۲۵ روز پس از شروع دوره صبر کنید.\n(گذشته: ${diffDays} روز از 25 روز)`, 'error'); return; }
        currentCourseId = courseId; currentStudentOriginalId = studentNationalId; const content = `<p><strong>نام:</strong> ${studentName} | <strong>کد ملی:</strong> ${studentNationalId}</p><hr><div class="form-group"><label>صحت حروف (از بیست نمره)</label><input type="number" id="g1" min="0" max="20"></div><div class="form-group"><label>صحت حرکات (از بیست نمره)</label><input type="number" id="g2" min="0" max="20"></div><div class="form-group"><label>حروف ناخوانا (از بیست نمره)</label><input type="number" id="g3" min="0" max="20"></div><div class="form-group"><label>وقف و ابتدا (از بیست نمره)</label><input type="number" id="g4" min="0" max="20"></div><div class="form-group"><label>التقاء ساکنین (از بیست نمره)</label><input type="number" id="g5" min="0" max="20"></div><button onclick="handleGradeSubmission(event)"><span class="btn-text">تایید و ارسال نمرات</span></button>`; renderModal('ثبت نمره برای قرآن آموز', content);
    }
    function handleGradeSubmission(event) { const grades = {}; for(let i=1; i<=5; i++) { const gradeVal = document.getElementById(`g${i}`).value; if(gradeVal === '' || isNaN(gradeVal) || gradeVal < 0 || gradeVal > 20) { showCustomAlert(`نمره برای همه موارد باید عددی بین 0 و 20 باشد.`, 'error'); return; } grades[`g${i}`] = Number(gradeVal); } showCustomAlert("آیا از ثبت نمرات اطمینان دارید؟ نمرات پس از ثبت قابل ویرایش نیستند.", 'confirm', async () => { const res = await callAppsScript('submitStudentGrades', { courseId: currentCourseId, studentNationalId: currentStudentOriginalId, grades }, event.target); if (res.success) { showCustomAlert(res.message, 'success'); fetchDashboardData(); } else showCustomAlert(res.message, 'error'); closeAllModals(); }); }
</script>
</body>
</html>
