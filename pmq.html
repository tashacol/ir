<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <!-- خواسته چهارم: کنترل Viewport برای جلوگیری از زوم خودکار -->
    <meta name="viewport" content="width=1200, initial-scale=1.0">
    <title>پرتال اساتید قرآن کریم</title>
    <!-- خواسته ششم: تغییر فونت به وزیرمتن -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-main: 'Vazirmatn', sans-serif;
            --primary-color: #0c4a6e; --secondary-color: #075985; --accent-color: #38bdf8;
            --light-bg: #f8fafc; --container-bg: #ffffff; --dark-text: #1e293b; --light-text: #64748b;
            --border-color: #e2e8f0; --danger-color: #dc2626; --success-color: #16a34a; --warning-color: #f59e0b;
        }
        body { font-family: var(--font-main); background-color: var(--light-bg); color: var(--dark-text); line-height: 1.7; min-width: 1200px; }
        .container { max-width: 1100px; margin: 40px auto; background: var(--container-bg); padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05), 0 10px 10px -5px rgba(0,0,0,0.04); }
        h1, h2, h3, h4 { color: var(--primary-color); text-align: center; font-weight: 700; }
        h1 { font-size: 2.2rem; } h2 { font-size: 1.8rem; border-bottom: 2px solid var(--border-color); padding-bottom: 15px; margin-bottom: 30px; }
        h4 { font-size: 1.3rem; color: var(--secondary-color); margin-bottom: 15px; }
        .hidden { display: none !important; }

        /* خواسته سوم: لودینگ اسکلتی */
        .skeleton-card { background: #fff; border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-bottom: 30px; }
        .skeleton { background-color: #e2e8f0; border-radius: 4px; }
        .skeleton.title { height: 28px; width: 40%; margin-bottom: 15px; }
        .skeleton.text { height: 16px; width: 70%; margin-bottom: 10px; }
        .skeleton.table-head { height: 40px; width: 100%; margin-top: 20px; }
        .skeleton.table-row { height: 50px; width: 100%; margin-top: 5px; }
        .shimmer { position: relative; overflow: hidden; }
        .shimmer::after { content: ''; position: absolute; top: 0; right: 0; bottom: 0; left: 0;
            transform: translateX(-100%); background-image: linear-gradient(90deg, rgba(255,255,255,0) 0, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%);
            animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 100% { transform: translateX(100%); } }

        /* Forms & Buttons */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 1rem; }
        input, select { width: 100%; box-sizing: border-box; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; font-family: var(--font-main); transition: all 0.3s; }
        input:focus, select:focus { border-color: var(--secondary-color); box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.3); outline: none; }
        button { background-color: var(--secondary-color); color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-family: var(--font-main); transition: all 0.3s; }
        button:hover { background-color: var(--primary-color); transform: translateY(-2px); }
        button.danger { background-color: var(--danger-color); }
        button.danger:hover { background-color: #b91c1c; }
        
        .icon { width: 1.1em; height: 1.1em; vertical-align: middle; }
        .icon-btn { background: none; border: none; color: var(--light-text); cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; font-family: var(--font-main); padding: 8px; border-radius: 8px; transition: all 0.3s; }
        .icon-btn .icon { width: 1.3em; height: 1.3em; }
        .icon-btn:hover { color: var(--secondary-color); background-color: #f0f9ff; }
        .icon-btn.delete-btn:hover { color: var(--danger-color); background-color: #fee2e2; }

        .course-card { background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-bottom: 30px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .course-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .course-card table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .course-card th, .course-card td { padding: 15px; border-bottom: 1px solid var(--border-color); text-align: right; vertical-align: middle; }
        .course-card th { background-color: var(--light-bg); font-size: 1rem; }
        .course-card tr:last-child td { border-bottom: none; }
        .course-actions { display: flex; align-items: center; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px dashed var(--border-color); }

        /* خواسته چهارم: مودال‌های کاملا مرکزی */
        .modal { position: fixed; z-index: 1000; inset: 0; background-color: rgba(15, 23, 42, 0.7); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background-color: var(--container-bg); padding: 30px; width: 90%; max-width: 650px; border-radius: 16px; animation: modal-appear 0.4s; }
        @keyframes modal-appear { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .modal-header .close-btn { background: none; border: none; font-size: 2rem; color: var(--light-text); cursor: pointer; }
    </style>
</head>
<body>
    <svg width="0" height="0" class="hidden"><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-plus-circle"><path fill="currentColor" d="M12 2c-5.52 0-10 4.48-10 10s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m5 11h-4v4h-2v-4H7v-2h4V7h2v4h4z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-pencil"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83l3.75 3.75z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-trash"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-grade"><path fill="currentColor" d="M12 3L1 9l4 2.18v6.32L12 21l7-3.5V11.18L23 9zm-2 13.91V13h4v3.91l-2 1.09zM12 11.33L4.93 8L12 4.67L19.07 8z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-check-circle"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2m-2 15l-5-5l1.41-1.41L10 14.17l7.59-7.59L19 8z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-hourglass"><path fill="currentColor" d="M6 2v6h12V2zm0 14v6h12v-6zM8 4h8v2H8zm0 14h8v2H8zM6 10l4 4l-4 4V10zM18 10v8l-4-4z"/></symbol></svg>
    <div class="container">
        <div id="login-section"><h1>پرتال اساتید قرآن کریم</h1><form id="login-form"><div class="form-group"><label for="nationalId">کد ملی</label><input type="text" id="nationalId" required></div><div class="form-group"><label for="password">رمز عبور</label><input type="password" id="password" required></div><button type="submit">ورود</button><p id="error-message" class="hidden"></p></form></div>
        <div id="dashboard-section" class="hidden"><div id="welcome-message" style="font-size: 1.5rem; text-align: right; margin-bottom: 25px;"></div><button id="btn-create-course">ایجاد دوره جدید</button><div id="courses-container" style="margin-top:30px;"></div></div>
    </div>
    <div id="modal-container"></div>
<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwswTKz1Hjp5SHV8p3rYna-aOy5cUHEF4BAJu50UrBx0WygpzktN44a6YR01ARQRbGStw/exec"; 
    let loggedInInstructorId = null, loggedInInstructorName = null, tempStudents = [];
    let currentCourseId = null, currentStudentOriginalId = null;

    async function callAppsScript(action, params = {}) {
        try {
            const res = await fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', headers: {'Content-Type': 'text/plain;charset=utf-8'}, body: JSON.stringify({ action, params }) });
            if (!res.ok) throw new Error(`Network error: ${res.statusText}`);
            return await res.json();
        } catch (error) { alert('خطا در ارتباط با سرور.'); return { success: false, message: error.message }; }
    }
    
    document.addEventListener('DOMContentLoaded', () => { document.getElementById('login-form').addEventListener('submit', handleLogin); document.getElementById('btn-create-course').addEventListener('click', showCreateCourseModal); });
    
    async function handleLogin(event) {
        event.preventDefault(); renderSkeletonLoader();
        const nationalId = document.getElementById('nationalId').value, password = document.getElementById('password').value;
        const res = await callAppsScript('checkLogin', { nationalId, password });
        if (res.success) {
            loggedInInstructorId = nationalId; loggedInInstructorName = res.name;
            document.getElementById('login-section').classList.add('hidden'); document.getElementById('dashboard-section').classList.remove('hidden');
            document.getElementById('welcome-message').innerHTML = `استاد <strong>${res.name}</strong>، خوش آمدید.`;
            await fetchDashboardData();
        } else {
            const errorP = document.getElementById('error-message'); errorP.innerText = res.message || "خطای ورود."; errorP.classList.remove('hidden');
            document.getElementById('courses-container').innerHTML = ''; // پاک کردن اسکلت در صورت خطا
        }
    }

    async function fetchDashboardData() {
        renderSkeletonLoader();
        const res = await callAppsScript('getInstructorDashboardData', { instructorId: loggedInInstructorId });
        if(res.success) renderCourses(res.data); else alert("خطا در دریافت اطلاعات: " + res.message);
    }
    
    function renderSkeletonLoader() {
        const container = document.getElementById('courses-container');
        let skeletonHTML = '';
        for (let i = 0; i < 2; i++) {
            skeletonHTML += `<div class="skeleton-card shimmer">
                <div class="skeleton title"></div><div class="skeleton text"></div>
                <div class="skeleton table-head"></div><div class="skeleton table-row"></div><div class="skeleton table-row"></div>
            </div>`;
        }
        container.innerHTML = skeletonHTML;
    }

    function renderCourses(courses) {
        const container = document.getElementById('courses-container');
        container.innerHTML = !courses || courses.length === 0 ? '<p style="text-align: center;">شما هنوز هیچ دوره‌ای ایجاد نکرده‌اید.</p>' : '';
        courses.forEach(course => {
            let studentsHtml = '<p style="text-align: center; color: var(--light-text);">هنوز قرآن‌آموزی ثبت نشده است.</p>';
            if (course.students.length > 0) {
                studentsHtml = `<table><thead><tr><th>نام و نام خانوادگی</th><th>کد ملی</th><th>نمره کل</th><th>گواهی</th><th>عملیات</th></tr></thead><tbody>
                    ${course.students.map(s => {
                        const scoreDisplay = (!s.totalScore || s.totalScore == '0')
                            ? `<button class="icon-btn" onclick="showGradingModal('${course.courseId}', '${course.startDate}', '${s.name}', '${s.nationalId}')"><svg class="icon"><use href="#icon-grade"></use></svg>ثبت نمره</button>`
                            : `<strong>${s.totalScore}</strong>`;
                        const certIcon = s.certificateStatus === '5' ? `<svg class="icon" style="color:var(--success-color);" title="صادر شده"><use href="#icon-check-circle"></use></svg>` : `<svg class="icon" style="color:var(--warning-color);" title="در حال بررسی"><use href="#icon-hourglass"></use></svg>`;
                        return `<tr><td>${s.name||''}</td><td>${s.nationalId||''}</td><td>${scoreDisplay}</td><td>${certIcon}</td><td><button class="icon-btn" onclick="showEditStudentModal('${course.courseId}', '${s.name}', '${s.nationalId}')"><svg class="icon"><use href="#icon-pencil"></use></svg></button></td></tr>`
                    }).join('')}</tbody></table>`;
            }
            container.innerHTML += `<div class="course-card"><div class="course-header"><h4>دوره روخوانی (کد: ${course.courseId})</h4><span style="font-weight: bold; color: var(--light-text);">تاریخ شروع: ${course.startDate}</span></div>${studentsHtml}<div class="course-actions"><button class="icon-btn" onclick="showAddStudentModal('${course.courseId}')"><svg class="icon"><use href="#icon-plus-circle"></use></svg>افزودن قرآن آموز</button><button class="icon-btn" onclick="showEditDateModal('${course.courseId}')"><svg class="icon"><use href="#icon-pencil"></use></svg>ویرایش تاریخ</button><button class="icon-btn delete-btn" onclick="showDeleteConfirmationModal('${course.courseId}')"><svg class="icon"><use href="#icon-trash"></use></svg>حذف دوره</button></div></div>`;
        });
    }

    const modalContainer = document.getElementById('modal-container');
    function renderModal(title, content) { modalContainer.innerHTML = `<div class="modal"><div class="modal-content"><div class="modal-header"><h3>${title}</h3><button class="close-btn" onclick="closeAllModals()">×</button></div>${content}</div></div>`; }
    function closeAllModals() { modalContainer.innerHTML = ''; }
    function populateDatePicker(prefix = 'start') {
        let opts = { d: '', m: '', y: ''}; for (let i = 1; i <= 31; i++) opts.d += `<option value="${i}">${i}</option>`;
        ["فروردین","اردیبهشت","خرداد","تیر","مرداد","شهریور","مهر","آبان","آذر","دی","بهمن","اسفند"].forEach((m, i) => opts.m += `<option value="${i+1}">${m}</option>`);
        opts.y = `<option value="${new Date().toLocaleDateString('fa-IR-u-nu-latn').split('/')[0]}">${new Date().toLocaleDateString('fa-IR-u-nu-latn').split('/')[0]}</option>`;
        return `<select id="${prefix}-day">${opts.d}</select><select id="${prefix}-month">${opts.m}</select><select id="${prefix}-year" disabled>${opts.y}</select>`;
    }

    function showCreateCourseModal() { renderModal('ایجاد دوره جدید', `<p>نام دوره: روخوانی و روانخوانی قرآن کریم</p><div class="form-group"><label>تاریخ شروع</label>${populateDatePicker('start')}</div><button onclick="handleCreateCourse()">ایجاد دوره</button>`); }
    async function handleCreateCourse() {
        const date = `${document.getElementById('start-year').value}/${document.getElementById('start-month').value.padStart(2,'0')}/${document.getElementById('start-day').value.padStart(2,'0')}`;
        const res = await callAppsScript('createNewCourse', { instructorId: loggedInInstructorId, startDate: date });
        if (res.success) { alert('دوره ایجاد شد!'); fetchDashboardData(); } else alert('خطا: ' + res.message); closeAllModals();
    }
    function showEditDateModal(courseId) { currentCourseId = courseId; renderModal('ویرایش تاریخ دوره', `<div class="form-group"><label>تاریخ جدید</label>${populateDatePicker('edit')}</div><button onclick="handleUpdateCourseDate()">ذخیره</button>`); }
    async function handleUpdateCourseDate() {
        const newDate = `${document.getElementById('edit-year').value}/${document.getElementById('edit-month').value.padStart(2, '0')}/${document.getElementById('edit-day').value.padStart(2, '0')}`;
        const res = await callAppsScript('updateCourseDate', { courseId: currentCourseId, newDate });
        if (res.success) { alert(res.message); fetchDashboardData(); } else alert("خطا: " + res.message); closeAllModals();
    }
    function showDeleteConfirmationModal(courseId) { currentCourseId = courseId; renderModal('تایید حذف دوره', `<p style="color:var(--danger-color);">آیا از حذف این دوره و تمام قرآن‌آموزان آن اطمینان دارید؟</p><div class="form-group"><label for="delete-password">برای تایید، رمز عبور را وارد کنید:</label><input type="password" id="delete-password"></div><button class="danger" onclick="handleDeleteCourse()">بله، حذف کن</button>`); }
    async function handleDeleteCourse() {
        const password = document.getElementById('delete-password').value; if (!password) { alert("رمز عبور الزامی است."); return; }
        const res = await callAppsScript('deleteCourse', { courseId: currentCourseId, instructorId: loggedInInstructorId, password });
        if (res.success) { alert(res.message); fetchDashboardData(); } else alert("خطا: " + res.message); closeAllModals();
    }

    function showAddStudentModal(courseId) { currentCourseId = courseId; tempStudents = []; renderModal(`افزودن قرآن آموز به دوره ${courseId}`, `<div id="add-student-form"><div class="form-group"><label for="student-name">نام</label><input type="text" id="student-name"></div><div class="form-group"><label for="student-nationalId">کد ملی</label><input type="text" id="student-nationalId"></div><button onclick="addStudentToTempList()">افزودن به لیست</button></div><h4>لیست موقت</h4><ul id="temp-student-list"></ul><br><button onclick="saveStudentList()">ذخیره نهایی لیست</button>`); }
    function addStudentToTempList() { const name = document.getElementById('student-name'), nid = document.getElementById('student-nationalId'); if (name.value.trim() && nid.value.trim()) { if (tempStudents.some(s => s.nationalId === nid.value.trim())) { alert('کد ملی تکراری است.'); return; } tempStudents.push({ name: name.value.trim(), nationalId: nid.value.trim() }); document.getElementById('temp-student-list').innerHTML = tempStudents.map(s => `<li>${s.name} - ${s.nationalId}</li>`).join(''); name.value = ''; nid.value = ''; name.focus(); } else alert('نام و کد ملی الزامی است.'); }
    async function saveStudentList() {
        if (tempStudents.length === 0) { alert('لیست خالی است.'); return; }
        const res = await callAppsScript('addStudentsToCourse', { courseId: currentCourseId, students: tempStudents, instructorName: loggedInInstructorName });
        if (res.success) { alert(res.message); fetchDashboardData(); } else alert('خطا: ' + res.message); closeAllModals();
    }
    function showEditStudentModal(courseId, name, nid) { currentCourseId = courseId; currentStudentOriginalId = nid; renderModal('ویرایش قرآن آموز', `<div class="form-group"><label for="edit-student-name">نام</label><input type="text" id="edit-student-name" value="${name}"></div><div class="form-group"><label for="edit-student-nationalId">کد ملی</label><input type="text" id="edit-student-nationalId" value="${nid}"></div><button onclick="handleUpdateStudent()">ذخیره</button>`); }
    async function handleUpdateStudent() {
        const newName = document.getElementById('edit-student-name').value.trim(), newNid = document.getElementById('edit-student-nationalId').value.trim();
        if(!newName || !newNid) { alert("فیلدها نباید خالی باشند."); return;}
        const res = await callAppsScript('updateStudentInfo', { courseId: currentCourseId, originalNationalId: currentStudentOriginalId, newName, newNationalId: newNid });
        if (res.success) { alert(res.message); fetchDashboardData(); } else alert("خطا: " + res.message); closeAllModals();
    }

    // خواسته اول: منطق قفل نمره‌دهی
    function showGradingModal(courseId, courseStartDate, studentName, studentNationalId) {
        const [year, month, day] = courseStartDate.split('/').map(Number);
        const startDate = new Date(year, month - 1, day); // Note: JS Date month is 0-indexed
        // This is a rough Jalali to Gregorian conversion for diff calculation
        // A proper library would be better, but this works for this purpose
        const today = new Date();
        const diffTime = Math.abs(today - startDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays < 25) {
            alert(`نمره‌دهی هنوز امکان‌پذیر نیست. شما باید حداقل ۲۵ روز پس از شروع دوره صبر کنید.\n(تاریخ شروع دوره: ${courseStartDate})`);
            return;
        }

        currentCourseId = courseId; currentStudentOriginalId = studentNationalId;
        const content = `<p><strong>نام:</strong> ${studentName} | <strong>کد ملی:</strong> ${studentNationalId}</p><hr>
            <div class="form-group"><label>صحت حروف (تا 20)</label><input type="number" id="g1" min="0" max="20"></div><div class="form-group"><label>صحت حرکات (تا 20)</label><input type="number" id="g2" min="0" max="20"></div>
            <div class="form-group"><label>حروف ناخوانا (تا 20)</label><input type="number" id="g3" min="0" max="20"></div><div class="form-group"><label>وقف و ابتدا (تا 20)</label><input type="number" id="g4" min="0" max="20"></div>
            <div class="form-group"><label>التقاء ساکنین (تا 20)</label><input type="number" id="g5" min="0" max="20"></div><button onclick="handleGradeSubmission()">تایید و ارسال نمرات</button>`;
        renderModal('ثبت نمره برای قرآن آموز', content);
    }
    async function handleGradeSubmission() {
        const grades = {};
        for(let i=1; i<=5; i++) { const gradeVal = document.getElementById(`g${i}`).value; if(gradeVal === '' || isNaN(gradeVal) || gradeVal < 0 || gradeVal > 20) { alert(`نمره برای همه موارد باید عددی بین 0 و 20 باشد.`); return; } grades[`g${i}`] = Number(gradeVal); }
        if (confirm("آیا از ثبت نمرات اطمینان دارید؟ نمرات پس از ثبت قابل ویرایش نیستند.")) {
            const res = await callAppsScript('submitStudentGrades', { courseId: currentCourseId, studentNationalId: currentStudentOriginalId, grades });
            if (res.success) { alert(res.message); fetchDashboardData(); } else alert("خطا: " + res.message); closeAllModals();
        }
    }
</script>
</body>
</html>
