<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1400">
    <title>پرتال اساتید قرآن کریم</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --font-main: 'Vazirmatn', sans-serif;
            --primary: #0d6efd; --primary-light: #e7f3ff; --primary-dark: #0056b3;
            --text-dark: #212529; --text-light: #6c757d; --text-on-dark: #ffffff;
            --bg-main: #f8f9fa; --bg-card: #ffffff; --border-color: #e9ecef;
            --success: #198754; --danger: #dc3545; --warning: #ffc107; --info: #0dcaf0;
            --shadow: 0 4px 25px rgba(0,0,0,0.08); --radius-lg: 16px; --radius-md: 12px;
            --transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-main); background-color: var(--bg-main); color: var(--text-dark); line-height: 1.7; min-width: 1400px; margin:0; }
        .hidden { display: none !important; }

        #login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .login-box { width: 100%; max-width: 420px; background: var(--bg-card); padding: 40px; border-radius: var(--radius-lg); box-shadow: var(--shadow); text-align: center; }
        .login-box .logo { color: var(--primary); font-size: 3rem; margin-bottom: 20px; }
        .login-box h1 { font-size: 1.8rem; margin-bottom: 8px; }
        .login-box p { color: var(--text-light); margin-bottom: 30px; }
        .input-wrapper { position: relative; margin-bottom: 20px; }
        .input-icon { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); color: var(--text-light); }
        .form-input { width: 100%; padding: 14px 50px 14px 15px; border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem; outline: none; transition: var(--transition); background: var(--bg-main); }
        .form-input:focus { border-color: var(--primary); background: var(--bg-card); box-shadow: 0 0 0 3px var(--primary-light); }
        
        .dashboard-container { max-width: 1200px; margin: 30px auto; padding: 0 30px; }
        
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .welcome-message { font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .header-loader { width: 24px; height: 24px; border: 3px solid var(--border-color); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; display: none;}
        .dashboard-header.loading .header-loader { display: block; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .btn { position:relative; background-color: var(--primary); color: var(--text-on-dark); padding: 12px 30px; border: none; border-radius: var(--radius-md); cursor: pointer; font-size: 1rem; font-family: var(--font-main); transition: var(--transition); display: inline-flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none;}
        .btn:hover:not(:disabled) { background: var(--primary-dark); transform: translateY(-2px); }
        .btn:disabled { background: #94a3b8; cursor: not-allowed; }
        .btn.btn-danger { background-color: var(--danger); } .btn.btn-danger:hover:not(:disabled) { background-color: #a71d2a; }
        .btn-loading .btn-text { visibility: hidden; }
        .btn-loading::after { content: ''; position: absolute; width: 20px; height: 20px; top: 0; left: 0; right: 0; bottom: 0; margin: auto; border: 3px solid transparent; border-top-color: #ffffff; border-radius: 50%; animation: spin 1s ease infinite; }
        
        .card { background: var(--bg-card); border-radius: var(--radius-lg); box-shadow: var(--shadow); padding: 25px; margin-bottom: 30px; }
        .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .card-header h4 { font-size: 1.3rem; margin: 0; }
        .card table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .card th, .card td { padding: 15px; border-bottom: 1px solid var(--border-color); text-align: right; vertical-align: middle; }
        .card th { font-weight: 500; color: var(--text-light); font-size: 0.9rem; }
        .card tr:last-child td { border-bottom: none; }
        .course-actions { display: flex; align-items: center; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px dashed var(--border-color); }
        .student-actions { display: flex; align-items: center; gap: 5px; }
        .btn-icon { background: none; border: none; color: var(--text-light); cursor: pointer; display: inline-flex; padding: 8px; border-radius: 50%; transition: var(--transition); }
        .btn-icon:hover:not(:disabled) { color: var(--primary); background-color: var(--primary-light); }
        .btn-icon.delete:hover:not(:disabled) { color: var(--danger); background-color: #ffebe9; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); animation: fadeIn 0.3s; padding: 20px;}
        .modal-overlay.show { display: flex; }
        .modal-box { background: var(--bg-card); padding: 30px; border-radius: var(--radius-lg); width: 100%; max-width: 650px; box-shadow: var(--shadow); animation: modal-pop-in 0.3s ease-out; }
        @keyframes modal-pop-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .modal-header h3 { margin: 0; }
        .modal-close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); }
        
        .alert-modal-box { max-width: 450px; text-align: center; }
        .alert-icon { font-size: 4rem; margin-bottom: 15px; }
        .alert-icon.success { color: var(--success); } .alert-icon.error { color: var(--danger); } .alert-icon.confirm { color: var(--warning); }
        .alert-message { font-size: 1.1rem; color: var(--text-dark); margin-bottom: 25px; }
        .alert-buttons { display: flex; justify-content: center; gap: 15px; }
        .alert-buttons button.secondary { background-color: var(--border-color); color: var(--text-dark); }
        .alert-buttons button.secondary:hover { background-color: #cbd5e1; }

        .skeleton.btn { height: 48px; width: 180px; margin-bottom: 30px; }
    </style>
</head>
<body>
    <div id="login-container">
        <div class="login-box" id="login-section">
            <i class="fas fa-quran logo"></i>
            <h1>پرتال اساتید</h1>
            <p>برای ورود به سامانه اطلاعات خود را وارد کنید.</p>
            <form id="login-form">
                <div class="input-wrapper"><i class="fas fa-id-card input-icon"></i><input type="tel" inputmode="numeric" pattern="[0-9]*" id="nationalId" class="form-input" placeholder="کد ملی" required></div>
                <div class="input-wrapper"><i class="fas fa-lock input-icon"></i><input type="password" id="password" class="form-input" placeholder="رمز عبور" required></div>
                <button type="submit" class="btn" style="width: 100%;"><span class="btn-text">ورود به پنل</span></button>
            </form>
            <p id="error-message" class="hidden" style="margin-top: 15px; color: var(--danger); min-height: 20px; font-weight: 500;"></p>
        </div>
    </div>
    
    <div id="dashboard-section" class="hidden">
        <div class="dashboard-container">
            <div class="dashboard-header">
                <div class="welcome-message">
                    <span id="welcome-text"></span>
                    <div class="header-loader"></div>
                </div>
                <button id="logout-btn" class="btn btn-danger"><i class="fas fa-sign-out-alt"></i><span class="btn-text">خروج</span></button>
            </div>
            <div id="create-course-container"><button id="btn-create-course" class="btn"><i class="fas fa-plus"></i><span class="btn-text">ایجاد دوره جدید</span></button></div>
            <div id="courses-container" style="margin-top:30px;"></div>
        </div>
    </div>
    <div id="modal-container"></div>
<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrKgoFDb7Yt1xoxbACi4Oje8mzZRFAwyL07TXvtTl1zqrAj4R-dGYb2txHgJPrg-P8mw/exec";
    const sessionKey = 'quranTeacherSession';
    let loggedInInstructorId = null, loggedInInstructorName = null, tempStudents = []; let currentCourseId = null, currentStudentOriginalId = null;
    let existingStudentsByCourse = {};

    async function callAppsScript(action, params = {}, button = null) {
        if(button) setButtonLoading(button, true);
        try { const res = await fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', headers: {'Content-Type': 'text/plain;charset=utf-8'}, body: JSON.stringify({ action, params }) }); if (!res.ok) throw new Error(`Network error`); return await res.json();
        } catch (error) { showCustomAlert('خطا در ارتباط با سرور.', 'error'); return { success: false, message: error.message };
        } finally { if(button) setButtonLoading(button, false); }
    }
    
    function setButtonLoading(button, isLoading) { if(!button) return; if(isLoading) { button.disabled = true; button.classList.add('btn-loading'); } else { button.disabled = false; button.classList.remove('btn-loading'); } }
    
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('login-form').addEventListener('submit', handleManualLogin);
        document.getElementById('btn-create-course').addEventListener('click', e => showCreateCourseModal(e.target));
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        const savedSession = localStorage.getItem(sessionKey);
        if (savedSession) { const { nationalId, name } = JSON.parse(savedSession); showDashboard(nationalId, name); }
    });

    function showDashboard(nationalId, name) {
        loggedInInstructorId = nationalId; loggedInInstructorName = name;
        document.getElementById('login-container').classList.add('hidden'); document.getElementById('dashboard-section').classList.remove('hidden');
        document.getElementById('welcome-text').innerHTML = `استاد <strong>${name}</strong>، خوش آمدید.`;
        fetchDashboardData();
    }
    
    async function handleManualLogin(event) {
        event.preventDefault(); const nationalId = document.getElementById('nationalId').value; const password = document.getElementById('password').value;
        const res = await callAppsScript('checkLogin', { nationalId, password }, event.target.querySelector('button'));
        if (res.success) { localStorage.setItem(sessionKey, JSON.stringify({ nationalId: nationalId, name: res.name })); showDashboard(nationalId, res.name);
        } else { const errorP = document.getElementById('error-message'); errorP.innerText = res.message || "خطای ورود."; errorP.classList.remove('hidden'); }
    }

    function handleLogout() { localStorage.removeItem(sessionKey); window.location.reload(); }

    async function fetchDashboardData() {
        renderSkeletonLoader();
        document.querySelector('.dashboard-header').classList.add('loading');
        const res = await callAppsScript('getInstructorDashboardData', { instructorId: loggedInInstructorId });
        document.querySelector('.dashboard-header').classList.remove('loading');
        if(res.success) renderCourses(res.data); else showCustomAlert("خطا در دریافت اطلاعات: " + res.message, 'error'); return true;
    }
    
    function renderSkeletonLoader() { 
        document.getElementById('create-course-container').innerHTML = '<div class="skeleton btn" style="display: inline-block;"></div>';
        let skeletonHTML = ''; for (let i = 0; i < 2; i++) { skeletonHTML += `<div class="skeleton-card shimmer"><div class="skeleton title"></div><div class="skeleton text"></div><div class="skeleton table-head"></div><div class="skeleton table-row"></div><div class="skeleton table-row"></div></div>`; } 
        document.getElementById('courses-container').innerHTML = skeletonHTML;
    }

    function renderCourses(courses) {
        document.getElementById('create-course-container').innerHTML = '<button id="btn-create-course" class="btn"><i class="fas fa-plus"></i><span class="btn-text">ایجاد دوره جدید</span></button>';
        document.getElementById('btn-create-course').addEventListener('click', e => showCreateCourseModal(e.target));
        const container = document.getElementById('courses-container'); container.innerHTML = !courses || courses.length === 0 ? '<p style="text-align: center;">شما هنوز هیچ دوره‌ای ایجاد نکرده‌اید.</p>' : '';
        existingStudentsByCourse = {};
        courses.forEach(course => {
            existingStudentsByCourse[course.courseId] = new Set(course.students.map(s => s.nationalId));
            const startDate = jalaliToGregorian(course.startDate.split('/').map(Number)[0], course.startDate.split('/').map(Number)[1], course.startDate.split('/').map(Number)[2]);
            const today = new Date(); startDate.setHours(0,0,0,0); today.setHours(0,0,0,0);
            const diffDays = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24));
            const canAddStudent = diffDays < 25; const canDeleteCourse = diffDays < 20; const canEditDate = diffDays <= 0;
            let addStudentBtn = canAddStudent ? `<button class="btn-icon" onclick="showAddStudentModal(event, '${course.courseId}')" title="افزودن قرآن آموز"><i class="fas fa-user-plus"></i></button>` : '';
            let editDateBtn = canEditDate ? `<button class="btn-icon" onclick="showEditDateModal(event, '${course.courseId}')" title="ویرایش تاریخ"><i class="fas fa-calendar-edit"></i></button>` : '';
            let deleteCourseBtn = canDeleteCourse ? `<button class="btn-icon delete" onclick="showDeleteCourseModal(event, '${course.courseId}')" title="حذف دوره"><i class="fas fa-trash-alt"></i></button>` : '';
            
            let studentsHtml = '<p style="text-align: center; color: var(--text-light);">هنوز قرآن‌آموزی ثبت نشده است.</p>';
            if (course.students.length > 0) {
                studentsHtml = `<table><thead><tr><th>نام و نام خانوادگی</th><th>کد ملی</th><th>نمره کل</th><th>وضعیت گواهی</th><th>عملیات</th></tr></thead><tbody>
                    ${course.students.map(s => {
                        const hasGrade = s.totalScore && s.totalScore != '0';
                        let scoreDisplay = !hasGrade ? `<button class="btn-icon" onclick="showGradingModal(event, '${course.courseId}', '${course.startDate}', '${s.name}', '${s.nationalId}')" title="ثبت نمره"><i class="fas fa-star-half-alt"></i></button>` : `<strong>${s.totalScore}</strong>`;
                        let certStatusDisplay = ''; let studentActionsDisplay = '';
                        if (hasGrade) {
                            switch(s.certificateStatus) {
                                case '0': certStatusDisplay = `<span style="color: var(--danger); font-weight: bold;">مردود</span>`; studentActionsDisplay = `<span style="color: var(--danger); font-size: 1.5rem; font-weight: bold;">—</span>`; break;
                                case '2': certStatusDisplay = `<span>بررسی</span>`; studentActionsDisplay = ``; break;
                                case '5': certStatusDisplay = `<span style="color: var(--success); font-weight: bold;">صدور</span>`; studentActionsDisplay = `<a href="https://tashacol.ir/equran.html" target="_blank" class="btn-icon" title="مشاهده گواهی"><i class="fas fa-star" style="color:var(--warning);"></i></a>`; break;
                                default: certStatusDisplay = ''; studentActionsDisplay = '';
                            }
                        } else { studentActionsDisplay = `<div class="student-actions"><button class="btn-icon" onclick="showEditStudentModal(event, '${course.courseId}', '${s.name}', '${s.nationalId}')" title="ویرایش"><i class="fas fa-edit"></i></button><button class="btn-icon delete" onclick="showDeleteStudentModal(event, '${course.courseId}', '${s.name}', '${s.nationalId}')" title="حذف"><i class="fas fa-user-minus"></i></button></div>`; }
                        return `<tr><td>${s.name||''}</td><td>${s.nationalId||''}</td><td>${scoreDisplay}</td><td>${certStatusDisplay}</td><td>${studentActionsDisplay}</td></tr>`
                    }).join('')}</tbody></table>`;
            }
            container.innerHTML += `<div class="card"><div class="card-header"><h4>دوره روخوانی (کد: ${course.courseId})</h4><span style="font-weight: bold; color: var(--text-light);">تاریخ شروع: ${course.startDate}</span></div>${studentsHtml}<div class="course-actions">${addStudentBtn}${editDateBtn}${deleteCourseBtn}</div></div>`;
        });
    }

    const modalContainer = document.getElementById('modal-container');
    function renderModal(title, content) { modalContainer.innerHTML = `<div class="modal-overlay show"><div class="modal-box"><div class="modal-header"><h3>${title}</h3><button class="modal-close-btn" onclick="closeAllModals()"><i class="fas fa-times"></i></button></div>${content}</div></div>`; }
    function closeAllModals() { modalContainer.innerHTML = ''; }
    
    function showCustomAlert(message, type = 'info') {
        const icons = { success: 'fa-check-circle', error: 'fa-times-circle', info: 'fa-info-circle' };
        const iconClass = type;
        const content = `<div class="alert-icon ${iconClass}"><i class="fas ${icons[type]}"></i></div><p class="alert-message">${message}</p><div class="alert-buttons"><button class="btn" onclick="closeAllModals()"><span class="btn-text">باشه</span></button></div>`;
        modalContainer.innerHTML = `<div class="modal-overlay show"><div class="modal-box alert-modal-box">${content}</div></div>`;
    }
    function showCustomConfirm(message) {
        return new Promise((resolve) => {
            const content = `<div class="alert-icon confirm"><i class="fas fa-question-circle"></i></div><p class="alert-message">${message}</p><div class="alert-buttons"><button id="confirm-btn-yes" class="btn"><span class="btn-text">تایید</span></button><button id="confirm-btn-no" class="btn secondary"><span class="btn-text">لغو</span></button></div>`;
            modalContainer.innerHTML = `<div class="modal-overlay show"><div class="modal-box alert-modal-box">${content}</div></div>`;
            document.getElementById('confirm-btn-yes').onclick = () => { closeAllModals(); resolve(true); }; document.getElementById('confirm-btn-no').onclick = () => { closeAllModals(); resolve(false); };
        });
    }
    
    function getTodayJalaliString() { const p2e = s => s.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d)); return p2e(new Date().toLocaleDateString('fa-IR', {year: 'numeric', month: '2-digit', day: '2-digit'})); }
    function populateDatePicker() {
        let opts = { d: '', m: '', y: ''}; for (let i = 1; i <= 31; i++) opts.d += `<option value="${i}">${i}</option>`;
        ["فروردین","اردیبهشت","خرداد","تیر","مرداد","شهریور","مهر","آبان","آذر","دی","بهمن","اسفند"].forEach((m, i) => opts.m += `<option value="${i+1}">${m}</option>`);
        opts.y = `<option value="${new Date().toLocaleDateString('fa-IR-u-nu-latn').split('/')[0]}">${new Date().toLocaleDateString('fa-IR-u-nu-latn').split('/')[0]}</option>`;
        return `<select id="date-day">${opts.d}</select><select id="date-month">${opts.m}</select><select id="date-year" disabled>${opts.y}</select>`;
    }
    function jalaliToGregorian(jy, jm, jd) { var sal_a, gy, gm, gd, days; jy += 1595; days = -355668 + (365 * jy) + (~~(jy / 33) * 8) + ~~(((jy % 33) + 3) / 4) + jd + ((jm < 7) ? (jm - 1) * 31 : ((jm - 7) * 30) + 186); gy = 400 * ~~(days / 146097); days %= 146097; if (days > 36524) { gy += 100 * ~~(--days / 36524); days %= 36524; if (days >= 365) days++; } gy += 4 * ~~(days / 1461); days %= 1461; if (days > 365) { gy += ~~((days - 1) / 365); days = (days - 1) % 365; } gd = days + 1; sal_a = [0, 31, ((gy % 4 === 0 && gy % 100 !== 0) || (gy % 400 === 0)) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]; for (gm = 0; gm < 13 && gd > sal_a[gm]; gm++) gd -= sal_a[gm]; return new Date(gy, gm - 1, gd); }

    function showCreateCourseModal() { renderModal('ایجاد دوره جدید', `<p>نام دوره: روخوانی و روانخوانی قرآن کریم</p><div class="form-group"><label>تاریخ شروع</label>${populateDatePicker()}</div><button class="btn" onclick="handleCreateCourse(event)"><span class="btn-text">ایجاد دوره</span></button>`); }
    async function handleCreateCourse(event) {
        const date = `${document.getElementById('date-year').value}/${document.getElementById('date-month').value.padStart(2,'0')}/${document.getElementById('date-day').value.padStart(2,'0')}`;
        if (date < getTodayJalaliString()) { showCustomAlert("تاریخ انتخابی نمی‌تواند در گذشته باشد.", "error"); return; }
        const res = await callAppsScript('createNewCourse', { instructorId: loggedInInstructorId, startDate: date }, event.target);
        if (res.success) { showCustomAlert('دوره با موفقیت ایجاد شد!', 'success'); fetchDashboardData(); } else showCustomAlert('خطا: ' + res.message, 'error'); closeAllModals();
    }
    
    function showEditDateModal(event, courseId) { currentCourseId = courseId; renderModal('ویرایش تاریخ دوره', `<div class="form-group"><label>تاریخ جدید</label>${populateDatePicker()}</div><button class="btn" onclick="handleUpdateCourseDate(event)"><span class="btn-text">ذخیره</span></button>`); }
    async function handleUpdateCourseDate(event) {
        const newDate = `${document.getElementById('date-year').value}/${document.getElementById('date-month').value.padStart(2, '0')}/${document.getElementById('date-day').value.padStart(2, '0')}`;
        if (newDate < getTodayJalaliString()) { showCustomAlert("تاریخ انتخابی نمی‌تواند در گذشته باشد.", "error"); return; }
        const res = await callAppsScript('updateCourseDate', { courseId: currentCourseId, newDate }, event.target);
        if (res.success) { showCustomAlert(res.message, 'success'); fetchDashboardData(); } else showCustomAlert("خطا: " + res.message, 'error'); closeAllModals();
    }
    
    function showDeleteCourseModal(event, courseId) { currentCourseId = courseId; renderModal('تایید حذف دوره', `<p style="color:var(--danger-color);">آیا از حذف این دوره و تمام قرآن‌آموزان آن اطمینان دارید؟</p><div class="form-group"><label for="delete-password">برای تایید، رمز عبور را وارد کنید:</label><input type="password" id="delete-password"></div><button class="btn btn-danger" onclick="handleDeleteCourse(event)"><span class="btn-text">بله، حذف کن</span></button>`); }
    async function handleDeleteCourse(event) {
        const password = document.getElementById('delete-password').value; if (!password) { showCustomAlert("رمز عبور الزامی است.", 'error'); return; }
        const res = await callAppsScript('deleteCourse', { courseId: currentCourseId, instructorId: loggedInInstructorId, password }, event.target);
        if (res.success) { showCustomAlert(res.message, 'success'); fetchDashboardData(); } else showCustomAlert("خطا: " + res.message, 'error'); closeAllModals();
    }

    function showAddStudentModal(event, courseId) { currentCourseId = courseId; tempStudents = []; renderModal(`افزودن قرآن آموز به دوره ${courseId}`, `<div id="add-student-form"><div class="form-group"><label for="student-name">نام</label><input type="text" id="student-name"></div><div class="form-group"><label for="student-nationalId">کد ملی</label><input type="tel" inputmode="numeric" pattern="[0-9]*" id="student-nationalId"></div><button class="btn" onclick="addStudentToTempList(event)"><span class="btn-text">افزودن به لیست</span></button></div><h4>لیست موقت</h4><ul id="temp-student-list"></ul><br><button class="btn" onclick="saveStudentList(event)"><span class="btn-text">ذخیره نهایی لیست</span></button>`); }
    function addStudentToTempList() { const name = document.getElementById('student-name'), nid = document.getElementById('student-nationalId'); if (name.value.trim() && nid.value.trim()) { const nationalId = nid.value.trim(); if (tempStudents.some(s => s.nationalId === nationalId)) { showCustomAlert('این کد ملی در لیست موقت شما وجود دارد.', 'error'); return; } if (existingStudentsByCourse[currentCourseId] && existingStudentsByCourse[currentCourseId].has(nationalId)) { showCustomAlert('این قرآن‌آموز قبلاً در این دوره ثبت‌نام شده است.', 'error'); return; } tempStudents.push({ name: name.value.trim(), nationalId: nationalId }); document.getElementById('temp-student-list').innerHTML = tempStudents.map(s => `<li>${s.name} - ${s.nationalId}</li>`).join(''); name.value = ''; nid.value = ''; name.focus(); } else showCustomAlert('نام و کد ملی الزامی است.', 'error'); }
    async function saveStudentList(event) {
        if (tempStudents.length === 0) { showCustomAlert('لیست خالی است.', 'error'); return; }
        const res = await callAppsScript('addStudentsToCourse', { courseId: currentCourseId, students: tempStudents, instructorName: loggedInInstructorName }, event.target);
        if (res.success) { showCustomAlert(res.message, 'success'); fetchDashboardData(); } else showCustomAlert('خطا: ' + res.message, 'error'); closeAllModals();
    }
    
    function showEditStudentModal(event, courseId, name, nid) { currentCourseId = courseId; currentStudentOriginalId = nid; renderModal('ویرایش قرآن آموز', `<div class="form-group"><label for="edit-student-name">نام</label><input type="text" id="edit-student-name" value="${name}"></div><div class="form-group"><label for="edit-student-nationalId">کد ملی</label><input type="tel" inputmode="numeric" pattern="[0-9]*" id="edit-student-nationalId" value="${nid}"></div><button class="btn" onclick="handleUpdateStudent(event)"><span class="btn-text">ذخیره</span></button>`); }
    async function handleUpdateStudent(event) {
        const newName = document.getElementById('edit-student-name').value.trim(), newNid = document.getElementById('edit-student-nationalId').value.trim();
        if(!newName || !newNid) { showCustomAlert("فیلدها نباید خالی باشند.", 'error'); return;}
        const res = await callAppsScript('updateStudentInfo', { courseId: currentCourseId, originalNationalId: currentStudentOriginalId, newName, newNationalId: newNid }, event.target);
        if (res.success) { showCustomAlert(res.message, 'success'); fetchDashboardData(); } else showCustomAlert("خطا: " + res.message, 'error'); closeAllModals();
    }
    
    function showDeleteStudentModal(event, courseId, studentName, studentNationalId) { currentCourseId = courseId; currentStudentOriginalId = studentNationalId; renderModal('تایید حذف قرآن‌آموز', `<p>آیا از حذف قرآن‌آموز <strong>${studentName}</strong> (کد ملی: ${studentNationalId}) اطمینان دارید؟</p><p style="color:var(--danger-color);">این عمل غیرقابل بازگشت است.</p><button class="btn btn-danger" onclick="handleDeleteStudent(event)"><span class="btn-text">بله، حذف کن</span></button>`); }
    async function handleDeleteStudent(event) {
        const res = await callAppsScript('deleteStudent', { courseId: currentCourseId, studentNationalId: currentStudentOriginalId }, event.target);
        if (res.success) { showCustomAlert(res.message, 'success'); fetchDashboardData(); } else { showCustomAlert("خطا: " + res.message, 'error'); } closeAllModals();
    }

    function showGradingModal(event, courseId, courseStartDate, studentName, studentNationalId) {
        const [year, month, day] = courseStartDate.split('/').map(Number); const startDate = jalaliToGregorian(year, month, day); const today = new Date(); startDate.setHours(0,0,0,0); today.setHours(0,0,0,0); const diffDays = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24));
        if (diffDays < 25) { showCustomAlert(`امکان نمره‌دهی وجود ندارد.\nباید حداقل ۲۵ روز از تاریخ شروع دوره (${courseStartDate}) گذشته باشد.`, 'error'); return; }
        currentCourseId = courseId; currentStudentOriginalId = studentNationalId;
        const content = `<p><strong>نام:</strong> ${studentName} | <strong>کد ملی:</strong> ${studentNationalId}</p><hr>
            <div class="form-group"><label>صحت حروف (از بیست نمره)</label><input type="number" id="g1" min="0" max="20"></div><div class="form-group"><label>صحت حرکات (از بیست نمره)</label><input type="number" id="g2" min="0" max="20"></div>
            <div class="form-group"><label>حروف ناخوانا (از بیست نمره)</label><input type="number" id="g3" min="0" max="20"></div><div class="form-group"><label>وقف و ابتدا (از بیست نمره)</label><input type="number" id="g4" min="0" max="20"></div>
            <div class="form-group"><label>التقاء ساکنین (از بیست نمره)</label><input type="number" id="g5" min="0" max="20"></div><button class="btn" onclick="handleGradeSubmission(event)"><span class="btn-text">تایید و ارسال نمرات</span></button>`;
        renderModal('ثبت نمره برای قرآن آموز', content);
    }
    async function handleGradeSubmission(event) {
        const grades = {}; for(let i=1; i<=5; i++) { const gradeVal = document.getElementById(`g${i}`).value; if(gradeVal === '' || isNaN(gradeVal) || gradeVal < 0 || gradeVal > 20) { showCustomAlert(`نمره برای همه موارد باید عددی بین 0 و 20 باشد.`, 'error'); return; } grades[`g${i}`] = Number(gradeVal); }
        const confirmed = await showCustomConfirm("آیا از ثبت نمرات اطمینان دارید؟ نمرات پس از ثبت قابل ویرایش نیستند.");
        if (confirmed) {
            const res = await callAppsScript('submitStudentGrades', { courseId: currentCourseId, studentNationalId: currentStudentOriginalId, grades }, event.target);
            if (res.success) { showCustomAlert(res.message, 'success'); fetchDashboardData(); } else showCustomAlert("خطا: " + res.message, 'error'); closeAllModals();
        }
    }
</script>
</body>
</html>
