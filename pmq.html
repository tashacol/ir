<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1200, initial-scale=1.0">
    <title>پرتال اساتید قرآن کریم</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-main: 'Vazirmatn', sans-serif;
            --primary-color: #0c4a6e; --secondary-color: #075985; --accent-color: #38bdf8;
            --light-bg: #f8fafc; --container-bg: #ffffff; --dark-text: #1e293b; --light-text: #64748b;
            --border-color: #e2e8f0; --danger-color: #dc2626; --success-color: #16a34a; --warning-color: #f59e0b;
        }
        body { font-family: var(--font-main); background-color: var(--light-bg); color: var(--dark-text); line-height: 1.7; min-width: 1200px; margin:0; }
        .hidden { display: none !important; }

        /* **درخواست جدید: استایل صفحه ورود** */
        #login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        #login-section { max-width: 420px; width: 100%; background: var(--container-bg); padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05), 0 10px 10px -5px rgba(0,0,0,0.04); }
        .container { max-width: 1100px; margin: 40px auto; } /* کانتینر برای داشبورد */
        
        h1, h2, h3, h4 { color: var(--primary-color); text-align: center; font-weight: 700; }
        h1 { font-size: 2.2rem; } h2 { font-size: 1.8rem; border-bottom: 2px solid var(--border-color); padding-bottom: 15px; margin-bottom: 30px; }
        h4 { font-size: 1.3rem; color: var(--secondary-color); margin-bottom: 15px; }

        .skeleton-card { background: #fff; border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-bottom: 30px; }
        .skeleton { background-color: #e2e8f0; border-radius: 4px; } .skeleton.title { height: 28px; width: 40%; margin-bottom: 15px; }
        .skeleton.text { height: 16px; width: 70%; margin-bottom: 10px; } .skeleton.table-head { height: 40px; width: 100%; margin-top: 20px; }
        .skeleton.table-row { height: 50px; width: 100%; margin-top: 5px; } .shimmer { position: relative; overflow: hidden; }
        .shimmer::after { content: ''; position: absolute; top: 0; right: 0; bottom: 0; left: 0; transform: translateX(-100%); background-image: linear-gradient(90deg, rgba(255,255,255,0) 0, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%); animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 100% { transform: translateX(100%); } }
        /* **درخواست جدید: لودینگ دکمه ایجاد دوره** */
        .skeleton.button { height: 48px; width: 180px; margin-bottom: 30px; }

        .form-group { margin-bottom: 20px; } label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 1rem; }
        input, select { width: 100%; box-sizing: border-box; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; font-family: var(--font-main); transition: all 0.3s; }
        input:focus, select:focus { border-color: var(--secondary-color); box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.3); outline: none; }
        button, a.btn-like { text-decoration: none; position:relative; background-color: var(--secondary-color); color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-family: var(--font-main); transition: all 0.3s; display: inline-block; text-align: center; }
        button:hover:not(:disabled), a.btn-like:hover:not(.disabled) { background-color: var(--primary-color); transform: translateY(-2px); }
        button:disabled, a.btn-like.disabled { background-color: #94a3b8; cursor: not-allowed; }
        button.danger { background-color: var(--danger-color); } button.danger:hover:not(:disabled) { background-color: #b91c1c; }
        
        .btn-loading .btn-text { visibility: hidden; }
        .btn-loading::after { content: ''; position: absolute; width: 20px; height: 20px; top: 0; left: 0; right: 0; bottom: 0; margin: auto; border: 3px solid transparent; border-top-color: #ffffff; border-radius: 50%; animation: button-loading-spinner 1s ease infinite; }
        @keyframes button-loading-spinner { from { transform: rotate(0turn); } to { transform: rotate(1turn); } }

        .icon { width: 1.1em; height: 1.1em; vertical-align: middle; }
        .icon-btn { background: none; border: none; color: var(--light-text); cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; font-family: var(--font-main); padding: 8px; border-radius: 8px; transition: all 0.3s; }
        .icon-btn .icon { width: 1.3em; height: 1.3em; } .icon-btn:hover:not(:disabled) { color: var(--secondary-color); background-color: #f0f9ff; }
        .icon-btn.delete-btn:hover:not(:disabled) { color: var(--danger-color); background-color: #fee2e2; }

        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        /* **درخواست جدید: لودینگ دایره‌ای کنار خوش‌آمدگویی** */
        .header-loader { width: 24px; height: 24px; border: 3px solid var(--border-color); border-top-color: var(--secondary-color); border-radius: 50%; animation: button-loading-spinner 1s linear infinite; display: none; margin-right: 15px;}
        .dashboard-header.loading .header-loader { display: block; }

        .course-card { background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-bottom: 30px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .course-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .course-card table { width: 100%; border-collapse: collapse; margin-top: 20px; } .course-card th, .course-card td { padding: 15px; border-bottom: 1px solid var(--border-color); text-align: right; vertical-align: middle; }
        .course-card th { background-color: var(--light-bg); font-size: 1rem; } .course-card tr:last-child td { border-bottom: none; }
        .course-actions { display: flex; align-items: center; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px dashed var(--border-color); }
        .student-actions { display: flex; align-items: center; gap: 5px; }

        .modal { position: fixed; z-index: 1000; inset: 0; background-color: rgba(15, 23, 42, 0.7); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); padding: 20px; }
        .modal-content { background-color: var(--container-bg); padding: 30px; width: 100%; max-width: 650px; border-radius: 16px; animation: modal-appear 0.4s; }
        @keyframes modal-appear { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .modal-header .close-btn { background: none; border: none; font-size: 2rem; color: var(--light-text); cursor: pointer; }
        
        .alert-modal-content { max-width: 450px; text-align: center; } .alert-icon { font-size: 4rem; margin-bottom: 15px; }
        .alert-icon.success { color: var(--success-color); } .alert-icon.error { color: var(--danger-color); }
        .alert-icon.confirm { color: var(--warning-color); } .alert-message { font-size: 1.1rem; color: var(--dark-text); margin-bottom: 25px; }
        .alert-buttons { display: flex; justify-content: center; gap: 15px; } .alert-buttons button { padding: 10px 25px; }
        .alert-buttons button.secondary { background-color: var(--border-color); color: var(--dark-text); }
        .alert-buttons button.secondary:hover { background-color: #cbd5e1; }
    </style>
</head>
<body>
    <svg width="0" height="0" class="hidden"><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-plus-circle"><path fill="currentColor" d="M12 2c-5.52 0-10 4.48-10 10s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m5 11h-4v4h-2v-4H7v-2h4V7h2v4h4z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-pencil"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83l3.75 3.75z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-trash"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-grade"><path fill="currentColor" d="M12 3L1 9l4 2.18v6.32L12 21l7-3.5V11.18L23 9zm-2 13.91V13h4v3.91l-2 1.09zM12 11.33L4.93 8L12 4.67L19.07 8z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-logout"><path fill="currentColor" d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4z"></path></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-star"><path fill="currentColor" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2L9.19 8.63L2 9.24l5.46 4.73L5.82 21z"></path></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-alert-success"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2m-2 15l-5-5l1.41-1.41L10 14.17l7.59-7.59L19 8z"></path></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-alert-error"><path fill="currentColor" d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10s10-4.47 10-10S17.53 2 12 2m-1 15h2v2h-2zm0-12h2v10h-2z"></path></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-alert-confirm"><path fill="currentColor" d="M1 21h22L12 2L1 21m12-3h-2v-2h2m0-4h-2v-4h2"></path></symbol></svg>
    
    <div id="login-container">
        <div id="login-section"><h1>پرتال اساتید قرآن کریم</h1><form id="login-form"><div class="form-group"><label for="nationalId">کد ملی</label><input type="tel" inputmode="numeric" pattern="[0-9]*" id="nationalId" required></div><div class="form-group"><label for="password">رمز عبور</label><input type="password" id="password" required></div><button type="submit"><span class="btn-text">ورود</span></button><p id="error-message" class="hidden"></p></form></div>
    </div>
    
    <div id="dashboard-section" class="hidden">
        <div class="container">
            <div class="dashboard-header"><div id="welcome-message" style="font-size: 1.5rem;"></div><div class="header-loader"></div><button id="logout-btn" class="icon-btn delete-btn"><svg class="icon"><use href="#icon-logout"></use></svg><span class="btn-text">خروج</span></button></div>
            <div id="create-course-container"><button id="btn-create-course"><span class="btn-text">ایجاد دوره جدید</span></button></div>
            <div id="courses-container" style="margin-top:30px;"></div>
        </div>
    </div>
    <div id="modal-container"></div>
<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrKgoFDb7Yt1xoxbACi4Oje8mzZRFAwyL07TXvtTl1zqrAj4R-dGYb2txHgJPrg-P8mw/exec";
    const sessionKey = 'quranTeacherSession';
    let loggedInInstructorId = null, loggedInInstructorName = null, tempStudents = []; let currentCourseId = null, currentStudentOriginalId = null;
    let existingStudentsByCourse = {};

    async function callAppsScript(action, params = {}, button = null) {
        if(button) setButtonLoading(button, true);
        try { const res = await fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', headers: {'Content-Type': 'text/plain;charset=utf-8'}, body: JSON.stringify({ action, params }) }); if (!res.ok) throw new Error(`Network error: ${res.statusText}`); return await res.json();
        } catch (error) { showCustomAlert('خطا در ارتباط با سرور.', 'error'); return { success: false, message: error.message };
        } finally { if(button) setButtonLoading(button, false); }
    }
    
    function setButtonLoading(button, isLoading) { if(!button) return; if(isLoading) { button.disabled = true; button.classList.add('btn-loading'); } else { button.disabled = false; button.classList.remove('btn-loading'); } }
    
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('login-form').addEventListener('submit', handleManualLogin);
        document.getElementById('btn-create-course').addEventListener('click', e => showCreateCourseModal(e.target));
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        const savedSession = localStorage.getItem(sessionKey);
        if (savedSession) { const { nationalId, name } = JSON.parse(savedSession); showDashboard(nationalId, name); }
    });

    function showDashboard(nationalId, name) {
        loggedInInstructorId = nationalId; loggedInInstructorName = name;
        document.getElementById('login-container').classList.add('hidden'); document.getElementById('dashboard-section').classList.remove('hidden');
        document.getElementById('welcome-message').innerHTML = `استاد <strong>${name}</strong>، خوش آمدید.`;
        fetchDashboardData();
    }
    
    async function handleManualLogin(event) {
        event.preventDefault(); const nationalId = document.getElementById('nationalId').value; const password = document.getElementById('password').value;
        const res = await callAppsScript('checkLogin', { nationalId, password }, event.target.querySelector('button'));
        if (res.success) { localStorage.setItem(sessionKey, JSON.stringify({ nationalId: nationalId, name: res.name })); showDashboard(nationalId, res.name);
        } else { const errorP = document.getElementById('error-message'); errorP.innerText = res.message || "خطای ورود."; errorP.classList.remove('hidden'); }
    }

    function handleLogout() { localStorage.removeItem(sessionKey); window.location.reload(); }

    async function fetchDashboardData() {
        renderSkeletonLoader();
        document.querySelector('.dashboard-header').classList.add('loading');
        const res = await callAppsScript('getInstructorDashboardData', { instructorId: loggedInInstructorId });
        document.querySelector('.dashboard-header').classList.remove('loading');
        if(res.success) renderCourses(res.data); else showCustomAlert("خطا در دریافت اطلاعات: " + res.message, 'error'); return true;
    }
    
    function renderSkeletonLoader() { 
        document.getElementById('create-course-container').innerHTML = '<div class="skeleton button shimmer"></div>';
        let skeletonHTML = ''; for (let i = 0; i < 2; i++) { skeletonHTML += `<div class="skeleton-card shimmer"><div class="skeleton title"></div><div class="skeleton text"></div><div class="skeleton table-head"></div><div class="skeleton table-row"></div><div class="skeleton table-row"></div></div>`; } 
        document.getElementById('courses-container').innerHTML = skeletonHTML;
    }

    function renderCourses(courses) {
        document.getElementById('create-course-container').innerHTML = '<button id="btn-create-course"><span class="btn-text">ایجاد دوره جدید</span></button>';
        document.getElementById('btn-create-course').addEventListener('click', e => showCreateCourseModal(e.target));

        const container = document.getElementById('courses-container'); container.innerHTML = !courses || courses.length === 0 ? '<p style="text-align: center;">شما هنوز هیچ دوره‌ای ایجاد نکرده‌اید.</p>' : '';
        existingStudentsByCourse = {};
        courses.forEach(course => {
            existingStudentsByCourse[course.courseId] = new Set(course.students.map(s => s.nationalId));
            const startDate = jalaliToGregorian(course.startDate.split('/').map(Number)[0], course.startDate.split('/').map(Number)[1], course.startDate.split('/').map(Number)[2]);
            const today = new Date(); startDate.setHours(0,0,0,0); today.setHours(0,0,0,0);
            const diffDays = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24));
            const canAddStudent = diffDays < 25; const canDeleteCourse = diffDays < 20; const canEditDate = diffDays <= 0;
            let addStudentBtn = canAddStudent ? `<button class="icon-btn" onclick="showAddStudentModal(event, '${course.courseId}')"><svg class="icon"><use href="#icon-plus-circle"></use></svg><span class="btn-text">افزودن قرآن آموز</span></button>` : '';
            let editDateBtn = canEditDate ? `<button class="icon-btn" onclick="showEditDateModal(event, '${course.courseId}')"><svg class="icon"><use href="#icon-pencil"></use></svg><span class="btn-text">ویرایش تاریخ</span></button>` : '';
            let deleteCourseBtn = canDeleteCourse ? `<button class="icon-btn delete-btn" onclick="showDeleteCourseModal(event, '${course.courseId}')"><svg class="icon"><use href="#icon-trash"></use></svg><span class="btn-text">حذف دوره</span></button>` : '';
            
            let studentsHtml = '<p style="text-align: center; color: var(--light-text);">هنوز قرآن‌آموزی ثبت نشده است.</p>';
            if (course.students.length > 0) {
                studentsHtml = `<table><thead><tr><th>نام و نام خانوادگی</th><th>کد ملی</th><th>نمره کل</th><th>وضعیت گواهی</th><th>عملیات</th></tr></thead><tbody>
                    ${course.students.map(s => {
                        const hasGrade = s.totalScore && s.totalScore != '0';
                        let scoreDisplay = !hasGrade ? `<button class="icon-btn" onclick="showGradingModal(event, '${course.courseId}', '${course.startDate}', '${s.name}', '${s.nationalId}')"><svg class="icon"><use href="#icon-grade"></use></svg><span class="btn-text">ثبت نمره</span></button>` : `<strong>${s.totalScore}</strong>`;
                        let certStatusDisplay = ''; let studentActionsDisplay = '';
                        if (hasGrade) {
                            switch(s.certificateStatus) {
                                case '0': certStatusDisplay = `<span style="color: var(--danger-color); font-weight: bold;">مردود</span>`; studentActionsDisplay = `<span style="color: var(--danger-color); font-size: 1.5rem; font-weight: bold;">—</span>`; break;
                                case '2': certStatusDisplay = `<span>بررسی</span>`; studentActionsDisplay = ``; break;
                                case '5': certStatusDisplay = `<span style="color: var(--success-color); font-weight: bold;">صدور</span>`; studentActionsDisplay = `<a href="https://tashacol.ir/equran.html" target="_blank" class="icon-btn" title="مشاهده گواهی"><svg class="icon" style="color:var(--warning-color);"><use href="#icon-star"></use></svg></a>`; break;
                                default: certStatusDisplay = ''; studentActionsDisplay = '';
                            }
                        } else { studentActionsDisplay = `<div class="student-actions"><button class="icon-btn" onclick="showEditStudentModal(event, '${course.courseId}', '${s.name}', '${s.nationalId}')" title="ویرایش"><svg class="icon"><use href="#icon-pencil"></use></svg></button><button class="icon-btn delete-btn" onclick="showDeleteStudentModal(event, '${course.courseId}', '${s.name}', '${s.nationalId}')" title="حذف"><svg class="icon"><use href="#icon-trash"></use></svg></button></div>`; }
                        return `<tr><td>${s.name||''}</td><td>${s.nationalId||''}</td><td>${scoreDisplay}</td><td>${certStatusDisplay}</td><td>${studentActionsDisplay}</td></tr>`
                    }).join('')}</tbody></table>`;
            }
            container.innerHTML += `<div class="course-card"><div class="course-header"><h4>دوره روخوانی (کد: ${course.courseId})</h4><span style="font-weight: bold; color: var(--light-text);">تاریخ شروع: ${course.startDate}</span></div>${studentsHtml}<div class="course-actions">${addStudentBtn}${editDateBtn}${deleteCourseBtn}</div></div>`;
        });
    }

    const modalContainer = document.getElementById('modal-container');
    function renderModal(title, content) { modalContainer.innerHTML = `<div class="modal"><div class="modal-content"><div class="modal-header"><h3>${title}</h3><button class="close-btn" onclick="closeAllModals()">×</button></div>${content}</div></div>`; }
    function closeAllModals() { modalContainer.innerHTML = ''; }
    
    function showCustomAlert(message, type = 'info') {
        const icons = { success: 'icon-alert-success', error: 'icon-alert-error', info: 'icon-alert-confirm' }; const iconClass = type === 'info' ? 'confirm' : type;
        const content = `<div class="alert-icon ${iconClass}"><svg class="icon"><use href="#${icons[type]}"></use></svg></div><p class="alert-message">${message}</p><div class="alert-buttons"><button onclick="closeAllModals()"><span class="btn-text">باشه</span></button></div>`;
        modalContainer.innerHTML = `<div class="modal"><div class="modal-content alert-modal-content">${content}</div></div>`;
    }
    function showCustomConfirm(message) {
        return new Promise((resolve) => {
            const content = `<div class="alert-icon confirm"><svg class="icon"><use href="#icon-alert-confirm"></use></svg></div><p class="alert-message">${message}</p><div class="alert-buttons"><button id="confirm-btn-yes"><span class="btn-text">تایید</span></button><button id="confirm-btn-no" class="secondary"><span class="btn-text">لغو</span></button></div>`;
            modalContainer.innerHTML = `<div class="modal"><div class="modal-content alert-modal-content">${content}</div></div>`;
            document.getElementById('confirm-btn-yes').onclick = () => { closeAllModals(); resolve(true); }; document.getElementById('confirm-btn-no').onclick = () => { closeAllModals(); resolve(false); };
        });
    }
    
    function getTodayJalaliString() { const p2e = s => s.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d)); return p2e(new Date().toLocaleDateString('fa-IR', {year: 'numeric', month: '2-digit', day: '2-digit'})); }
    function populateDatePicker(prefix = 'start') {
        let opts = { d: '', m: '', y: ''}; for (let i = 1; i <= 31; i++) opts.d += `<option value="${i}">${i}</option>`; ["فروردین","اردیبهشت","خرداد","تیر","مرداد","شهریور","مهر","آبان","آذر","دی","بهمن","اسفند"].forEach((m, i) => opts.m += `<option value="${i+1}">${m}</option>`); opts.y = `<option value="${new Date().toLocaleDateString('fa-IR-u-nu-latn').split('/')[0]}">${new Date().toLocaleDateString('fa-IR-u-nu-latn').split('/')[0]}</option>`;
        return `<select id="${prefix}-day">${opts.d}</select><select id="${prefix}-month">${opts.m}</select><select id="${prefix}-year" disabled>${opts.y}</select>`;
    }
    function jalaliToGregorian(jy, jm, jd) { var sal_a, gy, gm, gd, days; jy += 1595; days = -355668 + (365 * jy) + (~~(jy / 33) * 8) + ~~(((jy % 33) + 3) / 4) + jd + ((jm < 7) ? (jm - 1) * 31 : ((jm - 7) * 30) + 186); gy = 400 * ~~(days / 146097); days %= 146097; if (days > 36524) { gy += 100 * ~~(--days / 36524); days %= 36524; if (days >= 365) days++; } gy += 4 * ~~(days / 1461); days %= 1461; if (days > 365) { gy += ~~((days - 1) / 365); days = (days - 1) % 365; } gd = days + 1; sal_a = [0, 31, ((gy % 4 === 0 && gy % 100 !== 0) || (gy % 400 === 0)) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]; for (gm = 0; gm < 13 && gd > sal_a[gm]; gm++) gd -= sal_a[gm]; return new Date(gy, gm - 1, gd); }

    function showCreateCourseModal() { renderModal('ایجاد دوره جدید', `<p>نام دوره: روخوانی و روانخوانی قرآن کریم</p><div class="form-group"><label>تاریخ شروع</label>${populateDatePicker('start')}</div><button onclick="handleCreateCourse(event)"><span class="btn-text">ایجاد دوره</span></button>`); }
    async function handleCreateCourse(event) {
        const date = `${document.getElementById('start-year').value}/${document.getElementById('start-month').value.padStart(2,'0')}/${document.getElementById('start-day').value.padStart(2,'0')}`;
        if (date < getTodayJalaliString()) { showCustomAlert("تاریخ انتخابی نمی‌تواند در گذشته باشد.", "error"); return; }
        const res = await callAppsScript('createNewCourse', { instructorId: loggedInInstructorId, startDate: date }, event.target);
        if (res.success) { showCustomAlert('دوره با موفقیت ایجاد شد!', 'success'); fetchDashboardData(); } else showCustomAlert('خطا: ' + res.message, 'error'); closeAllModals();
    }
    
    function showEditDateModal(event, courseId) { currentCourseId = courseId; renderModal('ویرایش تاریخ دوره', `<div class="form-group"><label>تاریخ جدید</label>${populateDatePicker('edit')}</div><button onclick="handleUpdateCourseDate(event)"><span class="btn-text">ذخیره</span></button>`); }
    async function handleUpdateCourseDate(event) {
        const newDate = `${document.getElementById('edit-year').value}/${document.getElementById('edit-month').value.padStart(2, '0')}/${document.getElementById('edit-day').value.padStart(2, '0')}`;
        if (newDate < getTodayJalaliString()) { showCustomAlert("تاریخ انتخابی نمی‌تواند در گذشته باشد.", "error"); return; }
        const res = await callAppsScript('updateCourseDate', { courseId: currentCourseId, newDate }, event.target);
        if (res.success) { showCustomAlert(res.message, 'success'); fetchDashboardData(); } else showCustomAlert("خطا: " + res.message, 'error'); closeAllModals();
    }
    
    function showDeleteCourseModal(event, courseId) { currentCourseId = courseId; renderModal('تایید حذف دوره', `<p style="color:var(--danger-color);">آیا از حذف این دوره و تمام قرآن‌آموزان آن اطمینان دارید؟</p><div class="form-group"><label for="delete-password">برای تایید، رمز عبور را وارد کنید:</label><input type="password" id="delete-password"></div><button class="danger" onclick="handleDeleteCourse(event)"><span class="btn-text">بله، حذف کن</span></button>`); }
    async function handleDeleteCourse(event) {
        const password = document.getElementById('delete-password').value; if (!password) { showCustomAlert("رمز عبور الزامی است.", 'error'); return; }
        const res = await callAppsScript('deleteCourse', { courseId: currentCourseId, instructorId: loggedInInstructorId, password }, event.target);
        if (res.success) { showCustomAlert(res.message, 'success'); fetchDashboardData(); } else showCustomAlert("خطا: " + res.message, 'error'); closeAllModals();
    }

    function showAddStudentModal(event, courseId) { currentCourseId = courseId; tempStudents = []; renderModal(`افزودن قرآن آموز به دوره ${courseId}`, `<div id="add-student-form"><div class="form-group"><label for="student-name">نام</label><input type="text" id="student-name"></div><div class="form-group"><label for="student-nationalId">کد ملی</label><input type="tel" inputmode="numeric" pattern="[0-9]*" id="student-nationalId"></div><button onclick="addStudentToTempList(event)"><span class="btn-text">افزودن به لیست</span></button></div><h4>لیست موقت</h4><ul id="temp-student-list"></ul><br><button onclick="saveStudentList(event)"><span class="btn-text">ذخیره نهایی لیست</span></button>`); }
    function addStudentToTempList() { const name = document.getElementById('student-name'), nid = document.getElementById('student-nationalId'); if (name.value.trim() && nid.value.trim()) { const nationalId = nid.value.trim(); if (tempStudents.some(s => s.nationalId === nationalId)) { showCustomAlert('این کد ملی در لیست موقت شما وجود دارد.', 'error'); return; } if (existingStudentsByCourse[currentCourseId] && existingStudentsByCourse[currentCourseId].has(nationalId)) { showCustomAlert('این قرآن‌آموز قبلاً در این دوره ثبت‌نام شده است.', 'error'); return; } tempStudents.push({ name: name.value.trim(), nationalId: nationalId }); document.getElementById('temp-student-list').innerHTML = tempStudents.map(s => `<li>${s.name} - ${s.nationalId}</li>`).join(''); name.value = ''; nid.value = ''; name.focus(); } else showCustomAlert('نام و کد ملی الزامی است.', 'error'); }
    async function saveStudentList(event) {
        if (tempStudents.length === 0) { showCustomAlert('لیست خالی است.', 'error'); return; }
        const res = await callAppsScript('addStudentsToCourse', { courseId: currentCourseId, students: tempStudents, instructorName: loggedInInstructorName }, event.target);
        if (res.success) { showCustomAlert(res.message, 'success'); fetchDashboardData(); } else showCustomAlert('خطا: ' + res.message, 'error'); closeAllModals();
    }
    
    function showEditStudentModal(event, courseId, name, nid) { currentCourseId = courseId; currentStudentOriginalId = nid; renderModal('ویرایش قرآن آموز', `<div class="form-group"><label for="edit-student-name">نام</label><input type="text" id="edit-student-name" value="${name}"></div><div class="form-group"><label for="edit-student-nationalId">کد ملی</label><input type="tel" inputmode="numeric" pattern="[0-9]*" id="edit-student-nationalId" value="${nid}"></div><button onclick="handleUpdateStudent(event)"><span class="btn-text">ذخیره</span></button>`); }
    async function handleUpdateStudent(event) {
        const newName = document.getElementById('edit-student-name').value.trim(), newNid = document.getElementById('edit-student-nationalId').value.trim();
        if(!newName || !newNid) { showCustomAlert("فیلدها نباید خالی باشند.", 'error'); return;}
        const res = await callAppsScript('updateStudentInfo', { courseId: currentCourseId, originalNationalId: currentStudentOriginalId, newName, newNationalId: newNid }, event.target);
        if (res.success) { showCustomAlert(res.message, 'success'); fetchDashboardData(); } else showCustomAlert("خطا: " + res.message, 'error'); closeAllModals();
    }
    
    function showDeleteStudentModal(event, courseId, studentName, studentNationalId) { currentCourseId = courseId; currentStudentOriginalId = studentNationalId; renderModal('تایید حذف قرآن‌آموز', `<p>آیا از حذف قرآن‌آموز <strong>${studentName}</strong> (کد ملی: ${studentNationalId}) اطمینان دارید؟</p><p style="color:var(--danger-color);">این عمل غیرقابل بازگشت است.</p><button class="danger" onclick="handleDeleteStudent(event)"><span class="btn-text">بله، حذف کن</span></button>`); }
    async function handleDeleteStudent(event) {
        const res = await callAppsScript('deleteStudent', { courseId: currentCourseId, studentNationalId: currentStudentOriginalId }, event.target);
        if (res.success) { showCustomAlert(res.message, 'success'); fetchDashboardData(); } else { showCustomAlert("خطا: " + res.message, 'error'); } closeAllModals();
    }

    function showGradingModal(event, courseId, courseStartDate, studentName, studentNationalId) {
        const [year, month, day] = courseStartDate.split('/').map(Number); const startDate = jalaliToGregorian(year, month, day); const today = new Date(); startDate.setHours(0,0,0,0); today.setHours(0,0,0,0); const diffDays = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24));
        if (diffDays < 25) { showCustomAlert(`امکان نمره‌دهی وجود ندارد.\nباید حداقل ۲۵ روز از تاریخ شروع دوره (${courseStartDate}) گذشته باشد.`, 'error'); return; }
        currentCourseId = courseId; currentStudentOriginalId = studentNationalId;
        const content = `<p><strong>نام:</strong> ${studentName} | <strong>کد ملی:</strong> ${studentNationalId}</p><hr>
            <div class="form-group"><label>صحت حروف (از بیست نمره)</label><input type="number" id="g1" min="0" max="20"></div><div class="form-group"><label>صحت حرکات (از بیست نمره)</label><input type="number" id="g2" min="0" max="20"></div>
            <div class="form-group"><label>حروف ناخوانا (از بیست نمره)</label><input type="number" id="g3" min="0" max="20"></div><div class="form-group"><label>وقف و ابتدا (از بیست نمره)</label><input type="number" id="g4" min="0" max="20"></div>
            <div class="form-group"><label>التقاء ساکنین (از بیست نمره)</label><input type="number" id="g5" min="0" max="20"></div><button onclick="handleGradeSubmission(event)"><span class="btn-text">تایید و ارسال نمرات</span></button>`;
        renderModal('ثبت نمره برای قرآن آموز', content);
    }
    async function handleGradeSubmission(event) {
        const grades = {}; for(let i=1; i<=5; i++) { const gradeVal = document.getElementById(`g${i}`).value; if(gradeVal === '' || isNaN(gradeVal) || gradeVal < 0 || gradeVal > 20) { showCustomAlert(`نمره برای همه موارد باید عددی بین 0 و 20 باشد.`, 'error'); return; } grades[`g${i}`] = Number(gradeVal); }
        const confirmed = await showCustomConfirm("آیا از ثبت نمرات اطمینان دارید؟ نمرات پس از ثبت قابل ویرایش نیستند.");
        if (confirmed) {
            const res = await callAppsScript('submitStudentGrades', { courseId: currentCourseId, studentNationalId: currentStudentOriginalId, grades }, event.target);
            if (res.success) { showCustomAlert(res.message, 'success'); fetchDashboardData(); } else showCustomAlert("خطا: " + res.message, 'error'); closeAllModals();
        }
    }
</script>
</body>
</html>
