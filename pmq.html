<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پرتال اساتید قرآن</title>
    <style>
        :root { --primary-color: #2c7a7b; --secondary-color: #1a5f7a; --light-bg: #f0f5f9; --white: #ffffff; --dark-text: #333; --border-color: #dce4e8; --danger-color: #e74c3c; --success-color: #2ecc71; --warning-color: #f39c12;}
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--light-bg); margin: 0; padding: 20px; color: var(--dark-text); line-height: 1.6; }
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        .container { max-width: 950px; margin: auto; background: var(--white); padding: 30px; border-radius: 12px; box-shadow: 0 6px 15px rgba(0,0,0,0.08); }
        h1, h2, h3, h4 { color: var(--primary-color); text-align: center; }
        h2 { border-bottom: 2px solid var(--secondary-color); padding-bottom: 10px; margin-bottom: 25px;}
        .hidden { display: none !important; }
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 0.95em; }
        input[type="text"], input[type="password"], input[type="number"] { width: calc(100% - 22px); padding: 11px; border: 1px solid var(--border-color); border-radius: 6px; }
        button { background-color: var(--primary-color); color: white; padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-family: 'Vazirmatn', sans-serif; transition: background-color 0.3s; }
        button:hover { background-color: var(--secondary-color); }
        button.danger { background-color: var(--danger-color); }
        button.danger:hover { background-color: #c0392b; }
        .icon-btn { background: none; border: none; color: var(--secondary-color); cursor: pointer; display: inline-flex; align-items: center; gap: 6px; font-size: 14px; padding: 5px; border-radius: 5px; transition: background-color 0.3s, color 0.3s; }
        .icon-btn:hover { background-color: #e8f3f3; }
        .icon-btn.delete-btn { color: var(--danger-color); }
        .icon-btn.delete-btn:hover { background-color: #fbeae8; }
        .student-list table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .student-list th, .student-list td { padding: 12px; border: 1px solid #e1e1e1; text-align: right; vertical-align: middle; }
        .student-list th { background-color: #f2f2f2; font-weight: bold; }
        .status-icon { font-size: 24px; }
        .status-icon.success { color: var(--success-color); }
        .status-icon.pending { color: var(--warning-color); }
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; padding: 25px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 10px; animation: slide-down 0.4s; }
        @keyframes slide-down { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-btn { color: #aaa; float: left; font-size: 32px; font-weight: bold; cursor: pointer; line-height: 1; }
        .loader-modal { position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-color: rgba(255,255,255,0.8); }
        .loader-text { font-size: 1.2em; font-weight: bold; color: var(--primary-color); }
    </style>
</head>
<body>
    <div class="container">
        <!-- بخش‌های اصلی -->
        <div id="login-section">
            <h1>پرتال اساتید قرآن کریم</h1>
            <form id="login-form"><div class="form-group"><label for="nationalId">کد ملی:</label><input type="text" id="nationalId" required></div><div class="form-group"><label for="password">رمز عبور:</label><input type="password" id="password" required></div><button type="submit">ورود</button><p id="error-message" class="hidden"></p></form>
        </div>
        <div id="dashboard-section" class="hidden"><div id="welcome-message"></div><button id="btn-create-course">ایجاد دوره جدید</button><hr style="margin: 25px 0; border: none; border-top: 1px solid var(--border-color);"><div id="courses-container"></div></div>
    </div>
    
    <!-- مودال‌ها -->
    <div id="create-course-modal" class="modal hidden"><div class="modal-content"><span class="close-btn" onclick="closeAllModals()">&times;</span><h3>ایجاد دوره جدید</h3><p><strong>نام دوره:</strong> روخوانی و روانخوانی قرآن کریم</p><div class="form-group"><label>تاریخ شروع:</label><select id="start-day"></select><select id="start-month"></select><select id="start-year" disabled></select></div><button id="btn-submit-course">ایجاد دوره</button></div></div>
    <div id="add-student-modal" class="modal hidden"><div class="modal-content"><span class="close-btn" onclick="closeAllModals()">&times;</span><h3>افزودن قرآن آموز به دوره <span id="add-student-modal-course-id"></span></h3><div class="form-group"><label for="student-name">نام:</label><input type="text" id="student-name"></div><div class="form-group"><label for="student-nationalId">کد ملی:</label><input type="text" id="student-nationalId"></div><button onclick="addStudentToTempList()">افزودن به لیست</button><h4>لیست موقت</h4><ul id="temp-student-list"></ul><button onclick="saveStudentList()">ذخیره نهایی</button></div></div>
    <div id="edit-date-modal" class="modal hidden"><div class="modal-content"><span class="close-btn" onclick="closeAllModals()">&times;</span><h3>ویرایش تاریخ دوره</h3><div class="form-group"><label>تاریخ جدید:</label><select id="edit-day"></select><select id="edit-month"></select><select id="edit-year" disabled></select></div><button onclick="handleUpdateCourseDate()">ذخیره</button></div></div>
    <div id="edit-student-modal" class="modal hidden"><div class="modal-content"><span class="close-btn" onclick="closeAllModals()">&times;</span><h3>ویرایش قرآن آموز</h3><div class="form-group"><label for="edit-student-name">نام:</label><input type="text" id="edit-student-name"></div><div class="form-group"><label for="edit-student-nationalId">کد ملی:</label><input type="text" id="edit-student-nationalId"></div><button onclick="handleUpdateStudent()">ذخیره</button></div></div>
    <div id="delete-course-modal" class="modal hidden"><div class="modal-content"><span class="close-btn" onclick="closeAllModals()">&times;</span><h3>تایید حذف دوره</h3><p style="color: var(--danger-color);">آیا از حذف این دوره و تمام قرآن‌آموزان آن اطمینان دارید؟</p><div class="form-group"><label for="delete-password">برای تایید، رمز عبور را وارد کنید:</label><input type="password" id="delete-password"></div><button class="danger" onclick="handleDeleteCourse()">حذف کن</button></div></div>
    
    <!-- مودال جدید نمره‌دهی -->
    <div id="grading-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn" onclick="closeAllModals()">&times;</span>
            <h3>ثبت نمره برای قرآن آموز</h3>
            <p><strong>نام:</strong> <span id="grade-student-name"></span></p>
            <p><strong>کد ملی:</strong> <span id="grade-student-nid"></span></p>
            <hr>
            <div class="form-group"><label for="g1">صحت حروف (تا 20):</label><input type="number" id="g1" min="0" max="20"></div>
            <div class="form-group"><label for="g2">صحت حرکات کوتاه و کشیده (تا 20):</label><input type="number" id="g2" min="0" max="20"></div>
            <div class="form-group"><label for="g3">رعایت حروف ناخوانا (تا 20):</label><input type="number" id="g3" min="0" max="20"></div>
            <div class="form-group"><label for="g4">رعایت وقف و ابتدا (تا 20):</label><input type="number" id="g4" min="0" max="20"></div>
            <div class="form-group"><label for="g5">رعایت التقاء ساکنین (تا 20):</label><input type="number" id="g5" min="0" max="20"></div>
            <button onclick="handleGradeSubmission()">تایید و ارسال نمرات</button>
        </div>
    </div>

    <div id="loader" class="loader-modal hidden"><p class="loader-text">لطفاً صبر کنید...</p></div>

<script>
    // ######################################################################
    // # مهم: URL وب اپلیکیشن خود را در اینجا جایگزین کنید.                #
    // ######################################################################
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzQaOwN9iWbpthIqBnKnTbADX-5lbAhlG_LZ4yz7KYBpn5SP4EV-LcWvNE-WP3zCcMJJw/exec"; 
    
    let loggedInInstructorId = null, loggedInInstructorName = null, tempStudents = [];
    let currentCourseId = null, currentStudentOriginalId = null;

    async function callAppsScript(action, params = {}) {
        showLoader(true);
        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST', mode: 'cors', headers: {'Content-Type': 'text/plain;charset=utf-8'},
                body: JSON.stringify({ action, params }),
            });
            if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
            const result = await response.json();
            showLoader(false);
            return result;
        } catch (error) {
            showLoader(false);
            alert('خطا در ارتباط با سرور.');
            return { success: false, message: error.message };
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('btn-create-course').addEventListener('click', showCreateCourseModal);
        document.getElementById('btn-submit-course').addEventListener('click', handleCreateCourse);
    });

    function showLoader(show) { document.getElementById('loader').classList.toggle('hidden', !show); }

    async function handleLogin(event) {
        event.preventDefault();
        const nationalId = document.getElementById('nationalId').value;
        const password = document.getElementById('password').value;
        const response = await callAppsScript('checkLogin', { nationalId, password });
        if (response.success) {
            loggedInInstructorId = nationalId; loggedInInstructorName = response.name;
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            document.getElementById('welcome-message').innerHTML = `<strong>${response.name}</strong> عزیز، خوش آمدید.`;
            fetchDashboardData();
        } else {
            document.getElementById('error-message').innerText = response.message || "خطای ورود.";
            document.getElementById('error-message').classList.remove('hidden');
        }
    }

    async function fetchDashboardData() {
        const response = await callAppsScript('getInstructorDashboardData', { instructorId: loggedInInstructorId });
        if(response.success){ renderCourses(response.data); } 
        else { alert("خطا در دریافت اطلاعات: " + response.message); }
    }

    function renderCourses(courses) {
        const container = document.getElementById('courses-container');
        container.innerHTML = '';
        if (!courses || courses.length === 0) {
            container.innerHTML = '<p style="text-align: center;">شما هنوز هیچ دوره‌ای ایجاد نکرده‌اید.</p>';
            return;
        }
        courses.sort((a, b) => b.courseId - a.courseId).forEach(course => {
            let studentsHtml = '<p style="text-align: center; color: #777;">هنوز قرآن‌آموزی ثبت نشده است.</p>';
            if (course.students.length > 0) {
                studentsHtml = `<div class="student-list"><table>
                    <thead><tr><th>نام</th><th>کد ملی</th><th>نمره</th><th>وضعیت گواهی</th><th>عملیات</th></tr></thead>
                    <tbody>${course.students.map(s => {
                        const scoreDisplay = (!s.totalScore || s.totalScore == '0')
                            ? `<button class="icon-btn" onclick="showGradingModal('${course.courseId}', '${s.name}', '${s.nationalId}')">📝 ثبت نمره</button>`
                            : `<strong>${s.totalScore}</strong>`;
                        
                        const certificateIcon = s.certificateStatus === '5'
                            ? `<span class="status-icon success" title="صادر شده">✓</span>`
                            : `<span class="status-icon pending" title="در حال بررسی">...</span>`;

                        return `<tr>
                            <td>${s.name||''}</td>
                            <td>${s.nationalId||''}</td>
                            <td>${scoreDisplay}</td>
                            <td>${certificateIcon}</td>
                            <td><button class="icon-btn" onclick="showEditStudentModal('${course.courseId}', '${s.name}', '${s.nationalId}')">✏️ ویرایش</button></td>
                        </tr>`
                    }).join('')}</tbody></table></div>`;
            }
            const card = document.createElement('div');
            card.className = 'course-card';
            card.innerHTML = `
                <div class="course-header">
                    <h4>دوره: روخوانی و روانخوانی قرآن (کد: ${course.courseId})</h4>
                    <div><span style="font-weight: bold; color: #555;">تاریخ: ${course.startDate}</span>
                    <button class="icon-btn" onclick="showEditDateModal('${course.courseId}')">✏️</button></div>
                </div>
                <h4>لیست قرآن آموزان</h4> ${studentsHtml}
                <div class="course-actions" style="display: flex; align-items: center; gap: 15px; margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 15px;">
                    <button class="icon-btn" onclick="showAddStudentModal('${course.courseId}')">➕ افزودن قرآن آموز</button>
                    <button class="icon-btn delete-btn" onclick="showDeleteConfirmationModal('${course.courseId}')">🗑️ حذف دوره</button>
                </div>`;
            container.appendChild(card);
        });
    }

    function populateDatePicker(prefix = 'start') {
        const day = document.getElementById(`${prefix}-day`), month = document.getElementById(`${prefix}-month`), year = document.getElementById(`${prefix}-year`);
        if (day.options.length > 1 && prefix === 'start') return;
        day.innerHTML = ''; month.innerHTML = '';
        for (let i = 1; i <= 31; i++) day.innerHTML += `<option value="${i}">${i}</option>`;
        const months = ["فروردین", "اردیبهشت", "خرداد", "تیر", "مرداد", "شهریور", "مهر", "آبان", "آذر", "دی", "بهمن", "اسفند"];
        months.forEach((m, i) => month.innerHTML += `<option value="${i+1}">${m}</option>`);
        const currentYear = new Date().toLocaleDateString('fa-IR-u-nu-latn').split('/')[0];
        year.innerHTML = `<option value="${currentYear}">${currentYear}</option>`;
    }
    
    // --- مدیریت دوره ---
    function showCreateCourseModal() { populateDatePicker('start'); document.getElementById('create-course-modal').classList.remove('hidden'); }
    async function handleCreateCourse() {
        const date = `${document.getElementById('start-year').value}/${document.getElementById('start-month').value.padStart(2,'0')}/${document.getElementById('start-day').value.padStart(2,'0')}`;
        const res = await callAppsScript('createNewCourse', { instructorId: loggedInInstructorId, startDate: date });
        if (res.success) { alert('دوره ایجاد شد!'); fetchDashboardData(); } else { alert('خطا: ' + res.message); }
        closeAllModals();
    }
    function showEditDateModal(courseId) { currentCourseId = courseId; populateDatePicker('edit'); document.getElementById('edit-date-modal').classList.remove('hidden'); }
    async function handleUpdateCourseDate() {
        const newDate = `${document.getElementById('edit-year').value}/${document.getElementById('edit-month').value.padStart(2, '0')}/${document.getElementById('edit-day').value.padStart(2, '0')}`;
        const res = await callAppsScript('updateCourseDate', { courseId: currentCourseId, newDate });
        if (res.success) { alert(res.message); fetchDashboardData(); } else { alert("خطا: " + res.message); }
        closeAllModals();
    }
    function showDeleteConfirmationModal(courseId) { currentCourseId = courseId; document.getElementById('delete-password').value = ''; document.getElementById('delete-course-modal').classList.remove('hidden'); }
    async function handleDeleteCourse() {
        const password = document.getElementById('delete-password').value;
        if (!password) { alert("رمز عبور الزامی است."); return; }
        const res = await callAppsScript('deleteCourse', { courseId: currentCourseId, instructorId: loggedInInstructorId, password });
        if (res.success) { alert(res.message); fetchDashboardData(); } else { alert("خطا: " + res.message); }
        closeAllModals();
    }

    // --- مدیریت قرآن آموز ---
    function showAddStudentModal(courseId) { currentCourseId = courseId; document.getElementById('add-student-modal-course-id').innerText = courseId; tempStudents = []; renderTempStudentList(); document.getElementById('add-student-modal').classList.remove('hidden'); }
    function addStudentToTempList() {
        const name = document.getElementById('student-name'), nid = document.getElementById('student-nationalId');
        if (name.value.trim() && nid.value.trim()) {
            if (tempStudents.some(s => s.nationalId === nid.value.trim())) { alert('کد ملی تکراری است.'); return; }
            tempStudents.push({ name: name.value.trim(), nationalId: nid.value.trim() });
            renderTempStudentList(); name.value = ''; nid.value = ''; name.focus();
        } else { alert('نام و کد ملی الزامی است.'); }
    }
    function renderTempStudentList() { document.getElementById('temp-student-list').innerHTML = tempStudents.map(s => `<li>${s.name} - ${s.nationalId}</li>`).join(''); }
    async function saveStudentList() {
        if (tempStudents.length === 0) { alert('لیست خالی است.'); return; }
        const res = await callAppsScript('addStudentsToCourse', { courseId: currentCourseId, students: tempStudents, instructorName: loggedInInstructorName });
        if (res.success) { alert(res.message); fetchDashboardData(); } else { alert('خطا: ' + res.message); }
        closeAllModals();
    }
    function showEditStudentModal(courseId, name, nid) { currentCourseId = courseId; currentStudentOriginalId = nid; document.getElementById('edit-student-name').value = name; document.getElementById('edit-student-nationalId').value = nid; document.getElementById('edit-student-modal').classList.remove('hidden'); }
    async function handleUpdateStudent() {
        const newName = document.getElementById('edit-student-name').value.trim();
        const newNid = document.getElementById('edit-student-nationalId').value.trim();
        if(!newName || !newNid) { alert("فیلدها نباید خالی باشند."); return;}
        const res = await callAppsScript('updateStudentInfo', { courseId: currentCourseId, originalNationalId: currentStudentOriginalId, newName, newNationalId: newNid });
        if (res.success) { alert(res.message); fetchDashboardData(); } else { alert("خطا: " + res.message); }
        closeAllModals();
    }
    
    // --- مدیریت نمره‌دهی ---
    function showGradingModal(courseId, studentName, studentNationalId) {
        currentCourseId = courseId;
        currentStudentOriginalId = studentNationalId;
        document.getElementById('grade-student-name').innerText = studentName;
        document.getElementById('grade-student-nid').innerText = studentNationalId;
        // پاک کردن فیلدهای قبلی
        for(let i=1; i<=5; i++) { document.getElementById(`g${i}`).value = ''; }
        document.getElementById('grading-modal').classList.remove('hidden');
    }
    async function handleGradeSubmission() {
        const grades = {};
        for(let i=1; i<=5; i++) {
            const gradeVal = document.getElementById(`g${i}`).value;
            if(gradeVal === '' || isNaN(gradeVal) || gradeVal < 0 || gradeVal > 20) {
                alert(`لطفاً برای همه موارد نمره‌ای صحیح بین 0 تا 20 وارد کنید.`);
                return;
            }
            grades[`g${i}`] = Number(gradeVal);
        }

        if (confirm("آیا از ثبت نمرات اطمینان دارید؟ نمرات پس از ثبت قابل ویرایش نیستند.")) {
            const res = await callAppsScript('submitStudentGrades', {
                courseId: currentCourseId,
                studentNationalId: currentStudentOriginalId,
                grades: grades
            });
            if (res.success) {
                alert(res.message);
                fetchDashboardData();
            } else {
                alert("خطا در ثبت نمره: " + res.message);
            }
            closeAllModals();
        }
    }

    function closeAllModals() {
        document.querySelectorAll('.modal').forEach(modal => modal.classList.add('hidden'));
    }
</script>
</body>
</html>
