 <!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1200">
    <title>پرتال اساتید</title>
    <!-- استایل‌ها بدون تغییر باقی می‌مانند -->
    <style>
        :root {
            --font-main: 'Vazirmatn', sans-serif;
            --primary-color: #0c4a6e; --secondary-color: #075985; --accent-color: #38bdf8;
            --light-bg: #f8fafc; --container-bg: #ffffff; --dark-text: #1e293b; --light-text: #64748b;
            --border-color: #e2e8f0; --danger-color: #dc2626; --success-color: #16a34a; --warning-color: #f59e0b;
        }
        body {
            font-family: var(--font-main);
            color: var(--dark-text);
            line-height: 1.7;
            min-width: 1200px;
            margin: 0;
            background-image: url('https://tashacol.ir/123.jpg');
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed; 
        }
        /* ... بقیه استایل‌های شما بدون هیچ تغییری در اینجا قرار می‌گیرند ... */
    </style>
    <!-- افزودن اسکریپت Google reCAPTCHA -->
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>
    <!-- SVG Icons بدون تغییر باقی می‌مانند -->
    <svg width="0" height="0" class="hidden">
        <!-- ... تمام symbol های SVG شما در اینجا قرار می‌گیرند ... -->
    </svg>
    
    <div id="login-container">
        <div id="login-section">
            <img src="https://tashacol.ir/1754843708220.png" alt="لوگو" class="login-header-icon">
            <h1>پرتال اساتید</h1>
            <!-- تغییر فرم برای استفاده از کپچا -->
            <form id="login-form" onsubmit="handleManualLogin(event)">
                <div class="form-group">
                    <label for="nationalId">کد ملی</label>
                    <div class="input-icon"><svg class="icon"><use href="#icon-id-card"></use></svg></div>
                    <input type="tel" inputmode="numeric" pattern="[0-9]*" id="nationalId" required class="has-icon">
                </div>
                <div class="form-group">
                    <label for="password">رمز عبور</label>
                    <div class="input-icon"><svg class="icon"><use href="#icon-lock"></use></svg></div>
                    <input type="password" id="password" required class="has-icon">
                </div>
                <!-- دکمه ورود به همراه المنت کپچا -->
                <button 
                    class="g-recaptcha" 
                    data-sitekey="6Lc1vqkrAAAAAHLHbzPMzlREvKwgHDNSmakrB-aq" 
                    data-callback="onRecaptchaSuccess"
                    data-error-callback="onRecaptchaError"
                    data-size="invisible"
                    type="submit">
                    <span class="btn-text">ورود</span>
                </button>
                <p id="error-message" class="hidden modal-error-message" style="margin-top: 15px;"></p>
            </form>
        </div>
    </div>
    
    <div id="dashboard-section" class="hidden">
        <div class="container">
            <div class="dashboard-header">
                <div id="welcome-message" style="font-size: 1.5rem;"></div>
                <div class="header-loader"></div>
                <div class="header-actions">
                    <button id="edit-email-btn" class="icon-btn"><svg class="icon" style="color:var(--accent-color);"><use href="#icon-email"></use></svg><span class="btn-text">ویرایش ایمیل</span></button>
                    <button id="logout-btn" class="icon-btn delete-btn"><svg class="icon"><use href="#icon-logout"></use></svg><span class="btn-text">خروج</span></button>
                </div>
            </div>
            <div id="create-course-container"><button id="btn-create-course"><span class="btn-text">ایجاد دوره جدید</span></button></div>
            <div id="courses-container" style="margin-top:30px;"></div>
        </div>
    </div>
    <div id="modal-container"></div>
<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxF3se3e1sM95mW5rBM6vSq12NgLbP4aBFeGI_To2PP9sQwq_KtaFkXeAaeNItCEWM/exec";
    
    // --- مدیریت نشست امن ---
    let sessionToken = null; 
    let loggedInInstructorName = null, loggedInInstructorEmail = null, tempStudents = []; 
    let currentCourseId = null, currentStudentOriginalId = null;
    let existingStudentsByCourse = {};

    async function callAppsScript(action, params = {}, button = null) {
        if(button) setButtonLoading(button, true);
        const requestBody = { action, params };
        // اگر کاربر لاگین کرده باشد، توکن را به تمام درخواست‌ها اضافه کن
        if (sessionToken) {
            requestBody.token = sessionToken;
        }

        try {
            const res = await fetch(SCRIPT_URL, { 
                method: 'POST', 
                mode: 'cors', 
                headers: {'Content-Type': 'text/plain;charset=utf-8'}, 
                body: JSON.stringify(requestBody) 
            });
            if (!res.ok) throw new Error(`Network error: ${res.statusText}`);
            
            const data = await res.json();
            
            // اگر سرور به دلیل نشست نامعتبر خطا داد، کاربر را به صفحه لاگین برگردان
            if (data.unauthorized) {
                handleLogout(); // این تابع همه‌چیز را پاک کرده و صفحه را رفرش می‌کند
                return; // از ادامه اجرای کد جلوگیری کن
            }
            return data;

        } catch (error) {
            showCustomAlert('خطا در ارتباط با سرور.', 'error');
            return { success: false, message: error.message };
        } finally {
            if(button) setButtonLoading(button, false);
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        // دیگر از localStorage استفاده نمی‌کنیم و صفحه همیشه از لاگین شروع می‌شود
        // این کار امنیت را افزایش می‌دهد چون توکن در حافظه موقت (RAM) می‌ماند
    });

    function showDashboard(name, email, token) {
        loggedInInstructorName = name;
        loggedInInstructorEmail = email;
        sessionToken = token; // ذخیره توکن در متغیر جاوااسکریپت
        
        document.getElementById('login-container').classList.add('hidden');
        document.getElementById('dashboard-section').classList.remove('hidden');
        document.getElementById('welcome-message').innerHTML = `استاد <strong>${name}</strong>، خوش آمدید.`;
        document.getElementById('btn-create-course').addEventListener('click', e => showCreateCourseModal(e.target));
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        document.getElementById('edit-email-btn').addEventListener('click', showEditEmailModal);
        fetchDashboardData();
        if (!loggedInInstructorEmail) {
            showEmailPromptModal();
        }
    }

    // --- توابع جدید برای مدیریت کپچا و لاگین امن ---
    
    function handleManualLogin(event) {
        event.preventDefault();
        const nationalId = document.getElementById('nationalId').value;
        const password = document.getElementById('password').value;
        const errorP = document.getElementById('error-message');
        
        if (!isValidNationalId(nationalId)) {
            errorP.innerText = "کد ملی باید یک عدد ۱۰ رقمی صحیح باشد.";
            errorP.classList.remove('hidden');
            return;
        }
        errorP.classList.add('hidden');
        
        // اجرای کپچا
        grecaptcha.execute();
    }

    async function onRecaptchaSuccess(recaptchaToken) {
        const nationalId = document.getElementById('nationalId').value;
        const password = document.getElementById('password').value;
        const errorP = document.getElementById('error-message');
        const loginButton = document.querySelector('#login-form button[type="submit"]');

        const params = { nationalId, password, recaptchaToken };
        const res = await callAppsScript('checkLogin', params, loginButton);
        
        grecaptcha.reset(); // ریست کردن کپچا برای تلاش بعدی
        
        if (res && res.success) {
            // سرور توکن را برگردانده است
            showDashboard(res.name, res.email, res.token);
        } else if(res) {
            errorP.innerText = res.message || "خطای ورود.";
            errorP.classList.remove('hidden');
        }
    }

    function onRecaptchaError() {
        showCustomAlert('خطا در اجرای کپچا. لطفاً اتصال اینترنت خود را بررسی کرده و دوباره تلاش کنید.', 'error');
        grecaptcha.reset();
    }
    
    async function handleLogout() {
        if (sessionToken) {
            await callAppsScript('logout', {}); // به سرور اطلاع بده تا توکن را باطل کند
        }
        sessionToken = null; // توکن را از حافظه پاک کن
        window.location.reload(); // صفحه را برای بازگشت به لاگین رفرش کن
    }

    async function fetchDashboardData() {
        renderSkeletonLoader();
        document.querySelector('.dashboard-header').classList.add('loading');
        // دیگر instructorId ارسال نمی‌شود، سرور از روی توکن تشخیص می‌دهد
        const res = await callAppsScript('getInstructorDashboardData', {});
        document.querySelector('.dashboard-header').classList.remove('loading');
        if(res && res.success) renderCourses(res.data); else if(res) showCustomAlert("خطا در دریافت اطلاعات: " + res.message, 'error');
    }

    // --- رندر کردن UI بر اساس مجوزهای دریافتی از سرور ---
    function renderCourses(courses) {
        document.getElementById('create-course-container').innerHTML = '<button id="btn-create-course"><span class="btn-text">ایجاد دوره جدید</span></button>';
        document.getElementById('btn-create-course').addEventListener('click', e => showCreateCourseModal(e.target));

        const container = document.getElementById('courses-container');
        container.innerHTML = !courses || courses.length === 0 ? '<p style="text-align: center;">شما هنوز هیچ دوره‌ای ایجاد نکرده‌اید.</p>' : '';
        existingStudentsByCourse = {};

        courses.forEach(course => {
            // ** دریافت مجوزها مستقیما از سرور **
            const { canAddStudent, canDeleteCourse, canEditDate, canGradeOrConfirm } = course.permissions;
            const hasFinalExam = course.hasFinalExam === '5';
            // ... (بقیه منطق محاسبه تاریخ پایان)
            
            // ** دکمه‌ها بر اساس مجوزهای سرور ساخته می‌شوند **
            let addStudentBtn = canAddStudent ? `<button class="icon-btn" onclick="showAddStudentModal(event, '${course.courseId}')"><svg class="icon"><use href="#icon-plus-circle"></use></svg><span class="btn-text">افزودن قرآن آموز</span></button>` : '';
            let editDateBtn = canEditDate ? `<button class="icon-btn" onclick="showEditDateModal(event, '${course.courseId}')"><svg class="icon"><use href="#icon-pencil"></use></svg><span class="btn-text">ویرایش تاریخ</span></button>` : '';
            let deleteCourseBtn = canDeleteCourse ? `<button class="icon-btn delete-btn" onclick="showDeleteCourseModal(event, '${course.courseId}')"><svg class="icon"><use href="#icon-trash"></use></svg><span class="btn-text">حذف دوره</span></button>` : '';

            // ... (بقیه منطق رندر کردن وضعیت دوره و لیست دانش‌آموزان بدون تغییر)
            // منطق رندر کردن دکمه‌های ثبت نمره و تایید حضور نیز بر اساس canGradeOrConfirm خواهد بود
            
            // ... (بقیه کد HTML برای هر کارت دوره)
        });
    }

    // --- بقیه توابع جاوااسکریپت ---
    // تمام توابع دیگر (مانند renderModal, showCreateCourseModal, handleCreateCourse, و ...)
    // تقریبا بدون تغییر باقی می‌مانند. تنها تغییر این است که در هنگام فراخوانی callAppsScript،
    // دیگر نیازی به ارسال instructorId نیست.
    
    // مثال برای یک تابع تغییر یافته:
    async function handleUpdateEmail(event) {
        const emailInput = document.getElementById('edit-email');
        const email = emailInput.value.trim();
        // ... (اعتبارسنجی ایمیل)
        
        // instructorId دیگر ارسال نمی‌شود
        const res = await callAppsScript('updateTeacherEmail', { newEmail: email }, event.target);
        
        if (res.success) {
            loggedInInstructorEmail = email;
            // دیگر نیازی به آپدیت localStorage نیست
            closeAllModals();
            showCustomAlert(res.message, 'success');
        } else {
            showModalError('modal-error-container', res.message);
        }
    }
    
    // تمام توابع دیگر شما در اینجا قرار می‌گیرند.
    // لطفاً بقیه توابع جاوااسکریپت از کد قبلی خود را (به جز آن‌هایی که در بالا تغییر کرده‌اند) در اینجا کپی کنید.
    // تغییرات اصلی در callAppsScript, login, logout و fetchDashboardData اعمال شده است.
    // مطمئن شوید که در هیچ‌کدام از فراخوانی‌های callAppsScript، پارامتر instructorId را به صورت دستی ارسال نمی‌کنید.

</script>
</body>
</html>
