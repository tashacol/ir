 <!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <!-- **درخواست جدید: حل مشکل زوم در موبایل** -->
    <meta name="viewport" content="width=1200">
    <title>پرتال اساتید قرآن کریم</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1e40af; --primary-light: #dbeafe; --primary-dark: #1e3a8a;
            --text-dark: #1e293b; --text-light: #64748b; --text-on-dark: #ffffff;
            --bg-main: #f1f5f9; --bg-card: #ffffff; --border-color: #e2e8f0;
            --success: #16a34a; --danger: #dc2626; --warning: #f59e0b; --info: #3b82f6;
            --shadow: 0 4px 25px rgba(0,0,0,0.08); --radius-lg: 16px; --radius-md: 12px;
            --transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Vazirmatn', sans-serif; 
            background-color: var(--bg-main); 
            color: var(--text-dark);
            min-width: 1200px;
            font-size: 16px;
        }
        .hidden { display: none !important; }

        #login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .login-box {
            width: 100%; max-width: 420px; background: var(--bg-card); padding: 40px;
            border-radius: var(--radius-lg); box-shadow: var(--shadow); text-align: center;
        }
        .login-box .logo { color: var(--primary); font-size: 3.5rem; margin-bottom: 20px; }
        .login-box h1 { font-size: 1.8rem; margin-bottom: 8px; }
        .login-box p { color: var(--text-light); margin-bottom: 30px; }
        .input-wrapper { position: relative; margin-bottom: 20px; }
        .input-icon { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); color: var(--text-light); }
        .form-input {
            width: 100%; padding: 14px 50px 14px 15px; border: 1px solid var(--border-color);
            border-radius: var(--radius-md); font-size: 1rem; outline: none; transition: var(--transition);
            background: var(--bg-main); color: var(--text-dark);
        }
        .form-input:focus { border-color: var(--primary); background: var(--bg-card); box-shadow: 0 0 0 3px var(--primary-light); }
        .btn-primary { 
            width: 100%; padding: 14px; font-size: 1.1rem; font-weight: 500; background: var(--primary);
            color: var(--text-on-dark); border: none; border-radius: var(--radius-md); cursor: pointer;
            transition: var(--transition); position: relative; min-height: 52px; display: flex; align-items: center; justify-content: center;
        }
        .btn-primary:hover:not(:disabled) { background: var(--primary-dark); }
        .btn-primary.loading .spinner { opacity: 1; }
        .btn-primary .spinner { width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3); border-top-color: var(--text-on-dark); border-radius: 50%; animation: spin 0.8s linear infinite; position: absolute; opacity: 0; transition: var(--transition); }
        @keyframes spin { to { transform: rotate(360deg); } }
        #login-error-msg { margin-top: 15px; color: var(--danger); min-height: 20px; font-weight: 500; }
        
        #dashboard-view { display: none; }
        .container { max-width: 1100px; margin: 40px auto; }

        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header-welcome { display: flex; align-items: center; }
        .header-loader { width: 20px; height: 20px; border: 3px solid var(--border-color); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; display: none; margin-right: 15px;}
        .dashboard-header.loading .header-loader { display: block; }

        .btn { text-decoration: none; position:relative; background-color: var(--secondary-color); color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-family: var(--font-main); transition: all 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:hover:not(:disabled) { background-color: var(--primary-dark); transform: translateY(-2px); }
        .btn:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .btn.danger { background-color: var(--danger); } .btn.danger:hover:not(:disabled) { background-color: #b91c1c; }
        .btn.loading .btn-text { visibility: hidden; }
        .btn.loading::after { content: ''; position: absolute; width: 20px; height: 20px; top: 0; left: 0; right: 0; bottom: 0; margin: auto; border: 3px solid transparent; border-top-color: #ffffff; border-radius: 50%; animation: spin 1s ease infinite; }
        
        .skeleton { animation: skeleton-loading 1.5s linear infinite alternate; background-color: #e2e8f0; border-radius: 8px;}
        @keyframes skeleton-loading { from { background-color: #e2e8f0; } to { background-color: #f1f5f9; } }
        .skeleton.title { height: 28px; width: 40%; margin-bottom: 15px; } .skeleton.text { height: 16px; width: 70%; margin-bottom: 10px; }
        .skeleton.table-head { height: 40px; width: 100%; margin-top: 20px; } .skeleton.table-row { height: 50px; width: 100%; margin-top: 5px; }
        .skeleton.button { height: 48px; width: 180px; }
        
        .card { background: var(--bg-card); border-radius: var(--radius-lg); box-shadow: var(--shadow); padding: 25px; margin-bottom: 30px; }
        .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .card-header h4 { font-size: 1.3rem; margin:0; }
        .data-table { width: 100%; border-collapse: collapse; } .data-table th, .data-table td { padding: 15px; border-bottom: 1px solid var(--border-color); text-align: right; vertical-align: middle; }
        .data-table th { background-color: var(--bg-main); font-weight: 500; font-size: 0.9rem; color: var(--text-light); text-transform: uppercase; }
        .data-table tr:last-child td { border-bottom: none; }
        .card-actions { display: flex; align-items: center; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .student-actions { display: flex; align-items: center; gap: 5px; }
        
        .modal { position: fixed; z-index: 1000; inset: 0; background: rgba(15, 23, 42, 0.7); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); padding: 20px; }
        .modal-content { background-color: var(--bg-card); padding: 30px; width: 100%; max-width: 650px; border-radius: var(--radius-lg); animation: modal-pop-in 0.4s; }
        @keyframes modal-pop-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .modal-header .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); }
        
        .alert-modal-content { max-width: 450px; text-align: center; } .alert-icon { font-size: 4rem; margin-bottom: 15px; }
        .alert-icon.success { color: var(--success); } .alert-icon.error { color: var(--danger); } .alert-icon.confirm { color: var(--warning); }
        .alert-message { font-size: 1.1rem; color: var(--text-dark); margin-bottom: 25px; line-height: 1.8; }
        .alert-buttons { display: flex; justify-content: center; gap: 15px; } .alert-buttons .btn { padding: 10px 25px; }
        .alert-buttons .btn.secondary { background-color: var(--border-color); color: var(--text-dark); } .alert-buttons .btn.secondary:hover { background-color: #cbd5e1; }
    </style>
</head>
<body>
    <svg width="0" height="0" class="hidden"><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-quran"><path fill="currentColor" d="M18.9 2.1c.1.1.1.2.1.3v15.2c0 .1 0 .2-.1.3l-6.5 3c-.1 0-.2.1-.3.1s-.2 0-.3-.1l-6.5-3c-.1-.1-.1-.2-.1-.3V2.4c0-.1 0-.2.1-.3l6.5-2.1c.1 0 .2-.1.3-.1s.2 0 .3.1zM6 3.7l-1 .4v12.3l1 .5zm1.5.6v11.7l5-2.1V6.3zm11-1.3l-1-.4v12.3l1 .5z"></path></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-user"><path fill="currentColor" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4m0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4"></path></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-lock"><path fill="currentColor" d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2m-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2M9 8V6c0-1.66 1.34-3 3-3s3 1.34 3 3v2z"></path></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-plus-circle"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m-1 15v-4H7v-2h4V7h2v4h4v2h-4v4z"></path></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-pencil"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83l3.75 3.75l1.83-1.83z"></path></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-trash"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-grade"><path fill="currentColor" d="m12 3l-1.45 4.75L2 9.25l7.5 5.5-2.75 7.5L12 18.25l5.25 4-2.75-7.5L22 9.25l-8.55-1.5z"></path></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-logout"><path fill="currentColor" d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4z"></path></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-star"><path fill="currentColor" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2L9.19 8.63L2 9.24l5.46 4.73L5.82 21z"></path></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-alert-success"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m-2 15l-5-5l1.41-1.41L10 14.17l7.59-7.59L19 8z"></path></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-alert-error"><path fill="currentColor" d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10s10-4.47 10-10S17.53 2 12 2m-1 15h2v2h-2zm0-12h2v10h-2z"></path></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="icon-alert-confirm"><path fill="currentColor" d="M1 21h22L12 2L1 21m12-3h-2v-2h2m0-4h-2v-4h2"></path></symbol></svg>
    
    <div id="login-container">
        <div id="login-section" class="login-box">
            <div class="logo"><svg class="icon" style="width:1.2em; height:1.2em;"><use href="#icon-quran"></use></svg></div>
            <h1>پرتال اساتید</h1><p>برای مدیریت دوره‌ها وارد شوید.</p>
            <form id="login-form">
                <div class="input-wrapper"><svg class="input-icon icon"><use href="#icon-user"></use></svg><input type="tel" inputmode="numeric" pattern="[0-9]*" id="nationalId" class="form-input" placeholder="کد ملی" required></div>
                <div class="input-wrapper"><svg class="input-icon icon"><use href="#icon-lock"></use></svg><input type="password" id="password" class="form-input" placeholder="رمز عبور" required></div>
                <button type="submit" class="btn-primary"><span class="btn-text">ورود</span><div class="spinner"></div></button>
            </form>
            <p id="error-message"></p>
        </div>
    </div>
    
    <div id="dashboard-view" class="hidden">
        <div class="container">
            <div class="dashboard-header"><div class="header-welcome"><div id="welcome-message" style="font-size: 1.5rem;"></div><div class="header-loader"></div></div><button id="logout-btn" class="icon-btn delete-btn"><svg class="icon"><use href="#icon-logout"></use></svg><span class="btn-text">خروج</span></button></div>
            <div id="create-course-container"></div>
            <div id="courses-container" style="margin-top:30px;"></div>
        </div>
    </div>
    <div id="modal-container"></div>
<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrKgoFDb7Yt1xoxbACi4Oje8mzZRFAwyL07TXvtTl1zqrAj4R-dGYb2txHgJPrg-P8mw/exec";
    const sessionKey = 'quranTeacherSession';
    let loggedInInstructorId = null, loggedInInstructorName = null, tempStudents = []; let currentCourseId = null, currentStudentOriginalId = null;
    let existingStudentsByCourse = {};

    async function callAppsScript(action, params = {}, button = null) {
        if(button) setButtonLoading(button, true);
        try { const res = await fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', headers: {'Content-Type': 'text/plain;charset=utf-8'}, body: JSON.stringify({ action, params }) }); if (!res.ok) throw new Error(`Network error: ${res.statusText}`); return await res.json();
        } catch (error) { showCustomAlert('خطا در ارتباط با سرور.', 'error'); return { success: false, message: error.message };
        } finally { if(button) setButtonLoading(button, false); }
    }
    
    function setButtonLoading(button, isLoading) { if(!button) return; if(isLoading) { button.disabled = true; button.classList.add('loading'); } else { button.disabled = false; button.classList.remove('loading'); } }
    
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('login-form').addEventListener('submit', handleManualLogin);
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        const savedSession = localStorage.getItem(sessionKey);
        if (savedSession) { const { nationalId, name } = JSON.parse(savedSession); showDashboard(nationalId, name); }
    });

    function showDashboard(nationalId, name) {
        loggedInInstructorId = nationalId; loggedInInstructorName = name;
        document.getElementById('login-container').classList.add('hidden'); document.getElementById('dashboard-view').classList.remove('hidden');
        document.getElementById('welcome-message').innerHTML = `استاد <strong>${name}</strong>، خوش آمدید.`;
        fetchDashboardData();
    }
    
    async function handleManualLogin(event) {
        event.preventDefault(); const nationalId = document.getElementById('nationalId').value; const password = document.getElementById('password').value;
        const button = event.target.querySelector('button'); button.classList.add('loading');
        const res = await callAppsScript('checkLogin', { nationalId, password });
        button.classList.remove('loading');
        if (res.success) { localStorage.setItem(sessionKey, JSON.stringify({ nationalId: nationalId, name: res.name })); showDashboard(nationalId, res.name);
        } else { const errorP = document.getElementById('error-message'); errorP.textContent = res.message || "خطای ورود."; }
    }

    function handleLogout() { localStorage.removeItem(sessionKey); window.location.reload(); }

    async function fetchDashboardData() {
        renderSkeletonLoader();
        document.querySelector('.dashboard-header').classList.add('loading');
        const res = await callAppsScript('getInstructorDashboardData', { instructorId: loggedInInstructorId });
        document.querySelector('.dashboard-header').classList.remove('loading');
        if(res.success) renderCourses(res.data); else showCustomAlert("خطا در دریافت اطلاعات: " + res.message, 'error'); return true;
    }
    
    function renderSkeletonLoader() { 
        document.getElementById('create-course-container').innerHTML = '<div class="skeleton button"></div>';
        let skeletonHTML = ''; for (let i = 0; i < 2; i++) { skeletonHTML += `<div class="card"><div class="skeleton title"></div><div class="skeleton text"></div><div class="skeleton table-head"></div><div class="skeleton table-row"></div><div class="skeleton table-row"></div></div>`; } 
        document.getElementById('courses-container').innerHTML = skeletonHTML;
    }

    function renderCourses(courses) {
        document.getElementById('create-course-container').innerHTML = '<button id="btn-create-course" class="btn"><svg class="icon"><use href="#icon-plus-circle"></use></svg><span class="btn-text">ایجاد دوره جدید</span></button>';
        document.getElementById('btn-create-course').addEventListener('click', e => showCreateCourseModal(e.target));

        const container = document.getElementById('courses-container'); container.innerHTML = !courses || courses.length === 0 ? '<p style="text-align: center;">شما هنوز هیچ دوره‌ای ایجاد نکرده‌اید.</p>' : '';
        existingStudentsByCourse = {};
        courses.forEach(course => {
            existingStudentsByCourse[course.courseId] = new Set(course.students.map(s => s.nationalId));
            const startDate = jalaliToGregorian(course.startDate.split('/').map(Number)[0], course.startDate.split('/').map(Number)[1], course.startDate.split('/').map(Number)[2]);
            const today = new Date(); startDate.setHours(0,0,0,0); today.setHours(0,0,0,0);
            const diffDays = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24));
            const canAddStudent = diffDays < 25; const canDeleteCourse = diffDays < 20; const canEditDate = diffDays <= 0;
            let addStudentBtn = canAddStudent ? `<button class="btn" onclick="showAddStudentModal(event, '${course.courseId}')"><svg class="icon"><use href="#icon-plus-circle"></use></svg><span class="btn-text">افزودن قرآن آموز</span></button>` : '';
            let editDateBtn = canEditDate ? `<button class="btn" onclick="showEditDateModal(event, '${course.courseId}')"><svg class="icon"><use href="#icon-pencil"></use></svg><span class="btn-text">ویرایش تاریخ</span></button>` : '';
            let deleteCourseBtn = canDeleteCourse ? `<button class="btn danger" onclick="showDeleteCourseModal(event, '${course.courseId}')"><svg class="icon"><use href="#icon-trash"></use></svg><span class="btn-text">حذف دوره</span></button>` : '';
            
            let studentsHtml = '<p style="text-align: center; color: var(--text-light);">هنوز قرآن‌آموزی ثبت نشده است.</p>';
            if (course.students.length > 0) {
                studentsHtml = `<table class="data-table"><thead><tr><th>نام و نام خانوادگی</th><th>کد ملی</th><th>نمره کل</th><th>وضعیت گواهی</th><th>عملیات</th></tr></thead><tbody>
                    ${course.students.map(s => {
                        const hasGrade = s.totalScore && s.totalScore != '0';
                        let scoreDisplay = !hasGrade ? `<button class="icon-btn" onclick="showGradingModal(event, '${course.courseId}', '${course.startDate}', '${s.name}', '${s.nationalId}')"><svg class="icon"><use href="#icon-grade"></use></svg><span class="btn-text">ثبت نمره</span></button>` : `<strong>${s.totalScore}</strong>`;
                        let certStatusDisplay = ''; let studentActionsDisplay = '';
                        if (hasGrade) {
                            switch(s.certificateStatus) {
                                case '0': certStatusDisplay = `<span style="color: var(--danger); font-weight: bold;">مردود</span>`; studentActionsDisplay = `<span style="color: var(--danger); font-size: 1.5rem; font-weight: bold;">—</span>`; break;
                                case '2': certStatusDisplay = `<span>بررسی</span>`; studentActionsDisplay = ``; break;
                                case '5': certStatusDisplay = `<span style="color: var(--success); font-weight: bold;">صدور</span>`; studentActionsDisplay = `<a href="https://tashacol.ir/equran.html" target="_blank" class="icon-btn" title="مشاهده گواهی"><svg class="icon" style="color:var(--warning);"><use href="#icon-star"></use></svg></a>`; break;
                                default: certStatusDisplay = ''; studentActionsDisplay = '';
                            }
                        } else { studentActionsDisplay = `<div class="student-actions"><button class="icon-btn" onclick="showEditStudentModal(event, '${course.courseId}', '${s.name}', '${s.nationalId}')" title="ویرایش"><svg class="icon"><use href="#icon-pencil"></use></svg></button><button class="icon-btn delete-btn" onclick="showDeleteStudentModal(event, '${course.courseId}', '${s.name}', '${s.nationalId}')" title="حذف"><svg class="icon"><use href="#icon-trash"></use></svg></button></div>`; }
                        return `<tr><td>${s.name||''}</td><td>${s.nationalId||''}</td><td>${scoreDisplay}</td><td>${certStatusDisplay}</td><td>${studentActionsDisplay}</td></tr>`
                    }).join('')}</tbody></table>`;
            }
            container.innerHTML += `<div class="card"><div class="card-header"><h4>دوره روخوانی (کد: ${course.courseId})</h4><span>تاریخ شروع: ${course.startDate}</span></div>${studentsHtml}<div class="card-actions">${addStudentBtn}${editDateBtn}${deleteCourseBtn}</div></div>`;
        });
    }

    const modalContainer = document.getElementById('modal-container');
    function renderModal(title, content) { modalContainer.innerHTML = `<div class="modal"><div class="modal-content"><div class="modal-header"><h3>${title}</h3><button class="close-btn" onclick="closeAllModals()">×</button></div>${content}</div></div>`; }
    function closeAllModals() { modalContainer.innerHTML = ''; }
    
    function showCustomAlert(message, type = 'info') {
        const icons = { success: 'icon-alert-success', error: 'icon-alert-error', info: 'icon-alert-confirm' }; const iconClass = type === 'info' ? 'confirm' : type;
        const content = `<div class="alert-icon ${iconClass}"><svg class="icon"><use href="#${icons[type]}"></use></svg></div><p class="alert-message">${message}</p><div class="alert-buttons"><button class="btn" onclick="closeAllModals()"><span class="btn-text">باشه</span></button></div>`;
        modalContainer.innerHTML = `<div class="modal"><div class="modal-content alert-modal-content">${content}</div></div>`;
    }
    function showCustomConfirm(message) {
        return new Promise((resolve) => {
            const content = `<div class="alert-icon confirm"><svg class="icon"><use href="#icon-alert-confirm"></use></svg></div><p class="alert-message">${message}</p><div class="alert-buttons"><button id="confirm-btn-yes" class="btn"><span class="btn-text">تایید</span></button><button id="confirm-btn-no" class="btn secondary"><span class="btn-text">لغو</span></button></div>`;
            modalContainer.innerHTML = `<div class="modal"><div class="modal-content alert-modal-content">${content}</div></div>`;
            document.getElementById('confirm-btn-yes').onclick = () => { closeAllModals(); resolve(true); }; document.getElementById('confirm-btn-no').onclick = () => { closeAllModals(); resolve(false); };
        });
    }
    
    function getTodayJalaliString() { const p2e = s => s.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d)); return p2e(new Date().toLocaleDateString('fa-IR', {year: 'numeric', month: '2-digit', day: '2-digit'})); }
    function populateDatePicker(prefix = 'start') {
        let opts = { d: '', m: '', y: ''}; for (let i = 1; i <= 31; i++) opts.d += `<option value="${i}">${i}</option>`; ["فروردین","اردیبهشت","خرداد","تیر","مرداد","شهریور","مهر","آبان","آذر","دی","بهمن","اسفند"].forEach((m, i) => opts.m += `<option value="${i+1}">${m}</option>`); opts.y = `<option value="${new Date().toLocaleDateString('fa-IR-u-nu-latn').split('/')[0]}">${new Date().toLocaleDateString('fa-IR-u-nu-latn').split('/')[0]}</option>`;
        return `<select id="${prefix}-day" class="form-input">${opts.d}</select><select id="${prefix}-month" class="form-input">${opts.m}</select><select id="${prefix}-year" class="form-input" disabled>${opts.y}</select>`;
    }
    function jalaliToGregorian(jy, jm, jd) { var sal_a, gy, gm, gd, days; jy += 1595; days = -355668 + (365 * jy) + (~~(jy / 33) * 8) + ~~(((jy % 33) + 3) / 4) + jd + ((jm < 7) ? (jm - 1) * 31 : ((jm - 7) * 30) + 186); gy = 400 * ~~(days / 146097); days %= 146097; if (days > 36524) { gy += 100 * ~~(--days / 36524); days %= 36524; if (days >= 365) days++; } gy += 4 * ~~(days / 1461); days %= 1461; if (days > 365) { gy += ~~((days - 1) / 365); days = (days - 1) % 365; } gd = days + 1; sal_a = [0, 31, ((gy % 4 === 0 && gy % 100 !== 0) || (gy % 400 === 0)) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]; for (gm = 0; gm < 13 && gd > sal_a[gm]; gm++) gd -= sal_a[gm]; return new Date(gy, gm - 1, gd); }

    function showCreateCourseModal() { renderModal('ایجاد دوره جدید', `<p>نام دوره: روخوانی و روانخوانی قرآن کریم</p><div class="form-group"><label>تاریخ شروع</label><div style="display:flex; gap:10px;">${populateDatePicker('start')}</div></div><button class="btn" onclick="handleCreateCourse(event)"><span class="btn-text">ایجاد دوره</span></button>`); }
    async function handleCreateCourse(event) {
        const date = `${document.getElementById('start-year').value}/${document.getElementById('start-month').value.padStart(2,'0')}/${document.getElementById('start-day').value.padStart(2,'0')}`;
        if (date < getTodayJalaliString()) { showCustomAlert("تاریخ انتخابی نمی‌تواند در گذشته باشد.", "error"); return; }
        const res = await callAppsScript('createNewCourse', { instructorId: loggedInInstructorId, startDate: date }, event.target);
        if (res.success) { showCustomAlert('دوره با موفقیت ایجاد شد!', 'success'); fetchDashboardData(); } else showCustomAlert('خطا: ' + res.message, 'error'); closeAllModals();
    }
    
    function showEditDateModal(event, courseId) { currentCourseId = courseId; renderModal('ویرایش تاریخ دوره', `<div class="form-group"><label>تاریخ جدید</label><div style="display:flex; gap:10px;">${populateDatePicker('edit')}</div></div><button class="btn" onclick="handleUpdateCourseDate(event)"><span class="btn-text">ذخیره</span></button>`); }
    async function handleUpdateCourseDate(event) {
        const newDate = `${document.getElementById('edit-year').value}/${document.getElementById('edit-month').value.padStart(2, '0')}/${document.getElementById('edit-day').value.padStart(2, '0')}`;
        if (newDate < getTodayJalaliString()) { showCustomAlert("تاریخ انتخابی نمی‌تواند در گذشته باشد.", "error"); return; }
        const res = await callAppsScript('updateCourseDate', { courseId: currentCourseId, newDate }, event.target);
        if (res.success) { showCustomAlert(res.message, 'success'); fetchDashboardData(); } else showCustomAlert("خطا: " + res.message, 'error'); closeAllModals();
    }
    
    function showDeleteCourseModal(event, courseId) { currentCourseId = courseId; renderModal('تایید حذف دوره', `<p style="color:var(--danger);">آیا از حذف این دوره و تمام قرآن‌آموزان آن اطمینان دارید؟</p><div class="form-group"><label for="delete-password">برای تایید، رمز عبور را وارد کنید:</label><input type="password" id="delete-password" class="form-input"></div><button class="btn danger" onclick="handleDeleteCourse(event)"><span class="btn-text">بله، حذف کن</span></button>`); }
    async function handleDeleteCourse(event) {
        const password = document.getElementById('delete-password').value; if (!password) { showCustomAlert("رمز عبور الزامی است.", 'error'); return; }
        const res = await callAppsScript('deleteCourse', { courseId: currentCourseId, instructorId: loggedInInstructorId, password }, event.target);
        if (res.success) { showCustomAlert(res.message, 'success'); fetchDashboardData(); } else showCustomAlert("خطا: " + res.message, 'error'); closeAllModals();
    }

    function showAddStudentModal(event, courseId) { currentCourseId = courseId; tempStudents = []; renderModal(`افزودن قرآن آموز به دوره ${courseId}`, `<div id="add-student-form"><div class="form-group"><label for="student-name">نام</label><input type="text" id="student-name" class="form-input"></div><div class="form-group"><label for="student-nationalId">کد ملی</label><input type="tel" inputmode="numeric" pattern="[0-9]*" id="student-nationalId" class="form-input"></div><button class="btn" onclick="addStudentToTempList(event)"><span class="btn-text">افزودن به لیست</span></button></div><h4>لیست موقت</h4><ul id="temp-student-list" style="list-style-position: inside;"></ul><br><button class="btn" onclick="saveStudentList(event)"><span class="btn-text">ذخیره نهایی لیست</span></button>`); }
    function addStudentToTempList() { const name = document.getElementById('student-name'), nid = document.getElementById('student-nationalId'); if (name.value.trim() && nid.value.trim()) { const nationalId = nid.value.trim(); if (tempStudents.some(s => s.nationalId === nationalId)) { showCustomAlert('این کد ملی در لیست موقت شما وجود دارد.', 'error'); return; } if (existingStudentsByCourse[currentCourseId] && existingStudentsByCourse[currentCourseId].has(nationalId)) { showCustomAlert('این قرآن‌آموز قبلاً در این دوره ثبت‌نام شده است.', 'error'); return; } tempStudents.push({ name: name.value.trim(), nationalId: nationalId }); document.getElementById('temp-student-list').innerHTML = tempStudents.map(s => `<li>${s.name} - ${s.nationalId}</li>`).join(''); name.value = ''; nid.value = ''; name.focus(); } else showCustomAlert('نام و کد ملی الزامی است.', 'error'); }
    async function saveStudentList(event) {
        if (tempStudents.length === 0) { showCustomAlert('لیست خالی است.', 'error'); return; }
        const res = await callAppsScript('addStudentsToCourse', { courseId: currentCourseId, students: tempStudents, instructorName: loggedInInstructorName }, event.target);
        if (res.success) { showCustomAlert(res.message, 'success'); fetchDashboardData(); } else showCustomAlert('خطا: ' + res.message, 'error'); closeAllModals();
    }
    
    function showEditStudentModal(event, courseId, name, nid) { currentCourseId = courseId; currentStudentOriginalId = nid; renderModal('ویرایش قرآن آموز', `<div class="form-group"><label for="edit-student-name">نام</label><input type="text" id="edit-student-name" class="form-input" value="${name}"></div><div class="form-group"><label for="edit-student-nationalId">کد ملی</label><input type="tel" inputmode="numeric" pattern="[0-9]*" id="edit-student-nationalId" class="form-input" value="${nid}"></div><button class="btn" onclick="handleUpdateStudent(event)"><span class="btn-text">ذخیره</span></button>`); }
    async function handleUpdateStudent(event) {
        const newName = document.getElementById('edit-student-name').value.trim(), newNid = document.getElementById('edit-student-nationalId').value.trim();
        if(!newName || !newNid) { showCustomAlert("فیلدها نباید خالی باشند.", 'error'); return;}
        const res = await callAppsScript('updateStudentInfo', { courseId: currentCourseId, originalNationalId: currentStudentOriginalId, newName, newNationalId: newNid }, event.target);
        if (res.success) { showCustomAlert(res.message, 'success'); fetchDashboardData(); } else showCustomAlert("خطا: " + res.message, 'error'); closeAllModals();
    }
    
    function showDeleteStudentModal(event, courseId, studentName, studentNationalId) { currentCourseId = courseId; currentStudentOriginalId = studentNationalId; renderModal('تایید حذف قرآن‌آموز', `<p>آیا از حذف قرآن‌آموز <strong>${studentName}</strong> (کد ملی: ${studentNationalId}) اطمینان دارید؟</p><p style="color:var(--danger);">این عمل غیرقابل بازگشت است.</p><button class="btn danger" onclick="handleDeleteStudent(event)"><span class="btn-text">بله، حذف کن</span></button>`); }
    async function handleDeleteStudent(event) {
        const res = await callAppsScript('deleteStudent', { courseId: currentCourseId, studentNationalId: currentStudentOriginalId }, event.target);
        if (res.success) { showCustomAlert(res.message, 'success'); fetchDashboardData(); } else { showCustomAlert("خطا: " + res.message, 'error'); } closeAllModals();
    }

    function showGradingModal(event, courseId, courseStartDate, studentName, studentNationalId) {
        const [year, month, day] = courseStartDate.split('/').map(Number); const startDate = jalaliToGregorian(year, month, day); const today = new Date(); startDate.setHours(0,0,0,0); today.setHours(0,0,0,0); const diffDays = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24));
        if (diffDays < 25) { showCustomAlert(`امکان نمره‌دهی وجود ندارد.\nباید حداقل ۲۵ روز از تاریخ شروع دوره (${courseStartDate}) گذشته باشد.`, 'error'); return; }
        currentCourseId = courseId; currentStudentOriginalId = studentNationalId;
        const content = `<p><strong>نام:</strong> ${studentName} | <strong>کد ملی:</strong> ${studentNationalId}</p><hr>
            <div class="form-group"><label>صحت حروف (از بیست نمره)</label><input type="number" id="g1" min="0" max="20" class="form-input"></div><div class="form-group"><label>صحت حرکات (از بیست نمره)</label><input type="number" id="g2" min="0" max="20" class="form-input"></div>
            <div class="form-group"><label>حروف ناخوانا (از بیست نمره)</label><input type="number" id="g3" min="0" max="20" class="form-input"></div><div class="form-group"><label>وقف و ابتدا (از بیست نمره)</label><input type="number" id="g4" min="0" max="20" class="form-input"></div>
            <div class="form-group"><label>التقاء ساکنین (از بیست نمره)</label><input type="number" id="g5" min="0" max="20" class="form-input"></div><button class="btn" onclick="handleGradeSubmission(event)"><span class="btn-text">تایید و ارسال نمرات</span></button>`;
        renderModal('ثبت نمره برای قرآن آموز', content);
    }
    async function handleGradeSubmission(event) {
        const grades = {}; for(let i=1; i<=5; i++) { const gradeVal = document.getElementById(`g${i}`).value; if(gradeVal === '' || isNaN(gradeVal) || gradeVal < 0 || gradeVal > 20) { showCustomAlert(`نمره برای همه موارد باید عددی بین 0 و 20 باشد.`, 'error'); return; } grades[`g${i}`] = Number(gradeVal); }
        const confirmed = await showCustomConfirm("آیا از ثبت نمرات اطمینان دارید؟ نمرات پس از ثبت قابل ویرایش نیستند.");
        if (confirmed) {
            const res = await callAppsScript('submitStudentGrades', { courseId: currentCourseId, studentNationalId: currentStudentOriginalId, grades }, event.target);
            if (res.success) { showCustomAlert(res.message, 'success'); fetchDashboardData(); } else showCustomAlert("خطا: " + res.message, 'error'); closeAllModals();
        }
    }
</script>
</body>
</html>
