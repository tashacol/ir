<!DOCTYPE html>
<html lang="fa">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>درخواست نامه اداری</title> {/* Title changed slightly to be more general */}
    <style>
        body {
            font-family: Arial, sans-serif; /* Base font */
            margin: 0;
            padding: 0;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7); /* پس‌زمینه تار */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* بالاتر از سایر عناصر */
        }

        .loader {
            border: 8px solid #f3f3f3; /* رنگ لودینگ */
            border-top: 8px solid #3498db; /* رنگ قسمت متحرک */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite; /* انیمیشن چرخش */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @font-face {
            font-family: 'IranNastaliq'; /* Font for letter content */
            src: url('https://tashacol.github.io/ir/IranNastaliq.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        /* استایل کلی صفحه با پس‌زمینه رنگی و جذاب */
        body {
            direction: rtl;
            font-family: Tahoma, Arial, sans-serif; /* Default font for form, etc. */
            font-size: 14px;
            padding: 20px;
            background: linear-gradient(135deg, #c2e9fb, #a1c4fd);
        }
        h2 {
            text-align: center;
            color: #333;
            font-family: Tahoma, Arial, sans-serif; /* Ensure heading uses a standard font */
        }
        /* استایل فرم مشخصات با پس‌زمینه شفاف و حاشیه گرد سه‌بعدی */
        #letterForm {
            background: #d7d9a3;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            margin: 20px auto;
            border: 1px solid #ddd;
        }
        label {
            display: block;
            margin-top: 15px; /* Increased margin for better spacing */
            color: #555;
            font-weight: bold; /* Make labels stand out */
        }
        /* استایل فیلدهای ورود اطلاعات با طراحی مدرن، سه‌بعدی و رنگارنگ */
        input, textarea { /* Combined styles for input and textarea */
            width: 100%;
            padding: 12px 15px;
            font-size: 14px;
            margin-top: 5px;
            box-sizing: border-box;
            border: none;
            border-radius: 10px;
            background: #fff;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            font-family: Tahoma, Arial, sans-serif; /* Ensure inputs use standard font */
        }
        textarea {
             min-height: 120px; /* Give textarea a decent starting height */
             resize: vertical; /* Allow vertical resizing */
        }
        input:focus, textarea:focus { /* Combined focus styles */
            box-shadow: 0 0 8px rgba(102, 175, 233, 0.6);
            outline: none;
            transform: translateY(-2px);
        }
        /* دکمه‌های تولید و دانلود با ظاهر مدرن، سه‌بعدی و رنگارنگ */
        #generateBtn, #downloadBtn {
            margin-top: 25px; /* Increased margin */
            padding: 12px 25px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            color: #fff;
            background: linear-gradient(145deg, #ff6b6b, #ff4757);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
             font-family: Tahoma, Arial, sans-serif; /* Ensure buttons use standard font */
        }
        #generateBtn:hover, #downloadBtn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        #generateBtn:active, #downloadBtn:active {
            transform: translateY(1px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
        }
        /* استایل بخش محتوای نامه */
        #letterContent {
            margin-top: 40px;
            width: 148mm; /* A5 width */
            height: 210mm; /* A5 height */
            padding: 10mm;
            border: 1px solid #000;
            box-sizing: border-box;
            position: relative;
            background-color: #fff;
            font-family: 'IranNastaliq', Tahoma, sans-serif; /* Apply Nastaliq font here */
        }
        #letterContent * {
            font-size: 16px; /* Slightly larger font size for Nastaliq */
            line-height: 1.5; /* Adjusted line height for Nastaliq */
            margin: 0;
             font-family: inherit; /* Inherit font from #letterContent */
        }
        .header-right {
            position: absolute;
            top: 10mm;
            right: 10mm;
            text-align: right;
        }
         .header-right p { line-height: 1.3; font-size: 14px;} /* Specific style for header */

        .header-left {
            position: absolute;
            top: 10mm;
            left: 10mm;
            text-align: left;
        }
         .header-left p { line-height: 1.3; font-size: 14px;} /* Specific style for header */

        .line {
            width: calc(100% - 20mm);
            height: 1px;
            background-color: #000;
            position: absolute;
            top: 35mm; /* Adjusted position based on header content */
            left: 10mm;
        }
        .content {
            position: absolute;
            top: 38mm; /* Start content below the line */
            left: 10mm;
            right: 10mm;
            text-align: right;
            white-space: normal; /* Allow normal wrapping */
        }
        .content p {
            margin-bottom: 8px; /* Spacing between paragraphs */
        }
        .content p.spacing {
            margin-bottom: 12px; /* Larger spacing */
        }

        /* Style for the main letter body text */
        #letterBodyText {
             text-align: center;
             margin-top: 15px;    /* Space from 'Salam Aleikum' */
             margin-bottom: 15px; /* Space before signature */
             margin-left: 25px;   /* Right margin (since RTL) */
             margin-right: 25px;  /* Left margin (since RTL) */
             padding: 10px 0;     /* Vertical padding */
             white-space: pre-line; /* Preserve line breaks from textarea */
             line-height: 1.7; /* Increase line height for readability */
        }

        .signature {
            text-align: center;
            margin-top: 30px; /* Space above signature */
        }
         .signature p {
             line-height: 1.4;
         }

         /* Footer text positioning */
         .footer-note {
            position: absolute;
            bottom: 10mm; /* Position at the bottom */
            left: 10mm;
            right: 10mm;
            text-align: center;
            font-size: 12px !important; /* Smaller font size for footer note */
             font-family: Tahoma, Arial, sans-serif !important; /* Standard font for footer note */
             line-height: 1.2 !important;
         }

        /* استایل برای نمایش لودینگ */
        #loading {
            display: none; /* در ابتدا مخفی */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border: 1px solid #000;
            z-index: 1000;
            text-align: center;
            font-size: 18px;
             font-family: Tahoma, Arial, sans-serif; /* Standard font for loading message */
        }
    </style>
    <!-- اضافه کردن کتابخانه jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- اضافه کردن کتابخانه html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay">
        <div class="loader"></div>
    </div>

    <script>
        // Hide loading overlay once the page is fully loaded
        window.addEventListener('load', function() {
            document.querySelector('.loading-overlay').style.display = 'none';
        });
    </script>

    <h2>صدور نامه اداری</h2> {/* Title changed */}
    <form id="letterForm">
        <label for="department">نام اداره:</label>
        <input type="text" id="department" required>

        <label for="letterSubjectInput">موضوع:</label>
        <input type="text" id="letterSubjectInput" required>

        <label for="letterBodyInput">متن نامه:</label>
        <textarea id="letterBodyInput" rows="8" required></textarea> {/* Changed to textarea */}

        <button type="button" id="generateBtn">تولید نامه</button>
    </form>

    <div id="letterContent" style="display: none;">
        <div class="header-right">
            {/* === START: HEADER RIGHT CHANGES === */}
            <p>مؤسسه تعالی اندیشه و رشد، تأسيس 1400</p>
            <p>شناسه ملی: 14013770611</p>
            {/* === END: HEADER RIGHT CHANGES === */}
            <p>شماره تماس: ۰۹۱۳۵۰۷۶۵۸۷</p> {/* Kept as requested */}
        </div>
        <div class="header-left">
            <p id="letterNumber">شماره نامه: </p>
            <p id="currentDate">تاریخ: </p>
        </div>
        <div class="line"></div>
        <div class="content">
            <p style="text-align: center; font-weight: bold; margin-bottom: 15px;">بسمه تعالی</p> {/* Added more margin */}
            <p>ریاست محترم <span id="departmentName"></span></p>
            {/* === START: SUBJECT CHANGE === */}
            <p>موضوع: <span id="letterSubject"></span></p>
            {/* === END: SUBJECT CHANGE === */}
            <p class="spacing">سلام علیکم،</p> {/* Changed from 'با سلام و احترام' */}

            {/* === START: LETTER BODY AREA === */}
            <div id="letterBodyText">
                {/* Content from the 'متن نامه' textarea will go here */}
            </div>
            {/* === END: LETTER BODY AREA === */}

            <div class="signature">
                <p>امضاء</p>
                {/* === START: SIGNATURE TITLE CHANGE === */}
                <p>مدیرعامل مؤسسه تعالی اندیشه و رشد</p>
                {/* === END: SIGNATURE TITLE CHANGE === */}
            </div>

            {/* === START: FOOTER NOTE CHANGE === */}
            <p class="footer-note">
                این نامه به صورت الکترونیک صادر شده و بدون مهر و امضاء اعتباری ندارد.
            </p>
            {/* === END: FOOTER NOTE CHANGE === */}
        </div>
    </div>

    <button type="button" id="downloadBtn" style="display: none;">دانلود PDF</button>

    <!-- بخش لودینگ -->
    <div id="loading">
        نامه در حال تولید است، لطفاً کمی صبر کنید...
    </div>

    <script>
        // تابع تبدیل ارقام انگلیسی به فارسی
        function convertToPersianDigits(str) {
            if (typeof str !== 'string') str = String(str); // Ensure input is a string
            const persianDigits = '۰۱۲۳۴۵۶۷۸۹';
            return str.replace(/\d/g, function(d) {
                return persianDigits[parseInt(d)]; // Use parseInt to handle potential issues
            });
        }

        // نمایش محتوای نامه
        document.getElementById('generateBtn').addEventListener('click', function () {
            // Get values from the updated form fields
            const department = document.getElementById('department').value;
            const letterSubjectValue = document.getElementById('letterSubjectInput').value; // New field
            const letterBodyValue = document.getElementById('letterBodyInput').value;     // New field (textarea)

            // Validate the new required fields
            if (department && letterSubjectValue && letterBodyValue) {
                const letterContent = document.getElementById('letterContent');
                letterContent.style.display = 'block';

                // مخفی کردن فرم پس از ارسال مشخصات
                document.getElementById('letterForm').style.display = 'none';

                // Generate date and letter number (remains the same)
                const now = new Date();
                const currentDate = now.toLocaleDateString('fa-IR', { year: 'numeric', month: '2-digit', day: '2-digit' }); // Standard format
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const formattedTime = hours + minutes;
                const letterNumber = formattedTime + '/ب'; // Simple letter number logic

                // Populate letter content
                document.getElementById('letterNumber').innerText = 'شماره نامه: ' + convertToPersianDigits(letterNumber);
                document.getElementById('currentDate').innerText = 'تاریخ: ' + convertToPersianDigits(currentDate);
                document.getElementById('departmentName').innerText = department;
                document.getElementById('letterSubject').innerText = letterSubjectValue; // Populate new subject span
                document.getElementById('letterBodyText').innerText = letterBodyValue; // Populate new body div

                // Show download button
                document.getElementById('downloadBtn').style.display = 'inline-block';
            } else {
                alert('لطفاً تمام فیلدها (نام اداره، موضوع، متن نامه) را تکمیل کنید.'); // Updated alert message
            }
        });

        // دانلود PDF
        document.getElementById('downloadBtn').addEventListener('click', function () {
            const { jsPDF } = window.jspdf;

            // نمایش لودینگ
            const loadingElement = document.getElementById('loading');
            loadingElement.style.display = 'block';

            const letterElement = document.getElementById('letterContent');

            // Use html2canvas to capture the letter content
            html2canvas(letterElement, {
                scale: 4, // Increased scale for better quality PDF
                useCORS: true, // Important for external resources like fonts
                logging: false, // Disable extensive logging in console
                onclone: function(clonedDoc) {
                    // Ensure the element is visible in the cloned document for rendering
                    clonedDoc.getElementById('letterContent').style.display = 'block';
                    // Attempt to re-apply font styles in the cloned document (might help with font rendering)
                     const letterContentClone = clonedDoc.getElementById('letterContent');
                     letterContentClone.style.fontFamily = "'IranNastaliq', Tahoma, sans-serif";
                     const allElements = letterContentClone.getElementsByTagName('*');
                     for (let i = 0; i < allElements.length; i++) {
                       allElements[i].style.fontFamily = 'inherit';
                    }
                }
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a5', // Equivalent to [148, 210]
                    compress: true // Enable compression
                });

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                // Calculate image dimensions to fit the PDF page
                const imgProps = pdf.getImageProperties(imgData);
                const imgWidth = pdfWidth;
                const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                
                // Ensure image height does not exceed PDF height, adjust if necessary
                let finalHeight = imgHeight;
                if (imgHeight > pdfHeight) {
                    finalHeight = pdfHeight; // Cap height to page height
                     // Optionally recalculate width based on capped height, but fitting width is usually better
                }


                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, finalHeight);
                pdf.save('نامه-اداری.pdf'); // Changed filename slightly

                // مخفی کردن لودینگ پس از اتمام
                loadingElement.style.display = 'none';
            }).catch(err => {
                console.error("Error generating PDF:", err); // Log error for debugging
                // مخفی کردن لودینگ در صورت بروز خطا
                loadingElement.style.display = 'none';
                alert('خطایی در تولید PDF رخ داده است. لطفاً دوباره امتحان کنید یا کنسول را برای جزئیات بررسی کنید.');
            });
        });
    </script>
</body>
</html>
