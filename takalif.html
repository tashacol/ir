<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>بررسی و ارسال تکالیف</title>
  <style>
    /* --- استایل‌های پایه و ریسپانسیو --- */
    :root {
      --primary-color: #007bff;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --light-gray: #f8f9fa;
      --dark-gray: #343a40;
      --shadow-light: 0 5px 20px rgba(0,0,0,0.08);
      --shadow-heavy: 0 8px 25px rgba(0,0,0,0.1);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      direction: rtl; text-align: center;
      background: linear-gradient(135deg, #e0f2f7, #c1e0e9); /* پس زمینه آرام بخش */
      margin: 0; padding: 20px; color: var(--dark-gray);
      min-height: 100vh;
      display: flex; flex-direction: column;
    }
    .container {
      max-width: 960px; /* افزایش عرض برای محتوای بیشتر */
      margin: 2rem auto;
      padding: 20px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      box-shadow: var(--shadow-heavy);
      flex-grow: 1;
    }
    h2 { color: var(--dark-gray); margin-bottom: 1.5rem; }
    #welcome-message {
      font-size: 1.1rem;
      color: #555;
      margin-bottom: 2rem;
      line-height: 1.6;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
    }
    /* --- فرم ورودی کد ملی --- */
    .input-group {
      margin-bottom: 2rem;
      display: flex; justify-content: center;
      box-shadow: var(--shadow-light);
      border-radius: 12px;
      overflow: hidden; /* برای گرد شدن گوشه‌ها */
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    #nationalCodeInput {
      flex-grow: 1;
      padding: 14px 20px;
      border: 1px solid #ddd;
      border-right: none; /* حذف خط جداکننده */
      border-radius: 0;
      transition: all 0.3s;
      font-size: 1rem;
      text-align: right;
    }
    #nationalCodeInput:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0,123,255,0.2);
      outline: none;
    }
    #checkBtn {
      padding: 14px 25px;
      border: none;
      background: var(--primary-color);
      color: white;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
      font-weight: bold;
      font-size: 1rem;
    }
    #checkBtn:hover {
      background: #0056b3;
      transform: translateY(-2px);
    }
    /* --- شبکه ترم‌ها --- */
    .terms-grid {
      display: none;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 2rem;
    }
    .term-box {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow-light);
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      border: 1px solid #eee; /* حاشیه ملایم */
    }
    .term-box:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-heavy);
    }
    .term-title {
      font-weight: bold;
      font-size: 1.3rem;
      margin-bottom: 15px;
      color: #333;
    }
    .status {
      padding: 6px 14px;
      border-radius: 20px;
      color: white;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 15px;
      display: inline-block;
      min-width: 100px;
    }
    .status-approved { background: var(--success-color); }
    .status-rejected { background: var(--danger-color); }
    .status-pending { background: var(--warning-color); color: var(--dark-gray); }
    .status-locked { background: #6c757d; }
    .buttons-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 15px;
    }
    .term-btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.95rem;
      text-shadow: 0 1px 1px rgba(0,0,0,0.1);
    }
    .btn-submit { background: var(--primary-color); color: white; }
    .btn-edit { background: var(--warning-color); color: var(--dark-gray); }
    .btn-reason { background: var(--info-color); color: white; }
    .term-btn:disabled { background: #e9ecef; color: #6c757d; cursor: not-allowed; opacity: 0.7; }
    .term-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

    /* --- استایل‌های لودر --- */
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 30px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* --- استایل‌های عمومی پاپ‌آپ‌ها (Overlay و Popup base) --- */
    .overlay {
      display: none; /* به صورت پیش فرض مخفی */
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.6); /* تیره‌تر */
      backdrop-filter: blur(5px); /* افکت بلور برای پس زمینه */
      transition: opacity 0.3s ease;
      opacity: 0;
      visibility: hidden;
    }
    .overlay.active {
      display: block;
      opacity: 1;
      visibility: visible;
    }
    .popup-base {
      background-color: #fefefe;
      margin: 8% auto; /* کمی بالاتر از مرکز */
      padding: 30px;
      border: none;
      border-radius: 18px; /* گردتر */
      width: 90%;
      max-width: 550px; /* افزایش عرض برای پاپ‌آپ‌ها */
      box-shadow: 0 15px 30px rgba(0,0,0,0.25); /* سایه عمیق‌تر */
      position: relative;
      transform: translateY(20px); /* انیمیشن ورود */
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
      text-align: right; /* متن راست چین */
    }
    .overlay.active .popup-base {
      transform: translateY(0);
      opacity: 1;
    }
    .popup-header {
      font-size: 1.8rem; /* بزرگتر */
      margin-bottom: 20px;
      color: var(--primary-color);
      font-weight: 600;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
      text-align: center;
    }
    .popup-body {
      margin-bottom: 20px;
      font-size: 1.1rem;
      line-height: 1.7;
      color: #444;
      max-height: 60vh; /* محدود کردن ارتفاع و افزودن اسکرول */
      overflow-y: auto;
      padding-left: 10px; /* برای اسکرول بار */
    }
    .popup-footer {
      margin-top: 25px;
      text-align: center;
      display: flex;
      gap: 15px;
      justify-content: center;
    }
    .popup-footer button {
      padding: 12px 25px;
      border: none;
      border-radius: 10px; /* گردتر */
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .popup-footer button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.15);
    }
    .popup-footer .confirm-btn { background: var(--primary-color); color: white; }
    .popup-footer .confirm-btn:hover { background: #0056b3; }
    .popup-footer .cancel-btn { background: #e0e0e0; color: var(--dark-gray); }
    .popup-footer .cancel-btn:hover { background: #ccc; }

    /* --- استایل‌های خاص پاپ‌آپ ارسال تکلیف --- */
    #submissionModal .popup-header { color: #00796b; }
    #submissionModal textarea {
      width: 100%;
      min-height: 180px; /* افزایش ارتفاع */
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background-color: #f9f9f9;
      box-shadow: inset 1px 1px 3px rgba(0,0,0,0.05);
      transition: all 0.3s;
      resize: vertical;
      font-size: 1rem;
      direction: rtl;
      text-align: right;
    }
    #submissionModal textarea:focus {
      border-color: #ffeb3b;
      box-shadow: 0 0 0 4px rgba(255,235,59,0.3);
      outline: none;
      background-color: white;
    }
    #submissionModal .word-count {
      font-size: 0.9rem;
      color: #666;
      text-align: left;
      margin-top: 5px;
    }
    .word-count.invalid { color: var(--danger-color); font-weight: bold; }

    /* --- استایل‌های Markdown ساده --- */
    #reasonContent strong { font-weight: bold; color: var(--primary-color); }
    #reasonContent ul { padding-right: 25px; margin-top: 10px; margin-bottom: 10px; }
    #reasonContent li { margin-bottom: 5px; }

    /* --- ریسپانسیو بودن --- */
    @media (max-width: 768px) {
      .container { margin: 1rem; padding: 15px; border-radius: 12px; }
      h2 { font-size: 1.8rem; }
      .input-group { max-width: 100%; }
      #nationalCodeInput, #checkBtn { padding: 12px 15px; font-size: 0.9rem; }
      .terms-grid { grid-template-columns: 1fr; gap: 15px; }
      .term-box { padding: 15px; }
      .term-title { font-size: 1.1rem; }
      .status { font-size: 0.8rem; padding: 4px 10px; }
      .term-btn { padding: 10px; font-size: 0.85rem; }
      .popup-base { margin: 5% auto; padding: 20px; width: 95%; }
      .popup-header { font-size: 1.5rem; }
      .popup-body { font-size: 1rem; }
      .popup-footer { flex-direction: column; gap: 10px; }
      .popup-footer button { width: 100%; }
    }
  </style>
</head>
<body>

  <div class="container">
    <h2>سیستم بررسی و ارسال تکالیف</h2>
    <p id="welcome-message">فراگیر گرامی، لطفا خلاصه‌ای کامل و دارای تمام نکات مهم از تمام فصل‌های هر ترم ارسال بفرمایید. لطفا عنوان هر فصل را در خطی جداگانه نوشته و زیر آن متن تکلیف را بنویسید. بهتر است تکلیف را در یادداشت‌ها یا ورد بنویسید و سپس کپی نموده و در قسمت ارسال تکالیف جای‌گذاری نمایید. </p>
    <div class="input-group">
      <input type="text" id="nationalCodeInput" placeholder="کد ملی خود را وارد کنید..." />
      <button id="checkBtn" onclick="fetchData()">بررسی</button>
    </div>
    <div id="loader" class="loader" style="display: none;"></div>
    <div id="userInfo" style="display: none;"><h3 id="userName"></h3></div>
    <div id="termsGrid" class="terms-grid"></div>
  </div>

  <!-- Modal برای ارسال/ویرایش تکلیف -->
  <div id="submissionModalOverlay" class="overlay">
    <div id="submissionModal" class="popup-base">
      <h3 id="submissionModalHeader" class="popup-header"></h3>
      <div class="popup-body">
        <div><strong>سوال:</strong></div>
        <p id="submissionModalQuestion" style="white-space: pre-wrap;"></p>
        <form id="submissionForm">
          <input type="hidden" id="termNumber">
          <label for="answerText"><strong>پاسخ شما:</strong></label>
          <textarea id="answerText" required placeholder="متن تکلیف خود را اینجا وارد کنید"></textarea>
          <div id="wordCount" class="word-count">تعداد کلمات: 0</div>
          <div class="popup-footer">
            <button type="submit" class="confirm-btn">ارسال تکلیف</button>
            <button type="button" class="cancel-btn" onclick="closeSubmissionModal()">انصراف</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal برای نمایش دلیل رد تکلیف -->
  <div id="reasonModalOverlay" class="overlay">
    <div id="reasonModal" class="popup-base">
      <h3 class="popup-header">دلیل رد تکلیف</h3>
      <div class="popup-body">
        <p id="reasonModalContent" style="white-space: pre-wrap; text-align: right;"></p>
      </div>
      <div class="popup-footer">
        <button type="button" class="confirm-btn" onclick="closeReasonModal()">بستن</button>
      </div>
    </div>
  </div>

  <!-- Modal برای نمایش پیام‌های عمومی (موفقیت، خطا، هشدار) -->
  <div id="messageModalOverlay" class="overlay">
    <div id="messageModal" class="popup-base">
      <h3 id="messageModalHeader" class="popup-header"></h3>
      <div class="popup-body">
        <p id="messageModalContent"></p>
      </div>
      <div class="popup-footer">
        <button type="button" class="confirm-btn" onclick="closeMessageModal()">تایید</button>
      </div>
    </div>
  </div>


  <script>
    // =======================================================================
    // ▼▼▼ اینجا URL وب اپلیکیشن خود را قرار دهید (پس از Deploy کردن Code.gs) ▼▼▼
    // =======================================================================
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxI6Ja3lsYjFjSqMj2XcgoY1mFQVNqC7sYnWLiBad1nLY1W8ITGKy3ZCa711gaxtAU6/exec"; // مثال: https://script.google.com/macros/s/AKfycbz_YOUR_ID/exec
    // =======================================================================

    const nationalCodeInput = document.getElementById('nationalCodeInput');
    const checkBtn = document.getElementById('checkBtn');
    const loader = document.getElementById('loader');
    const termsGrid = document.getElementById('termsGrid');
    const userInfo = document.getElementById('userInfo');
    const userNameEl = document.getElementById('userName');
    const submissionForm = document.getElementById('submissionForm');
    const answerTextarea = document.getElementById('answerText');
    const wordCountDisplay = document.getElementById('wordCount');

    // Modals elements
    const submissionModalOverlay = document.getElementById('submissionModalOverlay');
    const submissionModal = document.getElementById('submissionModal');
    const reasonModalOverlay = document.getElementById('reasonModalOverlay');
    const reasonModal = document.getElementById('reasonModal');
    const messageModalOverlay = document.getElementById('messageModalOverlay');
    const messageModal = document.getElementById('messageModal');

    let userData = {}; // برای ذخیره داده‌های کاربر و تکالیفش

    // تابع برای ارتباط با Google Apps Script از طریق Fetch API
    async function callAppsScript(functionName, ...args) {
        try {
            const response = await fetch(WEB_APP_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    function: functionName,
                    arguments: args,
                }),
            });
            const data = await response.json(); // فرض می‌کنیم پاسخ همیشه JSON است
            if (data.error) {
                // اگر اسکریپت گوگل خطا برگرداند (مثلاً "کد ملی یافت نشد")
                throw new Error(data.error);
            }
            return data;
        } catch (error) {
            // خطاهای شبکه یا JSON نامعتبر
            console.error("Error calling Apps Script:", error);
            throw new Error("خطا در ارتباط با سرور: " + error.message);
        }
    }


    // تابع برای شمارش کلمات و به‌روزرسانی نمایشگر
    function updateWordCount() {
      const text = answerTextarea.value.trim();
      const words = text.split(/\s+/).filter(word => word.length > 0);
      const count = words.length;
      wordCountDisplay.textContent = `تعداد کلمات: ${count}`;

      if (count < 200 || count > 1500) {
        wordCountDisplay.classList.add('invalid');
      } else {
        wordCountDisplay.classList.remove('invalid');
      }
    }
    answerTextarea.addEventListener('input', updateWordCount);


    // توابع کنترل پاپ‌آپ‌ها
    function showSubmissionModal(term) {
      document.getElementById('termNumber').value = term;
      document.getElementById('submissionModalHeader').textContent = `ارسال تکلیف ترم ${term}`;
      document.getElementById('submissionModalQuestion').textContent = userData.questions[term] || 'سوالی برای این ترم تعریف نشده است.';
      const submission = userData.submissions[term];
      answerTextarea.value = submission ? submission.answer : '';
      updateWordCount(); // به‌روزرسانی شمارش کلمات هنگام باز شدن
      submissionModalOverlay.classList.add('active');
      submissionModal.classList.add('active');
    }

    function closeSubmissionModal() {
      submissionModalOverlay.classList.remove('active');
      submissionModal.classList.remove('active');
      submissionForm.reset();
    }

    function showReasonModal(term) {
      const reason = userData.submissions[term] ? userData.submissions[term].reason : 'دلیلی برای این تکلیف ثبت نشده است.';
      document.getElementById('reasonModalContent').innerHTML = renderMarkdown(reason);
      reasonModalOverlay.classList.add('active');
      reasonModal.classList.add('active');
    }

    function closeReasonModal() {
      reasonModalOverlay.classList.remove('active');
      reasonModal.classList.remove('active');
    }

    function showMessageModal(title, message) {
      document.getElementById('messageModalHeader').innerText = title;
      document.getElementById('messageModalContent').innerText = message;
      messageModalOverlay.classList.add('active');
      messageModal.classList.add('active');
    }

    function closeMessageModal() {
      messageModalOverlay.classList.remove('active');
      messageModal.classList.remove('active');
    }

    // تابع اصلی دریافت داده و نمایش ترم‌ها
    function fetchData() {
      const nationalCode = nationalCodeInput.value.trim();
      if (!/^\d{10}$/.test(nationalCode)) { showMessageModal("خطا", "لطفاً یک کد ملی معتبر ۱۰ رقمی وارد کنید."); return; }
      loader.style.display = 'block';
      termsGrid.style.display = 'none';
      userInfo.style.display = 'none';
      // جایگزینی google.script.run با callAppsScript
      callAppsScript("getUserData", nationalCode)
        .then(displayData)
        .catch(handleError);
    }

    function displayData(data) {
      loader.style.display = 'none';
      if (data.error) { showMessageModal("خطا", data.error); return; }
      userData = data;
      userNameEl.textContent = `سلام، ${data.name}!`;
      userInfo.style.display = 'block';
      termsGrid.innerHTML = '';
      let lastApprovedTerm = 0;
      for (let i = 1; i <= 8; i++) {
        if (data.submissions[i] && data.submissions[i].status == 5) { lastApprovedTerm = i; }
      }

      for (let term = 1; term <= 8; term++) {
        const submission = data.submissions[term];
        const canSubmit = (term === 1 || lastApprovedTerm >= term - 1);
        let statusText, statusClass, buttonsHTML = '';

        if (submission) {
          if (submission.status == 5) {
            statusText = 'تأیید شده'; statusClass = 'status-approved';
            buttonsHTML = `<button class="term-btn" disabled>تأیید شده</button>`;
          } else if (submission.status == 0) {
            statusText = 'تأیید نشده'; statusClass = 'status-rejected';
            buttonsHTML = `
              <button class="term-btn btn-edit" onclick="showSubmissionModal(${term})">ویرایش تکلیف</button>
            `;
            if (submission.reason && submission.reason.trim() !== "") {
                buttonsHTML += `<button class="term-btn btn-reason" onclick="showReasonModal(${term})">مشاهده دلیل رد</button>`;
            }
          } else {
            statusText = 'در حال بررسی'; statusClass = 'status-pending';
            buttonsHTML = `<button class="term-btn" disabled>در حال بررسی</button>`;
          }
        } else {
          statusText = 'ارسال نشده';
          if (canSubmit) {
            statusClass = 'status-pending';
            buttonsHTML = `<button class="term-btn btn-submit" onclick="showSubmissionModal(${term})">ارسال تکلیف</button>`;
          } else {
            statusClass = 'status-locked';
            buttonsHTML = `<button class="term-btn" disabled>قفل شده</button>`;
          }
        }
        const termBox = document.createElement('div');
        termBox.className = 'term-box';
        termBox.innerHTML = `
          <div>
            <div class="term-title">ترم ${term}</div>
            <div class="status ${statusClass}">${statusText}</div>
          </div>
          <div class="buttons-container">${buttonsHTML}</div>`;
        termsGrid.appendChild(termBox);
      }
      termsGrid.style.display = 'grid';
    }
    
    // تابع ارسال فرم
    submissionForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const term = document.getElementById('termNumber').value;
      const answer = answerTextarea.value.trim();

      // بررسی محدودیت کلمات در سمت کلاینت
      const words = answer.split(/\s+/).filter(word => word.length > 0);
      if (words.length < 200 || words.length > 1500) {
          showMessageModal("خطا در ارسال", `تعداد کلمات پاسخ شما (${words.length}) باید بین ۲۰۰ تا ۱۵۰۰ کلمه باشد.`);
          return;
      }

      loader.style.display = 'block';
      closeSubmissionModal(); // بستن پاپ‌آپ ارسال قبل از نمایش لودر

      const formData = { name: userData.name, nationalCode: nationalCodeInput.value.trim(), term: term, answer: answer };
      // جایگزینی google.script.run با callAppsScript
      callAppsScript("submitAssignment", formData)
        .then(handleSubmitSuccess)
        .catch(handleError);
    });

    function handleSubmitSuccess(response) {
      loader.style.display = 'none';
      if (response.success) {
        showMessageModal("موفقیت", response.message);
        fetchData(); // به‌روزرسانی داده‌ها پس از موفقیت
      } else {
        showMessageModal("توجه", response.message);
        fetchData(); // به‌روزرسانی داده‌ها حتی در صورت رد شدن برای نمایش وضعیت جدید
      }
    }

    function handleError(error) {
      loader.style.display = 'none';
      showMessageModal("خطا", 'خطا در ارتباط با سرور: ' + error.message);
    }

    // تابع رندر Markdown ساده برای نمایش دلیل رد
    function renderMarkdown(text) {
        let html = text;
        // Bold: **text**
        html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        // Simple list items: * item
        html = html.split('\n').map(line => {
            if (line.trim().startsWith('* ')) {
                return '<li>' + line.trim().substring(2).trim() + '</li>';
            }
            return line;
        }).join('\n');

        // Wrap list items in <ul> if any were created
        if (html.includes('<li>')) {
            html = '<ul>' + html + '</ul>';
            // Remove empty lines that might become empty <li> if not careful
            html = html.replace(/<ul>\s*<\/li>([\s\S]*?)<li>\s*<\/ul>/g, '<ul><li>$1</li></ul>');
            html = html.replace(/<\/li>(\n|\r\n)<li>/g, '</li><li>'); // Fix line breaks between li
            html = html.replace(/<p><\/p>/g, ''); // Remove empty paragraphs
        }

        // Convert remaining double newlines to paragraph tags for better spacing, then single newlines to <br>
        html = html.replace(/\n\s*\n/g, '</p><p>');
        html = html.replace(/\n/g, '<br>');
        html = `<p>${html}</p>`; // Wrap everything in a paragraph if not already in ul

        return html;
    }

    // بستن پاپ‌آپ‌ها با کلیک بیرون از آن‌ها
    window.onclick = function(event) {
        if (event.target == submissionModalOverlay) { closeSubmissionModal(); }
        if (event.target == reasonModalOverlay) { closeReasonModal(); }
        if (event.target == messageModalOverlay) { closeMessageModal(); }
    }
  </script>
</body>
</html>
