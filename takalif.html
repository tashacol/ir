  <!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow">
  <title>سیستم ارسال تکالیف</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- ▼▼▼ اسکریپت Google reCAPTCHA ▼▼▼ -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <style>
    :root {
      /* Palette رنگی مدرن و شیک */
      --primary-color: #4a69bd;
      --primary-gradient: linear-gradient(135deg, #4a69bd 0%, #6a89cc 100%);
      --success-color: #2ecc71;
      --danger-color: #e74c3c;
      --warning-color: #f39c12;
      --info-color: #3498db;
      --light-color: #f8f9fa;
      --dark-color: #34495e;
      --gray-color: #7f8c8d;
      /* پس زمینه گرادیانی برای بدنه */
      --bg-gradient: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
      /* استایل کارت ها و سایه ها */
      --card-bg: rgba(255, 255, 255, 0.85);
      --card-border-color: rgba(255, 255, 255, 0.4);
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      --border-radius: 16px;
      --font-family: 'Vazirmatn', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    *, *::before, *::after {
      box-sizing: border-box;
    }
    body {
      font-family: var(--font-family);
      direction: rtl;
      text-align: right;
      background-image: var(--bg-gradient);
      margin: 0;
      padding: 20px;
      color: var(--dark-color);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    .container {
      width: 100%;
      max-width: 1100px;
      margin: 1rem auto;
      padding: 40px;
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--card-border-color);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      transition: all 0.3s ease;
    }
    .main-header {
      text-align: center;
      margin-bottom: 2.5rem;
      color: var(--dark-color);
      font-size: 2.25rem;
      font-weight: 800;
    }
    .main-header i {
      color: var(--primary-color);
      margin-left: 15px;
      transform: translateY(4px);
    }
    .ai-warning {
      background-color: rgba(243, 156, 18, 0.1);
      color: #8a6d3b;
      border-left: 5px solid var(--warning-color);
      border-radius: 8px;
      padding: 15px 20px;
      margin: 0 auto 2.5rem auto;
      max-width: 700px;
      text-align: center;
      font-size: 1rem;
      line-height: 1.8;
    }
    .ai-warning i { margin-left: 10px; }
    .input-group {
      margin: 0 auto 2.5rem auto;
      display: flex;
      box-shadow: var(--shadow);
      border-radius: var(--border-radius);
      overflow: hidden;
      max-width: 500px;
      border: 1px solid var(--card-border-color);
    }
    #nationalCodeInput {
      flex-grow: 1;
      padding: 18px 25px;
      border: none;
      font-size: 1.1rem;
      text-align: right;
      transition: all 0.3s;
      background-color: rgba(255, 255, 255, 0.7);
      color: var(--dark-color);
    }
    #nationalCodeInput::placeholder { color: var(--gray-color); }
    #nationalCodeInput:focus {
      background-color: #fff;
      box-shadow: 0 0 0 4px rgba(74, 105, 189, 0.2);
      outline: none;
    }
    #checkBtn {
      padding: 18px 30px;
      border: none;
      background-image: var(--primary-gradient);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: bold;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #checkBtn i { transition: transform 0.3s ease; }
    #checkBtn:hover { filter: brightness(1.1); box-shadow: 0 5px 15px rgba(74, 105, 189, 0.4); }
    #checkBtn:hover i { transform: translateX(-4px); }

    .user-welcome {
      text-align: center;
      font-size: 1.75rem;
      font-weight: 600;
      margin-bottom: 2.5rem;
      color: var(--dark-color);
    }
    .user-welcome i { color: var(--success-color); }

    .terms-grid {
      display: none;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 30px;
    }
    .term-box {
      background: #fff;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      border: 1px solid #e9ecef;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .term-box:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.1);
    }
    .term-header {
      padding: 20px 25px;
      border-bottom: 1px solid #e9ecef;
      background-color: var(--light-color);
    }
    .term-title {
      font-size: 1.75rem;
      font-weight: 800;
      margin: 0;
      color: var(--dark-color);
    }
    .term-due-date {
      font-size: 0.85rem;
      color: var(--gray-color);
      margin-top: 8px;
      font-weight: 500;
    }
    .term-body {
      padding: 25px;
      flex-grow: 1;
    }
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 1rem;
      font-weight: 600;
      padding: 8px 16px;
      border-radius: 50px;
    }
    .status-badge i { font-size: 1.2rem; }
    .status-approved { background-color: rgba(46, 204, 113, 0.15); color: #27ae60; }
    .status-rejected { background-color: rgba(231, 76, 60, 0.15); color: #c0392b; }
    .status-pending { background-color: rgba(243, 156, 18, 0.15); color: #d35400; }
    .status-locked { background-color: rgba(127, 140, 141, 0.15); color: #7f8c8d; }

    .term-footer {
      padding: 25px;
      background-color: #fcfcfc;
      border-top: 1px solid #e9ecef;
    }
    .term-btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: white;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    .btn-submit { background-image: var(--primary-gradient); }
    .btn-edit { background-image: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%); color: #fff; }
    .btn-reason { background-image: linear-gradient(135deg, #5dade2 0%, #3498db 100%); }
    .term-btn:disabled {
      background: #e9ecef;
      color: #adb5bd;
      cursor: not-allowed;
      box-shadow: none;
    }
    .term-btn:hover:not(:disabled) {
      transform: translateY(-3px);
      filter: brightness(1.1);
      box-shadow: 0 7px 15px rgba(0, 0, 0, 0.15);
    }
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary-color);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 40px auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .linear-loader {
      height: 8px;
      width: 100%;
      max-width: 500px;
      margin: 0 auto 2.5rem auto;
      background-color: rgba(255, 255, 255, 0.5);
      border-radius: 4px;
      overflow: hidden;
    }
    .linear-loader-bar {
      height: 100%;
      width: 0;
      background-image: var(--primary-gradient);
      animation: fill-bar 2.5s ease-out forwards;
    }
    @keyframes fill-bar { from { width: 0%; } to { width: 100%; } }
    .overlay {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(30, 30, 30, 0.6);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      animation: fadeIn 0.4s ease;
    }
    .overlay.active { display: flex; align-items: center; justify-content: center; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .popup-base {
      background-color: var(--card-bg);
      border: 1px solid var(--card-border-color);
      margin: auto;
      padding: 0;
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 650px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.2);
      animation: slideIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      overflow: hidden;
    }
    @keyframes slideIn { from { transform: translateY(-40px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
    .popup-header {
      font-size: 1.6rem;
      font-weight: 700;
      padding: 25px 30px;
      background-color: rgba(255, 255, 255, 0.7);
      border-bottom: 1px solid #dee2e6;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .popup-body {
      padding: 30px;
      max-height: 65vh;
      overflow-y: auto;
      line-height: 1.9;
    }
    .popup-body strong { color: var(--primary-color); }
    #submissionModal textarea {
      width: 100%;
      min-height: 250px;
      padding: 15px;
      border: 1px solid #ced4da;
      border-radius: 12px;
      transition: all 0.3s;
      resize: vertical;
      font-size: 1rem;
      font-family: var(--font-family);
      box-sizing: border-box;
      background-color: #f8f9fa;
    }
    #submissionModal textarea:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px rgba(74, 105, 189, 0.2);
      outline: none;
      background-color: #fff;
    }
    .word-count {
      font-size: 0.9rem;
      color: #6c757d;
      text-align: left;
      margin-top: 12px;
    }
    .word-count.invalid { color: var(--danger-color); font-weight: bold; }
    .popup-footer {
      padding: 20px 30px;
      background-color: rgba(248, 249, 250, 0.9);
      text-align: left;
      border-top: 1px solid #dee2e6;
      display: flex;
      gap: 15px;
      justify-content: flex-end;
    }
    .popup-footer button {
      padding: 12px 30px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
    }
    .popup-footer .confirm-btn {
      background-image: var(--primary-gradient);
      color: white;
    }
    .popup-footer .confirm-btn:hover { filter: brightness(1.1); transform: translateY(-2px); }
    .popup-footer .cancel-btn {
      background-color: transparent;
      color: var(--dark-color);
      border: 1px solid #dee2e6;
    }
    .popup-footer .cancel-btn:hover { background-color: #e9ecef; }
    #reasonModalContent strong { color: var(--danger-color); }
    #reasonModalContent ul { padding-right: 20px; }
    .grecaptcha-badge { visibility: hidden; }
  </style>
</head>
<body>

  <div class="container">
    <h2 class="main-header"><i class="fas fa-tasks"></i>سیستم ارسال تکالیف</h2>
    <div class="ai-warning"><i class="fas fa-exclamation-triangle"></i> هرگونه تقلب شرعا حرام بوده و این سیستم مجهز به هوش مصنوعی است و در صورتیکه جواب از هوش مصنوعی اخذ شده باشد توسط سیستم تشخیص داده شده و رد می‌شود.</div>

    <div id="nationalCodeSection">
      <div class="input-group">
        <input type="text" id="nationalCodeInput" placeholder="کد ملی خود را وارد کنید..." />
        <button id="checkBtn" onclick="handleLoginClick()"><i class="fas fa-arrow-left"></i></button>
      </div>
    </div>

    <div id="linearLoader" class="linear-loader" style="display: none;">
      <div class="linear-loader-bar"></div>
    </div>

    <div id="loader" class="loader" style="display: none;"></div>
    <div id="userInfo" style="display: none;"><h3 id="userName" class="user-welcome"></h3></div>
    <div id="termsGrid" class="terms-grid"></div>
  </div>

  <!-- پاپ‌آپ‌ها بدون تغییر در ساختار و عملکرد -->
  <div id="submissionModalOverlay" class="overlay">
    <div id="submissionModal" class="popup-base">
      <div id="submissionModalHeader" class="popup-header"></div>
      <div class="popup-body">
        <div><strong><i class="fas fa-question-circle"></i> سوال:</strong></div>
        <p id="submissionModalQuestion" style="white-space: pre-wrap; background-color: #f0f2f5; padding: 15px; border-radius: 8px; margin-top: 10px;"></p>
        <form id="submissionForm" style="margin-top: 20px;">
          <input type="hidden" id="termNumber">
          <label for="answerText" style="font-weight: 600; font-size: 1.1rem; margin-bottom: 10px; display: block;">
            <i class="fas fa-pen-alt"></i> پاسخ شما:
          </label>
          <textarea id="answerText" required placeholder="متن تکلیف خود را اینجا وارد کنید"></textarea>
          <div id="wordCount" class="word-count">تعداد کلمات: 0</div>
        </form>
      </div>
      <div class="popup-footer">
        <button type="button" class="cancel-btn" onclick="closeSubmissionModal()">انصراف</button>
        <button type="submit" form="submissionForm" id="submitBtn" class="confirm-btn">ارسال تکلیف</button>
      </div>
    </div>
  </div>
  <div id="reasonModalOverlay" class="overlay">
    <div id="reasonModal" class="popup-base">
      <div class="popup-header"><i class="fas fa-info-circle"></i> دلیل رد تکلیف</div>
      <div class="popup-body"><div id="reasonModalContent"></div></div>
      <div class="popup-footer"><button type="button" class="confirm-btn" onclick="closeReasonModal()">متوجه شدم</button></div>
    </div>
  </div>
  <div id="approvedSubmissionModalOverlay" class="overlay">
    <div id="approvedSubmissionModal" class="popup-base">
      <div class="popup-header"><i class="fas fa-check-circle"></i> متن تکلیف تایید شده</div>
      <div class="popup-body">
        <p id="approvedSubmissionContent"></p>
      </div>
      <div class="popup-footer">
        <button type="button" class="confirm-btn" onclick="closeApprovedSubmissionModal()">بستن</button>
      </div>
    </div>
  </div>
  <div id="messageModalOverlay" class="overlay">
    <div id="messageModal" class="popup-base">
      <div id="messageModalHeader" class="popup-header"></div>
      <div class="popup-body"><p id="messageModalContent" style="font-size: 1.1rem; text-align: center;"></p></div>
      <div class="popup-footer"><button type="button" class="confirm-btn" onclick="closeMessageModal()">تایید</button></div>
    </div>
  </div>
  
  <!-- ▼▼▼ المان کپچا با کلید سایت شما ▼▼▼ -->
  <div class="g-recaptcha"
       data-sitekey="6Lc1vqkrAAAAAHLHbzPMzlREvKwgHDNSmakrB-aq"
       data-size="invisible"
       data-callback="onRecaptchaSuccess">
  </div>


  <script>
    // 
    // !!! JAVASCRIPT LOGIC IS UNCHANGED AS REQUESTED !!!
    // 
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwM6QPomqlgoIvgPq7CsWhTBAhgB-EbsIyOnPLClRzFFS2rhvzo89jh7AsW8znGAe9s/exec";

    // تعریف متغیرهای DOM
    const nationalCodeInput = document.getElementById('nationalCodeInput');
    const loader = document.getElementById('loader');
    const termsGrid = document.getElementById('termsGrid');
    const userInfo = document.getElementById('userInfo');
    const userNameEl = document.getElementById('userName');
    const submissionForm = document.getElementById('submissionForm');
    const answerTextarea = document.getElementById('answerText');
    const wordCountDisplay = document.getElementById('wordCount');
    const submissionModalOverlay = document.getElementById('submissionModalOverlay');
    const reasonModalOverlay = document.getElementById('reasonModalOverlay');
    const messageModalOverlay = document.getElementById('messageModalOverlay');
    const nationalCodeSection = document.getElementById('nationalCodeSection');
    const linearLoader = document.getElementById('linearLoader');
    const approvedSubmissionModalOverlay = document.getElementById('approvedSubmissionModalOverlay');
    
    // ▼▼▼ متغیرهای اصلی برای مدیریت وضعیت ▼▼▼
    let userData = {};
    let sessionToken = null; // توکن امنیتی که از سرور دریافت می‌شود

    // بررسی وجود کد ملی در URL هنگام بارگذاری صفحه
    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const nationalCodeFromId = params.get('id');
        
        if (nationalCodeFromId && /^\d{10}$/.test(nationalCodeFromId)) {
            nationalCodeSection.style.display = 'none';
            linearLoader.style.display = 'block';
            nationalCodeInput.value = nationalCodeFromId;
            grecaptcha.ready(() => { grecaptcha.execute(); });
        }
    });

    answerTextarea.addEventListener('input', () => {
      const text = answerTextarea.value.trim();
      const words = text.split(/\s+/).filter(word => word.length > 0);
      wordCountDisplay.textContent = `تعداد کلمات: ${words.length}`;
      wordCountDisplay.classList.toggle('invalid', words.length < 200 || words.length > 1500);
    });

    // توابع نمایش و بستن پاپ‌آپ‌ها (بدون تغییر)
    function showSubmissionModal(term) {
      document.getElementById('termNumber').value = term;
      document.getElementById('submissionModalHeader').innerHTML = `<i class="fas fa-upload"></i> ارسال تکلیف ترم ${term}`;
      document.getElementById('submissionModalQuestion').textContent = userData.questions[term] || 'سوالی برای این ترم تعریف نشده است.';
      answerTextarea.value = userData.submissions[term]?.answer || '';
      answerTextarea.dispatchEvent(new Event('input'));
      submissionModalOverlay.classList.add('active');
    }
    function closeSubmissionModal() { submissionModalOverlay.classList.remove('active'); }
    function showReasonModal(term) {
      const reason = userData.submissions[term]?.reason || 'دلیلی ثبت نشده است.';
      document.getElementById('reasonModalContent').innerHTML = renderMarkdown(reason);
      reasonModalOverlay.classList.add('active');
    }
    function closeReasonModal() { reasonModalOverlay.classList.remove('active'); }
    function showMessageModal(title, message) {
      document.getElementById('messageModalHeader').innerText = title;
      document.getElementById('messageModalContent').innerText = message;
      messageModalOverlay.classList.add('active');
    }
    function closeMessageModal() { messageModalOverlay.classList.remove('active'); }
    function showApprovedSubmissionModal(term) {
      const answer = userData.submissions[term]?.answer || 'متن تکلیفی یافت نشد.';
      document.getElementById('approvedSubmissionContent').textContent = answer;
      approvedSubmissionModalOverlay.classList.add('active');
    }
    function closeApprovedSubmissionModal() { approvedSubmissionModalOverlay.classList.remove('active'); }

    // ▼▼▼ مرحله ۱: شروع فرآیند ورود با کلیک کاربر ▼▼▼
    function handleLoginClick() {
        const nationalCode = nationalCodeInput.value.trim();
        if (!/^\d{10}$/.test(nationalCode)) {
            return showMessageModal("خطا", "کد ملی وارد شده معتبر نیست.");
        }
        loader.style.display = 'block';
        termsGrid.style.display = 'none';
        userInfo.style.display = 'none';
        
        // اجرای کپچا
        grecaptcha.ready(() => {
            grecaptcha.execute();
        });
    }

    // ▼▼▼ مرحله ۲: این تابع به صورت خودکار توسط کپچا پس از تایید فراخوانی می‌شود ▼▼▼
    async function onRecaptchaSuccess(recaptchaToken) {
      const nationalCode = nationalCodeInput.value.trim();
      
      try {
        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          // ارسال اکشن 'login' به همراه کد ملی و توکن کپچا
          body: JSON.stringify({ action: 'login', nationalCode, recaptchaToken })
        });
        
        if (!response.ok) throw new Error(`خطای شبکه (کد: ${response.status})`);
        
        const data = await response.json();
        
        if (data.success && data.sessionToken) {
          sessionToken = data.sessionToken; // ذخیره توکن امن
          displayData(data);
        } else {
          // اگر خطایی از سرور بیاید (مثل کد ملی اشتباه)
          handleError({ message: data.error || "خطای نامشخص از سرور." });
        }
      } catch (error) { 
        handleError(error); 
      } finally {
        // ریست کردن کپچا برای تلاش بعدی
        grecaptcha.reset();
      }
    }

    // ▼▼▼ مرحله ۳: نمایش اطلاعات دریافت شده از سرور ▼▼▼
    function displayData(data) {
      loader.style.display = 'none';
      linearLoader.style.display = 'none';

      if (data.error && !data.success) { // نمایش خطا فقط اگر عملیات ناموفق بود
        nationalCodeSection.style.display = 'flex';
        userInfo.style.display = 'none';
        termsGrid.style.display = 'none';
        return showMessageModal("وضعیت دوره", data.error);
      }
      
      nationalCodeSection.style.display = 'none';

      userData = data;
      userNameEl.innerHTML = `<i class="fas fa-user-check"></i> خوش آمدید، ${data.name}!`;
      userInfo.style.display = 'block';
      termsGrid.innerHTML = '';
      const lastApprovedTerm = Math.max(0, ...Object.keys(data.submissions).filter(t => data.submissions[t].status == 5).map(Number));

      const totalTerms = Object.keys(data.termDetails).length;
      for (let term = 1; term <= totalTerms; term++) {
        const submission = data.submissions[term];
        const details = data.termDetails[term];
        const prevTermApproved = (term === 1 || lastApprovedTerm >= term - 1);
        
        let statusIcon, statusText, statusClass, buttonsHTML;
        let dueDateHTML = '';

        if (details.isUnlocked) {
            dueDateHTML = `<div class="term-due-date">آخرین مهلت: ${details.dueDate}</div>`;
            const canSubmit = prevTermApproved;

            if (submission) {
                if (submission.status == 5) {
                    statusIcon = 'fa-check-circle'; statusText = 'تأیید شده'; statusClass = 'status-approved';
                    buttonsHTML = `<button class="term-btn" onclick="showApprovedSubmissionModal(${term})"><i class="fas fa-eye"></i> مشاهده تکلیف</button>`;
                } else if (submission.status == 0) {
                    statusIcon = 'fa-times-circle'; statusText = 'رد شده'; statusClass = 'status-rejected';
                    buttonsHTML = `<button class="term-btn btn-edit" onclick="showSubmissionModal(${term})"><i class="fas fa-pencil-alt"></i> ویرایش تکلیف</button>`;
                    if (submission.reason) { buttonsHTML += `<button class="term-btn btn-reason" style="margin-top: 10px;" onclick="showReasonModal(${term})"><i class="fas fa-info-circle"></i> مشاهده دلیل</button>`; }
                } else {
                    statusIcon = 'fa-hourglass-half'; statusText = 'در حال بررسی'; statusClass = 'status-pending';
                    buttonsHTML = `<button class="term-btn" disabled><i class="fas fa-spinner fa-spin"></i> در حال بررسی</button>`;
                }
            } else {
                if (canSubmit) {
                    statusIcon = 'fa-clock'; statusText = 'آماده ارسال'; statusClass = 'status-pending';
                    buttonsHTML = `<button class="term-btn btn-submit" onclick="showSubmissionModal(${term})"><i class="fas fa-paper-plane"></i> ارسال تکلیف</button>`;
                } else {
                    statusIcon = 'fa-lock'; statusText = 'منتظر تأیید ترم قبل'; statusClass = 'status-locked';
                    buttonsHTML = `<button class="term-btn" disabled><i class="fas fa-lock"></i> منتظر تأیید ترم قبل</button>`;
                }
            }
        } else {
            statusIcon = 'fa-lock'; statusText = 'قفل شده'; statusClass = 'status-locked';
            buttonsHTML = `<button class="term-btn" disabled><i class="fas fa-lock"></i> بازگشایی در ${details.unlockDate}</button>`;
        }
        
        const termBox = document.createElement('div');
        termBox.className = 'term-box';
        termBox.innerHTML = `
          <div class="term-header">
            <h3 class="term-title">ترم ${term}</h3>
            ${dueDateHTML}
          </div>
          <div class="term-body"><div class="status-badge ${statusClass}"><i class="fas ${statusIcon}"></i><span>${statusText}</span></div></div>
          <div class="term-footer">${buttonsHTML}</div>`;
        termsGrid.appendChild(termBox);
      }
      termsGrid.style.display = 'grid';
    }
    
    // ▼▼▼ ارسال فرم تکلیف با استفاده از توکن امن ▼▼▼
    submissionForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!sessionToken) {
          return showMessageModal("خطا", "نشست شما معتبر نیست. لطفاً صفحه را رفرش کنید.");
      }

      const term = document.getElementById('termNumber').value;
      const answer = answerTextarea.value.trim();
      const words = answer.split(/\s+/).filter(word => word.length > 0);
      if (words.length < 200 || words.length > 1500) { return showMessageModal("خطا", "تعداد کلمات پاسخ شما باید بین ۲۰۰ تا ۱۵۰۰ کلمه باشد."); }
      
      const submitBtn = document.getElementById('submitBtn');
      const originalBtnHTML = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> در حال ارسال...`;

      // فقط توکن و اطلاعات فرم ارسال می‌شود. کد ملی یا نام کاربر دیگر ارسال نمی‌شود.
      const payload = {
          action: 'submitAssignment',
          sessionToken: sessionToken,
          formData: { term, answer }
      };

      try {
        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error(`خطای شبکه (کد: ${response.status})`);
        
        const result = await response.json();
        
        closeSubmissionModal();
        showMessageModal(result.success ? "موفقیت" : "توجه", result.message || "پاسخ نامشخص از سرور.");

        // سرور پس از ارسال موفق، آخرین اطلاعات را برمی‌گرداند
        if (result.updatedData && result.updatedData.success) {
            displayData(result.updatedData);
        } else if (result.message.includes("نشست")) {
            // اگر توکن منقضی شده باشد، کاربر را به صفحه ورود برمی‌گردانیم
            window.location.reload();
        }

      } catch (error) {
        handleError(error);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnHTML;
      }
    });

    function handleError(error) {
      linearLoader.style.display = 'none';
      loader.style.display = 'none';
      // نمایش مجدد بخش ورود در صورت بروز خطا
      nationalCodeSection.style.display = 'flex';
      userInfo.style.display = 'none';
      termsGrid.style.display = 'none';
      showMessageModal("خطای اتصال", 'خطا در ارتباط با سرور: ' + error.message);
    }

    function renderMarkdown(text) {
      let html = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
      html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/^\* (.*$)/gm, '<li>$1</li>');
      if (html.includes('<li>')) { html = '<ul>' + html.replace(/<\/li>\s*<li>/g, '</li><li>') + '</ul>'; }
      return html.replace(/\n/g, '<br>');
    }

    window.onclick = (event) => {
      if (event.target == submissionModalOverlay) closeSubmissionModal();
      if (event.target == reasonModalOverlay) closeReasonModal();
      if (event.target == messageModalOverlay) closeMessageModal();
      if (event.target == approvedSubmissionModalOverlay) closeApprovedSubmissionModal();
    }
    nationalCodeInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') { event.preventDefault(); document.getElementById('checkBtn').click(); } });
  </script>

</body>
</html>
