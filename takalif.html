<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>سیستم ارسال تکالیف</title>
  <style>
    :root {
      --primary-color: #0d6efd; --success-color: #198754; --danger-color: #dc3545;
      --warning-color: #ffc107; --info-color: #0dcaf0; --light-gray: #f8f9fa;
      --dark-gray: #212529; --border-color: #dee2e6;
      --shadow-sm: 0 .125rem .25rem rgba(0,0,0,.075);
      --shadow-md: 0 .5rem 1rem rgba(0,0,0,.15);
    }
    body {
      font-family: 'Vazirmatn', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      direction: rtl; text-align: center; background-color: #f0f2f5;
      margin: 0; padding: 20px; color: var(--dark-gray);
      min-height: 100vh; display: flex; align-items: center; justify-content: center;
    }
    .container {
      width: 100%; max-width: 1140px; margin: 2rem auto; padding: 2.5rem;
      background: #ffffff; border-radius: 16px;
      box-shadow: var(--shadow-md);
    }
    .main-title { font-size: 2.5rem; color: var(--dark-gray); margin-bottom: 1rem; }
    #warning-message {
      font-size: 1rem; color: var(--danger-color); background-color: #f8d7da;
      border: 1px solid #f5c2c7; border-radius: 8px;
      padding: 1rem; margin: 0 auto 2rem auto; max-width: 700px;
    }
    .input-group {
      margin: 0 auto 2rem auto; display: flex; max-width: 450px;
      border-radius: 12px; overflow: hidden; box-shadow: var(--shadow-sm);
    }
    #nationalCodeInput {
      flex-grow: 1; padding: 14px 20px; border: 1px solid var(--border-color);
      border-left: none; font-size: 1.1rem; text-align: right;
    }
    #nationalCodeInput:focus { border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(13,110,253,.25); outline: none; z-index: 2;}
    #checkBtn {
      padding: 14px 30px; border: none; background: var(--primary-color); color: white;
      cursor: pointer; transition: background-color 0.2s; font-weight: 500; font-size: 1.1rem;
    }
    #checkBtn:hover { background-color: #0b5ed7; }
    .terms-grid {
      display: none; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 25px; margin-top: 2.5rem;
    }
    .term-box {
      background: white; padding: 20px; border-radius: 12px;
      box-shadow: var(--shadow-sm); transition: all 0.3s ease;
      border: 1px solid var(--border-color); display: flex;
      flex-direction: column; text-align: right;
    }
    .term-box:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
    .term-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
    .term-title { font-weight: 700; font-size: 1.5rem; color: #343a40; }
    .term-icon { width: 32px; height: 32px; }
    .term-body { flex-grow: 1; }
    .term-info { font-size: 0.95rem; color: #6c757d; margin-bottom: 1rem; }
    .status {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 6px 14px; border-radius: 50px; color: white;
      font-size: 0.9rem; font-weight: 500; margin-bottom: 15px;
    }
    .status-approved { background-color: var(--success-color); }
    .status-rejected { background-color: var(--danger-color); }
    .status-pending { background-color: var(--warning-color); color: var(--dark-gray); }
    .status-locked { background-color: #6c757d; }
    .status-upcoming { background-color: #e9ecef; color: #6c757d; }
    .term-footer { margin-top: auto; padding-top: 1rem; border-top: 1px solid #f1f1f1; }
    .buttons-container { display: flex; flex-direction: column; gap: 10px; }
    .term-btn {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      width: 100%; padding: 12px; border: none; border-radius: 8px;
      font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 1rem;
    }
    .btn-submit { background-color: var(--primary-color); color: white; }
    .btn-edit { background-color: var(--warning-color); color: var(--dark-gray); }
    .btn-reason { background-color: var(--info-color); color: white; }
    .term-btn:disabled { background-color: #e9ecef; color: #6c757d; cursor: not-allowed; opacity: 0.8; }
    .term-btn:hover:not(:disabled) { filter: brightness(1.1); }
    #system-message {
        font-size: 1.5rem; font-weight: 500; color: var(--dark-gray);
        background-color: #e9ecef; border-radius: 12px; padding: 2rem; display: none;
    }
    /* سایر استایل‌ها ... (لودر، پاپ‌آپ و ...) */
    .loader {
      border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color);
      border-radius: 50%; width: 40px; height: 40px;
      animation: spin 1s linear infinite; margin: 30px auto; display: none;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .overlay {
      display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
      opacity: 0; transition: opacity 0.3s ease;
    }
    .overlay.active { display: flex; align-items: center; justify-content: center; opacity: 1; }
    .popup-base {
      background-color: white; padding: 30px; border-radius: 18px; width: 90%; max-width: 600px;
      box-shadow: var(--shadow-md); transform: scale(0.95); opacity: 0;
      transition: all 0.3s ease; text-align: right;
    }
    .overlay.active .popup-base { transform: scale(1); opacity: 1; }
    .popup-header {
      font-size: 1.8rem; margin-bottom: 20px; color: var(--primary-color);
      font-weight: 700; border-bottom: 1px solid var(--border-color); padding-bottom: 15px;
    }
    /* بقیه استایل‌های پاپ آپ بدون تغییر ... */
    .popup-body { margin-bottom: 20px; font-size: 1.1rem; line-height: 1.7; color: #444; max-height: 60vh; overflow-y: auto; }
    .popup-footer { margin-top: 25px; text-align: center; display: flex; gap: 15px; justify-content: center; }
    .popup-footer button { padding: 12px 25px; border-radius: 10px; font-size: 1rem; }
    .popup-footer .confirm-btn { background-color: var(--primary-color); color: white; }
    .popup-footer .cancel-btn { background-color: #6c757d; color: white; }
    #submissionModal textarea {
      width: 100%; min-height: 200px; padding: 15px; border: 1px solid var(--border-color);
      border-radius: 10px; font-size: 1rem; resize: vertical;
    }
    .word-count { font-size: 0.9rem; color: #6c757d; text-align: left; margin-top: 5px; }
    .word-count.invalid { color: var(--danger-color); font-weight: bold; }
  </style>
</head>
<body>

  <div class="container">
    <h2 class="main-title">سیستم هوشمند ارسال تکالیف</h2>
    <p id="warning-message">
      هرگونه تقلب شرعاً حرام بوده و این سیستم مجهز به هوش مصنوعی است و در صورتی که جواب از هوش مصنوعی اخذ شده باشد توسط سیستم تشخیص داده شده و رد می‌شود.
    </p>

    <div class="input-group">
      <input type="text" id="nationalCodeInput" placeholder="کد ملی خود را وارد کنید..." />
      <button id="checkBtn" onclick="fetchData()">بررسی</button>
    </div>

    <div id="loader" class="loader"></div>
    <h3 id="userName" style="display: none; font-size: 1.8rem; margin-bottom: 2rem;"></h3>
    
    <div id="system-message"></div>

    <div id="termsGrid" class="terms-grid"></div>
  </div>

  <!-- پاپ‌آپ‌ها -->
  <div id="submissionModalOverlay" class="overlay">
    <div id="submissionModal" class="popup-base">
      <h3 id="submissionModalHeader" class="popup-header"></h3>
      <div class="popup-body">
        <div><strong>سوال:</strong></div>
        <p id="submissionModalQuestion" style="white-space: pre-wrap; background: #f8f9fa; padding: 10px; border-radius: 8px;"></p>
        <form id="submissionForm">
          <input type="hidden" id="termNumber">
          <label for="answerText"><strong>پاسخ شما:</strong></label>
          <textarea id="answerText" required placeholder="متن تکلیف خود را اینجا وارد کنید"></textarea>
          <div id="wordCount" class="word-count">تعداد کلمات: 0</div>
          <div class="popup-footer">
            <button type="submit" class="confirm-btn term-btn">ارسال تکلیف</button>
            <button type="button" class="cancel-btn term-btn" onclick="closeSubmissionModal()">انصراف</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div id="reasonModalOverlay" class="overlay">
    <div id="reasonModal" class="popup-base">
      <h3 class="popup-header">دلیل رد تکلیف</h3>
      <div class="popup-body" id="reasonModalContent" style="white-space: pre-wrap;"></div>
      <div class="popup-footer">
        <button type="button" class="confirm-btn" onclick="closeReasonModal()">بستن</button>
      </div>
    </div>
  </div>
  <div id="messageModalOverlay" class="overlay">
    <div id="messageModal" class="popup-base">
      <h3 id="messageModalHeader" class="popup-header"></h3>
      <div class="popup-body">
        <p id="messageModalContent"></p>
      </div>
      <div class="popup-footer">
        <button type="button" class="confirm-btn" onclick="closeMessageModal()">تایید</button>
      </div>
    </div>
  </div>

  <script>
    // ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼
    // ▼ مهم: آدرس وب اپلیکیشن (URL) جدید را که پس از انتشار دریافت می‌کنید، ▼
    // ▼ در اینجا قرار دهید.                                                  ▼
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzaQWO7AIEaj5k3L3Ex3EHIpCjPLFCzCwGyWumLjZrRZNj9vp-CRME1mVSVNLf65yo/exec";
    // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

    // آیکون‌ها به صورت SVG برای استفاده در کد
    const icons = {
      approved: `<svg class="term-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--success-color);"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
      rejected: `<svg class="term-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--danger-color);"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`,
      pending: `<svg class="term-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #6c757d;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`,
      locked: `<svg class="term-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #6c757d;"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>`,
      edit: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`,
      submit: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>`,
      reason: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`
    };
    
    // تمام عناصر DOM
    const nationalCodeInput = document.getElementById('nationalCodeInput');
    const loader = document.getElementById('loader');
    const termsGrid = document.getElementById('termsGrid');
    const userInfo = document.getElementById('userName');
    const systemMessage = document.getElementById('system-message');
    const submissionForm = document.getElementById('submissionForm');
    const answerTextarea = document.getElementById('answerText');
    const wordCountDisplay = document.getElementById('wordCount');
    const submissionModalOverlay = document.getElementById('submissionModalOverlay');
    const reasonModalOverlay = document.getElementById('reasonModalOverlay');
    const messageModalOverlay = document.getElementById('messageModalOverlay');

    let userData = {};

    answerTextarea.addEventListener('input', () => {
      const text = answerTextarea.value.trim();
      const words = text.split(/\s+/).filter(word => word.length > 0);
      wordCountDisplay.textContent = `تعداد کلمات: ${words.length}`;
      wordCountDisplay.classList.toggle('invalid', words.length < 200 || words.length > 1500);
    });

    function showSubmissionModal(term) {
      document.getElementById('termNumber').value = term;
      document.getElementById('submissionModalHeader').textContent = `ارسال تکلیف ترم ${term}`;
      document.getElementById('submissionModalQuestion').textContent = userData.questions[term] || 'سوالی برای این ترم تعریف نشده است.';
      answerTextarea.value = userData.submissions[term]?.answer || '';
      answerTextarea.dispatchEvent(new Event('input'));
      submissionModalOverlay.classList.add('active');
    }
    
    function showReasonModal(term) {
      document.getElementById('reasonModalContent').innerHTML = renderMarkdown(userData.submissions[term]?.reason || 'دلیلی ثبت نشده است.');
      reasonModalOverlay.classList.add('active');
    }

    function showMessageModal(title, message) {
      document.getElementById('messageModalHeader').innerText = title;
      document.getElementById('messageModalContent').innerText = message;
      messageModalOverlay.classList.add('active');
    }

    function closeAllModals() {
      submissionModalOverlay.classList.remove('active');
      reasonModalOverlay.classList.remove('active');
      messageModalOverlay.classList.remove('active');
    }
    function closeSubmissionModal() { submissionModalOverlay.classList.remove('active'); }
    function closeReasonModal() { reasonModalOverlay.classList.remove('active'); }
    function closeMessageModal() { messageModalOverlay.classList.remove('active'); }

    async function fetchData() {
      const nationalCode = nationalCodeInput.value.trim();
      if (!/^\d{10}$/.test(nationalCode)) {
        return showMessageModal("خطا", "لطفاً یک کد ملی معتبر ۱۰ رقمی وارد کنید.");
      }
      loader.style.display = 'block';
      termsGrid.style.display = 'none';
      userInfo.style.display = 'none';
      systemMessage.style.display = 'none';

      if (WEB_APP_URL.includes("YOUR_NEW_GOOGLE")) {
        return handleError({ message: "آدرس وب اپلیکیشن در کد HTML تنظیم نشده است." });
      }

      const postPayload = { action: 'getUserData', nationalCode: nationalCode };

      try {
        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(postPayload)
        });
        if (!response.ok) throw new Error(`خطای شبکه (کد: ${response.status})`);
        const data = await response.json();
        handleData(data);
      } catch (error) {
        handleError(error);
      }
    }

    function handleData(data) {
      loader.style.display = 'none';
      if (data.error) { return showMessageModal("خطا", data.error); }

      userData = data;
      termsGrid.innerHTML = ''; // پاک کردن محتوای قبلی

      if (data.status === 'COURSE_NOT_STARTED') {
        systemMessage.textContent = `دوره شما هنوز آغاز نشده است. تاریخ شروع: ${data.startDate}`;
        systemMessage.style.display = 'block';
        return;
      }
      if (data.status === 'COURSE_EXPIRED') {
        systemMessage.textContent = `دوره شما به پایان رسیده است.`;
        systemMessage.style.display = 'block';
        return;
      }
      
      // اگر دوره فعال است
      userInfo.textContent = `سلام، ${data.name}!`;
      userInfo.style.display = 'block';

      const lastApprovedTerm = Object.keys(data.submissions)
        .filter(term => data.submissions[term].status == 5)
        .map(Number).reduce((max, term) => Math.max(max, term), 0);
      
      const today = new Date();

      for (let term = 1; term <= 8; term++) {
        const submission = data.submissions[term];
        const termUnlockDate = new Date(data.termUnlockDates[term]);
        const isTermUnlocked = today >= termUnlockDate;
        const isPreviousApproved = (term === 1 || lastApprovedTerm >= term - 1);
        
        let statusText, statusClass, icon, buttonsHTML = '', termInfo = '';
        const termStartDateFormatted = new Intl.DateTimeFormat('fa-IR', { dateStyle: 'short' }).format(termUnlockDate);
        termInfo = `تاریخ شروع ترم: <strong>${termStartDateFormatted}</strong>`;

        if (submission) {
          if (submission.status == 5) {
            statusText = 'تأیید شده'; statusClass = 'status-approved'; icon = icons.approved;
            buttonsHTML = `<button class="term-btn" disabled>${icon} تأیید شده</button>`;
          } else if (submission.status == 0) {
            statusText = 'رد شده'; statusClass = 'status-rejected'; icon = icons.rejected;
            buttonsHTML = `<button class="term-btn btn-edit" onclick="showSubmissionModal(${term})">${icons.edit} ویرایش تکلیف</button>`;
            if (submission.reason) {
              buttonsHTML += `<button class="term-btn btn-reason" onclick="showReasonModal(${term})">${icons.reason} مشاهده دلیل رد</button>`;
            }
          } else {
            statusText = 'در حال بررسی'; statusClass = 'status-pending'; icon = icons.pending;
            buttonsHTML = `<button class="term-btn" disabled>${icon} در حال بررسی</button>`;
          }
        } else {
          if (isTermUnlocked) {
            if(isPreviousApproved) {
              statusText = 'آماده ارسال'; statusClass = 'status-pending'; icon = icons.pending;
              buttonsHTML = `<button class="term-btn btn-submit" onclick="showSubmissionModal(${term})">${icons.submit} ارسال تکلیف</button>`;
            } else {
              statusText = 'در انتظار ترم قبل'; statusClass = 'status-locked'; icon = icons.locked;
              buttonsHTML = `<button class="term-btn" disabled>${icon} در انتظار ترم قبل</button>`;
            }
          } else {
            statusText = 'قفل شده'; statusClass = 'status-upcoming'; icon = icons.locked;
            buttonsHTML = `<button class="term-btn" disabled>${icon} قفل شده</button>`;
          }
        }
        
        const termBox = document.createElement('div');
        termBox.className = 'term-box';
        termBox.innerHTML = `
          <div class="term-header">
            <div class="term-title">ترم ${term}</div>
            <div class="term-icon">${icon}</div>
          </div>
          <div class="term-body">
            <div class="status ${statusClass}">${statusText}</div>
            <p class="term-info">${termInfo}</p>
          </div>
          <div class="term-footer">
            <div class="buttons-container">${buttonsHTML}</div>
          </div>`;
        termsGrid.appendChild(termBox);
      }
      termsGrid.style.display = 'grid';
    }
    
    submissionForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const term = document.getElementById('termNumber').value;
      const answer = answerTextarea.value.trim();
      if (answerTextarea.parentElement.querySelector('.word-count.invalid')) {
        return showMessageModal("خطا", "تعداد کلمات پاسخ شما باید بین ۲۰۰ تا ۱۵۰۰ کلمه باشد.");
      }
      closeSubmissionModal();
      loader.style.display = 'block';
      const formData = { name: userData.name, nationalCode: nationalCodeInput.value, term, answer };
      const postPayload = { action: 'submitAssignment', formData };
      try {
        const response = await fetch(WEB_APP_URL, {
          method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(postPayload)
        });
        if (!response.ok) throw new Error(`خطای شبکه (کد: ${response.status})`);
        const result = await response.json();
        handleSubmitSuccess(result);
      } catch (error) {
        handleError(error);
      }
    });

    function handleSubmitSuccess(response) {
      loader.style.display = 'none';
      showMessageModal(response.success ? "موفقیت" : "توجه", response.message);
      fetchData(); // به‌روزرسانی وضعیت
    }

    function handleError(error) {
      loader.style.display = 'none';
      showMessageModal("خطای اتصال", 'خطا در ارتباط با سرور: ' + error.message);
    }

    function renderMarkdown(text) {
      return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
    }

    window.onclick = (event) => {
      if (event.target.classList.contains('overlay')) closeAllModals();
    }
  </script>
</body>
</html>
