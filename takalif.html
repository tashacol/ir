<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>سامانه بررسی و ارسال تکالیف</title>
    <style>
        /* تمام کدهای CSS که در پاسخ قبلی ارائه شد را اینجا کپی کنید */
        /* --- استایل‌های پایه و ریسپانسیو --- */
        * { box-sizing: border-box; }
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
          background: #f0f2f5; margin: 0; padding: 20px; direction: rtl;
          text-align: center; color: #333; min-height: 100vh;
        }
        .container { max-width: 900px; margin: 0 auto; }
        h2 { margin-bottom: 10px; color: #1c1e21; }
        .welcome-message { color: #606770; font-size: 1.1rem; margin-bottom: 20px; }
        .loader-container{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(255,255,255,0.8);display:flex;justify-content:center;align-items:center;z-index:2000;flex-direction:column}
        .loader{border:5px solid #f3f3f3;border-top:5px solid #3498db;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite}
        .loader-container p{font-size:1.2rem;color:#333;margin-top:20px}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .input-box{background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);display:inline-block}
        .input-box input{width:250px;padding:12px;border:1px solid #dddfe2;border-radius:6px;font-size:1rem}
        .input-box button{padding:12px 24px;border:none;border-radius:6px;background-color:#1877f2;color:#fff;cursor:pointer;transition:background-color .3s;font-size:1rem;font-weight:700;margin-right:8px}
        .input-box button:hover{background-color:#166fe5}
        .term-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:20px;margin-top:30px}
        .term-box{background-color:#fff;border-radius:8px;padding:20px;border:1px solid #dddfe2;box-shadow:0 2px 4px rgba(0,0,0,0.1);transition:transform .2s,box-shadow .2s}
        .term-box:not(.locked):hover{transform:translateY(-5px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
        .term-box strong{display:block;margin-bottom:15px;font-size:1.2rem;color:#1c1e21}
        .term-box.locked{background-color:#f0f2f5;color:#bec3c9}
        .term-box.locked .status-badge{background-color:#ced0d4;color:#fff}
        .status-badge{padding:6px 12px;border-radius:15px;font-size:.9rem;font-weight:700;color:#fff;display:inline-block;margin-bottom:15px}
        .status-badge.approved{background-color:#42b72a}
        .status-badge.rejected{background-color:#fa3e3e}
        .status-badge.not-sent{background-color:#606770}
        .status-badge.locked{background-color:#ced0d4}
        .button-container button{width:100%;padding:10px;border:none;border-radius:6px;cursor:pointer;font-size:.9rem;font-weight:700;transition:background-color .3s}
        .button-container .send-btn{background-color:#1877f2;color:#fff}
        .button-container .send-btn:hover{background-color:#166fe5}
        .button-container .edit-btn{background-color:#f5a623;color:#fff}
        .button-container .edit-btn:hover{background-color:#d89620}
        .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.6);opacity:0;visibility:hidden;transition:opacity .3s ease;z-index:1000}
        .overlay.active{opacity:1;visibility:visible}
        .popup-alert,.popup-form{position:fixed;top:50%;left:50%;width:90%;max-width:500px;background-color:#fff;border-radius:8px;padding:25px;transform:translate(-50%,-50%) scale(.9);box-shadow:0 5px 15px rgba(0,0,0,0.3);z-index:1001;opacity:0;visibility:hidden;transition:opacity .3s ease,transform .3s ease}
        .popup-alert.active,.popup-form.active{opacity:1;visibility:visible;transform:translate(-50%,-50%) scale(1)}
        .popup-alert h3,.popup-form h3{margin-top:0;color:#1c1e21}
        .popup-form .question-box{background:#f0f2f5;border-radius:6px;padding:15px;margin-bottom:15px;text-align:right}
        .popup-form .question-box strong{color:#606770}
        .popup-form .question-box p{margin:5px 0 0;color:#1c1e21;white-space:pre-wrap}
        .popup-form textarea{width:100%;padding:12px;min-height:150px;border:1px solid #dddfe2;border-radius:6px;resize:vertical;font-size:1rem;margin-bottom:15px}
        .popup-form button[type=submit]{width:100%;padding:12px;background-color:#42b72a;color:#fff;border:none;border-radius:6px;font-weight:700;font-size:1rem;cursor:pointer}
        .popup-alert button,.popup-form .close-btn{width:100%;padding:12px;background-color:#6c757d;color:#fff;border:none;border-radius:6px;font-weight:700;font-size:1rem;cursor:pointer;margin-top:10px}
        .popup-alert p{font-size:1rem;color:#606770;margin:20px 0}
    </style>
</head>
<body>
    <div class="container">
        <div id="loader" class="loader-container" style="display: none;">
            <div class="loader"></div>
            <p id="loader-text">در حال بررسی...</p>
        </div>

        <h2>سامانه بررسی و ارسال تکالیف</h2>
        <p id="welcome-name" class="welcome-message"></p>
        
        <div class="input-box" id="login-section">
            <input type="number" id="nationalCodeInput" placeholder="کد ملی را وارد کنید" onkeydown="if(event.key==='Enter') document.getElementById('check-btn').click()" />
            <button id="check-btn" onclick="checkUser()">بررسی</button>
        </div>
        
        <div id="dashboard" class="term-container"></div>
    </div>

    <div id="form-overlay" class="overlay"></div>
    <div id="form-popup" class="popup-form">
        <h3 id="popup-title"></h3>
        <div class="question-box">
            <strong>سوال:</strong>
            <p id="popup-question"></p>
        </div>
        <form id="assignment-form" onsubmit="submitAssignmentForm(event)">
            <input type="hidden" id="form-name" />
            <input type="hidden" id="form-national-code" />
            <input type="hidden" id="form-term" />
            <input type="hidden" id="form-existing-row" />
            <textarea id="form-answer" name="answer" required placeholder="پاسخ خود را اینجا وارد کنید..."></textarea>
            <button type="submit" id="submit-btn">ارسال</button>
        </form>
        <button class="close-btn" onclick="closeFormPopup()">بستن</button>
    </div>
    
    <div id="alert-overlay" class="overlay"></div>
    <div id="alert-popup" class="popup-alert">
        <h3 id="alert-title">توجه</h3>
        <p id="alert-message"></p>
        <button onclick="closeAlertPopup()">باشه</button>
    </div>

    <script>
        // <<<<<<<<<<<<<<< مهم: آدرس API خود را اینجا قرار دهید >>>>>>>>>>>>>>>>>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxLLPOBKmJWSmCiR51loLno_QeRsaHYMaZqr5Awz0afyeZYtL2wA8V2zgRc-KVfgX8Y/exec";
        // <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

        let currentStudent = {};
        let dashboardData = {};

        function showLoader(text = "لطفا صبر کنید...") {
            document.getElementById('loader-text').innerText = text;
            document.getElementById('loader').style.display = 'flex';
        }

        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
        }

        function showAlert(message, title = "خطا") {
            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-message').innerText = message;
            document.getElementById('alert-overlay').classList.add('active');
            document.getElementById('alert-popup').classList.add('active');
        }

        function closeAlertPopup() {
            document.getElementById('alert-overlay').classList.remove('active');
            document.getElementById('alert-popup').classList.remove('active');
        }

        async function apiCall(action, payload) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Required for Apps Script
                    body: JSON.stringify({ action, ...payload })
                });
                if (!response.ok) {
                    throw new Error(`Server error: ${response.statusText}`);
                }
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('API Call Failed:', error);
                return { success: false, message: 'خطا در ارتباط با سرور. لطفا اتصال اینترنت خود را بررسی کنید.' };
            }
        }

        async function checkUser() {
            const nationalId = document.getElementById('nationalCodeInput').value.trim();
            if (!nationalId) {
                showAlert("لطفاً کد ملی را وارد کنید.");
                return;
            }
            showLoader("در حال بررسی اطلاعات ثبت نام...");

            const response = await apiCall('checkUser', { nationalId });
            
            if (response.success) {
                currentStudent = { name: response.name, nationalId };
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('welcome-name').innerText = `خوش آمدید، ${response.name}`;
                fetchDashboardData();
            } else {
                hideLoader();
                showAlert(response.message || "کد ملی یافت نشد.");
            }
        }

        async function fetchDashboardData() {
            showLoader("در حال دریافت وضعیت تکالیف...");
            const response = await apiCall('getDashboardData', { nationalId: currentStudent.nationalId });
            hideLoader();
            if (response.success) {
                dashboardData = response;
                renderDashboard();
            } else {
                showAlert(response.message || "خطا در دریافت اطلاعات.");
            }
        }
        
        // تابع renderDashboard و بقیه توابع جاوا اسکریپت دقیقا مانند پاسخ قبلی هستند
        // و نیازی به تغییر ندارند. در اینجا آنها را دوباره قرار می‌دهم:

        function renderDashboard() {
            const container = document.getElementById('dashboard');
            container.innerHTML = '';
            let lastApprovedTerm = 0;
            
            for (const term in dashboardData.submissions) {
                if (dashboardData.submissions[term].status == 5) {
                    if (parseInt(term) > lastApprovedTerm) lastApprovedTerm = parseInt(term);
                }
            }

            for (let term = 1; term <= 8; term++) {
                const termData = dashboardData.submissions[term];
                const box = document.createElement('div');
                box.className = 'term-box';

                let status = 'not-sent', statusText = 'ارسال نشده', buttons = '';
                const isLocked = term > (lastApprovedTerm + 1);

                if (termData) {
                    if (termData.status == 5) { status = 'approved'; statusText = 'تایید شده'; } 
                    else { status = 'rejected'; statusText = 'نیاز به ویرایش'; buttons = `<button class="edit-btn" onclick="openFormPopup(${term})">ویرایش تکلیف</button>`; }
                } else if (!isLocked) {
                    buttons = `<button class="send-btn" onclick="openFormPopup(${term})">ارسال تکلیف</button>`;
                }

                if (isLocked) { status = 'locked'; statusText = 'قفل شده'; box.classList.add('locked'); }

                box.innerHTML = `<strong>ترم ${term}</strong><div class="status-badge ${status}">${statusText}</div><div class="button-container">${buttons}</div>`;
                container.appendChild(box);
            }
        }

        function openFormPopup(term) {
            const termData = dashboardData.submissions[term];
            const question = dashboardData.questions[term];
            if (!question) { showAlert(`سوال برای ترم ${term} تعریف نشده است.`); return; }
            document.getElementById('popup-title').innerText = `تکلیف ترم ${term}`;
            document.getElementById('popup-question').innerText = question;
            document.getElementById('form-name').value = currentStudent.name;
            document.getElementById('form-national-code').value = currentStudent.nationalId;
            document.getElementById('form-term').value = term;
            if (termData) {
                document.getElementById('form-answer').value = termData.answer;
                document.getElementById('form-existing-row').value = termData.row;
                document.getElementById('submit-btn').innerText = 'ویرایش و ارسال مجدد';
            } else {
                document.getElementById('form-answer').value = '';
                document.getElementById('form-existing-row').value = '';
                document.getElementById('submit-btn').innerText = 'ارسال';
            }
            document.getElementById('form-overlay').classList.add('active');
            document.getElementById('form-popup').classList.add('active');
        }

        function closeFormPopup() {
            document.getElementById('form-overlay').classList.remove('active');
            document.getElementById('form-popup').classList.remove('active');
        }

        async function submitAssignmentForm(event) {
            event.preventDefault();
            if (!document.getElementById('form-answer').value.trim()) { showAlert("فیلد پاسخ نمی‌تواند خالی باشد."); return; }
            showLoader("در حال ارسال و ارزیابی توسط هوش مصنوعی...");
            closeFormPopup();
            const formData = { name: currentStudent.name, nationalId: currentStudent.nationalId, term: document.getElementById('form-term').value, answer: document.getElementById('form-answer').value, existingRow: document.getElementById('form-existing-row').value };
            const response = await apiCall('submitAssignment', { formData });
            hideLoader();
            if (response.success) {
                showAlert(response.message, response.grade == 5 ? "موفق" : "نیاز به بازبینی");
                fetchDashboardData();
            } else {
                showAlert(response.message || "خطا در ثبت.");
            }
        }
    </script>
</body>
</html>
