 <!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow">
  <title>سیستم ارسال تکالیف</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- ▼▼▼ اسکریپت Google reCAPTCHA ▼▼▼ -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <style>
    :root {
      --primary-color: #0d6efd; --success-color: #198754; --danger-color: #dc3545;
      --warning-color: #ffc107; --info-color: #0dcaf0; --light-color: #f8f9fa;
      --dark-color: #212529; --gray-color: #6c757d; 
      
      /* New Modern Variables */
      --font-family: 'Vazirmatn', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --text-light: #f5f5f5;
      --text-muted: #adb5bd;
      --border-radius: 16px;
      --glass-bg: rgba(30, 30, 40, 0.65);
      --glass-border: 1px solid rgba(255, 255, 255, 0.18);
      --backdrop-blur: blur(12px);
      --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      --primary-glow: 0 0 15px rgba(13, 110, 253, 0.5);
      --primary-gradient: linear-gradient(45deg, #0d6efd, #0dcaf0);
    }
    
    body {
      font-family: var(--font-family); direction: rtl; text-align: right;
      margin: 0; padding: 20px; color: var(--text-light);
      min-height: 100vh; display: flex; align-items: center; justify-content: center;
      
      /* --- Background Image Added --- */
      background-image: url('https://tashacol.ir/123.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    
    /* Dark overlay for better text readability */
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: -1;
    }

    .container {
      width: 100%; max-width: 1100px; margin: 1rem auto; padding: 40px;
      /* --- Glassmorphism Effect --- */
      background: var(--glass-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      border: var(--glass-border);
      backdrop-filter: var(--backdrop-blur);
      -webkit-backdrop-filter: var(--backdrop-blur);
    }
    
    .main-header { 
      text-align: center; margin-bottom: 2rem; color: var(--text-light); 
      font-size: 2.2rem; font-weight: 700;
      text-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    .main-header i { color: var(--info-color); margin-left: 15px; }

    .ai-warning {
        background-color: rgba(255, 193, 7, 0.1);
        color: #ffc107;
        border: 1px solid rgba(255, 193, 7, 0.5);
        border-radius: 12px; padding: 15px; margin: 0 auto 2rem auto;
        max-width: 700px; text-align: center; font-size: 0.95rem; line-height: 1.7;
    }
    .ai-warning i { margin-left: 8px; }

    .input-group {
      margin: 0 auto 2.5rem auto; display: flex; 
      border-radius: var(--border-radius); overflow: hidden; max-width: 450px;
      border: var(--glass-border);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    #nationalCodeInput { 
      flex-grow: 1; padding: 15px 20px; 
      border: none;
      background-color: rgba(0,0,0,0.2);
      font-size: 1.1rem; text-align: right; transition: all 0.3s;
      color: var(--text-light);
    }
    #nationalCodeInput::placeholder { color: var(--text-muted); opacity: 1; }
    #nationalCodeInput:focus { 
      background-color: rgba(0,0,0,0.3);
      box-shadow: inset 0 0 10px rgba(13, 110, 253, 0.4);
      outline: none; 
    }
    #checkBtn { 
      padding: 15px 30px; border: none; 
      background: var(--primary-gradient);
      color: white; cursor: pointer; transition: all 0.3s; 
      font-weight: bold; font-size: 1.1rem;
    }
    #checkBtn i { transition: transform 0.3s; }
    #checkBtn:hover { 
      filter: brightness(1.2);
      box-shadow: var(--primary-glow);
    }
    #checkBtn:hover i { transform: scale(1.2); }
    
    .user-welcome { 
      text-align: center; font-size: 1.7rem; font-weight: 500; margin-bottom: 2rem; 
      text-shadow: 0 1px 3px rgba(0,0,0,0.4);
    }
    
    .terms-grid { display: none; grid-template-columns: repeat(auto-fill, minmax(290px, 1fr)); gap: 25px; }
    
    .term-box {
      /* --- Glassmorphism Effect --- */
      background: var(--glass-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      border: var(--glass-border);
      backdrop-filter: var(--backdrop-blur);
      -webkit-backdrop-filter: var(--backdrop-blur);
      
      display: flex; flex-direction: column; overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .term-box:hover { 
      transform: translateY(-8px) scale(1.02); 
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5); 
    }
    
    .term-header { 
      padding: 20px; 
      border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
    }
    .term-title { font-size: 1.6rem; font-weight: 700; margin: 0; color: #fff; }
    .term-due-date { font-size: 0.8rem; color: var(--text-muted); margin-top: 5px; font-weight: 500; }
    .term-body { padding: 20px; flex-grow: 1; }
    
    .status-badge { 
      display: inline-flex; align-items: center; gap: 10px; 
      font-size: 1rem; font-weight: 500; margin-bottom: 20px;
      padding: 8px 15px; border-radius: 50px;
      background-color: rgba(0,0,0,0.2);
    }
    .status-badge i { font-size: 1.3rem; }
    .status-approved { color: #28a745; } .status-rejected { color: #dc3545; }
    .status-pending { color: #ffc107; } .status-locked { color: #6c757d; }
    
    .term-footer { 
      padding: 20px; 
      background-color: rgba(0,0,0,0.2); 
      border-top: 1px solid rgba(255, 255, 255, 0.1); 
    }
    
    .term-btn {
      width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer;
      transition: all 0.2s; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 8px;
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    .btn-submit { background: var(--primary-gradient); box-shadow: var(--primary-glow); }
    .btn-edit { background: linear-gradient(45deg, #ffc107, #ff9800); box-shadow: 0 0 15px rgba(255, 193, 7, 0.5); }
    .btn-reason { background: linear-gradient(45deg, #17a2b8, #20c997); box-shadow: 0 0 15px rgba(23, 162, 184, 0.5); }
    .term-btn:disabled { 
      background-color: rgba(108, 117, 125, 0.5);
      color: var(--text-muted); cursor: not-allowed; 
      box-shadow: none;
    }
    .term-btn:hover:not(:disabled) { transform: translateY(-3px); filter: brightness(1.2); }
    
    .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 40px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .linear-loader {
        height: 8px; width: 100%; max-width: 450px; margin: 0 auto 2.5rem auto;
        background-color: rgba(255,255,255,0.2); border-radius: 4px; overflow: hidden;
    }
    .linear-loader-bar {
        height: 100%; width: 0; 
        background: var(--primary-gradient);
        animation: fill-bar 2.5s ease-out forwards;
    }
    @keyframes fill-bar { from { width: 0%; } to { width: 100%; } }
    
    .overlay { 
      display: none; position: fixed; z-index: 1000; left: 0; top: 0; 
      width: 100%; height: 100%; overflow: auto; 
      background-color: rgba(0,0,0,0.7); 
      backdrop-filter: blur(5px); animation: fadeIn 0.3s ease; 
    }
    .overlay.active { display: flex; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    .popup-base { 
      margin: auto; padding: 0; width: 90%; max-width: 600px; 
      animation: slideIn 0.4s ease; overflow: hidden;
      /* --- Glassmorphism Effect --- */
      background: var(--glass-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      border: var(--glass-border);
      backdrop-filter: var(--backdrop-blur);
      -webkit-backdrop-filter: var(--backdrop-blur);
    }
    @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { translateY(0); opacity: 1; } }
    
    .popup-header { 
      font-size: 1.5rem; font-weight: 600; padding: 20px 25px; 
      background-color: rgba(0,0,0,0.2); 
      border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
    }
    .popup-body { padding: 25px; max-height: 65vh; overflow-y: auto; }
    .popup-body p, .popup-body div { white-space: pre-wrap; line-height: 1.8; }
    .popup-body strong { color: var(--info-color); }
    
    #submissionModal textarea {
      width: 100%; min-height: 200px; padding: 15px;
      border-radius: 12px; transition: all 0.3s; resize: vertical; font-size: 1rem;
      font-family: var(--font-family); box-sizing: border-box;
      background-color: rgba(0,0,0,0.2); color: var(--text-light);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    #submissionModal textarea:focus { 
      border-color: var(--info-color); 
      box-shadow: 0 0 0 3px rgba(13, 202, 240, 0.3); outline: none; 
    }
    .word-count { font-size: 0.9rem; color: var(--text-muted); text-align: left; margin-top: 8px; }
    .word-count.invalid { color: var(--danger-color); font-weight: bold; }
    
    .popup-footer { 
      padding: 20px 25px; 
      background-color: rgba(0,0,0,0.2); 
      text-align: left; 
      border-top: 1px solid rgba(255, 255, 255, 0.1); 
      display: flex; gap: 15px; justify-content: flex-end; 
    }
    .popup-footer button { 
      padding: 10px 25px; border-radius: 8px; font-size: 1rem; 
      font-weight: bold; cursor: pointer; transition: all 0.2s; border: none;
    }
    .popup-footer .confirm-btn { background: var(--primary-gradient); color: white; }
    .popup-footer .confirm-btn:hover { filter: brightness(1.2); box-shadow: var(--primary-glow); }
    .popup-footer .cancel-btn { background-color: rgba(255,255,255,0.1); color: var(--text-light); border: 1px solid rgba(255,255,255,0.2); }
    .popup-footer .cancel-btn:hover { background-color: rgba(255,255,255,0.2); }
    
    #reasonModalContent strong { color: var(--danger-color); }
    #reasonModalContent ul { padding-right: 20px; }
    
    .grecaptcha-badge { visibility: hidden; }
  </style>
</head>
<body>

  <div class="container">
    <h2 class="main-header"><i class="fas fa-tasks"></i>سیستم ارسال تکالیف</h2>
    <div class="ai-warning"><i class="fas fa-exclamation-triangle"></i> هرگونه تقلب شرعا حرام بوده و این سیستم مجهز به هوش مصنوعی است و در صورتیکه جواب از هوش مصنوعی اخذ شده باشد توسط سیستم تشخیص داده شده و رد می‌شود.</div>

    <div id="nationalCodeSection">
      <div class="input-group">
        <input type="text" id="nationalCodeInput" placeholder="کد ملی خود را وارد کنید..." />
        <button id="checkBtn" onclick="handleLoginClick()"><i class="fas fa-search"></i></button>
      </div>
    </div>

    <div id="linearLoader" class="linear-loader" style="display: none;">
      <div class="linear-loader-bar"></div>
    </div>

    <div id="loader" class="loader" style="display: none;"></div>
    <div id="userInfo" style="display: none;"><h3 id="userName" class="user-welcome"></h3></div>
    <div id="termsGrid" class="terms-grid"></div>
  </div>

  <!-- پاپ‌آپ‌ها بدون تغییر در ساختار HTML -->
  <div id="submissionModalOverlay" class="overlay">
    <div id="submissionModal" class="popup-base">
      <div id="submissionModalHeader" class="popup-header"></div>
      <div class="popup-body">
        <div><strong><i class="fas fa-question-circle"></i> سوال:</strong></div>
        <p id="submissionModalQuestion" style="white-space: pre-wrap; background-color: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-top: 10px;"></p>
        <form id="submissionForm" style="margin-top: 20px;">
          <input type="hidden" id="termNumber">
          <label for="answerText"><strong><i class="fas fa-pen-alt"></i> پاسخ شما:</strong></label>
          <textarea id="answerText" required placeholder="متن تکلیف خود را اینجا وارد کنید" style="margin-top: 10px;"></textarea>
          <div id="wordCount" class="word-count">تعداد کلمات: 0</div>
        </form>
      </div>
      <div class="popup-footer">
        <button type="button" class="cancel-btn" onclick="closeSubmissionModal()">انصراف</button>
        <button type="submit" form="submissionForm" id="submitBtn" class="confirm-btn">ارسال تکلیف</button>
      </div>
    </div>
  </div>
  <div id="reasonModalOverlay" class="overlay">
    <div id="reasonModal" class="popup-base">
      <div class="popup-header"><i class="fas fa-info-circle"></i> دلیل رد تکلیف</div>
      <div class="popup-body"><div id="reasonModalContent"></div></div>
      <div class="popup-footer"><button type="button" class="confirm-btn" onclick="closeReasonModal()">متوجه شدم</button></div>
    </div>
  </div>
  <div id="approvedSubmissionModalOverlay" class="overlay">
    <div id="approvedSubmissionModal" class="popup-base">
      <div class="popup-header"><i class="fas fa-check-circle"></i> متن تکلیف تایید شده</div>
      <div class="popup-body">
        <p id="approvedSubmissionContent"></p>
      </div>
      <div class="popup-footer">
        <button type="button" class="confirm-btn" onclick="closeApprovedSubmissionModal()">بستن</button>
      </div>
    </div>
  </div>
  <div id="messageModalOverlay" class="overlay">
    <div id="messageModal" class="popup-base">
      <div id="messageModalHeader" class="popup-header"></div>
      <div class="popup-body"><p id="messageModalContent" style="font-size: 1.1rem; text-align: center;"></p></div>
      <div class="popup-footer"><button type="button" class="confirm-btn" onclick="closeMessageModal()">تایید</button></div>
    </div>
  </div>
  
  <!-- ▼▼▼ المان کپچا با کلید سایت شما ▼▼▼ -->
  <div class="g-recaptcha"
       data-sitekey="6Lc1vqkrAAAAAHLHbzPMzlREvKwgHDNSmakrB-aq"
       data-size="invisible"
       data-callback="onRecaptchaSuccess">
  </div>


  <script>
    // JAVASCRIPT LOGIC IS COMPLETELY UNCHANGED AS REQUESTED
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwM6QPomqlgoIvgPq7CsWhTBAhgB-EbsIyOnPLClRzFFS2rhvzo89jh7AsW8znGAe9s/exec";

    const nationalCodeInput = document.getElementById('nationalCodeInput');
    const loader = document.getElementById('loader');
    const termsGrid = document.getElementById('termsGrid');
    const userInfo = document.getElementById('userInfo');
    const userNameEl = document.getElementById('userName');
    const submissionForm = document.getElementById('submissionForm');
    const answerTextarea = document.getElementById('answerText');
    const wordCountDisplay = document.getElementById('wordCount');
    const submissionModalOverlay = document.getElementById('submissionModalOverlay');
    const reasonModalOverlay = document.getElementById('reasonModalOverlay');
    const messageModalOverlay = document.getElementById('messageModalOverlay');
    const nationalCodeSection = document.getElementById('nationalCodeSection');
    const linearLoader = document.getElementById('linearLoader');
    const approvedSubmissionModalOverlay = document.getElementById('approvedSubmissionModalOverlay');
    
    let userData = {};
    let sessionToken = null; 

    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const nationalCodeFromId = params.get('id');
        
        if (nationalCodeFromId && /^\d{10}$/.test(nationalCodeFromId)) {
            nationalCodeSection.style.display = 'none';
            linearLoader.style.display = 'block';
            nationalCodeInput.value = nationalCodeFromId;
            grecaptcha.ready(() => { grecaptcha.execute(); });
        }
    });

    answerTextarea.addEventListener('input', () => {
      const text = answerTextarea.value.trim();
      const words = text.split(/\s+/).filter(word => word.length > 0);
      wordCountDisplay.textContent = `تعداد کلمات: ${words.length}`;
      wordCountDisplay.classList.toggle('invalid', words.length < 200 || words.length > 1500);
    });

    function showSubmissionModal(term) {
      document.getElementById('termNumber').value = term;
      document.getElementById('submissionModalHeader').innerHTML = `<i class="fas fa-upload"></i> ارسال تکلیف ترم ${term}`;
      document.getElementById('submissionModalQuestion').textContent = userData.questions[term] || 'سوالی برای این ترم تعریف نشده است.';
      answerTextarea.value = userData.submissions[term]?.answer || '';
      answerTextarea.dispatchEvent(new Event('input'));
      submissionModalOverlay.classList.add('active');
    }
    function closeSubmissionModal() { submissionModalOverlay.classList.remove('active'); }
    function showReasonModal(term) {
      const reason = userData.submissions[term]?.reason || 'دلیلی ثبت نشده است.';
      document.getElementById('reasonModalContent').innerHTML = renderMarkdown(reason);
      reasonModalOverlay.classList.add('active');
    }
    function closeReasonModal() { reasonModalOverlay.classList.remove('active'); }
    function showMessageModal(title, message) {
      document.getElementById('messageModalHeader').innerText = title;
      document.getElementById('messageModalContent').innerText = message;
      messageModalOverlay.classList.add('active');
    }
    function closeMessageModal() { messageModalOverlay.classList.remove('active'); }
    function showApprovedSubmissionModal(term) {
      const answer = userData.submissions[term]?.answer || 'متن تکلیفی یافت نشد.';
      document.getElementById('approvedSubmissionContent').textContent = answer;
      approvedSubmissionModalOverlay.classList.add('active');
    }
    function closeApprovedSubmissionModal() { approvedSubmissionModalOverlay.classList.remove('active'); }

    function handleLoginClick() {
        const nationalCode = nationalCodeInput.value.trim();
        if (!/^\d{10}$/.test(nationalCode)) {
            return showMessageModal("خطا", "کد ملی وارد شده معتبر نیست.");
        }
        loader.style.display = 'block';
        termsGrid.style.display = 'none';
        userInfo.style.display = 'none';
        grecaptcha.ready(() => {
            grecaptcha.execute();
        });
    }

    async function onRecaptchaSuccess(recaptchaToken) {
      const nationalCode = nationalCodeInput.value.trim();
      
      try {
        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ action: 'login', nationalCode, recaptchaToken })
        });
        
        if (!response.ok) throw new Error(`خطای شبکه (کد: ${response.status})`);
        
        const data = await response.json();
        
        if (data.success && data.sessionToken) {
          sessionToken = data.sessionToken;
          displayData(data);
        } else {
          handleError({ message: data.error || "خطای نامشخص از سرور." });
        }
      } catch (error) { 
        handleError(error); 
      } finally {
        grecaptcha.reset();
      }
    }

    function displayData(data) {
      loader.style.display = 'none';
      linearLoader.style.display = 'none';

      if (data.error && !data.success) {
        nationalCodeSection.style.display = 'flex';
        userInfo.style.display = 'none';
        termsGrid.style.display = 'none';
        return showMessageModal("وضعیت دوره", data.error);
      }
      
      nationalCodeSection.style.display = 'none';

      userData = data;
      userNameEl.innerHTML = `<i class="fas fa-user-check"></i> خوش آمدید، ${data.name}!`;
      userInfo.style.display = 'block';
      termsGrid.innerHTML = '';
      const lastApprovedTerm = Math.max(0, ...Object.keys(data.submissions).filter(t => data.submissions[t].status == 5).map(Number));

      const totalTerms = Object.keys(data.termDetails).length;
      for (let term = 1; term <= totalTerms; term++) {
        const submission = data.submissions[term];
        const details = data.termDetails[term];
        const prevTermApproved = (term === 1 || lastApprovedTerm >= term - 1);
        
        let statusIcon, statusText, statusClass, buttonsHTML;
        let dueDateHTML = '';

        if (details.isUnlocked) {
            dueDateHTML = `<div class="term-due-date">آخرین مهلت: ${details.dueDate}</div>`;
            const canSubmit = prevTermApproved;

            if (submission) {
                if (submission.status == 5) {
                    statusIcon = 'fa-check-circle'; statusText = 'تأیید شده'; statusClass = 'status-approved';
                    buttonsHTML = `<button class="term-btn" disabled><i class="fas fa-check"></i> تأیید شده</button>`;
                    buttonsHTML += `<button class="term-btn btn-reason" style="margin-top: 10px;" onclick="showApprovedSubmissionModal(${term})"><i class="fas fa-eye"></i> مشاهده تکلیف</button>`;
                } else if (submission.status == 0) {
                    statusIcon = 'fa-times-circle'; statusText = 'تأیید نشده'; statusClass = 'status-rejected';
                    buttonsHTML = `<button class="term-btn btn-edit" onclick="showSubmissionModal(${term})"><i class="fas fa-pencil-alt"></i> ویرایش تکلیف</button>`;
                    if (submission.reason) { buttonsHTML += `<button class="term-btn btn-reason" style="margin-top: 10px;" onclick="showReasonModal(${term})"><i class="fas fa-eye"></i> مشاهده دلیل</button>`; }
                } else {
                    statusIcon = 'fa-hourglass-half'; statusText = 'در حال بررسی'; statusClass = 'status-pending';
                    buttonsHTML = `<button class="term-btn" disabled><i class="fas fa-spinner fa-spin"></i> در حال بررسی</button>`;
                }
            } else {
                if (canSubmit) {
                    statusIcon = 'fa-clock'; statusText = 'آماده ارسال'; statusClass = 'status-pending';
                    buttonsHTML = `<button class="term-btn btn-submit" onclick="showSubmissionModal(${term})"><i class="fas fa-paper-plane"></i> ارسال تکلیف</button>`;
                } else {
                    statusIcon = 'fa-lock'; statusText = 'منتظر تأیید ترم قبل'; statusClass = 'status-locked';
                    buttonsHTML = `<button class="term-btn" disabled><i class="fas fa-lock"></i> منتظر تأیید ترم قبل</button>`;
                }
            }
        } else {
            statusIcon = 'fa-lock'; statusText = 'قفل شده'; statusClass = 'status-locked';
            buttonsHTML = `<button class="term-btn" disabled><i class="fas fa-lock"></i> بازگشایی در ${details.unlockDate}</button>`;
        }
        
        const termBox = document.createElement('div');
        termBox.className = 'term-box';
        termBox.innerHTML = `
          <div class="term-header">
            <h3 class="term-title">ترم ${term}</h3>
            ${dueDateHTML}
          </div>
          <div class="term-body"><div class="status-badge ${statusClass}"><i class="fas ${statusIcon}"></i><span>${statusText}</span></div></div>
          <div class="term-footer">${buttonsHTML}</div>`;
        termsGrid.appendChild(termBox);
      }
      termsGrid.style.display = 'grid';
    }
    
    submissionForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!sessionToken) {
          return showMessageModal("خطا", "نشست شما معتبر نیست. لطفاً صفحه را رفرش کنید.");
      }

      const term = document.getElementById('termNumber').value;
      const answer = answerTextarea.value.trim();
      const words = answer.split(/\s+/).filter(word => word.length > 0);
      if (words.length < 200 || words.length > 1500) { return showMessageModal("خطا", "تعداد کلمات پاسخ شما باید بین ۲۰۰ تا ۱۵۰۰ کلمه باشد."); }
      
      const submitBtn = document.getElementById('submitBtn');
      const originalBtnHTML = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> در حال ارسال...`;

      const payload = {
          action: 'submitAssignment',
          sessionToken: sessionToken,
          formData: { term, answer }
      };

      try {
        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error(`خطای شبکه (کد: ${response.status})`);
        
        const result = await response.json();
        
        closeSubmissionModal();
        showMessageModal(result.success ? "موفقیت" : "توجه", result.message || "پاسخ نامشخص از سرور.");

        if (result.updatedData && result.updatedData.success) {
            displayData(result.updatedData);
        } else if (result.message.includes("نشست")) {
            window.location.reload();
        }

      } catch (error) {
        handleError(error);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnHTML;
      }
    });

    function handleError(error) {
      linearLoader.style.display = 'none';
      loader.style.display = 'none';
      nationalCodeSection.style.display = 'flex';
      userInfo.style.display = 'none';
      termsGrid.style.display = 'none';
      showMessageModal("خطای اتصال", 'خطا در ارتباط با سرور: ' + error.message);
    }

    function renderMarkdown(text) {
      let html = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
      html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/^\* (.*$)/gm, '<li>$1</li>');
      if (html.includes('<li>')) { html = '<ul>' + html.replace(/<\/li>\s*<li>/g, '</li><li>') + '</ul>'; }
      return html.replace(/\n/g, '<br>');
    }

    window.onclick = (event) => {
      if (event.target == submissionModalOverlay) closeSubmissionModal();
      if (event.target == reasonModalOverlay) closeReasonModal();
      if (event.target == messageModalOverlay) closeMessageModal();
      if (event.target == approvedSubmissionModalOverlay) closeApprovedSubmissionModal();
    }
    nationalCodeInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') { event.preventDefault(); document.getElementById('checkBtn').click(); } });
  </script>

</body>
</html>
