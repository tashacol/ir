 <!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>سیستم ارسال تکالیف</title>
  ...
</head>
<body>
  <div class="container">
    <h2 class="main-header"><i class="fas fa-tasks"></i>سیستم ارسال تکالیف</h2>
    <div class="ai-warning"><i class="fas fa-exclamation-triangle"></i> هرگونه تقلب شرعا حرام بوده و این سیستم مجهز به هوش مصنوعی است و در صورتیکه جواب از هوش مصنوعی اخذ شده باشد توسط سیستم تشخیص داده شده و رد می‌شود.</div>
    
    <div id="nationalCodeSection">
      <div class="input-group">
        <input type="text" id="nationalCodeInput" placeholder="کد ملی خود را وارد کنید..." />
        <button id="checkBtn" onclick="fetchData()"><i class="fas fa-search"></i></button>
      </div>
    </div>
    
    <div id="linearLoader" class="linear-loader" style="display: none;">
      <div class="linear-loader-bar"></div>
    </div>
    
    <div id="loader" class="loader" style="display: none;"></div>
    <div id="userInfo" style="display: none;"><h3 id="userName" class="user-welcome"></h3></div>
    <div id="termsGrid" class="terms-grid"></div>
  </div>
  ...
  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwxrTtG9kuMD9jNuju5fBYmadGF6K_4komw4-Khfj8wVXktKLGeiwdtV_Zxm40ULBFW/exec";

    const nationalCodeInput = document.getElementById('nationalCodeInput');
    const loader = document.getElementById('loader');
    const termsGrid = document.getElementById('termsGrid');
    const userInfo = document.getElementById('userInfo');
    const userNameEl = document.getElementById('userName');
    const submissionForm = document.getElementById('submissionForm');
    const answerTextarea = document.getElementById('answerText');
    const wordCountDisplay = document.getElementById('wordCount');
    const submissionModalOverlay = document.getElementById('submissionModalOverlay');
    const reasonModalOverlay = document.getElementById('reasonModalOverlay');
    const messageModalOverlay = document.getElementById('messageModalOverlay');
    
    const nationalCodeSection = document.getElementById('nationalCodeSection');
    const linearLoader = document.getElementById('linearLoader');
    
    let userData = {};

    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const nationalCodeFromId = params.get('id');
        
        if (nationalCodeFromId && /^\d{10}$/.test(nationalCodeFromId)) {
            nationalCodeSection.style.display = 'none'; // مخفی کردن فیلد ورودی
            linearLoader.style.display = 'block'; // نمایش لودر خطی
            fetchData(nationalCodeFromId);
        }
    });

    answerTextarea.addEventListener('input', () => {
      const text = answerTextarea.value.trim();
      const words = text.split(/\s+/).filter(word => word.length > 0);
      wordCountDisplay.textContent = `تعداد کلمات: ${words.length}`;
      wordCountDisplay.classList.toggle('invalid', words.length < 200 || words.length > 1500);
    });

    function showSubmissionModal(term) {
      document.getElementById('termNumber').value = term;
      document.getElementById('submissionModalHeader').innerHTML = `<i class="fas fa-upload"></i> ارسال تکلیف ترم ${term}`;
      document.getElementById('submissionModalQuestion').textContent = userData.questions[term] || 'سوالی برای این ترم تعریف نشده است.';
      answerTextarea.value = userData.submissions[term]?.answer || '';
      answerTextarea.dispatchEvent(new Event('input'));
      submissionModalOverlay.classList.add('active');
    }
    function closeSubmissionModal() { submissionModalOverlay.classList.remove('active'); }
    function showReasonModal(term) {
      const reason = userData.submissions[term]?.reason || 'دلیلی ثبت نشده است.';
      document.getElementById('reasonModalContent').innerHTML = renderMarkdown(reason);
      reasonModalOverlay.classList.add('active');
    }
    function closeReasonModal() { reasonModalOverlay.classList.remove('active'); }
    function showMessageModal(title, message) {
      document.getElementById('messageModalHeader').innerText = title;
      document.getElementById('messageModalContent').innerText = message;
      messageModalOverlay.classList.add('active');
    }
    function closeMessageModal() { messageModalOverlay.classList.remove('active'); }

    async function fetchData(nationalCodeFromUrl = null) {
      const nationalCode = nationalCodeFromUrl || nationalCodeInput.value.trim();
      
      if (!/^\d{10}$/.test(nationalCode)) {
        return showMessageModal("خطا", "کد ملی ارائه شده معتبر نیست.");
      }
      
      if (!nationalCodeFromUrl) {
          loader.style.display = 'block';
          termsGrid.style.display = 'none';
          userInfo.style.display = 'none';
      }

      if (WEB_APP_URL.includes("YOUR_NEW_GOOGLE")) { return handleError({ message: "آدرس وب اپلیکیشن در کد HTML تنظیم نشده است." }); }

      try {
        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ action: 'getUserData', nationalCode })
        });
        if (!response.ok) throw new Error(`خطای شبکه (کد: ${response.status})`);
        const data = await response.json();
        displayData(data);
      } catch (error) { handleError(error); }
    }

    function displayData(data) {
      loader.style.display = 'none';
      linearLoader.style.display = 'none';

      if (data.error) {
        nationalCodeSection.style.display = 'flex';
        return showMessageModal("خطا", data.error);
      }
      
      nationalCodeSection.style.display = 'none';
      userData = data;
      userNameEl.innerHTML = `<i class="fas fa-user-check"></i> خوش آمدید، ${data.name}!`;
      userInfo.style.display = 'block';
      termsGrid.innerHTML = '';

      // دریافت اطلاعات تاریخ شروع و ترم باز
      const startDate = new Date(userData.startTimestamp);
      const openTerm = userData.openTerm;
      const today = new Date();

      const lastApprovedTerm = Math.max(0, ...Object.keys(data.submissions).filter(t => data.submissions[t].status == 5).map(Number));

      for (let term = 1; term <= 8; term++) {
        const submission = data.submissions[term];
        const isOpenTerm = (term <= openTerm);
        const canSubmit = isOpenTerm && (term === 1 || lastApprovedTerm >= term - 1);
        let statusIcon, statusText, statusClass, buttonsHTML = '';

        if (submission) {
          if (submission.status == 5) {
            statusIcon = 'fa-check-circle'; statusText = 'تأیید شده'; statusClass = 'status-approved';
            buttonsHTML = `<button class="term-btn" disabled><i class="fas fa-check"></i> تأیید شده</button>`;
          } else if (submission.status == 0) {
            statusIcon = 'fa-times-circle'; statusText = 'تأیید نشده'; statusClass = 'status-rejected';
            buttonsHTML = `<button class="term-btn btn-edit" onclick="showSubmissionModal(${term})"><i class="fas fa-pencil-alt"></i> ویرایش تکلیف</button>`;
            if (submission.reason) {
              buttonsHTML += `<button class="term-btn btn-reason" style="margin-top: 10px;" onclick="showReasonModal(${term})"><i class="fas fa-eye"></i> مشاهده دلیل</button>`;
            }
          } else {
            statusIcon = 'fa-hourglass-half'; statusText = 'در حال بررسی'; statusClass = 'status-pending';
            buttonsHTML = `<button class="term-btn" disabled><i class="fas fa-spinner fa-spin"></i> در حال بررسی</button>`;
          }
        } else {
          // اگر ترم هنوز باز نشده (بسته به تاریخ)
          if (!isOpenTerm) {
            statusIcon = 'fa-lock';
            statusClass = 'status-locked';
            let openDate = new Date(startDate);
            openDate.setDate(startDate.getDate() + (term - 1) * 14);
            statusText = `قفل شده (از ${openDate.toLocaleDateString('fa-IR')} باز می‌شود)`;
            buttonsHTML = `<button class="term-btn" disabled><i class="fas fa-lock"></i> قفل شده</button>`;
          } else {
            statusIcon = canSubmit ? 'fa-clock' : 'fa-lock';
            statusText = canSubmit ? 'آماده ارسال' : 'قفل شده';
            statusClass = canSubmit ? 'status-pending' : 'status-locked';
            buttonsHTML = `<button class="term-btn ${canSubmit ? 'btn-submit' : ''}" ${canSubmit ? `onclick="showSubmissionModal(${term})"` : 'disabled'}>${canSubmit ? '<i class="fas fa-paper-plane"></i> ارسال تکلیف' : '<i class="fas fa-lock"></i> قفل شده'}</button>`;
          }
        }
        
        const termBox = document.createElement('div');
        termBox.className = 'term-box';
        termBox.innerHTML = `
          <div class="term-header"><h3 class="term-title">ترم ${term}</h3></div>
          <div class="term-body"><div class="status-badge ${statusClass}"><i class="fas ${statusIcon}"></i><span>${statusText}</span></div></div>
          <div class="term-footer">${buttonsHTML}</div>`;
        termsGrid.appendChild(termBox);
      }
      termsGrid.style.display = 'grid';
    }
    
    submissionForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const term = document.getElementById('termNumber').value;
      const answer = answerTextarea.value.trim();
      const words = answer.split(/\s+/).filter(word => word.length > 0);
      if (words.length < 200 || words.length > 1500) {
        return showMessageModal("خطا", "تعداد کلمات پاسخ شما باید بین ۲۰۰ تا ۱۵۰۰ کلمه باشد.");
      }
      
      const submitBtn = document.getElementById('submitBtn');
      const originalBtnHTML = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> در حال ارسال...`;

      const formData = { name: userData.name, nationalCode: nationalCodeInput.value || new URLSearchParams(window.location.search).get('id'), term, answer };
      try {
        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ action: 'submitAssignment', formData })
        });
        if (!response.ok) throw new Error(`خطای شبکه (کد: ${response.status})`);
        const result = await response.json();
        closeSubmissionModal();
        handleSubmitSuccess(result);
      } catch (error) {
        handleError(error);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnHTML;
      }
    });

    // توابع کمکی handleSubmitSuccess, handleError و غیره بدون تغییر باقی می‌مانند

  </script>
</body>
</html>
