
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <!-- دستور اول: اجبار به حالت دسکتاپ -->
    <meta name="viewport" content="width=1280, initial-scale=1">
    <title>سامانه جامع تقویم آموزشی | نسخه Enterprise</title>
    
    <!-- کتابخانه‌های پردازشی -->
    <script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- فونت و استایل -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Microsoft Fluent Design Palette */
            --primary: #0078D4;
            --primary-dark: #005A9E;
            --primary-light: #EFF6FC;
            --text-dark: #242424;
            --text-grey: #605E5C;
            --bg-body: #F3F2F1;
            --surface: #FFFFFF;
            --border: #E1DFDD;
            --shadow-card: 0 4px 8px rgba(0,0,0,0.12);
            --shadow-hover: 0 8px 16px rgba(0,0,0,0.14);
            --radius: 8px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; font-family: 'Vazirmatn', 'Segoe UI', sans-serif; }

        body { background-color: var(--bg-body); color: var(--text-dark); padding-bottom: 60px; min-width: 1200px; }

        .app-header {
            background: var(--primary); color: white; padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); margin-bottom: 30px;
        }
        .header-content { max-width: 1300px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
        .brand { font-size: 1.4rem; font-weight: 900; display: flex; align-items: center; gap: 10px; }

        .container {
            max-width: 1300px; margin: 0 auto; padding: 0 20px;
            display: grid; grid-template-columns: 400px 1fr; gap: 25px;
        }

        /* پنل کناری */
        .sidebar {
            background: var(--surface); padding: 25px; border-radius: var(--radius);
            box-shadow: var(--shadow-card); border: 1px solid var(--border);
            height: fit-content;
        }

        .section-box { margin-bottom: 25px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .section-box:last-child { border-bottom: none; }
        
        .sec-title { 
            font-size: 1rem; font-weight: 700; color: var(--primary); 
            margin-bottom: 15px; display: flex; align-items: center; gap: 8px;
        }

        /* فرم‌ها */
        .form-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .form-col { flex: 1; }
        
        label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-grey); margin-bottom: 5px; }
        
        input[type="text"], select {
            width: 100%; padding: 8px 12px; border: 1px solid var(--text-grey); 
            border-radius: 4px; font-size: 0.9rem; transition: 0.2s;
        }
        input[type="text"]:focus, select:focus { border-color: var(--primary); border-width: 2px; padding: 7px 11px; }

        /* چک‌باکس‌های مدرن */
        .toggle-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
        .toggle-group { background: var(--primary-light); padding: 10px; border-radius: var(--radius); border: 1px solid var(--border); }

        /* دکمه‌ها */
        .btn {
            width: 100%; padding: 10px; border: none; border-radius: 4px; 
            font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 0.9rem;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: #107C10; color: white; }
        .btn-success:hover { background: #0b5a0b; }
        .btn-danger { background: #D13438; color: white; }
        .btn-danger:hover { background: #a4262c; }
        .btn-outline { background: white; border: 1px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--primary-light); }

        /* پنل اصلی */
        .main-panel {
            background: var(--surface); padding: 25px; border-radius: var(--radius);
            box-shadow: var(--shadow-card); min-height: 800px; border: 1px solid var(--border);
        }

        /* جدول */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: var(--primary); color: white; padding: 12px; text-align: center; border: 1px solid #005A9E; white-space: nowrap; }
        td { border: 1px solid #E1DFDD; padding: 8px; text-align: center; vertical-align: middle; }
        
        /* استایل ردیف‌ها */
        .row-holiday { background-color: #FDE7E9; color: #A80000; font-weight: bold; }
        .row-friday { background-color: #FFF4CE; color: #797775; }
        .row-inter { background-color: #FDF6E3; color: #8a6d3b; }
        .row-exam { background-color: #DEECF9; color: #005A9E; }
        .row-event { background-color: #E6FFEC; color: #107C10; }

        /* لیست رویدادها */
        .event-list { max-height: 150px; overflow-y: auto; border: 1px solid var(--border); margin-top: 10px; }
        .event-item { padding: 5px 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-size: 0.8rem; }
        .event-item:last-child { border-bottom: none; }

        /* لیست بین‌التعطیلین */
        .inter-group { margin-bottom: 15px; border: 1px solid #fed7aa; background: #fff7ed; padding: 10px; border-radius: 6px; }
        .inter-header { font-weight: bold; color: #c05621; display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.85rem; }
        .inter-item { margin-left: 15px; display: flex; align-items: center; gap: 5px; font-size: 0.85rem; padding: 3px 0; }

        /* PDF Hidden */
        #pdfSource { padding: 20px; background: white; display: none; }
        #pdfSource table { width: 100%; font-size: 10pt; border-collapse: collapse; }
        #pdfSource th, #pdfSource td { border: 1px solid black; padding: 4px; }
    </style>
</head>
<body>

<div class="app-header">
    <div class="header-content">
        <div class="brand"><i class="fas fa-calendar-check"></i> سامانه تقویم ساز آموزشی</div>
        <div style="font-size: 0.9rem; opacity: 0.9;">نسخه سازمانی دسکتاپ</div>
    </div>
</div>

<div class="container">
    
    <!-- تنظیمات -->
    <aside class="sidebar">
        <!-- 1. مشخصات و بازه -->
        <div class="section-box">
            <div class="sec-title"><i class="fas fa-info-circle"></i> اطلاعات و بازه زمانی</div>
            <div class="form-row">
                <div class="form-col"><label>عنوان تقویم</label><input type="text" id="calTitle" value="تقویم آموزشی"></div>
            </div>
            <div class="form-row">
                <div class="form-col"><label>زیرعنوان</label><input type="text" id="calSub" value="سال تحصیلی ۱۴۰۴"></div>
            </div>
            <div class="form-row">
                <div class="form-col"><label>شروع (Y/M/D)</label><input type="text" id="startDate" class="text-center"></div>
                <div class="form-col"><label>پایان (Y/M/D)</label><input type="text" id="endDate" class="text-center"></div>
            </div>
        </div>

        <!-- 2. تنظیمات پیشرفته -->
        <div class="section-box">
            <div class="sec-title"><i class="fas fa-sliders-h"></i> تنظیمات نمایش و تعطیلات</div>
            
            <div class="toggle-group">
                <label>وضعیت پنج‌شنبه‌ها:</label>
                <select id="thursdayMode" style="margin-bottom: 10px;">
                    <option value="work">روز کاری (آموزشی)</option>
                    <option value="off">تعطیل کامل</option>
                    <option value="odd_off">هفته‌های فرد تعطیل</option>
                    <option value="even_off">هفته‌های زوج تعطیل</option>
                </select>

                <div class="toggle-row">
                    <label for="chkFriday">جمعه‌ها تعطیل باشد</label>
                    <input type="checkbox" id="chkFriday" checked>
                </div>
                <div class="toggle-row">
                    <label for="chkOfficial">تعطیلات رسمی اعمال شود</label>
                    <input type="checkbox" id="chkOfficial" checked>
                </div>
            </div>

            <div class="toggle-group" style="margin-top: 10px; background: #E6FFEC; border-color: #b7ebc5;">
                <div class="toggle-row">
                    <label for="chkGregorian">نمایش تاریخ و مناسبت میلادی</label>
                    <input type="checkbox" id="chkGregorian">
                </div>
                <div class="toggle-row">
                    <label for="chkOccasions">نمایش سایر مناسبت‌های شمسی</label>
                    <input type="checkbox" id="chkOccasions" checked>
                </div>
            </div>
        </div>

        <!-- 3. بین التعطیلین -->
        <div class="section-box">
            <div class="sec-title"><i class="fas fa-link"></i> مدیریت بین‌التعطیلین</div>
            <button class="btn btn-outline" onclick="findGaps()">
                <i class="fas fa-search"></i> شناسایی فواصل (۱ تا ۳ روز)
            </button>
            <div id="gapResults" style="margin-top: 10px;"></div>
        </div>

        <!-- 4. رویداد دستی -->
        <div class="section-box">
            <div class="sec-title"><i class="fas fa-plus-circle"></i> افزودن دستی</div>
            <div class="form-row">
                <input type="text" id="evtStart" placeholder="شروع" style="flex:1; text-align:center;">
                <input type="text" id="evtEnd" placeholder="پایان" style="flex:1; text-align:center;">
            </div>
            <input type="text" id="evtDesc" placeholder="عنوان رویداد" style="margin-bottom: 10px;">
            <div class="form-row">
                <select id="evtType" style="flex:2;">
                    <option value="holiday">تعطیل</option>
                    <option value="exam">امتحان</option>
                    <option value="event">مناسبت</option>
                </select>
                <button class="btn btn-success" style="flex:1;" onclick="addEvent()">ثبت</button>
            </div>
            <div id="eventList" class="event-list"></div>
        </div>

        <!-- 5. خروجی -->
        <div>
            <button class="btn btn-primary" style="margin-bottom: 10px;" onclick="renderPreview()">
                <i class="fas fa-sync"></i> به‌روزرسانی جدول
            </button>
            <div class="form-row">
                <button class="btn btn-success" style="flex:1;" onclick="exportExcel()">
                    <i class="fas fa-file-excel"></i> اکسل
                </button>
                <button class="btn btn-danger" style="flex:1;" onclick="exportPDF()">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
            </div>
        </div>
    </aside>

    <!-- پنل نمایش -->
    <main class="main-panel">
        <div id="previewArea" class="table-container">
            <div style="text-align:center; padding:100px; color:#999;">
                <i class="fas fa-calendar-alt fa-4x" style="margin-bottom:20px;"></i>
                <h3>برای مشاهده تقویم، تنظیمات را انجام داده و دکمه "به‌روزرسانی" را بزنید.</h3>
            </div>
        </div>
    </main>
</div>

<!-- کانتینر PDF -->
<div id="pdfSource"></div>

<script>
    // ==========================================
    // 1. DATA SOURCES (تقویم کامل مناسبت‌ها)
    // ==========================================
    
    // مناسبت‌های شمسی (تعطیل و غیرتعطیل)
    const solarEvents = {
        "1-1": { t: "عید نوروز", h: true }, "1-2": { t: "عید نوروز", h: true },
        "1-3": { t: "عید نوروز", h: true }, "1-4": { t: "عید نوروز", h: true },
        "1-12": { t: "روز جمهوری اسلامی", h: true }, "1-13": { t: "روز طبیعت", h: true },
        "1-25": { t: "روز بزرگداشت عطار", h: false }, "1-29": { t: "روز ارتش", h: false },
        "2-1": { t: "روز بزرگداشت سعدی", h: false }, "2-10": { t: "روز ملی خلیج فارس", h: false },
        "2-12": { t: "روز معلم", h: false }, "2-25": { t: "روز بزرگداشت فردوسی", h: false },
        "3-3": { t: "فتح خرمشهر", h: false }, "3-14": { t: "رحلت امام خمینی", h: true },
        "3-15": { t: "قیام ۱۵ خرداد", h: true },
        "4-14": { t: "روز قلم", h: false },
        "5-17": { t: "روز خبرنگار", h: false }, "5-28": { t: "کودتای ۲۸ مرداد", h: false },
        "6-1": { t: "روز پزشک", h: false }, "6-5": { t: "روز داروساز", h: false },
        "7-8": { t: "روز بزرگداشت مولوی", h: false }, "7-20": { t: "روز بزرگداشت حافظ", h: false },
        "8-13": { t: "روز دانش‌آموز", h: false },
        "9-16": { t: "روز دانشجو", h: false }, "9-30": { t: "شب یلدا", h: false },
        "11-12": { t: "بازگشت امام خمینی", h: false }, "11-22": { t: "پیروزی انقلاب اسلامی", h: true },
        "12-5": { t: "روز مهندس", h: false }, "12-29": { t: "ملی شدن صنعت نفت", h: true }
    };

    // مناسبت‌های میلادی مهم
    const gregorianEvents = {
        "1-1": "آغاز سال نو میلادی",
        "2-14": "ولنتاین",
        "3-8": "روز جهانی زن",
        "5-1": "روز جهانی کارگر",
        "12-25": "کریسمس"
    };

    let customEvents = [];
    let gapSelection = []; // لیست روزهای بین‌التعطیلین انتخاب شده

    // ==========================================
    // 2. UTILS
    // ==========================================
    function parseDate(str) {
        if (!str) return null;
        const p = str.split('/').map(Number);
        return (p.length === 3) ? { y: p[0], m: p[1], d: p[2] } : null;
    }

    function jToG(y, m, d) {
        const g = jalaali.toGregorian(y, m, d);
        return new Date(g.gy, g.gm - 1, g.gd);
    }

    // Set Today
    window.onload = function() {
        const now = new Date();
        const j = jalaali.toJalaali(now);
        const fmt = n => n.toString().padStart(2, '0');
        document.getElementById('startDate').value = `${j.jy}/${fmt(j.jm)}/${fmt(j.jd)}`;
        let em = j.jm + 4; let ey = j.jy; if(em>12){em-=12; ey++;}
        document.getElementById('endDate').value = `${ey}/${fmt(em)}/${fmt(j.jd)}`;
    };

    // ==========================================
    // 3. LOGIC & GAPS
    // ==========================================

    function addEvent() {
        const sVal = document.getElementById('evtStart').value;
        const eVal = document.getElementById('evtEnd').value;
        const desc = document.getElementById('evtDesc').value;
        const type = document.getElementById('evtType').value;

        if(!sVal || !desc) return alert("لطفا تاریخ شروع و عنوان را وارد کنید");
        
        const s = parseDate(sVal);
        const e = eVal ? parseDate(eVal) : s;
        
        // Validation range
        const ms = parseDate(document.getElementById('startDate').value);
        const me = parseDate(document.getElementById('endDate').value);
        if(jToDate(s.y,s.m,s.d) < jToDate(ms.y,ms.m,ms.d) || jToDate(e.y,e.m,e.d) > jToDate(me.y,me.m,me.d)) 
            return alert("تاریخ خارج از محدوده تقویم است.");

        customEvents.push({ id: Date.now(), start: s, end: e, title: desc, type });
        renderCustomEvents();
        document.getElementById('evtDesc').value = '';
    }

    function renderCustomEvents() {
        const div = document.getElementById('eventList');
        div.innerHTML = '';
        customEvents.forEach(ev => {
            div.innerHTML += `
                <div class="event-item">
                    <span>${ev.title} (${ev.start.y}/${ev.start.m}/${ev.start.d})</span>
                    <i class="fas fa-trash" style="color:red; cursor:pointer;" onclick="removeEvent(${ev.id})"></i>
                </div>`;
        });
    }
    function removeEvent(id) { customEvents = customEvents.filter(x=>x.id!==id); renderCustomEvents(); }

    // --- GAP DETECTION ALGORITHM ---
    function findGaps() {
        // Run a simulation to find holiday status of every day
        const data = calculateCalendar(true); // Dry run
        if(!data) return;

        const gaps1 = [];
        const gaps2 = [];
        const gaps3 = [];

        for(let i=0; i < data.length; i++) {
            const curr = data[i];
            
            // اگر امروز کاری است
            if(!curr.isHoliday) {
                // چک کردن قبل
                const prev = i > 0 ? data[i-1] : { isHoliday: false };
                
                // Gap 1 Day (Holiday - Work - Holiday)
                const next1 = i+1 < data.length ? data[i+1] : { isHoliday: false };
                if (prev.isHoliday && next1.isHoliday) {
                    gaps1.push(curr);
                    continue;
                }

                // Gap 2 Days (Holiday - Work - Work - Holiday)
                const next2 = i+2 < data.length ? data[i+2] : { isHoliday: false };
                if (prev.isHoliday && !next1.isHoliday && next2.isHoliday) {
                    // This creates duplicate detection if we iterate simply.
                    // Let's identify the block start.
                    // Actually, simpler logic:
                    // If prev is holiday, look ahead.
                }
            }
        }

        // Better logic: Iterate days, if holiday found, look for next holiday
        let i = 0;
        while(i < data.length) {
            if(data[i].isHoliday) {
                // Start looking ahead
                let gapSize = 0;
                let j = i + 1;
                while(j < data.length && !data[j].isHoliday) {
                    gapSize++;
                    j++;
                }
                
                // Now data[j] is holiday or end of list
                if(j < data.length && gapSize > 0 && gapSize <= 3) {
                    // Found a gap
                    const gapDays = data.slice(i+1, j);
                    if(gapSize === 1) gaps1.push(gapDays);
                    if(gapSize === 2) gaps2.push(gapDays);
                    if(gapSize === 3) gaps3.push(gapDays);
                }
                i = j; // Jump
            } else {
                i++;
            }
        }

        renderGapUI(gaps1, gaps2, gaps3);
    }

    function renderGapUI(g1, g2, g3) {
        const div = document.getElementById('gapResults');
        div.innerHTML = '';

        const createGroup = (title, gaps, idPrefix) => {
            if(gaps.length === 0) return '';
            let html = `
                <div class="inter-group">
                    <div class="inter-header">
                        <span>${title} (${gaps.length} مورد)</span>
                        <label><input type="checkbox" onchange="toggleGapGroup(this, '${idPrefix}')"> انتخاب همه</label>
                    </div>
            `;
            gaps.forEach((group, idx) => {
                const dates = group.map(d => d.fullDate).join(' و ');
                const val = group.map(d => d.fullDate).join(','); // Comma sep for value
                html += `
                    <div class="inter-item">
                        <input type="checkbox" class="gap-check ${idPrefix}" value="${val}">
                        <span>${dates} (${group[0].dayName}...)</span>
                    </div>
                `;
            });
            html += `</div>`;
            return html;
        };

        div.innerHTML += createGroup('فاصله ۱ روزه', g1, 'g1');
        div.innerHTML += createGroup('فاصله ۲ روزه', g2, 'g2');
        div.innerHTML += createGroup('فاصله ۳ روزه', g3, 'g3');
        
        if(div.innerHTML === '') div.innerHTML = '<p style="color:green; font-size:0.9rem;">هیچ فاصله‌ای یافت نشد.</p>';
    }

    function toggleGapGroup(src, cls) {
        document.querySelectorAll(`.${cls}`).forEach(c => c.checked = src.checked);
    }

    // ==========================================
    // 4. MAIN ENGINE
    // ==========================================

    function calculateCalendar(isDryRun = false) {
        const sStr = document.getElementById('startDate').value;
        const eStr = document.getElementById('endDate').value;
        const s = parseDate(sStr);
        const e = parseDate(eStr);
        if(!s || !e) return null;

        // Settings
        const thMode = document.getElementById('thursdayMode').value;
        const friOff = document.getElementById('chkFriday').checked;
        const offOff = document.getElementById('chkOfficial').checked;
        const showGreg = document.getElementById('chkGregorian').checked;
        const showOcc = document.getElementById('chkOccasions').checked;

        // Collect selected gaps if not dry run
        const forceHolidays = new Set();
        if(!isDryRun) {
            document.querySelectorAll('.gap-check:checked').forEach(cb => {
                cb.value.split(',').forEach(d => forceHolidays.add(d));
            });
        }

        let result = [];
        let curr = jToDate(s.y, s.m, s.d);
        const end = jToDate(e.y, e.m, e.d);
        let session = 1;
        let weekIdx = 1;

        const weekNames = ['یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنج‌شنبه', 'جمعه', 'شنبه'];
        const monthNames = ['', 'فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور', 'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'];

        while(curr <= end) {
            const j = jalaali.toJalaali(curr);
            const wd = curr.getDay(); // 0..6
            const fullDate = `${j.jy}/${j.jm}/${j.jd}`;
            const key = `${j.jm}-${j.jd}`;
            
            // Gregorian Data
            const gM = curr.getMonth() + 1;
            const gD = curr.getDate();
            const gKey = `${gM}-${gD}`;
            
            let row = {
                dayName: weekNames[wd],
                fullDate: fullDate,
                monthName: monthNames[j.jm],
                gDate: showGreg ? `${curr.getFullYear()}/${gM}/${gD}` : '-',
                status: 'آموزشی',
                reason: '',
                session: '',
                isHoliday: false,
                css: ''
            };

            // 1. رویدادهای دستی
            for(let ev of customEvents) {
                const es = jToDate(ev.start.y, ev.start.m, ev.start.d);
                const ee = jToDate(ev.end.y, ev.end.m, ev.end.d);
                if(curr >= es && curr <= ee) {
                    row.reason = ev.title;
                    if(ev.type === 'holiday') { row.isHoliday = true; row.status = 'تعطیل'; row.css = 'row-holiday'; }
                    else if(ev.type === 'exam') { row.status = 'امتحان'; row.css = 'row-exam'; }
                    else { row.status = 'رویداد'; row.css = 'row-event'; }
                }
            }

            // 2. بین التعطیلین (اجباری)
            if(!row.isHoliday && forceHolidays.has(fullDate)) {
                row.isHoliday = true; row.status = 'تعطیل'; row.reason = 'بین‌التعطیلین'; row.css = 'row-inter';
            }

            // 3. جمعه
            if(!row.isHoliday && wd === 5 && friOff) {
                row.isHoliday = true; row.status = 'تعطیل'; row.reason = 'جمعه'; row.css = 'row-friday';
            }

            // 4. پنج‌شنبه
            if(!row.isHoliday && wd === 4) {
                if(thMode === 'off') { row.isHoliday = true; row.reason = 'تعطیل پنج‌شنبه'; row.css = 'row-holiday'; }
                else if(thMode === 'odd_off' && weekIdx % 2 !== 0) { row.isHoliday = true; row.reason = 'تعطیل پنج‌شنبه (فرد)'; row.css = 'row-holiday'; }
                else if(thMode === 'even_off' && weekIdx % 2 === 0) { row.isHoliday = true; row.reason = 'تعطیل پنج‌شنبه (زوج)'; row.css = 'row-holiday'; }
            }

            // 5. مناسبت‌های شمسی
            if(solarEvents[key]) {
                const evt = solarEvents[key];
                // افزودن متن اگر تیک مناسبت‌ها فعال است یا روز تعطیل رسمی است
                if(showOcc || evt.h) {
                    row.reason = row.reason ? row.reason + " - " + evt.t : evt.t;
                }
                // اعمال تعطیلی
                if(evt.h && offOff && !row.isHoliday) {
                    row.isHoliday = true; row.status = 'تعطیل'; row.css = 'row-holiday';
                }
            }

            // 6. مناسبت‌های میلادی
            if(showGreg && gregorianEvents[gKey]) {
                const gt = gregorianEvents[gKey];
                row.reason = row.reason ? row.reason + " | " + gt : gt;
            }

            // شمارش
            if(!row.isHoliday && row.status !== 'امتحان') row.session = session++;
            else row.session = '-';
            
            if(row.isHoliday) row.status = 'تعطیل';

            result.push(row);
            if(wd === 5) weekIdx++;
            curr.setDate(curr.getDate() + 1);
        }
        return result;
    }

    // ==========================================
    // 5. OUTPUTS
    // ==========================================

    function renderPreview() {
        const data = calculateCalendar();
        if(!data) return alert("خطا در محاسبه تقویم");

        const showGreg = document.getElementById('chkGregorian').checked;
        const title = document.getElementById('calTitle').value;
        const sub = document.getElementById('calSub').value;

        let html = `
            <div style="text-align:center; margin-bottom:20px;">
                <h2 style="color:var(--primary);">${title}</h2>
                <h4 style="color:#666;">${sub}</h4>
            </div>
            <table>
                <thead>
                    <tr>
                        <th width="5%">#</th>
                        <th width="10%">روز</th>
                        <th width="12%">تاریخ شمسی</th>
                        ${showGreg ? '<th width="12%">تاریخ میلادی</th>' : ''}
                        <th width="10%">وضعیت</th>
                        <th>شرح رویداد / مناسبت</th>
                        <th width="8%">جلسه</th>
                    </tr>
                </thead>
                <tbody>
        `;

        data.forEach((r, i) => {
            html += `
                <tr class="${r.css}">
                    <td>${i + 1}</td>
                    <td>${r.dayName}</td>
                    <td dir="ltr">${r.fullDate}</td>
                    ${showGreg ? `<td dir="ltr">${r.gDate}</td>` : ''}
                    <td><strong>${r.status}</strong></td>
                    <td style="text-align:right;">${r.reason}</td>
                    <td><strong>${r.session}</strong></td>
                </tr>
            `;
        });
        html += '</tbody></table>';
        
        document.getElementById('previewArea').innerHTML = html;
        document.getElementById('pdfSource').innerHTML = html;
    }

    async function exportExcel() {
        const data = calculateCalendar();
        if(!data) return;
        const showGreg = document.getElementById('chkGregorian').checked;

        const wb = new ExcelJS.Workbook();
        const ws = wb.addWorksheet('تقویم', {views: [{rightToLeft: true}]});

        // هدر
        ws.mergeCells(showGreg ? 'A1:H1' : 'A1:G1');
        const t = ws.getCell('A1');
        t.value = document.getElementById('calTitle').value;
        t.font = { name: 'Tahoma', size: 16, bold: true, color: { argb: 'FFFFFFFF' } };
        t.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF0078D4' } };
        t.alignment = { horizontal: 'center', vertical: 'middle' };

        ws.mergeCells(showGreg ? 'A2:H2' : 'A2:G2');
        const s = ws.getCell('A2');
        s.value = document.getElementById('calSub').value;
        s.alignment = { horizontal: 'center' };

        // ستون‌ها
        const cols = [
            { key: 'idx', width: 8, header: 'ردیف' },
            { key: 'day', width: 15, header: 'روز' },
            { key: 'date', width: 15, header: 'تاریخ شمسی' }
        ];
        if(showGreg) cols.push({ key: 'gdate', width: 15, header: 'تاریخ میلادی' });
        cols.push(
            { key: 'status', width: 15, header: 'وضعیت' },
            { key: 'reason', width: 50, header: 'شرح' },
            { key: 'count', width: 10, header: 'جلسه' }
        );
        ws.columns = cols;

        // استایل هدر جدول (ردیف 3 چون 1 و 2 عنوان بود)
        // اما چون هدر خودکار اضافه نمیشه باید دستی تنظیم کنیم یا از هدر دیفالت استفاده نکنیم
        // بیایید هدر جدول را دستی در ردیف 4 بگذاریم
        const headerRow = ws.getRow(4);
        headerRow.values = cols.map(c => c.header);
        headerRow.eachCell(c => {
            c.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF005A9E' } };
            c.font = { name: 'Tahoma', bold: true, color: { argb: 'FFFFFFFF' } };
            c.alignment = { horizontal: 'center' };
        });

        // داده‌ها
        data.forEach((d, i) => {
            const rowData = [i+1, d.dayName, d.fullDate];
            if(showGreg) rowData.push(d.gDate);
            rowData.push(d.status, d.reason, d.session);
            
            const r = ws.addRow(rowData);
            
            let bg = 'FFFFFFFF';
            if(d.css === 'row-holiday') bg = 'FFFEE2E2';
            else if(d.css === 'row-friday') bg = 'FFFCE7F3';
            else if(d.css === 'row-inter') bg = 'FFFFF7ED';
            else if(d.css === 'row-exam') bg = 'FFEFF6FF';
            else if(d.css === 'row-event') bg = 'FFF0FDF4';

            r.eachCell(c => {
                c.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: bg } };
                c.border = { top:{style:'thin'}, left:{style:'thin'}, bottom:{style:'thin'}, right:{style:'thin'} };
                c.font = { name: 'Tahoma' };
                c.alignment = { horizontal: 'center', vertical: 'middle' };
            });
        });

        const buf = await wb.xlsx.writeBuffer();
        saveAs(new Blob([buf]), 'Calendar.xlsx');
    }

    function exportPDF() {
        const el = document.getElementById('pdfSource');
        if(!el.innerHTML) renderPreview();
        el.style.display = 'block';
        html2pdf().set({
            margin: 0.2,
            filename: 'Calendar.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        }).from(el).save().then(() => el.style.display = 'none');
    }
</script>

</body>
</html>
