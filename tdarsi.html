 
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <!-- دستور اول: اجبار به حالت دسکتاپ (عرض ثابت) -->
    <meta name="viewport" content="width=1280">
    <title>سامانه جامع تقویم آموزشی | نسخه سازمانی</title>
    
    <!-- استایل‌ها -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    
    <!-- کتابخانه‌های هسته -->
    <script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary: #2563eb; --primary-dark: #1e40af;
            --bg-app: #f1f5f9; --surface: #ffffff;
            --text-main: #1f2937; --text-sub: #64748b;
            --border: #e2e8f0; --radius: 8px;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Vazirmatn', sans-serif; }

        body { background-color: var(--bg-app); color: var(--text-main); min-width: 1280px; overflow-x: auto; padding-bottom: 100px; }

        .app-header { background: #fff; padding: 15px 30px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 30px; }

        .main-layout {
            max-width: 1600px; margin: 0 auto;
            display: grid; grid-template-columns: 400px 1fr; gap: 30px; padding: 0 30px;
        }

        /* پنل تنظیمات */
        .settings-panel {
            background: var(--surface); padding: 25px; border-radius: var(--radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid var(--border);
            height: fit-content; position: sticky; top: 20px; z-index: 10;
        }

        .section-box { border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-bottom: 20px; background: #f8fafc; }

        .section-title { font-weight: 800; color: var(--primary-dark); font-size: 1rem; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }

        /* فرم‌ها */
        .form-label { font-size: 0.85rem; font-weight: 700; color: #4b5563; margin-bottom: 5px; }
        .form-input, .form-select { font-size: 0.9rem; padding: 8px 12px; border-radius: 6px; }
        .form-check-label { font-size: 0.9rem; cursor: pointer; }

        /* پنل پیش‌نمایش */
        .preview-panel {
            background: var(--surface); padding: 25px; border-radius: var(--radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); min-height: 80vh; overflow-x: auto;
        }

        /* جدول */
        .calendar-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .calendar-table th { background: var(--primary); color: white; padding: 10px; text-align: center; white-space: nowrap; }
        .calendar-table td { border: 1px solid #d1d5db; padding: 6px 10px; text-align: center; vertical-align: middle; }
        
        /* رنگ‌بندی ردیف‌ها */
        .row-holiday { background: #fee2e2; color: #991b1b; font-weight: bold; }
        .row-friday { background: #fce7f3; color: #831843; }
        .row-inter { background: #fff7ed; color: #9a3412; }
        .row-exam { background: #eff6ff; color: #1e40af; }
        .row-event { background: #ecfccb; color: #365314; }

        /* لیست رویدادها */
        .event-list { max-height: 200px; overflow-y: auto; background: #fff; border: 1px solid #e5e7eb; padding: 5px; border-radius: 8px; }
        .event-item { padding: 5px 0; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; }

        /* لیست بین‌التعطیلین */
        .gaps-container { max-height: 300px; overflow-y: auto; }
        .gap-group { margin-bottom: 15px; border: 1px solid #cbd5e1; padding: 10px; border-radius: 6px; background: white; }
        .gap-header { font-weight: bold; color: var(--primary); margin-bottom: 5px; display: flex; justify-content: space-between; }
        .gap-item { display: flex; align-items: center; gap: 8px; padding: 3px 0; font-size: 0.85rem; }
        
        /* کانتینر مخفی PDF */
        #pdfSource { padding: 20px; background: white; display: none; width: 100%; }
    </style>
</head>
<body>

<header class="app-header">
    <div style="display:flex; align-items:center; gap:15px;">
        <i class="fas fa-calendar-check fa-2x text-primary"></i>
        <div>
            <h4 style="margin:0; font-weight:900;">تقویم‌ساز آموزشی پیشرفته</h4>
            <span style="font-size:0.8rem; color:#666;">نسخه سازمانی | تاریخ شمسی و میلادی</span>
        </div>
    </div>
    <div>
        <button class="btn btn-outline-primary btn-sm" onclick="window.print()"><i class="fas fa-print"></i> چاپ صفحه</button>
    </div>
</header>

<div class="main-layout">
    
    <!-- ستون تنظیمات -->
    <aside class="sidebar">
        
        <!-- 1. بازه و مشخصات -->
        <div class="section-box">
            <div class="section-title"><i class="fas fa-info-circle"></i> ۱. مشخصات تقویم</div>
            <div class="mb-2">
                <label class="form-label">عنوان اصلی</label>
                <input type="text" id="calTitle" class="form-control" value="تقویم آموزشی نیمسال اول">
            </div>
            <div class="row g-2 mb-2">
                <div class="col-6"><label class="form-label">شروع (Y/M/D)</label><input type="text" id="startDate" class="form-control text-center" placeholder="1403/07/01"></div>
                <div class="col-6"><label class="form-label">پایان (Y/M/D)</label><input type="text" id="endDate" class="form-control text-center" placeholder="1403/10/30"></div>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="showGregorian">
                <label class="form-check-label" for="showGregorian">نمایش ستون تاریخ میلادی</label>
            </div>
        </div>

        <!-- 2. قوانین تعطیلات -->
        <div class="section-box">
            <div class="section-title"><i class="fas fa-ban"></i> ۲. قوانین تعطیلات</div>
            <div class="checkbox-group">
                <label class="form-label" style="font-weight:900; color:red;">تعیین تعطیلی</label>
                <label class="checkbox-item"><input type="checkbox" id="chkFriday" checked> جمعه‌ها تعطیل باشد</label>
                <label class="checkbox-item"><input type="checkbox" id="chkOfficial" checked> تعطیلات رسمی (تقویم) اعمال شود</label>
                
                <label class="form-label" style="margin-top:10px;">وضعیت پنج‌شنبه‌ها:</label>
                <select id="thursdayMode" class="form-select form-select-sm">
                    <option value="work">روز کاری</option>
                    <option value="off">کاملاً تعطیل</option>
                    <option value="odd_off">هفته‌های فرد تعطیل</option>
                    <option value="even_off">هفته‌های زوج تعطیل</option>
                </select>
            </div>
        </div>

        <!-- 3. مناسبت‌های ملی و مذهبی (غیر تعطیل) -->
        <div class="section-box">
            <div class="section-title"><i class="fas fa-flag"></i> ۳. مناسبت‌های تقویم</div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="chkShowOccasions" checked>
                <label class="form-check-label" for="chkShowOccasions">درج مناسبت‌ها در تقویم</label>
            </div>
            <p class="text-muted" style="font-size:0.75rem; margin-top:5px;">(رویدادهای ملی، مذهبی و جهانی)</p>
        </div>

        <!-- 4. بین‌التعطیلین هوشمند -->
        <div class="section-box">
            <div class="section-title"><i class="fas fa-random"></i> ۴. مدیریت بین‌التعطیلین</div>
            <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="chkInterOff">
                <label class="form-check-label" for="chkInterOff">روزهای بین‌التعطیلین را تعطیل کن</label>
            </div>
            <button class="btn btn-warning w-100 btn-sm mb-3" onclick="analyzeGaps()">
                <i class="fas fa-search"></i> جستجوی فواصل کاری
            </button>
            <div id="gapsContainer" class="gaps-container">
                <!-- لیست فواصل اینجا می‌آید -->
            </div>
        </div>

        <!-- 5. رویداد دستی -->
        <div class="section-box">
            <div class="section-title"><i class="fas fa-plus-circle"></i> ۵. رویداد دستی</div>
            <div class="input-group input-group-sm mb-2">
                <input type="text" id="evtStart" class="form-control" placeholder="شروع (1403/08/10)">
                <input type="text" id="evtEnd" class="form-control" placeholder="تا (اختیاری)">
            </div>
            <input type="text" id="evtDesc" class="form-control form-control-sm mb-2" placeholder="عنوان رویداد">
            <div class="d-flex gap-2">
                <select id="evtType" class="form-select form-select-sm">
                    <option value="holiday">تعطیل اضطراری</option>
                    <option value="exam">امتحان</option>
                    <option value="event">مراسم/رویداد</option>
                </select>
                <button class="btn btn-success btn-sm" onclick="addEvent()">افزودن</button>
            </div>
            <div id="customEventList" class="event-list mt-2"></div>
        </div>

        <!-- دکمه‌های خروجی -->
        <button class="btn btn-primary btn-action" onclick="renderTable()">
            <i class="fas fa-sync"></i> به‌روزرسانی جدول
        </button>
        <div class="d-flex gap-2">
            <button class="btn btn-success btn-action" onclick="exportExcel()">
                <i class="fas fa-file-excel"></i> اکسل
            </button>
            <button class="btn btn-danger btn-action" onclick="exportPDF()">
                <i class="fas fa-file-pdf"></i> PDF
            </button>
        </div>

    </aside>

    <!-- ستون پیش‌نمایش -->
    <main>
        <div class="preview-panel">
            <div id="previewArea" class="preview-wrapper">
                <div class="text-center text-muted" style="padding-top: 200px;">
                    <i class="fas fa-table fa-4x mb-3"></i>
                    <h4>برای تولید تقویم، تنظیمات را انجام داده و دکمه به‌روزرسانی را بزنید.</h4>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- کانتینر مخفی PDF -->
<div id="pdfSource"></div>

<script>
    // ===========================================
    // 1. DATABASE & CONFIG
    // ===========================================
    
    const officialHolidays = {
        "1-1": "عید نوروز", "1-2": "عید نوروز", "1-3": "عید نوروز", "1-4": "عید نوروز",
        "1-12": "روز جمهوری اسلامی", "1-13": "روز طبیعت",
        "3-14": "رحلت امام خمینی", "3-15": "قیام ۱۵ خرداد",
        "11-22": "پیروزی انقلاب اسلامی", "12-29": "ملی شدن صنعت نفت"
    };

    const nationalOccasions = [
        { d: "1-25", t: "روز بزرگداشت عطار" }, { d: "2-1", t: "روز بزرگداشت سعدی" }, 
        { d: "2-10", t: "روز ملی خلیج فارس" }, { d: "2-12", t: "روز معلم" },
        { d: "2-25", t: "روز بزرگداشت فردوسی" }, { d: "3-1", t: "روز بزرگداشت ملاصدرا" }, 
        { d: "5-17", t: "روز خبرنگار" }, { d: "6-1", t: "روز پزشک" },
        { d: "6-5", t: "روز داروسازی" }, { d: "7-8", t: "روز بزرگداشت مولوی" }, 
        { d: "7-20", t: "روز بزرگداشت حافظ" }, { d: "8-13", t: "روز دانش‌آموز" },
        { d: "9-16", t: "روز دانشجو" }, { d: "9-27", t: "وحدت حوزه و دانشگاه" },
        { d: "10-5", t: "روز ایمنی در برابر زلزله" }, { d: "11-12", t: "آغاز دهه فجر" },
        { d: "12-5", t: "روز مهندس" }
    ];

    const gregorianEvents = {
        "1-1": "سال نو میلادی", "12-25": "کریسمس"
    };

    let customEvents = [];
    let interHolidays = [];
    let selectedGaps = new Set();
    let currentCalculatedDays = null;

    // --- توابع کمکی تاریخ ---
    function parseDate(str) {
        if(!str) return null;
        const p = str.split('/').map(Number);
        if(p.length !== 3 || isNaN(p[0])) return null;
        return { y: p[0], m: p[1], d: p[2] };
    }

    function jToDate(y, m, d) {
        try {
            const g = jalaali.toGregorian(y, m, d);
            return new Date(g.gy, g.gm - 1, g.gd);
        } catch {
            return new Date(NaN);
        }
    }

    // --- 2. مدیریت رویدادها ---
    function addEvent() {
        const sVal = document.getElementById('evtStart').value;
        const eVal = document.getElementById('evtEnd').value;
        const desc = document.getElementById('evtDesc').value;
        const type = document.getElementById('evtType').value;

        if(!sVal || !desc) return alert("تاریخ شروع و عنوان الزامی است.");
        const s = parseDate(sVal);
        const e = eVal ? parseDate(eVal) : s;

        if(!s || !e) return alert("فرمت تاریخ صحیح نیست.");

        // اعتبارسنجی بازه
        const ms = parseDate(document.getElementById('startDate').value);
        const me = parseDate(document.getElementById('endDate').value);
        
        const gEvtStart = jToDate(s.y, s.m, s.d);
        const gCalStart = jToDate(ms.y, ms.m, ms.d);
        const gCalEnd = jToDate(me.y, me.m, me.d);

        if (gEvtStart < gCalStart || gEvtStart > gCalEnd) {
            return alert("تاریخ رویداد باید در بازه زمانی تقویم باشد.");
        }

        customEvents.push({ id: Date.now(), s, e, title: desc, type });
        renderCustomEvents();
        document.getElementById('evtDesc').value = '';
    }

    function removeEvent(id) {
        customEvents = customEvents.filter(x => x.id !== id);
        renderCustomEvents();
    }

    function renderCustomEvents() {
        const div = document.getElementById('customEventList');
        div.innerHTML = '';
        customEvents.forEach(ev => {
            let badge = ev.type === 'holiday' ? 'bg-danger' : (ev.type==='exam' ? 'bg-primary' : 'bg-warning text-dark');
            let typeName = ev.type === 'holiday' ? 'تعطیل' : (ev.type === 'exam' ? 'امتحان' : 'رویداد');
            
            div.innerHTML += `
                <div class="event-item">
                    <div>
                        <span class="badge ${badge}">${typeName}</span>
                        <strong>${ev.s.y}/${ev.s.m}/${ev.s.d}</strong> : ${ev.title}
                    </div>
                    <i class="fas fa-times" style="cursor:pointer; color:red" onclick="removeEvent(${ev.id})"></i>
                </div>
            `;
        });
    }

    // --- 3. مدیریت بین‌التعطیلین (اصلاح شده برای تشخیص فواصل) ---
    function analyzeGaps() {
        const fullData = calculateCalendar(true);
        if(!fullData) return;

        let gaps = { 1: [], 2: [], 3: [] };
        
        // Logical Pass 1: Identify all holiday status changes
        for(let i=0; i<fullData.length; i++) {
            const curr = fullData[i];
            
            // اگر امروز روز کاری باشد
            if(!curr.isHoliday) {
                let startGap = i;
                let endGap = i;
                let gapLength = 1;

                // اگر قبلش تعطیل بود، یک فاصله پیدا کرده‌ایم
                if (i > 0 && fullData[i-1].isHoliday) {
                    // شمارش تا روزی که دوباره تعطیل شود
                    for(let j=i+1; j < Math.min(i + 4, fullData.length); j++) {
                        if(fullData[j].isHoliday) {
                            endGap = j - 1;
                            gapLength = endGap - startGap + 1;
                            break;
                        }
                    }
                    
                    // اگر فاصله بین تعطیلی‌ها بود (1 تا 3 روزه)
                    if (gapLength > 0 && gapLength <= 3 && endGap < fullData.length && fullData[endGap+1].isHoliday) {
                        const gapDates = [];
                        for(let k=startGap; k<=endGap; k++) {
                            gapDates.push(fullData[k].fullDate);
                        }
                        gaps[gapLength].push({
                            dates: gapDates,
                            label: `${fullData[startGap].fullDate} تا ${fullData[endGap].fullDate}`
                        });
                        i = endGap; // پرش به انتهای این فاصله
                    }
                }
            }
        }
        
        // Remove old list and display new one
        const container = document.getElementById('gapsContainer');
        container.innerHTML = '';
        document.getElementById('interHolidayList').style.display = 'block';
        
        renderGapGroupUI(container, 1, "یک روزه", gaps[1]);
        renderGapGroupUI(container, 2, "دو روزه", gaps[2]);
        renderGapGroupUI(container, 3, "سه روزه", gaps[3]);

        if(gaps[1].length === 0 && gaps[2].length === 0 && gaps[3].length === 0) {
            container.innerHTML = `<div class="alert alert-success">هیچ فاصله کاری (بین‌التعطیلین) یافت نشد.</div>`;
        }
    }

    function renderGapGroupUI(container, days, label, gapData) {
        if(gapData.length === 0) return;
        
        let html = `
            <div class="gap-group">
                <div class="gap-header">
                    <span>${label} (${days} روز) - ${gapData.length} مورد</span>
                    <label style="font-size:0.8rem"><input type="checkbox" onchange="toggleGapGroup(this, 'gap-${days}')"> انتخاب همه</label>
                </div>
                <div class="scrollable-list">
        `;
        
        gapData.forEach((gap, idx) => {
            const allDates = gap.dates.join(' و ');
            html += `
                <div class="gap-item">
                    <input type="checkbox" class="form-check-input gap-check gap-${days}" value="${gap.dates.join(',')}" id="gap_${days}_${idx}">
                    <label class="form-check-label" for="gap_${days}_${idx}">${allDates}</label>
                </div>
            `;
        });
        html += `</div></div>`;
        container.innerHTML += html;
    }

    function toggleGapGroup(source, className) {
        document.querySelectorAll('.' + className).forEach(ch => ch.checked = source.checked);
    }

    // ===========================================
    // 5. MAIN ENGINE
    // ===========================================

    function calculateCalendar(isDryRun = false) {
        const sStr = document.getElementById('startDate').value;
        const eStr = document.getElementById('endDate').value;
        const s = parseDate(sStr);
        const e = parseDate(eStr);
        
        if(!s || !e) return null;

        const startG = jToDate(s.y, s.m, s.d);
        const endG = jToDate(e.y, e.m, e.d);

        if(endG < startG || isNaN(startG) || isNaN(endG)) return null; // اعتبارسنجی نهایی تاریخ

        const thMode = document.getElementById('thursdayMode').value;
        const friOff = document.getElementById('chkFriday').checked;
        const offOff = document.getElementById('chkOfficial').checked;
        const showGreg = document.getElementById('showGregorian').checked;
        const showOcc = document.getElementById('chkShowOccasions').checked;
        const interOff = document.getElementById('chkInterOff').checked;

        // لیست بین‌التعطیلین‌های انتخاب شده
        const selectedGaps = new Set();
        if(!isDryRun && interOff) {
            document.querySelectorAll('.gap-check:checked').forEach(c => {
                c.value.split(',').forEach(d => selectedGaps.add(d));
            });
        }

        let result = [];
        let curr = new Date(startG);
        let session = 1;
        let weekIdx = 1;

        const weekNames = ['یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنج‌شنبه', 'جمعه', 'شنبه'];
        const monthNames = ['', 'فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور', 'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'];

        while(curr <= endG) {
            const j = jalaali.toJalaali(curr);
            const wd = curr.getDay(); 
            const dateKey = `${j.jm}-${j.jd}`;
            const fullDate = `${j.jy}/${j.jm}/${j.jd}`;
            
            const gM = curr.getMonth() + 1;
            const gD = curr.getDate();
            const gKey = `${gM}-${gD}`;
            const gDateStr = `${curr.getFullYear()}/${gM}/${gD}`;

            let row = {
                idx: 0, dayName: weekNames[wd], fullDate: fullDate, gDate: gDateStr,
                monthName: monthNames[j.jm], status: 'آموزشی', reason: '',
                session: '', isHoliday: false, css: ''
            };

            // --- تعیین وضعیت تعطیلی (Logic of Priority) ---
            
            // 1. Custom Events (User defined range holidays/exams)
            for(let ev of customEvents) {
                const es = jToDate(ev.start.y, ev.start.m, ev.start.d);
                const ee = jToDate(ev.end.y, ev.end.m, ev.end.d);
                if(curr >= es && curr <= ee) {
                    row.reason = ev.title;
                    if(ev.type === 'holiday') { row.isHoliday = true; row.status = 'تعطیل'; row.css = 'row-holiday'; }
                    else if(ev.type === 'exam') { row.status = 'امتحان'; row.css = 'row-exam'; }
                    else { row.status = 'رویداد'; row.css = 'row-event'; }
                }
            }

            // 2. Weekends (Only if not already a custom holiday)
            if(!row.isHoliday) {
                if(wd === 5 && friOff) { row.isHoliday = true; row.reason = 'جمعه'; row.css = 'row-friday'; }
                else if(wd === 4) {
                    if(thMode === 'off') { row.isHoliday = true; row.reason = 'تعطیل پنج‌شنبه'; row.css = 'row-holiday'; }
                    else if(thMode === 'odd_off' && weekIdx % 2 !== 0) { row.isHoliday = true; row.reason = 'تعطیل هفته فرد'; row.css = 'row-holiday'; }
                    else if(thMode === 'even_off' && weekIdx % 2 === 0) { row.isHoliday = true; row.reason = 'تعطیل هفته زوج'; row.css = 'row-holiday'; }
                }
            }
            
            // 3. Inter-holidays (Only if explicitly selected AND not already custom event)
            if(!row.isHoliday && selectedGaps.has(fullDate)) {
                row.isHoliday = true; row.status = 'تعطیل'; row.reason = 'بین‌التعطیلین'; row.css = 'row-inter';
            }

            // 4. Official/Fixed Holidays
            if(officialHolidays[dateKey]) {
                const hName = officialHolidays[dateKey];
                row.reason = row.reason ? row.reason + " - " + hName : hName;
                if(offOff && !row.isHoliday) {
                    row.isHoliday = true; row.status = 'تعطیل'; row.css = 'row-holiday';
                }
            }
            
            // 5. Gregorian Events
            if(gregorianEvents[gKey]) {
                row.reason = row.reason ? row.reason + ` (${gregorianEvents[gKey]})` : gregorianEvents[gKey];
            }

            // 6. Non-holiday Occasions
            if(showOcc) {
                const occ = nationalOccasions.find(o => o.d === dateKey);
                if(occ) {
                    row.reason = row.reason ? row.reason + " - " + occ.t : occ.t;
                    if(!row.isHoliday && row.status === 'آموزشی') row.css = 'row-event'; // رویداد غیر تعطیل
                }
            }


            // Session Logic
            if(!row.isHoliday && row.status !== 'امتحان') {
                row.session = session++;
            } else {
                row.session = '-';
            }
            if(row.isHoliday) row.status = 'تعطیل';

            result.push(row);

            if(wd === 5) weekIdx++;
            curr.setDate(curr.getDate() + 1);
        }

        currentCalculatedDays = result;
        return result;
    }

    // ===========================================
    // 6. RENDER & EXPORT
    // ===========================================

    function renderTable() {
        const data = calculateCalendar();
        if(!data) { alert("تاریخ‌ها نامعتبر یا بازه زمانی نامناسب است."); return; }

        const title = document.getElementById('calTitle').value;
        const sub = document.getElementById('calSub').value;
        const showGreg = document.getElementById('showGregorian').checked;

        let html = `
            <div style="text-align:center; margin-bottom:20px;">
                <h2 style="color:#1e40af; margin:0;">${title}</h2>
                <h4 style="color:#64748b; margin:5px 0;">${sub}</h4>
            </div>
            <div class="table-responsive">
            <table class="calendar-table">
                <thead>
                    <tr>
                        <th width="5%">#</th>
                        <th width="10%">روز</th>
                        <th width="12%">تاریخ شمسی</th>
                        ${showGreg ? '<th width="12%">تاریخ میلادی</th>' : ''}
                        <th width="10%">وضعیت</th>
                        <th width="40%">توضیحات / مناسبت</th>
                        <th width="10%">جلسه</th>
                    </tr>
                </thead>
                <tbody>
        `;

        data.forEach((r, i) => {
            html += `
                <tr class="${r.css}">
                    <td>${i + 1}</td>
                    <td>${r.dayName}</td>
                    <td dir="ltr">${r.fullDate}</td>
                    ${showGreg ? `<td dir="ltr">${r.gDate}</td>` : ''}
                    <td><strong>${r.status}</strong></td>
                    <td style="text-align:right">${r.reason}</td>
                    <td><strong>${r.session}</strong></td>
                </tr>
            `;
        });
        html += `</tbody></table></div>`;

        document.getElementById('previewArea').innerHTML = html;
        document.getElementById('pdfSource').innerHTML = html;
    }

    async function exportExcel() {
        const data = calculateCalendar();
        if(!data) return;

        const wb = new ExcelJS.Workbook();
        const ws = wb.addWorksheet('تقویم', {views: [{rightToLeft: true}]});
        const showGreg = document.getElementById('showGregorian').checked;

        // هدر
        const headerCols = showGreg ? 7 : 6; // تعداد ستون
        const mergeRange = `A1:${String.fromCharCode(65 + headerCols - 1)}1`;

        ws.mergeCells(mergeRange);
        const t = ws.getCell('A1');
        t.value = document.getElementById('calTitle').value;
        t.font = { name: 'Tahoma', size: 16, bold: true, color: { argb: 'FFFFFFFF' } };
        t.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E40AF' } };
        t.alignment = { horizontal: 'center', vertical: 'middle' };

        ws.mergeCells('A2:' + mergeRange.slice(2));
        const s = ws.getCell('A2');
        s.value = document.getElementById('calSub').value;
        s.font = { name: 'Tahoma', size: 12, bold: true };
        s.alignment = { horizontal: 'center', vertical: 'middle' };

        // سرستون
        const headers = ['ردیف', 'روز', 'تاریخ شمسی'];
        if(showGreg) headers.push('تاریخ میلادی');
        headers.push('وضعیت', 'توضیحات', 'جلسه');
        
        const hRow = ws.getRow(4);
        hRow.values = headers;
        hRow.eachCell(cell => {
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2563EB' } };
            cell.font = { name: 'Tahoma', size: 11, bold: true, color: { argb: 'FFFFFFFF' } };
            cell.alignment = { horizontal: 'center', vertical: 'middle' };
            cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
        });

        // داده‌ها
        data.forEach((d, i) => {
            const vals = [i+1, d.dayName, d.fullDate];
            if(showGreg) vals.push(d.gDate);
            vals.push(d.status, d.reason, d.session);

            const r = ws.addRow(vals);
            
            let bg = 'FFFFFFFF';
            if(d.css === 'row-holiday' || d.css === 'row-inter') bg = 'FFFEE2E2';
            if(d.css === 'row-friday') bg = 'FFFCE7F3';
            if(d.css === 'row-exam') bg = 'FFEFF6FF';
            if(d.css === 'row-event') bg = 'FFECFCCB';

            r.eachCell(c => {
                c.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: bg } };
                c.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
                c.alignment = { horizontal: 'center', vertical: 'middle' };
                c.font = { name: 'Tahoma' };
            });
        });

        // عرض ستون‌ها
        ws.columns = [ {width:6}, {width:12}, {width:15}, ...(showGreg ? [{width:15}] : []), {width:15}, {width:50}, {width:8} ];

        const buffer = await wb.xlsx.writeBuffer();
        saveAs(new Blob([buffer]), 'Calendar.xlsx');
    }

    function downloadPDF() {
        const el = document.getElementById('pdfSource');
        if(!el.innerHTML) renderPreview();
        el.style.display = 'block';
        
        html2pdf().set({
            margin: [0.5, 0.5],
            filename: 'Calendar.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        }).from(el).save().then(() => el.style.display = 'none');
    }

</script>
</body>
</html>
