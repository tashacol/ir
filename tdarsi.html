 
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تقویم ساز آموزشی حرفه‌ای</title>
    
    <!-- استایل‌ها -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    
    <!-- کتابخانه‌های هسته (پایدار) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- کتابخانه تبدیل تاریخ (برای دقت ۱۰۰٪) -->
    <script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --surface: #ffffff;
            --bg: #f1f5f9;
        }
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--bg); padding-bottom: 50px; }
        
        .main-wrapper {
            max-width: 1400px; margin: 20px auto; display: grid; 
            grid-template-columns: 400px 1fr; gap: 20px; padding: 0 20px;
        }
        
        .panel { background: var(--surface); padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .sticky-panel { position: sticky; top: 20px; height: fit-content; max-height: 95vh; overflow-y: auto; }
        
        h4 { font-weight: 900; color: var(--primary); margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        /* Table Styles */
        .preview-box { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: var(--primary); color: white; padding: 10px; text-align: center; white-space: nowrap; }
        td { border: 1px solid #ddd; padding: 8px; text-align: center; vertical-align: middle; }
        
        .holiday-row { background: #fee2e2; color: #991b1b; } /* قرمز */
        .friday-row { background: #fce7f3; color: #831843; } /* صورتی */
        .exam-row { background: #eff6ff; color: #1e40af; } /* آبی */
        .event-row { background: #fef3c7; color: #92400e; } /* زرد */
        
        /* Event List */
        .event-item { 
            background: #f8fafc; border: 1px solid #e2e8f0; padding: 8px; 
            border-radius: 6px; margin-bottom: 5px; font-size: 0.85rem; 
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .btn-action { width: 100%; margin-bottom: 10px; font-weight: 700; padding: 10px; }
        
        @media (max-width: 992px) { .main-wrapper { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="main-wrapper">
    
    <!-- پنل تنظیمات -->
    <aside class="panel sticky-panel">
        <h4><i class="fas fa-sliders-h"></i> تنظیمات تقویم</h4>
        
        <div class="mb-3">
            <label class="form-label">عنوان اصلی</label>
            <input type="text" id="headerTitle" class="form-control" value="تقویم آموزشی">
        </div>
        
        <div class="row g-2 mb-3">
            <div class="col-6">
                <label class="form-label">تاریخ شروع</label>
                <input type="text" id="startDate" class="form-control text-center" placeholder="1403/01/01">
            </div>
            <div class="col-6">
                <label class="form-label">تاریخ پایان</label>
                <input type="text" id="endDate" class="form-control text-center" placeholder="1403/04/01">
            </div>
        </div>
        
        <div class="mb-3">
            <label class="form-label">قانون پنج‌شنبه‌ها</label>
            <select id="thursdayMode" class="form-select">
                <option value="work">روز کاری</option>
                <option value="off">تعطیل کامل</option>
                <option value="odd">هفته‌های فرد تعطیل</option>
            </select>
        </div>

        <hr>
        <h6 class="fw-bold mb-3">مدیریت رویدادها</h6>
        <div class="bg-light p-3 rounded border mb-3">
            <div class="mb-2">
                <select id="eventType" class="form-select form-select-sm">
                    <option value="holiday">تعطیل</option>
                    <option value="exam">امتحان</option>
                    <option value="event">رویداد/مراسم</option>
                </select>
            </div>
            <div class="row g-2 mb-2">
                <div class="col-6"><input type="text" id="evtStart" class="form-control form-control-sm text-center" placeholder="از: 1403/02/01"></div>
                <div class="col-6"><input type="text" id="evtEnd" class="form-control form-control-sm text-center" placeholder="تا: 1403/02/01"></div>
            </div>
            <input type="text" id="evtDesc" class="form-control form-control-sm mb-2" placeholder="توضیح (الزامی)">
            <button class="btn btn-sm btn-dark w-100" onclick="addEvent()">افزودن رویداد</button>
        </div>
        
        <div id="eventListContainer" class="mb-3" style="max-height: 200px; overflow-y: auto;"></div>

        <hr>
        <button class="btn btn-primary btn-action" onclick="renderPreview()">
            <i class="fas fa-eye"></i> به‌روزرسانی جدول
        </button>
        <button class="btn btn-success btn-action" onclick="downloadExcel()">
            <i class="fas fa-file-excel"></i> دانلود اکسل حرفه‌ای
        </button>
        <button class="btn btn-danger btn-action" onclick="downloadPDF()">
            <i class="fas fa-file-pdf"></i> دانلود PDF
        </button>
    </aside>

    <!-- پنل پیش‌نمایش -->
    <main class="panel">
        <div id="previewArea" class="preview-box">
            <div class="text-center text-muted py-5">
                <i class="fas fa-calendar-alt fa-3x mb-3"></i>
                <h5>لطفاً بازه زمانی را تنظیم کرده و دکمه "به‌روزرسانی" را بزنید.</h5>
            </div>
        </div>
    </main>

</div>

<!-- کانتینر مخفی برای تولید PDF -->
<div id="pdfSource" style="padding: 20px; background: white; display: none;"></div>

<script>
    // ===========================================
    //  1. هسته محاسباتی (بدون وابستگی خارجی پیچیده)
    // ===========================================
    
    let eventsDB = [];

    // تابع کمکی: تبدیل رشته تاریخ به آبجکت و برعکس
    // فرمت: YYYY/MM/DD
    function strToDate(str) {
        if(!str || str.split('/').length !== 3) return null;
        const p = str.split('/').map(Number);
        return { y: p[0], m: p[1], d: p[2] };
    }

    // تبدیل تاریخ شمسی به آبجکت Date میلادی (برای حلقه)
    function jToG(jY, jM, jD) {
        const g = jalaali.toGregorian(jY, jM, jD);
        return new Date(g.gy, g.gm - 1, g.gd);
    }

    // تنظیم تاریخ امروز در ورودی‌ها
    window.onload = function() {
        const today = new Date();
        const j = jalaali.toJalaali(today);
        const fmt = (n) => n.toString().padStart(2, '0');
        const todayStr = `${j.jy}/${fmt(j.jm)}/${fmt(j.jd)}`;
        
        document.getElementById('startDate').value = todayStr;
        // پیش‌فرض پایان: 3 ماه بعد
        let nextM = j.jm + 3;
        let nextY = j.jy;
        if(nextM > 12) { nextM -= 12; nextY++; }
        document.getElementById('endDate').value = `${nextY}/${fmt(nextM)}/${fmt(j.jd)}`;
    };

    // ===========================================
    //  2. مدیریت رویدادها
    // ===========================================

    function addEvent() {
        const sStr = document.getElementById('evtStart').value;
        const eStr = document.getElementById('evtEnd').value;
        const desc = document.getElementById('evtDesc').value;
        const type = document.getElementById('eventType').value;

        // اعتبارسنجی
        if(!sStr || !desc) return alert("تاریخ شروع و توضیحات الزامی است");
        const s = strToDate(sStr);
        const e = eStr ? strToDate(eStr) : s; // اگر پایان خالی بود، همان روز شروع است

        // بررسی بازه کلی تقویم
        const mainStart = strToDate(document.getElementById('startDate').value);
        const mainEnd = strToDate(document.getElementById('endDate').value);
        
        const gEvtStart = jToG(s.y, s.m, s.d);
        const gCalStart = jToG(mainStart.y, mainStart.m, mainStart.d);
        const gCalEnd = jToG(mainEnd.y, mainEnd.m, mainEnd.d);

        if (gEvtStart < gCalStart || gEvtStart > gCalEnd) {
            return alert("تاریخ رویداد باید در بازه زمانی تقویم باشد.");
        }

        eventsDB.push({ id: Date.now(), s, e, desc, type });
        renderEvents();
        document.getElementById('evtDesc').value = '';
    }

    function deleteEvent(id) {
        eventsDB = eventsDB.filter(x => x.id !== id);
        renderEvents();
    }

    function renderEvents() {
        const list = document.getElementById('eventListContainer');
        list.innerHTML = '';
        eventsDB.forEach(ev => {
            let badge = ev.type === 'holiday' ? 'bg-danger' : (ev.type === 'exam' ? 'bg-primary' : 'bg-warning text-dark');
            let typeName = ev.type === 'holiday' ? 'تعطیل' : (ev.type === 'exam' ? 'امتحان' : 'رویداد');
            
            list.innerHTML += `
                <div class="event-item">
                    <div>
                        <span class="badge ${badge}">${typeName}</span>
                        <strong>${ev.s.y}/${ev.s.m}/${ev.s.d}</strong> : ${ev.desc}
                    </div>
                    <i class="fas fa-trash text-danger" style="cursor:pointer" onclick="deleteEvent(${ev.id})"></i>
                </div>
            `;
        });
    }

    // ===========================================
    //  3. موتور تولید داده (Data Engine)
    // ===========================================

    function generateData() {
        const sStr = document.getElementById('startDate').value;
        const eStr = document.getElementById('endDate').value;
        const thRule = document.getElementById('thursdayMode').value;

        const startJ = strToDate(sStr);
        const endJ = strToDate(eStr);

        if(!startJ || !endJ) return null;

        const startG = jToG(startJ.y, startJ.m, startJ.d);
        const endG = jToG(endJ.y, endJ.m, endJ.d);

        if(endG < startG) {
            alert("تاریخ پایان نمی‌تواند قبل از شروع باشد!");
            return null;
        }

        let result = [];
        let currentG = new Date(startG);
        let sessionCount = 1;
        let weekIdx = 1;

        // نام روزها و ماه‌ها
        const weekDays = ['یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنج‌شنبه', 'جمعه', 'شنبه'];
        const months = ['', 'فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور', 'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'];

        while(currentG <= endG) {
            // تبدیل برعکس برای نمایش
            const currentJ = jalaali.toJalaali(currentG);
            const dayOfWeek = currentG.getDay(); // 0..6
            
            let row = {
                idx: result.length + 1,
                date: `${currentJ.jy}/${currentJ.jm}/${currentJ.jd}`,
                dayName: weekDays[dayOfWeek],
                monthName: months[currentJ.jm],
                status: 'آموزشی',
                desc: '',
                count: '',
                className: ''
            };

            // 1. بررسی جمعه
            if(dayOfWeek === 5) {
                row.status = 'تعطیل';
                row.desc = 'جمعه';
                row.className = 'friday-row';
            }

            // 2. بررسی پنج‌شنبه
            if(dayOfWeek === 4 && row.status !== 'تعطیل') {
                if(thRule === 'off') {
                    row.status = 'تعطیل';
                    row.desc = 'تعطیلی پنج‌شنبه';
                    row.className = 'holiday-row';
                } else if(thRule === 'odd' && weekIdx % 2 !== 0) {
                    row.status = 'تعطیل';
                    row.desc = 'تعطیلی هفته فرد';
                    row.className = 'holiday-row';
                }
            }

            // 3. بررسی رویدادهای کاربر (اولویت بالا)
            // تبدیل تاریخ فعلی به فرمت قابل مقایسه
            // اینجا باید چک کنیم آیا currentJ بین s و e رویداد هست یا نه
            // برای سادگی، بازه رویداد را هم به میلادی تبدیل و مقایسه میکنیم
            for(let ev of eventsDB) {
                let evStartG = jToG(ev.s.y, ev.s.m, ev.s.d);
                let evEndG = jToG(ev.e.y, ev.e.m, ev.e.d);
                
                if(currentG >= evStartG && currentG <= evEndG) {
                    row.desc = ev.desc;
                    if(ev.type === 'holiday') {
                        row.status = 'تعطیل';
                        row.className = 'holiday-row';
                    } else if(ev.type === 'exam') {
                        row.status = 'امتحان';
                        row.className = 'exam-row';
                    } else {
                        row.status = 'رویداد';
                        row.className = 'event-row';
                    }
                }
            }

            // شمارش جلسه
            if(row.status === 'آموزشی' || row.status === 'رویداد') {
                row.count = sessionCount++;
            } else {
                row.count = '-';
            }

            result.push(row);

            // افزایش روز
            if(dayOfWeek === 5) weekIdx++; // جمعه هفته عوض میشه
            currentG.setDate(currentG.getDate() + 1);
        }

        return result;
    }

    // ===========================================
    //  4. رندر و خروجی
    // ===========================================

    function renderPreview() {
        const data = generateData();
        if(!data) return;

        const title = document.getElementById('headerTitle').value;
        
        let html = `
            <div class="text-center mb-3">
                <h3>${title}</h3>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ردیف</th>
                        <th>روز هفته</th>
                        <th>تاریخ</th>
                        <th>ماه</th>
                        <th>وضعیت</th>
                        <th>توضیحات</th>
                        <th>شمارش</th>
                    </tr>
                </thead>
                <tbody>
        `;

        data.forEach(row => {
            html += `
                <tr class="${row.className}">
                    <td>${row.idx}</td>
                    <td>${row.dayName}</td>
                    <td dir="ltr">${row.date}</td>
                    <td>${row.monthName}</td>
                    <td><strong>${row.status}</strong></td>
                    <td>${row.desc}</td>
                    <td><strong>${row.count}</strong></td>
                </tr>
            `;
        });

        html += `</tbody></table>`;
        document.getElementById('previewArea').innerHTML = html;
        document.getElementById('pdfSource').innerHTML = html; // کپی برای PDF
    }

    async function downloadExcel() {
        const data = generateData();
        if(!data) return;

        const workbook = new ExcelJS.Workbook();
        const sheet = workbook.addWorksheet('تقویم', {views: [{rightToLeft: true}]});

        // هدر اصلی
        sheet.mergeCells('A1:G1');
        const titleRow = sheet.getCell('A1');
        titleRow.value = document.getElementById('headerTitle').value;
        titleRow.font = { name: 'Tahoma', size: 16, bold: true, color: { argb: 'FFFFFFFF' } };
        titleRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E40AF' } };
        titleRow.alignment = { horizontal: 'center', vertical: 'middle' };
        sheet.getRow(1).height = 40;

        // عناوین جدول
        const headers = ['ردیف', 'روز', 'تاریخ', 'ماه', 'وضعیت', 'توضیحات', 'شمارش'];
        const headerRow = sheet.addRow(headers);
        headerRow.eachCell(cell => {
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2563EB' } };
            cell.font = { name: 'Tahoma', size: 12, bold: true, color: { argb: 'FFFFFFFF' } };
            cell.alignment = { horizontal: 'center', vertical: 'middle' };
            cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
        });

        // داده‌ها
        data.forEach(d => {
            const r = sheet.addRow([d.idx, d.dayName, d.date, d.monthName, d.status, d.desc, d.count]);
            
            let color = 'FFFFFFFF';
            if(d.className === 'holiday-row') color = 'FFFEE2E2';
            if(d.className === 'friday-row') color = 'FFFCE7F3';
            if(d.className === 'exam-row') color = 'FFEFF6FF';
            if(d.className === 'event-row') color = 'FFFFFBEB';

            r.eachCell(cell => {
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: color } };
                cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
                cell.alignment = { horizontal: 'center', vertical: 'middle' };
                cell.font = { name: 'Tahoma' };
            });
        });

        // تنظیم عرض ستون‌ها
        sheet.columns = [
            { width: 8 }, { width: 15 }, { width: 15 }, { width: 12 }, { width: 15 }, { width: 40 }, { width: 10 }
        ];

        // دانلود
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
        saveAs(blob, "Calendar.xlsx");
    }

    function downloadPDF() {
        const element = document.getElementById('pdfSource');
        if(element.innerHTML.trim() === "") renderPreview();
        
        element.style.display = 'block';
        const opt = {
            margin: 0.5,
            filename: 'calendar.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save().then(() => {
            element.style.display = 'none';
        });
    }

</script>
</body>
</html>
