  
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سامانه جامع تقویم آموزشی | نسخه نهایی</title>
    
    <!-- استایل‌ها -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    
    <!-- کتابخانه‌های ضروری (نسخه‌های پایدار و تست شده) -->
    <!-- ExcelJS برای خروجی اکسل حرفه‌ای -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <!-- FileSaver برای ذخیره فایل -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- html2pdf برای خروجی PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --bg-app: #f3f4f6;
            --surface: #ffffff;
            --text-main: #1f2937;
            --radius: 12px;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            padding-bottom: 100px;
        }

        .app-container {
            max-width: 1200px;
            margin: 30px auto;
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 25px;
        }

        .settings-panel, .preview-panel {
            background: var(--surface);
            padding: 25px;
            border-radius: var(--radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .settings-panel { position: sticky; top: 20px; height: fit-content; }
        .preview-panel { min-height: 80vh; }

        .section-title {
            font-weight: 800; color: var(--primary);
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px; margin-bottom: 20px;
        }

        .calendar-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .calendar-table th { background-color: var(--primary); color: white; padding: 12px; text-align: center; }
        .calendar-table td { border: 1px solid #e5e7eb; padding: 10px; vertical-align: middle; text-align: center; }
        
        .row-holiday { background-color: #fef2f2; color: #991b1b; }
        .row-friday { background-color: #fce7f3; color: #831843; }
        .row-event { background-color: #fffbeb; color: #92400e; }
        .row-exam { background-color: #eff6ff; color: #1e40af; }

        .btn-action { width: 100%; padding: 12px; border-radius: 10px; font-weight: 700; margin-bottom: 10px; transition: 0.3s; }
        .btn-excel { background-color: #10b981; color: white; border: none; }
        .btn-excel:hover { background-color: #059669; }
        .btn-preview { background-color: var(--primary); color: white; border: none; }
        .btn-preview:hover { background-color: var(--primary-dark); }
        .btn-pdf { background-color: #ef4444; color: white; border: none; }
        .btn-pdf:hover { background-color: #dc2626; }

        .event-list-item {
            display: flex; justify-content: space-between; align-items: center;
            background: #f9fafb; padding: 8px 12px; border-radius: 6px;
            margin-bottom: 5px; border: 1px solid #e5e7eb; font-size: 0.85rem;
        }

        @media (max-width: 992px) { .app-container { grid-template-columns: 1fr; } }
        .pdf-container { padding: 20px; background: white; display: none; }
    </style>
</head>
<body>

<div class="app-container">
    
    <!-- Sidebar -->
    <aside class="settings-panel">
        <div class="text-center mb-4">
            <h4 style="font-weight: 900; color: var(--primary-dark);">تنظیمات تقویم</h4>
        </div>

        <div class="section-title"><i class="fas fa-cog"></i> اطلاعات پایه</div>
        <div class="mb-3">
            <label class="form-label">عنوان تقویم</label>
            <input type="text" id="calTitle" class="form-control" value="تقویم آموزشی نیمسال اول">
        </div>
        <div class="mb-3">
            <label class="form-label">زیرعنوان</label>
            <input type="text" id="calSubtitle" class="form-control" value="سال تحصیلی ۱۴۰۴-۱۴۰۳">
        </div>

        <div class="row g-2 mb-3">
            <div class="col-6"><label class="form-label">شروع (Y/M/D)</label><input type="text" id="startDate" class="form-control text-center" value="1403/07/01"></div>
            <div class="col-6"><label class="form-label">پایان (Y/M/D)</label><input type="text" id="endDate" class="form-control text-center" value="1403/10/30"></div>
        </div>

        <div class="mb-4">
            <label class="form-label">وضعیت پنج‌شنبه‌ها</label>
            <select id="thursdayMode" class="form-select">
                <option value="work">روز کاری (آموزشی)</option>
                <option value="off">تعطیل کامل</option>
                <option value="odd">هفته‌های فرد تعطیل</option>
            </select>
        </div>

        <div class="section-title"><i class="fas fa-calendar-plus"></i> رویداد/تعطیلی</div>
        <div class="bg-light p-3 rounded mb-3 border">
            <div class="mb-2">
                <select id="eventType" class="form-select form-select-sm">
                    <option value="holiday">تعطیل رسمی/اضطراری</option>
                    <option value="exam">ایام امتحانات</option>
                    <option value="event">رویداد آموزشی</option>
                </select>
            </div>
            <div class="row g-2 mb-2">
                <div class="col-6"><input type="text" id="evtStart" class="form-control form-control-sm text-center" placeholder="از: 1403/08/10"></div>
                <div class="col-6"><input type="text" id="evtEnd" class="form-control form-control-sm text-center" placeholder="تا: 1403/08/12"></div>
            </div>
            <input type="text" id="evtDesc" class="form-control form-control-sm mb-2" placeholder="توضیحات">
            <button class="btn btn-sm btn-success w-100" onclick="addEventRange()">افزودن</button>
        </div>

        <div id="eventsList" class="mb-4"></div>

        <hr>
        <button class="btn-action btn-preview" onclick="generatePreview()">پیش‌نمایش جدول</button>
        <button class="btn-action btn-excel" onclick="exportToExcel()">دانلود فایل اکسل</button>
        <button class="btn-action btn-pdf" onclick="exportToPDF()">دانلود فایل PDF</button>
    </aside>

    <!-- Preview -->
    <main class="preview-panel">
        <div id="previewArea">
            <div class="text-center text-muted mt-5">
                <i class="fas fa-table fa-3x mb-3"></i>
                <h5>برای مشاهده، دکمه پیش‌نمایش را بزنید.</h5>
            </div>
        </div>
    </main>
</div>

<!-- Hidden container for PDF generation -->
<div id="pdfSource" class="pdf-container"></div>

<script>
    // --- 1. Utilities ---
    const fixedHolidays = {
        "1-1": "عید نوروز", "1-2": "عید نوروز", "1-3": "عید نوروز", "1-4": "عید نوروز",
        "1-12": "روز جمهوری اسلامی", "1-13": "روز طبیعت",
        "3-14": "رحلت امام خمینی", "3-15": "قیام ۱۵ خرداد",
        "11-22": "پیروزی انقلاب اسلامی", "12-29": "ملی شدن صنعت نفت"
    };
    let userEvents = [];

    // Jalali Converter Logic (Internal)
    const JalaliDate = {
        g_days_in_month: [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31],
        j_days_in_month: [31, 31, 31, 31, 31, 31, 30, 30, 30, 30, 30, 29],
        jalaliToGregorian: function(j_y, j_m, j_d) {
            j_y = parseInt(j_y); j_m = parseInt(j_m); j_d = parseInt(j_d);
            var jy = j_y - 979; var jm = j_m - 1; var jd = j_d - 1;
            var j_day_no = 365 * jy + parseInt(jy / 33) * 8 + parseInt((jy % 33 + 3) / 4);
            for (var i = 0; i < jm; ++i) j_day_no += this.j_days_in_month[i];
            j_day_no += jd;
            var g_day_no = j_day_no + 79;
            var gy = 1600 + 400 * parseInt(g_day_no / 146097);
            g_day_no = g_day_no % 146097;
            var leap = true;
            if (g_day_no >= 36525) { g_day_no--; gy += 100 * parseInt(g_day_no / 36524); g_day_no = g_day_no % 36524; if (g_day_no >= 365) g_day_no++; else leap = false; }
            gy += 4 * parseInt(g_day_no / 1461); g_day_no %= 1461;
            if (g_day_no >= 366) { leap = false; g_day_no--; gy += parseInt(g_day_no / 365); g_day_no = g_day_no % 365; }
            for (var i = 0; g_day_no >= this.g_days_in_month[i] + (i == 1 && leap); i++) g_day_no -= this.g_days_in_month[i] + (i == 1 && leap);
            return new Date(gy, i, g_day_no + 1);
        },
        gregorianToJalali: function(g_y, g_m, g_d) {
            g_y = parseInt(g_y); g_m = parseInt(g_m); g_d = parseInt(g_d);
            var gy = g_y - 1600; var gm = g_m - 1; var gd = g_d - 1;
            var g_day_no = 365 * gy + parseInt((gy + 3) / 4) - parseInt((gy + 99) / 100) + parseInt((gy + 399) / 400);
            for (var i = 0; i < gm; ++i) g_day_no += this.g_days_in_month[i];
            if (gm > 1 && ((gy % 4 == 0 && gy % 100 != 0) || (gy % 400 == 0))) g_day_no++;
            g_day_no += gd;
            var j_day_no = g_day_no - 79;
            var j_np = parseInt(j_day_no / 12053);
            j_day_no %= 12053;
            var jy = 979 + 33 * j_np + 4 * parseInt(j_day_no / 1461);
            j_day_no %= 1461;
            if (j_day_no >= 366) { jy += parseInt((j_day_no - 1) / 365); j_day_no = (j_day_no - 1) % 365; }
            for (var i = 0; i < 11 && j_day_no >= this.j_days_in_month[i]; ++i) j_day_no -= this.j_days_in_month[i];
            return [jy, i + 1, j_day_no + 1];
        },
        getDayName: function(dayIndex) { const days = ['یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنج‌شنبه', 'جمعه', 'شنبه']; return days[dayIndex]; },
        getMonthName: function(m) { const months = ["", "فروردین", "اردیبهشت", "خرداد", "تیر", "مرداد", "شهریور", "مهر", "آبان", "آذر", "دی", "بهمن", "اسفند"]; return months[m]; }
    };

    function parseDate(str) {
        const parts = str.split('/');
        if(parts.length !== 3) return null;
        return { y: parseInt(parts[0]), m: parseInt(parts[1]), d: parseInt(parts[2]) };
    }
    
    function dateToObj(jY, jM, jD) { return JalaliDate.jalaliToGregorian(jY, jM, jD); }

    // --- 2. Event Functions ---
    function addEventRange() {
        const startStr = document.getElementById('evtStart').value;
        const endStr = document.getElementById('evtEnd').value;
        const desc = document.getElementById('evtDesc').value;
        const type = document.getElementById('eventType').value;

        if(!startStr || !desc) { alert("تاریخ شروع و توضیحات الزامی است"); return; }
        const s = parseDate(startStr);
        const e = endStr ? parseDate(endStr) : s;
        if(!s || !e) { alert("فرمت تاریخ اشتباه است (مثال: 1403/08/10)"); return; }

        userEvents.push({ 
            id: Date.now(), 
            start: dateToObj(s.y, s.m, s.d), 
            end: dateToObj(e.y, e.m, e.d), 
            desc: desc, 
            type: type 
        });
        renderEventsList();
        document.getElementById('evtDesc').value = "";
    }

    function removeEvent(id) {
        userEvents = userEvents.filter(ev => ev.id !== id);
        renderEventsList();
    }

    function renderEventsList() {
        const container = document.getElementById('eventsList');
        container.innerHTML = "";
        userEvents.forEach(ev => {
            const sJ = JalaliDate.gregorianToJalali(ev.start.getFullYear(), ev.start.getMonth()+1, ev.start.getDate());
            const eJ = JalaliDate.gregorianToJalali(ev.end.getFullYear(), ev.end.getMonth()+1, ev.end.getDate());
            
            let badgeClass = "bg-secondary";
            if(ev.type === 'holiday') badgeClass = "bg-danger";
            else if(ev.type === 'exam') badgeClass = "bg-primary";
            else if(ev.type === 'event') badgeClass = "bg-warning text-dark";

            container.innerHTML += `
                <div class="event-list-item">
                    <div>
                        <span class="badge ${badgeClass} ms-1">${ev.type==='holiday'?'تعطیل':(ev.type==='exam'?'امتحان':'رویداد')}</span>
                        <small><strong>${sJ[0]}/${sJ[1]}/${sJ[2]}</strong> تا <strong>${eJ[0]}/${eJ[1]}/${eJ[2]}</strong> : ${ev.desc}</small>
                    </div>
                    <button class="btn btn-sm text-danger" onclick="removeEvent(${ev.id})"><i class="fas fa-times"></i></button>
                </div>`;
        });
    }

    // --- 3. Calendar Engine ---
    function calculateCalendar() {
        const sStr = document.getElementById('startDate').value;
        const eStr = document.getElementById('endDate').value;
        const s = parseDate(sStr); const e = parseDate(eStr);
        const thRule = document.getElementById('thursdayMode').value;

        if(!s || !e) return null;

        let current = dateToObj(s.y, s.m, s.d);
        const end = dateToObj(e.y, e.m, e.d);
        let rows = [];
        let weekCounter = 1;
        let sessionCounter = 1;

        while(current <= end) {
            const [jy, jm, jd] = JalaliDate.gregorianToJalali(current.getFullYear(), current.getMonth()+1, current.getDate());
            const dayOfWeek = current.getDay(); // 0=Sun ... 6=Sat
            
            let status = "active";
            let reason = "";
            let cssClass = "";
            let count = sessionCounter;

            // Check User Events
            let userEvt = userEvents.find(ev => current >= ev.start && current <= ev.end);
            if(userEvt) {
                reason = userEvt.desc;
                if(userEvt.type === 'holiday') { status = "holiday"; cssClass = "row-holiday"; count = "-"; }
                else if(userEvt.type === 'exam') { status = "exam"; cssClass = "row-exam"; count = "-"; }
                else { status = "event"; cssClass = "row-event"; }
            }

            // Check Fixed Holidays
            if(status !== 'holiday') {
                const fKey = `${jm}-${jd}`;
                if(fixedHolidays[fKey]) { status = "holiday"; reason = fixedHolidays[fKey]; cssClass = "row-holiday"; count = "-"; }
            }

            // Check Friday
            if(dayOfWeek === 5) {
                status = "holiday"; reason = "جمعه"; cssClass = "row-friday"; count = "-";
            }

            // Check Thursday
            if(dayOfWeek === 4 && status !== 'holiday') {
                if(thursdayRule === 'off') { status = "holiday"; reason = "تعطیل پنج‌شنبه"; cssClass = "row-holiday"; count = "-"; }
                else if (thursdayRule === 'odd' && weekCounter % 2 !== 0) { status = "holiday"; reason = "تعطیل پنج‌شنبه (فرد)"; cssClass = "row-holiday"; count = "-"; }
            }

            if(status !== 'holiday' && status !== 'exam') sessionCounter++;

            rows.push({
                idx: 0, 
                dayName: JalaliDate.getDayName(dayOfWeek),
                fullDate: `${jy}/${jm}/${jd}`,
                monthName: JalaliDate.getMonthName(jm),
                status: status === 'holiday' ? 'تعطیل' : (status === 'exam' ? 'امتحان' : 'آموزشی'),
                reason: reason,
                count: count,
                cssClass: cssClass,
                statusCode: status
            });

            if(dayOfWeek === 5) weekCounter++;
            current.setDate(current.getDate() + 1);
        }
        return rows;
    }

    // --- 4. Preview Generation ---
    function generatePreview() {
        const data = calculateCalendar();
        if(!data) { alert("لطفا تاریخ شروع و پایان را صحیح وارد کنید"); return; }
        
        const title = document.getElementById('calTitle').value;
        const sub = document.getElementById('calSubtitle').value;

        let html = `
            <div class="text-center mb-4">
                <h3 style="font-weight:900; color:var(--primary-dark)">${title}</h3>
                <h5 class="text-muted">${sub}</h5>
            </div>
            <table class="calendar-table">
                <thead>
                    <tr>
                        <th width="5%">#</th>
                        <th width="10%">روز</th>
                        <th width="15%">تاریخ</th>
                        <th width="10%">ماه</th>
                        <th width="10%">وضعیت</th>
                        <th width="35%">شرح</th>
                        <th width="15%">جلسه</th>
                    </tr>
                </thead>
                <tbody>
        `;

        data.forEach((r, i) => {
            html += `
                <tr class="${r.cssClass}">
                    <td>${i + 1}</td>
                    <td>${r.dayName}</td>
                    <td dir="ltr">${r.fullDate}</td>
                    <td>${r.monthName}</td>
                    <td style="font-weight:bold">${r.status}</td>
                    <td>${r.reason}</td>
                    <td style="font-weight:bold">${r.count}</td>
                </tr>
            `;
        });

        html += `</tbody></table>`;
        document.getElementById('previewArea').innerHTML = html;
        document.getElementById('pdfSource').innerHTML = html;
    }

    // --- 5. Export Logic (ExcelJS) ---
    async function exportToExcel() {
        try {
            const data = calculateCalendar();
            if(!data) { alert("ابتدا بازه زمانی را تنظیم کنید"); return; }

            const wb = new ExcelJS.Workbook();
            const ws = wb.addWorksheet('تقویم آموزشی', {
                views: [{ rightToLeft: true }]
            });

            const title = document.getElementById('calTitle').value;
            const sub = document.getElementById('calSubtitle').value;

            // Columns
            ws.columns = [
                { key: 'idx', width: 8 },
                { key: 'day', width: 15 },
                { key: 'date', width: 15 },
                { key: 'month', width: 12 },
                { key: 'status', width: 15 },
                { key: 'reason', width: 45 },
                { key: 'count', width: 10 },
            ];

            // Header Rows
            ws.mergeCells('A1:G1');
            const titleRow = ws.getCell('A1');
            titleRow.value = title;
            titleRow.font = { name: 'Tahoma', size: 16, bold: true, color: { argb: 'FFFFFFFF' } };
            titleRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E40AF' } };
            titleRow.alignment = { vertical: 'middle', horizontal: 'center' };

            ws.mergeCells('A2:G2');
            const subRow = ws.getCell('A2');
            subRow.value = sub;
            subRow.font = { name: 'Tahoma', size: 12, bold: true };
            subRow.alignment = { vertical: 'middle', horizontal: 'center' };
            subRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE5E7EB' } };

            // Stats
            const totalHolidays = data.filter(d => d.statusCode === 'holiday').length;
            const totalSessions = data.length - totalHolidays;
            ws.mergeCells('A3:G3');
            ws.getCell('A3').value = `مجموع روزها: ${data.length} | روزهای آموزشی: ${totalSessions} | تعطیلات: ${totalHolidays}`;
            ws.getCell('A3').alignment = { vertical: 'middle', horizontal: 'center' };

            // Table Header
            const headerRow = ws.getRow(4);
            headerRow.values = ['ردیف', 'روز هفته', 'تاریخ', 'ماه', 'وضعیت', 'شرح رویداد / تعطیلی', 'جلسه'];
            headerRow.eachCell((cell) => {
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2563EB' } };
                cell.font = { name: 'Tahoma', size: 11, bold: true, color: { argb: 'FFFFFFFF' } };
                cell.alignment = { vertical: 'middle', horizontal: 'center' };
                cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
            });

            // Data Rows
            data.forEach((d, i) => {
                const row = ws.addRow([i + 1, d.dayName, d.fullDate, d.monthName, d.status, d.reason, d.count]);
                
                let bgColor = 'FFFFFFFF'; // White
                if(d.statusCode === 'holiday') bgColor = 'FFFEE2E2'; // Red
                if(d.dayName === 'جمعه') bgColor = 'FFFCE7F3'; // Pink
                if(d.statusCode === 'exam') bgColor = 'FFEFF6FF'; // Blue
                if(d.statusCode === 'event') bgColor = 'FFFFFBEB'; // Yellow

                row.eachCell((cell) => {
                    cell.font = { name: 'Tahoma', size: 10 };
                    cell.alignment = { vertical: 'middle', horizontal: 'center' };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: bgColor } };
                    cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
                });
            });

            // Export
            const buffer = await wb.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            saveAs(blob, 'Calendar_Pro.xlsx');

        } catch(e) {
            alert("خطا در ایجاد فایل اکسل: " + e.message);
            console.error(e);
        }
    }

    // --- 6. PDF Export ---
    function exportToPDF() {
        const element = document.getElementById('pdfSource');
        if(element.innerHTML.trim() === "") generatePreview();
        
        element.style.display = 'block';
        const opt = {
            margin: 0.5,
            filename: 'Calendar.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        };
        
        html2pdf().set(opt).from(element).save().then(() => {
            element.style.display = 'none';
        });
    }
</script>

</body>
</html>
