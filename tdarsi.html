      <!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ابزار ساخت تقویم آموزشی</title>
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    
    <!-- Vazirmatn Font -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    
    <!-- SheetJS Library for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
      :root {
        --primary-color: #007bff; --success-color: #28a745; --info-color: #17a2b8;
        --light-gray: #f8f9fa; --border-color: #dee2e6;
        --card-shadow: 0 4px 8px 0 rgba(0,0,0,0.1);
      }
      body { font-family: 'Vazirmatn', sans-serif; background-color: var(--light-gray); padding: 2rem 0; }
      .container { max-width: 750px; background: #fff; padding: 2.5rem; border-radius: 12px; box-shadow: var(--card-shadow); }
      .card { border: 1px solid var(--border-color); border-radius: 8px; box-shadow: none; margin-top: 1.5rem; }
      .card-header { background-color: #f7f7f9; font-weight: 500; border-bottom: 1px solid var(--border-color); cursor: pointer; }
      .card-header h5::after { content: '▼'; float: left; transition: transform 0.3s; }
      .card-header.collapsed h5::after { transform: rotate(-90deg); }
      .btn { font-weight: 500; padding: 0.6rem 1.2rem; border-radius: 8px; transition: all 0.2s; }
      .form-control, .custom-select { border-radius: 8px; }
      .loader-container { text-align: center; padding: 20px; display: none; }
      .loader { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px auto; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .hijri-anchor-row { margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px dashed var(--border-color); align-items: center; }
      .hijri-anchor-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
      #interHolidaysContainer .form-check { margin-bottom: 5px; }
      .alert { display: flex; align-items: center; }
      .alert::before { content: '✓'; font-size: 1.5rem; margin-left: 0.75rem; }
      .alert-danger::before { content: '×'; }
    </style>
</head>
<body>
    <div class="container">
      <div class="text-center mb-5">
        <h2>ابزار ساخت تقویم آموزشی</h2>
        <p class="text-muted">یک ابزار مستقل برای ایجاد و دانلود تقویم‌های آموزشی سفارشی</p>
      </div>

      <div id="accordion">

        <!-- STEP 1: Main Info -->
        <div class="card" id="step1">
            <div class="card-header" data-toggle="collapse" data-target="#collapseOne">
                <h5>مرحله ۱: اطلاعات اصلی تقویم</h5>
            </div>
            <div id="collapseOne" class="collapse show" data-parent="#accordion">
                <div class="card-body">
                    <h6>اطلاعات سربرگ فایل خروجی</h6>
                    <div class="form-group"><label for="headerName">نام مجموعه</label><input type="text" id="headerName" class="form-control" value="مجموعه آموزشی X"></div>
                    <div class="form-group"><label for="headerTerm">سال/ترم تحصیلی</label><input type="text" id="headerTerm" class="form-control" value="سال تحصیلی ۱۴۰۵-۱۴۰۴"></div>
                    <div class="form-group"><label for="headerOther">سایر اطلاعات (اختیاری)</label><input type="text" id="headerOther" class="form-control" placeholder="مثلا: تقویم دوره کارشناسی ارشد"></div>
                    <hr>
                    <h6>محدوده زمانی تقویم</h6>
                    <div class="row">
                      <div class="col-md-6 form-group"><label>تاریخ شروع</label><div class="form-row"><div class="col"><input type="number" id="startDay" class="form-control" value="1"></div><div class="col"><input type="number" id="startMonth" class="form-control" value="6"></div><div class="col"><input type="number" id="startYear" class="form-control" value="1404"></div></div></div>
                      <div class="col-md-6 form-group"><label>تاریخ اتمام</label><div class="form-row"><div class="col"><input type="number" id="endDay" class="form-control" value="31"></div><div class="col"><input type="number" id="endMonth" class="form-control" value="4"></div><div class="col"><input type="number" id="endYear" class="form-control" value="1405"></div></div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 2: Holiday Settings -->
        <div class="card" id="step2">
          <div class="card-header collapsed" data-toggle="collapse" data-target="#collapseTwo">
            <h5>مرحله ۲: تنظیمات تعطیلات</h5>
          </div>
          <div id="collapseTwo" class="collapse" data-parent="#accordion">
            <div class="card-body">
                <h6>تنظیمات تعطیلی پنج‌شنبه‌ها</h6>
                <select id="thursdayOption" class="custom-select">
                    <option value="none" selected>پنج‌شنبه‌ها تعطیل نیست</option>
                    <option value="all">تمام پنج‌شنبه‌ها تعطیل است</option>
                    <option value="alternate_off">یک هفته در میان (هفته اول تعطیل)</option>
                    <option value="alternate_on">یک هفته در میان (هفته اول کاری)</option>
                </select>
                <hr>
                <h6>افزودن تعطیلات غیررسمی (اختیاری)</h6>
                <div class="form-row">
                  <div class="col-3"><input type="number" id="customDay" class="form-control" placeholder="روز"></div>
                  <div class="col-3"><input type="number" id="customMonth" class="form-control" placeholder="ماه"></div>
                  <div class="col-3"><input type="number" id="customYear" class="form-control" placeholder="سال"></div>
                  <div class="col-3"><input type="text" id="customReason" class="form-control" placeholder="دلیل تعطیلی"></div>
                </div>
                <button type="button" class="btn btn-secondary btn-sm mt-2" onclick="addCustomHoliday()">افزودن</button>
                <ul id="customHolidaysList" class="list-group mt-3"></ul>
            </div>
          </div>
        </div>
        
        <!-- STEP 3: Hijri Anchor -->
        <div class="card" id="step3">
          <div class="card-header collapsed" data-toggle="collapse" data-target="#collapseThree">
            <h5>مرحله ۳: تطبیق تاریخ قمری (مهم)</h5>
          </div>
          <div id="collapseThree" class="collapse" data-parent="#accordion">
            <div class="card-body">
              <p class="text-muted">برای محاسبه دقیق تعطیلات، ابتدا نقاط کلیدی زیر را بر اساس یک تقویم رسمی تطبیق دهید.</p>
              <button type="button" id="findAnchorPointsBtn" class="btn btn-info" onclick="findAnchorPoints()">شناسایی نقاط کلیدی</button>
              <div id="hijriAnchorsContainer" class="mt-3"></div>
            </div>
          </div>
        </div>
        
        <!-- STEP 4: Inter-Holidays -->
        <div class="card" id="step4">
          <div class="card-header collapsed" data-toggle="collapse" data-target="#collapseFour">
            <h5>مرحله ۴: شناسایی بین‌التعطیلین (اختیاری)</h5>
          </div>
          <div id="collapseFour" class="collapse" data-parent="#accordion">
            <div class="card-body">
              <p class="text-muted">پس از تنظیم تمام تعطیلات در مراحل قبل، روی دکمه زیر کلیک کنید.</p>
              <button type="button" id="findInterBtn" class="btn btn-warning" onclick="findInterHolidays()" disabled>یافتن روزهای بین‌التعطیلین</button>
              <div id="interHolidaysContainer" class="mt-3"></div>
            </div>
          </div>
        </div>

      </div>

      <!-- Action Button and Status -->
      <button type="button" id="generateBtn" class="btn btn-success btn-lg btn-block mt-4" onclick="generate()" disabled>ایجاد تقویم و دانلود فایل اکسل</button>
      <div id="loader-container" class="loader-container">
          <div class="loader"></div>
          <p id="loader-message"></p>
      </div>
      <div id="status" class="alert mt-3" style="display:none;"></div>
      
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
      // ===================================================================================
      // SECTION: CALENDAR UTILITIES (ALL MATH IS HERE)
      // ===================================================================================
      const CalendarUtils = (() => {
          const JALALI_MONTH_NAMES = ["", "فروردین", "اردیبهشت", "خرداد", "تیر", "مرداد", "شهریور", "مهر", "آبان", "آذر", "دی", "بهمن", "اسفند"];
          const HIJRI_MONTH_NAMES = ["", "محرم", "صفر", "ربیع‌الاول", "ربیع‌الثانی", "جمادی‌الاول", "جمادی‌الثانی", "رجب", "شعبان", "رمضان", "شوال", "ذی‌القعده", "ذی‌الحجه"];
          
          function gregorianToJalali(gDate) {
              const gy = gDate.getFullYear(); const gm = gDate.getMonth() + 1; const gd = gDate.getDate();
              let g_d_m, jy, jm, jd, gy2, days;
              g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
              gy2 = (gm > 2) ? (gy + 1) : gy;
              days = 355666 + (365 * gy) + Math.floor((gy2 + 3) / 4) - Math.floor((gy2 + 99) / 100) + Math.floor((gy2 + 399) / 400) + gd + g_d_m[gm - 1];
              jy = -1595 + (33 * Math.floor(days / 12053)); days %= 12053;
              jy += 4 * Math.floor(days / 1461); days %= 1461;
              if (days > 365) { jy += Math.floor((days - 1) / 365); days = (days - 1) % 365; }
              jm = (days < 186) ? 1 + Math.floor(days / 31) : 7 + Math.floor((days - 186) / 30);
              jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
              return { jy, jm, jd };
          }

          function jalaliToGregorian(jy, jm, jd) {
              let sal_a, gy, gm, gd, days; jy += 1595;
              days = -355668 + (365 * jy) + (Math.floor(jy / 33) * 8) + Math.floor(((jy % 33) + 3) / 4) + jd + ((jm < 7) ? (jm - 1) * 31 : ((jm - 7) * 30) + 186);
              gy = 400 * Math.floor(days / 146097); days %= 146097;
              if (days > 36524) { gy += 100 * Math.floor(--days / 36524); days %= 36524; if (days >= 365) days++; }
              gy += 4 * Math.floor(days / 1461); days %= 1461;
              if (days > 365) { gy += Math.floor((days - 1) / 365); days = (days - 1) % 365; }
              gd = days + 1;
              sal_a = [0, 31, ((gy % 4 === 0 && gy % 100 !== 0) || (gy % 400 === 0)) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
              for (gm = 0; gm < 13 && gd > sal_a[gm]; gm++) gd -= sal_a[gm];
              return new Date(gy, gm - 1, gd);
          }
          
          const GREGORIAN_EPOCH = 1721425.5;
          const ISLAMIC_EPOCH = 1948439.5;
          function g2d(year, month, day) { return (GREGORIAN_EPOCH - 1) + (365 * (year - 1)) + Math.floor((year - 1) / 4) - Math.floor((year - 1) / 100) + Math.floor((year - 1) / 400) + Math.floor((((367 * month) - 362) / 12) + ((month <= 2) ? 0 : (((year % 4 === 0) && (year % 100 !== 0)) || (year % 400 === 0)) ? -1 : -2) + day); }
          function islamicToJd(year, month, day) { return (day + Math.ceil(29.5 * (month - 1)) + (year - 1) * 354 + Math.floor((3 + (11 * year)) / 30) + ISLAMIC_EPOCH) - 1; }
          function jdToHijri(jd) { const year = Math.floor(((30 * (jd - ISLAMIC_EPOCH)) + 10646) / 10631); const month = Math.min(12, Math.ceil((jd - (29 + (islamicToJd(year, 1, 1)))) / 29.5) + 1); const day = (jd - islamicToJd(year, month, 1)) + 1; return { year, month, day }; }
          
          function calculateHijriDate(gregorianDate, anchor) {
              const anchorGDate = CalendarUtils.jalaliToGregorian(anchor.sYear, anchor.sMonth, anchor.sDay);
              const dayDiff = Math.round((gregorianDate.getTime() - anchorGDate.getTime()) / (1000 * 60 * 60 * 24));
              const anchorJd = islamicToJd(anchor.hYear, anchor.hMonth, anchor.hDay);
              const targetJd = anchorJd + dayDiff;
              return jdToHijri(targetJd);
          }
          
          function getOfficialHolidays() {
              return {
                  shamsi: {
                      "1-1": "نوروز", "1-2": "نوروز", "1-3": "نوروز", "1-4": "نوروز",
                      "1-12": "روز جمهوری اسلامی", "1-13": "روز طبیعت",
                      "3-14": "رحلت امام خمینی (ره)", "3-15": "قیام ۱۵ خرداد",
                      "11-22": "پیروزی انقلاب اسلامی", "12-29": "ملی شدن صنعت نفت ایران"
                  },
                  qamari: {
                      "1-9": "تاسوعای حسینی", "1-10": "عاشورای حسینی",
                      "2-20": "اربعین حسینی", "2-28": "شهادت پیامبر (ص) و امام حسن (ع)",
                      "2-29": "شهادت امام رضا (ع)", "2-30": "شهادت امام رضا (ع)",
                      "3-17": "تولد پیامبر (ص) و امام صادق (ع)",
                      "6-3": "شهادت حضرت فاطمه (س)",
                      "7-13": "ولادت امام علی (ع)", "7-27": "مبعث حضرت رسول اکرم (ص)",
                      "8-15": "تولد حجت بن الحسن (عج)",
                      "9-21": "شهادت امام علی (ع)",
                      "10-1": "عید فطر", "10-2": "عید فطر",
                      "10-25": "شهادت امام جعفر صادق (ع)",
                      "12-10": "عید قربان", "12-18": "عید غدیر خم"
                  }
              };
          }

          return { gregorianToJalali, jalaliToGregorian, getJalaliMonthName: (m) => JALALI_MONTH_NAMES[m], getHijriMonthName: (m) => HIJRI_MONTH_NAMES[m], getOfficialHolidays, calculateHijriDate };
      })();

      // ===================================================================================
      // SECTION: UI LOGIC AND EVENT HANDLERS
      // ===================================================================================
      let customHolidays = [];

      function getFormData(includeInterHolidays = false) {
        const sDay = parseInt(document.getElementById('startDay').value);
        const sMonth = parseInt(document.getElementById('startMonth').value);
        const sYear = parseInt(document.getElementById('startYear').value);
        
        let hijriAnchor = null;
        if(document.getElementById('hDay')){
             hijriAnchor = {
                sDay: sDay, sMonth: sMonth, sYear: sYear,
                hDay: parseInt(document.getElementById('hDay').value),
                hMonth: parseInt(document.getElementById('hMonth').value),
                hYear: parseInt(document.getElementById('hYear').value)
            };
        }
        
        let hijriMonthlyAnchors = [];
        document.querySelectorAll('.hijri-anchor-row').forEach(row => {
            const year = parseInt(row.dataset.year); const month = parseInt(row.dataset.month);
            const day = parseInt(row.dataset.day);
            const hDay = parseInt(row.querySelector('.h-day').value); const hMonth = parseInt(row.querySelector('.h-month').value); const hYear = parseInt(row.querySelector('.h-year').value);
            if (!isNaN(hDay) && !isNaN(hMonth) && !isNaN(hYear)) hijriMonthlyAnchors.push({ sYear:year, sMonth:month, sDay:day, hDay, hMonth, hYear });
        });

        const data = {
          headerInfo: { name: document.getElementById('headerName').value, term: document.getElementById('headerTerm').value, other: document.getElementById('headerOther').value },
          startDate: { day: sDay, month: sMonth, year: sYear },
          endDate: { day: parseInt(document.getElementById('endDay').value), month: parseInt(document.getElementById('endMonth').value), year: parseInt(document.getElementById('endYear').value) },
          thursdayOption: document.getElementById('thursdayOption').value,
          customHolidays: customHolidays,
          hijriAnchors: hijriMonthlyAnchors
        };
        
        if(includeInterHolidays){
          const selectedInterHolidays = [];
          document.querySelectorAll('.inter-holiday-check:checked').forEach(checkbox => { selectedInterHolidays.push(checkbox.value); });
          data.selectedInterHolidays = selectedInterHolidays;
        }
        return data;
      }

      function addCustomHoliday() { /* ... same as previous ... */ }
      
      function findAnchorPoints() {
        try {
            setLoading(true, "در حال شناسایی نقاط کلیدی...");
            const data = getFormData();
            const gStart = CalendarUtils.jalaliToGregorian(data.startDate.year, data.startDate.month, data.startDate.day);
            const gEnd = CalendarUtils.jalaliToGregorian(data.endDate.year, data.endDate.month, data.endDate.day);
            
            let anchorPoints = [];
            let processedMonths = new Set();
            
            for (let d = new Date(gStart.getTime()); d <= gEnd; d.setDate(d.getDate() + 1)) {
              const jDate = CalendarUtils.gregorianToJalali(d);
              // Add start date as the very first anchor point
              if (anchorPoints.length === 0) {
                  anchorPoints.push({key: `${jDate.jy}-${jDate.jm}-${jDate.jd}`, year: jDate.jy, month: jDate.jm, day: jDate.jd });
              }
              // Add first day of subsequent months
              const monthKey = `${jDate.jy}-${jDate.jm}`;
              if (jDate.jd === 1 && !processedMonths.has(monthKey)) {
                  const firstAnchorKey = `${anchorPoints[0].year}-${anchorPoints[0].month}-${anchorPoints[0].day}`;
                  if (`${jDate.jy}-${jDate.jm}-${jDate.jd}` !== firstAnchorKey) {
                      anchorPoints.push({key: monthKey, year: jDate.jy, month: jDate.jm, day: 1 });
                  }
                  processedMonths.add(monthKey);
              }
            }
            onAnchorPointsFound(anchorPoints);
        } catch(e) { onFailure(e); }
      }

      function onAnchorPointsFound(anchorPoints) {
        setLoading(false);
        const container = document.getElementById('hijriAnchorsContainer');
        container.innerHTML = '<p>لطفا برای هر <b>نقطه کلیدی</b> زیر، تاریخ قمری معادل آن را وارد کنید:</p>';
        if (anchorPoints.length > 0) {
          anchorPoints.forEach(p => {
            const row = document.createElement('div'); row.className = 'form-row hijri-anchor-row';
            row.dataset.year = p.year; row.dataset.month = p.month; row.dataset.day = p.day;
            const label = `${p.day} ${CalendarUtils.getJalaliMonthName(p.month)} ${p.year}`;
            row.innerHTML = `<div class="col-md-4"><label class="col-form-label">${label}</label></div><div class="col-md-3"><input type="number" class="form-control h-day" placeholder="روز قمری"></div><div class="col-md-3"><input type="number" class="form-control h-month" placeholder="ماه قمری"></div><div class="col-md-2"><input type="number" class="form-control h-year" placeholder="سال ق"></div>`;
            container.appendChild(row);
          });
          document.getElementById('findInterBtn').disabled = false;
          $('#collapseThree').collapse('hide');
          $('#collapseFour').collapse('show');
        } else { onFailure({message: "هیچ نقطه کلیدی یافت نشد."}); }
      }

      function findInterHolidays() { /* ... same as previous ... */ }
      function onInterHolidaysFound(potentialDays) { /* ... same as previous ... */ }
      
      function generate() { /* ... same as previous ... */ }
      function processAndPrepareExcelData(data) { /* ... same as previous ... */ }
      
      function onSuccess(fileName) { /* ... same as previous ... */ }
      function onFailure(error) { /* ... same as previous ... */ }
      function setLoading(isLoading, message = "") { /* ... same as previous ... */ }
      
      // Paste full function bodies from the previous correct response
      // This is where all the previous functions should be fully written out.
      
    </script>
</body>
</html>
