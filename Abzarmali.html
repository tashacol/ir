
<!DOCTYPE html> 
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مدیریت سرمایه تعالی</title>
    <!-- فونت وزیرمتن -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <!-- آیکون‌ها -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- نمودار -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- تبدیل به عکس -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-body: #f1f5f9;
            --glass-bg: rgba(255, 255, 255, 0.98);
            --glass-border: 1px solid rgba(255, 255, 255, 1);
            --shadow-soft: 0 4px 15px rgba(148, 163, 184, 0.15);
            --shadow-card: 0 10px 30px rgba(0, 0, 0, 0.08);
            --primary: #3730a3; /* Indigo 800 - Bank Style */
            --primary-dark: #312e81;
            --primary-light: #6366f1;
            --text-main: #0f172a;
            --text-sec: #64748b;
            --success: #059669;
            --danger: #dc2626;
            --warning: #d97706;
            --info: #0284c7;
            --card-radius: 16px;
            --nav-height: 75px;
        }

        [data-theme="dark"] {
            --bg-body: #0f172a;
            --glass-bg: rgba(30, 41, 59, 0.98);
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --text-main: #f8fafc;
            --text-sec: #94a3b8;
            --primary: #6366f1;
            --primary-light: #818cf8;
            --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.4);
        }

        * {
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0 0 var(--nav-height) 0;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.3s ease;
        }

        /* --- Loading Overlay --- */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(10px);
            z-index: 20000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .loading-overlay.active {
            display: flex;
            opacity: 1;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--primary-light);
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
            box-shadow: 0 0 20px rgba(79, 70, 229, 0.4);
        }

        .loading-text {
            margin-top: 20px;
            color: white;
            font-weight: bold;
            font-size: 1rem;
            letter-spacing: 1px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
            animation: pulse 1.5s infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; transform: scale(1.05); }
        }

        /* --- Toast Notification --- */
        .toast-container {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 12000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: rgba(30, 41, 59, 0.95);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 0.9rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast i {
            color: var(--success);
        }

        /* --- Components --- */
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 40px;
        }

        .glass-panel {
            background: var(--glass-bg);
            border: var(--glass-border);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-soft);
            padding: 20px;
            margin-bottom: 24px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(0,0,0,0.06);
        }

        [data-theme="dark"] .header-row {
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }

        .header-row h3 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 800;
        }

        /* Buttons */
        .btn {
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            box-shadow: 0 4px 12px rgba(55, 48, 163, 0.15);
            min-height: 46px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.97);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--text-sec);
            color: var(--text-sec);
            box-shadow: none;
            opacity: 0.8;
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(55, 48, 163, 0.05);
            opacity: 1;
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
            box-shadow: none;
        }

        .btn-danger:hover {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
            box-shadow: none;
        }

        .btn-success:hover {
            background: var(--success);
            color: white;
        }

        .btn-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: var(--glass-bg);
            border: var(--glass-border);
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-soft);
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(55, 48, 163, 0.25);
        }

        .btn-small-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-right: 5px;
            font-size: 0.9rem;
            transition: all 0.2s;
            border: none;
        }

        .btn-edit { color: var(--warning); background: rgba(245, 158, 11, 0.15); }
        .btn-del { color: var(--danger); background: rgba(239, 68, 68, 0.15); }
        .btn-settings { color: var(--primary); background: rgba(79, 70, 229, 0.15); }
        .btn-copy { color: var(--text-sec); background: rgba(100, 116, 139, 0.15); }
        .btn-copy:hover { background: var(--text-main); color: white; }
        .btn-check { color: var(--success); background: rgba(16, 185, 129, 0.15); }
        .btn-check:hover { background: var(--success); color: white; }
        
        .btn-charge {
            background: rgba(14, 165, 233, 0.1);
            color: var(--info);
            border: 1px solid rgba(14, 165, 233, 0.2);
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: 0.2s;
        }
        .btn-charge:hover {
            background: var(--info);
            color: white;
        }

        .currency-toggle-btn {
            background: var(--glass-bg);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }

        .currency-toggle-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 15px rgba(55, 48, 163, 0.3);
        }

        /* Inputs */
        input, select {
            background: var(--bg-body);
            border: 1px solid transparent;
            color: var(--text-main);
            padding: 16px;
            border-radius: 14px;
            font-size: 1rem;
            width: 100%;
            margin-bottom: 15px;
            transition: all 0.2s;
            font-weight: 500;
        }

        input:focus, select:focus {
            border-color: var(--primary);
            background: var(--glass-bg);
            box-shadow: 0 0 0 3px rgba(55, 48, 163, 0.1);
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            margin: 15px 0;
            background: transparent;
            box-shadow: none;
            border:none;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            margin-top: -10px;
            box-shadow: 0 4px 10px rgba(55, 48, 163, 0.4);
            border: 3px solid white;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 3px;
        }

        .date-picker-row { display: flex; gap: 8px; direction: ltr; }
        .date-picker-row select { flex: 1; padding: 12px; font-size: 0.9rem; direction: rtl; text-align: center; }

        .money-input-wrapper { position: relative; margin-bottom: 15px; }
        .money-input-wrapper input { padding-left: 80px; margin-bottom: 0; direction: ltr; text-align: right; font-weight: 800; letter-spacing: 1px; font-size: 1.1rem; }
        .money-unit {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            font-size: 0.8rem;
            font-weight: bold;
            pointer-events: none;
            background: rgba(55, 48, 163, 0.1);
            padding: 6px 10px;
            border-radius: 10px;
        }

        .search-bar { position: relative; margin-bottom: 15px; }
        .search-bar input { padding-right: 40px; margin-bottom: 0; background: rgba(0,0,0,0.03); border: 1px solid transparent; }
        .search-bar i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-sec); pointer-events: none; }

        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.02); border-radius: 12px; cursor: pointer; }
        .checkbox-wrapper input[type="checkbox"] { width: 24px; height: 24px; margin: 0; cursor: pointer; }

        /* --- Lock Screen --- */
        .pin-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .auth-card {
            background: var(--glass-bg);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 32px;
            padding: 40px 30px;
            width: 100%;
            max-width: 350px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            transform: translateY(0);
            animation: floatAuth 0.6s ease-out;
        }

        @keyframes floatAuth { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .auth-avatar {
            width: 70px;
            height: 70px;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            margin-bottom: 15px;
            box-shadow: 0 10px 25px rgba(55, 48, 163, 0.3);
        }

        .auth-link { margin-top: 20px; color: var(--text-sec); font-size: 0.8rem; cursor: pointer; transition: 0.2s; }
        .auth-link:hover { color: var(--primary); }

        /* --- Identity Card Styles --- */
        .identity-card-container {
            width: 100%;
            max-width: 350px;
            border-radius: 20px;
            overflow: hidden;
            background: linear-gradient(135deg, #1e293b, #0f172a);
            color: white;
            font-family: 'Vazirmatn', sans-serif;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            margin: 0 auto;
        }

        .id-card-header {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            text-align: center;
            font-weight: bold;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display:flex;
            align-items:center;
            justify-content:center;
            gap:8px;
        }

        .id-card-body { padding: 20px; }
        .id-row { margin-bottom: 15px; }
        .id-label { font-size: 0.75rem; color: #94a3b8; display: block; margin-bottom: 4px; }
        .id-value { font-size: 1.1rem; font-weight: bold; color: white; letter-spacing: 0; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .id-value-big { font-size: 1.4rem; color: #fbbf24; letter-spacing: 2px; direction: ltr; font-family: monospace; display: block; }

        .id-footer {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            text-align: center;
            font-size: 0.75rem;
            color: #64748b;
            display: flex;
            justify-content: space-around;
        }

        /* --- Bank Card --- */
        .hero-card { perspective: 1500px; height: 240px; margin-bottom: 30px; cursor: pointer; }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: right;
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d;
            border-radius: 28px;
            box-shadow: 0 25px 50px -12px rgba(55, 48, 163, 0.5);
        }

        .hero-card.flipped .card-inner { transform: rotateY(180deg); }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 28px;
            padding: 25px;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            overflow: hidden;
        }

        .card-front {
            background: linear-gradient(110deg, #1e3a8a 0%, #3b82f6 100%);
            background-image: radial-gradient(circle at 10% 20%, rgba(255,255,255,0.1) 0%, transparent 20%), radial-gradient(circle at 90% 80%, rgba(255,255,255,0.1) 0%, transparent 20%), linear-gradient(110deg, #0f172a 0%, #1e40af 100%);
        }

        .card-front::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .card-chip {
            width: 50px;
            height: 38px;
            background: linear-gradient(135deg, #fbbf24 0%, #d97706 50%, #fbbf24 100%);
            border-radius: 6px;
            position: relative;
            box-shadow: inset 0 1px 2px rgba(255,255,255,0.4), 0 2px 5px rgba(0,0,0,0.2);
            border: 1px solid rgba(0,0,0,0.1);
        }

        .card-chip::after { content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: rgba(0,0,0,0.3); }
        .card-chip::before { content: ''; position: absolute; left: 30%; top: 0; height: 100%; width: 1px; background: rgba(0,0,0,0.3); }

        .card-number-top {
            font-family: 'Vazirmatn', sans-serif;
            font-size: 1.2rem;
            letter-spacing: 2px;
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .card-back {
            background: #0f172a;
            transform: rotateY(180deg);
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .balance-label { font-size: 0.9rem; opacity: 0.8; font-weight: 500; display:block; margin-bottom:2px; text-align: center; }
        .balance-wrapper { display: flex; justify-content: center; align-items: center; gap: 12px; margin: 5px 0; width: 100%; }
        .balance-value {
            font-size: clamp(1.4rem, 4vw, 2rem);
            font-weight: 800;
            text-shadow: 0 4px 10px rgba(0,0,0,0.3);
            letter-spacing: -1px;
            font-family: 'Vazirmatn', sans-serif;
            white-space: nowrap;
            overflow-x: auto;
            scrollbar-width: none;
            text-align: center;
        }
        .balance-value::-webkit-scrollbar { display: none; }
        .balance-currency { font-size: 1rem; font-weight: 400; opacity: 0.9; }

        #eyeIcon { cursor: pointer; font-size: 1.1rem; opacity: 0.7; transition: 0.2s; padding: 5px; }
        #eyeIcon:hover { opacity: 1; transform: scale(1.1); }

        /* Modified Card Icons Style */
        .card-icon-btn {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.4rem;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.2s, opacity 0.2s;
            opacity: 0.85;
        }
        .card-icon-btn:hover { transform: scale(1.1); opacity: 1; }

        /* --- BENTO GRID (Budget) --- */
        .budget-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100%, 1fr)); gap: 20px; }
        @media(min-width: 600px) { .budget-grid { grid-template-columns: 1fr 1fr; } }

        .bento-item {
            background: var(--glass-bg);
            border: var(--glass-border);
            border-radius: 22px;
            padding: 20px;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: var(--shadow-soft);
            transition: all 0.3s;
        }

        .bento-item:hover { transform: translateY(-5px); box-shadow: var(--shadow-card); }
        .bento-item.paused { opacity: 0.7; filter: grayscale(1); border: 2px dashed var(--text-sec); }

        .bento-header { display: flex; justify-content: space-between; align-items: center; font-weight: 800; font-size: 1.1rem; color: var(--text-main); }

        .progress-bar { height: 14px; background: rgba(0,0,0,0.06); border-radius: 10px; overflow: hidden; margin: 5px 0; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        .progress-fill { height: 100%; transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 10px; }

        .stat-green .progress-fill { background: linear-gradient(90deg, var(--success), #34d399); }
        .stat-yellow .progress-fill { background: linear-gradient(90deg, var(--warning), #fbbf24); }
        .stat-red .progress-fill { background: linear-gradient(90deg, var(--danger), #f87171); }

        .bento-actions { margin-top: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        .action-chip {
            padding: 10px;
            font-size: 0.8rem;
            border-radius: 12px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            font-weight: 700;
            white-space: nowrap;
            transition: 0.2s;
        }

        .action-btn-exp { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .action-btn-exp:hover { background: var(--danger); color: white; }

        .action-btn-copy { background: rgba(79, 70, 229, 0.1); color: var(--primary); }
        .action-btn-copy:hover { background: var(--primary); color: white; }

        .action-btn-add { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .action-btn-add:hover { background: var(--success); color: white; }

        .action-btn-pause { background: rgba(148, 163, 184, 0.1); color: var(--text-sec); }
        .action-btn-pause:hover { background: var(--text-sec); color: white; }

        .action-btn-sub { background: rgba(245, 158, 11, 0.1); color: var(--warning); grid-column: span 2; }
        .action-btn-sub:hover { background: var(--warning); color: white; }

        .action-btn-transfer { background: rgba(14, 165, 233, 0.1); color: var(--info); }
        .action-btn-transfer:hover { background: var(--info); color: white; }

        .action-btn-zero { background: rgba(0,0,0,0.1); color: var(--text-main); }
        .action-btn-zero:hover { background: var(--text-main); color: white; }

        /* Sub-Budget Styles */
        .sub-budget-bar { display: flex; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 5px; background: rgba(0,0,0,0.05); }
        .sub-budget-seg { height: 100%; transition: width 0.3s; }
        .sub-budget-legend { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px; font-size: 0.75rem; color: var(--text-sec); }
        .sub-legend-item { display: flex; align-items: center; gap: 4px; }
        .sub-dot { width: 8px; height: 8px; border-radius: 50%; }

        /* Animation for Due Items */
        @keyframes pulse-yellow { 0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); } 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        .pulse-warning { animation: pulse-yellow 2s infinite; border: 2px solid var(--warning); }
        .pulse-danger { animation: pulse-red 1.5s infinite; border: 2px solid var(--danger); }

        .bg-yellow-highlight { background: rgba(245, 158, 11, 0.1) !important; border: 1px solid var(--warning) !important; }
        .bg-green-highlight { background: rgba(16, 185, 129, 0.1) !important; border: 1px solid var(--success) !important; }

        .status-overdue { border: 2px solid var(--danger); background: rgba(239, 68, 68, 0.05); }
        .status-due { border: 2px solid var(--success); background: rgba(16, 185, 129, 0.05); }

        /* --- Template Chips --- */
        .template-row { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; margin-bottom: 10px; scrollbar-width: none; }
        .template-chip { white-space: nowrap; padding: 8px 18px; border-radius: 50px; background: var(--glass-bg); border: 1px solid var(--primary); color: var(--primary); font-size: 0.85rem; font-weight: 700; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .template-chip:hover { background: var(--primary); color: white; transform: scale(1.05); }

        /* --- BOTTOM NAV --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--nav-height);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-top: 1px solid rgba(255,255,255,0.5);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 9000;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.05);
            padding-bottom: 15px;
        }

        [data-theme="dark"] .bottom-nav { background: rgba(15, 23, 42, 0.9); border-top: 1px solid rgba(255,255,255,0.05); }

        .nav-btn {
            background: none;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            color: var(--text-sec);
            font-size: 0.75rem;
            cursor: pointer;
            width: 60px;
            font-weight: bold;
            opacity: 0.6;
            transition: 0.3s;
        }

        .nav-btn i { font-size: 1.4rem; margin-bottom: 4px; transition: transform 0.2s; padding: 8px; border-radius: 12px; }
        .nav-btn.active { color: var(--primary); opacity: 1; }
        .nav-btn.active i { background: rgba(79, 70, 229, 0.1); transform: translateY(-5px); }

        /* --- MODALS --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 11000;
            display: none;
            justify-content: center;
            align-items: flex-end;
            backdrop-filter: blur(8px);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal.active { display: flex; opacity: 1; }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            width: 100%;
            max-width: 600px;
            padding: 35px 25px;
            border-radius: 35px 35px 0 0;
            border-top: 1px solid rgba(255,255,255,0.6);
            box-shadow: 0 -20px 80px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        }
        [data-theme="dark"] .modal-content { border-top: 1px solid rgba(255,255,255,0.1); }
        .modal.active .modal-content { transform: translateY(0); }

        .tab-pane { display: none; padding-bottom: 20px; animation: fadeIn 0.4s ease; }
        .tab-pane.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* --- REPORT (PRINT) --- */
        #printArea {
            position: absolute;
            top: -9999px;
            left: -9999px;
            width: 800px;
            background: white;
            color: black;
            padding: 40px;
            border: 2px solid #333;
            font-family: 'Tahoma', sans-serif;
            z-index: 99999;
        }

        .print-header { text-align: center; border-bottom: 2px solid #000; margin-bottom: 20px; padding-bottom: 15px; }
        .print-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .print-table th { background: #eee; border: 1px solid #000; padding: 10px; }
        .print-table td { border: 1px solid #000; padding: 8px; text-align: center; }
        .print-summary { display: flex; justify-content: space-between; margin-top: 20px; font-weight: bold; border: 1px solid #000; padding: 10px; background: #f9f9f9; }
        .print-section-title { font-weight: bold; margin-top: 20px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
        .print-chart-container { width: 100%; height: 300px; margin-top: 20px; border: 1px dashed #ccc; padding: 10px; }

        .history-btn {
            font-size: 0.8rem;
            background: rgba(79, 70, 229, 0.1);
            color: var(--primary);
            padding: 6px 14px;
            border-radius: 20px;
            cursor: pointer;
            margin-left: 10px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: 0.2s;
            border: 1px solid transparent;
        }
        .history-btn:hover { background: var(--primary); color: white; border-color: var(--primary-light); }

        .auth-input-group { width: 100%; margin-bottom: 20px; text-align: center; }
        .auth-label { display: block; text-align: right; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 8px; margin-right: 5px; font-weight: bold; }

        .alloc-info-box {
            background: rgba(79, 70, 229, 0.05);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px dashed var(--primary);
            color: var(--primary);
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
        }
        .sub-budget-row { background:rgba(0,0,0,0.03); padding:10px; border-radius:12px; margin-bottom:10px; display:flex; gap:8px; align-items:center; }
        .sub-budget-calc-display { font-size: 0.85rem; color: var(--text-sec); margin-right: 5px; flex: 1.5; text-align: left; }

        /* Modern Settings Styles */
        .settings-header-card {
            background: linear-gradient(120deg, var(--primary-dark), var(--primary));
            border-radius: 20px;
            padding: 25px;
            color: white;
            margin-bottom: 25px;
            box-shadow: 0 10px 25px rgba(55, 48, 163, 0.3);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .settings-header-icon { width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .settings-list { display: flex; flex-direction: column; gap: 15px; }
        .settings-group { background: var(--glass-bg); border: var(--glass-border); border-radius: 18px; overflow: hidden; box-shadow: var(--shadow-soft); }
        .settings-group-title { padding: 15px 20px 5px 20px; font-size: 0.85rem; color: var(--text-sec); font-weight: 800; }
        .settings-item { padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.04); transition: background 0.2s; }
        .settings-item:last-child { border-bottom: none; }
        .settings-item:hover { background: rgba(0,0,0,0.02); }
        .settings-item-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-left: 15px; font-size: 1.1rem; }
        .settings-text { font-weight: 600; font-size: 0.95rem; }
        .settings-chevron { color: var(--text-sec); font-size: 0.8rem; opacity: 0.5; }
        .si-blue { background: rgba(79, 70, 229, 0.1); color: var(--primary); }
        .si-green { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .si-red { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .si-orange { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .si-gray { background: rgba(100, 116, 139, 0.1); color: var(--text-sec); }

        /* Details Modal Row */
        .detail-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { font-size: 0.9rem; color: var(--text-sec); font-weight: 500; }
        .detail-val { font-weight: 700; color: var(--text-main); font-size: 1rem; direction: ltr; }

        /* Complete Goal Badge */
        .complete-badge { background: var(--success); color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; margin-right: 5px; }

        /* Charts Container */
        .chart-wrapper {
            background: var(--glass-bg);
            border: var(--glass-border);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-soft);
            height: 300px;
            position: relative;
        }

        /* --- Receipt & Transfer Styles --- */
        .receipt-card {
            background: white;
            color: #1e293b;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 320px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
            font-family: 'Vazirmatn', sans-serif;
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        .receipt-header { border-bottom: 2px dashed #cbd5e1; padding-bottom: 15px; margin-bottom: 15px; }
        .receipt-title { font-size: 1.1rem; font-weight: 800; color: var(--primary); margin: 0; }
        .receipt-status { font-size: 0.9rem; font-weight: bold; margin-top: 5px; padding: 4px 12px; border-radius: 20px; display: inline-block; }
        .status-success { background: #dcfce7; color: #166534; }
        .status-fail { background: #fee2e2; color: #991b1b; }
        .receipt-amount { font-size: 1.8rem; font-weight: 900; color: var(--text-main); margin: 15px 0; direction: ltr; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.85rem; }
        .receipt-label { color: #64748b; font-weight: 500; }
        .receipt-val { font-weight: 700; direction: ltr; }

        .transfer-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--glass-bg);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .t-info h4 { margin: 0; font-size: 0.95rem; color: var(--text-main); }
        .t-info p { margin: 4px 0 0 0; font-size: 0.8rem; color: var(--text-sec); }
        .t-amount { font-weight: 800; direction: ltr; font-size: 1rem; }
        .t-status { font-size: 0.75rem; padding: 2px 8px; border-radius: 8px; font-weight: bold; margin-right: 5px; }
        .ts-pending { background: #fef9c3; color: #854d0e; }
        .ts-approved { background: #dcfce7; color: #166534; }
        .ts-rejected { background: #fee2e2; color: #991b1b; }

        /* Timeline History Styles - Updated for Instruction 1 */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            margin-top: 10px;
        }
        .history-table th {
            text-align: right;
            padding: 10px;
            color: var(--text-sec);
            border-bottom: 2px solid rgba(0,0,0,0.1);
            font-weight: bold;
        }
        .history-table td {
            padding: 12px 10px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            vertical-align: middle;
        }
        .history-table tr:last-child td { border-bottom: none; }
        .history-table tr:hover { background: rgba(0,0,0,0.02); cursor: pointer; }
        .ht-icon { width: 30px; height: 30px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; }
        .ht-inc { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .ht-exp { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .ht-trf { background: rgba(14, 165, 233, 0.15); color: var(--info); }
        .ht-amount { font-weight: bold; direction: ltr; }
        .ht-date { font-size: 0.75rem; color: var(--text-sec); display: block; margin-top: 2px; }

        /* Installment Detail Styles */
        .inst-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            transition: 0.2s;
        }
        .inst-row:hover { background: rgba(0,0,0,0.02); }
        .inst-status { font-size: 0.75rem; padding: 3px 8px; border-radius: 12px; font-weight: bold; }
        .is-paid { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .is-due { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .is-over { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .inst-penalty { font-size: 0.75rem; color: var(--danger); display: block; margin-top: 2px; }

        /* Instruction 1: Organized Debt Cards */
        .debt-card {
            margin-bottom: 15px;
            background: #fff;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid #eee;
            transition: transform 0.2s;
        }
        .debt-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        [data-theme="dark"] .debt-card {
            background: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">درحال پردازش...</div>
</div>
<div id="toastContainer" class="toast-container"></div>

<!-- 1. AUTH SCREEN -->
<div id="authModal" class="pin-screen" style="display: flex;">
    <div class="auth-card">
        <div class="auth-avatar" id="authIcon">
            <i class="fas fa-fingerprint"></i>
        </div>
        <h2 id="authTitle" style="margin: 0 0 5px 0; color: var(--primary); font-size: 1.4rem;">مدیریت سرمایه</h2>
        <p id="authSub" style="font-size: 0.9rem; color: var(--text-sec); margin-bottom: 25px;">لطفاً وارد شوید یا ثبت نام کنید</p>

        <!-- Initial Buttons -->
        <div id="authInitial" style="width:100%;">
            <!-- Biometric Login Button (Moved here for better UX) -->
            <button id="bioLoginBtnInitial" class="btn btn-success" style="width:100%; margin-bottom:10px; display:none;" onclick="loginWithBiometric()">
                <i class="fas fa-fingerprint"></i> ورود با اثر انگشت
            </button>
            <button class="btn btn-primary" style="width:100%; margin-bottom:10px;" onclick="showLoginForm()">ورود با رمز عبور</button>
            <button class="btn btn-outline" style="width:100%;" onclick="showRegisterForm()">ثبت نام جدید</button>
        </div>

        <!-- Login Form -->
        <div id="loginForm" style="display:none; width:100%;">
            <label class="auth-label">کد ملی (۱۰ رقم):</label>
            <input type="text" id="loginNatId" inputmode="numeric" pattern="[0-9]*" maxlength="10" placeholder="کد ملی خود را وارد کنید">
            <label class="auth-label">رمز عبور (۴ رقم):</label>
            <input type="password" id="loginPass" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="رمز عبور...">
            
            <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="processLogin()">ورود</button>
            <button class="btn btn-outline" style="width:100%; margin-top:10px;" onclick="resetAuthView()">بازگشت</button>
            
            <div class="auth-link" onclick="startRecovery()" style="margin-top:15px; text-align:center;">رمز عبور را فراموش کردم؟</div>
        </div>

        <!-- Registration Steps -->
        <div id="authStep1" style="display:none; width:100%;">
            <input type="hidden" id="setupStepVal" value="1">
            <div id="setupS1">
                <label class="auth-label">مرحله ۱: نام و نام خانوادگی</label>
                <input type="text" id="setupNameInput" placeholder="نام خود را وارد کنید" style="padding:12px; border-radius:12px;">
            </div>
            <div id="setupS2" style="display:none;">
                <label class="auth-label">مرحله ۲: کد ملی (۱۰ رقم)</label>
                <input type="text" id="setupNatId" inputmode="numeric" pattern="[0-9]*" maxlength="10" placeholder="کد ملی خود را وارد کنید" style="padding:12px; border-radius:12px;">
            </div>
            <div id="setupS3" style="display:none;">
                <label class="auth-label">مرحله ۳: تعیین رمز عبور (۴ رقم)</label>
                <input type="password" id="setupPassword" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="رمز عبور ۴ رقمی" style="padding:12px; border-radius:12px;">
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn btn-outline" style="flex:1;" onclick="resetAuthView()">انصراف</button>
                <button class="btn btn-primary" style="flex:1;" onclick="nextSetupStep()" id="setupNextBtn">بعدی</button>
            </div>
        </div>

        <!-- Actions -->
        <div id="authActions" style="width:100%; margin-top:10px;">
        </div>
    </div>
</div>

<!-- 2. MAIN APP -->
<div class="container" id="appContent" style="display:none;">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-top: 10px;">
        <div style="display:flex; flex-direction:column;">
            <h2 style="margin:0; color:var(--primary); font-weight:900; font-size:1.3rem;" id="headerDate">---</h2>
            <!-- Instruction 5: Removed daysPassedLabel -->
        </div>
        <div style="display:flex; gap:10px; align-items: center;">
            <button class="currency-toggle-btn" id="currBtn" onclick="toggleCurrency()" title="تغییر واحد پول">
                <i class="fas fa-coins"></i>
                <span id="currBtnText">تومان</span>
            </button>
            <!-- Instruction 3: Update Icon with new logic -->
            <button class="btn-icon" onclick="refreshAppData()" title="بروزرسانی">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="btn-icon" style="color:var(--danger); border-color:rgba(220,38,38,0.3);" onclick="logout()" title="خروج">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </div>

    <!-- TAB 1: DASHBOARD -->
    <div id="view-dashboard" class="tab-pane active">
        <!-- Hero Card -->
        <div class="hero-card">
            <div class="card-inner">
                <div class="card-front" onclick="if(!event.target.closest('button') && !event.target.closest('.fa-eye') && !event.target.closest('.fa-copy') && !event.target.closest('.card-icon-btn')) showCardDetails()">
                    <div class="card-number-top" id="cardAccountNumber">
                        <span id="accNumText">۰۰۰۰ ۰۰۰۰ ۰۰۰۰ ۰۰۰۰</span>
                        <i class="fas fa-copy" style="font-size:1rem; cursor:pointer; opacity:0.8;" onclick="copyToClipboard(document.getElementById('accNumText').innerText)"></i>
                    </div>

                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-top:10px;">
                        <div class="card-chip"></div>
                        <i class="fas fa-wifi" style="opacity:0.7; transform: rotate(90deg); font-size:1.5rem;"></i>
                    </div>

                    <div style="margin-top: auto; text-align:center;"> 
                        <span class="balance-label">موجودی</span>
                        <div class="balance-wrapper">
                            <div class="balance-value" id="totalBalance">۰</div>
                            <span class="balance-currency currency-text" id="cardCurrency">تومان</span>
                            <i class="fas fa-eye" id="eyeIcon" onclick="toggleBalanceHide(event)"></i>
                        </div>
                    </div>

                    <!-- Instruction 3: Modified Card Bottom Layout -->
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                        <div style="display:flex; gap:15px;">
                            <button class="card-icon-btn" onclick="openBankTransfer(event)" title="انتقال وجه">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                            <button class="card-icon-btn" onclick="openGlobalHistory(event)" title="تراکنش‌ها">
                                <i class="fas fa-history"></i>
                            </button>
                        </div>
                        
                        <!-- Name Display with Auto-Resize Logic -->
                        <div style="flex:1; text-align:left; overflow:hidden; white-space:nowrap;">
                            <span id="userNameDisplay" style="font-weight:bold; opacity:0.9; display:inline-block;">کاربر</span> 
                        </div>
                    </div>
                </div>
                <div class="card-back">
                    <h3 style="margin:0;">خلاصه وضعیت</h3>
                    <p style="margin:5px 0; opacity:0.8;">برای مشاهده جزئیات کلیک کنید</p>
                </div>
            </div>
        </div>

        <div class="header-row">
            <h3>داشبورد <span class="history-btn" onclick="showSectionHistory('dashboard')"><i class="fas fa-history"></i> سابقه</span></h3>
        </div>

        <div class="glass-panel">
            <div class="header-row">
                <h3><i class="fas fa-wallet"></i> منابع مالی (کیف پول)</h3>
                <button class="btn btn-primary" onclick="openModal('walletModal')"><i class="fas fa-plus"></i> افزودن</button>
            </div>
            <div id="walletList"></div>
        </div>

        <div class="glass-panel">
            <div class="header-row">
                <h3><i class="fas fa-file-invoice-dollar"></i> اقساط ثابت (ماهانه)</h3>
                <div style="display:flex; gap:5px;">
                    <button class="btn btn-charge" onclick="openInternalTransfer('اقساط ماهانه')"><i class="fas fa-wallet"></i> شارژ کیف</button>
                    <button class="btn btn-primary" onclick="openModal('debtModal')"><i class="fas fa-plus"></i> افزودن</button>
                </div>
            </div>
            <p style="font-size:0.8rem; color:var(--text-sec); margin-bottom:10px;">توجه: مبلغ این بخش از کیف پول اختصاصی "اقساط ماهانه" پرداخت می‌شود.</p>
            <div id="debtList"></div>
        </div>

        <div class="glass-panel">
            <div class="header-row">
                <h3><i class="fas fa-money-check-alt"></i> چک و بدهی</h3>
                <div style="display:flex; gap:5px;">
                    <button class="btn btn-charge" onclick="openInternalTransfer('چک و بدهی')"><i class="fas fa-wallet"></i> شارژ کیف</button>
                    <button class="btn btn-primary" onclick="openModal('checkModal')"><i class="fas fa-plus"></i> افزودن</button>
                </div>
            </div>
            <p style="font-size:0.8rem; color:var(--text-sec); margin-bottom:10px;">توجه: مبلغ این بخش از کیف پول اختصاصی "چک و بدهی" پرداخت می‌شود.</p>
            <div id="checkList"></div>
        </div>

        <div class="glass-panel">
            <div class="header-row">
                <h3><i class="fas fa-comments-dollar"></i> وجه به وجه</h3>
                <button class="btn btn-primary" style="font-size:0.8rem;" onclick="simulateIncomingTransfer()">+ شبیه‌سازی دریافت</button>
            </div>
            <div id="transfersList" style="max-height: 250px; overflow-y: auto;">
                <p style="text-align:center; color:var(--text-sec); padding:10px;">تراکنشی یافت نشد.</p>
            </div>
        </div>
    </div>

    <!-- TAB 2: BUDGET -->
    <div id="view-budget" class="tab-pane">
        <div class="glass-panel" style="text-align:center; padding: 25px;">
            <span style="color:var(--text-sec); font-size:0.95rem; font-weight:bold;">بودجه کل توزیع شده (خالص):</span>
            <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top:5px;">
                <div id="distributable" style="font-size:2rem; font-weight:800; color:var(--primary); direction:ltr; display: flex; align-items: baseline; gap: 8px;">۰</div>
                <small id="totalPercentBadge" style="background:var(--text-sec); color:white; padding:4px 10px; border-radius:10px; font-weight:bold;">۰%</small>
            </div>
            <p style="font-size:0.75rem; color:var(--warning); margin-top:5px;">(موجودی کیف پول‌های اقساط و بدهی در اینجا محاسبه نمی‌شود)</p>
            <button id="btnDistribute" class="btn btn-primary" style="margin-top:20px; width:100%; display:none; justify-content:center;" onclick="triggerDistribution()">
                <i class="fas fa-sync-alt"></i> توزیع موجودی جدید
            </button>
        </div>

        <div class="header-row" style="margin: 0 5px 20px 5px; flex-direction: column; align-items: flex-start; border:none;">
            <div style="display: flex; justify-content: space-between; width: 100%; align-items: center; margin-bottom:15px;">
                <h3 style="display:flex; align-items:center;">مدیریت ردیف‌ها <span class="history-btn" onclick="showSectionHistory('budget')"><i class="fas fa-history"></i> سابقه</span></h3>
                <button class="btn btn-primary" onclick="openModal('addBudgetModal')"><i class="fas fa-plus"></i> جدید</button>
            </div>

            <div class="template-row" style="width: 100%;">
                <span style="font-size:0.85rem; line-height:34px; margin-left:8px; font-weight:bold; color:var(--text-sec);">قالب‌ها:</span>
                <div class="template-chip" onclick="applyTemplate('default')">پیش‌فرض</div>
                <div class="template-chip" onclick="applyTemplate('student')">دانشجویی</div>
                <div class="template-chip" onclick="applyTemplate('married')">متاهلی</div>
                <div class="template-chip" onclick="applyTemplate('clear')">پاکسازی</div>
            </div>
        </div>

        <div id="budgetGrid" class="budget-grid"></div>
    </div>

    <!-- TAB 3: TOOLS -->
    <div id="view-tools" class="tab-pane">
        <div class="header-row" style="padding:0 5px;">
            <h3>ابزارها <span class="history-btn" onclick="showSectionHistory('tools')"><i class="fas fa-history"></i> سابقه</span></h3>
        </div>

        <div class="glass-panel">
            <div class="header-row">
                <h3><i class="fas fa-bullseye"></i> اهداف پس‌انداز</h3>
                <button class="btn btn-primary" onclick="openModal('goalModal')"><i class="fas fa-plus"></i> هدف</button>
            </div>
            <div id="goalList"></div>
        </div>

        <div class="glass-panel">
            <div class="header-row">
                <h3><i class="fas fa-shopping-cart"></i> لیست خرید</h3>
                <button class="btn btn-primary" onclick="openModal('shopModal')"><i class="fas fa-plus"></i> کالا</button>
            </div>
            <div id="shopList"></div>
        </div>

        <div class="glass-panel">
            <div class="header-row">
                <h3><i class="fas fa-hand-holding-usd"></i> طلب‌ها (قرض داده شده)</h3>
                <button class="btn btn-primary" onclick="openModal('loanModal')"><i class="fas fa-plus"></i> ثبت</button>
            </div>
            <div id="loanList"></div>
        </div>
    </div>

    <!-- TAB 4: REPORTS -->
    <div id="view-reports" class="tab-pane">
        <div class="header-row" style="padding:0 5px;">
            <h3>گزارشات و نمودارها</h3>
        </div>
        <div class="glass-panel">
            <div class="header-row"><h3><i class="fas fa-chart-pie"></i> توزیع مخارج</h3></div>
            <div class="chart-wrapper">
                <canvas id="expenseChart"></canvas>
            </div>
        </div>
        <div class="glass-panel">
            <div class="header-row"><h3><i class="fas fa-chart-line"></i> روند سلامت مالی</h3></div>
            <div class="chart-wrapper">
                <canvas id="netWorthChart"></canvas>
            </div>
        </div>
    </div>

    <!-- TAB 5: SETTINGS -->
    <div id="view-settings" class="tab-pane">
        <div class="settings-header-card">
            <div class="settings-header-icon"><i class="fas fa-user-circle"></i></div>
            <div>
                <h2 style="margin:0; font-size:1.3rem;" id="settingsUserName">کاربر</h2>
                <span style="font-size:0.9rem; opacity:0.8; letter-spacing:1px;" id="settingsNatId">---</span>
            </div>
        </div>

        <div class="settings-list">
            <div class="settings-group-title">عمومی و حسابداری</div>
            <div class="settings-group">
                <!-- Instruction 5: Night Mode moved here -->
                <div class="settings-item" onclick="toggleTheme()">
                    <div style="display:flex; align-items:center;">
                        <div class="settings-item-icon si-blue"><i class="fas fa-moon"></i></div>
                        <div class="settings-text">حالت شب / روز</div>
                    </div>
                    <i class="fas fa-chevron-left settings-chevron"></i>
                </div>
                <!-- New: Biometric Settings -->
                <div class="settings-item" onclick="setupBiometric()">
                    <div style="display:flex; align-items:center;">
                        <div class="settings-item-icon si-green"><i class="fas fa-fingerprint"></i></div>
                        <div class="settings-text">ورود با اثرانگشت</div>
                    </div>
                    <i class="fas fa-chevron-left settings-chevron"></i>
                </div>
                <div class="settings-item" onclick="openPrioritySettings()">
                    <div style="display:flex; align-items:center;">
                        <div class="settings-item-icon si-orange"><i class="fas fa-sort-amount-up"></i></div>
                        <div class="settings-text">مدیریت اولویت‌ها</div>
                    </div>
                    <i class="fas fa-chevron-left settings-chevron"></i>
                </div>
                <div class="settings-item" onclick="changeecUserName()">
                    <div style="display:flex; align-items:center;">
                        <div class="settings-item-icon si-blue"><i class="fas fa-user-edit"></i></div>
                        <div class="settings-text">تغییر نام</div>
                    </div>
                    <i class="fas fa-chevron-left settings-chevron"></i>
                </div>
                <label class="settings-item" style="cursor:pointer; display:flex;">
                    <div style="display:flex; align-items:center;">
                        <div class="settings-item-icon si-gray"><i class="fas fa-copy"></i></div>
                        <div class="settings-text">کپی ارقام بدون ممیز</div>
                    </div>
                    <input type="checkbox" id="rawCopyCheck" style="width:20px; height:20px; margin:0;">
                </label>
            </div>

            <div class="settings-group-title">داده‌ها و گزارش</div>
            <div class="settings-group">
                <div class="settings-item" onclick="exportExcel()">
                    <div style="display:flex; align-items:center;">
                        <div class="settings-item-icon si-green"><i class="fas fa-file-excel"></i></div>
                        <div class="settings-text">فایل اکسل</div>
                    </div>
                    <i class="fas fa-chevron-left settings-chevron"></i>
                </div>
                <div class="settings-item" onclick="generateReportImage()">
                    <div style="display:flex; align-items:center;">
                        <div class="settings-item-icon si-blue"><i class="fas fa-file-image"></i></div>
                        <div class="settings-text">فایل تصویری</div>
                    </div>
                    <i class="fas fa-chevron-left settings-chevron"></i>
                </div>
                <div class="settings-item" onclick="downloadBackup()">
                    <div style="display:flex; align-items:center;">
                        <div class="settings-item-icon si-green"><i class="fas fa-download"></i></div>
                        <div class="settings-text">پشتیبان‌گیری (Backup)</div>
                    </div>
                    <i class="fas fa-chevron-left settings-chevron"></i>
                </div>
                <label class="settings-item">
                    <div style="display:flex; align-items:center;">
                        <div class="settings-item-icon si-green"><i class="fas fa-upload"></i></div>
                        <div class="settings-text">بازیابی اطلاعات</div>
                    </div>
                    <input type="file" id="restoreFile" style="display:none" onchange="restoreBackup(this)">
                    <i class="fas fa-chevron-left settings-chevron"></i>
                </label>
                <div class="settings-item" onclick="showHistory()">
                    <div style="display:flex; align-items:center;">
                        <div class="settings-item-icon si-gray"><i class="fas fa-history"></i></div>
                        <div class="settings-text">تاریخچه بکاپ‌ها</div>
                    </div>
                    <i class="fas fa-chevron-left settings-chevron"></i>
                </div>
            </div>

            <div class="settings-group-title">امنیت</div>
            <div class="settings-group">
                <div class="settings-item" onclick="changePassword()">
                    <div style="display:flex; align-items:center;">
                        <div class="settings-item-icon si-orange"><i class="fas fa-key"></i></div>
                        <div class="settings-text">تغییر رمز ورود</div>
                    </div>
                    <i class="fas fa-chevron-left settings-chevron"></i>
                </div>
                <div class="settings-item" onclick="resetAll()">
                    <div style="display:flex; align-items:center;">
                        <div class="settings-item-icon si-red"><i class="fas fa-trash-alt"></i></div>
                        <div class="settings-text" style="color:var(--danger)">پاکسازی تمام سیستم</div>
                    </div>
                    <i class="fas fa-chevron-left settings-chevron"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
    <button class="nav-btn active" onclick="switchTab('dashboard')"><i class="fas fa-home"></i> داشبورد</button>
    <button class="nav-btn" onclick="switchTab('budget')"><i class="fas fa-chart-pie"></i> بودجه</button>
    <button class="nav-btn" onclick="switchTab('reports')"><i class="fas fa-chart-bar"></i> گزارشات</button>
    <button class="nav-btn" onclick="switchTab('tools')"><i class="fas fa-tools"></i> ابزارها</button>
    <button class="nav-btn" onclick="switchTab('settings')"><i class="fas fa-cog"></i> تنظیمات</button>
</nav>

<!-- MODALS -->

<!-- GLOBAL HISTORY MODAL (Instruction 1: Redesigned) -->
<div id="globalHistoryModal" class="modal">
    <div class="modal-content">
        <h3>تاریخچه تراکنش‌ها</h3>
        <div class="search-bar">
            <input type="text" id="globalHistSearch" onkeyup="filterGlobalHistory()" placeholder="جستجو (شناسه، توضیحات)...">
            <i class="fas fa-search"></i>
        </div>
        <p style="font-size:0.85rem; color:var(--text-sec); margin-bottom:15px;">برای مشاهده رسید روی تراکنش کلیک کنید.</p>
        <div id="globalHistoryList" style="max-height:400px; overflow-y:auto;">
            <!-- Rendered via JS as Table -->
        </div>
        <button class="btn btn-outline" style="width:100%; margin-top:20px;" onclick="closeAllModals()">بستن</button>
    </div>
</div>

<!-- Identity Card Modal -->
<div id="identityCardModal" class="modal">
    <div class="modal-content" style="text-align:center;">
        <h3>کارت هویت دیجیتال</h3>
        <p style="font-size:0.9rem; color:var(--text-sec); margin-bottom:20px;">لطفاً این کارت را ذخیره کنید. شامل کد بازیابی شماست.</p>
        <div id="idCardRenderArea">
            <div class="identity-card-container">
                <div class="id-card-header">
                    <i class="fas fa-id-card"></i> مدیریت سرمایه تعالی
                </div>
                <div class="id-card-body">
                    <div class="id-row">
                        <span class="id-label">نام کاربر</span>
                        <span class="id-value" id="idCardName">---</span>
                    </div>
                    <div class="id-row">
                        <span class="id-label">شماره حساب (یکتا)</span>
                        <span class="id-value-big" id="idCardAcc">---</span>
                    </div>
                    <div class="id-row">
                        <span class="id-label">کد بازیابی (PUK)</span>
                        <span class="id-value-big" id="idCardPuk" style="color:#22d3ee;">---</span>
                    </div>
                </div>
                <div class="id-footer">
                    <span>تاریخ ثبت نام: <span id="idCardDate">---</span></span>
                    <span>کد ملی: <span id="idCardNat">---</span></span>
                </div>
            </div>
        </div>
        <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="downloadIdCard()">
            <i class="fas fa-download"></i> دانلود کارت
        </button>
        <button class="btn btn-outline" style="width:100%; margin-top:10px;" onclick="closeIdCardAndLogin()">
            ورود به برنامه
        </button>
    </div>
</div>

<!-- Internal Transfer Modal (Wallet to Wallet) -->
<div id="internalTransferModal" class="modal">
    <div class="modal-content">
        <h3>انتقال وجه داخلی (شارژ کیف)</h3>
        <p style="font-size:0.9rem; color:var(--text-sec); margin-bottom:15px;">
            شارژ کیف پول: <b><span id="itTargetName"></span></b>
        </p>
        
        <label>انتخاب کیف پول مبدا:</label>
        <select id="itSourceSelect"></select>
        <p style="font-size:0.8rem; color:var(--info); margin-bottom:15px;" id="itSourceBalance">موجودی: ---</p>

        <div style="background:rgba(0,0,0,0.03); padding:10px; border-radius:10px; margin-bottom:15px;">
             <span style="font-size:0.8rem; color:var(--text-sec);">مبلغ آزاد (توزیع نشده در سیستم):</span><br>
             <b id="itFreeFundsDisplay" style="color:var(--success); font-size:1rem; direction:ltr;">---</b>
        </div>

        <label>مبلغ انتقال:</label>
        <div class="money-input-wrapper">
            <input type="text" id="itAmount" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="۰">
            <span class="money-unit currency-text">تومان</span>
        </div>
        
        <p style="font-size:0.75rem; color:var(--warning); margin-top:5px; line-height:1.5;">
            <i class="fas fa-exclamation-triangle"></i> توجه: مبلغ باید کمتر از بودجه موجود کیف پول مبدا باشد. همچنین نباید از پول‌های توزیع شده در بودجه باشد (سیستم خودکار چک می‌کند).
        </p>

        <div style="margin-top:25px; display:flex; gap:12px;">
            <button class="btn btn-primary" style="flex:1" onclick="performInternalTransfer()">انتقال</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Bank Transfer Wizard Modal -->
<div id="bankTransferModal" class="modal">
    <div class="modal-content" id="btContent">
        <!-- Will be populated by JS -->
    </div>
</div>

<!-- Receipt Modal -->
<div id="receiptModal" class="modal">
    <div class="modal-content" style="text-align:center;">
        <h3>رسید تراکنش</h3>
        <p style="font-size:0.8rem; color:var(--text-sec); margin-bottom:20px;">برای ذخیره روی دانلود کلیک کنید</p>
        <div id="receiptContainer" style="display:flex; justify-content:center; margin-bottom:20px;">
            <!-- Receipt Node Rendered Here -->
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="downloadReceipt()"><i class="fas fa-download"></i> دانلود رسید</button>
        <button class="btn btn-outline" style="width:100%; margin-top:10px;" onclick="closeAllModals()">بستن</button>
    </div>
</div>

<!-- Card Details & Copy -->
<div id="cardDetailsModal" class="modal">
    <div class="modal-content">
        <h3>وضعیت کلی سرمایه</h3>
        <p style="font-size:0.85rem; color:var(--text-sec); margin-bottom:15px;">خلاصه تمام دارایی‌ها و بدهی‌ها</p>
        <div id="cardDetailsContent"></div>
        <div style="margin-top:20px;">
            <button class="btn btn-outline" style="width:100%" onclick="copyCardDetails()"><i class="fas fa-copy"></i> کپی اطلاعات (فرمت استاندارد)</button>
        </div>
        <button class="btn btn-danger" style="width:100%; margin-top:10px;" onclick="closeAllModals()">بستن</button>
    </div>
</div>

<!-- Transfer Funds Modal (Internal Budget) -->
<div id="transferModal" class="modal">
    <div class="modal-content">
        <h3>انتقال وجه (داخلی بودجه)</h3>
        <p style="font-size:0.9rem; color:var(--text-sec); margin-bottom:5px;">
            انتقال از <b><span id="transferSourceName"></span></b> به:
        </p>
        <p style="font-size:0.85rem; color:var(--info); margin-bottom:15px;" id="transferSourceBalance"></p>
        <label>مقصد انتقال:</label>
        <select id="transferTargetSelect"></select>
        <label>مبلغ انتقال:</label>
        <div class="money-input-wrapper">
            <input type="text" id="transferAmount" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="۰">
            <span class="money-unit currency-text">تومان</span>
        </div>
        <div style="margin-top:25px; display:flex; gap:12px;">
            <button class="btn btn-primary" style="flex:1" onclick="performTransfer()">تایید انتقال</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Deposit Selection Modal -->
<div id="depositOptionsModal" class="modal">
    <div class="modal-content">
        <h3>انتخاب روش واریز</h3>
        <p style="font-size:0.9rem; color:var(--text-sec); margin-bottom:20px;">لطفاً نوع واریز به این ردیف بودجه را مشخص کنید:</p>
        <button id="btnSystemDep" class="btn btn-primary" style="width:100%; margin-bottom:5px; display:flex; justify-content:space-between;" onclick="selectDepositType('system')">
            <span>واریز از حساب سیستم (توزیع نشده)</span>
            <i class="fas fa-exchange-alt"></i>
        </button>
        <p id="systemDepMsg" style="font-size:0.8rem; color:var(--text-sec); margin-bottom:15px; margin-right:5px;">از موجودی کل توزیع نشده کسر می‌شود.</p>

        <button class="btn btn-success" style="width:100%; background:var(--success); color:white; margin-bottom:10px; display:flex; justify-content:space-between;" onclick="selectDepositType('direct')">
            <span>واریز مستقیم (پول بیرونی)</span>
            <i class="fas fa-hand-holding-usd"></i>
        </button>
        <p style="font-size:0.8rem; color:var(--text-sec); margin-bottom:15px; margin-right:5px;">به موجودی آیتم و موجودی کل حساب افزوده می‌شود.</p>

        <button class="btn btn-outline" style="width:100%; margin-top:10px;" onclick="closeAllModals()">انصراف</button>
    </div>
</div>

<!-- History Edit Modal -->
<div id="historyEditModal" class="modal">
    <div class="modal-content">
        <h3>ویرایش تراکنش</h3>
        <input type="hidden" id="heBudgetId">
        <input type="hidden" id="heHistIndex">
        <input type="hidden" id="heType">
        <label>مبلغ جدید:</label>
        <div class="money-input-wrapper">
            <input type="text" id="heAmount" onkeyup="formatCurrency(this)" inputmode="numeric">
            <span class="money-unit currency-text">تومان</span>
        </div>
        <label>توضیحات:</label>
        <input type="text" id="heReason">
        <label>تاریخ:</label>
        <input type="text" id="heDate" placeholder="۱۴۰۳/xx/xx">
        <div style="margin-top:25px; display:flex; gap:12px;">
            <button class="btn btn-primary" style="flex:1" onclick="saveHistoryEdit()">ذخیره تغییرات</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Universal Input Modal -->
<div id="universalInputModal" class="modal">
    <div class="modal-content">
        <h3 id="uInputTitle">ورود اطلاعات</h3>
        <p id="uInputLabel" style="color:var(--text-sec); margin-bottom:15px;">مقدار را وارد کنید:</p>

        <div id="uInputTextWrapper" style="display:none;">
            <input type="text" id="uInputText" placeholder="...">
        </div>

        <div id="uInputMoneyWrapper" class="money-input-wrapper" style="display:none;">
            <input type="text" id="uInputMoney" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="۰">
            <span class="money-unit currency-text">تومان</span>
        </div>

        <div id="uInputSelectWrapper" style="display:none;">
            <select id="uInputSelect"></select>
        </div>

        <div style="margin-top:25px; display:flex; gap:12px;">
            <button class="btn btn-primary" style="flex:1" onclick="submitUniversalInput()">تایید</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div id="changePassModal" class="modal">
    <div class="modal-content">
        <h3>تغییر رمز عبور</h3>
        <p style="font-size:0.85rem; color:var(--text-sec); margin-bottom:15px;">رمز فعلی و جدید را وارد کنید (فقط ۴ رقم عددی)</p>
        
        <label>رمز فعلی:</label>
        <input type="password" id="cpOldPass" maxlength="4" inputmode="numeric" pattern="[0-9]*" placeholder="****" style="text-align:center;">
        
        <label>رمز جدید:</label>
        <input type="password" id="cpNewPass" maxlength="4" inputmode="numeric" pattern="[0-9]*" placeholder="****" style="text-align:center;">
        
        <div style="margin-top:25px; display:flex; gap:12px;">
            <button class="btn btn-primary" style="flex:1" onclick="doChangePassword()">تایید و تغییر</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">انصراف</button>
        </div>
    </div>
</div>

<!-- Sub-Budget Manager -->
<div id="subBudgetModal" class="modal">
    <div class="modal-content">
        <h3>مدیریت زیرمجموعه‌ها</h3>
        <p style="font-size:0.85rem; color:var(--text-sec); margin-bottom:15px;">
            تعیین درصد برای هر زیرمجموعه از ردیف "<b><span id="subParentName"></span></b>".
        </p>

        <div class="alloc-info-box">
            <span id="subTotalBudget">سهم کل: ۰</span>
            <span id="subRemainPercent">باقی‌مانده: ۱۰۰%</span>
        </div>

        <div id="subBudgetList" style="max-height:300px; overflow-y:auto; padding-bottom:10px;"></div>

        <button class="btn btn-outline" style="width:100%; margin-top:10px;" onclick="addNewSubCategory()">+ افزودن زیرمجموعه</button>

        <div style="margin-top:25px; display:flex; gap:12px;">
            <button class="btn btn-primary" style="flex:1" onclick="saveSubBudgets()">ذخیره تغییرات</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">بستن</button>
        </div>
    </div>
</div>

<!-- Auto Allocation Settings -->
<div id="autoAllocModal" class="modal">
    <div class="modal-content">
        <h3>تنظیمات پس‌انداز خودکار</h3>
        <input type="hidden" id="autoAllocType">
        <input type="hidden" id="autoAllocId">

        <label>نوع برداشت:</label>
        <select id="aaType" onchange="toggleAutoAllocFields()">
            <option value="none">غیرفعال (دستی)</option>
            <option value="percent">درصدی از ورودی بودجه</option>
            <option value="fixed">مبلغ ثابت در هر شارژ</option>
        </select>

        <div id="aaPercentField" style="display:none;">
            <label>درصد کسر:</label>
            <input type="number" id="aaPercent" placeholder="مثلا ۱۰">
        </div>

        <div id="aaAmountField" style="display:none;">
            <label>مبلغ کسر (تومان):</label>
            <div class="money-input-wrapper">
                <input type="text" id="aaAmount" onkeyup="formatCurrency(this)" inputmode="numeric">
                <span class="money-unit currency-text">تومان</span>
            </div>
        </div>

        <label>منبع کسر بودجه:</label>
        <select id="aaSource"></select>

        <label>حداقل موجودی منبع برای کسر:</label>
        <div class="money-input-wrapper">
            <input type="text" id="aaMin" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="۰">
            <span class="money-unit currency-text">تومان</span>
        </div>

        <div style="margin-top:25px; display:flex; gap:12px;">
            <button class="btn btn-primary" style="flex:1" onclick="saveAutoAlloc()">ذخیره تنظیمات</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<div id="recoveryModal" class="modal">
    <div class="modal-content">
        <h3><i class="fas fa-key"></i> بازیابی رمز عبور</h3>
        <p style="color:var(--text-sec); font-size:0.9rem; margin-bottom:15px;">برای بازیابی، کد ملی و کد PUK خود را وارد کنید.</p>
        <label>کد ملی:</label>
        <input type="text" id="recNatId" inputmode="numeric" placeholder="کد ملی خود را وارد کنید">
        <label>کد بازیابی (PUK):</label>
        <input type="text" id="recPuk" placeholder="کد ۸ رقمی PUK" inputmode="numeric">
        <label>رمز عبور جدید (۴ رقم):</label>
        <input type="password" id="recNewPass" placeholder="رمز جدید..." maxlength="4" inputmode="numeric" pattern="[0-9]*">
        <div style="margin-top:25px; display:flex; gap:12px;">
            <button class="btn btn-primary" style="flex:1" onclick="checkRecovery()">بازیابی اکانت</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">بستن</button>
        </div>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <h3><i class="fas fa-edit"></i> ویرایش آیتم</h3>
        <input type="hidden" id="editType">
        <input type="hidden" id="editIndex">

        <label>عنوان:</label>
        <input type="text" id="editName">

        <div id="editAmountWrapper">
            <label>مبلغ / ارزش:</label>
            <div class="money-input-wrapper">
                <input type="text" id="editVal" onkeyup="formatCurrency(this)" inputmode="numeric">
                <span class="money-unit currency-text">تومان</span>
            </div>
        </div>
        
        <div id="editDeductWrapper" style="display:none; margin-bottom:15px;"></div>

        <div id="editDateWrapper" style="display:none;">
            <label>تاریخ:</label>
            <div class="date-picker-row" id="editDateRow"></div>
        </div>

        <!-- Instruction 2: Added Start/End Date for Debt Editing -->
        <div id="editDebtDatesWrapper" style="display:none;">
            <label>تاریخ اولین قسط:</label>
            <div class="date-picker-row" id="editDebtStartRow"></div>
            <label style="margin-top:10px; display:block;">تاریخ آخرین قسط:</label>
            <div class="date-picker-row" id="editDebtEndRow"></div>
        </div>

        <div id="editPercentWrapper" style="display:none;">
            <label>درصد:</label>
            <input type="number" id="editPercent" inputmode="numeric">
        </div>

        <div style="margin-top:25px; display:flex; gap:12px;">
            <button class="btn btn-primary" style="flex:1" onclick="performEdit()">ذخیره تغییرات</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<div id="sectionHistoryModal" class="modal">
    <div class="modal-content">
        <h3>تاریخچه تغییرات (۱۰ مورد آخر)</h3>
        <p style="font-size:0.8rem; color:var(--text-sec); margin-bottom:10px;">در اینجا جزییات دقیق تغییرات نمایش داده می‌شود.</p>
        <div id="sectionHistoryList" style="max-height:300px; overflow-y:auto; margin-top:5px;"></div>
        <button class="btn btn-outline" style="width:100%; margin-top:20px;" onclick="closeAllModals()">بستن</button>
    </div>
</div>

<div id="walletModal" class="modal">
    <div class="modal-content">
        <h3>افزودن کیف پول</h3>
        <label>نام کیف پول:</label>
        <input type="text" id="wName" placeholder="مثلاً: کارت ملی">
        <label>مبلغ موجودی:</label>
        <div class="money-input-wrapper">
            <input type="text" id="wVal" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="۰">
            <span class="money-unit currency-text">تومان</span>
        </div>
        <div style="margin-top:25px; display:flex; gap:12px;">
            <button class="btn btn-primary" style="flex:1" onclick="addWallet()">ثبت</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Instruction 6: Updated Debt Modal for Start/End Date -->
<div id="debtModal" class="modal">
    <div class="modal-content">
        <h3>افزودن قسط ثابت</h3>
        <label>عنوان قسط:</label>
        <input type="text" id="dName" placeholder="مثلاً: وام مسکن">
        <label>مبلغ هر قسط:</label>
        <div class="money-input-wrapper">
            <input type="text" id="dVal" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="۰">
            <span class="money-unit currency-text">تومان</span>
        </div>
        <label>تاریخ اولین قسط:</label>
        <div class="date-picker-row" id="dStartDateRow"></div>
        <label>تاریخ آخرین قسط:</label>
        <div class="date-picker-row" id="dEndDateRow"></div>
        <!-- Instruction 7: Penalty Input -->
        <label>درصد جریمه دیرکرد (ماهانه):</label>
        <input type="number" id="dPenalty" placeholder="مثلاً: ۲" value="0">
        
        <div style="margin-top:25px; display:flex; gap:12px;">
            <button class="btn btn-primary" style="flex:1" onclick="addDebt()">ثبت</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- New Modal: Debt Details (Instruction 6) -->
<div id="debtDetailsModal" class="modal">
    <div class="modal-content">
        <h3>جزئیات اقساط</h3>
        <p id="ddTitle" style="color:var(--primary); font-weight:bold; margin-bottom:10px;"></p>
        <div id="ddStats" style="display:flex; flex-wrap:wrap; gap:10px; font-size:0.8rem; margin-bottom:15px; background:rgba(0,0,0,0.03); padding:10px; border-radius:12px;"></div>
        <div id="ddList" style="max-height:300px; overflow-y:auto;"></div>
        <button class="btn btn-outline" style="width:100%; margin-top:20px;" onclick="closeAllModals()">بستن</button>
    </div>
</div>

<div id="checkModal" class="modal">
    <div class="modal-content">
        <h3>افزودن چک / بدهی</h3>
        <label>عنوان:</label>
        <input type="text" id="cName" placeholder="مثلاً: چک صیادی">
        <label>مبلغ:</label>
        <div class="money-input-wrapper">
            <input type="text" id="cVal" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="۰">
            <span class="money-unit currency-text">تومان</span>
        </div>
        <label>تاریخ سررسید:</label>
        <div class="date-picker-row" id="checkDateRow"></div>
        <div style="margin-top:25px; display:flex; gap:12px;">
            <button class="btn btn-primary" style="flex:1" onclick="addCheck()">ثبت</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<div id="loanModal" class="modal">
    <div class="modal-content">
        <h3>ثبت طلب (قرض داده شده)</h3>
        <label>نام شخص/عنوان:</label>
        <input type="text" id="lName" placeholder="مثلاً: علی رضایی">
        <label>مبلغ قرض:</label>
        <div class="money-input-wrapper">
            <input type="text" id="lVal" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="۰">
            <span class="money-unit currency-text">تومان</span>
        </div>
        <label>تاریخ وصول:</label>
        <div class="date-picker-row" id="loanDateRow"></div>
        <div style="margin-top:25px; display:flex; gap:12px;">
            <button class="btn btn-primary" style="flex:1" onclick="addLoan()">ثبت</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<div id="addBudgetModal" class="modal">
    <div class="modal-content">
        <h3>افزودن ردیف بودجه</h3>
        <label>عنوان:</label>
        <input type="text" id="bName" placeholder="مثلاً: پوشاک">
        <label>درصد سهم:</label>
        <input type="number" id="bPercent" inputmode="numeric" placeholder="مثلاً: ۱۰">
        <div style="margin-top:25px; display:flex; gap:12px;">
            <button class="btn btn-primary" style="flex:1" onclick="addNewBudget()">ثبت</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<div id="expModal" class="modal">
    <div class="modal-content">
        <h3>ثبت هزینه جدید</h3>
        <input type="hidden" id="expBudgetId">
        <div id="expWalletWrapper" style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: var(--text-sec);">پرداخت از کیف پول:</label>
            <select id="expWalletSelect" style="width: 100%;"></select>
        </div>
        <label>مبلغ هزینه:</label>
        <div class="money-input-wrapper">
            <input type="text" id="expAmt" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="۰">
            <span class="money-unit currency-text">تومان</span>
        </div>
        <label>بابت (توضیح):</label>
        <input type="text" id="expReason" placeholder="...">
        <div style="margin-top:25px; display:flex; gap:12px;">
            <button class="btn btn-primary" style="flex:1" onclick="submitExp()">ثبت</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<div id="goalModal" class="modal">
    <div class="modal-content">
        <h3>هدف پس‌انداز جدید</h3>
        <label>نام هدف:</label>
        <input type="text" id="gName" placeholder="مثلاً: لپ‌تاپ">
        <label>مبلغ هدف:</label>
        <div class="money-input-wrapper">
            <input type="text" id="gTarget" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="۰">
            <span class="money-unit currency-text">تومان</span>
        </div>
        <div style="margin-top:25px; display:flex; gap:12px;">
            <button class="btn btn-primary" style="flex:1" onclick="addGoal()">ثبت</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<div id="shopModal" class="modal">
    <div class="modal-content">
        <h3>افزودن به لیست خرید</h3>
        <label>نام کالا:</label>
        <input type="text" id="sName" placeholder="مثلاً: روغن زیتون">
        <label>قیمت حدودی (اختیاری):</label>
        <div class="money-input-wrapper">
            <input type="text" id="sPrice" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="۰">
            <span class="money-unit currency-text">تومان</span>
        </div>
        <div style="margin-top:25px; display:flex; gap:12px;">
            <button class="btn btn-primary" style="flex:1" onclick="addShop()">ثبت</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<div id="allocModal" class="modal">
    <div class="modal-content">
        <h3>اختصاص بودجه</h3>
        <p style="font-size:0.9rem; color:var(--text-sec);">انتخاب کنید هزینه از کدام ردیف بودجه کسر شود:</p>
        <input type="hidden" id="allocType">
        <input type="hidden" id="allocId">
        <label>ردیف بودجه:</label>
        <select id="allocBudgetSelect"></select>
        <div id="allocInfo" class="alloc-info-box" style="display:none;">
            <span>موجودی این ردیف:</span>
            <b id="allocLimitDisplay" style="direction:ltr">۰</b>
        </div>
        <label>مبلغ اختصاصی:</label>
        <div class="money-input-wrapper">
            <input type="text" id="allocAmt" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="۰">
            <span class="money-unit currency-text">تومان</span>
        </div>
        <div style="margin-top:25px; display:flex; gap:12px;">
            <button class="btn btn-primary" style="flex:1" onclick="performAllocation()">ثبت کسری</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<div id="fixPercentModal" class="modal">
    <div class="modal-content">
        <h3><i class="fas fa-exclamation-triangle" style="color:var(--warning)"></i> خطا در درصد کل</h3>
        <p>مجموع درصد‌ها از ۱۰۰٪ بیشتر شده است.</p>
        <div style="margin:20px 0; padding:15px; background:rgba(0,0,0,0.05); border-radius:12px;">
            <p><b>حالت اول:</b> انتخاب دستی تا سقف مجاز</p>
            <p style="font-size:0.9rem;">حداکثر درصد قابل انتخاب: <b id="maxAllowedPercent" style="color:var(--primary)">۰%</b></p>
            <div style="display:flex; align-items:center; gap:10px;">
                <span>۰</span>
                <input type="range" id="percentSlider" min="0" value="0" oninput="updateSliderVal()">
                <span id="sliderValDisplay">۰</span>%
            </div>
            <button class="btn btn-outline" style="width:100%; margin-top:10px;" onclick="useSliderPercent()">ثبت درصد انتخابی</button>
        </div>
        <div style="margin:20px 0; padding:15px; background:rgba(0,0,0,0.05); border-radius:12px;">
            <p><b>حالت دوم:</b> اصلاح هوشمند سیستم</p>
            <p style="font-size:0.9rem;">سیستم بر اساس اولویت‌بندی‌ها، درصدهای اولویت پایین‌تر را کاهش می‌دهد.</p>
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
                <input type="checkbox" id="allowZeroCheck" style="width:auto; margin:0; box-shadow:none;">
                <label for="allowZeroCheck" style="font-size:0.9rem;">اجازه صفر شدن آیتم‌ها</label>
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="autoCorrectBudget()">اصلاح خودکار و ثبت</button>
        </div>
        <button class="btn btn-danger" style="width:100%" onclick="closeAllModals()">انصراف</button>
    </div>
</div>

<!-- Priority Settings Modal -->
<div id="prioritySettingsModal" class="modal">
    <div class="modal-content">
        <h3>مدیریت هوشمند اولویت‌ها</h3>
        <!-- Instruction 2: Added Explanation Box -->
        <div style="background:rgba(255,255,255,0.5); padding:10px; border-radius:10px; margin-bottom:15px; font-size:0.85rem; color:var(--text-sec); line-height:1.6;">
            راهنما: در اینجا مشخص می‌کنید که سیستم هنگام کمبود بودجه، از کدام آیتم‌ها راحت‌تر پول بردارد. بازه‌ها را بر اساس درصد سهم تعریف کنید.
            <br><b>مثال:</b> اگر بازه ۰ تا ۱۰٪ را در اولویت ۱ (مهم) قرار دهید، سیستم سعی می‌کند از آیتم‌های کوچک (مثل نان) کم نکند و سراغ اولویت‌های بعدی (مثل تفریح) برود.
        </div>
        <div id="tierListContainer"></div>
        <div id="newTierForm" style="margin-top:20px; padding:15px; background:rgba(0,0,0,0.03); border-radius:12px; display:none;">
            <h4 style="margin:0 0 10px 0; color:var(--primary);">افزودن اولویت <span id="nextTierNum"></span></h4>
            <div style="display:flex; gap:10px; align-items:center;">
                <span>از <b id="tierStartDisplay">۰</b>% تا</span>
                <input type="number" id="tierEndInput" placeholder="سقف درصد" style="margin:0; width:100px;">
                <span>%</span>
            </div>
            <button class="btn btn-primary" style="margin-top:10px; width:100%;" onclick="addPriorityTier()">ثبت بازه</button>
        </div>
        <div style="margin-top:25px; display:flex; flex-direction: column; gap:12px;">
            <button id="addTierBtn" class="btn btn-outline" style="width:100%" onclick="showAddTierForm()">+ افزودن اولویت جدید</button>
            <button class="btn btn-danger" style="width:100%" onclick="resetPriorities()">بازنشانی همه</button>
            <button class="btn btn-outline" style="width:100%" onclick="closeAllModals()">بستن</button>
        </div>
    </div>
</div>

<div id="itemHistModal" class="modal">
    <div class="modal-content">
        <h3>تاریخچه تراکنش‌ها (قابل ویرایش)</h3>
        <div class="search-bar">
            <input type="text" id="histSearchInput" onkeyup="filterList('histSearchInput', 'itemHistList')" placeholder="جستجو در مبلغ یا توضیحات...">
            <i class="fas fa-search"></i>
        </div>
        <p style="font-size:0.8rem; color:var(--text-sec); margin-bottom:10px;">برای ویرایش روی آیکون مداد کلیک کنید.</p>
        <div id="itemHistList" style="max-height:300px; overflow-y:auto; margin-top:15px; font-size:0.9rem;"></div>
        <button class="btn btn-outline" style="width:100%; margin-top:20px;" onclick="closeAllModals()">بستن</button>
    </div>
</div>

<div id="histModal" class="modal">
    <div class="modal-content">
        <h3>تاریخچه بکاپ‌ها</h3>
        <div id="histList" style="max-height:300px; overflow-y:auto; margin-top:15px; font-size:0.9rem;"></div>
        <button class="btn btn-outline" style="width:100%; margin-top:20px;" onclick="closeAllModals()">بستن</button>
    </div>
</div>

<div id="printArea">
    <div class="print-header">
        <h1>گزارش جامع وضعیت مالی</h1>
        <p id="printDate">تاریخ: ---</p>
        <p>کاربر: <span id="printUser">---</span> | روزهای سپری شده: <span id="printDays">۰</span></p>
    </div>
    <div class="print-summary">
        <div>کل دارایی: <b id="printInc">۰</b></div>
        <div>کل بدهی (موثر): <b id="printDebt">۰</b></div>
        <div>خالص قابل خرج: <b id="printNet">۰</b></div>
    </div>
    <div class="print-section-title">نمودار پیشرفت مالی (روزانه)</div>
    <div class="print-chart-container">
        <canvas id="printChart"></canvas>
    </div>
    <div class="print-section-title">تاریخچه روزانه اخیر</div>
    <table class="print-table" style="font-size:0.8rem;">
        <thead><tr><th>تاریخ</th><th>خالص (تومان)</th><th>هزینه شده</th></tr></thead>
        <tbody id="printHistoryTable"></tbody>
    </table>
    <div class="print-section-title">جزئیات بودجه‌بندی</div>
    <table class="print-table">
        <thead><tr><th>ردیف</th><th>درصد</th><th>سهم (تومان)</th><th>خرج شده</th><th>مانده</th></tr></thead>
        <tbody id="printBody"></tbody>
    </table>
    <div class="print-section-title">وضعیت بدهی‌ها</div>
    <div id="printDebtsList" style="margin-top:5px; font-size:0.9rem;"></div>
    <div class="print-section-title">وضعیت اهداف مالی</div>
    <div id="printGoalsList" style="margin-top:5px; font-size:0.9rem;"></div>
</div>

<script>
    // IMPORTANT: Web App URL Placeholder
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzLum9qk7WmBan9jNI7HhS5Jjq-rc9h0i7p2bTxm2kF1FOpjyaYEwNJ5Pu5C7sC6ymt/exec";

    const CONST_WALLET_DEBT = "اقساط ماهانه";
    const CONST_WALLET_CHECK = "چک و بدهی";
    const RESTRICTED_SOURCES = ["کیف پول بیرونی", "External Wallet", "کیف پول دریافت وجه", "Receive Wallet"];
    const LOCAL_STORAGE_KEY = 'amir_fin_v9';

    const defaultState = {
        security: { hasPin: false, pin: "", isSetup: false, questionId: 0, answer: "", nationalId: "" },
        user: { name: "", theme: "light", currency: "toman", startDate: Date.now() },
        settings: { globalDeduct: true, biometricEnabled: false, biometricId: null },
        wallets: [],
        debts: [],
        checks: [],
        loans: [],
        transfers: [],
        transactionLog: [], // Global history log
        budgets: [
            {id: 1, name: "کرایه شهری", percent: 20, spent: 0, history: [], manualAdd: 0, isPaused: false, savedPercent: 0, subs: [], internalDebt: []},
            {id: 2, name: "خورد و خوراک", percent: 14, spent: 0, history: [], manualAdd: 0, subs: [], internalDebt: []},
            {id: 3, name: "سفر", percent: 20, spent: 0, history: [], manualAdd: 0, subs: [], internalDebt: []},
            {id: 4, name: "دوا و درمان", percent: 7, spent: 0, history: [], manualAdd: 0, subs: [], internalDebt: []},
            {id: 5, name: "جانبی", percent: 8, spent: 0, history: [], manualAdd: 0, subs: [], internalDebt: []},
            {id: 6, name: "زیبایی و مکمل", percent: 7, spent: 0, history: [], manualAdd: 0, subs: [], internalDebt: []},
            {id: 7, name: "لباس", percent: 5, spent: 0, history: [], manualAdd: 0, subs: [], internalDebt: []},
            {id: 8, name: "ضروری", percent: 5, spent: 0, history: [], manualAdd: 0, subs: [], internalDebt: []},
            {id: 9, name: "تفریح", percent: 3, spent: 0, history: [], manualAdd: 0, subs: [], internalDebt: []},
            {id: 10, name: "پس‌انداز کل", percent: 11, spent: 0, history: [], manualAdd: 0, subs: [], internalDebt: []}
        ],
        priorities: {},
        priorityTiers: [],
        distributedAmount: 0,
        goals: [],
        shopping: [],
        history: [],
        dailyLogs: [],
        sectionHistory: { dashboard: [], budget: [], tools: [] }
    };

    let app = JSON.parse(JSON.stringify(defaultState));
    let rate = 1;
    let tempBudget = null;
    let tempSubIndex = -1;
    let universalCallback = null;
    let tempDepositIndex = -1;
    let myChart1 = null;
    let myChart2 = null;
    let isBalanceHidden = false;
    let loginAttempts = 0;
    let changePassAttempts = 0;
    
    // Internal Transfer specific variable
    let tempInternalTargetName = "";

    async function googleApi(funcName, ...args) {
        const payload = { functionName: funcName, args: args };
        try {
            const response = await fetch(WEB_APP_URL, {
                method: 'POST',
                body: JSON.stringify(payload),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            });
            const data = await response.json();
            return data;
        } catch (error) {
            console.error("API Error:", error);
            throw error;
        }
    }

    function showToast(message, icon="check-circle") {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
        container.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add('show'));
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 400);
        }, 3000);
    }

    function toggleLoading(active) {
        const overlay = document.getElementById('loadingOverlay');
        if (active) overlay.classList.add('active');
        else overlay.classList.remove('active');
    }

    function withLoading(callback, duration=800) {
        toggleLoading(true);
        setTimeout(() => {
            callback();
            toggleLoading(false);
        }, duration);
    }

    window.onload = () => {
        checkAuth();
        setupDatePickers();
    };

    function toPersianNum(num, dontTrim) {
        if(num === null || num === undefined) return '';
        const str = num.toString();
        const persian = { '0': '۰', '1': '۱', '2': '۲', '3': '۳', '4': '۴', '5': '۵', '6': '۶', '7': '۷', '8': '۸', '9': '۹' };
        let res = "";
        for (let i = 0; i < str.length; i++) {
            let ch = str[i];
            res += persian[ch] || ch;
        }
        return res;
    }

    // --- Instruction 3: Helper function for date logic ---
    function toEn(str) {
        if (!str) return "";
        return str.toString().replace(/[۰-۱-۲-۳-۴-۵-۶-۷-۸-۹]/g, d => "۰۱۲۳۴۵۶۷۸۹".indexOf(d));
    }

    function getAccountNumber() {
        const natId = app.security.nationalId || "";
        if(!natId || natId.length !== 10) return "۰۰۰۰ ۰۰۰۰ ۰۰۰۰ ۰۰۰۰";
        const reversed = natId.split('').reverse().join('');
        return toPersianNum(reversed);
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast("کپی شد");
        });
    }

    function processDailyLog() {
        const today = new Date().toLocaleDateString('fa-IR');
        if(!app.dailyLogs) app.dailyLogs = [];
        const lastLog = app.dailyLogs.length > 0 ? app.dailyLogs[app.dailyLogs.length-1] : null;

        if (!lastLog || lastLog.date !== today) {
            const income = app.wallets.reduce((a,b)=>a+b.value,0);
            const fixedDebt = app.debts.reduce((a,b)=> (b.deduct !== false && b.lastPaid !== getCurMonth()) ? a+b.value : a, 0);
            const checkDebt = (app.checks || []).reduce((a,b)=> (!b.isPaid && b.deduct !== false) ? a+b.value : a, 0);
            const totalDebt = fixedDebt + checkDebt;
            const net = Math.max(0, income - totalDebt);
            const spent = app.budgets.reduce((a,b)=>a+b.spent,0);
            app.dailyLogs.push({ date: today, net: net, spent: spent, timestamp: Date.now() });
            saveData();
        }
    }

    function setupDatePickers() { 
        document.getElementById('dStartDateRow').innerHTML = createDatePickerHTML('dStart');
        document.getElementById('dEndDateRow').innerHTML = createDatePickerHTML('dEnd');
        document.getElementById('checkDateRow').innerHTML = createDatePickerHTML('c');
        document.getElementById('loanDateRow').innerHTML = createDatePickerHTML('l');
        // Instruction 2: Setup Edit Debt Date Pickers
        document.getElementById('editDebtStartRow').innerHTML = createDatePickerHTML('editDStart');
        document.getElementById('editDebtEndRow').innerHTML = createDatePickerHTML('editDEnd');
    }

    // --- تابع ساخت HTML انتخابگر تاریخ (اصلاح شده) ---
    function createDatePickerHTML(prefix, defaultD, defaultM, defaultY) {
        // اگر مقادیر پیش‌فرض داده نشده بود، از تاریخ امروز استفاده کن
        if (!defaultD || !defaultM || !defaultY) {
            const today = new Date().toLocaleDateString('fa-IR-u-nu-latn').split('/');
            defaultY = parseInt(today[0]);
            defaultM = parseInt(today[1]);
            defaultD = parseInt(today[2]);
        }

        // ترتیب: روز (راست) - ماه (وسط) - سال (چپ)
        // چون dir="rtl" است، اولین المنت در HTML سمت راست قرار می‌گیرد.
        return `
            <select id="${prefix}Day" class="date-sel" style="flex:1;">${genOpts(1, 31, defaultD)}</select>
            <select id="${prefix}Month" class="date-sel" style="flex:1;">${genOpts(1, 12, defaultM)}</select>
            <select id="${prefix}Year" class="date-sel" style="flex:1.5;">${genYearOpts(defaultY)}</select>
        `;
    }

    // --- تابع تولید گزینه‌های سال (اصلاح شده: 100 سال قبل و بعد) ---
    function genYearOpts(sel) {
        const currentYear = parseInt(new Date().toLocaleDateString('fa-IR-u-nu-latn').split('/')[0]);
        const startYear = currentYear - 100;
        const endYear = currentYear + 100;
        
        let html = '';
        // حلقه از سال شروع تا پایان
        for(let i = startYear; i <= endYear; i++) {
            html += `<option value="${i}" ${i == sel ? 'selected' : ''}>${toPersianNum(i)}</option>`;
        }
        return html;
    }

    // --- تابع تولید گزینه‌های روز و ماه (بدون تغییر، فقط برای اطمینان) ---
    function genOpts(min, max, sel) {
        let html = '';
        for(let i=min; i<=max; i++) {
            let val = i < 10 ? '0' + i : i;
            // تبدیل sel به عدد برای مقایسه دقیق
            html += `<option value="${val}" ${parseInt(val) == parseInt(sel) ? 'selected' : ''}>${toPersianNum(i)}</option>`;
        }
        return html;
    }

    function getDateString(prefix) {
        const d = document.getElementById(prefix+'Day').value;
        const m = document.getElementById(prefix+'Month').value;
        const y = document.getElementById(prefix+'Year').value;
        return toPersianNum(`${y}/${m}/${d}`);
    }

    function getCurMonth() {
        return toPersianNum(new Date().toLocaleDateString('fa-IR-u-nu-latn').split('/').slice(0, 2).join('/'));
    }

    function isValidIranianNationalId(input) {
        if (!/^\d{10}$/.test(input)) return false;
        const check = parseInt(input[9]);
        const sum = input.split('').slice(0, 9).reduce((acc, x, i) => acc + parseInt(x) * (10 - i), 0) % 11;
        return sum < 2 ? check === sum : check === 11 - sum;
    }

    // --- Instruction 3: Updated Date Logic ---
    function dateToInt(dateStr) {
        const parts = toEn(dateStr).split('/');
        const y = parts[0];
        const m = parts[1].length < 2 ? '0' + parts[1] : parts[1];
        const d = parts[2].length < 2 ? '0' + parts[2] : parts[2];
        return parseInt(y + m + d);
    }

    function compareDates(targetDateStr) {
        if(!targetDateStr) return 0;
        
        const tParts = toEn(targetDateStr).split('/');
        const tY = parseInt(tParts[0]);
        const tM = parseInt(tParts[1]);
        const tD = parseInt(tParts[2]);

        const today = new Date().toLocaleDateString('fa-IR-u-nu-latn').split('/');
        const cY = parseInt(today[0]);
        const cM = parseInt(today[1]);
        const cD = parseInt(today[2]);

        function getDayOfYear(m, d) {
            if (m <= 7) return (m - 1) * 31 + d;
            return 186 + (m - 7) * 30 + d;
        }

        const tTotal = (tY * 365) + getDayOfYear(tM, tD);
        const cTotal = (cY * 365) + getDayOfYear(cM, cD);

        return tTotal - cTotal;
    }

    // --- AUTHENTICATION ---
    function checkAuth() {
        document.getElementById('authModal').style.display = 'flex';
        resetAuthView();
        
        // بررسی فعال بودن ورود بیومتریک از لوکال استوریج
        const localData = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (localData) {
            try {
                const parsed = JSON.parse(localData);
                // اگر بیومتریک فعال است، دکمه را نمایش بده
                if (parsed.settings && parsed.settings.biometricEnabled && parsed.settings.biometricId) {
                    document.getElementById('bioLoginBtnInitial').style.display = 'block';
                    // پیش‌بارگذاری داده‌ها برای دسترسی سریع‌تر به ID بیومتریک
                    app = parsed; 
                }
            } catch (e) { console.error("Error checking auth", e); }
        }
    }

    function resetAuthView() {
        document.getElementById('authInitial').style.display = 'block';
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('authStep1').style.display = 'none';
        document.getElementById('authActions').style.display = 'block';
        document.getElementById('authTitle').innerText = "مدیریت سرمایه";
        document.getElementById('authSub').innerText = "لطفاً وارد شوید یا ثبت نام کنید";
        document.getElementById('loginNatId').value = '';
        document.getElementById('loginPass').value = '';
    }

    function showLoginForm() {
        document.getElementById('authInitial').style.display = 'none';
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('authActions').style.display = 'block';
        document.getElementById('authTitle').innerText = "ورود به حساب";
        document.getElementById('authSub').innerText = "اطلاعات کاربری خود را وارد کنید";
    }

    function showRegisterForm() {
        document.getElementById('authInitial').style.display = 'none';
        document.getElementById('authStep1').style.display = 'block';
        document.getElementById('authActions').style.display = 'none';
        document.getElementById('authTitle').innerText = "ثبت نام";
        document.getElementById('authSub').innerText = "مراحل را به ترتیب طی کنید";
        document.getElementById('setupStepVal').value = 1;
        document.getElementById('setupS1').style.display = 'block';
        document.getElementById('setupS2').style.display = 'none';
        document.getElementById('setupS3').style.display = 'none';
        document.getElementById('setupNextBtn').innerText = 'بعدی';
    }

    function nextSetupStep() {
        let step = parseInt(document.getElementById('setupStepVal').value);
        if(step === 1) {
            const name = document.getElementById('setupNameInput').value.trim();
            if(!name) return alert("لطفا نام را وارد کنید");
            app.user.name = name;
            document.getElementById('setupS1').style.display = 'none';
            document.getElementById('setupS2').style.display = 'block';
            document.getElementById('setupStepVal').value = 2;
        } else if(step === 2) {
            const natId = document.getElementById('setupNatId').value.trim();
            if(!isValidIranianNationalId(natId)) return alert("کد ملی نامعتبر است. لطفاً کد ملی ۱۰ رقمی صحیح وارد کنید.");
            app.security.nationalId = natId;
            document.getElementById('setupS2').style.display = 'none';
            document.getElementById('setupS3').style.display = 'block';
            document.getElementById('setupStepVal').value = 3;
            document.getElementById('setupNextBtn').innerText = 'تکمیل ثبت نام';
        } else if(step === 3) {
            const pass = document.getElementById('setupPassword').value;
            if(!/^\d{4}$/.test(pass)) return alert("رمز عبور باید دقیقاً ۴ رقم عددی باشد.");
            toggleLoading(true);
            googleApi('apiRegister', app.user.name, app.security.nationalId, pass)
                .then(response => {
                    toggleLoading(false);
                    if (response.success) {
                        showIdentityCardModal(response.data.name, response.data.accountNumber, response.data.puk, pass, response.data.nationalId);
                    } else {
                        alert("خطا در ثبت نام: " + response.message);
                    }
                })
                .catch(err => {
                    toggleLoading(false);
                    alert("خطا در ارتباط با سرور: " + err);
                });
        }
    }

    function showIdentityCardModal(name, acc, puk, pass, natId) {
        document.getElementById('authModal').style.display = 'none';
        document.getElementById('idCardName').innerText = name;
        document.getElementById('idCardAcc').innerText = toPersianNum(acc);
        document.getElementById('idCardPuk').innerText = puk;
        document.getElementById('idCardNat').innerText = toPersianNum(natId);
        document.getElementById('idCardDate').innerText = toPersianNum(new Date().toLocaleDateString('fa-IR'));
        openModal('identityCardModal');
    }

    function downloadIdCard() {
        const el = document.getElementById('idCardRenderArea');
        html2canvas(el, { scale: 2 }).then(canvas => {
            const a = document.createElement('a');
            a.download = `IdentityCard_${Date.now()}.png`;
            a.href = canvas.toDataURL();
            a.click();
            showToast("کارت هویت ذخیره شد");
        });
    }

    function closeIdCardAndLogin() {
        closeAllModals();
        alert("لطفاً با رمز عبور خود وارد شوید.");
        checkAuth();
        showLoginForm();
    }

    function processLogin() {
        const natId = document.getElementById('loginNatId').value.trim();
        const pass = document.getElementById('loginPass').value;
        if(!isValidIranianNationalId(natId)) return alert("کد ملی نامعتبر است");
        if(!/^\d{4}$/.test(pass)) return alert("رمز عبور باید ۴ رقم باشد");

        toggleLoading(true);

        // تلاش اول: اتصال به سرور (آنلاین)
        googleApi('apiLogin', natId, pass)
            .then(response => {
                toggleLoading(false);
                if(response.success) {
                    loginAttempts = 0;
                    const cloudData = response.userData.appData;
                    const securityData = response.userData.security;
                    app = { ...defaultState, ...cloudData };
                    if(!app.transactionLog) app.transactionLog = []; 
                    app.security = securityData;
                    
                    // ذخیره کامل در لوکال استوریج برای استفاده‌های بعدی (آفلاین)
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(app));

                    document.getElementById('authModal').style.display = 'none';
                    document.getElementById('appContent').style.display = 'block';
                    processDailyLog();
                    updateDate();
                    renderUI();
                    showToast("خوش آمدید", "user-check");
                } else {
                    alert(response.message);
                    loginAttempts++;
                    if(loginAttempts >= 3) {
                        alert("تعداد تلاش‌های ناموفق بیش از حد مجاز است. حساب کاربری موقتا قفل شد. لطفا از طریق بازیابی رمز اقدام کنید.");
                        closeAllModals();
                        startRecovery();
                        return;
                    } else {
                        alert(`رمز عبور اشتباه است. (تلاش ${loginAttempts} از ۳)`);
                    }
                }
            })
            .catch(err => {
                // حالت آفلاین: اگر سرور پاسخ نداد، از حافظه بخوان
                console.warn("Server unreachable, trying local storage...", err);
                const localData = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (localData) {
                    try {
                        const json = JSON.parse(localData);
                        // بررسی اعتبار در حالت آفلاین
                        if (json.security && json.security.nationalId === natId && json.security.password === pass) {
                            app = json;
                            toggleLoading(false);
                            document.getElementById('authModal').style.display = 'none';
                            document.getElementById('appContent').style.display = 'block';
                            processDailyLog();
                            updateDate();
                            renderUI();
                            showToast("ورود آفلاین موفق", "wifi-slash");
                            return;
                        } else {
                            toggleLoading(false);
                            alert("اطلاعات ورود اشتباه است (آفلاین)");
                        }
                    } catch (e) {
                        toggleLoading(false);
                        alert("خطا در خواندن اطلاعات ذخیره شده.");
                    }
                } else {
                    toggleLoading(false);
                    alert("خطا در ارتباط با سرور و عدم وجود اطلاعات ذخیره شده: " + err);
                }
            });
    }

    // --- Helpers for Base64 Conversion ---
    function bufferToBase64(buffer) {
        return btoa(String.fromCharCode(...new Uint8Array(buffer)));
    }

    function base64ToBuffer(base64) {
        const binaryString = atob(base64);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
    }

    // --- Biometric Setup & Login ---
    async function setupBiometric() {
        if (!window.PublicKeyCredential) {
            return alert("دستگاه شما از قابلیت ورود بیومتریک پشتیبانی نمی‌کند.");
        }

        try {
            const challenge = new Uint8Array(32);
            window.crypto.getRandomValues(challenge);

            const publicKey = {
                challenge: challenge,
                rp: { name: "Capital Management App" },
                user: {
                    id: Uint8Array.from(app.security.nationalId, c => c.charCodeAt(0)),
                    name: app.security.nationalId,
                    displayName: app.user.name
                },
                pubKeyCredParams: [{ type: "public-key", alg: -7 }],
                authenticatorSelection: { authenticatorAttachment: "platform" },
                timeout: 60000
            };

            const credential = await navigator.credentials.create({ publicKey });
            
            if (credential) {
                // ذخیره شناسه اثر انگشت (Credential ID) به صورت رشته Base64
                app.settings.biometricEnabled = true;
                app.settings.biometricId = bufferToBase64(credential.rawId);
                
                saveData();
                showToast("ورود بیومتریک با موفقیت فعال شد");
            }
        } catch (err) {
            console.error(err);
            alert("خطا در فعال‌سازی بیومتریک: " + err.message);
        }
    }

    async function loginWithBiometric() {
        if (!window.PublicKeyCredential) {
            return alert("بیومتریک پشتیبانی نمی‌شود.");
        }

        const localData = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (!localData) return alert("اطلاعات کاربری یافت نشد. لطفاً ابتدا با رمز عبور وارد شوید.");

        let parsedApp;
        try {
            parsedApp = JSON.parse(localData);
        } catch(e) {
            return alert("خطا در خواندن داده‌ها.");
        }

        if (!parsedApp.settings || !parsedApp.settings.biometricId) {
            return alert("اثر انگشت برای این حساب فعال نشده است. لطفاً از تنظیمات فعال کنید.");
        }

        try {
            const challenge = new Uint8Array(32);
            window.crypto.getRandomValues(challenge);

            // بازیابی شناسه اثر انگشت از رشته Base64 به بافر
            const savedCredentialId = base64ToBuffer(parsedApp.settings.biometricId);

            const credential = await navigator.credentials.get({
                publicKey: {
                    challenge: challenge,
                    allowCredentials: [{
                        id: savedCredentialId,
                        type: 'public-key',
                        transports: ['internal']
                    }],
                    userVerification: "required",
                    timeout: 60000
                }
            });

            if (credential) {
                // اگر تایید شد، داده‌های لوکال را بارگذاری کن
                app = parsedApp;
                
                document.getElementById('authModal').style.display = 'none';
                document.getElementById('appContent').style.display = 'block';
                processDailyLog();
                updateDate();
                renderUI();
                showToast("ورود موفق با اثر انگشت", "fingerprint");
            }
        } catch (err) {
            console.error(err);
            alert("احراز هویت ناموفق بود یا لغو شد.");
        }
    }

    // Instruction 3: Refresh Data Function
    function refreshAppData() {
        toggleLoading(true);
        const natId = app.security.nationalId;
        const pass = app.security.password;
        
        if(natId && pass) {
             googleApi('apiLogin', natId, pass).then(res => {
                 if(res.success) {
                     app = {...defaultState, ...res.userData.appData};
                     renderUI();
                     showToast("بروزرسانی شد");
                 } else {
                     showToast("خطا در بروزرسانی", "exclamation-triangle");
                 }
                 toggleLoading(false);
             }).catch(err => {
                 console.error(err);
                 toggleLoading(false);
                 showToast("خطا در ارتباط", "wifi-slash");
             });
        } else {
            // Guest or local only - just re-render
            renderUI();
            toggleLoading(false);
            showToast("بروزرسانی شد");
        }
    }

    function startRecovery() {
        openModal('recoveryModal');
    }

    function checkRecovery() {
        const natId = document.getElementById('recNatId').value.trim();
        const puk = document.getElementById('recPuk').value.trim();
        const newPass = document.getElementById('recNewPass').value.trim();
        
        if(!natId || !puk || !newPass) return alert("همه فیلدها الزامی است");
        if(!/^\d{4}$/.test(newPass)) return alert("رمز عبور باید ۴ رقم عددی باشد.");

        toggleLoading(true);
        
        // فراخوانی تابع سمت سرور
        googleApi('apiRecoverAccount', natId, puk, newPass)
            .then(response => {
                toggleLoading(false);
                if(response.success) {
                    alert(response.message);
                    loginAttempts = 0;
                    closeAllModals();
                    showLoginForm();
                } else {
                    alert(response.message);
                    if(response.locked) {
                        closeAllModals();
                    }
                }
            })
            .catch(err => {
                toggleLoading(false);
                alert("خطا در بازیابی: " + err);
            });
    }

    function logout() {
        if(confirm("آیا می‌خواهید از حساب خارج شوید؟")) {
            location.reload();
        }
    }

    function changePassword() {
        document.getElementById('cpOldPass').value = '';
        document.getElementById('cpNewPass').value = '';
        changePassAttempts = 0;
        openModal('changePassModal');
    }

    function doChangePassword() {
        const oldPass = document.getElementById('cpOldPass').value;
        const newPass = document.getElementById('cpNewPass').value;

        if(!/^\d{4}$/.test(oldPass) || !/^\d{4}$/.test(newPass)) {
            return alert("هر دو رمز باید دقیقاً ۴ رقم عددی باشند.");
        }

        toggleLoading(true);
        
        // فراخوانی تابع سمت سرور
        googleApi('apiChangePasswordSecure', app.security.nationalId, oldPass, newPass)
            .then(res => {
                toggleLoading(false);
                if (res.success) {
                    // آپدیت لوکال فقط بعد از موفقیت سرور
                    app.security.password = newPass;
                    saveData(); // ذخیره نسخه لوکال برای هماهنگی
                    closeAllModals();
                    showToast(res.message);
                    
                    // پاک کردن فیلدها
                    document.getElementById('cpOldPass').value = '';
                    document.getElementById('cpNewPass').value = '';
                } else {
                    alert(res.message);
                }
            })
            .catch(err => {
                toggleLoading(false);
                alert("خطا در ارتباط با سرور: " + err);
            });
    }

    // --- GLOBAL TRANSACTION LOGGING ---
    function logSystemTransaction(type, amount, from, to, desc) {
        if(!app.transactionLog) app.transactionLog = [];
        app.transactionLog.unshift({
            id: Date.now() + Math.floor(Math.random() * 1000), // More unique
            date: new Date().toLocaleDateString('fa-IR'),
            time: new Date().toLocaleTimeString('fa-IR'),
            type: type, // 'expense', 'deposit', 'transfer'
            amount: amount,
            from: from,
            to: to,
            desc: desc
        });
        // Keep logs manageable
        if(app.transactionLog.length > 500) app.transactionLog.pop();
        saveData();
    }

    function openGlobalHistory(e) {
        e.stopPropagation();
        filterGlobalHistory(); // Init Render
        openModal('globalHistoryModal');
    }

    // Instruction 2: Fix Missing Transactions in Global History
    function filterGlobalHistory() {
        const query = document.getElementById('globalHistSearch').value.toLowerCase();
        const list = document.getElementById('globalHistoryList');
        
        // 1. جمع‌آوری تمام تراکنش‌ها از منابع مختلف
        let allTransactions = [];

        // الف) لاگ‌های سیستمی (موجود)
        if (app.transactionLog) {
            allTransactions = allTransactions.concat(app.transactionLog.map(t => ({...t, source: 'system'})));
        }

        // ب) تراکنش‌های بودجه (هزینه و واریز)
        if (app.budgets) {
            app.budgets.forEach(b => {
                if (b.history) {
                    b.history.forEach(h => {
                        allTransactions.push({
                            id: h.id || Date.now() + Math.random(),
                            date: h.date,
                            time: h.time,
                            type: h.type, // expense, deposit, transferOut, transferIn
                            amount: h.amount,
                            desc: `${h.reason} (${b.name})`, // افزودن نام بودجه به توضیحات
                            from: h.type === 'deposit' ? 'منبع خارجی' : b.name,
                            to: h.type === 'expense' ? 'هزینه' : b.name,
                            source: 'budget'
                        });
                    });
                }
            });
        }

        // ج) انتقال‌های وجه به وجه (بانکی)
        if (app.transfers) {
            app.transfers.forEach(t => {
                let type = t.type === 'incoming' ? 'deposit' : 'expense';
                let desc = t.type === 'incoming' ? `دریافت از ${t.senderName || 'ناشناس'}` : `انتقال به ${t.destName || 'ناشناس'}`;
                
                allTransactions.push({
                    id: t.id,
                    date: t.date,
                    time: "00:00", // معمولاً در ترنسفرها ساعت دقیق نداریم مگر اینکه اضافه کرده باشید
                    type: type,
                    amount: t.amount,
                    desc: desc,
                    from: t.type === 'incoming' ? t.senderName : 'کیف پول من',
                    to: t.type === 'incoming' ? 'کیف پول من' : t.destName,
                    source: 'transfer'
                });
            });
        }

        // 2. فیلتر کردن بر اساس جستجو
        const filtered = allTransactions.filter(t => {
            const txt = (t.desc + " " + t.amount + " " + t.date + " " + t.from + " " + t.to).toLowerCase();
            return txt.includes(query);
        });

        // 3. مرتب‌سازی بر اساس تاریخ و زمان (نزولی - جدیدترین اول)
        // نکته: چون فرمت تاریخ شمسی است، مقایسه رشته‌ای معمولاً جواب می‌دهد (سال/ماه/روز)
        filtered.sort((a, b) => {
            const dateA = a.date + " " + a.time;
            const dateB = b.date + " " + b.time;
            return dateB.localeCompare(dateA);
        });

        // 4. نمایش در HTML
        if(filtered.length === 0) {
            list.innerHTML = `<p style="text-align:center; padding:20px; color:var(--text-sec);">تراکنشی یافت نشد.</p>`;
            return;
        }

        let html = `<table class="history-table">
            <thead>
                <tr>
                    <th>نوع</th>
                    <th>شرح</th>
                    <th>مبلغ</th>
                    <th>تاریخ</th>
                </tr>
            </thead>
            <tbody>`;

        html += filtered.map(t => {
            let iconClass = "ht-trf";
            let icon = "fa-exchange-alt";
            // تشخیص نوع برای آیکون و رنگ
            if(t.type === 'deposit' || t.type === 'incoming' || t.type === 'transferIn') { 
                iconClass = "ht-inc"; icon = "fa-arrow-down"; 
            }
            if(t.type === 'expense' || t.type === 'outgoing' || t.type === 'transferOut') { 
                iconClass = "ht-exp"; icon = "fa-arrow-up"; 
            }
            
            // آماده‌سازی داده برای نمایش رسید (فقط فیلدهای ضروری)
            const receiptData = {
                amount: t.amount,
                from: t.from || '---',
                to: t.to || '---',
                desc: t.desc,
                id: t.id,
                date: t.date,
                time: t.time
            };
            const dataStr = encodeURIComponent(JSON.stringify(receiptData));

            return `
            <tr onclick="showTransactionReceipt('${dataStr}')">
                <td><div class="ht-icon ${iconClass}"><i class="fas ${icon}"></i></div></td>
                <td>
                    <div style="font-weight:bold; font-size:0.85rem;">${t.desc}</div>
                    <div style="font-size:0.7rem; color:var(--text-sec);">${t.source === 'budget' ? 'بودجه' : (t.source === 'transfer' ? 'بانکی' : 'سیستمی')}</div>
                </td>
                <td class="ht-amount">${format(t.amount)}</td>
                <td>
                    <span class="ht-date">${t.date}</span>
                    <span class="ht-date" style="font-size:0.65rem;">${t.time}</span>
                </td>
            </tr>`;
        }).join('');

        html += `</tbody></table>`;
        list.innerHTML = html;
    }

    function showTransactionReceipt(dataStr) {
        const t = JSON.parse(decodeURIComponent(dataStr));
        showReceipt(true, t.amount, t.from || 'سیستم', app.user.name, t.to || '---', t.desc, t.id, t.date + ' ' + t.time);
    }

    // --- HELPER FUNCTIONS ---
    function getSpecialWalletName(type) {
        if (type === 'debt') return CONST_WALLET_DEBT;
        if (type === 'check') return CONST_WALLET_CHECK;
        return null;
    }

    function ensureSpecialWalletExists(name) {
        if (!app.wallets.find(w => w.name === name)) {
            app.wallets.push({ name: name, value: 0 });
            // Log creation
            logSystemTransaction('system', 0, 'System', name, 'ایجاد کیف پول اختصاصی');
            return true;
        }
        return false;
    }

    // --- INTERNAL TRANSFER LOGIC (Wallet to Wallet) ---
    function openInternalTransfer(targetWalletName) {
        tempInternalTargetName = targetWalletName;
        document.getElementById('itTargetName').innerText = targetWalletName;
        
        // Populate Source Select (exclude current target AND restricted wallets)
        const sel = document.getElementById('itSourceSelect');
        sel.innerHTML = app.wallets
            .map((w, i) => {
                if (w.name === targetWalletName) return '';
                if (RESTRICTED_SOURCES.includes(w.name)) return ''; // Filter out External Wallets
                return `<option value="${i}">${w.name} (موجودی: ${format(w.value)})</option>`;
            }).join('');
        
        // Reset fields
        document.getElementById('itAmount').value = '';
        document.getElementById('itSourceBalance').innerText = 'موجودی: ---';
        
        // Calculate Free Funds logic
        // Logic: Total Money in Wallets - Money currently in Restricted Wallets (Debt/Check) - Money already allocated to Budgets (Manual Adds + Distributed %)
        
        const income = app.wallets.reduce((a,b)=>a+b.value,0);
        const restrictedWallets = [CONST_WALLET_DEBT, CONST_WALLET_CHECK];
        const restrictedValue = app.wallets.filter(w => restrictedWallets.includes(w.name)).reduce((a,w) => a+w.value, 0);
        const manualDeductions = app.budgets.reduce((a,b) => a + (b.manualAdd || 0), 0);
        
        let distributableNet = income - restrictedValue - manualDeductions;
        if (distributableNet < 0) distributableNet = 0;
        
        let freeFunds = distributableNet - app.distributedAmount;
        if (freeFunds < 0) freeFunds = 0; 

        document.getElementById('itFreeFundsDisplay').innerText = format(freeFunds) + " تومان";

        // Attach change listener
        sel.onchange = function() {
            const idx = this.value;
            if(idx !== "") {
                document.getElementById('itSourceBalance').innerText = `موجودی: ${format(app.wallets[idx].value)}`;
            } else {
                document.getElementById('itSourceBalance').innerText = 'موجودی: ---';
            }
        };
        // Trigger once
        sel.onchange();

        openModal('internalTransferModal');
    }

    function performInternalTransfer() {
        const sourceIdx = document.getElementById('itSourceSelect').value;
        const targetName = tempInternalTargetName;
        const amountVal = document.getElementById('itAmount').value;
        const amount = parseFormatted(amountVal);

        if (sourceIdx === "" || isNaN(amount) || amount <= 0) return alert("لطفا مبلغ و مبدا را صحیح انتخاب کنید.");

        const sourceWallet = app.wallets[sourceIdx];
        const targetWallet = app.wallets.find(w => w.name === targetName);

        if (!targetWallet) {
             ensureSpecialWalletExists(targetName);
             return performInternalTransfer(); 
        }

        // Condition 1: Budget Limit
        if (sourceWallet.value < amount) return alert("موجودی کیف پول مبدا کافی نیست.");

        // Condition 2: Not previously divided check (using Free Funds logic)
        const income = app.wallets.reduce((a,b)=>a+b.value,0);
        const restrictedWallets = [CONST_WALLET_DEBT, CONST_WALLET_CHECK];
        const restrictedValue = app.wallets.filter(w => restrictedWallets.includes(w.name)).reduce((a,w) => a+w.value, 0);
        const manualDeductions = app.budgets.reduce((a,b) => a + (b.manualAdd || 0), 0);
        let distributableNet = income - restrictedValue - manualDeductions;
        let freeFunds = distributableNet - app.distributedAmount;
        
        // This check ensures we aren't moving money that is already "claimed" by the budget distribution system
        if (freeFunds < amount) {
            return alert(`خطا: مبلغ وارد شده (${format(amount)}) بیشتر از مبلغ آزاد سیستم (${format(freeFunds)}) است. بخشی از این پول قبلاً در بودجه‌بندی توزیع شده است.`);
        }

        // Execute Transfer
        sourceWallet.value -= amount;
        targetWallet.value += amount;

        // Log it
        logSystemTransaction('transfer', amount, sourceWallet.name, targetWallet.name, 'شارژ کیف پول (انتقال داخلی)');
        
        saveData();
        renderUI();
        closeAllModals();
        showToast("انتقال انجام شد");
    }


    function openUniversalInput(title, label, isMoney, callback, isSelectWallet = false) {
        document.getElementById('uInputTitle').innerText = title;
        document.getElementById('uInputLabel').innerText = label;
        const txtWrap = document.getElementById('uInputTextWrapper');
        const monWrap = document.getElementById('uInputMoneyWrapper');
        const selWrap = document.getElementById('uInputSelectWrapper');

        document.getElementById('uInputText').value = '';
        document.getElementById('uInputMoney').value = '';

        txtWrap.style.display = 'none';
        monWrap.style.display = 'none';
        selWrap.style.display = 'none';

        if (isSelectWallet) {
            selWrap.style.display = 'block';
            const sel = document.getElementById('uInputSelect');
            sel.innerHTML = app.wallets.map((w, i) => `<option value="${i}">${w.name} (موجودی: ${format(w.value)})</option>`).join('');
            if(title.includes("دریافت")) {
                sel.innerHTML += `<option value="new">++ ایجاد کیف پول جدید</option>`;
            }
        } else if(isMoney) {
            monWrap.style.display = 'block';
        } else {
            txtWrap.style.display = 'block';
        }

        universalCallback = callback;
        openModal('universalInputModal');
    }

    function submitUniversalInput() {
        const txtWrap = document.getElementById('uInputTextWrapper');
        const selWrap = document.getElementById('uInputSelectWrapper');
        let val;
        if (selWrap.style.display !== 'none') {
            val = document.getElementById('uInputSelect').value;
        } else if(txtWrap.style.display === 'none') {
            val = parseFormatted(document.getElementById('uInputMoney').value);
        } else {
            val = document.getElementById('uInputText').value;
        }

        if(universalCallback) universalCallback(val);
        closeAllModals();
    }

    function changeecUserName() {
        openUniversalInput('تغییر نام', 'نام جدید را وارد کنید:', false, (val) => {
            if(val && val.trim() !== "") {
                app.user.name = val;
                saveData();
                renderUI();
            }
        });
        // Pre-fill name
        document.getElementById('uInputText').value = app.user.name;
    }

    function formatCurrency(input) {
        let val = input.value;
        if (!val) return;
        val = val.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d))
            .replace(/[٠-٩]/g, d => '٠١٢٣٤٥٦٧٨٩'.indexOf(d));
        let cleanVal = val.replace(/[^0-9]/g, '');

        if (cleanVal) {
            input.value = Number(cleanVal).toLocaleString('en-US');
            if(input.id === 'btAmountInput') {
                document.getElementById('btAmountDisplay').innerText = format(Number(cleanVal));
            }
        } else {
            input.value = '';
            if(input.id === 'btAmountInput') document.getElementById('btAmountDisplay').innerText = "۰";
        }
    }

    function parseFormatted(val) {
        if(!val) return 0;
        if(typeof val === 'number') return val;
        let s = val.toString().replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d))
            .replace(/[٠-٩]/g, d => '٠١٢٣٤٥٦٧٨٩'.indexOf(d));
        s = s.replace(/,/g, '');
        let res = parseInt(s);
        return isNaN(res) ? 0 : res;
    }

    function format(n) {
        return toPersianNum((n * rate).toLocaleString('en-US'));
    }

    function saveSectionSnap(section, description = "تغییر بدون توضیح") {
        let snap = null;
        if(section === 'dashboard') {
            snap = JSON.stringify({ wallets: app.wallets, debts: app.debts, checks: app.checks, loans: app.loans });
        } else if(section === 'budget') {
            snap = JSON.stringify({ budgets: app.budgets, priorities: app.priorities, distributedAmount: app.distributedAmount });
        } else if(section === 'tools') {
            snap = JSON.stringify({ goals: app.goals, shopping: app.shopping });
        }

        if(!app.sectionHistory[section]) app.sectionHistory[section] = [];
        app.sectionHistory[section].unshift({ time: new Date().toLocaleTimeString('fa-IR'), data: snap, description: description });
        if(app.sectionHistory[section].length > 10) app.sectionHistory[section].pop();
        saveData();
    }

    function showSectionHistory(section) {
        const list = document.getElementById('sectionHistoryList');
        const hist = app.sectionHistory[section] || [];
        if(hist.length === 0) {
            list.innerHTML = "<p style='text-align:center'>سابقه‌ای موجود نیست.</p>";
        } else {
            list.innerHTML = hist.map((h, i) => `<div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="restoreSectionSnap('${section}', ${i})">
                 <div style="text-align:right;">
                   <span style="display:block; font-weight:bold; font-size:0.9rem; color:var(--text-main); margin-bottom:5px;">${h.description || 'تغییر سیستم'}</span>
                   <span style="font-size:0.75rem; color:var(--text-sec);">${toPersianNum(h.time)}</span>
                 </div>
                 <i class="fas fa-undo" style="color:var(--primary); font-size:1.1rem;"></i>
               </div>`).join('');
        }
        openModal('sectionHistoryModal');
    }

    function restoreSectionSnap(section, index) {
        if(!confirm("آیا مطمئن هستید؟ با این کار وضعیت به حالت انتخاب شده برمی‌گردد.")) return;
        withLoading(() => {
            const snap = JSON.parse(app.sectionHistory[section][index].data);
            if(section === 'dashboard') {
                app.wallets = snap.wallets;
                app.debts = snap.debts;
                app.checks = snap.checks;
                app.loans = snap.loans;
            } else if(section === 'budget') {
                app.budgets = snap.budgets;
                app.priorities = snap.priorities;
                app.distributedAmount = snap.distributedAmount || 0;
            } else if(section === 'tools') {
                app.goals = snap.goals;
                app.shopping = snap.shopping;
            }
            logSystemTransaction('system', 0, 'Backup', 'Restore', `بازیابی بخش ${section}`);
            saveData();
            renderUI();
            closeAllModals();
            showToast("بازیابی شد");
        }, 1000);
    }

    function toggleBalanceHide(e) {
        e.stopPropagation();
        isBalanceHidden = !isBalanceHidden;
        const balEl = document.getElementById('totalBalance');
        const icon = document.getElementById('eyeIcon');
        if(isBalanceHidden) {
            balEl.innerText = toPersianNum("۰۰۰");
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            renderUI(); 
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    // --- BANK TRANSFER WIZARD ---
    function openBankTransfer(e) {
        e.stopPropagation();
        app.wizardState = {};
        renderTransferStep1();
        openModal('bankTransferModal');
    }

    function renderTransferStep1() {
        const content = document.getElementById('btContent');
        content.innerHTML = `
           <h3>انتقال وجه</h3>
           <div id="btStep1">
             <p style="color:var(--text-sec); font-size:0.9rem;">شماره کارت یا حساب مقصد را وارد کنید (فقط ۱۰ رقم):</p>
             <input type="tel" id="btDestInput" placeholder="xxxx-xxxx-xx" maxlength="10" style="text-align:center; letter-spacing:2px; font-weight:bold;" value="${app.wizardState.dest || ''}">
             <button class="btn btn-primary" style="width:100%; margin-bottom:10px;" onclick="bankTransferNext(1)">ادامه</button>
             <button class="btn btn-outline" style="width:100%" onclick="closeAllModals()">انصراف</button>
           </div>
        `;
    }

    function bankTransferNext(step) {
        const content = document.getElementById('btContent');

        if (step === 1) {
            const dest = document.getElementById('btDestInput').value;
            const cleanDest = dest.replace(/[^0-9]/g, '');
            if(cleanDest.length < 10) return alert("شماره حساب نامعتبر است.");
            
            toggleLoading(true);
            // استعلام واقعی از سرور
            googleApi('apiGetAccountName', cleanDest).then(res => {
                toggleLoading(false);
                if(res.success) {
                    app.wizardState.dest = cleanDest;
                    app.wizardState.destName = res.name;
                    app.wizardState.destNatId = res.nationalId;

                    content.innerHTML = `
                      <h3>مبلغ انتقال</h3>
                      <div style="background:rgba(16, 185, 129, 0.1); padding:10px; border-radius:10px; margin-bottom:15px; text-align:center;">
                        <span style="font-size:0.8rem; color:var(--text-sec);">انتقال به:</span><br>
                        <b style="font-size:1.1rem; color:var(--success);">${res.name}</b>
                        <div style="font-size:0.8rem; letter-spacing:1px;">${toPersianNum(cleanDest)}</div>
                      </div>
                      <div class="money-input-wrapper">
                         <input type="text" id="btAmountInput" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="۰">
                         <span class="money-unit currency-text">${document.getElementById('currBtnText').innerText}</span>
                      </div>
                      <div style="display:flex; gap:10px;">
                         <button class="btn btn-outline" style="flex:1" onclick="renderTransferStep1()">بازگشت</button>
                         <button class="btn btn-primary" style="flex:1" onclick="bankTransferNext(2)">ادامه</button>
                      </div>
                    `;
                } else {
                    alert(res.message);
                }
            }).catch(err => alert("خطا: " + err));

        } else if (step === 2) {
            const amtVal = document.getElementById('btAmountInput').value;
            const amt = parseFormatted(amtVal);
            if(amt <= 0) return alert("مبلغ نامعتبر است");
            app.wizardState.amount = amt;
            
            let walletsHtml = '';
            app.wallets.forEach((w, idx) => {
                if (RESTRICTED_SOURCES.includes(w.name)) return;
                walletsHtml += `
                 <div class="checkbox-wrapper" onclick="selectTransferWallet(${idx})" style="border:1px solid #eee; justify-content:space-between;">
                    <span>${w.name} (${format(w.value)})</span>
                    <input type="radio" name="trWallet" id="trW_${idx}" value="${idx}">
                 </div>`;
            });

            content.innerHTML = `
              <h3>انتخاب کیف پول مبدا</h3>
              <p style="font-size:0.9rem;">مبلغ: <b>${format(amt)}</b></p>
              <div style="max-height:200px; overflow-y:auto;">${walletsHtml}</div>
              <div style="display:flex; gap:10px; margin-top:10px;">
                 <button class="btn btn-outline" style="flex:1" onclick="bankTransferNext(1)">بازگشت</button>
                 <button class="btn btn-primary" style="flex:1" onclick="bankTransferNext(3)">تایید نهایی</button>
              </div>
            `;
        } else if (step === 3) {
            const selectedWallet = document.querySelector('input[name="trWallet"]:checked');
            if(!selectedWallet) return alert("لطفاً یک کیف پول انتخاب کنید.");
            app.wizardState.walletIdx = parseInt(selectedWallet.value);

            content.innerHTML = `
              <h3>تایید نهایی</h3>
              <p style="text-align:center;">انتقال <b>${format(app.wizardState.amount)}</b><br>به <b>${app.wizardState.destName}</b></p>
              <label>رمز عبور (۴ رقم):</label>
              <input type="password" id="btPinInput" maxlength="4" inputmode="numeric" pattern="[0-9]*" placeholder="****" style="text-align:center;">
              <div style="display:flex; gap:10px; margin-top:15px;">
                 <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
                 <button class="btn btn-primary" style="flex:1" onclick="bankTransferCheckPin()">انتقال</button>
              </div>
            `;
        }
    }
    
    function selectTransferWallet(idx) {
        document.getElementById(`trW_${idx}`).checked = true;
    }

    function updateTransferTotal() {
        const inputs = document.querySelectorAll('.wallet-deduct-input');
        let total = 0;
        inputs.forEach(inp => {
            let val = inp.value.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d)).replace(/[^0-9]/g, '');
            if(val) {
                total += parseInt(val);
                inp.value = parseInt(val).toLocaleString('en-US'); 
            }
        });

        const req = app.wizardState.amount;
        const el = document.getElementById('transferProgress');
        el.innerText = `انتخاب شده: ${format(total)} / ${format(req)}`;
        if(total === req) el.style.color = 'var(--success)';
        else el.style.color = 'var(--danger)';
    }

    function bankTransferCheckPin() {
        const pin = document.getElementById('btPinInput').value;
        if (pin !== app.security.password) return alert("رمز عبور اشتباه است!");

        toggleLoading(true);
        googleApi('apiInitiateTransfer', 
            app.security.nationalId, 
            app.wizardState.destNatId, 
            app.wizardState.amount, 
            app.wizardState.walletIdx,
            app.user.name,
            getAccountNumber()
        ).then(res => {
            toggleLoading(false);
            if(res.success) {
                Object.assign(app, res.appData); 
                
                saveData(); 
                renderUI();
                closeAllModals();
                showToast("انتقال انجام شد و در انتظار تایید گیرنده است.");
            } else {
                alert("خطا: " + res.message);
            }
        }).catch(err => {
            toggleLoading(false);
            alert("خطا: " + err);
        });
    }

    function showReceipt(success, amount, sourceAcc, sourceName, destAcc, destName, txId, dateTime) {
        closeAllModals();
        const container = document.getElementById('receiptContainer');
        const statusClass = success ? 'status-success' : 'status-fail';
        const statusText = success ? 'موفق' : 'ناموفق';
        const color = success ? '#059669' : '#dc2626';

        container.innerHTML = `
          <div class="receipt-card" id="finalReceipt">
             <div class="receipt-header">
                <h2 class="receipt-title">رسید تراکنش</h2>
                <div class="receipt-status ${statusClass}">${statusText}</div>
             </div>
             <div class="receipt-amount" style="color:${color}">${format(amount)} ریال</div>
             
             <div class="receipt-row">
                <span class="receipt-label">مبدا</span>
                <span class="receipt-val">${toPersianNum(sourceAcc)}</span>
             </div>
             <div class="receipt-row">
                <span class="receipt-label">نام فرستنده</span>
                <span class="receipt-val">${sourceName}</span>
             </div>
             <hr style="border:0; border-top:1px dashed #eee; margin:10px 0;">
             <div class="receipt-row">
                <span class="receipt-label">مقصد</span>
                <span class="receipt-val">${toPersianNum(destAcc)}</span>
             </div>
             <div class="receipt-row">
                <span class="receipt-label">گیرنده/شرح</span>
                <span class="receipt-val">${destName}</span>
             </div>
             <hr style="border:0; border-top:1px dashed #eee; margin:10px 0;">
             <div class="receipt-row">
                <span class="receipt-label">زمان</span>
                <span class="receipt-val">${toPersianNum(dateTime || '')}</span>
             </div>
             <div class="receipt-row">
                <span class="receipt-label">شناسه</span>
                <span class="receipt-val">${toPersianNum(txId || '')}</span>
             </div>
          </div>
        `;
        openModal('receiptModal');
    }

    // Instruction 1: Fix Freeze on Download (Optimized)
    function downloadReceipt() {
        const el = document.getElementById('finalReceipt');
        
        // اطمینان از اینکه مودال باز است و المنت وجود دارد
        if (!el) {
            showToast("خطا: رسید یافت نشد", "exclamation-triangle");
            return;
        }

        // نمایش لودینگ
        toggleLoading(true);

        // استفاده از setTimeout برای جلوگیری از فریز شدن UI قبل از شروع رندر
        setTimeout(() => {
            html2canvas(el, { 
                scale: 2, // کیفیت بهتر
                useCORS: true, // حل مشکل آیکون‌ها و فونت‌های خارجی
                logging: false, // غیرفعال کردن لاگ‌های اضافی
                backgroundColor: '#ffffff' // اطمینان از پس‌زمینه سفید
            }).then(canvas => {
                try {
                    // ایجاد لینک دانلود
                    const a = document.createElement('a');
                    a.download = `Receipt_${Date.now()}.png`;
                    a.href = canvas.toDataURL('image/png');
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    showToast("رسید با موفقیت ذخیره شد");
                } catch (err) {
                    console.error("Save Error:", err);
                    alert("خطا در ذخیره فایل: " + err.message);
                } finally {
                    // * نکته کلیدی: حتماً لودینگ را خاموش کن *
                    toggleLoading(false);
                }
            }).catch(err => {
                console.error("Render Error:", err);
                alert("خطا در ایجاد تصویر رسید: " + err.message);
                toggleLoading(false); // در صورت خطا هم لودینگ خاموش شود
            });
        }, 100); // تاخیر 100 میلی‌ثانیه‌ای برای پایداری
    }

    // --- OTHER UI LOGIC ---
    function renderTransfers() {
        const list = document.getElementById('transfersList');
        if(!app.transfers || app.transfers.length === 0) {
            list.innerHTML = `<p style="text-align:center; color:var(--text-sec); padding:10px;">تراکنشی یافت نشد.</p>`;
            return;
        }

        list.innerHTML = app.transfers.slice().reverse().map(t => {
            const isIncoming = t.type === 'incoming';
            
            // تعیین متن و رنگ وضعیت
            let statusLabel = "نامشخص";
            let statusClass = "ts-pending";
            
            if (t.status === 'success') { statusLabel = "موفق"; statusClass = "ts-approved"; }
            else if (t.status === 'rejected') { statusLabel = "رد شده (برگشت وجه)"; statusClass = "ts-rejected"; }
            else if (t.status === 'pending_approval') { statusLabel = "در انتظار تایید گیرنده"; statusClass = "ts-pending"; }
            else if (t.status === 'pending_action') { statusLabel = "نیازمند تایید شما"; statusClass = "ts-pending"; }

            const icon = isIncoming ? 'fa-arrow-down' : 'fa-arrow-up';
            const color = isIncoming ? 'var(--success)' : 'var(--danger)';
            const partyName = isIncoming ? t.otherPartyName : t.otherPartyName;

            // دکمه‌های عملیات فقط برای گیرنده و زمانی که وضعیت pending_action است
            let actions = '';
            if(isIncoming && t.status === 'pending_action') {
                actions = `
                  <div style="margin-top:10px; display:flex; gap:10px;">
                     <button class="btn btn-success" style="padding:6px 12px; font-size:0.8rem; width:100%" onclick="processTransfer('${t.id}', 'approve')">تایید و دریافت</button>
                     <button class="btn btn-danger" style="padding:6px 12px; font-size:0.8rem; width:100%" onclick="processTransfer('${t.id}', 'reject')">رد کردن</button>
                  </div>`;
            }

            return `
             <div class="transfer-list-item">
               <div style="flex:1">
                 <div class="t-info">
                   <h4><i class="fas ${icon}" style="color:${color}"></i> ${isIncoming ? 'دریافت از: ' : 'واریز به: '} ${partyName}</h4>
                   <p>${t.date} | ${toPersianNum(t.amount)} تومان</p>
                 </div>
                 ${actions}
               </div>
               <div style="text-align:left;">
                 <div class="t-status ${statusClass}">${statusLabel}</div>
               </div>
             </div>`;
        }).join('');
    }

    function processTransfer(txId, action) {
        let walletIdx = null;
        
        if (action === 'approve') {
            // اگر تایید کرد، باید بپرسیم به کدام کیف پول واریز شود
            openUniversalInput("دریافت وجه", "واریز به کدام کیف پول؟", false, (val) => {
                if(val === "new") walletIdx = 'new';
                else walletIdx = parseInt(val);
                
                sendProcessRequest(txId, 'approve', walletIdx);
            }, true);
        } else {
            if(!confirm("آیا مطمئن هستید؟ وجه به فرستنده برگشت داده می‌شود.")) return;
            sendProcessRequest(txId, 'reject', null);
        }
    }

    function sendProcessRequest(txId, action, walletIdx) {
        toggleLoading(true);
        googleApi('apiProcessTransfer', app.security.nationalId, txId, action, walletIdx)
            .then(res => {
                toggleLoading(false);
                if(res.success) {
                    Object.assign(app, res.appData); // آپدیت داده‌ها
                    saveData();
                    renderUI();
                    showToast(action === 'approve' ? "دریافت شد" : "رد شد");
                } else {
                    alert("خطا: " + res.message);
                }
            })
            .catch(err => {
                toggleLoading(false);
                alert("خطا: " + err);
            });
    }

    function simulateIncomingTransfer() {
        const t = {
            id: Date.now(),
            type: 'incoming',
            amount: 500000,
            date: new Date().toLocaleDateString('fa-IR'),
            senderName: 'علی محمدی (تست)',
            senderAccount: '60379971...',
            status: 'pending'
        };
        if(!app.transfers) app.transfers = [];
        app.transfers.push(t);
        saveData();
        renderUI();
        showToast("درخواست دریافت ایجاد شد");
    }

    function approveTransfer(id) {
        const tIndex = app.transfers.findIndex(x => x.id === id);
        if(tIndex === -1) return;

        openUniversalInput("دریافت وجه", "واریز به کدام کیف پول؟", false, (val) => {
            let wIdx;
            if(val === "new") {
                app.wallets.push({name: "دریافت وجه", value: 0});
                wIdx = app.wallets.length - 1;
            } else {
                wIdx = parseInt(val);
            }

            app.transfers[tIndex].status = 'approved';
            app.wallets[wIdx].value += app.transfers[tIndex].amount;
            app.transfers[tIndex].details = `واریز به: ${app.wallets[wIdx].name}`;
            logSystemTransaction('deposit', app.transfers[tIndex].amount, app.transfers[tIndex].senderName, app.wallets[wIdx].name, 'دریافت وجه');
            saveData();
            renderUI();
            showToast("مبلغ به کیف پول افزوده شد");
        }, true);
    }

    function rejectTransfer(id) {
        const tIndex = app.transfers.findIndex(x => x.id === id);
        if(tIndex === -1) return;

        if(confirm("آیا این دریافت را رد می‌کنید؟")) {
            app.transfers[tIndex].status = 'rejected';
            saveData();
            renderUI();
            showToast("دریافت رد شد");
        }
    }

    // --- MAIN RENDER LOGIC (Modified Instruction 4) ---
    function renderUI() {
        applyTheme();
        rate = app.user.currency === 'rial' ? 10 : 1;
        const curName = app.user.currency === 'toman' ? 'تومان' : 'ریال';
        
        document.getElementById('currBtnText').innerText = curName;
        document.getElementById('cardCurrency').innerText = curName;
        document.querySelectorAll('.currency-text').forEach(el => el.innerText = curName);
        
        // --- اصلاح جدید: اعمال خودکار قالب پیش‌فرض اگر بودجه خالی بود (Instruction 4) ---
        if (!app.budgets || app.budgets.length === 0) {
            // بارگذاری قالب پیش‌فرض بدون پرسش از کاربر (چون بار اول است)
            app.budgets = JSON.parse(JSON.stringify(defaultState.budgets));
            // ذخیره فوری تا در دفعات بعد هم بماند
            saveData();
        }
        // --------------------------------------------------------------

        const income = app.wallets.reduce((a,b)=>a+b.value,0);
        
        // BUDGET CALCULATION
        const restrictedWallets = [CONST_WALLET_DEBT, CONST_WALLET_CHECK];
        const restrictedValue = app.wallets.filter(w => restrictedWallets.includes(w.name)).reduce((a,w) => a+w.value, 0);
        const manualDeductions = app.budgets.reduce((a,b) => a + (b.manualAdd || 0), 0);
        
        let cardNet = income; // Card shows total assets
        
        // Distributable Calculation:
        let distributableNet = income - restrictedValue - manualDeductions;
        if (distributableNet < 0) distributableNet = 0;

        const balEl = document.getElementById('totalBalance');
        if(!isBalanceHidden) balEl.innerText = format(cardNet);

        // Name Update Here
        const uName = app.user.name || 'کاربر';
        document.getElementById('userNameDisplay').innerText = uName;
        adjustNameFontSize(); // Instruction 3: Auto-resize name
        document.getElementById('settingsUserName').innerText = uName;
        document.getElementById('settingsNatId').innerText = toPersianNum(app.security.nationalId) || 'کد ملی ثبت نشده';

        document.getElementById('cardAccountNumber').innerHTML = `<span id="accNumText">${getAccountNumber()}</span> <i class="fas fa-copy" style="font-size:1rem; cursor:pointer; opacity:0.8;" onclick="copyToClipboard(document.getElementById('accNumText').innerText)"></i>`;

        renderWallets();
        renderDebts();
        renderChecks();
        renderLoans();
        renderBudgets(distributableNet);
        renderGoals();
        renderShop();
        renderReports();
        renderTransfers();
    }

    // Instruction 3: Auto-resize name logic
    function adjustNameFontSize() {
        const el = document.getElementById('userNameDisplay');
        const textLength = el.innerText.length;
        if (textLength > 20) el.style.fontSize = '0.7rem';
        else if (textLength > 15) el.style.fontSize = '0.8rem';
        else el.style.fontSize = '0.9rem';
    }

    function showCardDetails() {
        const income = app.wallets.reduce((a,b)=>a+b.value,0);
        
        const fixedDebt = app.debts.reduce((a,b)=>a+b.value,0);
        const checkDebt = (app.checks || []).reduce((a,b)=>!b.isPaid ? a+b.value : a, 0);
        const totalDebt = fixedDebt + checkDebt;

        let net = income - totalDebt;
        if(net < 0) net = 0;

        const shoppingTotal = app.shopping.reduce((a,b) => {
            const price = b.price || 0;
            const paid = b.paid || 0;
            return a + (price - paid > 0 ? price - paid : 0);
        }, 0);
        const goalsTotal = app.goals.reduce((a,b) => a + (b.target - b.curr), 0);
        const loansTotal = app.loans.reduce((a,b) => !b.isReceived ? a + b.value : a, 0);

        const content = document.getElementById('cardDetailsContent');
        content.innerHTML = `
          <div class="detail-row">
             <span class="detail-label">مجموع موجودی (ناخالص):</span>
             <span class="detail-val" id="cpGross">${format(income)}</span>
          </div>
          <div class="detail-row">
             <span class="detail-label">خالص (پس از کسر بدهی‌ها):</span>
             <span class="detail-val" style="color:var(--primary)" id="cpNet">${format(net)}</span>
          </div>
          <div class="detail-row">
             <span class="detail-label">مجموع کل بدهی‌ها:</span>
             <span class="detail-val" style="color:var(--danger)" id="cpDebt">${format(totalDebt)}</span>
          </div>
          <div class="detail-row">
             <span class="detail-label">هزینه لیست خرید:</span>
             <span class="detail-val" id="cpShop">${format(shoppingTotal)}</span>
          </div>
          <div class="detail-row">
             <span class="detail-label">اهداف پس‌انداز (مانده):</span>
             <span class="detail-val" id="cpGoal">${format(goalsTotal)}</span>
          </div>
          <div class="detail-row">
             <span class="detail-label">مجموع طلب‌ها:</span>
             <span class="detail-val" style="color:var(--success)" id="cpLoan">${format(loansTotal)}</span>
          </div>`;
        openModal('cardDetailsModal');
    }

    function copyCardDetails() {
        const gross = document.getElementById('cpGross').innerText;
        const net = document.getElementById('cpNet').innerText;
        const debt = document.getElementById('cpDebt').innerText;
        const acc = document.getElementById('cardAccountNumber').innerText;

        const txt = `وضعیت مالی ${app.user.name}\nشماره حساب: ${acc}\nموجودی کل: ${gross}\nخالص: ${net}\nبدهی‌ها: ${debt}`;
        navigator.clipboard.writeText(txt);
        showToast("اطلاعات کپی شد");
    }

    function renderWallets() {
        const div = document.getElementById('walletList');
        div.innerHTML = app.wallets.map((w, i) => `
            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:12px; align-items:center;">
                <span style="font-weight:600;">${w.name}</span>
                <div style="display:flex; align-items:center;">
                    <b style="font-size:1.1rem; color:var(--primary);">${format(w.value)}</b>
                    <span style="margin-right:15px; display:flex;">
                       <button class="btn-small-icon btn-edit" onclick="openEdit('wallet', ${i})"><i class="fas fa-edit"></i></button>
                       <button class="btn-small-icon btn-del" onclick="delWallet(${i})"><i class="fas fa-trash"></i></button>
                    </span>
                </div>
            </div>`).join('');
    }

    // Instruction 1: Organized Debt Cards
    // Instruction 6 & 7: Advanced Installment Logic
    function renderDebts() {
        const div = document.getElementById('debtList');
        const today = new Date();
        const currentMonthStr = toPersianNum(today.toLocaleDateString('fa-IR-u-nu-latn').split('/').slice(0, 2).join('/'));

        div.innerHTML = app.debts.map((d, i) => {
            // Calculate Stats
            const schedule = generateInstallmentSchedule(d);
            const totalCount = schedule.length;
            const paidCount = schedule.filter(s => s.isPaid).length;
            const overdueCount = schedule.filter(s => s.isOverdue).length;
            const totalSum = d.value * totalCount;
            
            let animClass = "";
            let statusText = "";

            if (totalCount === 0) {
                // رفع باگ: اگر قسطی تولید نشد
                statusText = `<span style="color:var(--text-sec);">بازه‌ای تعریف نشده</span>`;
            } else if (paidCount === totalCount) {
                statusText = `<span style="color:var(--success); font-weight:bold;">تکمیل شده <i class="fas fa-check"></i></span>`;
            } else if (overdueCount > 0) {
                statusText = `<span style="color:var(--danger); font-weight:bold;">${toPersianNum(overdueCount)} قسط معوق!</span>`;
                animClass = "status-overdue pulse-danger";
            } else {
                // پیدا کردن نزدیک‌ترین قسط پرداخت نشده
                const nextDue = schedule.find(s => !s.isPaid);
                if (nextDue) {
                    if (nextDue.isDueToday) {
                        statusText = `<span style="color:var(--danger); font-weight:bold;">سررسید امروز!</span>`;
                        animClass = "status-due pulse-danger";
                    } else if (nextDue.daysLeft > 0 && nextDue.daysLeft <= 3) {
                        statusText = `<span style="color:var(--warning); font-weight:bold;">سررسید نزدیک (${toPersianNum(nextDue.daysLeft)} روز)</span>`;
                        animClass = "status-due pulse-warning";
                    } else {
                        statusText = `سررسید بعدی: ${nextDue.date}`;
                    }
                }
            }

            // Instruction 1: Using 'debt-card' class for organization
            return `<div class="debt-card ${animClass}" onclick="openDebtDetails(${i})">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                       <span style="font-weight:bold; font-size:1.05rem;">${d.name}</span>
                       <div style="font-size:0.8rem; margin-top:4px; color:var(--text-sec); line-height:1.6;">${statusText}</div>
                       <div style="font-size:0.75rem; color:var(--text-sec); margin-top:2px;">
                           کل: ${toPersianNum(totalCount)} | پرداخت: ${toPersianNum(paidCount)} | مبلغ کل: ${format(totalSum)}
                       </div>
                    </div>
                    <div style="display:flex; align-items:center;">
                       <b style="color:var(--danger); margin-left:10px;">${format(d.value)}</b>
                       <span style="display:flex; gap:5px;">
                          <button class="btn-small-icon btn-edit" onclick="event.stopPropagation(); openEdit('debt', ${i})"><i class="fas fa-edit"></i></button>
                          <button class="btn-small-icon btn-del" onclick="event.stopPropagation(); delDebt(${i})"><i class="fas fa-trash"></i></button>
                       </span>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    // --- Instruction 3: Updated Installment Generation Logic ---
    function generateInstallmentSchedule(debt) {
        if (!debt.startDate || !debt.endDate) return [];

        const startParts = toEn(debt.startDate).split('/');
        // محاسبه عدد تاریخ پایان برای توقف دقیق حلقه
        const endInt = dateToInt(debt.endDate); 
        
        let y = parseInt(startParts[0]);
        let m = parseInt(startParts[1]);
        let d = parseInt(startParts[2]); // روز ثابت قسط
        
        const schedule = [];
        // نرمال‌سازی لیست پرداخت‌ها
        const paidList = (debt.paidHistory || []).map(p => {
            const pp = toEn(p).split('/');
            // افزودن صفر قبل از اعداد تک رقمی برای مقایسه صحیح
            return `${pp[0]}/${parseInt(pp[1])<10?'0'+parseInt(pp[1]):pp[1]}/${parseInt(pp[2])<10?'0'+parseInt(pp[2]):pp[2]}`;
        });

        // حلقه ایمن (حداکثر ۱۰۰۰ قسط برای جلوگیری از هنگ کردن در صورت اشتباه کاربر)
        let safetyCounter = 0;

        while (safetyCounter < 1000) {
            safetyCounter++;

            // تنظیم روز ماه (جلوگیری از تاریخ نامعتبر مثل ۳۱ اسفند)
            let currentD = d;
            if (m > 6 && m < 12 && currentD > 30) currentD = 30; // ماه‌های ۳۰ روزه
            if (m === 12 && currentD > 29) currentD = 29; // اسفند (فرض ساده ۲۹ روز)

            // ساخت فرمت استاندارد
            const mStr = m < 10 ? '0' + m : m;
            const dStr = currentD < 10 ? '0' + currentD : currentD;
            
            const dateStrEn = `${y}/${mStr}/${dStr}`;
            const currentInt = parseInt(`${y}${mStr}${dStr}`);

            // *** اصلاح اصلی: اگر تاریخ قسط از تاریخ پایان بزرگتر شد، حلقه قطع شود ***
            if (currentInt > endInt) break;

            const dateStrFa = toPersianNum(dateStrEn);
            const isPaid = paidList.includes(dateStrEn);
            const diffDays = compareDates(dateStrEn);
            
            schedule.push({
                date: dateStrFa,
                dateEn: dateStrEn,
                isPaid: isPaid,
                isOverdue: diffDays < 0 && !isPaid,
                isDueToday: diffDays === 0 && !isPaid,
                daysLeft: diffDays
            });

            // رفتن به ماه بعد
            m++;
            if (m > 12) {
                m = 1;
                y++;
            }
        }
        return schedule;
    }

    function openDebtDetails(index) {
        const debt = app.debts[index];
        const schedule = generateInstallmentSchedule(debt);
        const penaltyPercent = debt.penalty || 0;

        document.getElementById('ddTitle').innerText = debt.name;
        
        // Stats
        const total = schedule.length;
        const paid = schedule.filter(s => s.isPaid).length;
        const overdue = schedule.filter(s => s.isOverdue).length;
        document.getElementById('ddStats').innerHTML = `
            <span>تعداد کل: ${toPersianNum(total)}</span>
            <span style="color:var(--success)">پرداخت شده: ${toPersianNum(paid)}</span>
            <span style="color:var(--danger)">معوق: ${toPersianNum(overdue)}</span>
            <span>جریمه: ${toPersianNum(penaltyPercent)}%</span>
        `;

        const list = document.getElementById('ddList');
        list.innerHTML = schedule.map(s => {
            let statusClass = "";
            let statusLabel = "";
            let penaltyAmt = 0;
            let finalAmt = debt.value;

            if (s.isPaid) {
                statusClass = "is-paid";
                statusLabel = "پرداخت شده";
            } else if (s.isOverdue) {
                statusClass = "is-over";
                statusLabel = "معوق";
                // Calculate Penalty
                penaltyAmt = Math.round(debt.value * (penaltyPercent / 100));
                finalAmt += penaltyAmt;
            } else if (s.isDueToday) {
                statusClass = "is-due";
                statusLabel = "سررسید امروز";
            } else {
                statusLabel = "آینده";
            }

            const penaltyHtml = penaltyAmt > 0 ? `<span class="inst-penalty">جریمه دیرکرد: ${format(penaltyAmt)}</span>` : '';
            const btnHtml = !s.isPaid ? `<button class="btn-small-icon btn-check" onclick="paySpecificInstallment(${index}, '${s.dateEn}', ${finalAmt})"><i class="fas fa-check"></i></button>` : '';

            return `
            <div class="inst-row">
                <div>
                    <div style="font-weight:bold;">${toPersianNum(s.date)}</div>
                    <span class="inst-status ${statusClass}">${statusLabel}</span>
                    ${penaltyHtml}
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <b style="direction:ltr;">${format(finalAmt)}</b>
                    ${btnHtml}
                </div>
            </div>`;
        }).join('');

        openModal('debtDetailsModal');
    }

    function paySpecificInstallment(debtIndex, dateStr, amount) {
        const debt = app.debts[debtIndex];
        const walletName = CONST_WALLET_DEBT;
        const walletIndex = app.wallets.findIndex(w => w.name === walletName);
        
        if (walletIndex === -1) {
            alert(`کیف پول '${walletName}' یافت نشد.`);
            ensureSpecialWalletExists(walletName);
            saveData();
            renderUI();
            return;
        }

        const wallet = app.wallets[walletIndex];

        if (wallet.value < amount) {
            if(confirm(`موجودی کیف پول '${walletName}' کافی نیست (${format(wallet.value)}). آیا می‌خواهید اکنون آن را شارژ کنید؟`)) {
                closeAllModals();
                openInternalTransfer(walletName);
            }
            return;
        }

        if(confirm(`آیا مبلغ ${format(amount)} بابت قسط تاریخ ${toPersianNum(dateStr)} پرداخت شود؟`)) {
            app.wallets[walletIndex].value -= amount;
            
            if (!debt.paidHistory) debt.paidHistory = [];
            // ذخیره تاریخ به صورت استاندارد (انگلیسی) برای جلوگیری از مشکلات مقایسه بعدی
            debt.paidHistory.push(toEn(dateStr));
            
            logSystemTransaction('expense', amount, walletName, debt.name, `پرداخت قسط ${dateStr}`);
            saveSectionSnap('dashboard', `پرداخت قسط ${debt.name}`);
            saveData();
            renderUI();
            openDebtDetails(debtIndex); 
            showToast("قسط پرداخت شد");
        }
    }

    function renderChecks() {
        const div = document.getElementById('checkList');
        if(!app.checks) app.checks = [];

        div.innerHTML = app.checks.map((c, i) => {
            if(c.isPaid) {
                return `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:12px; align-items:center; opacity:0.6;">
                          <div><del>${c.name}</del> <small style="color:var(--success);">(پاس شد)</small></div>
                          <div style="display:flex; align-items:center;">
                             <b style="color:var(--text-sec);">${format(c.value)}</b>
                             <button class="btn-small-icon btn-del" onclick="delCheck(${i})" style="margin-right:10px;"><i class="fas fa-trash"></i></button>
                          </div>
                        </div>`;
            }

            let animClass = "";
            let statusMsg = "";
            const diff = compareDates(c.date);

            if (diff < 0) {
                statusMsg = "زمان سررسید گذشته است!";
                animClass = "status-overdue pulse-danger";
            } else if (diff === 0) {
                statusMsg = "سررسید امروز است!";
                animClass = "status-due pulse-danger";
            } else {
                statusMsg = `تاریخ سررسید: ${c.date}`;
                if (diff <= 3) animClass = "status-due pulse-warning";
            }

            return `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:12px; align-items:center; border-radius:12px;" class="${animClass}">
                <div>${c.name} <br><small style="color:${animClass?'var(--danger)':'var(--text-sec)'}; font-weight:bold;">${statusMsg}</small></div>
                <div style="display:flex; align-items:center;">
                   <b style="color:var(--danger);">${format(c.value)}</b>
                   <span style="margin-right:15px; display:flex; gap:5px;">
                      <button class="btn-small-icon btn-check" onclick="passCheck(${i})" title="پاس کردن"><i class="fas fa-money-check"></i></button>
                      <button class="btn-small-icon btn-edit" onclick="openEdit('check', ${i})"><i class="fas fa-edit"></i></button>
                      <button class="btn-small-icon btn-del" onclick="delCheck(${i})"><i class="fas fa-trash"></i></button>
                   </span>
                </div>
            </div>`;
        }).join('');
    }

    function passCheck(i) {
        // Strict logic: Must pay from "Check Wallet"
        const check = app.checks[i];
        const walletName = CONST_WALLET_CHECK;
        const walletIndex = app.wallets.findIndex(w => w.name === walletName);
        
        if (walletIndex === -1) {
             alert(`کیف پول '${walletName}' یافت نشد.`);
             ensureSpecialWalletExists(walletName);
             saveData();
             renderUI();
             return;
        }

        const wallet = app.wallets[walletIndex];

        if (wallet.value < check.value) {
            if(confirm(`موجودی کیف پول '${walletName}' کافی نیست (${format(wallet.value)}). آیا می‌خواهید اکنون آن را شارژ کنید؟`)) {
                openInternalTransfer(walletName);
            }
            return;
        }

        if(confirm(`آیا مبلغ ${format(check.value)} از کیف پول '${walletName}' کسر و چک پاس شود؟`)) {
            app.wallets[walletIndex].value -= check.value;
            app.checks[i].isPaid = true;
            
            logSystemTransaction('expense', check.value, walletName, check.name, 'پاس شدن چک');
            saveSectionSnap('dashboard', `پاس شدن چک ${check.name}`);
            saveData();
            renderUI();
            showToast("چک پاس شد");
        }
    }

    function renderLoans() {
        const div = document.getElementById('loanList');
        if(!app.loans) app.loans = [];

        div.innerHTML = app.loans.map((l, i) => {
            if(l.isReceived) {
                return `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:12px; align-items:center; opacity:0.6;">
                          <div><del>${l.name}</del> <small style="color:var(--success);">(وصول شد)</small></div>
                          <div style="display:flex; align-items:center;">
                             <b style="color:var(--text-sec);">${format(l.value)}</b>
                             <button class="btn-small-icon btn-del" onclick="delLoan(${i})" style="margin-right:10px;"><i class="fas fa-trash"></i></button>
                          </div>
                        </div>`;
            }

            let animClass = "";
            let statusMsg = "وصول: " + l.date;
            const diff = compareDates(l.date);

            if (diff < 0) {
                statusMsg = "زمان وصول گذشته!";
                animClass = "status-overdue pulse-danger";
            } else if (diff === 0) {
                statusMsg = "زمان وصول امروز!";
                animClass = "status-due pulse-warning";
            } else if (diff <= 3) {
                statusMsg += " (نزدیک)";
                animClass = "status-due pulse-warning";
            }

            return `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:12px; align-items:center; border-radius:12px;" class="${animClass}">
                <div>${l.name} <br><small style="color:var(--text-sec);">${statusMsg}</small></div>
                <div style="display:flex; align-items:center;">
                   <b style="color:var(--success);">${format(l.value)}</b>
                   <span style="margin-right:15px; display:flex; gap:5px;">
                      <button class="btn-small-icon btn-check" onclick="receiveLoan(${i})" title="دریافت شد"><i class="fas fa-download"></i></button>
                      <button class="btn-small-icon btn-edit" onclick="openEdit('loan', ${i})"><i class="fas fa-edit"></i></button>
                      <button class="btn-small-icon btn-del" onclick="delLoan(${i})"><i class="fas fa-trash"></i></button>
                   </span>
                </div>
            </div>`;
        }).join('');
    }

    function receiveLoan(i) {
        if(confirm("آیا مبلغ قرض داده شده وصول شد؟")) {
            openUniversalInput(`وصول طلب ${app.loans[i].name}`, "واریز به کدام کیف پول؟", false, (val) => {
                let wIdx;
                if(val === "new") {
                    app.wallets.push({name: "وصول طلب", value: 0});
                    wIdx = app.wallets.length - 1;
                } else {
                    wIdx = parseInt(val);
                }

                app.wallets[wIdx].value += app.loans[i].value;
                app.loans[i].isReceived = true;
                logSystemTransaction('deposit', app.loans[i].value, app.loans[i].name, app.wallets[wIdx].name, 'وصول طلب');
                saveSectionSnap('dashboard', `وصول طلب ${app.loans[i].name}`);
                saveData();
                renderUI();
                showToast("وصول ثبت شد");
            }, true);
        }
    }

    function renderBudgets(net) {
        const distributeBtn = document.getElementById('btnDistribute');
        const distributableDisplay = document.getElementById('distributable');

        if(net !== app.distributedAmount) {
            if (net > app.distributedAmount) {
                const diff = net - app.distributedAmount;
                distributeBtn.style.display = 'flex';
                distributableDisplay.innerHTML = `<span style="color:var(--text-sec);">${format(app.distributedAmount)}</span> <span style="color:var(--success); font-size:0.9em; margin-right:5px;">(+${format(diff)})</span>`;
            } else {
                distributeBtn.style.display = 'flex';
                distributableDisplay.style.color = 'var(--warning)';
                distributableDisplay.innerText = format(app.distributedAmount) + " (کسری)";
            }
        } else {
            distributeBtn.style.display = 'none';
            distributableDisplay.style.color = 'var(--primary)';
            distributableDisplay.innerText = format(app.distributedAmount);
        }

        const div = document.getElementById('budgetGrid');
        div.innerHTML = '';
        let totalP = 0;
        app.budgets.forEach(b => totalP += b.percent);

        const badge = document.getElementById('totalPercentBadge');
        badge.innerText = toPersianNum(totalP) + '%';
        badge.style.background = totalP > 100 ? 'var(--danger)' : (totalP === 100 ? 'var(--success)' : 'var(--text-sec)');

        const baseAmount = app.distributedAmount;
        const colors = ['#f87171', '#fbbf24', '#34d399', '#60a5fa', '#818cf8'];

        app.budgets.forEach((b, i) => {
            const shareFromPercent = Math.round((baseAmount * b.percent) / 100);
            const totalShare = shareFromPercent + (b.manualAdd || 0);
            const remain = totalShare - b.spent;
            const percent = totalShare > 0 ? (b.spent / totalShare) * 100 : 0;

            let status = 'stat-green';
            if(percent > 50) status = 'stat-yellow';
            if(percent > 90) status = 'stat-red';

            const pausedClass = b.isPaused ? 'paused' : '';

            let subBars = "";
            let subLegend = "";
            if(b.subs && b.subs.length > 0) {
                let subHtml = "";
                let legHtml = "";
                b.subs.forEach((s, idx) => {
                    const c = colors[idx % colors.length];
                    const sAmount = Math.round((totalShare * s.percent) / 100);
                    if(sAmount > 0) {
                        subHtml += `<div class="sub-budget-seg" style="width:${s.percent}%; background:${c};" title="${s.name} (${format(sAmount)})"></div>`;
                        legHtml += `<div class="sub-legend-item"><div class="sub-dot" style="background:${c}"></div> ${s.name}: ${format(sAmount)}</div>`;
                    }
                });
                subBars = `<div class="sub-budget-bar">${subHtml}</div>`;
                subLegend = `<div class="sub-budget-legend">${legHtml}</div>`;
            }

            div.innerHTML += `<div class="bento-item ${status} ${pausedClass}">
                <div class="bento-header">
                    <span>${b.name} (${toPersianNum(b.percent)}%) ${b.isPaused ? '<small>(توقف)</small>' : ''} <i class="fas fa-edit" style="font-size:0.9rem; cursor:pointer; margin-right:5px; color:var(--text-sec);" onclick="openEdit('budget', ${i})"></i></span>
                    <div style="display:flex; gap:8px;">
                        <i class="fas fa-list-alt" style="opacity:0.5; cursor:pointer;" onclick="openItemHistory(${i})" title="تاریخچه"></i>
                        <i class="fas fa-trash" style="opacity:0.3; cursor:pointer;" onclick="delBudget(${i})"></i>
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-top:5px; color:var(--text-sec);">
                    <span>سهم: ${format(shareFromPercent)} ${b.manualAdd ? `+ ${format(b.manualAdd)}` : ''}</span>
                    <span style="color:var(--danger)">خرج: ${format(b.spent)}</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" style="width:${Math.min(percent,100)}%"></div></div>
                ${subBars}
                ${subLegend}
                <div style="text-align:left; font-weight:800; font-size:1.4rem; color:var(--primary); direction:ltr; letter-spacing:1px; margin: 5px 0;">
                    ${format(remain)}
                </div>
                <div class="bento-actions">
                    <button class="action-chip action-btn-exp" onclick="openExp(${i})" ${b.isPaused ? 'disabled' : ''}><i class="fas fa-minus-circle"></i> ثبت هزینه</button>
                    <button class="action-chip action-btn-copy" onclick="copyTxt(${remain})"><i class="fas fa-copy"></i> کپی</button>
                    <button class="action-chip action-btn-add" onclick="openDepositOptions(${i})"><i class="fas fa-plus-circle"></i> واریز</button>
                    <button class="action-chip action-btn-transfer" onclick="openTransfer(${i})"><i class="fas fa-exchange-alt"></i> انتقال</button>
                    <button class="action-chip action-btn-pause" onclick="togglePause(${i})">${b.isPaused ? '<i class="fas fa-play"></i> فعال' : '<i class="fas fa-pause"></i> توقف'}</button>
                    <button class="action-chip action-btn-zero" onclick="zeroItem(${i})"><i class="fas fa-eraser"></i> تصفیه</button>
                    <button class="action-chip action-btn-sub" onclick="openSubBudgetManager(${i})"><i class="fas fa-layer-group"></i> مدیریت زیرمجموعه</button>
                </div>
            </div>`;
        });
    }

    function triggerDistribution() {
        withLoading(() => {
            // FIX: Ensure Budgets Exist on first run
            if(!app.budgets || app.budgets.length === 0) {
                applyTemplate('default'); // Load default immediately if empty
            }

            const income = app.wallets.reduce((a,b)=>a+b.value,0);
            
            // Recalculate distributable (Same logic as renderUI)
            const restrictedWallets = [CONST_WALLET_DEBT, CONST_WALLET_CHECK];
            const restrictedValue = app.wallets.filter(w => restrictedWallets.includes(w.name)).reduce((a,w) => a+w.value, 0);
            const manualDeductions = app.budgets.reduce((a,b) => a + (b.manualAdd || 0), 0);
            
            let net = income - restrictedValue - manualDeductions;
            if(net < 0) net = 0;

            const previousAmount = app.distributedAmount;
            if(net > previousAmount) {
                const addedAmount = net - previousAmount;
                processAutoTransfer(addedAmount, net);
            }

            app.distributedAmount = net;
            logSystemTransaction('system', net, 'Income', 'Budget', 'توزیع خودکار بودجه');
            saveSectionSnap('budget', 'توزیع موجودی جدید');
            saveData();
            renderUI();
            showToast("بودجه توزیع شد");
        }, 1200);
    }

    function processAutoTransfer(addedAmount, currentNet) {
        let totalDeducted = 0;
        app.goals.forEach(g => {
            if(g.curr >= g.target) return;
            if(g.autoConfig && g.autoConfig.type !== 'none') {
                const conf = g.autoConfig;
                let sourceBalance = 0;
                let sourceObj = null;

                if(conf.sourceId === 'main') {
                    sourceBalance = currentNet;
                } else {
                    sourceObj = app.budgets.find(b => b.id == conf.sourceId);
                    if(sourceObj) {
                        const baseShare = Math.round((currentNet * sourceObj.percent) / 100);
                        sourceBalance = baseShare + (sourceObj.manualAdd || 0) - sourceObj.spent;
                    }
                }

                if(sourceBalance >= (conf.minThreshold || 0)) {
                    let amountToTransfer = 0;
                    if(conf.type === 'percent') {
                        amountToTransfer = Math.round((addedAmount * conf.percent) / 100);
                    } else if(conf.type === 'fixed') {
                        amountToTransfer = conf.amount;
                    }

                    if(amountToTransfer > 0) {
                        if (g.curr + amountToTransfer > g.target) {
                            amountToTransfer = g.target - g.curr;
                        }
                        g.curr += amountToTransfer;
                        if (sourceObj) {
                            sourceObj.spent += amountToTransfer;
                            addToHistory(app.budgets.indexOf(sourceObj), amountToTransfer, "برداشت خودکار: " + g.name, 'expense');
                        }
                    }
                }
            }
        });
    }

    function openTransfer(index) {
        tempDepositIndex = index;
        const b = app.budgets[index];
        const baseAmount = app.distributedAmount;
        const share = Math.round((baseAmount * b.percent) / 100) + (b.manualAdd || 0);
        const remain = share - b.spent;

        document.getElementById('transferSourceName').innerText = b.name;
        document.getElementById('transferSourceBalance').innerText = `موجودی فعلی: ${format(remain)} تومان`;

        const sel = document.getElementById('transferTargetSelect');
        sel.innerHTML = app.budgets.map((item, i) => {
            if (i === index) return '';
            return `<option value="${i}">${item.name}</option>`;
        }).join('');

        document.getElementById('transferAmount').value = '';
        openModal('transferModal');
    }

    function performTransfer() {
        const sourceIdx = tempDepositIndex;
        const targetIdx = parseInt(document.getElementById('transferTargetSelect').value);
        const amount = parseFormatted(document.getElementById('transferAmount').value);

        if (isNaN(amount) || amount <= 0) return alert("مبلغ نامعتبر است");
        const b = app.budgets[sourceIdx];

        saveSectionSnap('budget', `انتقال ${format(amount)} از ${b.name} به ${app.budgets[targetIdx].name}`);
        
        if(!app.budgets[sourceIdx].manualAdd) app.budgets[sourceIdx].manualAdd = 0;
        app.budgets[sourceIdx].manualAdd -= amount;

        if (!app.budgets[targetIdx].manualAdd) app.budgets[targetIdx].manualAdd = 0;
        app.budgets[targetIdx].manualAdd += amount;

        addToHistory(sourceIdx, amount, `انتقال به ${app.budgets[targetIdx].name}`, 'transferOut');
        addToHistory(targetIdx, amount, `دریافت از ${app.budgets[sourceIdx].name}`, 'transferIn');

        saveData();
        renderUI();
        closeAllModals();
        showToast("انتقال انجام شد");
    }

    function zeroItem(index) {
        if (!confirm("آیا مطمئن هستید؟ این کار موجودی باقی‌مانده را با ثبت یک هزینه تصفیه صفر می‌کند.")) return;
        const b = app.budgets[index];
        const baseAmount = app.distributedAmount;
        const share = Math.round((baseAmount * b.percent) / 100) + (b.manualAdd || 0);
        const remain = share - b.spent;

        if (remain > 0) {
            saveSectionSnap('budget', `تصفیه حساب ${b.name}`);
            b.spent += remain;
            addToHistory(index, remain, "تصفیه حساب (صفر کردن)", 'expense');
            saveData();
            renderUI();
            showToast("حساب صفر شد");
        } else {
            alert("موجودی برای صفر کردن وجود ندارد.");
        }
    }

    function openDepositOptions(index) {
        tempDepositIndex = index;
        
        const income = app.wallets.reduce((a,b)=>a+b.value,0);
        const restrictedWallets = [CONST_WALLET_DEBT, CONST_WALLET_CHECK];
        const restrictedValue = app.wallets.filter(w => restrictedWallets.includes(w.name)).reduce((a,w) => a+w.value, 0);
        const manualDeductions = app.budgets.reduce((a,b) => a + (b.manualAdd || 0), 0);
        
        let net = income - restrictedValue - manualDeductions;
        if(net < 0) net = 0;

        const surplus = net - app.distributedAmount;
        const btn = document.getElementById('btnSystemDep');
        const msg = document.getElementById('systemDepMsg');

        if (surplus > 0) {
            btn.disabled = false;
            btn.classList.remove('btn-outline');
            btn.classList.add('btn-primary');
            msg.innerHTML = `موجودی قابل واریز: <b style="color:var(--success)">${format(surplus)}</b> تومان`;
            btn.dataset.max = surplus;
        } else {
            btn.disabled = true;
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-outline');
            msg.innerHTML = "موجودی جدیدی برای توزیع وجود ندارد.";
            btn.dataset.max = 0;
        }
        openModal('depositOptionsModal');
    }

    function selectDepositType(type) {
        closeAllModals();
        if(type === 'system') {
            const max = parseFloat(document.getElementById('btnSystemDep').dataset.max) || 0;
            openUniversalInput('واریز از سیستم', `حداکثر قابل واریز: ${format(max)} تومان`, true, (val) => {
                if(val && !isNaN(val)) {
                    if (val > max) return alert("مبلغ وارد شده بیشتر از موجودی توزیع نشده است!");
                    saveSectionSnap('budget', `واریز سیستمی به ${app.budgets[tempDepositIndex].name}: ${format(val)}`);
                    if(!app.budgets[tempDepositIndex].manualAdd) app.budgets[tempDepositIndex].manualAdd = 0;
                    app.budgets[tempDepositIndex].manualAdd += val;
                    addToHistory(tempDepositIndex, val, "واریز از سیستم", 'deposit');
                    saveData();
                    renderUI();
                    showToast("واریز سیستمی انجام شد");
                }
            });
        } else if (type === 'direct') {
            openUniversalInput('واریز مستقیم (بیرونی)', 'مبلغ واریزی:', true, (val) => {
                if(val && !isNaN(val)) {
                    saveSectionSnap('budget', `واریز مستقیم به ${app.budgets[tempDepositIndex].name}: ${format(val)}`);
                    if(!app.budgets[tempDepositIndex].manualAdd) app.budgets[tempDepositIndex].manualAdd = 0;
                    app.budgets[tempDepositIndex].manualAdd += val;
                    addToHistory(tempDepositIndex, val, "واریز مستقیم (بیرونی)", 'deposit');
                    
                    const targetWalletName = "پول بیرونی";
                    let wIdx = app.wallets.findIndex(w => w.name === targetWalletName);
                    if(wIdx > -1) {
                        app.wallets[wIdx].value += val;
                    } else {
                        app.wallets.push({name: targetWalletName, value: val});
                    }
                    saveData();
                    renderUI();
                    showToast("واریز مستقیم ثبت شد");
                }
            });
        }
    }

    function togglePause(index) {
        saveSectionSnap('budget', `تغییر وضعیت توقف برای ${app.budgets[index].name}`);
        const b = app.budgets[index];
        if(b.isPaused) {
            let restore = confirm(`آیا درصد قبلی (${b.savedPercent}%) اعمال شود؟\nتایید = بله\nلغو = خیر (وارد کردن درصد جدید)`);
            b.isPaused = false;
            if(restore) {
                b.percent = b.savedPercent;
                saveData();
                renderUI();
            } else {
                openUniversalInput('درصد جدید', 'درصد جدید را وارد کنید:', false, (val) => {
                    b.percent = parseInt(val) || 0;
                    saveData();
                    renderUI();
                });
            }
        } else {
            b.savedPercent = b.percent;
            b.percent = 0;
            b.isPaused = true;
            saveData();
            renderUI();
            showToast("آیتم متوقف شد");
        }
    }

    function addGoal() {
        const n = document.getElementById('gName').value;
        const t = parseFormatted(document.getElementById('gTarget').value);
        if(n && !isNaN(t)) {
            saveSectionSnap('tools', `افزودن هدف: ${n}`);
            app.goals.push({name:n, target:t, curr:0, autoConfig:{type:'none'}});
            saveData();
            renderUI();
            closeAllModals();
        }
    }

    function renderGoals() {
        const div = document.getElementById('goalList');
        div.innerHTML = app.goals.map((g, i) => {
            const p = Math.min(100, Math.round((g.curr / g.target)*100));
            const remaining = Math.max(0, g.target - g.curr);
            const autoBadge = g.autoConfig && g.autoConfig.type !== 'none' ? '<i class="fas fa-robot" style="color:var(--primary)" title="برداشت خودکار فعال"></i>' : '';
            
            // Build Auto-Alloc Detail String
            let autoDetail = "";
            if(g.autoConfig && g.autoConfig.type !== 'none') {
                const conf = g.autoConfig;
                let srcName = conf.sourceId === 'main' ? 'ورودی اصلی' : 'ردیف بودجه';
                if(conf.sourceId !== 'main') {
                    const b = app.budgets.find(item => item.id == conf.sourceId);
                    if(b) srcName = b.name;
                }
                const val = conf.type === 'percent' ? toPersianNum(conf.percent) + '%' : format(conf.amount) + ' ت';
                autoDetail = `<div style="font-size:0.75rem; color:var(--info); margin-bottom:5px;">برداشت خودکار: <b>${val}</b> از <b>${srcName}</b></div>`;
            }

            let statusHTML = `<span>مانده: <b style="color:var(--danger)">${format(remaining)}</b></span>`;
            let completeMsg = "";
            if (g.curr >= g.target) {
                statusHTML = `<span style="color:var(--success); font-weight:bold;"><i class="fas fa-check-circle"></i> تکمیل شد</span>`;
                completeMsg = `<span class="complete-badge">تبریک! تکمیل شد</span>`;
                if(g.autoConfig && g.autoConfig.type !== 'none') g.autoConfig.type = 'none';
            }

            return `
            <div style="padding:15px; border-bottom:1px solid #eee;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <b style="font-size:1.05rem;">${completeMsg} ${g.name} ${autoBadge}</b>
                    <span style="font-size:0.9rem;">
                       <button class="btn-small-icon btn-settings" onclick="openAutoAlloc('goal', ${i})"><i class="fas fa-cog"></i></button>
                       <button class="btn-small-icon btn-edit" onclick="openEdit('goal', ${i})"><i class="fas fa-edit"></i></button>
                    </span>
                </div>
                ${autoDetail}
                <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:var(--text-sec); margin-top:5px;">
                    <span>جمع‌شده: <b style="color:var(--success)">${format(g.curr)}</b></span>
                    ${statusHTML}
                </div>
                <div class="progress-bar"><div class="progress-fill" style="width:${p}%; background:${g.curr>=g.target ? 'var(--success)' : 'var(--warning)'};"></div></div>
                <div style="display:flex; gap:8px; margin-top:8px;">
                    <button class="btn btn-primary" style="font-size:0.8rem; padding:6px 12px;" onclick="openAllocate('goal', ${i})" ${g.curr>=g.target ? 'disabled style="opacity:0.5"' : ''}>🔗 اختصاص بودجه</button>
                    <button class="btn btn-outline" style="font-size:0.8rem; padding:6px 12px;" onclick="addGoalMoneyDirect(${i})" ${g.curr>=g.target ? 'disabled style="opacity:0.5"' : ''}>+ مستقیم</button>
                    <button class="btn btn-danger" style="font-size:0.8rem; padding:6px 12px;" onclick="delGoal(${i})">×</button>
                </div>
            </div>`;
        }).join('');
    }

    function addGoalMoneyDirect(i) {
        if(app.goals[i].curr >= app.goals[i].target) return alert("این هدف تکمیل شده است.");
        openUniversalInput('واریز مستقیم به هدف', 'مبلغ را وارد کنید:', true, (val) => {
            if(val) {
                saveSectionSnap('tools', `واریز دستی به هدف ${app.goals[i].name}`);
                app.goals[i].curr += parseInt(val);
                logSystemTransaction('expense', val, 'Unknown', app.goals[i].name, 'واریز مستقیم به هدف');
                saveData();
                renderUI();
            }
        });
    }

    function delGoal(i) {
        saveSectionSnap('tools', `حذف هدف ${app.goals[i].name}`);
        app.goals.splice(i,1);
        saveData();
        renderUI();
    }

    function addShop() {
        const n = document.getElementById('sName').value;
        const p = parseFormatted(document.getElementById('sPrice').value);
        if(n) {
            saveSectionSnap('tools', `افزودن کالا: ${n}`);
            app.shopping.push({name:n, price: p || 0, autoConfig:{type:'none'}, paid: 0});
            saveData();
            renderUI();
            closeAllModals();
        }
    }

    function renderShop() {
        const div = document.getElementById('shopList');
        div.innerHTML = app.shopping.map((s, i) => {
            const autoBadge = s.autoConfig && s.autoConfig.type !== 'none' ? '<i class="fas fa-robot" style="color:var(--primary)"></i>' : '';
            const paid = s.paid || 0;
            const price = s.price || 0;
            const remaining = price > 0 ? Math.max(0, price - paid) : 0;
            let isComplete = (price > 0 && paid >= price);
            if(isComplete && s.autoConfig.type !== 'none') s.autoConfig.type = 'none';
            
            // Build Auto-Alloc Detail String for Shop
            let autoDetail = "";
            if(s.autoConfig && s.autoConfig.type !== 'none') {
                const conf = s.autoConfig;
                let srcName = conf.sourceId === 'main' ? 'ورودی اصلی' : 'ردیف بودجه';
                if(conf.sourceId !== 'main') {
                    const b = app.budgets.find(item => item.id == conf.sourceId);
                    if(b) srcName = b.name;
                }
                const val = conf.type === 'percent' ? toPersianNum(conf.percent) + '%' : format(conf.amount) + ' ت';
                autoDetail = `<div style="font-size:0.75rem; color:var(--info); margin-top:2px;">برداشت خودکار: <b>${val}</b> از <b>${srcName}</b></div>`;
            }

            let msg = "";
            if(isComplete) msg = `<span class="complete-badge">خرید کامل شد</span>`;

            return `<div style="display:flex; justify-content:space-between; padding:15px; border-bottom:1px solid #eee; align-items:center; flex-wrap:wrap;">
                <div style="flex:1;">
                    <span style="font-weight:bold; font-size:1.05rem;">${msg} ${s.name} ${autoBadge}</span>
                    <div style="font-size:0.8rem; color:var(--text-sec); margin-top:3px;">
                        ${price ? `قیمت: ${format(price)} | ` : ''}
                        <span style="color:var(--success)">پرداخت: ${format(paid)}</span>
                        ${price ? ` | <span style="color:var(--danger)">مانده: ${format(remaining)}</span>` : ''}
                    </div>
                    ${autoDetail}
                </div>
                <div style="display:flex; gap:8px; align-items:center; margin-top:5px;">
                    <button class="btn btn-primary" style="font-size:0.8rem;" onclick="openAllocate('shop', ${i})" ${isComplete ? 'disabled style="opacity:0.5"' : ''}>خرید</button>
                    <button class="btn-small-icon btn-settings" onclick="openAutoAlloc('shop', ${i})"><i class="fas fa-cog"></i></button>
                    <button class="btn-small-icon btn-edit" onclick="openEdit('shop', ${i})"><i class="fas fa-edit"></i></button>
                    <i class="fas fa-check-circle" style="cursor:pointer; font-size:1.4rem; color:var(--success);" onclick="delShop(${i})"></i>
                </div>
            </div>`;
        }).join('');
    }

    function delShop(i) {
        saveSectionSnap('tools', `حذف کالا ${app.shopping[i].name}`);
        app.shopping.splice(i,1);
        saveData();
        renderUI();
    }

    function openAutoAlloc(type, id) {
        document.getElementById('autoAllocType').value = type;
        document.getElementById('autoAllocId').value = id;
        const item = type === 'goal' ? app.goals[id] : app.shopping[id];
        const conf = item.autoConfig || { type: 'none' };
        
        document.getElementById('aaType').value = conf.type || 'none';
        document.getElementById('aaPercent').value = conf.percent || '';
        document.getElementById('aaAmount').value = conf.amount || '';
        formatCurrency(document.getElementById('aaAmount'));
        document.getElementById('aaMin').value = conf.minThreshold || '';
        formatCurrency(document.getElementById('aaMin'));
        
        const sel = document.getElementById('aaSource');
        sel.innerHTML = app.budgets.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
        if(conf.sourceId) sel.value = conf.sourceId;

        toggleAutoAllocFields();
        openModal('autoAllocModal');
    }

    function toggleAutoAllocFields() {
        const t = document.getElementById('aaType').value;
        document.getElementById('aaPercentField').style.display = t === 'percent' ? 'block' : 'none';
        document.getElementById('aaAmountField').style.display = t === 'fixed' ? 'block' : 'none';
    }

    function saveAutoAlloc() {
        const type = document.getElementById('autoAllocType').value;
        const id = document.getElementById('autoAllocId').value;
        const conf = {
            type: document.getElementById('aaType').value,
            percent: parseFloat(document.getElementById('aaPercent').value) || 0,
            amount: parseFormatted(document.getElementById('aaAmount').value),
            minThreshold: parseFormatted(document.getElementById('aaMin').value),
            sourceId: document.getElementById('aaSource').value
        };

        if(type === 'goal') app.goals[id].autoConfig = conf;
        else app.shopping[id].autoConfig = conf;

        saveData();
        renderUI();
        closeAllModals();
        showToast("تنظیمات خودکار ذخیره شد");
    }

    function openSubBudgetManager(i) {
        tempSubIndex = i;
        const b = app.budgets[i];
        document.getElementById('subParentName').innerText = b.name;
        renderSubBudgets(b);
        openModal('subBudgetModal');
    }

    function captureSubState() {
        if(tempSubIndex === -1) return [];
        const nameInputs = document.querySelectorAll('.sub-name');
        const percentInputs = document.querySelectorAll('.sub-percent-input');
        const temp = [];
        nameInputs.forEach((inp, idx) => {
            temp.push({ name: inp.value, percent: parseFloat(percentInputs[idx].value) || 0 });
        });
        return temp;
    }

    function renderSubBudgets(budget, tempState = null) {
        const subsToRender = tempState || (budget.subs || []);
        const baseAmount = app.distributedAmount;
        const share = Math.round((baseAmount * budget.percent) / 100) + (budget.manualAdd || 0);
        const totalPercentAllocated = subsToRender.reduce((acc, s) => acc + (s.percent || 0), 0);
        const remainPercent = 100 - totalPercentAllocated;

        document.getElementById('subTotalBudget').innerText = "سهم کل: " + format(share);
        document.getElementById('subRemainPercent').innerText = "باقی‌مانده: " + toPersianNum(remainPercent) + "%";
        if(remainPercent < 0) document.getElementById('subRemainPercent').style.color = 'var(--danger)';
        else document.getElementById('subRemainPercent').style.color = 'var(--success)';

        const div = document.getElementById('subBudgetList');
        div.innerHTML = subsToRender.map((s, idx) => {
            const calculatedAmount = Math.round((share * (s.percent || 0)) / 100);
            return `<div class="sub-budget-row">
                      <input type="text" value="${s.name}" class="sub-name" placeholder="عنوان" style="flex:1.5; margin:0; font-size:0.9rem; padding:10px;">
                      <div style="flex:1; position:relative;">
                         <input type="number" value="${s.percent}" class="sub-percent-input" placeholder="%" oninput="updateSubCalculations(${share})" style="margin:0; text-align:center; padding:10px; font-size:0.95rem;">
                      </div>
                      <div class="sub-budget-calc-display" id="subCalc_${idx}">${format(calculatedAmount)}</div>
                      <button class="btn-small-icon btn-copy" onclick="copySub(${calculatedAmount})" title="کپی مبلغ"><i class="fas fa-copy"></i></button>
                      <i class="fas fa-times" style="cursor:pointer; color:var(--danger); font-size:1.2rem; margin-right:5px;" onclick="deleteSub(${idx})"></i>
                    </div>`
        }).join('');
    }

    function updateSubCalculations(totalShare) {
        const inputs = document.querySelectorAll('.sub-percent-input');
        let totalP = 0;
        inputs.forEach((inp, idx) => {
            const p = parseFloat(inp.value) || 0;
            totalP += p;
            const amt = Math.round((totalShare * p) / 100);
            document.getElementById(`subCalc_${idx}`).innerText = format(amt);
            const copyBtn = inp.parentElement.parentElement.querySelector('.btn-copy');
            copyBtn.setAttribute('onclick', `copySub(${amt})`);
        });

        const remain = 100 - totalP;
        document.getElementById('subRemainPercent').innerText = "باقی‌مانده: " + toPersianNum(remain) + "%";
        if(remain < 0) document.getElementById('subRemainPercent').style.color = 'var(--danger)';
        else document.getElementById('subRemainPercent').style.color = 'var(--success)';
    }

    function addNewSubCategory() {
        if(tempSubIndex === -1) return;
        const currentData = captureSubState();
        currentData.push({name: "", percent: 0});
        renderSubBudgets(app.budgets[tempSubIndex], currentData);
    }

    function deleteSub(idx) {
        const currentData = captureSubState();
        currentData.splice(idx, 1);
        renderSubBudgets(app.budgets[tempSubIndex], currentData);
    }

    function copySub(amt) {
        copyTxt(amt);
    }

    function saveSubBudgets() {
        const finalData = captureSubState();
        let totalP = 0;
        finalData.forEach(s => totalP += s.percent);

        if(totalP > 100) {
            alert("خطا: مجموع درصدها (" + toPersianNum(totalP) + "%) از ۱۰۰٪ بیشتر است!");
            return;
        }

        saveSectionSnap('budget', `تغییر زیرمجموعه‌های ${app.budgets[tempSubIndex].name}`);
        app.budgets[tempSubIndex].subs = finalData;
        saveData();
        renderUI();
        closeAllModals();
        showToast("زیرمجموعه‌ها ذخیره شدند");
    }

    // --- Instruction 6: Updated openEdit to keep original date ---
    function openEdit(type, index) {
        // Prevent editing External/Receive Wallets amount
        if (type === 'wallet') {
            const wName = app.wallets[index].name;
            if (RESTRICTED_SOURCES.includes(wName)) {
                // We allow changing name maybe (though better not), but DEFINITELY not adding balance via simple edit
            }
        }

        openModal('editModal');
        document.getElementById('editType').value = type;
        document.getElementById('editIndex').value = index;

        let item;
        let showPercent = false;
        let showAmount = true;
        let showDate = false;
        let showDeduct = false; 
        let showDebtDates = false;

        if(type === 'wallet') item = app.wallets[index];
        else if(type === 'debt') { item = app.debts[index]; showDebtDates = true; showAmount = true; } 
        else if(type === 'check') { item = app.checks[index]; showDate = true; }
        else if(type === 'loan') { item = app.loans[index]; showDate = true; }
        else if(type === 'budget') { item = app.budgets[index]; showPercent = true; showAmount = false; }
        else if(type === 'goal') { item = app.goals[index]; }
        else if(type === 'shop') { item = app.shopping[index]; }

        document.getElementById('editName').value = item.name;

        if(showAmount) {
            document.getElementById('editAmountWrapper').style.display = 'block';
            let val = 0;
            if(type === 'goal') val = item.target;
            else if(type === 'shop') val = item.price || 0;
            else val = item.value;
            
            document.getElementById('editVal').value = val;
            formatCurrency(document.getElementById('editVal'));

            if (type === 'wallet' && RESTRICTED_SOURCES.includes(item.name)) {
                document.getElementById('editVal').disabled = true;
                document.getElementById('editVal').placeholder = "غیرقابل ویرایش دستی";
            } else {
                document.getElementById('editVal').disabled = false;
            }

        } else {
            document.getElementById('editAmountWrapper').style.display = 'none';
        }

        document.getElementById('editDeductWrapper').style.display = 'none';

        if(showPercent) {
            document.getElementById('editPercentWrapper').style.display = 'block';
            document.getElementById('editPercent').value = item.percent;
        } else {
            document.getElementById('editPercentWrapper').style.display = 'none';
        }

        // --- اصلاح بخش تاریخ (چک و وام) ---
        if(showDate) {
            document.getElementById('editDateWrapper').style.display = 'block';
            const row = document.getElementById('editDateRow');
            
            // پیش‌فرض: امروز
            let d = null, m = null, y = null;
            
            // اگر آیتم تاریخ داشت، آن را تجزیه کن
            if (item.date) {
                // تبدیل اعداد فارسی به انگلیسی برای پارس صحیح
                const dateStr = toEn(item.date);
                const parts = dateStr.split('/');
                if(parts.length === 3) {
                    y = parseInt(parts[0]);
                    m = parseInt(parts[1]);
                    d = parseInt(parts[2]);
                }
            }
            // ارسال مقادیر استخراج شده به تابع سازنده
            row.innerHTML = createDatePickerHTML('editD', d, m, y);
        } else {
            document.getElementById('editDateWrapper').style.display = 'none';
        }

        // --- اصلاح بخش تاریخ اقساط (شروع و پایان) ---
        if(showDebtDates) {
            document.getElementById('editDebtDatesWrapper').style.display = 'block';
            
            // تاریخ شروع
            let sd = null, sm = null, sy = null;
            if (item.startDate) {
                const sParts = toEn(item.startDate).split('/');
                if(sParts.length === 3) {
                    sy = parseInt(sParts[0]);
                    sm = parseInt(sParts[1]);
                    sd = parseInt(sParts[2]);
                }
            }
            document.getElementById('editDebtStartRow').innerHTML = createDatePickerHTML('editDStart', sd, sm, sy);

            // تاریخ پایان
            let ed = null, em = null, ey = null;
            if (item.endDate) {
                const eParts = toEn(item.endDate).split('/');
                if(eParts.length === 3) {
                    ey = parseInt(eParts[0]);
                    em = parseInt(eParts[1]);
                    ed = parseInt(eParts[2]);
                }
            }
            document.getElementById('editDebtEndRow').innerHTML = createDatePickerHTML('editDEnd', ed, em, ey);

        } else {
            document.getElementById('editDebtDatesWrapper').style.display = 'none';
        }
    }

    function performEdit() {
        withLoading(() => {
            const type = document.getElementById('editType').value;
            const index = parseInt(document.getElementById('editIndex').value);
            const newName = document.getElementById('editName').value;
            if(!newName) return alert("نام نمی‌تواند خالی باشد");

            let desc = "ویرایش آیتم";

            if(type === 'wallet') {
                // Restriction check
                if (RESTRICTED_SOURCES.includes(app.wallets[index].name)) {
                   const oldVal = app.wallets[index].value;
                   const newVal = parseFormatted(document.getElementById('editVal').value);
                   if (oldVal !== newVal) {
                       alert("موجودی این کیف پول سیستمی قابل ویرایش دستی نیست.");
                       return;
                   }
                }

                saveSectionSnap('dashboard', `ویرایش کیف پول ${newName}`);
                app.wallets[index].name = newName;
                app.wallets[index].value = parseFormatted(document.getElementById('editVal').value);
            } else if(type === 'debt') {
                // Instruction 2: Save edited debt details
                saveSectionSnap('dashboard', `ویرایش قسط ${newName}`);
                app.debts[index].name = newName;
                app.debts[index].value = parseFormatted(document.getElementById('editVal').value);
                app.debts[index].startDate = getDateString('editDStart');
                app.debts[index].endDate = getDateString('editDEnd');
            } else if(type === 'check') {
                saveSectionSnap('dashboard', `ویرایش چک ${newName}`);
                app.checks[index].name = newName;
                app.checks[index].value = parseFormatted(document.getElementById('editVal').value);
                app.checks[index].date = getDateString('editD');
            } else if(type === 'loan') {
                saveSectionSnap('dashboard', `ویرایش طلب ${newName}`);
                app.loans[index].name = newName;
                app.loans[index].value = parseFormatted(document.getElementById('editVal').value);
                app.loans[index].date = getDateString('editD');
            } else if(type === 'budget') {
                const oldName = app.budgets[index].name;
                const newP = parseInt(document.getElementById('editPercent').value) || 0;
                let total = 0;
                app.budgets.forEach((b, i) => { if(i !== index) total += b.percent; });

                if(total + newP > 100) {
                    tempBudget = JSON.parse(JSON.stringify(app.budgets[index]));
                    tempBudget.name = newName;
                    tempBudget.percent = newP;
                    const safeMax = 100 - total;
                    document.getElementById('maxAllowedPercent').innerText = toPersianNum(safeMax) + '%';
                    const slider = document.getElementById('percentSlider');
                    slider.max = safeMax;
                    slider.value = 0;
                    document.getElementById('sliderValDisplay').innerText = toPersianNum(0);
                    tempBudget.isEdit = true;
                    tempBudget.editIndex = index;
                    openModal('fixPercentModal');
                    return;
                }

                saveSectionSnap('budget', `ویرایش بودجه ${newName}`);
                app.budgets[index].name = newName;
                app.budgets[index].percent = newP;
                if(oldName !== newName && app.priorities[oldName]) {
                    app.priorities[newName] = app.priorities[oldName];
                    delete app.priorities[oldName];
                }
            } else if(type === 'goal') {
                saveSectionSnap('tools', `ویرایش هدف ${newName}`);
                app.goals[index].name = newName;
                app.goals[index].target = parseFormatted(document.getElementById('editVal').value);
            } else if(type === 'shop') {
                saveSectionSnap('tools', `ویرایش کالا ${newName}`);
                app.shopping[index].name = newName;
                app.shopping[index].price = parseFormatted(document.getElementById('editVal').value);
            }

            saveData();
            renderUI();
            closeAllModals();
            showToast("تغییرات ذخیره شد");
        }, 800);
    }

    function applyTemplate(type) {
        if(!confirm("بودجه‌بندی فعلی پاک شده و قالب جدید اعمال می‌شود. ادامه می‌دهید؟")) return;
        saveSectionSnap('budget', 'اعمال قالب آماده');
        let newBudgets = [];
        
        if(type === 'default') {
            newBudgets = JSON.parse(JSON.stringify(defaultState.budgets));
        } else if(type === 'student') {
            newBudgets = [
                {id: 1, name: "رفت‌وآمد", percent: 30, spent: 0, history: [], manualAdd: 0, subs:[]},
                {id: 2, name: "غذا (سلف/بیرون)", percent: 25, spent: 0, history: [], manualAdd: 0, subs:[]},
                {id: 3, name: "اینترنت و شارژ", percent: 15, spent: 0, history: [], manualAdd: 0, subs:[]},
                {id: 4, name: "کتاب و جزوه", percent: 10, spent: 0, history: [], manualAdd: 0, subs:[]},
                {id: 5, name: "تفریح دوستانه", percent: 15, spent: 0, history: [], manualAdd: 0, subs:[]},
                {id: 6, name: "پس‌انداز اضطراری", percent: 5, spent: 0, history: [], manualAdd: 0, subs:[]}
            ];
        } else if(type === 'married') {
            newBudgets = [
                {id: 1, name: "اجاره خانه", percent: 35, spent: 0, history: [], manualAdd: 0, subs:[]},
                {id: 2, name: "خورد و خوراک منزل", percent: 25, spent: 0, history: [], manualAdd: 0, subs:[]},
                {id: 3, name: "قبوض و شارژ", percent: 10, spent: 0, history: [], manualAdd: 0, subs:[]},
                {id: 4, name: "درمان و بهداشت", percent: 10, spent: 0, history: [], manualAdd: 0, subs:[]},
                {id: 5, name: "پوشاک", percent: 5, spent: 0, history: [], manualAdd: 0, subs:[]},
                {id: 6, name: "پس‌انداز آینده", percent: 10, spent: 0, history: [], manualAdd: 0, subs:[]},
                {id: 7, name: "تفریح", percent: 5, spent: 0, history: [], manualAdd: 0, subs:[]}
            ];
        } else if(type === 'clear') {
            newBudgets = [];
        }

        app.budgets = newBudgets;
        app.priorities = {};
        app.priorityTiers = [];
        saveData();
        renderUI();
    }

    function addWallet() {
        const n = document.getElementById('wName').value;
        const v = parseFormatted(document.getElementById('wVal').value);
        if(n && !isNaN(v)) {
            // Instruction 5 Restriction: Check manual creation
            if (RESTRICTED_SOURCES.includes(n)) {
                return alert("ساخت کیف پول با این نام مجاز نیست (کیف پول سیستمی است).");
            }

            saveSectionSnap('dashboard', `افزودن کیف پول ${n}`);
            app.wallets.push({name:n, value:v});
            saveData();
            renderUI();
            closeAllModals();
        }
    }

    function delWallet(i) {
        if(confirm('حذف؟')) {
            const wName = app.wallets[i].name;
            if(wName === CONST_WALLET_DEBT || wName === CONST_WALLET_CHECK) {
                alert("این کیف پول سیستمی است و حذف آن توصیه نمی‌شود.");
            }
            saveSectionSnap('dashboard', `حذف کیف پول ${wName}`);
            app.wallets.splice(i,1);
            saveData();
            renderUI();
        }
    }

    // Instruction 6: Updated addDebt
    function addDebt() {
        const n = document.getElementById('dName').value;
        const v = parseFormatted(document.getElementById('dVal').value);
        const start = getDateString('dStart');
        const end = getDateString('dEnd');
        const penalty = parseFloat(document.getElementById('dPenalty').value) || 0;

        if(n && !isNaN(v)) {
            saveSectionSnap('dashboard', `افزودن قسط ${n}`);
            app.debts.push({
                name: n, 
                value: v, 
                startDate: start, 
                endDate: end, 
                penalty: penalty,
                paidHistory: [], // Array of paid dates
                lastPaid: null // Legacy support
            });
            // Ensure Wallet Exists
            ensureSpecialWalletExists(CONST_WALLET_DEBT);
            saveData();
            renderUI();
            closeAllModals();
        }
    }

    function delDebt(i) {
        if(confirm('حذف؟')) {
            saveSectionSnap('dashboard', `حذف قسط ${app.debts[i].name}`);
            app.debts.splice(i,1);
            saveData();
            renderUI();
        }
    }

    function addCheck() {
        const n = document.getElementById('cName').value;
        const v = parseFormatted(document.getElementById('cVal').value);
        const d = getDateString('c');
        if(n && !isNaN(v)) {
            saveSectionSnap('dashboard', `افزودن چک ${n}`);
            if(!app.checks) app.checks = [];
            app.checks.push({name:n, value:v, date:d, isPaid: false});
            // Ensure Wallet Exists
            ensureSpecialWalletExists(CONST_WALLET_CHECK);
            saveData();
            renderUI();
            closeAllModals();
        }
    }

    function delCheck(i) {
        if(confirm('حذف؟')) {
            saveSectionSnap('dashboard', `حذف چک ${app.checks[i].name}`);
            app.checks.splice(i,1);
            saveData();
            renderUI();
        }
    }

function addLoan() {
        const n = document.getElementById('lName').value;
        const v = parseFormatted(document.getElementById('lVal').value);
        const d = getDateString('l');
        if(n && !isNaN(v)) {
            saveSectionSnap('dashboard', `افزودن طلب ${n}`);
            if(!app.loans) app.loans = [];
            app.loans.push({name:n, value:v, date:d, isReceived: false});
            saveData();
            renderUI();
            closeAllModals();
        }
    }

    function delLoan(i) {
        if(confirm('حذف؟')) {
            saveSectionSnap('dashboard', `حذف طلب ${app.loans[i].name}`);
            app.loans.splice(i,1);
            saveData();
            renderUI();
        }
    }

    function addNewBudget() {
        const n = document.getElementById('bName').value;
        const p = parseInt(document.getElementById('bPercent').value);
        if(!n || isNaN(p)) return alert("لطفا مقادیر صحیح وارد کنید");

        let currentTotal = 0;
        app.budgets.forEach(b => currentTotal += b.percent);

        if (currentTotal + p > 100) {
            tempBudget = { name: n, percent: p, id: Date.now(), spent: 0, history: [], manualAdd: 0, isEdit: false, subs:[], internalDebt: [] };
            const max = 100 - currentTotal;
            const safeMax = max > 0 ? max : 0;
            document.getElementById('maxAllowedPercent').innerText = toPersianNum(safeMax) + '%';
            const slider = document.getElementById('percentSlider');
            slider.max = safeMax;
            slider.value = 0;
            document.getElementById('sliderValDisplay').innerText = toPersianNum(0);
            openModal('fixPercentModal');
        } else {
            saveSectionSnap('budget', `افزودن بودجه ${n}`);
            app.budgets.push({id:Date.now(), name:n, percent:p, spent:0, history:[], manualAdd: 0, subs:[], internalDebt: []});
            if (!app.priorities[n]) app.priorities[n] = 4;
            saveData();
            renderUI();
            closeAllModals();
        }
    }

    function updateSliderVal() {
        document.getElementById('sliderValDisplay').innerText = toPersianNum(document.getElementById('percentSlider').value);
    }

    function useSliderPercent() {
        if(!tempBudget) return;
        saveSectionSnap('budget', 'اصلاح درصد بودجه');
        const newP = parseInt(document.getElementById('percentSlider').value);
        if(tempBudget.isEdit) {
            app.budgets[tempBudget.editIndex].name = tempBudget.name;
            app.budgets[tempBudget.editIndex].percent = newP;
        } else {
            tempBudget.percent = newP;
            app.budgets.push(tempBudget);
            if (!app.priorities[tempBudget.name]) app.priorities[tempBudget.name] = 4;
        }
        saveData();
        renderUI();
        closeAllModals();
        tempBudget = null;
    }

    function autoCorrectBudget() {
        if(!tempBudget) return;
        saveSectionSnap('budget', 'اصلاح خودکار بودجه');
        let usedPercent = 0;
        app.budgets.forEach((b,i) => {
            if(tempBudget.isEdit && i === tempBudget.editIndex) return;
            usedPercent += b.percent;
        });

        const needed = tempBudget.percent;
        const allowZero = document.getElementById('allowZeroCheck').checked;
        let overflow = (usedPercent + needed) - 100;

        if(overflow <= 0) {
            if(tempBudget.isEdit) {
                app.budgets[tempBudget.editIndex].name = tempBudget.name;
                app.budgets[tempBudget.editIndex].percent = needed;
            } else {
                app.budgets.push(tempBudget);
            }
            saveData();
            renderUI();
            closeAllModals();
            return;
        }

        let candidates = app.budgets.map((b, index) => {
            if(tempBudget.isEdit && index === tempBudget.editIndex) return null;
            return { index: index, priority: app.priorities[b.name] || 4, percent: b.percent };
        }).filter(x => x !== null)
          .sort((a, b) => {
              if (b.priority !== a.priority) return b.priority - a.priority;
              return b.percent - a.percent;
          });

        for (let item of candidates) {
            if (overflow <= 0) break;
            let currentP = app.budgets[item.index].percent;
            let canDeduct = 0;
            if (allowZero) {
                canDeduct = currentP;
            } else {
                canDeduct = currentP > 1 ? currentP - 1 : 0;
            }
            let deductAmount = Math.min(canDeduct, overflow);
            app.budgets[item.index].percent -= deductAmount;
            overflow -= deductAmount;
        }

        if(overflow > 0) {
            alert("امکان اصلاح خودکار وجود ندارد!\nحتی با کاهش اولویت‌های پایین، فضا کافی نیست.\nلطفاً درصد وارد شده را کمتر کنید یا اجازه صفر شدن آیتم‌ها را بدهید.");
            const lastSnap = JSON.parse(app.sectionHistory['budget'][0].data);
            app.budgets = lastSnap.budgets;
            return;
        }

        if(tempBudget.isEdit) {
            app.budgets[tempBudget.editIndex].name = tempBudget.name;
            app.budgets[tempBudget.editIndex].percent = needed;
        } else {
            app.budgets.push(tempBudget);
            if (!app.priorities[tempBudget.name]) app.priorities[tempBudget.name] = 4;
        }
        
        saveData();
        renderUI();
        closeAllModals();
        tempBudget = null;
        showToast("بودجه با موفقیت اصلاح شد");
    }

    function openPrioritySettings() {
        if(!app.priorityTiers) {
            app.priorityTiers = [];
        }
        renderPriorityTiers();
        document.getElementById('newTierForm').style.display = 'none';
        const lastTier = app.priorityTiers[app.priorityTiers.length-1];
        const currentCap = lastTier ? lastTier.end : 0;
        document.getElementById('addTierBtn').style.display = currentCap >= 100 ? 'none' : 'block';
        openModal('prioritySettingsModal');
    }

    function renderPriorityTiers() {
        const div = document.getElementById('tierListContainer');
        if(app.priorityTiers.length === 0) {
            div.innerHTML = '<p style="text-align:center; color:var(--text-sec); margin:20px 0;">هیچ بازه اولویتی تعریف نشده است.</p>';
        } else {
            div.innerHTML = app.priorityTiers.map((t, idx) => `
               <div style="background:var(--bg-body); border-radius:12px; padding:12px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                  <div style="font-weight:bold;">اولویت ${toPersianNum(idx + 1)}</div>
                  <div style="direction:ltr;">${toPersianNum(t.start)}% - ${toPersianNum(t.end)}%</div>
               </div>`
            ).join('');
        }
    }

    function showAddTierForm() {
        const lastTier = app.priorityTiers[app.priorityTiers.length-1];
        const start = lastTier ? lastTier.end : 0;
        if (start >= 100) return alert("ظرفیت اولویت‌ها تکمیل شده است (۱۰۰٪).");

        document.getElementById('tierStartDisplay').innerText = toPersianNum(start);
        document.getElementById('tierEndInput').value = '';
        document.getElementById('tierEndInput').setAttribute('min', start + 1);
        document.getElementById('tierEndInput').setAttribute('max', 100);
        document.getElementById('nextTierNum').innerText = toPersianNum(app.priorityTiers.length + 1);
        document.getElementById('newTierForm').style.display = 'block';
        document.getElementById('addTierBtn').style.display = 'none';
    }

    function addPriorityTier() {
        const lastTier = app.priorityTiers[app.priorityTiers.length-1];
        const start = lastTier ? lastTier.end : 0;
        const end = parseInt(document.getElementById('tierEndInput').value);

        if (isNaN(end) || end <= start) return alert("سقف باید بیشتر از کف باشد.");
        if (end > 100) return alert("سقف نمی‌تواند بیشتر از ۱۰۰ باشد.");

        app.priorityTiers.push({ id: Date.now(), start: start, end: end });
        saveData();
        renderPriorityTiers();
        
        if (end < 100) {
            showAddTierForm();
        } else {
            document.getElementById('newTierForm').style.display = 'none';
            showToast("تعریف اولویت‌ها تکمیل شد");
        }
    }

    function resetPriorities() {
        if(confirm("آیا تمام بازه‌های اولویت پاک شوند؟")) {
            app.priorityTiers = [];
            saveData();
            openPrioritySettings();
        }
    }

    function delBudget(i) {
        if(confirm('حذف ردیف؟')) {
            saveSectionSnap('budget', `حذف بودجه ${app.budgets[i].name}`);
            app.budgets.splice(i,1);
            saveData();
            renderUI();
        }
    }

    // --- Instruction 3: Updated openExp and submitExp ---
    
    // متغیر سراسری برای ذخیره ایندکس بودجه در حال ویرایش
    let activeIdx = -1; 

    function openExp(i) { 
        activeIdx = i; 
        const modalContent = document.querySelector('#expModal .modal-content'); 
        
        // بررسی و ایجاد فیلد انتخاب کیف پول اگر وجود ندارد 
        // (Note: In the HTML structure I provided earlier, I already added expWalletWrapper, 
        //  but this check ensures safety if HTML is modified)
        let walletSelectDiv = document.getElementById('expWalletWrapper'); 
        if (!walletSelectDiv) { 
            walletSelectDiv = document.createElement('div'); 
            walletSelectDiv.id = 'expWalletWrapper'; 
            walletSelectDiv.style.marginBottom = '15px'; 
            const label = document.createElement('label'); 
            label.innerText = 'پرداخت از کیف پول:'; 
            label.style.display = 'block'; 
            label.style.marginBottom = '5px'; 
            label.style.fontSize = '0.9rem'; 
            label.style.color = 'var(--text-sec)'; 
            const select = document.createElement('select'); 
            select.id = 'expWalletSelect'; 
            select.style.width = '100%'; 
            walletSelectDiv.appendChild(label); 
            walletSelectDiv.appendChild(select); 
            // اضافه کردن قبل از دکمه‌ها 
            const btnContainer = modalContent.querySelector('div[style*="margin-top"]'); 
            modalContent.insertBefore(walletSelectDiv, btnContainer); 
        } 
        
        // لیست کیف پول‌های ممنوعه (سیستمی) 
        const restrictedWallets = [CONST_WALLET_DEBT, CONST_WALLET_CHECK]; 
        
        // پر کردن لیست فقط با کیف پول‌های مجاز 
        const sel = document.getElementById('expWalletSelect'); 
        sel.innerHTML = app.wallets.map((w, idx) => { 
            // اگر کیف پول ممنوعه است، آن را نشان نده 
            if (restrictedWallets.includes(w.name)) return ''; 
            return `<option value="${idx}">${w.name} (موجودی: ${format(w.value)})</option>`; 
        }).join(''); 
        
        // پاک کردن فیلدها 
        document.getElementById('expAmt').value = ''; 
        document.getElementById('expReason').value = ''; 
        openModal('expModal'); 
    }

    function submitExp() { 
        const v = parseFormatted(document.getElementById('expAmt').value); 
        const r = document.getElementById('expReason').value || 'بدون توضیح'; 
        const wIdx = document.getElementById('expWalletSelect').value; 
        
        // اعتبارسنجی‌ها 
        if (isNaN(v) || v <= 0) return alert("مبلغ نامعتبر است"); 
        if (activeIdx === -1) return; 
        if (wIdx === "") return alert("لطفاً کیف پول را انتخاب کنید (اگر لیست خالی است، کیف پول جدید بسازید)"); 
        
        const wallet = app.wallets[wIdx]; 
        const budgetItem = app.budgets[activeIdx]; 
        
        // بررسی موجودی کیف پول 
        if (wallet.value < v) { 
            return alert(`موجودی کیف پول "${wallet.name}" کافی نیست.`); 
        } 
        
        // هشدار اگر بیشتر از بودجه مانده خرج شود (اختیاری) 
        const totalShare = Math.round((app.distributedAmount * budgetItem.percent) / 100) + (budgetItem.manualAdd || 0); 
        const remainingBudget = totalShare - budgetItem.spent; 
        if (v > remainingBudget) { 
            if (!confirm(`هشدار: مبلغ هزینه (${format(v)}) از مانده بودجه این ردیف (${format(remainingBudget)}) بیشتر است.\nآیا ادامه می‌دهید؟`)) { 
                return; 
            } 
        } 
        
        // --- انجام عملیات کسر --- 
        
        // 1. کسر از کیف پول واقعی 
        wallet.value -= v; 
        
        // 2. کسر از پول توزیع شده سیستم (چون این پول خرج شده و دیگر در دسترس نیست) 
        if (app.distributedAmount >= v) { 
            app.distributedAmount -= v; 
        } else { 
            app.distributedAmount = 0; 
        } 
        
        // 3. ثبت آمار در بودجه 
        budgetItem.spent += v; 
        
        // 4. ثبت لاگ و ذخیره 
        saveSectionSnap('budget', `هزینه ${format(v)} برای ${budgetItem.name}`); 
        addToHistory(activeIdx, v, r, 'expense'); 
        logSystemTransaction('expense', v, wallet.name, budgetItem.name, r); 
        
        saveData(); 
        renderUI(); 
        closeAllModals(); 
        showToast("هزینه ثبت و از حساب کسر شد"); 
    }

    function addToHistory(bIdx, amount, reason, type = 'expense') {
        if(!app.budgets[bIdx].history) app.budgets[bIdx].history = [];
        app.budgets[bIdx].history.push({
            id: Date.now() + Math.random(),
            amount: amount,
            reason: reason,
            type: type,
            date: toPersianNum(new Date().toLocaleDateString('fa-IR')),
            time: toPersianNum(new Date().toLocaleTimeString('fa-IR'))
        });
    }

    function openItemHistory(i) {
        tempDepositIndex = i;
        const hList = document.getElementById('itemHistList');
        const hist = app.budgets[i].history || [];
        document.getElementById('histSearchInput').value = '';

        if(hist.length === 0) {
            hList.innerHTML = '<p style="text-align:center;">موردی یافت نشد.</p>';
        } else {
            hList.innerHTML = hist.slice().reverse().map((h, idx) => {
                const isPositive = h.type === 'deposit' || h.type === 'transferIn';
                const color = isPositive ? 'var(--success)' : 'var(--danger)';
                const sign = isPositive ? '+' : '-';
                return `<div class="hist-item" data-search="${h.amount} ${h.reason}" style="border-bottom:1px solid #eee; padding:10px 0;">
                   <div style="display:flex; justify-content:space-between; font-weight:bold; align-items:center;">
                     <span>${h.reason}</span>
                     <div style="display:flex; align-items:center; gap:8px;">
                        <span style="color:${color}; direction:ltr;">${sign}${format(h.amount)}</span>
                        <i class="fas fa-edit" style="color:var(--text-sec); cursor:pointer; font-size:0.9rem;" onclick="editHistoryItem(${i}, '${h.id}')"></i>
                     </div>
                   </div>
                   <div style="font-size:0.75rem; color:var(--text-sec); margin-top:3px;">${h.date} - ${h.time}</div>
                </div>`;
            }).join('');
        }
        openModal('itemHistModal');
    }

    function filterList(inputId, listId) {
        const query = document.getElementById(inputId).value.toLowerCase();
        const items = document.querySelectorAll(`#${listId} .hist-item`);
        items.forEach(item => {
            const text = item.getAttribute('data-search').toLowerCase();
            if(text.includes(query)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

   function editHistoryItem(budgetIdx, histId) {
        closeAllModals();
        const budget = app.budgets[budgetIdx];
        const hIndex = budget.history.findIndex(h => h.id == histId);
        if (hIndex === -1) return;
        const item = budget.history[hIndex];

        document.getElementById('heBudgetId').value = budgetIdx;
        document.getElementById('heHistIndex').value = hIndex;
        document.getElementById('heType').value = item.type;
        
        document.getElementById('heAmount').value = item.amount;
        formatCurrency(document.getElementById('heAmount'));
        
        document.getElementById('heReason').value = item.reason;
        document.getElementById('heDate').value = item.date;
        
        openModal('historyEditModal');
    }

    function saveHistoryEdit() {
        const bIdx = parseInt(document.getElementById('heBudgetId').value);
        const hIdx = parseInt(document.getElementById('heHistIndex').value);
        const newAmount = parseFormatted(document.getElementById('heAmount').value);
        const newReason = document.getElementById('heReason').value;
        const newDate = document.getElementById('heDate').value;

        if (isNaN(newAmount)) return alert("مبلغ نامعتبر است");
        const budget = app.budgets[bIdx];
        const histItem = budget.history[hIdx];
        
        const oldAmount = histItem.amount;
        const diff = newAmount - oldAmount;
        const type = histItem.type;

        saveSectionSnap('budget', `ویرایش تراکنش: ${histItem.reason}`);

        if (type === 'expense' || type === 'transferOut') {
            budget.spent += diff;
        } else if (type === 'deposit' || type === 'transferIn') {
            if (!budget.manualAdd) budget.manualAdd = 0;
            budget.manualAdd += diff;
        }

        histItem.amount = newAmount;
        histItem.reason = newReason;
        histItem.date = newDate;

        saveData();
        renderUI();
        closeAllModals();
        showToast("تراکنش ویرایش شد");
    }

    function openAllocate(type, id) {
        document.getElementById('allocType').value = type;
        document.getElementById('allocId').value = id;

        const sel = document.getElementById('allocBudgetSelect');
        sel.innerHTML = `<option value="">انتخاب کنید...</option>` + app.budgets.map((b, i) => `<option value="${i}">${b.name}</option>`).join('');
        
        sel.onchange = function() {
            const idx = sel.value;
            const infoBox = document.getElementById('allocInfo');
            if(idx === "") {
                infoBox.style.display = 'none';
                return;
            }
            const b = app.budgets[idx];
            const baseAmount = app.distributedAmount;
            const share = Math.round((baseAmount * b.percent) / 100) + (b.manualAdd || 0);
            const remain = share - b.spent;
            
            infoBox.style.display = 'flex';
            const displayEl = document.getElementById('allocLimitDisplay');
            displayEl.innerText = format(remain);
            displayEl.dataset.max = remain;
        };

        if(type === 'shop' && app.shopping[id].price) {
            document.getElementById('allocAmt').value = app.shopping[id].price.toLocaleString();
        } else {
            document.getElementById('allocAmt').value = '';
        }

        document.getElementById('allocInfo').style.display = 'none';
        openModal('allocModal');
    }

    function performAllocation() {
        const type = document.getElementById('allocType').value;
        const id = parseInt(document.getElementById('allocId').value);
        const bIdxStr = document.getElementById('allocBudgetSelect').value;
        if(bIdxStr === "") return alert("لطفا یک ردیف بودجه انتخاب کنید");

        const bIdx = parseInt(bIdxStr);
        const amt = parseFormatted(document.getElementById('allocAmt').value);
        const max = parseFloat(document.getElementById('allocLimitDisplay').dataset.max) || 0;

        if(isNaN(amt) || amt <= 0) return alert("مبلغ نامعتبر");
        if(amt > max) return alert("خطا: مبلغ وارد شده از موجودی این ردیف بودجه بیشتر است!");

        let reason = "";
        if(type === 'goal') {
            app.goals[id].curr += amt;
            reason = "اختصاص به هدف: " + app.goals[id].name;
        } else {
            if(!app.shopping[id].paid) app.shopping[id].paid = 0;
            app.shopping[id].paid += amt;
            reason = "خرید کالا: " + app.shopping[id].name;
        }

        saveSectionSnap('budget', reason);
        app.budgets[bIdx].spent += amt;
        addToHistory(bIdx, amt, reason, 'expense');
        logSystemTransaction('expense', amt, app.budgets[bIdx].name, reason, 'اختصاص بودجه');
        saveData();
        renderUI();
        closeAllModals();
        showToast("تراکنش ثبت شد");
    }

    function toggleCurrency() {
        app.user.currency = app.user.currency === 'toman' ? 'rial' : 'toman';
        const btn = document.getElementById('currBtn');
        if(app.user.currency === 'rial') btn.classList.add('active');
        else btn.classList.remove('active');
        saveData();
        renderUI();
    }

    function toggleTheme() {
        if(document.body.getAttribute('data-theme') === 'dark') {
            document.body.removeAttribute('data-theme');
            app.user.theme = 'light';
        } else {
            document.body.setAttribute('data-theme', 'dark');
            app.user.theme = 'dark';
        }
        saveData();
    }

    function applyTheme() {
        if(app.user.theme === 'dark') document.body.setAttribute('data-theme', 'dark');
    }

    // Analytics
    function renderReports() {
        if (document.getElementById('view-reports').classList.contains('active')) {
            setTimeout(() => {
                renderDonutChart();
                renderLineChart();
            }, 200);
        }
    }

    function renderDonutChart() {
        const ctx = document.getElementById('expenseChart').getContext('2d');
        if (myChart1) myChart1.destroy();

        const labels = app.budgets.map(b => b.name);
        const data = app.budgets.map(b => b.spent);
        const colors = ['#f87171', '#fbbf24', '#34d399', '#60a5fa', '#818cf8', '#a78bfa', '#f472b6'];

        myChart1 = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors,
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { font: { family: 'Vazirmatn' } }
                    }
                }
            }
        });
    }

    function renderLineChart() {
        const ctx = document.getElementById('netWorthChart').getContext('2d');
        if (myChart2) myChart2.destroy();

        const logs = app.dailyLogs.slice(-30);
        const labels = logs.map(l => toPersianNum(l.date));
        const data = logs.map(l => l.net);

        myChart2 = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'موجودی خالص',
                    data: data,
                    borderColor: '#4f46e5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    function exportExcel() {
        withLoading(() => {
            const toEn = (str) => str ? str.toString().replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d)) : '';
            
            // تابع کمکی برای تمیز کردن متن‌ها (حذف کاما و خط جدید که فرمت CSV را خراب می‌کند)
            const clean = (text) => {
                if (!text) return "";
                return text.toString().replace(/,/g, "،").replace(/\n/g, " ");
            };

            // ساخت محتوای CSV
            // نکته: استفاده از BOM (\uFEFF) برای نمایش صحیح فارسی الزامی است
            let csvContent = "\uFEFF"; 
            
            // بخش 1: خلاصه وضعیت
            csvContent += "خلاصه وضعیت مالی\n";
            csvContent += "نام کاربر,موجودی کل,بدهی کل,تاریخ گزارش\n";
            csvContent += `${clean(app.user.name)},${toEn(document.getElementById('totalBalance').innerText)},${toEn(app.debts.reduce((a,b)=>a+b.value,0) + app.checks.reduce((a,b)=>!b.isPaid?a+b.value:0,0))},${new Date().toLocaleDateString('fa-IR')}\n\n`;

            // بخش 2: تراکنش‌های بودجه
            csvContent += "تاریخچه تراکنش های بودجه\n";
            csvContent += "تاریخ,ساعت,نوع,مبلغ,دسته بندی,توضیحات\n";
            
            app.budgets.forEach(b => {
                if (b.history) {
                    b.history.forEach(h => {
                        const typeFa = h.type === 'expense' ? 'هزینه' : (h.type === 'deposit' ? 'واریز' : 'انتقال');
                        csvContent += `${h.date},${h.time},${typeFa},${toEn(h.amount)},${clean(b.name)},${clean(h.reason)}\n`;
                    });
                }
            });
            csvContent += "\n";

            // بخش 3: اهداف
            csvContent += "اهداف پس انداز\n";
            csvContent += "هدف,مبلغ هدف,جمع شده,مانده\n";
            app.goals.forEach(g => {
                csvContent += `${clean(g.name)},${toEn(g.target)},${toEn(g.curr)},${toEn(g.target - g.curr)}\n`;
            });
            csvContent += "\n";

            // بخش 4: بدهی‌ها
            csvContent += "بدهی و اقساط\n";
            csvContent += "عنوان,مبلغ,نوع,وضعیت\n";
            app.debts.forEach(d => {
                csvContent += `${clean(d.name)},${toEn(d.value)},قسط ثابت,${d.lastPaid === getCurMonth() ? 'پرداخت شده' : 'مانده'}\n`;
            });
            app.checks.forEach(c => {
                csvContent += `${clean(c.name)},${toEn(c.value)},چک/بدهی,${c.isPaid ? 'پاس شده' : 'پاس نشده'}\n`;
            });

            // ایجاد و دانلود فایل
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Gozaresh_Mali_${new Date().toLocaleDateString('fa-IR').replace(/\//g,'-')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast("فایل اکسل (CSV) دانلود شد");
        }, 1000);
    }

    // Instruction 5: Comprehensive Image Report (Fixed Transfer Details)
    function generateReportImage() {
        withLoading(() => {
            const income = app.wallets.reduce((a,b)=>a+b.value,0);
            
            const fixedDebt = app.debts.reduce((a,b)=> a+b.value, 0); 
            const checkDebt = (app.checks || []).reduce((a,b)=> !b.isPaid ? a+b.value : 0, 0);
            const totalDebt = fixedDebt + checkDebt;
            
            let net = income - totalDebt;
            if (net < 0) net = 0;

            const days = app.user.startDate ? Math.floor((Date.now() - app.user.startDate)/(1000*60*60*24))+1 : 0;

            // Header Info
            document.getElementById('printDate').innerText = toPersianNum(new Date().toLocaleDateString('fa-IR'));
            document.getElementById('printUser').innerText = app.user.name;
            document.getElementById('printDays').innerText = toPersianNum(days);
            document.getElementById('printInc').innerText = format(income);
            document.getElementById('printDebt').innerText = format(totalDebt);
            document.getElementById('printNet').innerText = format(net);

            // Chart
            if(app.dailyLogs && app.dailyLogs.length > 0) {
                const ctx = document.getElementById('printChart').getContext('2d');
                if(window.myPrintChart) window.myPrintChart.destroy();
                const logs = app.dailyLogs.slice(-15);
                window.myPrintChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: logs.map(l => toPersianNum(l.date)),
                        datasets: [{
                            label: 'موجودی خالص (تومان)',
                            data: logs.map(l => l.net),
                            borderColor: '#4338ca',
                            backgroundColor: 'rgba(67, 56, 202, 0.1)',
                            fill: true
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // History Table
                const hTab = document.getElementById('printHistoryTable');
                hTab.innerHTML = logs.map(l => `<tr><td>${toPersianNum(l.date)}</td><td>${format(l.net)}</td><td>${format(l.spent)}</td></tr>`).join('');
            }

            // Budgets Table
            const tb = document.getElementById('printBody');
            tb.innerHTML = '';
            app.budgets.forEach(b => {
                const baseAmount = app.distributedAmount;
                const s = Math.round((baseAmount * b.percent) / 100) + (b.manualAdd || 0);
                tb.innerHTML += `<tr><td>${b.name}</td><td>${toPersianNum(b.percent)}%</td><td>${format(s)}</td><td>${format(b.spent)}</td><td>${format(s-b.spent)}</td></tr>`;
            });

            // Detailed Lists
            
            // 1. Wallets
            let walletsHtml = "<h4>منابع مالی (کیف پول‌ها)</h4><table class='print-table'><thead><tr><th>نام کیف</th><th>موجودی</th></tr></thead><tbody>";
            app.wallets.forEach(w => {
                walletsHtml += `<tr><td>${w.name}</td><td>${format(w.value)}</td></tr>`;
            });
            walletsHtml += "</tbody></table>";

            // 2. Debts
            let debtsHtml = "<h4>اقساط و بدهی‌ها</h4><table class='print-table'><thead><tr><th>عنوان</th><th>مبلغ</th><th>نوع</th><th>وضعیت</th></tr></thead><tbody>";
            app.debts.forEach(d => {
                // For report, check if lastPaid matches current month
                const isPaid = d.lastPaid === getCurMonth();
                debtsHtml += `<tr><td>${d.name}</td><td>${format(d.value)}</td><td>قسط ثابت</td><td>${isPaid ? 'پرداخت شده' : 'مانده'}</td></tr>`;
            });
            app.checks.forEach(c => {
                debtsHtml += `<tr><td>${c.name}</td><td>${format(c.value)}</td><td>چک/بدهی</td><td>${c.isPaid ? 'پاس شده' : 'مانده'}</td></tr>`;
            });
            debtsHtml += "</tbody></table>";

            // 3. Goals
            let goalsHtml = "<h4>اهداف پس‌انداز</h4><table class='print-table'><thead><tr><th>هدف</th><th>هدف کل</th><th>جمع شده</th><th>مانده</th></tr></thead><tbody>";
            app.goals.forEach(g => {
                goalsHtml += `<tr><td>${g.name}</td><td>${format(g.target)}</td><td>${format(g.curr)}</td><td>${format(g.target - g.curr)}</td></tr>`;
            });
            goalsHtml += "</tbody></table>";

            // 4. Shopping
            let shopHtml = "<h4>لیست خرید</h4><table class='print-table'><thead><tr><th>کالا</th><th>قیمت تقریبی</th><th>پرداخت شده</th></tr></thead><tbody>";
            app.shopping.forEach(s => {
                shopHtml += `<tr><td>${s.name}</td><td>${format(s.price||0)}</td><td>${format(s.paid||0)}</td></tr>`;
            });
            shopHtml += "</tbody></table>";

            // 5. Loans (Given)
            let loansHtml = "<h4>طلب‌ها (قرض داده شده)</h4><table class='print-table'><thead><tr><th>شخص</th><th>مبلغ</th><th>وضعیت</th></tr></thead><tbody>";
            app.loans.forEach(l => {
                loansHtml += `<tr><td>${l.name}</td><td>${format(l.value)}</td><td>${l.isReceived ? 'وصول شد' : 'مانده'}</td></tr>`;
            });
            loansHtml += "</tbody></table>";

            // 6. Recent Transfers (Fixed Details)
            let transHtml = "<h4>آخرین انتقال‌ها (وجه به وجه)</h4><table class='print-table'><thead><tr><th>نوع</th><th>مبلغ</th><th>جزئیات کامل</th></tr></thead><tbody>";
            if(app.transfers) {
                app.transfers.slice(-5).forEach(t => {
                    // Translate Status
                    let statusFa = "نامشخص";
                    if(t.status === 'approved') statusFa = "موفق";
                    else if(t.status === 'rejected') statusFa = "ناموفق (رد شده)";
                    else if(t.status === 'pending') statusFa = "در انتظار تایید";

                    // Build Detail String
                    let details = `
                        <div style="text-align:right; font-size:0.8rem; line-height:1.6;">
                            <b>تاریخ:</b> ${t.date} <br>
                            <b>فرستنده:</b> ${t.senderName || '---'} (${toPersianNum(t.senderAccount || '---')})<br>
                            <b>گیرنده:</b> ${t.destName || '---'} (${toPersianNum(t.destAccount || '---')})<br>
                            <b>وضعیت:</b> ${statusFa}
                        </div>
                    `;

                    transHtml += `<tr><td>${t.type==='incoming'?'دریافت':'ارسال'}</td><td>${format(t.amount)}</td><td>${details}</td></tr>`;
                });
            }
            transHtml += "</tbody></table>";

            // Append all to print area
            const listsContainer = document.getElementById('printDebtsList');
            listsContainer.innerHTML = walletsHtml + debtsHtml;
            document.getElementById('printGoalsList').innerHTML = goalsHtml + shopHtml + loansHtml + transHtml;

            const el = document.getElementById('printArea');
            el.style.top = "0";

            setTimeout(() => {
                html2canvas(el, { scale: 2 }).then(c => {
                    const a = document.createElement('a');
                    a.download = `Financial_Full_Report_${days}Days.png`;
                    a.href = c.toDataURL();
                    a.click();
                    el.style.top = "-9999px";
                    toggleLoading(false);
                });
            }, 800);
        }, 100);
    }

    function downloadBackup() {
        withLoading(() => {
            const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(app));
            const a = document.createElement('a');
            a.href = str;
            a.download = "backup.json";
            a.click();
            
            // Logic for Guest Mode removed here as requested
            app.history.unshift({date: Date.now(), name: "بکاپ دستی"});
            if(app.history.length > 5) app.history.pop();
            saveData();
            
        }, 1500);
    }

    function restoreBackup(input) {
        withLoading(() => {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const loadedApp = JSON.parse(e.target.result);
                    
                    // Merge loaded data with default structure to ensure new fields exist
                    app = { ...defaultState, ...loadedApp };

                    // Deep merge checks
                    if(!app.priorities) app.priorities = defaultState.priorities;
                    if(!app.priorityTiers) app.priorityTiers = defaultState.priorityTiers;
                    if(!app.settings) app.settings = defaultState.settings;
                    if(!app.sectionHistory) app.sectionHistory = { dashboard: [], budget: [], tools: [] };
                    if(app.distributedAmount === undefined) app.distributedAmount = 0;
                    if(!app.security.nationalId) app.security.nationalId = "";
                    if(!app.dailyLogs) app.dailyLogs = [];
                    if(!app.transfers) app.transfers = [];
                    if(!app.transactionLog) app.transactionLog = [];

                    // Fix potentially missing properties in arrays
                    app.budgets.forEach(b => {
                        if(!b.history) b.history = [];
                        if(b.manualAdd === undefined) b.manualAdd = 0;
                        if(b.isPaused === undefined) b.isPaused = false;
                        if(b.savedPercent === undefined) b.savedPercent = 0;
                        if(!b.subs) b.subs = [];
                        if(!b.internalDebt) b.internalDebt = [];
                    });
                    app.goals.forEach(g => {
                        if(!g.autoConfig) g.autoConfig = {type:'none'};
                    });
                    app.shopping.forEach(s => {
                        if(!s.autoConfig) s.autoConfig = {type:'none'};
                        if(s.paid === undefined) s.paid = 0;
                    });
                    app.debts.forEach(d => {
                        if(d.lastPaid === undefined) d.lastPaid = null;
                        if(d.deduct === undefined) d.deduct = true; 
                    });
                    app.checks.forEach(c => {
                        if(c.isPaid === undefined) c.isPaid = false;
                        if(c.deduct === undefined) c.deduct = true;
                    });
                    app.loans.forEach(l => {
                        if(l.isReceived === undefined) l.isReceived = false;
                    });

                    logSystemTransaction('system', 0, 'Backup', 'Restore', 'بازیابی موفق فایل پشتیبان');
                    saveData();
                    location.reload();
                } catch(err) {
                    alert("فایل نامعتبر یا خراب است.");
                    console.error(err);
                }
            };
            reader.readAsText(file);
        }, 2000);
    }

    function showHistory() {
        const d = document.getElementById('histList');
        d.innerHTML = app.history.map(h => `<div style="padding:10px; border-bottom:1px solid #eee;">${h.name} - ${new Date(h.date).toLocaleDateString('fa-IR')}</div>`).join('');
        openModal('histModal');
    }

    function resetAll() {
        if(confirm("هشدار: تمام اطلاعات مالی شما پاک خواهد شد (نام، کد ملی و رمز عبور باقی می‌ماند). آیا مطمئن هستید؟")) {
            // Keep security info
            const sec = app.security;
            const usrName = app.user.name;
            const natId = app.security.nationalId;
            const pass = app.security.password;
            
            // Reset to default
            app = JSON.parse(JSON.stringify(defaultState));
            
            // Restore Security
            app.security = sec;
            app.security.nationalId = natId;
            app.security.password = pass;
            app.user.name = usrName;
            
            logSystemTransaction('system', 0, 'System', 'Reset', 'بازنشانی کامل سیستم (Reset Factory)');
            saveData();
            location.reload();
        }
    }

    function copyTxt(n) {
        const raw = document.getElementById('rawCopyCheck').checked;
        const txt = raw ? (n*rate).toString() : format(n);
        navigator.clipboard.writeText(txt);
        showToast("کپی شد: " + txt);
    }

    // --- SAVING DATA (Updated for Instruction 7) ---
    function saveData() {
        // Local Backup (Essential for offline access)
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(app));

        // Cloud Backup (if logged in and online)
        if(app.security && app.security.nationalId && navigator.onLine) {
            // Send appData to cloud
            googleApi('apiSaveData', app.security.nationalId, JSON.stringify(app))
                .then(res => {
                    if(!res.success) console.error("Cloud Save Failed: " + res.message);
                })
                .catch(err => console.error("Cloud Save Network Error", err));
        }
    }

    function updateDate() {
        document.getElementById('headerDate').innerText = toPersianNum(new Date().toLocaleDateString('fa-IR'));
    }

    function switchTab(id) {
        document.querySelectorAll('.tab-pane').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
        document.getElementById('view-'+id).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => {
            if(b.getAttribute('onclick').includes(id)) b.classList.add('active');
        });
        if (id === 'reports') {
            renderReports();
        }
    }

    function openModal(id) {
        if(id === 'prioritySettingsModal') {
            // This check is fine here, but the recursive call inside openModal was the issue.
            // Since openPrioritySettings calls openModal, we just let it proceed.
        }
        
        const m = document.getElementById(id);
        if (!m) return console.error("Modal not found: " + id);

        const inputs = m.querySelectorAll('input');
        inputs.forEach(i => {
            // Clear inputs unless they are special/hidden
            if(i.type !== 'hidden' && i.type !== 'checkbox' && i.type !== 'range' && 
               !i.classList.contains('sub-name') && !i.classList.contains('sub-percent-input') && 
               i.id !== 'aaPercent' && i.id !== 'aaAmount' && i.id !== 'aaMin' && 
               i.id !== 'heBudgetId' && i.id !== 'heHistIndex' && i.id !== 'heType' && 
               i.id !== 'setupNameInput' && i.id !== 'setupNatId' && 
               i.id !== 'tierEndInput' && i.id !== 'histSearchInput' && 
               i.id !== 'btDestInput' && i.id !== 'btAmountInput' && i.id !== 'btPinInput' && 
               i.id !== 'loginNatId' && i.id !== 'loginPass' && 
               !i.classList.contains('wallet-deduct-input') ) {
                i.value = '';
            }
        });
        m.classList.add('active');
    }

    function closeAllModals() {
        document.querySelectorAll('.modal').forEach(e => e.classList.remove('active'));
    }
</script>
</body>
  </html>
