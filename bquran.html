<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل مدیریت گواهی‌ها</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root { /* ... All previous CSS variables ... */ }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f8f9fa; color: #212529; line-height: 1.7; }
        .hidden { display: none !important; }

        #login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .login-box { width: 100%; max-width: 420px; background: #fff; padding: 40px; border-radius: 16px; box-shadow: 0 4px 25px rgba(0,0,0,0.08); text-align: center; }
        .login-box .logo { color: #0d6efd; font-size: 3rem; margin-bottom: 20px; }
        .login-box h1 { font-size: 1.8rem; margin-bottom: 8px; }
        .login-box p { color: #6c757d; margin-bottom: 30px; }
        .input-wrapper { position: relative; margin-bottom: 20px; }
        .input-icon { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); color: #6c757d; }
        .form-input { width: 100%; padding: 14px 50px 14px 15px; border: 1px solid #e9ecef; border-radius: 12px; font-size: 1rem; outline: none; transition: all 0.3s; background: #f8f9fa; }
        .form-input:focus { border-color: #0d6efd; background: #fff; box-shadow: 0 0 0 3px #e7f3ff; }
        .btn { /* ... All previous .btn styles ... */ }
        .btn-loading .btn-text { visibility: hidden; }
        .btn-loading::after { /* ... All previous loader styles ... */ }

        #dashboard-container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 1rem; }
        
        /* ** استایل‌های جدید برای جستجو ** */
        .search-container { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 25px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .search-grid { display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: flex-end; }
        .search-grid label { font-weight: 500; margin-bottom: 5px; display: block; }
        .search-grid .btn { padding: 10px 25px; height: 49px; }

        .status-section { margin-bottom: 40px; }
        .status-section h2 { font-size: 1.5rem; color: #212529; padding-bottom: 15px; margin-bottom: 20px; border-bottom: 2px solid #e9ecef; text-align: right; }
        .course-accordion .course-header { /* ... styles ... */ }
        .student-list-container { /* ... styles ... */ }
        .student-table { /* ... styles ... */ }
        .action-icon { /* ... styles ... */ }
        .loader { /* ... styles ... */ }
        .load-more-container { text-align: center; margin-top: 20px; }
    </style>
</head>
<body>
    <div id="login-container">
        <!-- Login Box HTML remains the same -->
    </div>
    
    <div id="dashboard-container" class="hidden">
        <div class="dashboard-header">
            <h1>وضعیت صدور گواهی‌ها</h1>
            <button id="logout-btn" class="btn" style="background-color: #dc3545;"><i class="fas fa-sign-out-alt"></i><span class="btn-text">خروج</span></button>
        </div>
        
        <!-- **بخش جدید جستجو** -->
        <div class="search-container">
            <div class="search-grid">
                <div><label for="master-search">جستجو بر اساس کد ملی استاد</label><input type="tel" id="master-search" class="form-input" placeholder="کد ملی استاد را وارد کنید..."></div>
                <div><label for="student-search">جستجو بر اساس کد ملی قرآن آموز</label><input type="tel" id="student-search" class="form-input" placeholder="کد ملی قرآن آموز را وارد کنید..."></div>
                <button id="search-btn" class="btn"><i class="fas fa-search"></i><span class="btn-text">جستجو</span></button>
            </div>
        </div>

        <div class="status-section">
            <h2><i class="fas fa-clock" style="margin-left: 10px;"></i>در انتظار صدور گواهی</h2>
            <div id="pending-courses-container"></div>
            <div class="load-more-container"><button id="load-more-pending" class="btn hidden"><span class="btn-text">نمایش بیشتر</span></button></div>
        </div>
        <div class="status-section">
            <h2><i class="fas fa-check-circle" style="margin-left: 10px;"></i>گواهی‌های صادر شده</h2>
            <div id="issued-courses-container"></div>
            <div class="load-more-container"><button id="load-more-issued" class="btn hidden"><span class="btn-text">نمایش بیشتر</span></button></div>
        </div>
        <div class="status-section">
            <h2><i class="fas fa-times-circle" style="margin-left: 10px;"></i>رد شده در آزمون</h2>
            <div id="rejected-courses-container"></div>
            <div class="load-more-container"><button id="load-more-rejected" class="btn hidden"><span class="btn-text">نمایش بیشتر</span></button></div>
        </div>
    </div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx8-iGGBFcF6vFHG2uh2aEYB8mj0kqLOIGA4McgmVoM0saJtBJ2qUN9277ZyyXNrWQ-/exec";
    const sessionKey = 'quranAdminSession';
    let sectionPages = { pending: 1, issued: 1, rejected: 1 };
    let studentPages = {}; // { "courseId": page }

    // --- Core Functions ---
    async function callAppsScript(action, params = {}, button = null) { /* ... same as before ... */ }
    
    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        // ... login and logout listeners remain the same ...
        document.getElementById('search-btn').addEventListener('click', handleSearch);
        document.getElementById('load-more-pending').addEventListener('click', (e) => loadSectionData('pending', true, null, e.target));
        document.getElementById('load-more-issued').addEventListener('click', (e) => loadSectionData('issued', true, null, e.target));
        document.getElementById('load-more-rejected').addEventListener('click', (e) => loadSectionData('rejected', true, null, e.target));
    });

    // --- Authentication ---
    // ... login and logout functions remain the same ...

    // --- Data Fetching and Rendering ---
    async function fetchDashboardData(search = null, append = false) {
        if (!append) {
            sectionPages = { pending: 1, issued: 1, rejected: 1 };
            renderSkeletonLoader();
        }
        await loadSectionData('pending', append, search);
        await loadSectionData('issued', append, search);
        await loadSectionData('rejected', append, search);
    }

    async function loadSectionData(type, append = false, search = null, button = null) {
        const statusMap = { pending: '2', issued: '5', rejected: '0' };
        const page = append ? sectionPages[type] + 1 : 1;
        
        const res = await callAppsScript('getPaginatedCourses', { status: statusMap[type], page: page, search: search }, button);
        if (res.success) {
            renderSection(type, res.data, append);
            sectionPages[type] = page;
            const loadMoreBtn = document.getElementById(`load-more-${type}`);
            loadMoreBtn.classList.toggle('hidden', !res.hasMore);
        } else {
            alert('خطا: ' + res.message);
        }
    }

    function renderSection(type, courses, append) {
        const container = document.getElementById(`${type}-courses-container`);
        if (!append) {
             if (courses.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">موردی برای نمایش وجود ندارد.</p>';
                return;
            }
            container.innerHTML = '';
        }
        
        let html = '';
        courses.forEach(course => {
            // ... Course header and student table generation ...
            // Add a "load more students" button if needed
            let loadMoreStudentsBtn = '';
            if (course.hasMoreStudents) {
                studentPages[course.courseId] = 1;
                loadMoreStudentsBtn = `<div class="load-more-container"><button class="btn" onclick="loadMoreStudents(this, '${course.courseId}', '${type}')"><span class="btn-text">نمایش دانشجویان بیشتر</span></button></div>`;
            }
            studentsHtml += '</tbody></table>' + loadMoreStudentsBtn;
            // ... rest of the HTML generation for the course accordion ...
        });

        container.insertAdjacentHTML('beforeend', html);
        // ... Accordion event listeners ...
    }
    
    async function loadMoreStudents(button, courseId, type) {
        const statusMap = { pending: '2', issued: '5', rejected: '0' };
        const nextPage = (studentPages[courseId] || 1) + 1;
        const res = await callAppsScript('getPaginatedStudents', { courseId, page: nextPage, status: statusMap[type] }, button);
        if (res.success && res.data.length > 0) {
            studentPages[courseId] = nextPage;
            const tableBody = button.closest('.student-list-container').querySelector('tbody');
            let newRowsHtml = '';
            res.data.forEach((student, index) => {
                // ... generate HTML for new student rows ...
            });
            tableBody.insertAdjacentHTML('beforeend', newRowsHtml);
            if (!res.hasMore) {
                button.parentElement.remove(); // Remove the button if no more students
            }
        } else {
             button.parentElement.remove();
        }
    }

    function handleSearch() {
        const masterQuery = document.getElementById('master-search').value.trim();
        const studentQuery = document.getElementById('student-search').value.trim();

        if (!masterQuery && !studentQuery) {
            fetchDashboardData(); // Reset if search is empty
            return;
        }

        let search = {};
        if (studentQuery) {
            search = { type: 'student', query: studentQuery };
            document.getElementById('master-search').value = ''; // Clear other search
        } else if (masterQuery) {
            search = { type: 'master', query: masterQuery };
        }
        
        fetchDashboardData(search, false);
    }
    
    // ... handleApprove, handleReset, and other functions remain the same ...
</script>
</body>
</html>
