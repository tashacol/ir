 <!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل مدیریت اساتید</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-Regular.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f8f9fa;
        }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 2rem;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .dashboard-container {
            display: none; /* در ابتدا مخفی است */
        }
        .accordion-button:not(.collapsed) {
            color: #0d6efd;
            background-color: #e7f1ff;
        }
        .accordion-header h2 {
            margin: 0;
            padding: 0;
        }
        .student-list-item {
            display: grid;
            grid-template-columns: 30px 1fr 1fr 80px 50px;
            gap: 10px;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #dee2e6;
        }
        .student-list-item:last-child {
            border-bottom: none;
        }
        .student-list-header {
            font-weight: bold;
            background-color: #f1f3f5;
        }
        .action-icon {
            cursor: pointer;
            font-size: 1.3rem;
            text-align: center;
        }
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.7);
            display: none; /* Initially hidden */
            justify-content: center;
            align-items: center;
            z-index: 1056; 
        }
    </style>
</head>
<body>

    <!-- Loader Overlay -->
    <div id="loader-overlay" class="loader-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">در حال بارگذاری...</span>
        </div>
    </div>

    <!-- Login Form -->
    <div id="login-container" class="login-container">
        <h2 class="text-center mb-4">ورود به پنل</h2>
        <form id="login-form">
            <div class="form-floating mb-3">
                <input type="text" class="form-control" id="username" placeholder="نام کاربری" required>
                <label for="username">نام کاربری</label>
            </div>
            <div class="form-floating mb-3">
                <input type="password" class="form-control" id="password" placeholder="رمز عبور" required>
                <label for="password">رمز عبور</label>
            </div>
            <button type="submit" class="btn btn-primary w-100 py-2">ورود</button>
            <div id="login-error" class="alert alert-danger mt-3 d-none"></div>
        </form>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard-container" class="container dashboard-container py-5">
        <h1 class="text-center mb-5">داشبورد مدیریت قرآن آموزان</h1>

        <!-- Section 1: Awaiting Approval -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h3>در انتظار صدور گواهی</h3>
            </div>
            <div class="card-body">
                <div class="accordion" id="pending-accordion"></div>
                <div id="no-pending-data" class="text-center text-muted p-3 d-none">موردی برای نمایش وجود ندارد.</div>
            </div>
        </div>

        <!-- Section 2: Issued Certificates -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h3>گواهی های صادر شده</h3>
            </div>
            <div class="card-body">
                <div class="accordion" id="issued-accordion"></div>
                 <div id="no-issued-data" class="text-center text-muted p-3 d-none">موردی برای نمایش وجود ندارد.</div>
            </div>
        </div>

        <!-- Section 3: Failed Students -->
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h3>رد شده در آزمون</h3>
            </div>
            <div class="card-body">
                <div class="accordion" id="failed-accordion"></div>
                 <div id="no-failed-data" class="text-center text-muted p-3 d-none">موردی برای نمایش وجود ندارد.</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // !!!!!! مهم: این آدرس را با آدرس وب اپلیکیشن خودتان جایگزین کنید !!!!!!
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwN2nvknA_Uwww7HEB_FluDyNH-lszcJ9Se8B8r-d3BaXwkhBYQN68LW49Eq9R6uqoolw/exec";

        const loginForm = document.getElementById('login-form');
        const loginContainer = document.getElementById('login-container');
        const dashboardContainer = document.getElementById('dashboard-container');
        const loader = document.getElementById('loader-overlay');

        // تابع کمکی برای ارسال درخواست به API گوگل
        async function postToApi(payload) {
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    body: JSON.stringify(payload),
                    headers: {
                        "Content-Type": "text/plain;charset=utf-8",
                    }
                });
                return await response.json();
            } catch (error) {
                console.error("Fetch Error:", error);
                return { success: false, message: "خطای شبکه. لطفا اتصال اینترنت خود را بررسی کنید." };
            }
        }
        
        // مدیریت ورود
        loginForm.addEventListener('submit', async event => {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('login-error');
            
            showLoader();
            loginError.classList.add('d-none');

            const payload = { action: 'login', username, password };
            const response = await postToApi(payload);
            
            hideLoader();
            if (response.success) {
                loginContainer.style.display = 'none';
                dashboardContainer.style.display = 'block';
                fetchAndRenderDashboard();
            } else {
                loginError.textContent = response.message;
                loginError.classList.remove('d-none');
            }
        });

        function showLoader() { loader.style.display = 'flex'; }
        function hideLoader() { loader.style.display = 'none'; }
        
        // دریافت و نمایش اطلاعات داشبورد
        async function fetchAndRenderDashboard() {
            showLoader();
            const payload = { action: 'getDashboard' };
            const response = await postToApi(payload);
            
            hideLoader();
            if (response.success) {
                renderDashboard(response.data);
            } else {
                alert("خطا در دریافت اطلاعات: " + response.message);
            }
        }

        // نمایش داده‌ها در آکاردئون‌ها (کد این بخش بدون تغییر است)
        function renderDashboard(courses) {
            const pendingAccordion = document.getElementById('pending-accordion');
            const issuedAccordion = document.getElementById('issued-accordion');
            const failedAccordion = document.getElementById('failed-accordion');

            pendingAccordion.innerHTML = ''; issuedAccordion.innerHTML = ''; failedAccordion.innerHTML = '';
            
            let hasPending = false, hasIssued = false, hasFailed = false;

            Object.values(courses).forEach(course => {
                if (course.students.pending.length > 0) {
                    hasPending = true;
                    pendingAccordion.innerHTML += createAccordionItem(course, 'pending');
                }
                if (course.students.issued.length > 0) {
                    hasIssued = true;
                    issuedAccordion.innerHTML += createAccordionItem(course, 'issued');
                }
                if (course.students.failed.length > 0) {
                    hasFailed = true;
                    failedAccordion.innerHTML += createAccordionItem(course, 'failed');
                }
            });
            
            document.getElementById('no-pending-data').classList.toggle('d-none', hasPending);
            document.getElementById('no-issued-data').classList.toggle('d-none', hasIssued);
            document.getElementById('no-failed-data').classList.toggle('d-none', hasFailed);
            
            addEventListeners();
        }

        function createAccordionItem(course, type) {
            const students = course.students[type];
            const parentId = `${type}-accordion`;
            const collapseId = `collapse-${type}-${course.courseCode}`;

            let studentListHtml = `<div class="student-list-item student-list-header"><div>#</div><div>نام و نام خانوادگی</div><div>کد ملی</div><div>نمره دوره</div><div>عملیات</div></div>`;

            students.forEach((student, index) => {
                let actionIcon = '';
                switch(type) {
                    case 'pending':
                        actionIcon = `<i class="bi bi-check-circle-fill text-success action-icon approve-btn" data-rownum="${student.rowNum}" title="تایید گواهی"></i>`;
                        break;
                    case 'issued':
                        actionIcon = `<i class="bi bi-patch-check-fill text-primary" title="تایید شده"></i>`;
                        break;
                    case 'failed':
                        actionIcon = `<i class="bi bi-trash3-fill text-danger action-icon reset-btn" data-rownum="${student.rowNum}" title="حذف نمرات و تلاش مجدد"></i>`;
                        break;
                }
                studentListHtml += `<div class="student-list-item"><div>${index + 1}</div><div>${student.name || ''}</div><div>${student.nationalId || ''}</div><div>${student.score || ''}</div><div class="text-center">${actionIcon}</div></div>`;
            });

            return `<div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}"><strong>${course.teacherName}</strong>&nbsp;-&nbsp;تاریخ شروع: ${course.startDate} &nbsp;<span class="badge bg-secondary ms-auto">${students.length} نفر</span></button></h2><div id="${collapseId}" class="accordion-collapse collapse" data-bs-parent="#${parentId}"><div class="accordion-body p-0">${studentListHtml}</div></div></div>`;
        }
        
        function addEventListeners() {
            document.querySelectorAll('.approve-btn').forEach(btn => {
                btn.onclick = (e) => handleAction('approve', e.target.dataset.rownum, "آیا از تایید این گواهینامه اطمینان دارید؟");
            });
            document.querySelectorAll('.reset-btn').forEach(btn => {
                btn.onclick = (e) => handleAction('reset', e.target.dataset.rownum, "آیا از حذف تمام نمرات این قرآن آموز اطمینان دارید؟ این عمل غیرقابل بازگشت است.");
            });
        }
        
        async function handleAction(action, rowNum, confirmMessage) {
            if (confirm(confirmMessage)) {
                showLoader();
                const payload = { action, rowNum };
                const response = await postToApi(payload);
                
                hideLoader();
                alert(response.message);
                if (response.success) {
                    fetchAndRenderDashboard(); // Refresh data
                }
            }
        }
    </script>
</body>
</html>
