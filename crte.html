<!DOCTYPE html><html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>گواهی سوابق فعالیت</title>
  <!-- Excel, jsPDF, html2canvas Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* Variables & Fonts */
    @font-face {
      font-family: 'IranNastaliq';
      src: url('https://tashacol.github.io/ir/IranNastaliq.ttf') format('truetype');
    }
    :root {
      --bg-gradient: linear-gradient(135deg, #1e3c72, #2a5298);
      --card-bg: rgba(255,255,255,0.15);
      --card-border: rgba(255,255,255,0.3);
      --primary: #ffeb3b;
      --accent: #00b894;
      --text-light: #fafafa;
      --text-dark: #333;
    }
    /* Global & Background Animation */
    @keyframes bgAnim { 0% {background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;} }
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: 'IranNastaliq', serif;
      direction: rtl; text-align: center;
      background: var(--bg-gradient); background-size: 200% 200%; animation: bgAnim 20s ease infinite;
      min-height: 100vh; display: flex; align-items: center; justify-content: center;
      overflow-x: hidden;
    }
    /* Loader Overlay */
    .loading-overlay {
      position: fixed; top:0; left:0; width:100vw; height:100vh;
      background: rgba(0,0,0,0.6); backdrop-filter: blur(6px);
      display:flex; align-items:center; justify-content:center; z-index:9999;
    }
    .loading-overlay .loader {
      border: 8px solid rgba(255,255,255,0.3);
      border-top: 8px solid #fff; border-radius:50%; width:60px; height:60px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { from{transform:rotate(0deg);} to{transform:rotate(360deg);} }
    /* Container Card */
    .container {
      width: 90%; max-width: 600px;
      background: var(--card-bg); border:1px solid var(--card-border);
      border-radius: 20px; backdrop-filter: blur(10px);
      padding: 30px 20px; box-shadow:0 8px 32px rgba(0,0,0,0.4);
      color: var(--text-light);
      position: relative;
    }
    h2 {
      font-size:1.8rem; color:var(--primary);
      margin-bottom:20px; text-transform: uppercase; letter-spacing:1px;
    }
    /* Form & Input */
    #loginForm { display:flex; flex-direction: column; gap:15px; }
    input[type="tel"] {
      width:100%; padding:12px 15px;
      font-size:1rem; border:none; border-radius:8px;
      outline:none; background:rgba(255,255,255,0.8);
      color:var(--text-dark); transition: transform .2s;
    }
    input[type="tel"]:focus { transform: scale(1.02); }
    /* Button */
    button {
      padding:14px; font-size:1rem; font-weight:bold;
      background: var(--accent); color:#fff; border:none; border-radius:8px;
      cursor:pointer; text-transform: uppercase;
      transition: background .3s, transform .3s;
    }
    button:hover { background:#009977; transform: translateY(-2px) scale(1.02); }
    /* Messages */
    #errorMsg, #loadingMsg {
      font-size:0.9rem; margin:10px 0; display:none; color:#ff6b6b;
    }
    /* Certificate Card */
    #result { display:none; }
    #certificate {
      margin-top:30px; background:rgba(255,255,255,0.9);
      border-radius:12px; padding:20px; color:var(--text-dark);
      box-shadow:0 8px 20px rgba(0,0,0,0.15);
      text-align: right;
    }
    #certificate .header { display:flex; justify-content:space-between; flex-wrap: wrap; }
    #certificate .header div { flex:1; min-width:120px; }
    #certificate .header .center { text-align:center; }
    .separator { border:none; border-top:1px solid #333; margin:20px 0; }
    .title { font-size:1.2rem; font-weight:bold; margin-bottom:10px; }
    .centered-text { margin-bottom:5px; }
    table { width:100%; border-collapse: collapse; margin-top:15px; font-size:0.9rem; }
    th, td { border:1px solid #ddd; padding:8px; }
    thead th { background:var(--accent); color:#fff; }
    tbody tr:nth-child(even) { background:#f7f7f7; }
    tbody tr:hover { background:var(--primary); color:#000; }
    /* Download & creating loader */
    #downloadPdfBtn { display:none; margin-top:20px; }
    #creating { display:none; font-size:1rem; margin-top:10px; color:#54a0ff; }
    /* Responsive */
    @media(max-width:600px) {
      .container { padding:20px 15px; }
      h2 { font-size:1.5rem; }
      input, button { font-size:0.9rem; padding:12px; }
      th, td { padding:6px; font-size:0.8rem; }
    }
  </style>
</head>
<body>
  <div class="loading-overlay">
    <div class="loader"></div>
  </div>
  <div class="container">
    <h2>گواهی سوابق فعالیت</h2>
    <form id="loginForm">
      <input type="tel" id="nationalCode" placeholder="کد ملی را وارد کنید" pattern="\d{10}" maxlength="10" required />
      <button type="button" id="searchButton">ورود</button>
    </form>
    <div id="errorMsg">کد ملی یافت نشد یا نامعتبر است.</div>
    <div id="loadingMsg">در حال بارگذاری داده‌ها...</div>
    <div id="result">
      <div id="certificate">
        <div class="header">
          <div class="left">
            <p>شماره گواهی: <span id="certificateNumber"></span></p>
            <p>تاریخ: <span id="date"></span></p>
          </div>
          <div class="center">
            <p class="centered-text title">مؤسسه تعالی اندیشه و رشد</p>
            <p class="centered-text title">گواهی سوابق فعالیت</p>
          </div>
          <div class="right">
            <p>شناسه ملی: ۱۴۰۱۳۷۷۰۶۱۱</p>
            <p>تلفن: ۰۹۱۳۵۰۷۶۵۸۷</p>
          </div>
        </div>
        <hr class="separator" />
        <p>آقا/خانم <span id="fullName"></span> با کد ملی <span id="userId"></span> به مدت <span id="columnG"></span> در مؤسسه فعالیت داشته‌اند.</p>
        <table>
          <thead><tr><th>فعالیت</th><th>تاریخ شروع</th><th>تاریخ پایان</th></tr></thead>
          <tbody id="activityTable"></tbody>
        </table>
        <div class="signature">
          <p>مهر و امضای مدیر عامل</p>
        </div>
      </div>
      <button id="downloadPdfBtn">دانلود PDF</button>
      <div id="creating">در حال ایجاد گواهی، لطفا صبر کنید...</div>
    </div>
  </div>
  <script>
    let excelData = [];
    async function fetchExcelData() {
      document.getElementById('loadingMsg').style.display = 'block';
      const res = await fetch('https://docs.google.com/spreadsheets/d/19tVWLwHOMO1zqAId5mY7zYceF1uJUrS67Y_A-nuiT9w/export?format=xlsx');
      const buf = await res.arrayBuffer();
      const wb = XLSX.read(buf,{type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      excelData = XLSX.utils.sheet_to_json(ws,{header:1}).slice(1);
      document.querySelector('.loading-overlay').style.display = 'none';
      document.getElementById('loadingMsg').style.display = 'none';
    }
    fetchExcelData();
    function toPersianDigits(str){return str.replace(/\d/g,d=>'۰۱۲۳۴۵۶۷۸۹'[d]);}
    document.getElementById('searchButton').addEventListener('click',()=>{
      const code=document.getElementById('nationalCode').value.trim();
      if(!/^\d{10}$/.test(code)){return document.getElementById('errorMsg').style.display='block';}
      document.getElementById('errorMsg').style.display='none';
      const matches=excelData.filter(r=>r[2]==code);
      if(!matches.length){return document.getElementById('errorMsg').style.display='block';}
      const now=new Date();
      const time=now.getHours().toString().padStart(2,'0')+now.getMinutes().toString().padStart(2,'0');
      document.getElementById('certificateNumber').innerText=toPersianDigits(code+time);
      document.getElementById('date').innerText=toPersianDigits(now.toLocaleDateString('fa-IR'));
      document.getElementById('fullName').innerText=matches[0][1];
      document.getElementById('userId').innerText=toPersianDigits(code);
      const total=matches.reduce((s,r)=>s+Number(r[6]||0),0);
      const years=Math.floor(total/12), months=total%12;
      document.getElementById('columnG').innerText=toPersianDigits(years+' سال و '+months+' ماه');
      const tbody=document.getElementById('activityTable'); tbody.innerHTML='';
      matches.forEach(r=>{const tr=document.createElement('tr');const end=r[5]?r[5]:'تا اکنون';
        tr.innerHTML=`<td>${r[3]}</td><td>${toPersianDigits(r[4])}</td><td>${toPersianDigits(end)}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('loginForm').style.display='none';
      document.getElementById('result').style.display='block';
      document.getElementById('downloadPdfBtn').style.display='block';
    });
    document.getElementById('downloadPdfBtn').addEventListener('click',()=>{
      document.getElementById('creating').style.display='block';
      const { jsPDF }=window.jspdf;
      html2canvas(document.getElementById('certificate'),{scale:3,useCORS:true})
        .then(canvas=>{
          const img=canvas.toDataURL('image/png');
          const pdf=new jsPDF('portrait','pt','a5');
          const w=420,h=canvas.height*(420/canvas.width);
          pdf.addImage(img,'PNG',0,0,w,h);
          let left=h-595;
          while(left>0){pdf.addPage();pdf.addImage(img,'PNG',0,-left,w,h);left-=595;}
          pdf.save('سوابق.pdf');
          document.getElementById('creating').style.display='none';
        });
    });
  </script>
</body>
</html>
