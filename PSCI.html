// ==========================================================
// File: Code.gs (نسخه نهایی و اصلاح شده طبق دستورات جدید)
// ==========================================================

const AUTH_SHEET_ID = '1EMbhRCghY7x406DpfbwGHhc-gPrAMVdHZRrfkDgWj-k';
const ARTICLES_SHEET_ID = '1F_A8CWPFQjQEYF3ybVvk-ShjCn-aZGvGY2SDn8t4hhA';
const LOGS_SHEET_ID = '1NjmQPVoPZL4DpOiBQPba-ewVAYTpBh1aD-6Y8QAR6LI';
const TEMPLATE_ARTICLE_ID = '1fmNH2mC1yyznDtNm9eblq9Vlai1R5CUMvY0NPAsCvgU';

const AUTH_SHEET_NAME = 'Sheet1';
const ARTICLES_SHEET_NAME = 'Sheet1';
const LOGS_SHEET_NAME = 'Sheet1';

const authSheet = SpreadsheetApp.openById(AUTH_SHEET_ID).getSheetByName(AUTH_SHEET_NAME);
const articlesSheet = SpreadsheetApp.openById(ARTICLES_SHEET_ID).getSheetByName(ARTICLES_SHEET_NAME);
const logsSheet = SpreadsheetApp.openById(LOGS_SHEET_ID).getSheetByName(LOGS_SHEET_NAME);

// <<<< ویرایش: تطبیق ستون‌ها با فایل "شاهین" و دستورات >>>>
const AUTH_COLS = {
    NAME: 0,              // A
    NID: 1,               // B
    PASS: 2,              // C
    SCORE: 3,             // D: تعداد مقالات تائید شده (امتیاز کاربر)
    SUPERVISOR_NAME: 4,   // E
    SUPERVISOR_NID: 5,    // F
    SUPERVISOR_PASS: 6,   // G
    SUPERVISOR_REVIEWS: 7,// H: تعداد داوری‌های موفق
    SUPERVISOR_LAST_LOGIN: 8, // I
    SUPERVISOR_STATUS: 9, // J: وضعیت فعال بودن (5 فعال، 0 غیرفعال)
    SUPERVISOR_ABOUT: 10, // K: توضیحات درباره استاد
    SUPERVISOR_CAPACITY: 11, // L
    SUPERVISOR_CONTACT: 12,  // M: اطلاعات تماس
    SUGGESTED_TITLE: 13,     // N
    SUGGESTED_TITLE_STATUS: 14, // O
    SUGGESTED_TITLE_ART_ID: 15, // P
    SUGGESTED_TITLE_PROP_ID: 16 // Q
};

const ARTICLES_COLS = {
    REQUEST_DATE: 0, RESEARCHER_NAME: 1, RESEARCHER_ID: 2, AFFILIATION: 3, SUPERVISOR_NAME: 4, SUPERVISOR_ID: 5,
    SUPERVISOR_STATUS: 6, ARTICLE_ID: 7, ARTICLE_STATUS: 8, REJECTION_REASON: 9, ACCEPTANCE_DATE: 10,
    ISSUE_NUMBER: 11, KNOWLEDGE_AREA: 12, TITLE: 13, TOPIC_REASON: 14, KEYWORDS: 15, ABSTRACT: 16,
    INTRODUCTION: 17, BODY: 18, CONCLUSION: 19, REFERENCES: 20, PUBLISH_DATE: 21
};

function _logAction(researcherId, researcherName, articleId, action, details) {
    try {
        const timestamp = new Date();
        logsSheet.insertRowBefore(2);
        logsSheet.getRange("B2:D2").setNumberFormat("@");
        logsSheet.getRange("A2:F2").setValues([[timestamp, researcherId, researcherName, articleId, action, details]]);
    } catch (e) {
        Logger.log(`Failed to write to logs sheet: ${e.toString()}`);
    }
}

function _findArticleRow(articleId) {
    if (!articleId) return -1;
    const textFinder = articlesSheet.getRange("H:H").createTextFinder(String(articleId)).matchEntireCell(true);
    const foundCell = textFinder.findNext();
    return foundCell ? foundCell.getRow() : -1;
}

// <<<< ویرایش: افزودن اطلاعات تکمیلی استاد به آبجکت مقاله (دستور 5) >>>>
function _mapArticleRowToObject(row) {
    const authData = authSheet.getRange("E2:M" + authSheet.getLastRow()).getValues(); // خواندن ستون‌های مربوط به اساتید
    
    // ایجاد مپ برای اطلاعات کامل استاد
    const supervisorDetailsMap = authData.reduce((map, r) => {
        const nid = String(r[1]).trim(); // Col F -> Index 1 in slice
        if (nid) {
            map[nid] = {
                contact: r[8],  // Col M -> Index 8 in slice E:M
                reviews: r[3],  // Col H -> Index 3 in slice E:M
                about: r[6]     // Col K -> Index 6 in slice E:M
            };
        }
        return map;
    }, {});

    const supId = String(row[ARTICLES_COLS.SUPERVISOR_ID]).trim();
    const supInfo = supervisorDetailsMap[supId] || {};

    return {
        supervisorStatus: row[ARTICLES_COLS.SUPERVISOR_STATUS],
        articleId: row[ARTICLES_COLS.ARTICLE_ID],
        articleStatus: row[ARTICLES_COLS.ARTICLE_STATUS],
        title: row[ARTICLES_COLS.TITLE],
        affiliation: row[ARTICLES_COLS.AFFILIATION],
        supervisorName: row[ARTICLES_COLS.SUPERVISOR_NAME],
        supervisorId: row[ARTICLES_COLS.SUPERVISOR_ID],
        // اطلاعات اضافی برای پاپ‌آپ استاد
        supervisorContact: supInfo.contact || '',
        supervisorReviews: supInfo.reviews || 0,
        supervisorAbout: supInfo.about || '',
        
        knowledgeArea: row[ARTICLES_COLS.KNOWLEDGE_AREA],
        topicReason: row[ARTICLES_COLS.TOPIC_REASON],
        keywords: row[ARTICLES_COLS.KEYWORDS],
        abstract: row[ARTICLES_COLS.ABSTRACT],
        introduction: row[ARTICLES_COLS.INTRODUCTION],
        body: row[ARTICLES_COLS.BODY],
        conclusion: row[ARTICLES_COLS.CONCLUSION],
        references: row[ARTICLES_COLS.REFERENCES],
        requestDate: row[ARTICLES_COLS.REQUEST_DATE],
        acceptanceDate: row[ARTICLES_COLS.ACCEPTANCE_DATE],
        issueNumber: row[ARTICLES_COLS.ISSUE_NUMBER],
        rejectionReason: row[ARTICLES_COLS.REJECTION_REASON],
        publishDate: row[ARTICLES_COLS.PUBLISH_DATE],
        researcherName: row[ARTICLES_COLS.RESEARCHER_NAME]
    };
}

function doPost(e) {
    try {
        const request = JSON.parse(e.postData.contents);
        const params = request.params || {};
        let response;
        switch (request.action) {
            case 'login': response = handleLogin(params.nationalId, params.password); break;
            // <<<< دستور دوم: تغییر رمز عبور >>>>
            case 'changePassword': response = changePassword(params.nationalId, params.oldPassword, params.newPassword); break;
            case 'getArticles': response = getArticlesForUser(params.nationalId, params.searchTerm, params.page); break;
            case 'getSingleArticle': response = getSingleArticle(params.nationalId, params.articleId); break;
            case 'getSupervisors': response = getSupervisorsList(params.searchTerm, params.page); break;
            case 'submitNewArticle': response = submitNewArticle(params.data, params.isDraft); break;
            case 'submitDraftToSupervisor': response = submitDraftToSupervisor(params.articleId, params.nationalId); break;
            case 'updateArticleSection': response = updateArticleSection(params.nationalId, params.articleId, params.section, params.content); break;
            case 'updateArticleDetails': response = updateArticleDetails(params.nationalId, params.articleId, params.details); break;
            case 'deleteArticle': response = deleteArticle(params.nationalId, params.articleId); break;
            case 'submitRevisions': response = submitRevisions(params.articleId, params.nationalId, params.revisionNotes); break;
            case 'submitFinalRevisions': response = submitFinalRevisions(params.articleId, params.nationalId, params.revisionNotes); break;
            case 'sendForFinalReview': response = sendForFinalReview(params.articleId, params.nationalId); break;
            case 'getArticleHistory': response = getArticleHistory(params.nationalId, params.articleId); break;
            case 'getSuggestedTitles': response = getSuggestedTitles(); break;
            case 'generateArticlePdf': response = generateArticlePdf(params.nationalId, params.articleId); break;
            default: response = { status: 'error', message: 'Action not recognized' };
        }
        return ContentService.createTextOutput(JSON.stringify(response)).setMimeType(ContentService.MimeType.JSON);
    } catch (error) {
        Logger.log("Server Error: " + error.message + " Stack: " + error.stack);
        _logAction('N/A', 'N/A', 'N/A', 'SERVER_ERROR', error.message);
        return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: "خطای داخلی سرور: " + error.message }))
            .setMimeType(ContentService.MimeType.JSON);
    }
}

// <<<< دستور دوم: تابع تغییر رمز عبور >>>>
function changePassword(nationalId, oldPassword, newPassword) {
    if (!nationalId || !oldPassword || !newPassword) {
        return { status: 'error', message: 'تمام فیلدها الزامی هستند.' };
    }
    
    // جستجوی کاربر با استفاده از کدملی در ستون B (ایندکس 1)
    const finder = authSheet.getRange(2, AUTH_COLS.NID + 1, authSheet.getLastRow() - 1, 1).createTextFinder(nationalId).matchEntireCell(true);
    const cell = finder.findNext();
    
    if (!cell) {
        return { status: 'error', message: 'کاربر یافت نشد.' };
    }
    
    const rowIndex = cell.getRow();
    const currentPass = authSheet.getRange(rowIndex, AUTH_COLS.PASS + 1).getValue().toString().trim();
    
    if (currentPass !== oldPassword.toString().trim()) {
        return { status: 'error', message: 'رمز عبور فعلی اشتباه است.' };
    }
    
    // ذخیره رمز جدید در ستون C
    authSheet.getRange(rowIndex, AUTH_COLS.PASS + 1).setValue(newPassword.trim());
    _logAction(nationalId, 'N/A', 'N/A', 'PASSWORD_CHANGE', 'رمز عبور با موفقیت تغییر کرد.');
    
    return { status: 'success', message: 'رمز عبور با موفقیت تغییر کرد.' };
}

function generateArticlePdf(nationalId, articleId) {
    let tempDocFile;
    try {
        if (!nationalId || !articleId) { return { status: 'error', message: 'اطلاعات ناقص است.' }; }
        const rowNumber = _findArticleRow(articleId);
        if (rowNumber === -1) { return { status: 'error', message: 'مقاله یافت نشد.' }; }

        const articleRowData = articlesSheet.getRange(rowNumber, 1, 1, articlesSheet.getLastColumn()).getValues()[0];
        const ownerId = articleRowData[ARTICLES_COLS.RESEARCHER_ID];

        if (String(ownerId).trim() !== String(nationalId).trim()) {
            _logAction(nationalId, 'N/A', articleId, 'PDF_DOWNLOAD_FAIL', 'Authorization Error');
            return { status: 'error', message: 'شما اجازه دسترسی به این مقاله را ندارید.' };
        }

        const articleData = _mapArticleRowToObject(articleRowData);
        const formatDateForDoc = (dateString) => {
            if (!dateString) return 'نامشخص';
            try { return new Date(dateString).toLocaleDateString('fa-IR', { year: 'numeric', month: 'long', day: 'numeric' }); }
            catch (e) { return dateString.toString(); }
        };

        const templateFile = DriveApp.getFileById(TEMPLATE_ARTICLE_ID);
        tempDocFile = templateFile.makeCopy(`مقاله موقت - ${articleId}`);
        const tempDoc = DocumentApp.openById(tempDocFile.getId());
        const body = tempDoc.getBody();

        body.replaceText('{{JOURNAL_NAME}}', "سالنامه علمی تبیان");
        body.replaceText('{{ISSUE_NUMBER}}', articleData.issueNumber || 'نامشخص');
        body.replaceText('{{TITLE}}', articleData.title || '');
        body.replaceText('{{RESEARCHER_NAME}}', articleData.researcherName || '');
        body.replaceText('{{RESEARCHER_AFFILIATION}}', articleData.affiliation || '');
        body.replaceText('{{SUPERVISOR_NAME}}', articleData.supervisorName || '');
        body.replaceText('{{ACCEPTANCE_DATE}}', formatDateForDoc(articleData.acceptanceDate));
        body.replaceText('{{PUBLISH_DATE}}', formatDateForDoc(articleData.publishDate));
        body.replaceText('{{ABSTRACT}}', articleData.abstract || 'موجود نیست');
        body.replaceText('{{KEYWORDS}}', articleData.keywords || 'موجود نیست');
        body.replaceText('{{INTRODUCTION}}', articleData.introduction || 'موجود نیست');
        body.replaceText('{{BODY}}', articleData.body || 'موجود نیست');
        body.replaceText('{{CONCLUSION}}', articleData.conclusion || 'موجود نیست');
        body.replaceText('{{REFERENCES}}', articleData.references || 'موجود نیست');

        tempDoc.saveAndClose();
        const pdfBlob = tempDocFile.getAs('application/pdf');
        const pdfBase64 = Utilities.base64Encode(pdfBlob.getBytes());
        const filename = `مقاله - ${articleData.title}.pdf`;

        return { status: 'success', data: { filename: filename, mimeType: 'application/pdf', content: pdfBase64 } };
    } catch (error) {
        Logger.log("generateArticlePdf Error: " + error.toString());
        return { status: 'error', message: 'خطا در هنگام ساخت PDF: ' + error.toString() };
    } finally {
        if (tempDocFile) { try { DriveApp.getFileById(tempDocFile.getId()).setTrashed(true); } catch (e) { Logger.log("Failed to delete temp file: " + e.toString()); } }
    }
}

function getSingleArticle(nationalId, articleId) {
    if (!nationalId || !articleId) { return { status: 'error', message: 'اطلاعات ناقص است.' }; }
    const rowNumber = _findArticleRow(articleId);
    if (rowNumber === -1) { return { status: 'error', message: 'مقاله یافت نشد.' }; }
    const articleRowData = articlesSheet.getRange(rowNumber, 1, 1, articlesSheet.getLastColumn()).getValues()[0];
    const ownerId = articleRowData[ARTICLES_COLS.RESEARCHER_ID];

    if (String(ownerId).trim() !== String(nationalId).trim()) {
        _logAction(nationalId, 'N/A', articleId, 'GET_SINGLE_ARTICLE_FAIL', 'Authorization Error');
        return { status: 'error', message: 'شما اجازه دسترسی به این مقاله را ندارید.' };
    }

    const articleObject = _mapArticleRowToObject(articleRowData);
    return { status: 'success', article: articleObject };
}

// <<<< دستور چهارم الف: نمایش نام پیشنهاد دهنده (استاد) >>>>
function getSuggestedTitles() {
    try {
        const lastRow = authSheet.getLastRow();
        if (lastRow < 2) { return { status: 'success', titles: [] }; }
        // خواندن کل داده‌ها برای پردازش
        const allData = authSheet.getRange(2, 1, lastRow - 1, authSheet.getLastColumn()).getValues();
        
        const availableTitles = allData.map(row => {
            const title = row[AUTH_COLS.SUGGESTED_TITLE];
            const status = row[AUTH_COLS.SUGGESTED_TITLE_STATUS];
            // طبق دستور: نام استاد پیشنهاد دهنده در ستون E (ایندکس AUTH_COLS.SUPERVISOR_NAME) از همان ردیف است
            const proposerName = row[AUTH_COLS.SUPERVISOR_NAME]; 

            if (title && String(status).trim() !== '5') {
                return {
                    title: title,
                    proposerName: proposerName || 'نامشخص'
                };
            }
            return null;
        }).filter(Boolean);
        return { status: 'success', titles: availableTitles };
    } catch (error) {
        Logger.log("Error in getSuggestedTitles: " + error.toString());
        return { status: 'error', message: 'خطا در دریافت عناوین پیشنهادی.' };
    }
}

// <<<< دستور چهارم ب و ششم: لیست اساتید با جزئیات بیشتر و وضعیت فعال بودن از ستون J >>>>
function getSupervisorsList(searchTerm = '', page = 1) {
    try {
        const PAGE_SIZE = 7;
        // محاسبه ظرفیت پر شده
        const articlesData = articlesSheet.getRange("F2:G" + articlesSheet.getLastRow()).getValues();
        const activeArticleStatuses = new Set(['1', '6', '8']);
        const supervisorLoad = articlesData.reduce((acc, row) => {
            const supervisorId = row[0];
            const supervisorStatus = String(row[1]);
            if (supervisorId && activeArticleStatuses.has(supervisorStatus)) {
                acc[supervisorId] = (acc[supervisorId] || 0) + 1;
            }
            return acc;
        }, {});

        const authLastRow = authSheet.getLastRow();
        if (authLastRow < 2) return { status: 'success', supervisors: [], hasMore: false };
        const supervisorsData = authSheet.getRange(2, 1, authLastRow - 1, authSheet.getLastColumn()).getValues();
        const allSupervisors = [];
        const seenNids = new Set();
        
        for (const row of supervisorsData) {
            const name = String(row[AUTH_COLS.SUPERVISOR_NAME] || '').trim();
            const nid = String(row[AUTH_COLS.SUPERVISOR_NID] || '').trim();
            
            if (name && nid && !seenNids.has(nid)) {
                // طبق دستور ششم: وضعیت فعال بودن در ستون J (ایندکس AUTH_COLS.SUPERVISOR_STATUS)
                const statusVal = String(row[AUTH_COLS.SUPERVISOR_STATUS]).trim();
                const isActive = statusVal === '5'; 
                
                const capacity = parseInt(row[AUTH_COLS.SUPERVISOR_CAPACITY]) || 0;
                const currentLoad = supervisorLoad[nid] || 0;
                
                // طبق دستور چهارم: ارسال تعداد داوری‌های موفق (ستون H) و متن درباره استاد (ستون K)
                allSupervisors.push({
                    name: name, 
                    nationalId: nid, 
                    isActive: isActive,
                    description: String(row[AUTH_COLS.SUPERVISOR_ABOUT] || '').trim(), // ستون K
                    successfulReviews: row[AUTH_COLS.SUPERVISOR_REVIEWS] || 0,       // ستون H
                    contact: String(row[AUTH_COLS.SUPERVISOR_CONTACT] || '').trim(),  // ستون M
                    isFull: currentLoad >= capacity
                });
                seenNids.add(nid);
            }
        }
        
        let filteredSupervisors = allSupervisors;
        if (searchTerm) {
            const lowerCaseSearch = searchTerm.toLowerCase().trim();
            filteredSupervisors = allSupervisors.filter(s =>
                s.name.toLowerCase().includes(lowerCaseSearch) || s.nationalId.includes(lowerCaseSearch)
            );
        }
        
        const startIndex = (page - 1) * PAGE_SIZE;
        const paginatedSupervisors = filteredSupervisors.slice(startIndex, startIndex + PAGE_SIZE);
        const hasMore = (startIndex + PAGE_SIZE) < filteredSupervisors.length;
        return { status: 'success', supervisors: paginatedSupervisors, hasMore: hasMore };
    } catch (error) {
        Logger.log("Error in getSupervisorsList: " + error.toString());
        return { status: 'error', message: 'خطا در دریافت لیست اساتید.' };
    }
}

function getArticlesForUser(nationalId, searchTerm = '', page = 1) {
    try {
        const PAGE_SIZE = 5;
        const allArticlesData = articlesSheet.getDataRange().getValues().slice(1);
        let userArticlesRows = allArticlesData.filter(row => row[ARTICLES_COLS.RESEARCHER_ID] && row[ARTICLES_COLS.RESEARCHER_ID].toString().trim() === nationalId.trim());

        if (searchTerm) {
            const lowerCaseSearch = searchTerm.toLowerCase().trim();
            userArticlesRows = userArticlesRows.filter(row => {
                const title = (row[ARTICLES_COLS.TITLE] || '').toLowerCase();
                const supervisor = (row[ARTICLES_COLS.SUPERVISOR_NAME] || '').toLowerCase();
                const keywords = (row[ARTICLES_COLS.KEYWORDS] || '').toLowerCase();
                return title.includes(lowerCaseSearch) || supervisor.includes(lowerCaseSearch) || keywords.includes(lowerCaseSearch);
            });
        }
        
        userArticlesRows.sort((a, b) => (b[ARTICLES_COLS.ARTICLE_ID] || 0) - (a[ARTICLES_COLS.ARTICLE_ID] || 0));

        const startIndex = (page - 1) * PAGE_SIZE;
        const paginatedRows = userArticlesRows.slice(startIndex, startIndex + PAGE_SIZE);
        const hasMore = (startIndex + PAGE_SIZE) < userArticlesRows.length;

        const articles = paginatedRows.map(row => _mapArticleRowToObject(row));

        let score = 0;
        try {
            // <<<< دستور اول: امتیاز کاربر در ستون D (ایندکس 3) >>>>
            const textFinder = authSheet.getRange("B:B").createTextFinder(String(nationalId)).matchEntireCell(true);
            const foundCell = textFinder.findNext();
            if (foundCell) { 
                // ستون B ایندکس 2 است، ستون D ایندکس 4 می‌شود نسبت به کل شیت
                // اما اینجا از ایندکس ثابت AUTH_COLS استفاده می‌کنیم
                score = authSheet.getRange(foundCell.getRow(), AUTH_COLS.SCORE + 1).getValue() || 0; 
            }
        } catch (e) { Logger.log("Could not retrieve score for user " + nationalId + ": " + e.toString()); }

        return { status: 'success', articles: articles, hasMore: hasMore, score: score };
    } catch (error) {
        Logger.log("Error in getArticlesForUser: " + error.toString());
        return { status: 'error', message: 'خطا در بارگذاری مقالات.' };
    }
}

function submitNewArticle(data, isDraft = false) {
    try {
        if (!data.title) return { status: 'error', message: 'عنوان مقاله الزامی است.' };
        if (!isDraft && !data.supervisor) return { status: 'error', message: 'انتخاب استاد راهنما برای ارسال نهایی الزامی است.' };
        
        const articleIdColumn = ARTICLES_COLS.ARTICLE_ID + 1;
        const lastRow = articlesSheet.getLastRow();
        let maxId = 100000;
        if (lastRow > 1) {
            const allIds = articlesSheet.getRange(2, articleIdColumn, lastRow - 1, 1).getValues()
                .flat().map(id => parseInt(id)).filter(id => !isNaN(id));
            if (allIds.length > 0) { maxId = Math.max(...allIds); }
        }
        const newArticleId = maxId + 1;
        const today = new Date();

        const newRow = Array(Object.keys(ARTICLES_COLS).length + 1).fill('');
        newRow[ARTICLES_COLS.REQUEST_DATE] = today;
        newRow[ARTICLES_COLS.RESEARCHER_NAME] = data.researcherName;
        newRow[ARTICLES_COLS.RESEARCHER_ID] = data.researcherId;
        newRow[ARTICLES_COLS.AFFILIATION] = data.affiliation;
        newRow[ARTICLES_COLS.SUPERVISOR_NAME] = data.supervisor ? data.supervisor.name : '';
        newRow[ARTICLES_COLS.SUPERVISOR_ID] = data.supervisor ? data.supervisor.nationalId : '';
        newRow[ARTICLES_COLS.SUPERVISOR_STATUS] = isDraft ? 9 : 1; 
        newRow[ARTICLES_COLS.ARTICLE_ID] = newArticleId;
        newRow[ARTICLES_COLS.ARTICLE_STATUS] = isDraft ? 9 : 1; 
        newRow[ARTICLES_COLS.KNOWLEDGE_AREA] = data.knowledgeArea;
        newRow[ARTICLES_COLS.TITLE] = data.title;
        newRow[ARTICLES_COLS.TOPIC_REASON] = data.topicReason;

        articlesSheet.getRange(articlesSheet.getLastRow() + 1, 1, 1, newRow.length).setNumberFormat("@").setValues([newRow]);
        
        try {
            const titleFinder = authSheet.getRange("N:N").createTextFinder(data.title).matchEntireCell(true);
            const foundTitleCell = titleFinder.findNext();
            if (foundTitleCell) {
                const row = foundTitleCell.getRow();
                authSheet.getRange(row, 15).setValue(5); 
                authSheet.getRange(row, 16).setValue(newArticleId); 
                _logAction(data.researcherId, data.researcherName, newArticleId, 'SUGGESTED_TITLE_TAKEN', `Title: ${data.title}`);
            }
        } catch (e) { Logger.log("Could not update suggested title status: " + e.toString()); }

        const logAction = isDraft ? 'SAVE_DRAFT_SUCCESS' : 'SUBMIT_ARTICLE_SUCCESS';
        const message = isDraft ? 'مقاله با موفقیت به عنوان پیش‌نویس ذخیره شد.' : 'مقاله با موفقیت برای استاد راهنما ارسال شد.';
        _logAction(data.researcherId, data.researcherName, newArticleId, logAction, `عنوان: ${data.title}`);
        return { status: 'success', message: message };
    } catch (error) {
        _logAction(data.researcherId || 'N/A', data.researcherName || 'N/A', 'N/A', 'SUBMIT_ARTICLE_ERROR', error.toString());
        Logger.log("Error in submitNewArticle: " + error.toString());
        return { status: 'error', message: 'خطا در ثبت مقاله: ' + error.toString() };
    }
}

function submitDraftToSupervisor(articleId, nationalId) {
    if (!articleId || !nationalId) return { status: 'error', message: 'اطلاعات ناقص است.' };
    const rowNumber = _findArticleRow(articleId);
    if (rowNumber === -1) return { status: 'error', message: 'مقاله یافت نشد.' };
    const articleData = articlesSheet.getRange(rowNumber, 1, 1, articlesSheet.getLastColumn()).getValues()[0];
    const ownerId = articleData[ARTICLES_COLS.RESEARCHER_ID];
    const currentStatus = articleData[ARTICLES_COLS.ARTICLE_STATUS];
    const supervisorId = articleData[ARTICLES_COLS.SUPERVISOR_ID];
    const researcherName = articleData[ARTICLES_COLS.RESEARCHER_NAME];
    if (ownerId.toString().trim() !== nationalId.trim()) {
        _logAction(nationalId, 'N/A', articleId, 'SUBMIT_DRAFT_FAIL', 'Authorization Error');
        return { status: 'error', message: 'شما اجازه دسترسی به این مقاله را ندارید.' };
    }
    if (String(currentStatus) !== '9') {
        _logAction(nationalId, researcherName, articleId, 'SUBMIT_DRAFT_FAIL', `Invalid Status: ${currentStatus}`);
        return { status: 'error', message: 'این مقاله یک پیش‌نویس نیست.' };
    }
    if (!supervisorId) {
        _logAction(nationalId, researcherName, articleId, 'SUBMIT_DRAFT_FAIL', 'No supervisor selected');
        return { status: 'error', message: 'لطفا ابتدا یک استاد راهنما برای مقاله انتخاب کنید.' };
    }
    try {
        articlesSheet.getRange(rowNumber, ARTICLES_COLS.ARTICLE_STATUS + 1).setValue(1);
        articlesSheet.getRange(rowNumber, ARTICLES_COLS.SUPERVISOR_STATUS + 1).setValue(1);
        _logAction(nationalId, researcherName, articleId, 'SUBMIT_DRAFT_SUCCESS', 'پیش‌نویس برای استاد راهنما ارسال شد.');
        return { status: 'success', message: 'مقاله با موفقیت برای استاد راهنما ارسال شد.' };
    } catch (error) {
        _logAction(nationalId, researcherName, articleId, 'SUBMIT_DRAFT_ERROR', error.toString());
        return { status: 'error', message: 'خطا در ارسال مقاله: ' + error.toString() };
    }
}

function handleLogin(nationalId, password) {
    if (!nationalId || !password) return { status: 'error', message: 'کدملی و رمز عبور الزامی است.' };
    const data = authSheet.getRange(2, 1, authSheet.getLastRow(), 4).getValues();
    for (let i = 0; i < data.length; i++) {
        if (data[i][AUTH_COLS.NID] && data[i][AUTH_COLS.PASS] && data[i][AUTH_COLS.NID].toString().trim() === nationalId.trim() && data[i][AUTH_COLS.PASS].toString().trim() === password.trim()) {
            const score = data[i][AUTH_COLS.SCORE] || 0;
            _logAction(nationalId, data[i][AUTH_COLS.NAME], 'N/A', 'LOGIN_SUCCESS', 'ورود موفق به سیستم');
            return { status: 'success', user: { name: data[i][AUTH_COLS.NAME], nationalId: data[i][AUTH_COLS.NID].toString().trim(), score: score } };
        }
    }
    _logAction(nationalId, 'N/A', 'N/A', 'LOGIN_FAIL', 'کدملی یا رمز عبور اشتباه است.');
    return { status: 'error', message: 'کدملی یا رمز عبور اشتباه است.' };
}

function getArticleHistory(nationalId, articleId) {
    if (!nationalId || !articleId) { return { status: 'error', message: 'اطلاعات ناقص است.' }; }
    const rowNumber = _findArticleRow(articleId);
    if (rowNumber !== -1) {
        const ownerId = articlesSheet.getRange(rowNumber, ARTICLES_COLS.RESEARCHER_ID + 1).getValue();
        if (ownerId.toString().trim() !== nationalId.trim()) {
            _logAction(nationalId, 'N/A', articleId, 'VIEW_HISTORY_FAIL', 'Authorization Error');
            return { status: 'error', message: 'شما اجازه مشاهده تاریخچه این مقاله را ندارید.' };
        }
    }
    try {
        const logData = logsSheet.getDataRange().getValues();
        const history = [];
        for (let i = 1; i < logData.length; i++) {
            if (String(logData[i][3]).trim() === String(articleId).trim()) {
                history.push({ timestamp: logData[i][0], action: logData[i][4], details: logData[i][5] });
            }
        }
        return { status: 'success', history: history };
    } catch (error) {
        _logAction(nationalId, 'Current User', articleId, 'VIEW_HISTORY_ERROR', error.toString());
        return { status: 'error', message: 'خطا در خواندن تاریخچه وقایع.' };
    }
}

function submitFinalRevisions(articleId, nationalId, revisionNotes) {
    if (!articleId || !nationalId || !revisionNotes) { return { status: 'error', message: 'اطلاعات لازم ارسال نشده است.' }; }
    
    const rowNumber = _findArticleRow(articleId);
    if (rowNumber === -1) { return { status: 'error', message: 'مقاله یافت نشد.' }; }
    
    const articleInfo = articlesSheet.getRange(rowNumber, 1, 1, articlesSheet.getLastColumn()).getValues()[0];
    const researcherName = articleInfo[ARTICLES_COLS.RESEARCHER_NAME];
    const ownerId = articleInfo[ARTICLES_COLS.RESEARCHER_ID];
    const currentStatus = articleInfo[ARTICLES_COLS.ARTICLE_STATUS];
    const originalReason = articleInfo[ARTICLES_COLS.REJECTION_REASON];

    if (ownerId.toString().trim() !== nationalId.trim()) {
        _logAction(nationalId, 'N/A', articleId, 'SUBMIT_FINAL_REVISIONS_FAIL', 'Authorization Error');
        return { status: 'error', message: 'شما اجازه دسترسی به این مقاله را ندارید.' };
    }

    if (String(currentStatus) != '10') {
        _logAction(nationalId, researcherName, articleId, 'SUBMIT_FINAL_REVISIONS_FAIL', `Invalid Status: ${currentStatus}`);
        return { status: 'error', message: 'این مقاله در وضعیت "نیازمند ویرایش نهایی" قرار ندارد.' };
    }

    try {
        const combinedNotes = `توضیحات رد از طرف نشریه: ${originalReason}\nویرایش های جدید محقق: ${revisionNotes}`;
        articlesSheet.getRange(rowNumber, ARTICLES_COLS.ARTICLE_STATUS + 1).setValue(12); 
        articlesSheet.getRange(rowNumber, ARTICLES_COLS.REJECTION_REASON + 1).setValue(combinedNotes); 
        _logAction(nationalId, researcherName, articleId, 'SUBMIT_FINAL_REVISIONS_SUCCESS', 'ویرایشات نهایی برای بررسی مجدد ارسال شد.');
        return { status: 'success', message: 'ویرایشات نهایی شما با موفقیت برای بررسی مجدد ارسال شد.' };
    } catch (error) {
        _logAction(nationalId, researcherName, articleId, 'SUBMIT_FINAL_REVISIONS_ERROR', error.toString());
        return { status: 'error', message: 'خطا در ارسال ویرایشات نهایی: ' + error.toString() };
    }
}

function submitRevisions(articleId, nationalId, revisionNotes) {
    if (!articleId || !nationalId || !revisionNotes) { return { status: 'error', message: 'اطلاعات لازم ارسال نشده است.' }; }
    const rowNumber = _findArticleRow(articleId);
    if (rowNumber === -1) { return { status: 'error', message: 'مقاله یافت نشد.' }; }
    
    const articleInfo = articlesSheet.getRange(rowNumber, 1, 1, articlesSheet.getLastColumn()).getValues()[0];
    const researcherName = articleInfo[ARTICLES_COLS.RESEARCHER_NAME];
    const ownerId = articleInfo[ARTICLES_COLS.RESEARCHER_ID];
    const currentStatus = articleInfo[ARTICLES_COLS.ARTICLE_STATUS];
    const originalReason = articleInfo[ARTICLES_COLS.REJECTION_REASON];

    if (ownerId.toString().trim() !== nationalId.trim()) {
        _logAction(nationalId, 'N/A', articleId, 'SUBMIT_REVISIONS_FAIL', 'Authorization Error');
        return { status: 'error', message: 'شما اجازه دسترسی به این مقاله را ندارید.' };
    }
    if (String(currentStatus) != '2') {
        _logAction(nationalId, researcherName, articleId, 'SUBMIT_REVISIONS_FAIL', `Invalid Status: ${currentStatus}`);
        return { status: 'error', message: 'این مقاله در وضعیت "نیازمند ویرایش" قرار ندارد.' };
    }
    try {
        const combinedNotes = `درخواست استاد: ${originalReason.split('توضیحات محقق:')[0].replace('درخواست استاد:', '').trim()}\nتوضیحات محقق: ${revisionNotes}`;
        articlesSheet.getRange(rowNumber, ARTICLES_COLS.ARTICLE_STATUS + 1).setValue(12); 
        articlesSheet.getRange(rowNumber, ARTICLES_COLS.REJECTION_REASON + 1).setValue(combinedNotes); 
        _logAction(nationalId, researcherName, articleId, 'SUBMIT_REVISIONS_SUCCESS', 'ویرایشات برای بررسی مجدد ارسال شد.');
        return { status: 'success', message: 'ویرایشات شما با موفقیت برای بررسی مجدد ارسال شد.' };
    } catch (error) {
        _logAction(nationalId, researcherName, articleId, 'SUBMIT_REVISIONS_ERROR', error.toString());
        return { status: 'error', message: 'خطا در ارسال ویرایشات: ' + error.toString() };
    }
}

function deleteArticle(nationalId, articleId) {
    if (!nationalId || !articleId) return { status: 'error', message: 'اطلاعات لازم برای حذف ارسال نشده است.' };
    const rowNumber = _findArticleRow(articleId);
    if (rowNumber === -1) {
        _logAction(nationalId, 'N/A', articleId, 'DELETE_ARTICLE_FAIL', 'مقاله برای حذف یافت نشد.');
        return { status: 'error', message: 'مقاله مورد نظر یافت نشد.' };
    }
    const articleRowData = articlesSheet.getRange(rowNumber, 1, 1, articlesSheet.getLastColumn()).getValues()[0];
    const researcherName = articleRowData[ARTICLES_COLS.RESEARCHER_NAME];
    const ownerId = articleRowData[ARTICLES_COLS.RESEARCHER_ID];
    const supervisorStatus = articleRowData[ARTICLES_COLS.SUPERVISOR_STATUS];
    const articleTitle = articleRowData[ARTICLES_COLS.TITLE];
    const articleStatus = articleRowData[ARTICLES_COLS.ARTICLE_STATUS];
    if (ownerId.toString().trim() !== nationalId.trim()) {
        _logAction(nationalId, 'N/A', articleId, 'DELETE_ARTICLE_FAIL', 'Authorization Error');
        return { status: 'error', message: 'شما اجازه حذف این مقاله را ندارید.' };
    }
    if (supervisorStatus == 5 && articleStatus != 9) {
        _logAction(nationalId, researcherName, articleId, 'DELETE_ARTICLE_FAIL', 'استاد راهنما قبلاً مقاله را تایید کرده است.');
        return { status: 'error', message: 'امکان حذف مقاله پس از تایید استاد راهنما وجود ندارد.' };
    }
    articlesSheet.deleteRow(rowNumber);
    _logAction(nationalId, researcherName, articleId, 'DELETE_ARTICLE_SUCCESS', 'مقاله با موفقیت حذف شد.');
    try {
        const titleFinder = authSheet.getRange("P:P").createTextFinder(articleId).matchEntireCell(true);
        const foundTitleCell = titleFinder.findNext();
        if (foundTitleCell) {
            const row = foundTitleCell.getRow();
            authSheet.getRange(row, 15).setValue(0);
            authSheet.getRange(row, 16).clearContent();
            _logAction(nationalId, researcherName, articleId, 'SUGGESTED_TITLE_RELEASED', `Title: ${articleTitle}`);
        }
    } catch (e) {
        Logger.log(`Could not release suggested title for article ${articleId}: ${e.toString()}`);
    }
    try {
        const logData = logsSheet.getDataRange().getValues();
        for (let i = logData.length - 1; i >= 1; i--) {
            if (String(logData[i][3]).trim() === String(articleId).trim()) {
                logsSheet.deleteRow(i + 1);
            }
        }
    } catch(e) { Logger.log(`Could not delete logs for article ${articleId}: ${e.toString()}`); }
    return { status: 'success', message: 'مقاله و سوابق مربوطه با موفقیت حذف شدند.' };
}

function sendForFinalReview(articleId, nationalId) {
    if (!articleId || !nationalId) { return { status: 'error', message: 'اطلاعات ناقص است.' }; }
    const rowNumber = _findArticleRow(articleId);
    if (rowNumber === -1) { return { status: 'error', message: 'مقاله یافت نشد.' }; }

    const articleData = articlesSheet.getRange(rowNumber, 1, 1, articlesSheet.getLastColumn()).getValues()[0];
    const ownerId = articleData[ARTICLES_COLS.RESEARCHER_ID];
    const researcherName = articleData[ARTICLES_COLS.RESEARCHER_NAME];
    const supervisorStatus = articleData[ARTICLES_COLS.SUPERVISOR_STATUS];

    if (ownerId.toString().trim() !== nationalId.trim()) {
      _logAction(nationalId, 'N/A', articleId, 'SEND_FINAL_REVIEW_FAIL', 'Authorization Error');
      return { status: 'error', message: 'شما اجازه دسترسی به این مقاله را ندارید.' };
    }
    if (String(supervisorStatus) !== '5') {
      _logAction(nationalId, researcherName, articleId, 'SEND_FINAL_REVIEW_FAIL', 'Supervisor not accepted yet');
      return { status: 'error', message: 'این عمل تنها پس از تایید استاد راهنما امکان‌پذیر است.' };
    }

    try {
      articlesSheet.getRange(rowNumber, ARTICLES_COLS.ARTICLE_STATUS + 1).setValue(11);
      _logAction(nationalId, researcherName, articleId, 'SEND_FINAL_REVIEW_SUCCESS', 'مقاله برای بررسی نهایی ارسال شد.');
      return { status: 'success', message: 'مقاله با موفقیت برای بررسی نهایی ارسال شد و پس از این قابل ویرایش نخواهد بود.' };
    } catch (error) {
      _logAction(nationalId, researcherName, articleId, 'SEND_FINAL_REVIEW_ERROR', error.toString());
      return { status: 'error', message: 'خطا در ارسال مقاله: ' + error.toString() };
    }
}

function updateArticleDetails(nationalId, articleId, details) {
    if (!nationalId) return { status: 'error', message: 'احراز هویت ناموفق.' };
    const rowNumber = _findArticleRow(articleId);
    if (rowNumber === -1) return { status: 'error', message: 'مقاله یافت نشد.' };
    const articleInfo = articlesSheet.getRange(rowNumber, 1, 1, articlesSheet.getLastColumn()).getValues()[0];
    const researcherName = articleInfo[ARTICLES_COLS.RESEARCHER_NAME];
    const ownerId = articleInfo[ARTICLES_COLS.RESEARCHER_ID];
    const articleStatus = articleInfo[ARTICLES_COLS.ARTICLE_STATUS];
    if (ownerId.toString().trim() !== nationalId.trim()) {
        _logAction(nationalId, 'N/A', articleId, 'UPDATE_DETAILS_FAIL', 'Authorization Error');
        return { status: 'error', message: 'شما اجازه ویرایش این مقاله را ندارید.' };
    }
    let logDetails = [];

    if (details.title && details.title.trim() !== '') {
        articlesSheet.getRange(rowNumber, ARTICLES_COLS.TITLE + 1).setValue(details.title.trim());
        logDetails.push(`تغییر عنوان به: ${details.title.trim()}`);
    }

    if (details.supervisor) {
        const supervisorStatus = articlesSheet.getRange(rowNumber, ARTICLES_COLS.SUPERVISOR_STATUS + 1).getValue();
        if (supervisorStatus == 5 && articleStatus != 4 && articleStatus != 9) {
            _logAction(nationalId, researcherName, articleId, 'UPDATE_DETAILS_FAIL', 'تلاش برای تغییر استاد راهنمای تایید شده');
            return { status: 'error', message: 'استاد راهنما قبلاً مقاله را پذیرفته و قابل تغییر نیست.' };
        }
        articlesSheet.getRange(rowNumber, ARTICLES_COLS.SUPERVISOR_NAME + 1).setValue(details.supervisor.name);
        articlesSheet.getRange(rowNumber, ARTICLES_COLS.SUPERVISOR_ID + 1).setValue(details.supervisor.nationalId);
        if (articleStatus != 9) {
            articlesSheet.getRange(rowNumber, ARTICLES_COLS.SUPERVISOR_STATUS + 1).setValue(1);
            if (articleStatus == 4) { articlesSheet.getRange(rowNumber, ARTICLES_COLS.ARTICLE_STATUS + 1).setValue(1); }
        }
        logDetails.push(`تغییر استاد راهنما به: ${details.supervisor.name}`);
    }
    if (details.affiliation) { articlesSheet.getRange(rowNumber, ARTICLES_COLS.AFFILIATION + 1).setValue(details.affiliation); logDetails.push('تغییر وابستگی سازمانی'); }
    if (details.knowledgeArea) { articlesSheet.getRange(rowNumber, ARTICLES_COLS.KNOWLEDGE_AREA + 1).setValue(details.knowledgeArea); logDetails.push('تغییر حیطه دانشی'); }
    if (details.topicReason) { articlesSheet.getRange(rowNumber, ARTICLES_COLS.TOPIC_REASON + 1).setValue(details.topicReason); logDetails.push('تغییر دلیل انتخاب موضوع'); }
    _logAction(nationalId, researcherName, articleId, 'UPDATE_DETAILS_SUCCESS', logDetails.join('، '));
    return { status: 'success', message: 'اطلاعات مقاله با موفقیت به‌روزرسانی شد.' };
}

function updateArticleSection(nationalId, articleId, section, content) {
    if (!nationalId) return { status: 'error', message: 'احراز هویت ناموفق.' };
    const rowNumber = _findArticleRow(articleId);
    if (rowNumber === -1) return { status: 'error', message: 'مقاله یافت نشد.' };
    const articleInfo = articlesSheet.getRange(rowNumber, ARTICLES_COLS.RESEARCHER_NAME + 1, 1, 2).getValues()[0];
    const researcherName = articleInfo[0];
    const ownerId = articleInfo[1];
    if (ownerId.toString().trim() !== nationalId.trim()) {
        _logAction(nationalId, 'N/A', articleId, 'UPDATE_SECTION_FAIL', `Authorization Error for section ${section}`);
        return { status: 'error', message: 'شما اجازه ویرایش این مقاله را ندارید.' };
    }
    let sectionNameForLog = section;
    switch (section) {
        case 'keywords_abstract':
            sectionNameForLog = 'چکیده و کلیدواژه‌ها'; articlesSheet.getRange(rowNumber, ARTICLES_COLS.KEYWORDS + 1, 1, 2).setValues([[content.keywords, content.abstract]]); break;
        case 'introduction':
            sectionNameForLog = 'مقدمه'; articlesSheet.getRange(rowNumber, ARTICLES_COLS.INTRODUCTION + 1).setValue(content); break;
        case 'body':
            sectionNameForLog = 'بدنه مقاله'; articlesSheet.getRange(rowNumber, ARTICLES_COLS.BODY + 1).setValue(content); break;
        case 'conclusion':
            sectionNameForLog = 'نتیجه‌گیری'; articlesSheet.getRange(rowNumber, ARTICLES_COLS.CONCLUSION + 1).setValue(content); break;
        case 'references':
            sectionNameForLog = 'منابع'; articlesSheet.getRange(rowNumber, ARTICLES_COLS.REFERENCES + 1).setValue(content); break;
        default: return { status: 'error', message: 'بخش نامعتبر است.' };
    }
    _logAction(nationalId, researcherName, articleId, 'UPDATE_SECTION_SUCCESS', `بخش "${sectionNameForLog}" به‌روزرسانی شد.`);
    return { status: 'success', message: 'بخش مورد نظر با موفقیت ذخیره شد.' };
}

// ==========================================================
// File: Script.js (نسخه نهایی با اعمال تمام تغییرات و حذف‌ها)
// ==========================================================

// --- Configurations ---
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwwTgJU4lbocweggC0zU7XyzzWKg3BhcUcFc5kaeYoD6dsAHVN7A-15L19G32UCa2hB/exec';

// --- State Management ---
let allUserArticles = [];
let currentPage = 1;
let currentSearchTerm = '';
let isLoading = false;
let hasMoreArticles = true;
let currentFilter = 'all';

// --- DOM Elements ---
const loginPage = document.getElementById('login-page');
const dashboardPage = document.getElementById('dashboard-page');
const loginForm = document.getElementById('login-form');
const modalContainer = document.getElementById('modal-container');
const toastContainer = document.getElementById('toast-container');

// --- Skeleton Generators ---
function generateSkeletonHTML(count = 3) {
    let html = '';
    for(let i=0; i<count; i++) {
        html += `
        <div class="article-card" style="border-right-color: #e2e8f0;">
            <div class="skeleton skeleton-text" style="width: 60%; height: 20px;"></div>
            <div class="skeleton skeleton-text" style="width: 30%; height: 14px; margin-top: 8px;"></div>
            <div class="card-separator-strip"></div>
        </div>`;
    }
    return html;
}

// --- Core API Function ---
async function callApi(action, params = {}, button = null) {
    if (button) button.classList.add('btn-loading');
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify({ action, params })
        });
        if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
        const data = await response.json();
        if (data.status === 'error') { console.error('API Error:', data.message); }
        return data;
    } catch (error) {
        console.error('API Call Failed:', error);
        return { status: 'error', message: error.message, isNetworkError: true };
    } finally {
        if (button) button.classList.remove('btn-loading');
    }
}

// --- Initialization ---
document.addEventListener('DOMContentLoaded', () => {
    const user = getStoredUser();
    const body = document.body;
    if (user) {
        loginPage.classList.add('hidden');
        dashboardPage.classList.remove('hidden');
        body.classList.remove('login-view');
        showDashboard(user);
    } else {
            loginPage.classList.remove('hidden');
            dashboardPage.classList.add('hidden');
            body.classList.add('login-view');
    }

    // Close menu on click outside
    document.addEventListener('click', function (event) {
        const menu = document.getElementById('user-menu-dropdown');
        const menuBtn = document.getElementById('user-menu-btn');
        if (menu && menuBtn && !menu.contains(event.target) && !menuBtn.contains(event.target)) {
            menu.classList.add('hidden');
        }
    });
});

// --- Login Logic ---
loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const loginError = document.getElementById('login-error');
    loginError.textContent = '';
    const btn = document.getElementById('login-btn');
    
    const response = await callApi('login', {
        nationalId: document.getElementById('national-id').value,
        password: document.getElementById('password').value
    }, btn);
    
    if (response?.status === 'success') {
        storeUser(response.user);
        loginPage.classList.add('hidden');
        dashboardPage.classList.remove('hidden');
        document.body.classList.remove('login-view');
        showDashboard(response.user);
        showToast(`خوش آمدید، ${response.user.name}`, 'success');
    } else {
        loginError.textContent = response?.isNetworkError ? 'خطا در ارتباط با سرور' : response?.message || 'خطایی رخ داد.';
        showToast('ورود ناموفق', 'error');
    }
});

// --- Dashboard Logic ---
function showDashboard(user) {
    document.getElementById('header-greeting').textContent = `سلام، ${user.name}`;
    document.getElementById('menu-user-name').textContent = user.name;
    document.getElementById('menu-user-nid').textContent = user.nationalId;
    document.getElementById('menu-user-score').textContent = user.score || 0; 
    
    document.getElementById('user-menu-btn').onclick = () => {
        document.getElementById('user-menu-dropdown').classList.toggle('hidden');
    };
    
    // <<<< دستور دوم: هندلینگ تغییر رمز عبور >>>>
    document.getElementById('change-pass-btn').onclick = () => {
        showChangePasswordModal();
    };

    document.getElementById('refresh-btn').onclick = () => {
        const icon = document.querySelector('#refresh-btn i');
        icon.classList.add('fa-spin');
        loadArticles(user.nationalId, false).then(() => {
            icon.classList.remove('fa-spin');
            showToast('لیست بروزرسانی شد', 'info');
        });
    };

    document.getElementById('logout-btn').onclick = handleLogout;
    document.getElementById('add-new-article-btn').onclick = showNewArticleModal;

    document.getElementById('article-tabs').addEventListener('click', (e) => {
        if (e.target.classList.contains('tab-item')) {
            const filter = e.target.dataset.statusFilter;
            if (filter === currentFilter) return;
            currentFilter = filter;
            document.querySelectorAll('.tab-item').forEach(tab => tab.classList.remove('active'));
            e.target.classList.add('active');
            renderArticles(); 
        }
    });

    let searchDebounce;
    const searchInput = document.getElementById('article-search-input');
    searchInput.addEventListener('input', (e) => {
        clearTimeout(searchDebounce);
        searchDebounce = setTimeout(() => {
            currentSearchTerm = e.target.value.trim();
            loadArticles(user.nationalId, false);
        }, 500);
    });
    loadArticles(user.nationalId, false);
}

// <<<< دستور دوم: مودال تغییر رمز عبور >>>>
function showChangePasswordModal() {
    const modalContent = `
        <div class="modal-body">
            <div class="form-group">
                <label>رمز عبور قبلی</label>
                <input type="password" id="old-pass" required>
            </div>
            <div class="form-group">
                <label>رمز عبور جدید</label>
                <input type="password" id="new-pass" required>
            </div>
        </div>
        <div class="modal-footer">
            <button id="do-change-pass-btn" class="btn-primary" style="width:100%">تغییر رمز</button>
        </div>
    `;
    renderModal('تغییر رمز عبور', modalContent, 'modal-sm');
    
    document.getElementById('do-change-pass-btn').onclick = async (e) => {
        const oldPass = document.getElementById('old-pass').value;
        const newPass = document.getElementById('new-pass').value;
        if(!oldPass || !newPass) return showToast('لطفا همه فیلدها را پر کنید', 'error');
        
        const user = getStoredUser();
        const res = await callApi('changePassword', { nationalId: user.nationalId, oldPassword: oldPass, newPassword: newPass }, e.target);
        
        if (res?.status === 'success') {
            showToast('رمز عبور تغییر کرد', 'success');
            closeModalById('main-modal');
        } else {
            showToast(res.message || 'خطا در تغییر رمز', 'error');
        }
    };
}

// <<<< دستور پنجم: نمایش مودال اطلاعات استاد >>>>
function showSupervisorDetailsModal(details, name) {
    const modalContent = `
        <div class="modal-body" style="text-align: right; line-height: 1.8;">
            <div style="margin-bottom: 15px;">
                <strong>نام استاد:</strong> <span>${name}</span>
            </div>
            <div style="margin-bottom: 15px; background: #f0f9ff; padding: 10px; border-radius: 8px;">
                <strong><i class="fas fa-check-circle" style="color:var(--success);"></i> تعداد داوری‌های موفق:</strong> 
                <span style="font-size: 1.1rem; font-weight: bold;">${details.supervisorReviews}</span>
            </div>
            <div style="margin-bottom: 15px;">
                <strong><i class="fas fa-envelope"></i> اطلاعات تماس:</strong><br>
                <span>${details.supervisorContact || 'ثبت نشده'}</span>
            </div>
            <div style="margin-bottom: 15px;">
                <strong><i class="fas fa-info-circle"></i> درباره استاد:</strong><br>
                <p style="white-space: pre-wrap; color: var(--text-muted);">${details.supervisorAbout || 'توضیحاتی ثبت نشده است.'}</p>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeModalById('sub-modal')" class="btn-secondary">بستن</button>
        </div>
    `;
    renderModal('مشخصات استاد راهنما', modalContent, 'modal-sm', true);
}

async function loadArticles(nationalId, isLoadMore = false) {
    if (isLoading) return;
    isLoading = true;

    const loadMoreContainer = document.getElementById('load-more-container');
    const articlesContainer = document.getElementById('articles-container');

    if (!isLoadMore) {
        currentPage = 1;
        allUserArticles = [];
        hasMoreArticles = true;
        articlesContainer.innerHTML = generateSkeletonHTML(4);
        const loadingSpinner = '<i class="fas fa-spinner fa-spin" style="font-size:1.2rem;"></i>';
        document.getElementById('stat-inprogress-count').innerHTML = loadingSpinner;
        document.getElementById('stat-accepted-count').innerHTML = loadingSpinner;
        document.getElementById('stat-rejected-count').innerHTML = loadingSpinner;
    } else {
        if (loadMoreContainer.querySelector('button')) {
            loadMoreContainer.querySelector('button').classList.add('btn-loading');
        }
    }

    const response = await callApi('getArticles', {
        nationalId,
        searchTerm: currentSearchTerm,
        page: currentPage
    });

    if (isLoadMore && loadMoreContainer.querySelector('button')) {
        loadMoreContainer.querySelector('button').classList.remove('btn-loading');
    }

    if (response?.status === 'success') {
        allUserArticles.push(...response.articles);
        hasMoreArticles = response.hasMore;
        currentPage++;

        renderArticles();
        updateSummaryDashboard(response.summary || allUserArticles);
        
        if (!isLoadMore) {
            document.getElementById('menu-user-score').textContent = response.score;
            const user = getStoredUser();
            if (user) { user.score = response.score; storeUser(user); }
        }
    } else {
        if (!isLoadMore) {
            articlesContainer.innerHTML = '<p style="color:var(--danger); text-align: center; margin-top:30px;">خطا در بارگذاری مقالات</p>';
             document.getElementById('stat-inprogress-count').innerHTML = '-';
             document.getElementById('stat-accepted-count').innerHTML = '-';
             document.getElementById('stat-rejected-count').innerHTML = '-';
        }
        if (response.isNetworkError) {
            showToast('خطا در ارتباط با سرور', 'error');
        }
    }
    isLoading = false;
}

function updateSummaryDashboard(data) {
    let inProgress, accepted, rejected;

    if (Array.isArray(data)) {
        inProgress = data.filter(a => ![0, 5, 9, 10, '0', '5', '9', '10'].includes(a.articleStatus)).length;
        accepted = data.filter(a => String(a.articleStatus) === '5').length;
        rejected = data.filter(a => ['0', '10'].includes(String(a.articleStatus))).length;
    } else {
        inProgress = data.inProgress;
        accepted = data.accepted;
        rejected = data.rejected;
    }
    
    document.getElementById('stat-inprogress-count').textContent = inProgress;
    document.getElementById('stat-accepted-count').textContent = accepted;
    document.getElementById('stat-rejected-count').textContent = rejected;
}

// --- Toast & Alerts System ---
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    
    let iconClass = 'fa-info-circle';
    if (type === 'success') iconClass = 'fa-check-circle';
    if (type === 'error') iconClass = 'fa-exclamation-circle';
    
    toast.innerHTML = `<i class="fas ${iconClass}"></i><span>${message}</span>`;
    
    toastContainer.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(10px)';
        setTimeout(() => toast.remove(), 400);
    }, 4000);
}

function showCustomAlert(message, type = 'info', onClose = null) {
    const alertContainer = document.getElementById('alert-container');
    const overlay = document.createElement('div');
    overlay.className = 'custom-alert-overlay'; 
    overlay.style.position = 'fixed'; overlay.style.inset = '0'; overlay.style.background = 'rgba(0,0,0,0.5)'; overlay.style.zIndex = '2000'; overlay.style.display = 'flex'; overlay.style.alignItems = 'center'; overlay.style.justifyContent = 'center'; overlay.style.backdropFilter = 'blur(5px)';
    
    const icons = { success: 'fa-check-circle', error: 'fa-times-circle', info: 'fa-info-circle' };
    const iconClass = icons[type] || 'fa-info-circle';
    
    overlay.innerHTML = `
        <div class="modal-box" style="max-width: 350px; text-align: center; padding: 30px;">
            <i class="fas ${iconClass} custom-alert-icon ${type}"></i>
            <p style="margin-bottom:25px; font-size:1.1rem; line-height: 1.6;">${message}</p>
            <button id="alert-ok-btn" class="btn-primary" style="width: 100%;">متوجه شدم</button>
        </div>`;
    
    alertContainer.appendChild(overlay);
    
    setTimeout(() => overlay.classList.add('visible'), 10);
    
    const closeAlert = () => {
        overlay.style.opacity = '0';
        setTimeout(() => { overlay.remove(); if (onClose) onClose(); }, 300);
    };
    overlay.querySelector('#alert-ok-btn').onclick = closeAlert;
}

function showCustomConfirm(message, onConfirm, confirmText = 'بله', cancelText = 'خیر') {
    const alertContainer = document.getElementById('alert-container');
    const overlay = document.createElement('div');
    overlay.className = 'custom-alert-overlay';
    overlay.style.position = 'fixed'; overlay.style.inset = '0'; overlay.style.background = 'rgba(0,0,0,0.5)'; overlay.style.zIndex = '2000'; overlay.style.display = 'flex'; overlay.style.alignItems = 'center'; overlay.style.justifyContent = 'center'; overlay.style.backdropFilter = 'blur(5px)';
    
    overlay.innerHTML = `
        <div class="modal-box" style="max-width: 400px; text-align: center; padding: 30px;">
            <i class="fas fa-question-circle custom-alert-icon warning" style="color:var(--warning)"></i>
            <p style="margin-bottom:25px; font-size:1.1rem; line-height: 1.6;">${message}</p>
            <div style="display:flex; gap:10px; justify-content:center;">
                <button id="confirm-yes-btn" class="btn-primary" style="min-width:100px;">${confirmText}</button>
                <button id="confirm-no-btn" class="btn-secondary" style="min-width:100px;">${cancelText}</button>
            </div>
        </div>`;
    
    alertContainer.appendChild(overlay);
    
    const confirmBtn = overlay.querySelector('#confirm-yes-btn');
    const cancelBtn = overlay.querySelector('#confirm-no-btn');
    
    const closeModal = () => { overlay.remove(); };
    
    confirmBtn.onclick = () => { 
        confirmBtn.classList.add('btn-loading'); 
        onConfirm(true, confirmBtn, closeModal); 
    };
    cancelBtn.onclick = () => { 
        onConfirm(false, null, closeModal); 
    };
}

// --- Article Actions ---
async function handleDeleteArticle(articleId, button) {
    showCustomConfirm('آیا از حذف این مقاله اطمینان دارید؟ تمام سوابق آن پاک خواهد شد.', async (confirmed, confirmBtn, closeModal) => {
        if (confirmed) {
            const user = getStoredUser();
            const response = await callApi('deleteArticle', { articleId: articleId, nationalId: user.nationalId });
            closeModal();
            if (response?.status === 'success') {
                showToast('مقاله با موفقیت حذف شد', 'success');
                loadArticles(user.nationalId, false);
            } else {
                showToast(response?.message || 'خطا در حذف مقاله', 'error');
            }
        } else { closeModal(); }
    }, 'حذف شود', 'لغو');
}

async function handleNewArticleSubmit(e, isDraft) {
    if (!isDraft && !window.selectedSupervisor) {
        return showToast('لطفاً استاد راهنما را انتخاب کنید.', 'error');
    }
    const user = getStoredUser();
    const data = {
        researcherName: user.name,
        researcherId: user.nationalId,
        title: document.getElementById('new-article-title').value,
        affiliation: [document.getElementById('aff-level').value, document.getElementById('aff-field').value, document.getElementById('aff-institute').value, document.getElementById('aff-location').value].filter(Boolean).join('، '),
        knowledgeArea: document.getElementById('new-knowledge-area').value,
        topicReason: document.getElementById('new-topic-reason').value,
        supervisor: isDraft ? null : window.selectedSupervisor
    };
    
    const response = await callApi('submitNewArticle', { data, isDraft }, e.target);
    
    if (response?.status === 'success') {
        showToast(isDraft ? 'پیش‌نویس ذخیره شد' : 'مقاله با موفقیت ثبت شد', 'success');
        closeAllModals();
        await loadArticles(user.nationalId, false);
    } else {
        showToast(response?.message || 'خطا در ثبت', 'error');
    }
}

async function updateCardInPlace(articleId) {
    const card = document.querySelector(`.article-card[data-article-id="${articleId}"]`);
    if (!card) return;
    const statusContainer = card.querySelector('.status-badges');
    if (statusContainer) { statusContainer.innerHTML = '<div class="btn-loading" style="color:var(--primary); height:20px;"></div>'; }

    const user = getStoredUser();
    const response = await callApi('getSingleArticle', { nationalId: user.nationalId, articleId });

    if (response?.status === 'success' && response.article) {
        const newArticleData = response.article;
        const articleIndex = allUserArticles.findIndex(a => a.articleId == articleId);
        if (articleIndex > -1) { allUserArticles[articleIndex] = newArticleData; }
        
        card.innerHTML = generateArticleCardInnerHTML(newArticleData);
        card.style.borderRightColor = getCardBorderColor(newArticleData);
        bindArticleCardEvents(card, newArticleData);
    }
}

// --- Main Feature: Split-Screen Editor & Navigation ---
function showEditArticleWizard(article) {
    const isFullyLocked = [5, 6, 8, 11].includes(Number(article.articleStatus));
    const isReadOnly = isFullyLocked;
    const isDraft = Number(article.articleStatus) === 9;
    
    const countWords = (str) => str ? str.trim().split(/\s+/).filter(Boolean).length : 0;
    const countKeywords = (str) => str ? str.trim().split(/[,،]/).filter(s => s.trim() !== "").length : 0;
    
    const referenceManagerHTML = `
        <div class="form-group"><label for="ref-type">نوع منبع</label><select id="ref-type" ${isReadOnly ? 'disabled' : ''}><option value="book">کتاب</option><option value="journal">مقاله مجله</option><option value="website">وب‌سایت</option></select></div>
        <div id="ref-book-fields"><div class="ref-manager-grid"><div class="form-group"><label>نام خانوادگی</label><input id="ref-book-lname" ${isReadOnly ? 'disabled' : ''}></div><div class="form-group"><label>نام نویسنده</label><input id="ref-book-fname" ${isReadOnly ? 'disabled' : ''}></div><div class="form-group"><label>سال نشر</label><input id="ref-book-year" type="number" ${isReadOnly ? 'disabled' : ''}></div><div class="form-group"><label>عنوان کتاب</label><input id="ref-book-title" ${isReadOnly ? 'disabled' : ''}></div><div class="form-group"><label>انتشارات</label><input id="ref-book-publisher" ${isReadOnly ? 'disabled' : ''}></div></div></div>
        <div id="ref-journal-fields" class="hidden"><div class="ref-manager-grid"><div class="form-group"><label>نام خانوادگی</label><input id="ref-journal-lname" ${isReadOnly ? 'disabled' : ''}></div><div class="form-group"><label>نام نویسنده</label><input id="ref-journal-fname" ${isReadOnly ? 'disabled' : ''}></div><div class="form-group"><label>سال نشر</label><input id="ref-journal-year" type="number" ${isReadOnly ? 'disabled' : ''}></div><div class="form-group"><label>عنوان مقاله</label><input id="ref-journal-title" ${isReadOnly ? 'disabled' : ''}></div><div class="form-group"><label>نام مجله</label><input id="ref-journal-name" ${isReadOnly ? 'disabled' : ''}></div></div></div>
        <div id="ref-website-fields" class="hidden"><div class="ref-manager-grid"><div class="form-group"><label>نویسنده</label><input id="ref-web-author" ${isReadOnly ? 'disabled' : ''}></div><div class="form-group"><label>سال</label><input id="ref-web-year" type="number" ${isReadOnly ? 'disabled' : ''}></div><div class="form-group"><label>عنوان صفحه</label><input id="ref-web-title" ${isReadOnly ? 'disabled' : ''}></div><div class="form-group"><label>URL</label><input id="ref-web-url" type="url" ${isReadOnly ? 'disabled' : ''}></div></div></div>
        <button id="add-ref-btn" class="btn-secondary" style="width:100%; margin-bottom:10px;" type="button" ${isReadOnly ? 'disabled' : ''}><i class="fas fa-plus"></i> افزودن به لیست</button>
        <div class="validation-note"><span>حداقل ۵ منبع</span><span id="ref-counter" class="counter"></span></div>
        <ul class="reference-list" id="reference-list-container"></ul>
        <textarea id="edit-references-hidden" class="hidden">${article.references || ''}</textarea>
        <button class="save-section-btn btn-success" type="button" data-section="references" style="width:100%; margin-top:10px;" ${isReadOnly ? 'disabled' : ''}>ذخیره منابع</button>
    `;

    const modalContent = `
    <div class="split-editor-container">
        <!-- Sidebar -->
        <div class="editor-sidebar">
            <h4 style="display:none;">بخش‌ها</h4>
            <button class="sidebar-nav-btn active" data-target="sec-details">1. اطلاعات کلی</button>
            <button class="sidebar-nav-btn" data-target="sec-abstract">2. چکیده و کلیدواژه</button>
            <button class="sidebar-nav-btn" data-target="sec-intro">3. مقدمه</button>
            <button class="sidebar-nav-btn" data-target="sec-body">4. بدنه اصلی</button>
            <button class="sidebar-nav-btn" data-target="sec-conclusion">5. نتیجه‌گیری</button>
            <button class="sidebar-nav-btn" data-target="sec-refs">6. منابع</button>
        </div>
        
        <!-- Content -->
        <div class="editor-content" id="editor-content-area">
            <div id="sec-details" class="editor-section" data-index="0">
                <!-- Details injected via JS -->
            </div>

            <div id="sec-abstract" class="editor-section hidden" data-index="1">
                <div class="form-group">
                    <label>چکیده</label>
                    <textarea id="edit-abstract" rows="6" ${isReadOnly ? 'disabled' : ''}>${article.abstract || ''}</textarea>
                    <div class="validation-note"><span id="abstract-counter" class="counter">0</span> کلمه</div>
                </div>
                <div class="form-group">
                    <label>کلیدواژه‌ها</label>
                    <input type="text" id="edit-keywords" value="${article.keywords || ''}" ${isReadOnly ? 'disabled' : ''}>
                    <div class="validation-note"><span id="keywords-counter" class="counter">0</span> مورد</div>
                </div>
                <button class="save-section-btn btn-success" type="button" data-section="keywords_abstract" style="width:100%" ${isReadOnly ? 'disabled' : ''}>ذخیره</button>
            </div>

            <div id="sec-intro" class="editor-section hidden" data-index="2">
                <div class="form-group">
                    <label>مقدمه</label>
                    <textarea id="edit-introduction" rows="12" ${isReadOnly ? 'disabled' : ''}>${article.introduction || ''}</textarea>
                    <div class="validation-note"><span id="intro-counter" class="counter">0</span> کلمه</div>
                </div>
                <button class="save-section-btn btn-success" type="button" data-section="introduction" style="width:100%" ${isReadOnly ? 'disabled' : ''}>ذخیره</button>
            </div>

            <div id="sec-body" class="editor-section hidden" data-index="3">
                <div class="form-group">
                    <label>بدنه اصلی</label>
                    <textarea id="edit-body" rows="18" ${isReadOnly ? 'disabled' : ''}>${article.body || ''}</textarea>
                    <div class="validation-note"><span id="body-counter" class="counter">0</span> کلمه</div>
                </div>
                <button class="save-section-btn btn-success" type="button" data-section="body" style="width:100%" ${isReadOnly ? 'disabled' : ''}>ذخیره</button>
            </div>

            <div id="sec-conclusion" class="editor-section hidden" data-index="4">
                <div class="form-group">
                    <label>نتیجه‌گیری</label>
                    <textarea id="edit-conclusion" rows="8" ${isReadOnly ? 'disabled' : ''}>${article.conclusion || ''}</textarea>
                    <div class="validation-note"><span id="conclusion-counter" class="counter">0</span> کلمه</div>
                </div>
                <button class="save-section-btn btn-success" type="button" data-section="conclusion" style="width:100%" ${isReadOnly ? 'disabled' : ''}>ذخیره</button>
            </div>

            <div id="sec-refs" class="editor-section hidden" data-index="5">
                ${referenceManagerHTML}
            </div>
        </div>
    </div>
    ${isDraft ? `<div class="modal-footer"><button id="submit-draft-btn" class="btn-info" type="button" style="width:100%"><i class="fas fa-paper-plane"></i> <span class="btn-text">ارسال نهایی پیش‌نویس برای استاد</span></button></div>` : ''}
    `;
    
    renderModal(`${article.title}`, modalContent, 'modal-lg');
    
    document.querySelectorAll('.sidebar-nav-btn').forEach(btn => {
        btn.onclick = () => {
            const targetId = btn.dataset.target;
            const targetEl = document.getElementById(targetId);
            if(targetEl) {
                document.querySelectorAll('.editor-section').forEach(section => {
                    section.classList.add('hidden');
                });
                targetEl.classList.remove('hidden');
                document.querySelectorAll('.sidebar-nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
        };
    });

    if (isDraft) {
        document.getElementById('submit-draft-btn').onclick = (e) => handleSubmitDraft(e, article.articleId, article.supervisorName);
    }

    if (!isDraft && [0, 1].includes(Number(article.supervisorStatus))) {
        const step1Container = document.getElementById('sec-details');
        const notice = document.createElement('div');
        notice.className = 'editor-feedback-notice rejected';
        notice.style.marginBottom = '20px';
        notice.innerHTML = '<strong>توجه:</strong> تا زمان تایید استاد راهنما، امکان ویرایش بخش‌های دیگر مقاله وجود ندارد.';
        if (Number(article.supervisorStatus) === 0) {
            notice.innerHTML = '<strong>درخواست رد شد:</strong> استاد راهنما درخواست شما را نپذیرفته است. لطفاً از این بخش، استاد راهنمای دیگری انتخاب کنید.';
        }
        step1Container.prepend(notice);
    }
    
    const setupCounter = (inputId, counterId, min, max, isKeyword = false) => {
        const input = document.getElementById(inputId);
        const counter = document.getElementById(counterId);
        const update = () => {
            const count = isKeyword ? countKeywords(input.value) : countWords(input.value);
            counter.textContent = count;
            counter.classList.toggle('invalid', !isReadOnly && (count < min || count > max));
        };
        input.addEventListener('input', update);
        update();
    };
    setupCounter('edit-abstract', 'abstract-counter', 150, 300);
    setupCounter('edit-keywords', 'keywords-counter', 3, 5, true);
    setupCounter('edit-introduction', 'intro-counter', 350, 500);
    setupCounter('edit-body', 'body-counter', 700, 3000);
    setupCounter('edit-conclusion', 'conclusion-counter', 100, 500);

    document.querySelectorAll('.save-section-btn').forEach(btn => {
        btn.onclick = async (e) => {
            if (isReadOnly) return;
            const user = getStoredUser();
            const section = e.target.closest('button').dataset.section;
            let content;
            
            if (section === 'keywords_abstract') {
                const abstractText = document.getElementById('edit-abstract').value;
                const keywordsText = document.getElementById('edit-keywords').value;
                if (countWords(abstractText) < 150 || countWords(abstractText) > 300) return showToast('تعداد کلمات چکیده معتبر نیست (۱۵۰ تا ۳۰۰)', 'error');
                if (countKeywords(keywordsText) < 3 || countKeywords(keywordsText) > 5) return showToast('تعداد کلیدواژه‌ها معتبر نیست (۳ تا ۵)', 'error');
                content = { keywords: keywordsText, abstract: abstractText };
            } else if (section === 'references') {
                content = document.getElementById('edit-references-hidden').value;
                if (document.getElementById('reference-list-container').children.length < 5) return showToast('حداقل ۵ منبع الزامی است', 'error');
            } else {
                const text = document.getElementById(`edit-${section}`).value;
                const wordCount = countWords(text);
                if (section === 'introduction' && (wordCount < 350 || wordCount > 500)) return showToast('تعداد کلمات مقدمه معتبر نیست', 'error');
                if (section === 'body' && (wordCount < 700 || wordCount > 3000)) return showToast('تعداد کلمات بدنه معتبر نیست', 'error');
                if (section === 'conclusion' && (wordCount < 100 || wordCount > 500)) return showToast('تعداد کلمات نتیجه‌گیری معتبر نیست', 'error');
                content = text;
            }

            const res = await callApi('updateArticleSection', { nationalId: user.nationalId, articleId: article.articleId, section, content }, e.target);
            if (res?.status === 'success') {
                showToast('ذخیره شد', 'success');
                updateCardInPlace(article.articleId);
            } else {
                showToast(res.message || 'خطا در ذخیره', 'error');
            }
        };
    });

    const refTypeSelect = document.getElementById('ref-type');
    const fields = { book: document.getElementById('ref-book-fields'), journal: document.getElementById('ref-journal-fields'), website: document.getElementById('ref-website-fields') };
    const addRefBtn = document.getElementById('add-ref-btn');
    const refListContainer = document.getElementById('reference-list-container');
    const hiddenRefTextarea = document.getElementById('edit-references-hidden');
    const refCounter = document.getElementById('ref-counter');
    
    const updateRefList = () => {
        const items = Array.from(refListContainer.children).map(li => li.querySelector('span').textContent);
        hiddenRefTextarea.value = items.join('\n');
        const count = items.length;
        refCounter.textContent = count;
        refCounter.classList.toggle('invalid', !isReadOnly && (count < 5));
    };

    const renderInitialRefs = () => {
        refListContainer.innerHTML = '';
        hiddenRefTextarea.value.split('\n').filter(Boolean).forEach(refText => {
            const li = document.createElement('li');
            li.innerHTML = `<span>${refText}</span><button class="icon-btn-circle" style="width:24px;height:24px;min-height:auto;border:none;background:transparent;color:var(--danger);" type="button"><i class="fas fa-times"></i></button>`;
            if (!isReadOnly) { li.querySelector('button').onclick = () => { li.remove(); updateRefList(); }; }
            refListContainer.appendChild(li);
        });
        updateRefList();
    };

    refTypeSelect.onchange = () => Object.keys(fields).forEach(key => fields[key].classList.toggle('hidden', refTypeSelect.value !== key));
    
    addRefBtn.onclick = () => {
        if (isReadOnly) return;
        let formattedRef = '', inputsToClear = [];
        if (refTypeSelect.value === 'book') {
            const vals = ['ref-book-lname', 'ref-book-fname', 'ref-book-year', 'ref-book-title', 'ref-book-publisher'].map(id => document.getElementById(id).value.trim());
            if (vals.some(v => !v)) return showToast('تمام فیلدها الزامی است', 'error');
            formattedRef = `${vals[0]}، ${vals[1]} (${vals[2]}). *${vals[3]}*. ${vals[4]}.`;
            inputsToClear = ['ref-book-lname', 'ref-book-fname', 'ref-book-year', 'ref-book-title', 'ref-book-publisher'];
        } else if (refTypeSelect.value === 'journal') {
            const vals = ['ref-journal-lname', 'ref-journal-fname', 'ref-journal-year', 'ref-journal-title', 'ref-journal-name'].map(id => document.getElementById(id).value.trim());
            if (vals.some(v => !v)) return showToast('تمام فیلدها الزامی است', 'error');
            formattedRef = `${vals[0]}، ${vals[1]} (${vals[2]}). "${vals[3]}". *${vals[4]}*.`;
            inputsToClear = ['ref-journal-lname', 'ref-journal-fname', 'ref-journal-year', 'ref-journal-title', 'ref-journal-name'];
        } else {
            const vals = ['ref-web-author', 'ref-web-year', 'ref-web-title', 'ref-web-url'].map(id => document.getElementById(id).value.trim());
            if (!vals[1] || !vals[2] || !vals[3]) return showToast('سال، عنوان و URL الزامی است', 'error');
            formattedRef = `${vals[0] ? vals[0] + ' ' : ''}(${vals[1]}). *${vals[2]}*. بازیابی: ${vals[3]}`;
            inputsToClear = ['ref-web-author', 'ref-web-year', 'ref-web-title', 'ref-web-url'];
        }
        const li = document.createElement('li');
        li.innerHTML = `<span>${formattedRef}</span><button class="icon-btn-circle" style="width:24px;height:24px;min-height:auto;border:none;background:transparent;color:var(--danger);" type="button"><i class="fas fa-times"></i></button>`;
        li.querySelector('button').onclick = () => { li.remove(); updateRefList(); };
        refListContainer.appendChild(li);
        updateRefList();
        inputsToClear.forEach(id => document.getElementById(id).value = '');
    };
    renderInitialRefs();

    const canChangeSupervisor = (article.supervisorStatus != 5) || (article.articleStatus == 4) || isDraft;
    const step1 = document.getElementById('sec-details');
    step1.innerHTML = `
        <div class="form-group">
            <label>عنوان مقاله</label>
            <input type="text" id="edit-article-title" value="${article.title || ''}" ${isFullyLocked ? 'disabled' : ''}>
        </div>
        <div class="form-group">
            <label>حیطه دانشی</label>
            <select id="edit-knowledgeArea" ${isReadOnly ? 'disabled' : ''}>${getKnowledgeAreaOptions(article.knowledgeArea)}</select>
        </div>
        <div class="form-group">
            <label>دلیل انتخاب موضوع</label>
            <textarea id="edit-topicReason" rows="3" ${isReadOnly ? 'disabled' : ''}>${article.topicReason || ''}</textarea>
        </div>
        <div class="form-group">
            <label>وابستگی سازمانی (جهت ویرایش کلیک کنید)</label>
            <input type="text" id="edit-affiliation-display" value="${article.affiliation || ''}" readonly style="cursor:pointer;" onclick="if(!${isReadOnly}) document.getElementById('aff-trigger-btn').click()">
            <button id="aff-trigger-btn" class="hidden"></button>
        </div>
        <div class="form-group">
            <label>استاد راهنما</label>
            <div style="display:flex; gap:10px;">
                <input type="text" id="edit-supervisor-display" value="${article.supervisorName || 'انتخاب نشده'}" disabled>
                ${canChangeSupervisor && !isReadOnly ? '<button id="change-supervisor-btn" class="btn-secondary" type="button">تغییر</button>' : ''}
            </div>
        </div>
        <button id="save-details-btn" class="save-section-btn btn-success" type="button" style="width:100%" ${isReadOnly ? 'disabled' : ''}>ذخیره اطلاعات کلی</button>
    `;

    document.getElementById('aff-trigger-btn').onclick = () => {
        showAffiliationModal(null, document.getElementById('edit-affiliation-display').value, (newVal) => {
            document.getElementById('edit-affiliation-display').value = newVal;
        });
    };

    if (document.getElementById('change-supervisor-btn')) {
        document.getElementById('change-supervisor-btn').onclick = () => {
            showSupervisorModal(null, (s) => {
                window.selectedSupervisorForEdit = s;
                document.getElementById('edit-supervisor-display').value = s.name;
            });
        };
    }

    document.getElementById('save-details-btn').onclick = async (e) => {
        if (isReadOnly) return;
        const user = getStoredUser();
        const details = {
            title: document.getElementById('edit-article-title').value,
            affiliation: document.getElementById('edit-affiliation-display').value,
            knowledgeArea: document.getElementById('edit-knowledgeArea').value,
            topicReason: document.getElementById('edit-topicReason').value
        };
        if (canChangeSupervisor && window.selectedSupervisorForEdit) {
            details.supervisor = window.selectedSupervisorForEdit;
        }
        
        const res = await callApi('updateArticleDetails', { nationalId: user.nationalId, articleId: article.articleId, details }, e.target);
        if (res?.status === 'success') {
            showToast('اطلاعات کلی بروزرسانی شد', 'success');
            updateCardInPlace(article.articleId);
            window.selectedSupervisorForEdit = null;
            if (isDraft) {
                const updated = await callApi('getSingleArticle', { nationalId: user.nationalId, articleId: article.articleId });
                if (updated?.article) { closeModalById('main-modal'); showEditArticleWizard(updated.article); }
            }
        } else {
            showToast(res.message || 'خطا در ذخیره', 'error');
        }
    };
}

async function handleSubmitDraft(e, articleId, supervisorName) {
    const supervisorDisplay = document.getElementById('edit-supervisor-display').value;
    if (!supervisorName && (supervisorDisplay === 'انتخاب نشده' || !supervisorDisplay)) {
        return showToast('لطفا استاد راهنما را انتخاب و ذخیره کنید', 'error');
    }
    showCustomConfirm('آیا پیش‌نویس برای استاد ارسال شود؟', async (confirmed, btn, closeModal) => {
        if (confirmed) {
            const user = getStoredUser();
            const response = await callApi('submitDraftToSupervisor', { articleId, nationalId: user.nationalId }, btn);
            closeModal();
            if (response?.status === 'success') {
                showToast('ارسال شد', 'success');
                closeAllModals();
                loadArticles(user.nationalId, false);
            } else {
                showToast(response.message || 'خطا', 'error');
            }
        } else { closeModal(); }
    });
}

// --- Rendering Articles ---
function renderArticles() {
    const container = document.getElementById('articles-container');
    container.innerHTML = '';
    
    const drafts = allUserArticles.filter(a => String(a.articleStatus) === '9');
    const rejected = allUserArticles.filter(a => ['0', '10'].includes(String(a.articleStatus)));
    const accepted = allUserArticles.filter(a => String(a.articleStatus) === '5');
    const inProgress = allUserArticles.filter(a => !['0', '5', '9', '10'].includes(String(a.articleStatus)));

    if (currentFilter === 'all') {
        if(drafts.length) renderGroup('پیش‌نویس‌ها', drafts, container);
        if(inProgress.length) renderGroup('در حال پیگیری', inProgress, container);
        if(accepted.length) renderGroup('پذیرفته شده', accepted, container);
        if(rejected.length) renderGroup('رد شده', rejected, container);
    } else {
        const map = { 'drafts': drafts, 'rejected': rejected, 'accepted': accepted, 'inProgress': inProgress };
        renderSingleGroup(map[currentFilter] || [], container);
    }

    if (container.innerHTML === '') {
        container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-muted);">موردی یافت نشد.</div>';
    }
    
    const lmContainer = document.getElementById('load-more-container');
    lmContainer.innerHTML = '';
    if (hasMoreArticles && currentFilter === 'all') {
        const btn = document.createElement('button');
        btn.className = 'btn-secondary';
        btn.innerHTML = 'بارگذاری بیشتر';
        btn.onclick = () => { const user = getStoredUser(); loadArticles(user.nationalId, true); };
        lmContainer.appendChild(btn);
    }
}

function renderGroup(title, articles, container) {
    const h4 = document.createElement('h4');
    h4.textContent = title;
    h4.style.color = 'var(--text-muted)';
    h4.style.borderBottom = '1px solid #e2e8f0';
    h4.style.paddingBottom = '8px';
    h4.style.marginTop = '20px';
    container.appendChild(h4);
    renderSingleGroup(articles, container);
}

function renderSingleGroup(articles, container) {
    articles.forEach(article => {
        const card = document.createElement('div');
        card.className = 'article-card';
        card.dataset.articleId = article.articleId;
        card.style.borderRightColor = getCardBorderColor(article);
        card.innerHTML = generateArticleCardInnerHTML(article);
        bindArticleCardEvents(card, article);
        container.appendChild(card);
    });
}

function getCardBorderColor(article) {
    const isDraft = String(article.articleStatus) === '9';
    if (isDraft) return '#64748b';
    if (['0', '10'].includes(String(article.articleStatus)) || article.supervisorStatus == 0) return '#dc2626'; 
    if (String(article.articleStatus) === '5') return '#10b981'; 
    if (String(article.supervisorStatus) === '1') return '#f59e0b'; 
    return '#3b82f6'; 
}

function generateArticleCardInnerHTML(article) {
    let supervisorStatusText, supervisorStatusColor;
    if (article.supervisorStatus == 5) { supervisorStatusText = `راهنما: ${article.supervisorName}`; supervisorStatusColor = 'var(--success)'; } 
    else if (article.supervisorStatus == 1) { supervisorStatusText = 'بررسی پذیرش'; supervisorStatusColor = 'var(--warning)'; } 
    else if (article.supervisorStatus == 0) { supervisorStatusText = 'رد درخواست'; supervisorStatusColor = 'var(--danger)'; } 
    else { supervisorStatusText = 'منتظر ارسال'; supervisorStatusColor = 'var(--secondary)'; }
    
    const [articleStatusText, articleStatusColor] = getStatusInfo('article', article.articleStatus);
    const isDraft = String(article.articleStatus) === '9';
    const isReadOnly = [5, 6, 8, 11].includes(Number(article.articleStatus));
    
    let messageHTML = '';
    if (article.rejectionReason && ['2', '10', '0'].includes(String(article.articleStatus))) {
        const isRej = ['0', '10'].includes(String(article.articleStatus));
        messageHTML = `<div class="editor-feedback-notice ${isRej ? 'rejected' : ''}"><strong>${isRej ? 'پیام نشریه:' : 'درخواست اصلاح:'}</strong> ${article.rejectionReason}</div>`;
    } else if (article.supervisorStatus == 0) {
        messageHTML = `<div class="editor-feedback-notice rejected"><strong>استاد راهنما درخواست را نپذیرفت.</strong></div>`;
    }

    const requestDate = article.requestDate ? new Date(article.requestDate).toLocaleDateString('fa-IR') : '-';
    
    const btnView = `<button class="btn-secondary btn-sm btn-view"><i class="fas fa-${isReadOnly ? 'eye' : 'edit'}"></i> ${isReadOnly ? 'مشاهده' : 'ویرایش'}</button>`;
    const btnHistory = `<button class="btn-secondary btn-sm btn-history" title="تاریخچه"><i class="fas fa-history"></i></button>`;
    const btnDelete = (article.supervisorStatus != 5 || isDraft) ? `<button class="btn-danger btn-sm btn-delete" title="حذف"><i class="fas fa-trash"></i></button>` : '';
    const btnPDF = (String(article.articleStatus) === '5') ? `<button class="btn-success btn-sm btn-download-pdf"><i class="fas fa-file-pdf"></i> PDF</button>` : '';
    
    // <<<< دستور پنجم: دکمه اطلاعات استاد >>>>
    const btnSupInfo = article.supervisorName && article.supervisorName.trim() !== '' ? 
        `<button class="btn-secondary btn-sm btn-sup-info" title="درباره استاد"><i class="fas fa-user-graduate"></i></button>` : '';

    let actionButtons = '';
    if (String(article.articleStatus) === '2') actionButtons += `<button class="btn-info btn-sm btn-rereview">ارسال اصلاحیه</button>`;
    if (String(article.articleStatus) === '10') actionButtons += `<button class="btn-info btn-sm btn-resubmit-final">ارسال نهایی</button>`;
    
    const isContentComplete = article.title && article.affiliation && article.knowledgeArea && article.topicReason && article.abstract && article.keywords && article.introduction && article.body && article.conclusion && article.references;
    const canSendFinal = isContentComplete && (String(article.supervisorStatus) === '5') && ![5, 6, 8, 11, 12, 10].includes(Number(article.articleStatus));
    if (canSendFinal) actionButtons += `<button class="btn-success btn-sm btn-send-final-review">ارسال برای داوری</button>`;

    return `
    <div class="article-header">
        <div>
            <div class="article-title">${article.title || 'بدون عنوان'}</div>
            <div style="font-size:0.8rem; color:var(--text-muted); margin-top:4px;">کد: ${article.articleId} | ${requestDate}</div>
        </div>
        <div class="status-badges">
            <span class="status-badge" style="background:${isDraft ? '#94a3b8' : supervisorStatusColor}">${isDraft ? 'پیش‌نویس' : supervisorStatusText}</span>
            <span class="status-badge" style="background:${articleStatusColor}">${articleStatusText}</span>
        </div>
    </div>
    ${messageHTML}
    <div class="collapsible-details">
        <div class="details-grid">
            <div style="display:flex; align-items:center; gap:5px;">
                <strong>استاد:</strong> ${article.supervisorName || '-'}
                ${btnSupInfo}
            </div>
            <div><strong>حیطه:</strong> ${article.knowledgeArea || '-'}</div>
            <div><strong>تاریخ بروزرسانی:</strong> ${new Date().toLocaleDateString('fa-IR')}</div>
        </div>
        <div class="article-actions">
            ${actionButtons}
            ${btnView}
            ${btnHistory}
            ${btnPDF}
            ${btnDelete}
        </div>
    </div>
    <div class="card-separator-strip">
         <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span>
    </div>`;
}

function bindArticleCardEvents(card, article) {
    const toggle = () => card.classList.toggle('expanded');
    card.querySelector('.article-header').onclick = toggle;
    card.querySelector('.card-separator-strip').onclick = toggle;
    
    const viewBtn = card.querySelector('.btn-view');
    if (viewBtn) viewBtn.onclick = (e) => { e.stopPropagation(); showEditArticleWizard(article); };
    
    const histBtn = card.querySelector('.btn-history');
    if (histBtn) histBtn.onclick = (e) => { e.stopPropagation(); handleShowHistory(article.articleId, article.title, e.target); };
    
    const delBtn = card.querySelector('.btn-delete');
    if (delBtn) delBtn.onclick = (e) => { e.stopPropagation(); handleDeleteArticle(article.articleId, e.target); };

    const pdfBtn = card.querySelector('.btn-download-pdf');
    if (pdfBtn) pdfBtn.onclick = (e) => { e.stopPropagation(); generatePdf(article, e.target); };
    
    const finalRevBtn = card.querySelector('.btn-send-final-review');
    if (finalRevBtn) finalRevBtn.onclick = (e) => { e.stopPropagation(); handleSendForFinalReview(article.articleId, e.target); };

    const rereviewBtn = card.querySelector('.btn-rereview');
    if (rereviewBtn) rereviewBtn.onclick = (e) => { e.stopPropagation(); handleRequestReReviewClick(article, e.target); };

    const resubFinalBtn = card.querySelector('.btn-resubmit-final');
    if (resubFinalBtn) resubFinalBtn.onclick = (e) => { e.stopPropagation(); handleRequestFinalRevisionsClick(article, e.target); };

    // <<<< دستور پنجم: هندلر دکمه اطلاعات استاد >>>>
    const supInfoBtn = card.querySelector('.btn-sup-info');
    if (supInfoBtn) {
        supInfoBtn.onclick = (e) => {
            e.stopPropagation();
            showSupervisorDetailsModal(article, article.supervisorName);
        };
    }
}

// --- Other Action Handlers ---
async function generatePdf(article, button) {
    const user = getStoredUser();
    showToast('در حال ایجاد PDF...', 'info');
    const response = await callApi('generateArticlePdf', { nationalId: user.nationalId, articleId: article.articleId }, button);
    if (response?.status === 'success') {
        downloadBase64File(response.data);
        showToast('دانلود آغاز شد', 'success');
    } else {
        showToast('خطا در ایجاد PDF', 'error');
    }
}

function downloadBase64File({ filename, mimeType, content }) {
    const byteCharacters = atob(content);
    const byteNumbers = new Array(byteCharacters.length);
    for (let i = 0; i < byteCharacters.length; i++) { byteNumbers[i] = byteCharacters.charCodeAt(i); }
    const blob = new Blob([new Uint8Array(byteNumbers)], { type: mimeType });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

async function handleSendForFinalReview(articleId, button) {
    showCustomConfirm('ارسال برای داوری نهایی؟ پس از این ویرایش قفل می‌شود.', async (confirmed, btn, closeModal) => {
        if (confirmed) {
            const user = getStoredUser();
            const response = await callApi('sendForFinalReview', { articleId, nationalId: user.nationalId }, button); 
            closeModal();
            if (response?.status === 'success') {
                showToast('ارسال موفقیت‌آمیز بود', 'success');
                loadArticles(user.nationalId, false);
            } else {
                showToast(response.message || 'خطا', 'error');
            }
        } else { closeModal(); }
    });
}

function handleRequestReReviewClick(article, button) {
    const modalContent = `
        <div class="modal-body">
            <div class="editor-feedback-notice" style="margin-bottom:15px;"><strong>درخواست:</strong> ${article.rejectionReason}</div>
            <div class="form-group"><label>توضیحات اصلاحات</label><textarea id="revision-notes" rows="4"></textarea></div>
        </div>
        <div class="modal-footer"><button id="send-rev-btn" class="btn-info">ارسال اصلاحیه</button></div>
    `;
    renderModal('ارسال اصلاحیه', modalContent, 'modal-sm');
    document.getElementById('send-rev-btn').onclick = async () => {
        const notes = document.getElementById('revision-notes').value;
        if(!notes) return showToast('توضیحات الزامی است', 'error');
        const user = getStoredUser();
        const res = await callApi('submitRevisions', { articleId: article.articleId, nationalId: user.nationalId, revisionNotes: notes }, document.getElementById('send-rev-btn'));
        if(res?.status === 'success') {
            closeModalById('main-modal');
            showToast('ارسال شد', 'success');
            loadArticles(user.nationalId, false);
        } else { showToast('خطا', 'error'); }
    };
}

function handleRequestFinalRevisionsClick(article, button) {
    const modalContent = `
        <div class="modal-body">
            <div class="editor-feedback-notice rejected" style="margin-bottom:15px;"><strong>پیام داور:</strong> ${article.rejectionReason}</div>
            <div class="form-group"><label>توضیحات نهایی</label><textarea id="final-notes" rows="4"></textarea></div>
        </div>
        <div class="modal-footer"><button id="send-final-rev-btn" class="btn-info">ارسال نهایی</button></div>
    `;
    renderModal('ارسال ویرایش نهایی', modalContent, 'modal-sm');
    document.getElementById('send-final-rev-btn').onclick = async () => {
        const notes = document.getElementById('final-notes').value;
        if(!notes) return showToast('توضیحات الزامی است', 'error');
        const user = getStoredUser();
        const res = await callApi('submitFinalRevisions', { articleId: article.articleId, nationalId: user.nationalId, revisionNotes: notes }, document.getElementById('send-final-rev-btn'));
        if(res?.status === 'success') {
            closeModalById('main-modal');
            showToast('ارسال شد', 'success');
            loadArticles(user.nationalId, false);
        } else { showToast('خطا', 'error'); }
    };
}

async function handleShowHistory(articleId, title, button) {
    const skeletonHTML = `
        <div style="padding:15px 0; border-bottom:1px solid #eee;">
            <div class="skeleton skeleton-text" style="width:40%; height:16px;"></div>
            <div class="skeleton skeleton-text" style="width:20%; height:12px; margin-top:5px;"></div>
        </div>
        <div style="padding:15px 0; border-bottom:1px solid #eee;">
            <div class="skeleton skeleton-text" style="width:40%; height:16px;"></div>
            <div class="skeleton skeleton-text" style="width:20%; height:12px; margin-top:5px;"></div>
        </div>`;
    
    renderModal(`تاریخچه: ${title}`, `<div id="hist-body" class="modal-body">${skeletonHTML}</div>`, 'modal-sm');
    const user = getStoredUser();
    const res = await callApi('getArticleHistory', { nationalId: user.nationalId, articleId }, button);
    const body = document.getElementById('hist-body');
    if (res?.status === 'success') {
        if (!res.history.length) { body.innerHTML = '<p style="text-align:center;">سابقه‌ای موجود نیست</p>'; return; }
        const list = res.history.map(h => `
            <div style="margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #eee;">
                <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:0.9rem;">
                    <span>${h.action}</span>
                    <span style="color:var(--text-muted); font-size:0.8rem;">${new Date(h.timestamp).toLocaleString('fa-IR')}</span>
                </div>
                <div style="font-size:0.85rem; color:var(--text-muted); margin-top:4px;">${h.details || ''}</div>
            </div>`).join('');
        body.innerHTML = list;
    } else { body.innerHTML = '<p style="color:red; text-align:center;">خطا در دریافت</p>'; }
}

// --- New Article Modal & Wizards ---
function showNewArticleModal() {
    window.selectedSupervisor = null;
    const modalContent = `
    <div class="modal-body">
        <div id="wizard-steps">
            <!-- Step 1 -->
            <div class="wizard-step active" data-step="1">
                <h4>1. مشخصات سازمانی</h4>
                <div class="form-group"><label>پایه/مدرک</label><input id="aff-level" required></div>
                <div class="form-group"><label>رشته تحصیلی</label><input id="aff-field" required></div>
                <div class="form-group"><label>موسسه/مدرسه</label><input id="aff-institute" required></div>
                <div class="form-group"><label>شهر</label><input id="aff-location" required></div>
            </div>
            <!-- Step 2 -->
            <div class="wizard-step hidden" data-step="2">
                <h4>2. اطلاعات پایه مقاله</h4>
                <div class="form-group">
                    <label>عنوان مقاله 
                        <i class="fas fa-lightbulb" id="suggest-btn" style="color:var(--warning); cursor:pointer; margin-right:5px;"></i>
                        <span style="font-size:0.8rem; color:var(--text-muted);">برای مشاهده عناوین پیشنهادی کلیک کنید</span>
                    </label>
                    <input id="new-article-title" required>
                </div>
                <div class="form-group">
                    <label>حیطه دانشی</label>
                    <select id="new-knowledge-area">${getKnowledgeAreaOptions()}</select>
                </div>
            </div>
            <!-- Step 3 -->
            <div class="wizard-step hidden" data-step="3">
                <h4>3. انگیزه پژوهش</h4>
                <div class="form-group"><label>دلیل انتخاب موضوع</label><textarea id="new-topic-reason" rows="5" required></textarea></div>
            </div>
            <!-- Step 4 -->
            <div class="wizard-step hidden" data-step="4">
                <h4>4. انتخاب استاد راهنما</h4>
                <div id="new-supervisor-container"></div>
            </div>
        </div>
    </div>
    <div class="modal-footer" style="justify-content:space-between;">
        <button id="wiz-prev" class="btn-secondary" style="visibility:hidden;">قبلی</button>
        <div style="display:flex; gap:10px;">
            <div id="wiz-final-actions" class="hidden">
                <button id="draft-btn" class="btn-secondary">پیش‌نویس</button>
                <button id="submit-btn" class="btn-primary">ثبت نهایی</button>
            </div>
            <button id="wiz-next" class="btn-primary">بعدی <i class="fas fa-arrow-left"></i></button>
        </div>
    </div>`;
    
    renderModal('ثبت مقاله جدید', modalContent, 'modal-lg');
    
    document.getElementById('suggest-btn').onclick = async (e) => {
        const btn = e.target;
        btn.classList.add('blinking-yellow'); 
        showToast('در حال دریافت پیشنهادات...', 'info');
        
        try {
            const res = await callApi('getSuggestedTitles', {}, null);
            if(res?.status === 'success') {
                let html = '<div class="modal-body">';
                res.titles.forEach(t => { 
                    // <<<< دستور چهارم الف: نمایش نام استاد پیشنهاد دهنده >>>>
                    const supText = t.proposerName ? `<br><span style="font-size:0.8rem; color:var(--text-muted);">پیشنهاد دهنده: ${t.proposerName}</span>` : '';
                    html += `<div style="padding:10px; border-bottom:1px solid #eee; cursor:pointer;" onclick="selectTitle('${t.title}')"><strong>${t.title}</strong>${supText}</div>`; 
                });
                html += '</div>';
                window.selectTitle = (t) => { document.getElementById('new-article-title').value = t; closeModalById('sub-modal'); };
                renderModal('عناوین پیشنهادی', html, 'modal-sm', true);
            } else { showToast('پیشنهادی یافت نشد', 'error'); }
        } finally {
            btn.classList.remove('blinking-yellow'); 
        }
    };

    let step = 1;
    const updateWiz = () => {
        document.querySelectorAll('.wizard-step').forEach(d => d.classList.add('hidden'));
        document.querySelector(`.wizard-step[data-step="${step}"]`).classList.remove('hidden');
        document.getElementById('wiz-prev').style.visibility = step > 1 ? 'visible' : 'hidden';
        document.getElementById('wiz-next').classList.toggle('hidden', step === 4);
        document.getElementById('wiz-final-actions').classList.toggle('hidden', step !== 4);
        
        if (step === 4 && !document.getElementById('new-supervisor-container').hasChildNodes()) {
            loadSupervisorSelector('new-supervisor-container', (s) => window.selectedSupervisor = s);
        }
    };

    document.getElementById('wiz-next').onclick = () => {
        let valid = true;
        if(step===1) valid = ['aff-level','aff-field','aff-institute','aff-location'].every(id => document.getElementById(id).value);
        if(step===2) valid = document.getElementById('new-article-title').value && document.getElementById('new-knowledge-area').value;
        if(step===3) valid = document.getElementById('new-topic-reason').value;
        if(valid) { step++; updateWiz(); } else { showToast('لطفاً فیلدها را پر کنید', 'error'); }
    };
    document.getElementById('wiz-prev').onclick = () => { step--; updateWiz(); };
    
    document.getElementById('submit-btn').onclick = (e) => handleNewArticleSubmit(e, false);
    document.getElementById('draft-btn').onclick = (e) => handleNewArticleSubmit(e, true);
}

// <<<< دستور چهارم ب: نمایش داوری های موفق و دکمه درباره استاد >>>>
function loadSupervisorSelector(containerId, onSelect) {
    const container = document.getElementById(containerId);
    container.innerHTML = `
        <div style="position:relative; margin-bottom:15px;">
            <input id="sup-search" placeholder="جستجوی نام استاد..." style="padding-left:35px;">
            <i class="fas fa-search" style="position:absolute; left:10px; top:12px; color:#999;"></i>
        </div>
        <div id="sup-results" style="height:250px; overflow-y:auto; border:1px solid #eee; border-radius:8px;">
            <div class="content-loader"></div>
        </div>
    `;
    
    let term = '';
    const fetchSup = async () => {
        const res = await callApi('getSupervisors', { searchTerm: term, page: 1 });
        const list = document.getElementById('sup-results');
        list.innerHTML = '';
        if(res?.status === 'success') {
            res.supervisors.forEach(s => {
                const div = document.createElement('div');
                div.style.padding = '12px'; div.style.borderBottom = '1px solid #f0f0f0';
                div.style.display = 'flex'; div.style.justifyContent = 'space-between'; div.style.alignItems = 'center';
                
                let statusBadge = '';
                if(s.isFull) statusBadge = '<span class="supervisor-tag full">تکمیل</span>';
                else if(!s.isActive) statusBadge = '<span class="supervisor-tag inactive">غیرفعال</span>';
                else statusBadge = '<span class="supervisor-tag active">فعال</span>';

                const divStyle = (!s.isActive || s.isFull) ? 'opacity:0.6; cursor:not-allowed; background:#f9fafb;' : 'cursor:pointer;';
                div.setAttribute('style', `padding:12px; border-bottom:1px solid #f0f0f0; display:flex; justify-content:space-between; align-items:center; ${divStyle}`);
                
                div.innerHTML = `
                    <div>
                        <div style="font-weight:bold;">${s.name}</div>
                        <div style="font-size:0.8rem; color:var(--text-muted);">داوری های موفق: ${s.successfulReviews}</div>
                    </div>
                    <div style="display:flex; gap:5px; align-items:center;">
                        <button class="btn-secondary btn-sm about-sup-btn" style="padding:2px 8px; font-size:0.7rem;">درباره</button>
                        ${statusBadge}
                    </div>
                `;
                
                // هندل کردن دکمه درباره استاد (جلوگیری از انتخاب هنگام کلیک روی دکمه)
                div.querySelector('.about-sup-btn').onclick = (e) => {
                    e.stopPropagation();
                    const details = {
                        supervisorReviews: s.successfulReviews,
                        supervisorContact: s.contact,
                        supervisorAbout: s.description
                    };
                    showSupervisorDetailsModal(details, s.name);
                };

                if(s.isActive && !s.isFull) {
                    div.onclick = () => {
                        onSelect(s);
                        Array.from(list.children).forEach(c => {
                             if (!c.querySelector('.supervisor-tag.full') && !c.querySelector('.supervisor-tag.inactive')) c.style.background = 'white';
                        });
                        div.style.background = '#e0f2fe';
                    };
                }
                list.appendChild(div);
            });
        }
    };
    document.getElementById('sup-search').addEventListener('input', (e) => { term = e.target.value; setTimeout(fetchSup, 500); });
    fetchSup();
}

// Utils
function showSupervisorModal(target, onSelect) {
    const html = `<div class="modal-body" id="sup-mod-con"></div>`;
    renderModal('انتخاب استاد', html, 'modal-sm', true);
    loadSupervisorSelector('sup-mod-con', (s) => { onSelect(s); closeModalById('sub-modal'); });
}

function showAffiliationModal(target, val, onSave) {
    const [l, f, i, loc] = (val || '').split('،').map(s=>s.trim());
    const html = `
        <div class="modal-body">
            <div class="form-group"><label>پایه</label><input id="m-l" value="${l||''}"></div>
            <div class="form-group"><label>رشته</label><input id="m-f" value="${f||''}"></div>
            <div class="form-group"><label>موسسه</label><input id="m-i" value="${i||''}"></div>
            <div class="form-group"><label>شهر</label><input id="m-loc" value="${loc||''}"></div>
        </div>
        <div class="modal-footer"><button id="m-save" class="btn-primary">ثبت</button></div>`;
    renderModal('ویرایش وابستگی', html, 'modal-sm', true);
    document.getElementById('m-save').onclick = () => {
        const res = [document.getElementById('m-l').value, document.getElementById('m-f').value, document.getElementById('m-i').value, document.getElementById('m-loc').value].filter(Boolean).join('، ');
        onSave(res); closeModalById('sub-modal');
    };
}

function getKnowledgeAreaOptions(sel) {
    const areas = ["فقه", "اصول", "اخلاق", "کلام", "تفسیر", "ترجمه", "فلسفه", "عرفان", "حدیث", "رجال", "درایه", "صرف", "نحو", "بلاغت", "مشاوره", "تربیتی", "روانشناسی"];
    return areas.map(a => `<option value="${a}" ${sel === a ? 'selected' : ''}>${a}</option>`).join('');
}

function handleLogout() { localStorage.removeItem('currentUser'); window.location.reload(); }
function storeUser(u) { localStorage.setItem('currentUser', JSON.stringify(u)); }
function getStoredUser() { try { return JSON.parse(localStorage.getItem('currentUser')); } catch(e){ return null; } }

function renderModal(title, content, sizeClass = '', isSub = false) {
    const id = isSub ? 'sub-modal' : 'main-modal';
    const existing = document.getElementById(id);
    if(existing) existing.remove();
    
    const overlay = document.createElement('div');
    overlay.id = id; overlay.className = 'modal-overlay';
    if (isSub) overlay.style.zIndex = '1100'; 
    
    overlay.innerHTML = `
        <div class="modal-box ${sizeClass}">
            <div class="modal-header"><h3>${title}</h3><button class="modal-close-btn"><i class="fas fa-times"></i></button></div>
            ${content}
        </div>`;
    
    modalContainer.appendChild(overlay);
    setTimeout(() => overlay.classList.add('visible'), 10);
    overlay.querySelector('.modal-close-btn').onclick = () => overlay.remove();
}

function closeModalById(id) { const m = document.getElementById(id); if(m) m.remove(); }
function closeAllModals() { modalContainer.innerHTML = ''; }

function getStatusInfo(type, code) {
    const map = { '0': ['رد شده', '#ef4444'], '1': ['بررسی اولیه', '#f59e0b'], '2': ['نیاز به اصلاح', '#f59e0b'], '4': ['انصراف استاد', '#64748b'], '5': ['پذیرش نهایی', '#10b981'], '9': ['پیش‌نویس', '#94a3b8'], '10': ['اصلاح نهایی', '#ef4444'], '11': ['داوری نهایی', '#3b82f6'] };
    return map[String(code)] || ['در جریان', '#3b82f6'];
}

// ==========================================================
// File: Index.html (اصلاح شده طبق دستورات)
// ==========================================================

/*
<!DOCTYPE html> 
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>پنل کاربری محققین</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="toast-container"></div>
    <div id="alert-container"></div>
    
    <!-- Login Page -->
    <div id="login-page">
        <div class="login-wrapper">
            <div class="login-box fade-in">
                <div class="login-header-strip"></div>
                <div class="login-content">
                    <div class="login-logo-area">
                        <i class="fas fa-university fa-3x" style="color: var(--primary);"></i>
                    </div>
                    <h3 style="margin-top: 15px; color: var(--text-muted); font-size: 1rem; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">موسسه تعالی اندیشه و رشد</h3>
                    <h2 style="color: var(--primary-dark);">پنل محققان نشریه</h2>
                    <p class="login-subtitle">سامانه جامع مدیریت مقالات و تحقیقات علمی</p>
                    <form id="login-form">
                        <div class="form-group">
                            <label for="national-id"><i class="fas fa-user-shield"></i> نام کاربری</label>
                            <input type="text" id="national-id" required placeholder="کد ملی خود را وارد کنید">
                        </div>
                        <div class="form-group">
                            <label for="password"><i class="fas fa-key"></i> رمز عبور</label>
                            <input type="password" id="password" required placeholder="رمز عبور خود را وارد کنید">
                        </div>
                        <button type="submit" id="login-btn" style="width: 100%;">
                            <span class="btn-text">ورود به سامانه</span>
                        </button>
                        <p id="login-error" style="color: #dc2626; margin-top: 20px; min-height: 20px; font-size: 0.9rem; font-weight: 500;"></p>
                    </form>
                </div>
            </div>
            <div class="login-footer">
                &copy; تمامی حقوق برای موسسه تعالی اندیشه محفوظ است.
            </div>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboard-page" class="hidden">
        <div class="container fade-in">
            <!-- Header -->
            <div class="dashboard-header">
                <div class="header-text-container">
                    <div id="header-greeting" class="header-greeting">خوش آمدید</div>
                </div>
                <div class="header-actions">
                    <button id="refresh-btn" class="icon-btn-circle" title="بروزرسانی لیست"><i class="fas fa-sync-alt"></i></button>
                    
                    <div class="user-menu">
                        <button id="user-menu-btn" class="icon-btn-circle"><i class="fas fa-user-tie"></i></button>
                        <div id="user-menu-dropdown" class="user-menu-content hidden">
                            <div style="padding: 15px; background: #f8fafc; border-radius: var(--radius-md); margin-bottom: 8px; border: 1px solid #e2e8f0;">
                                <strong id="menu-user-name" style="display:block; color:var(--primary-dark);">کاربر</strong>
                                <span id="menu-user-nid" style="display:block; font-size:0.8rem; color:var(--text-muted); margin-top:2px;"></span>
                                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed #cbd5e1; font-size: 0.9rem; color: var(--success); font-weight: 700;">
                                    امتیاز کل: <span id="menu-user-score">0</span>
                                </div>
                            </div>
                            <!-- دستور دوم: دکمه تغییر رمز با ID مشخص -->
                            <button id="change-pass-btn" class="menu-item"><i class="fas fa-key" style="margin-left:8px; width:20px;"></i> تغییر رمز عبور</button>
                            <!-- دستور سوم: حذف دکمه افزودن شماره تلفن -->
                            <div style="height:1px; background:#e2e8f0; margin:5px 0;"></div>
                            <button id="logout-btn" class="menu-item" style="color: var(--danger);"><i class="fas fa-sign-out-alt" style="margin-left:8px; width:20px;"></i> خروج</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="dashboard-content">
                <!-- Stat Pills -->
                <div id="summary-dashboard" class="summary-grid">
                    <div class="summary-card">
                        <span class="count" id="stat-inprogress-count">--</span>
                        <span class="label">در جریان</span>
                    </div>
                    <div class="summary-card accepted">
                        <span class="count" id="stat-accepted-count">--</span>
                        <span class="label">پذیرفته شده</span>
                    </div>
                    <div class="summary-card rejected">
                        <span class="count" id="stat-rejected-count">--</span>
                        <span class="label">رد شده</span>
                    </div>
                </div>

                <div class="tabs-nav" id="article-tabs">
                    <button class="tab-item active" data-status-filter="all">همه مقالات</button>
                    <button class="tab-item" data-status-filter="inProgress">در جریان</button>
                    <button class="tab-item" data-status-filter="accepted">پذیرفته شده</button>
                    <button class="tab-item" data-status-filter="rejected">رد شده</button>
                    <button class="tab-item" data-status-filter="drafts">پیش‌نویس</button>
                </div>

                <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; align-items: center;">
                    <div style="flex-grow: 1; position: relative;">
                        <input type="text" id="article-search-input" placeholder="جستجو در عنوان، شناسه..." style="padding-left: 40px; border-radius: 8px; border: 1px solid #cbd5e1; height: 45px;">
                        <i class="fas fa-search" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8;"></i>
                    </div>
                    <button id="add-new-article-btn" class="btn-primary" style="height: 45px;">
                        <i class="fas fa-plus"></i><span class="btn-text">ثبت مقاله جدید</span>
                    </button>
                </div>

                <div id="articles-container"></div>
                <div id="load-more-container" style="text-align: center; margin-top: 30px;"></div>
            </div>
        </div>
    </div>
    <div id="modal-container"></div>
    <script src="script.js"></script>
</body>
</html>
*/

// ==========================================================
// File: Style.css (بدون تغییر، اما برای اطمینان مجددا آورده شده)
// ==========================================================

/*
@import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@200;300;400;500;600;700;800;900&display=swap');

:root {
    --primary: #1e3a8a;
    --primary-light: #e0e7ff;
    --primary-dark: #172554;
    --secondary: #64748b;
    --text-main: #1e293b;
    --text-muted: #64748b;
    --bg-body: #f8fafc;
    --bg-glass: rgba(255, 255, 255, 0.95);
    --success: #15803d;
    --success-bg: #dcfce7;
    --danger: #b91c1c;
    --danger-bg: #fee2e2;
    --warning: #b45309;
    --warning-bg: #fef3c7;
    --info: #1d4ed8;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
    --radius-xl: 12px;
    --radius-lg: 8px;
    --radius-md: 6px;
    --radius-sm: 4px;
    --transition-fast: 0.2s ease;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
body { font-family: 'Vazirmatn', sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; }
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: #f1f5f9; }
::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
.hidden { display: none !important; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.fade-in { animation: fadeIn 0.4s ease-out forwards; }
body.login-view { background-color: #f0f2f5; background-image: radial-gradient(#e2e8f0 1px, transparent 1px); background-size: 20px 20px; justify-content: center; align-items: center; }
.login-wrapper { width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
.login-box { background: #ffffff; border: 1px solid #e2e8f0; border-radius: var(--radius-lg); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); width: 100%; max-width: 400px; text-align: center; overflow: hidden; }
.login-header-strip { height: 6px; background: var(--primary); width: 100%; }
.login-content { padding: 40px 30px; }
.login-logo-area { margin-bottom: 20px; display: inline-block; padding: 15px; background: var(--primary-light); border-radius: 50%; }
.login-subtitle { color: var(--text-muted); margin-bottom: 30px; font-size: 0.9rem; }
.login-box .form-group label { color: var(--text-main); text-align: right; margin-bottom: 6px; font-size: 0.9rem; font-weight: 600; }
.login-box input { background: #f8fafc; border: 1px solid #cbd5e1; color: var(--text-main); border-radius: var(--radius-md); padding: 12px; transition: var(--transition-fast); }
.login-box input:focus { background: #fff; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
.login-footer { margin-top: 20px; font-size: 0.8rem; color: var(--text-muted); }
.container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 20px; }
h1, h2, h3, h4 { margin-top: 0; color: var(--text-main); font-weight: 700; }
.form-group { margin-bottom: 20px; text-align: right; }
label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: var(--text-main); }
input, select, textarea { width: 100%; padding: 10px 14px; border: 1px solid #cbd5e1; border-radius: var(--radius-md); font-family: inherit; font-size: 0.95rem; background: #ffffff; transition: all 0.2s ease; color: var(--text-main); }
input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
button { padding: 8px 16px; border: none; border-radius: var(--radius-md); font-family: inherit; font-weight: 500; font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; position: relative; user-select: none; }
button:active { transform: translateY(1px); }
.btn-primary { background-color: var(--primary); color: white; }
.btn-primary:hover { background-color: var(--primary-dark); box-shadow: 0 4px 6px rgba(30, 58, 138, 0.2); }
.btn-secondary { background-color: white; color: var(--text-main); border: 1px solid #cbd5e1; }
.btn-secondary:hover { background-color: #f1f5f9; border-color: #94a3b8; }
.btn-success { background-color: var(--success); color: white; }
.btn-success:hover { background-color: #166534; }
.btn-danger { background-color: var(--danger); color: white; }
.btn-danger:hover { background-color: #991b1b; }
.btn-info { background-color: var(--info); color: white; }
.btn-info:hover { background-color: #1e40af; }
.btn-sm { padding: 6px 12px; font-size: 0.8rem; border-radius: 6px; }
#login-btn { background: var(--primary); color: #fff; font-weight: 700; border: none; margin-top: 10px; height: 44px; }
#login-btn:hover { background: var(--primary-dark); }
.btn-loading { color: transparent !important; pointer-events: none; position: relative; }
.btn-loading::after { content: ''; position: absolute; top: 50%; left: 50%; width: 18px; height: 18px; margin-left: -9px; margin-top: -9px; border: 2px solid rgba(255,255,255,0.4); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
#login-btn.btn-loading::after { border-color: rgba(255,255,255, 0.2); border-top-color: white; }
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes blinkYellow { 0% { color: var(--warning); text-shadow: none; } 50% { color: #fde047; text-shadow: 0 0 8px #fde047; transform: scale(1.1); } 100% { color: var(--warning); text-shadow: none; } }
.blinking-yellow { animation: blinkYellow 0.6s infinite; }
.dashboard-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; margin-bottom: 25px; background: transparent; border-bottom: 1px solid #e2e8f0; }
.header-text-container { display: flex; align-items: center; }
.header-greeting { font-size: 1.5rem; font-weight: 800; color: var(--text-main); margin: 0; }
.header-actions { display: flex; align-items: center; gap: 10px; }
.icon-btn-circle { width: 40px; height: 40px; border-radius: 50%; background: white; border: 1px solid #e2e8f0; color: var(--text-muted); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; transition: var(--transition-fast); }
.icon-btn-circle:hover { color: var(--primary); border-color: var(--primary-light); background: #f8fafc; }
.summary-grid { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 30px; }
.summary-card { background: white; padding: 15px 25px; border-radius: var(--radius-lg); border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 15px; flex: 1; min-width: 140px; box-shadow: var(--shadow-sm); }
.summary-card::before { font-family: "Font Awesome 6 Free"; font-weight: 900; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-left: 5px; }
.summary-card:first-child::before { content: '\f017'; color: var(--primary); }
.summary-card.accepted::before { content: '\f058'; color: var(--success); }
.summary-card.rejected::before { content: '\f057'; color: var(--danger); }
.summary-card .count { font-size: 1.5rem; font-weight: 800; color: var(--text-main); min-width: 30px; display: inline-block; text-align: center; }
.summary-card .label { font-size: 0.9rem; color: var(--text-muted); font-weight: 500; display: block; white-space: nowrap; }
.tabs-nav { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
.tab-item { background: white; border: 1px solid #cbd5e1; padding: 6px 16px; border-radius: 20px; color: var(--text-muted); font-weight: 500; cursor: pointer; white-space: nowrap; transition: all 0.2s ease; font-size: 0.9rem; }
.tab-item:hover { background: #f1f5f9; color: var(--text-main); }
.tab-item.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 2px 5px rgba(30, 58, 138, 0.3); }
.article-card { background: white; border-radius: var(--radius-lg); border: 1px solid #e2e8f0; margin-bottom: 15px; border-right: 4px solid var(--secondary); transition: all 0.2s ease; position: relative; overflow: hidden; padding: 0; }
.article-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: #cbd5e1; }
.article-header { padding: 18px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
.article-title { font-size: 1.05rem; font-weight: 700; color: var(--text-main); margin-bottom: 4px; }
.status-badges { display: flex; gap: 6px; flex-wrap: wrap; }
.status-badge { padding: 3px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; color: white; }
.collapsible-details { max-height: 0; overflow: hidden; opacity: 0; will-change: max-height, opacity, padding; transition: max-height 0.4s ease, opacity 0.3s ease, padding 0.3s ease; background: #fdfdfd; padding: 0 20px; }
.article-card.expanded .collapsible-details { max-height: 800px; opacity: 1; border-top: 1px solid #f1f5f9; padding: 15px 20px; }
.details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px; }
.details-grid div { font-size: 0.85rem; color: var(--text-muted); }
.details-grid strong { color: var(--text-main); }
.article-actions { display: flex; justify-content: flex-end; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
.card-separator-strip { height: 24px; background: #f8fafc; border-top: 1px solid #f1f5f9; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: background 0.2s; }
.card-separator-strip:hover { background: #f1f5f9; }
.toggle-icon { transition: transform 0.3s; color: var(--text-muted); font-size: 0.8rem; }
.article-card.expanded .toggle-icon { transform: rotate(180deg); color: var(--primary); }
.editor-feedback-notice { margin: 10px 20px; padding: 10px 14px; background: var(--warning-bg); border-radius: var(--radius-md); color: #92400e; font-size: 0.85rem; border-right: 3px solid var(--warning); }
.editor-feedback-notice.rejected { background: var(--danger-bg); color: #991b1b; border-color: var(--danger); }
.modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); opacity: 0; pointer-events: none; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s; }
.modal-overlay.visible { opacity: 1; pointer-events: auto; visibility: visible; }
.modal-box { background: white; width: 95%; max-width: 500px; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); display: flex; flex-direction: column; max-height: 90vh; overflow: hidden; transform: scale(0.98); transition: transform 0.3s ease; opacity: 0; }
.modal-overlay.visible .modal-box { transform: scale(1); opacity: 1; }
.modal-box.modal-lg { max-width: 1000px; height: 85vh; }
.modal-header { padding: 12px 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
.modal-header h3 { margin: 0; font-size: 1rem; color: var(--text-main); }
.modal-close-btn { background: none; border: none; font-size: 1.1rem; color: var(--text-muted); cursor: pointer; padding: 4px; }
.modal-close-btn:hover { color: var(--danger); }
.modal-body { flex-grow: 1; overflow-y: auto; padding: 20px; position: relative; }
.modal-footer { padding: 12px 20px; border-top: 1px solid #e2e8f0; background: #f8fafc; display: flex; justify-content: flex-end; gap: 10px; }
.split-editor-container { display: flex; height: 100%; overflow: hidden; background: #f1f5f9; }
.editor-sidebar { width: 220px; background: white; border-left: 1px solid #e2e8f0; display: flex; flex-direction: column; padding: 15px 0; flex-shrink: 0; overflow-y: auto; }
.editor-sidebar h4 { display: none; }
.sidebar-nav-btn { text-align: right; background: transparent; color: var(--text-main); border-radius: 0; padding: 12px 20px; width: 100%; border-right: 3px solid transparent; font-weight: 500; font-size: 0.85rem; justify-content: flex-start; }
.sidebar-nav-btn:hover { background: #f8fafc; color: var(--primary); }
.sidebar-nav-btn.active { background: var(--primary-light); color: var(--primary-dark); border-right-color: var(--primary); font-weight: 700; }
.editor-content { flex-grow: 1; padding: 25px; overflow-y: auto; }
.editor-section { background: white; border-radius: var(--radius-lg); padding: 25px; box-shadow: var(--shadow-sm); border: 1px solid #e2e8f0; animation: fadeIn 0.2s ease-out; }
.skeleton { background: #e2e8f0; animation: pulse 1.5s infinite; border-radius: 4px; }
@keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
.supervisor-tag { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
.supervisor-tag.active { background: var(--success-bg); color: var(--success); }
.supervisor-tag.full { background: #f1f5f9; color: #64748b; }
.supervisor-tag.inactive { background: var(--danger-bg); color: var(--danger); }
#toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; width: 90%; max-width: 380px; }
.toast-notification { background: white; border-radius: var(--radius-md); padding: 12px 18px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 12px; pointer-events: auto; font-size: 0.9rem; font-weight: 500; }
.toast-success { border-right: 4px solid var(--success); }
.toast-success i { color: var(--success); }
.toast-error { border-right: 4px solid var(--danger); }
.toast-error i { color: var(--danger); }
.toast-info { border-right: 4px solid var(--info); }
.toast-info i { color: var(--info); }
.user-menu { position: relative; }
.user-menu-content { position: absolute; top: 110%; left: 0; background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); border: 1px solid #e2e8f0; width: 220px; z-index: 100; padding: 6px; opacity: 0; transform: translateY(-10px); pointer-events: none; transition: 0.2s; }
.user-menu-content:not(.hidden) { opacity: 1; transform: translateY(0); pointer-events: auto; }
.menu-item { width: 100%; text-align: right; background: transparent; padding: 8px 12px; border-radius: var(--radius-sm); color: var(--text-main); font-size: 0.9rem; }
.menu-item:hover { background: #f1f5f9; color: var(--primary); }
.content-loader { width: 30px; height: 30px; border: 3px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
.validation-note { display: flex; justify-content: flex-end; gap: 5px; font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }
.counter.invalid { color: var(--danger); font-weight: bold; }
.ref-manager-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; }
.reference-list li { background: #f8fafc; border: 1px solid #e2e8f0; margin-bottom: 5px; padding: 8px 12px; border-radius: var(--radius-md); display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; }
@media (max-width: 768px) {
    .container { padding: 15px; }
    .summary-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .summary-card { min-width: auto; margin-bottom: 0; }
    .split-editor-container { flex-direction: column; }
    .editor-sidebar { width: 100%; height: auto; border-left: none; border-bottom: 1px solid #e2e8f0; padding: 5px; flex-direction: row; overflow-x: auto; white-space: nowrap; align-items: center; }
    .sidebar-nav-btn { width: auto; padding: 8px 15px; border-right: none; border-bottom: 3px solid transparent; font-size: 0.85rem; margin-bottom: 0; }
    .sidebar-nav-btn.active { border-right: none; border-bottom-color: var(--primary); background: transparent; color: var(--primary); }
    .editor-content { padding: 15px; }
    .modal-box.modal-lg { height: 100%; width: 100%; border-radius: 0; max-height: 100vh; }
    .modal-box { width: 100%; border-radius: 0; }
    .modal-header, .modal-footer { padding: 15px; }
    .dashboard-header { flex-direction: row; align-items: center; }
    .header-greeting { font-size: 1.1rem; }
    .article-header { flex-direction: column; align-items: flex-start; gap: 8px; }
    .status-badges { width: 100%; justify-content: flex-start; margin-top: 5px; }
    .form-group { margin-bottom: 15px; }
}
*/

// ==========================================================
// گزارش تغییرات (Summary of Changes):
// ==========================================================
/*
1. فایل Code.gs:
    - ثابت `AUTH_COLS` به‌روزرسانی شد تا دقیقاً با ساختار فایل "شاهین" مطابقت داشته باشد (ستون D امتیاز کاربر، ستون E نام استاد، ستون F کدملی استاد و...).
    - تابع `changePassword` اضافه شد (دستور دوم) که رمز عبور در ستون C را بررسی و تغییر می‌دهد.
    - در تابع `getSupervisorsList`:
        - ستون J برای وضعیت فعال بودن (عدد 5) بررسی شد (دستور ششم).
        - اطلاعات تعداد داوری موفق (ستون H) و توضیحات استاد (ستون K) به خروجی اضافه شد (دستور چهارم ب).
    - در تابع `getSuggestedTitles`:
        - نام استاد پیشنهاد دهنده از ستون E (همان ردیف) خوانده شد (دستور چهارم الف).
    - تابع `_mapArticleRowToObject`:
        - بهینه شد تا اطلاعات کامل استاد (داوری‌ها، درباره، تماس) را از شیت Auth بخواند و به آبجکت مقاله اضافه کند تا در پاپ‌آپ قابل نمایش باشد (دستور پنجم).

2. فایل Script.js:
    - قابلیت "افزودن شماره تلفن" حذف شد (دستور سوم).
    - دکمه "تغییر رمز عبور" به منوی کاربری اضافه شد و فانکشن `showChangePasswordModal` برای مدیریت آن پیاده‌سازی شد (دستور دوم).
    - در تابع `loadSupervisorSelector`:
        - نمایش "تعداد داوری‌های موفق" اضافه شد.
        - دکمه "درباره استاد" اضافه شد که با کلیک روی آن مودال اطلاعات باز می‌شود (دستور چهارم ب).
    - در تابع `generateArticleCardInnerHTML` و `bindArticleCardEvents`:
        - دکمه/آیکون کوچک کنار نام استاد اضافه شد.
        - کلیک روی این دکمه تابع `showSupervisorDetailsModal` را فراخوانی می‌کند که اطلاعات تماس، داوری‌ها و توضیحات را نشان می‌دهد (دستور پنجم).
    - در تابع `showNewArticleModal`:
        - نمایش نام پیشنهاد دهنده کنار عنوان پیشنهادی اضافه شد (دستور چهارم الف).

3. فایل Index.html:
    - دکمه "ثبت شماره همراه" از منوی کاربری حذف شد.
    - دکمه "تغییر رمز عبور" به منوی کاربری اضافه شد.

4. فایل Style.css:
    - بدون تغییر ساختاری باقی ماند (صرفاً کلاس‌های مورد نیاز از قبل موجود بودند یا به صورت inline style مدیریت شدند).
*/
