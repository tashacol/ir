 
<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل کاربری محققین</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap');

        :root {
            --primary: #2563EB;
            --primary-light: #EFF6FF;
            --primary-hover: #1D4ED8;
            --text-main: #1F2937;
            --text-muted: #6B7280;
            --bg-body: #F3F4F6;
            --bg-card: #FFFFFF;
            --border: #E5E7EB;
            --success: #10B981;
            --success-light: #D1FAE5;
            --danger: #EF4444;
            --danger-light: #FEE2E2;
            --warning: #F59E0B;
            --info: #3B82F6;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 8px;
            --transition: all 0.2s ease-in-out;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
        }

        /* --- استایل صفحه ورود مدرن (دستور اول) --- */
        body.login-view {
            background: linear-gradient(-45deg, #1e3a8a, #2563EB, #0891b2, #0d9488);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            align-items: center;
            padding: 20px;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .hidden { display: none !important; }
        .container { width: 100%; max-width: 1000px; margin: 0 auto; padding-bottom: 40px; }

        .login-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 50px 40px;
            width: 100%;
            max-width: 420px;
            box-sizing: border-box;
            text-align: center;
        }

        .login-box h2 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            font-weight: 800;
            color: #111827;
            letter-spacing: -0.5px;
        }

        .login-subtitle {
            color: var(--text-muted);
            margin-top: 0;
            margin-bottom: 35px;
            font-size: 0.95rem;
        }

        /* حذف لوگو طبق دستور */
        .login-logo { display: none; }

        h1, h2, h3, h4 { color: var(--text-main); font-weight: 700; margin-top: 0; }

        .form-group { margin-bottom: 20px; text-align: right; }
        label { display: block; font-weight: 500; margin-bottom: 8px; color: var(--text-main); font-size: 0.9rem; }
        
        input, select, textarea {
            width: 100%;
            box-sizing: border-box;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.95rem;
            font-family: inherit;
            transition: var(--transition);
            background-color: #fff;
            color: var(--text-main);
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
            outline: none;
        }

        input:disabled, select:disabled, textarea:disabled {
            background-color: #F9FAFB;
            color: #9CA3AF;
            cursor: not-allowed;
        }

        button {
            font-family: inherit;
            padding: 12px 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover:not(:disabled) { background-color: var(--primary-hover); transform: translateY(-1px); }
        button:active:not(:disabled) { transform: translateY(0); }
        button:disabled { background-color: #D1D5DB; cursor: not-allowed; transform: none; }

        button.btn-danger { background-color: var(--danger); }
        button.btn-danger:hover { background-color: #DC2626; }
        button.btn-secondary { background-color: #fff; color: var(--text-main); border: 1px solid var(--border); }
        button.btn-secondary:hover { background-color: #F9FAFB; border-color: #D1D5DB; }
        button.btn-info { background-color: var(--info); }
        button.btn-info:hover { background-color: #2563EB; }
        button.btn-success { background-color: var(--success); }
        button.btn-success:hover { background-color: #059669; }
        
        button.btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
            min-height: auto;
            background-color: #fff;
            color: var(--text-muted);
            border: 1px solid var(--border);
        }
        button.btn-icon:hover { color: var(--primary); border-color: var(--primary); }

        .btn-loading .btn-text, .btn-loading .fas { visibility: hidden; }
        .btn-loading::after {
            content: ''; position: absolute; top: 50%; left: 50%; width: 20px; height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%;
            animation: spin-center 0.8s linear infinite;
        }

        @keyframes spin-center { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }

        /* --- لودینگ (بدون تغییر طبق دستور چهارم) --- */
        .content-loader-wrapper { display: flex; justify-content: center; align-items: center; min-height: 150px; }
        .content-loader { width: 48px; height: 48px; border-radius: 50%; display: inline-block; position: relative; border: 3px solid; border-color: var(--primary) var(--primary) transparent transparent; box-sizing: border-box; animation: spin-content 1.2s linear infinite; }
        .content-loader::after, .content-loader::before { content: ''; box-sizing: border-box; position: absolute; left: 0; right: 0; top: 0; bottom: 0; margin: auto; border: 3px solid; border-color: transparent transparent var(--success) var(--success); width: 40px; height: 40px; border-radius: 50%; animation: spin-content-alt 1s linear infinite; }
        .content-loader::before { width: 32px; height: 32px; border-color: var(--primary) var(--primary) transparent transparent; animation: spin-content 1.5s linear infinite; }
        @keyframes spin-content { to { transform: rotate(360deg); } }
        @keyframes spin-content-alt { to { transform: rotate(-360deg); } }

        /* --- هدر اصلاح شده (دستور سوم) --- */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
        }

        .dashboard-title-wrapper h3 { margin: 0; font-size: 1.4rem; color: #111827; }
        .dashboard-subtitle { font-size: 0.9rem; color: var(--text-muted); font-weight: 400; margin-top: 4px; }

        .header-actions { display: flex; gap: 10px; align-items: center; }

        .user-menu { position: relative; }
        .user-menu-trigger { background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border); border-radius: 50%; width: 44px; height: 44px; min-height: 44px; padding: 0; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: var(--transition); }
        .user-menu-trigger:hover, .user-menu-trigger.active { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }

        .user-menu-content {
            position: absolute;
            top: 120%; left: 0;
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            width: 260px;
            z-index: 100;
            padding: 8px;
            opacity: 0; visibility: hidden; transform: translateY(-10px);
            transition: all 0.2s ease;
        }
        .user-menu-content:not(.hidden) { opacity: 1; visibility: visible; transform: translateY(0); }

        .user-info { padding: 12px; background: var(--bg-body); border-radius: var(--radius); margin-bottom: 8px; text-align: right; }
        .user-info strong { display: block; font-size: 1rem; color: #111827; }
        .user-info span { font-size: 0.85rem; color: var(--text-muted); display: block; margin-top: 2px; }
        .user-score { font-size: 0.85rem; padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); margin-bottom: 8px; color: var(--text-main); }
        .user-score span { background: var(--success-light); color: var(--success); padding: 2px 8px; border-radius: 10px; font-weight: 700; font-size: 0.8rem; }

        /* آیتم‌های منو */
        .menu-item { display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 12px; text-align: right; background: none; border: none; font-size: 0.9rem; color: var(--text-main); border-radius: 6px; min-height: auto; }
        .menu-item:hover { background-color: var(--bg-body); color: var(--primary); }
        .menu-item i { width: 20px; text-align: center; }
        .menu-item.logout { color: var(--danger); }
        .menu-item.logout:hover { background-color: var(--danger-light); }

        /* --- باکس‌های آمار اصلاح شده (دستور دوم) --- */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .summary-card {
            background-color: var(--bg-card);
            padding: 15px 20px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: var(--transition);
        }
        
        .summary-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--primary); }

        .summary-info { display: flex; flex-direction: column; }
        .summary-card .count { font-size: 1.8rem; font-weight: 800; color: #111827; line-height: 1; }
        .summary-card .label { font-size: 0.9rem; color: var(--text-muted); margin-top: 5px; }
        
        .summary-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .summary-card.progress .summary-icon { background-color: var(--primary-light); color: var(--primary); }
        .summary-card.accepted .summary-icon { background-color: var(--success-light); color: var(--success); }
        .summary-card.rejected .summary-icon { background-color: var(--danger-light); color: var(--danger); }

        .skeleton-loader { background-color: #E5E7EB; border-radius: 4px; position: relative; overflow: hidden; }
        .skeleton-loader::after { content: ''; position: absolute; top: 0; right: 0; bottom: 0; left: 0; transform: translateX(-100%); background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent); animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 100% { transform: translateX(100%); } }

        /* --- تب‌ها --- */
        .tabs-nav { display: flex; gap: 8px; margin-bottom: 25px; border-bottom: 1px solid var(--border); padding-bottom: 15px; overflow-x: auto; }
        .tab-item { padding: 8px 16px; cursor: pointer; border: none; background: transparent; color: var(--text-muted); font-weight: 500; border-radius: 20px; transition: var(--transition); font-size: 0.9rem; white-space: nowrap; min-height: auto; }
        .tab-item:hover { background-color: #F3F4F6; color: var(--text-main); }
        .tab-item.active { background-color: var(--primary); color: white; box-shadow: var(--shadow-sm); }

        .dashboard-controls { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 20px; }
        .search-field-wrapper { position: relative; flex-grow: 1; max-width: 400px; }
        .search-field-wrapper input { padding-left: 40px; border-radius: 20px; background-color: #fff; }
        .search-field-wrapper .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

        /* --- لیست کارت‌ها ظریف و زیبا (دستور پنجم) --- */
        #articles-container { display: flex; flex-direction: column; gap: 15px; }

        .article-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            padding: 20px;
            /* حذف border-top و افزودن border-right */
            border-right: 4px solid var(--primary); 
            transition: var(--transition);
            position: relative;
        }

        .article-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateX(-2px); /* حرکت جزئی به چپ */
        }

        .article-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; cursor: pointer; }
        .article-title { font-size: 1.1rem; font-weight: 700; color: #111827; line-height: 1.5; }
        .toggle-icon { color: var(--text-muted); transition: transform 0.3s; margin-top: 2px; }
        .article-card.expanded .toggle-icon { transform: rotate(180deg); color: var(--primary); }

        .status-badges { display: flex; gap: 8px; margin-top: 8px; align-items: center; flex-wrap: wrap; }
        .status-badge { padding: 2px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; color: white; display: inline-block; }

        .collapsible-details { max-height: 0; overflow: hidden; transition: all 0.4s ease; opacity: 0; }
        .article-card.expanded .collapsible-details { max-height: 1000px; margin-top: 20px; opacity: 1; padding-top: 20px; border-top: 1px solid #F3F4F6; }

        .details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; font-size: 0.9rem; margin-bottom: 20px; }
        .details-grid div { display: flex; flex-direction: column; gap: 4px; }
        .details-grid strong { color: var(--text-muted); font-size: 0.8rem; }
        .details-grid span { color: var(--text-main); font-weight: 500; }

        .article-actions { display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap; }
        .article-actions button { font-size: 0.85rem; padding: 8px 16px; min-height: 38px; border-radius: 6px; }

        /* Notice Boxes */
        .notice-box { margin-top: 15px; padding: 12px 16px; border-radius: 6px; font-size: 0.9rem; display: flex; gap: 10px; align-items: flex-start; }
        .notice-box.danger { background: #FEF2F2; color: #991B1B; border: 1px solid #FECACA; }
        .notice-box.success { background: #ECFDF5; color: #065F46; border: 1px solid #A7F3D0; }
        .notice-box.warning { background: #FFFBEB; color: #92400E; border: 1px solid #FDE68A; }
        .notice-box i { margin-top: 3px; }

        /* --- ویرایشگر تمام صفحه جدید (دستور ششم) --- */
        .editor-overlay {
            position: fixed; inset: 0; background: #fff; z-index: 2000;
            display: flex; flex-direction: column; animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .editor-header {
            height: 60px; border-bottom: 1px solid var(--border); display: flex;
            justify-content: space-between; align-items: center; padding: 0 20px;
            background: #fff; box-shadow: var(--shadow-sm); z-index: 10;
        }
        .editor-title { font-size: 1.1rem; font-weight: 700; color: #111827; display: flex; align-items: center; gap: 10px; }
        .editor-close { background: #F3F4F6; color: var(--text-main); border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; font-size: 1.2rem; min-height: auto; }
        .editor-close:hover { background: #E5E7EB; color: var(--danger); }

        .editor-body { display: flex; flex: 1; overflow: hidden; background: #F9FAFB; }
        
        .editor-sidebar {
            width: 260px; background: #fff; border-left: 1px solid var(--border);
            padding: 20px 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px;
        }
        
        .editor-nav-item {
            padding: 12px 15px; border-radius: 8px; cursor: pointer;
            color: var(--text-muted); font-weight: 500; font-size: 0.95rem;
            display: flex; justify-content: space-between; align-items: center;
            transition: all 0.2s;
        }
        .editor-nav-item:hover { background: #F3F4F6; color: var(--text-main); }
        .editor-nav-item.active { background: var(--primary-light); color: var(--primary); font-weight: 700; }
        .editor-nav-item i { width: 20px; text-align: center; }
        .nav-status-icon { font-size: 0.8rem; }
        .nav-status-icon.done { color: var(--success); }
        .nav-status-icon.warning { color: var(--warning); }

        .editor-content { flex: 1; padding: 40px; overflow-y: auto; display: flex; justify-content: center; }
        .paper-sheet {
            background: #fff; width: 100%; max-width: 800px; min-height: 100%;
            padding: 40px; box-shadow: var(--shadow-sm); border-radius: 2px;
            animation: fadeIn 0.4s;
        }

        .editor-section { display: none; }
        .editor-section.active { display: block; }
        
        .editor-section h2 { font-size: 1.5rem; border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-bottom: 20px; color: #111827; }
        .word-count { font-size: 0.85rem; color: var(--text-muted); text-align: left; margin-top: 5px; }
        .word-count.invalid { color: var(--danger); font-weight: 600; }
        
        .save-float-btn {
            position: fixed; bottom: 30px; left: 30px;
            padding: 12px 24px; border-radius: 30px;
            box-shadow: var(--shadow-lg); font-size: 1rem;
        }

        /* --- مودال‌های معمولی --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-box { background: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: var(--shadow-lg); transform: scale(0.95); transition: transform 0.2s; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-overlay.visible .modal-box { transform: scale(1); }
        
        /* سایر استایل‌های عمومی */
        .article-group-title { margin: 30px 0 15px; font-size: 1.1rem; color: var(--text-muted); font-weight: 600; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        .status-loader { width: 16px; height: 16px; border: 2px solid var(--primary-light); border-top-color: var(--primary); border-radius: 50%; animation: spin-center 1s linear infinite; display: inline-block; }
        
        /* استایل‌های رفرنس منیجر در ادیتور */
        .ref-item { display: flex; justify-content: space-between; align-items: flex-start; padding: 12px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 8px; background: #FAFAFA; }
        .ref-item button { color: var(--danger); background: none; border: none; padding: 4px; min-height: auto; }
        
        /* Custom Alert */
        .custom-alert-box { text-align: center; max-width: 400px; }
        .custom-alert-icon { font-size: 3rem; margin-bottom: 15px; display: block; }
        .custom-alert-icon.success { color: var(--success); }
        .custom-alert-icon.error { color: var(--danger); }
        .custom-alert-icon.info { color: var(--info); }
        .custom-alert-icon.confirm { color: var(--warning); }
        .custom-alert-actions { margin-top: 20px; display: flex; justify-content: center; gap: 10px; }

        @media (max-width: 768px) {
            .editor-body { flex-direction: column; }
            .editor-sidebar { width: 100%; height: auto; max-height: 150px; flex-direction: row; overflow-x: auto; border-left: none; border-bottom: 1px solid var(--border); }
            .editor-nav-item { white-space: nowrap; }
            .paper-sheet { padding: 20px; }
            .login-box { padding: 30px 20px; }
        }
    </style>
</head>

<body>
    <div id="alert-container"></div>
    <div class="container">
        
        <!-- صفحه ورود اصلاح شده -->
        <div id="login-page">
            <div class="login-wrapper">
                <div class="login-box">
                    <h2>سامانه پژوهشیار</h2>
                    <p class="login-subtitle">جهت ورود به پنل، اطلاعات کاربری خود را وارد کنید</p>
                    <form id="login-form">
                        <div class="form-group">
                            <label for="national-id">کد ملی</label>
                            <input type="tel" id="national-id" placeholder="مثال: 0123456789" required>
                        </div>
                        <div class="form-group">
                            <label for="password">رمز عبور</label>
                            <input type="password" id="password" placeholder="••••••••" required>
                        </div>
                        <button type="submit" id="login-btn" style="width: 100%;">
                            <span class="btn-text">ورود به سامانه</span>
                        </button>
                        <p id="login-error" style="color: var(--danger); margin-top: 15px; font-size: 0.9rem; min-height: 1.2em;"></p>
                    </form>
                </div>
            </div>
        </div>

        <!-- صفحه داشبورد -->
        <div id="dashboard-page" class="hidden">
            <div class="dashboard-header">
                <div class="dashboard-title-wrapper">
                    <h3>پنل مدیریت مقالات</h3>
                    <h4 id="header-user-name" class="dashboard-subtitle"></h4>
                </div>
                <div class="header-actions">
                    <button id="refresh-btn" class="user-menu-trigger" title="بروزرسانی">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    
                    <div class="user-menu">
                        <button id="user-menu-btn" class="user-menu-trigger" title="منوی کاربری">
                            <i class="fas fa-user"></i>
                        </button>
                        <div id="user-menu-dropdown" class="user-menu-content hidden">
                            <div class="user-info">
                                <strong id="menu-user-name">نام کاربر</strong>
                                <span id="menu-user-nid">کد ملی</span>
                            </div>
                            <div class="user-score">
                                امتیاز پژوهشی
                                <span id="menu-user-score">0</span>
                            </div>
                            
                            <!-- گزینه‌های درخواستی در هدر (داخل منو) -->
                            <button class="menu-item"><i class="fas fa-key"></i> ویرایش رمز عبور</button>
                            <button class="menu-item"><i class="fas fa-phone"></i> افزودن شماره تماس</button>
                            <hr style="border: 0; border-top: 1px solid var(--border); margin: 5px 0;">
                            
                            <button id="logout-btn" class="menu-item logout">
                                <i class="fas fa-sign-out-alt"></i> خروج از حساب
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="dashboard-content">
                <!-- باکس‌های آمار اصلاح شده -->
                <div id="summary-dashboard" class="summary-grid"></div>

                <div class="tabs-nav" id="article-tabs">
                    <button class="tab-item active" data-status-filter="all">همه مقالات</button>
                    <button class="tab-item" data-status-filter="inProgress">در حال پیگیری</button>
                    <button class="tab-item" data-status-filter="accepted">پذیرفته شده</button>
                    <button class="tab-item" data-status-filter="rejected">رد شده</button>
                    <button class="tab-item" data-status-filter="drafts">پیش‌نویس‌ها</button>
                </div>

                <div class="dashboard-controls">
                    <div class="search-field-wrapper">
                        <input type="text" id="article-search-input" placeholder="جستجو در عنوان یا شناسه مقاله...">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    <button id="add-new-article-btn" class="btn-success">
                        <i class="fas fa-plus"></i> <span class="btn-text">ثبت مقاله جدید</span>
                    </button>
                </div>

                <div id="articles-container"></div>
                <div id="load-more-container" style="text-align: center; margin-top: 30px;"></div>
            </div>
        </div>
    </div>
    
    <!-- کانتینر مودال‌ها و ادیتور -->
    <div id="modal-container"></div>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwwTgJU4lbocweggC0zU7XyzzWKg3BhcUcFc5kaeYoD6dsAHVN7A-15L19G32UCa2hB/exec';
        
        const loginPage = document.getElementById('login-page');
        const dashboardPage = document.getElementById('dashboard-page');
        const loginForm = document.getElementById('login-form');
        const modalContainer = document.getElementById('modal-container');
        
        let allUserArticles = [];
        let currentPage = 1;
        let currentSearchTerm = '';
        let isLoading = false;
        let hasMoreArticles = true;
        let currentFilter = 'all';

        // --- Core Functions ---

        async function callApi(action, params = {}, button = null) {
            if (button) button.classList.add('btn-loading');
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action, params })
                });
                if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('API Call Failed:', error);
                return { status: 'error', message: error.message, isNetworkError: true };
            } finally {
                if (button) button.classList.remove('btn-loading');
            }
        }

        function storeUser(user) { localStorage.setItem('currentUser', JSON.stringify(user)); }
        function getStoredUser() { return JSON.parse(localStorage.getItem('currentUser')); }

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            const user = getStoredUser();
            if (user) {
                loginPage.classList.add('hidden');
                dashboardPage.classList.remove('hidden');
                document.body.classList.remove('login-view');
                showDashboard(user);
            } else {
                loginPage.classList.remove('hidden');
                document.body.classList.add('login-view');
            }

            // User Menu Logic
            document.addEventListener('click', function (event) {
                const menu = document.getElementById('user-menu-dropdown');
                const menuBtn = document.getElementById('user-menu-btn');
                if (menu && menuBtn) {
                    if (menuBtn.contains(event.target)) {
                        menu.classList.toggle('hidden');
                        menuBtn.classList.toggle('active');
                    } else if (!menu.contains(event.target)) {
                        menu.classList.add('hidden');
                        menuBtn.classList.remove('active');
                    }
                }
            });
        });

        // --- Login Logic ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const loginError = document.getElementById('login-error');
            loginError.textContent = '';
            
            // نمایش لودینگ تمام صفحه برای ورود حرفه‌ای
            showFullScreenLoader(true);
            
            const response = await callApi('login', {
                nationalId: document.getElementById('national-id').value,
                password: document.getElementById('password').value
            });
            
            showFullScreenLoader(false);

            if (response?.status === 'success') {
                storeUser(response.user);
                loginPage.classList.add('hidden');
                dashboardPage.classList.remove('hidden');
                document.body.classList.remove('login-view');
                showDashboard(response.user);
            } else {
                loginError.textContent = response?.isNetworkError ? 'خطا در ارتباط با سرور' : response?.message || 'اطلاعات ورود نادرست است.';
            }
        });

        function showFullScreenLoader(show) {
            const id = 'full-screen-loader';
            let loader = document.getElementById(id);
            if (show) {
                if (!loader) {
                    loader = document.createElement('div');
                    loader.id = id;
                    loader.className = 'editor-overlay'; // استفاده از استایل مشابه برای پوشش کامل
                    loader.style.zIndex = '9999';
                    loader.style.background = 'rgba(255,255,255,0.8)';
                    loader.style.backdropFilter = 'blur(5px)';
                    loader.style.alignItems = 'center';
                    loader.style.justifyContent = 'center';
                    loader.innerHTML = '<div class="content-loader"></div>';
                    document.body.appendChild(loader);
                }
            } else {
                if (loader) loader.remove();
            }
        }

        // --- Dashboard Logic ---
        function showDashboard(user) {
            // دستور سوم: نمایش نام در هدر
            document.getElementById('header-user-name').textContent = 'سلام، ' + user.name;
            
            document.getElementById('menu-user-name').textContent = user.name;
            document.getElementById('menu-user-nid').textContent = user.nationalId;
            document.getElementById('menu-user-score').textContent = user.score;
            
            document.getElementById('logout-btn').onclick = () => { localStorage.removeItem('currentUser'); window.location.reload(); };
            
            // دکمه رفرش
            document.getElementById('refresh-btn').onclick = () => { 
                const icon = document.getElementById('refresh-btn').querySelector('i');
                icon.classList.add('fa-spin');
                loadArticles(user.nationalId, false).then(() => icon.classList.remove('fa-spin'));
            };

            document.getElementById('add-new-article-btn').onclick = showNewArticleModal;

            // Tab Logic
            document.getElementById('article-tabs').addEventListener('click', (e) => {
                if (e.target.classList.contains('tab-item')) {
                    const filter = e.target.dataset.statusFilter;
                    if (filter === currentFilter) return;
                    currentFilter = filter;
                    document.querySelectorAll('.tab-item').forEach(tab => tab.classList.remove('active'));
                    e.target.classList.add('active');
                    renderArticles(); 
                }
            });

            // Initial Stats Skeleton (Pill Style)
            const summaryContainer = document.getElementById('summary-dashboard');
            summaryContainer.innerHTML = `
                <div class="summary-card progress"><div class="summary-info"><span class="count">...</span><span class="label">در حال پیگیری</span></div><div class="summary-icon"><i class="fas fa-clock"></i></div></div>
                <div class="summary-card accepted"><div class="summary-info"><span class="count">...</span><span class="label">پذیرفته شده</span></div><div class="summary-icon"><i class="fas fa-check-circle"></i></div></div>
                <div class="summary-card rejected"><div class="summary-info"><span class="count">...</span><span class="label">رد شده</span></div><div class="summary-icon"><i class="fas fa-times-circle"></i></div></div>
            `;
            
            let searchDebounce;
            document.getElementById('article-search-input').addEventListener('input', (e) => {
                clearTimeout(searchDebounce);
                searchDebounce = setTimeout(() => {
                    currentSearchTerm = e.target.value.trim();
                    loadArticles(user.nationalId, false);
                }, 500);
            });
            
            loadArticles(user.nationalId, false);
        }

        async function loadArticles(nationalId, isLoadMore = false) {
            if (isLoading) return;
            isLoading = true;

            const articlesContainer = document.getElementById('articles-container');
            const summaryContainer = document.getElementById('summary-dashboard');

            if (!isLoadMore) {
                currentPage = 1;
                allUserArticles = [];
                hasMoreArticles = true;
                articlesContainer.innerHTML = '<div class="content-loader-wrapper"><div class="content-loader"></div></div>';
            } else {
                const btn = document.querySelector('#load-more-container button');
                if (btn) btn.classList.add('btn-loading');
            }

            const response = await callApi('getArticles', {
                nationalId,
                searchTerm: currentSearchTerm,
                page: currentPage
            });

            if (!isLoadMore) articlesContainer.innerHTML = '';

            if (response?.status === 'success') {
                allUserArticles.push(...response.articles);
                hasMoreArticles = response.hasMore;
                currentPage++;
                
                // بروزرسانی آمار با استایل جدید
                updateSummaryDashboard(response.summary || allUserArticles);
                
                renderArticles();
                
                if (!isLoadMore && response.score) {
                    document.getElementById('menu-user-score').textContent = response.score;
                    const u = getStoredUser(); u.score = response.score; storeUser(u);
                }
            } else {
                if (!isLoadMore) articlesContainer.innerHTML = '<p style="text-align:center; color:var(--danger)">خطا در دریافت اطلاعات</p>';
                if (response.isNetworkError) showCustomAlert('خطا در ارتباط با سرور', 'error');
            }
            isLoading = false;
        }

        function updateSummaryDashboard(data) {
            const container = document.getElementById('summary-dashboard');
            let p, a, r;
            if (Array.isArray(data)) {
                p = data.filter(x => ![0, 5, 9, 10, '0', '5', '9', '10'].includes(x.articleStatus)).length;
                a = data.filter(x => String(x.articleStatus) === '5').length;
                r = data.filter(x => ['0', '10'].includes(String(x.articleStatus))).length;
            } else {
                p = data.inProgress; a = data.accepted; r = data.rejected;
            }
            container.innerHTML = `
                <div class="summary-card progress"><div class="summary-info"><span class="count">${p}</span><span class="label">در حال پیگیری</span></div><div class="summary-icon"><i class="fas fa-clock"></i></div></div>
                <div class="summary-card accepted"><div class="summary-info"><span class="count">${a}</span><span class="label">پذیرفته شده</span></div><div class="summary-icon"><i class="fas fa-check-circle"></i></div></div>
                <div class="summary-card rejected"><div class="summary-info"><span class="count">${r}</span><span class="label">رد شده</span></div><div class="summary-icon"><i class="fas fa-times-circle"></i></div></div>
            `;
        }

        // --- Render Articles (دستور پنجم: ظریف و زیبا) ---
        function renderArticles() {
            const container = document.getElementById('articles-container');
            const lmContainer = document.getElementById('load-more-container');
            container.innerHTML = ''; lmContainer.innerHTML = '';

            const drafts = allUserArticles.filter(a => String(a.articleStatus) === '9');
            const rejected = allUserArticles.filter(a => ['0', '10'].includes(String(a.articleStatus)));
            const accepted = allUserArticles.filter(a => String(a.articleStatus) === '5');
            const inProgress = allUserArticles.filter(a => !['0', '5', '9', '10'].includes(String(a.articleStatus)));

            let targetList = [];
            if (currentFilter === 'all') {
                if(drafts.length) renderGroup('پیش‌نویس‌ها', drafts, container);
                if(inProgress.length) renderGroup('در حال پیگیری', inProgress, container);
                if(accepted.length) renderGroup('پذیرفته شده', accepted, container);
                if(rejected.length) renderGroup('رد شده / نیازمند اصلاح', rejected, container);
                if(allUserArticles.length === 0) container.innerHTML = '<p style="text-align:center; padding:30px; color:#9CA3AF">مقاله‌ای یافت نشد.</p>';
            } else {
                if(currentFilter === 'drafts') targetList = drafts;
                if(currentFilter === 'inProgress') targetList = inProgress;
                if(currentFilter === 'accepted') targetList = accepted;
                if(currentFilter === 'rejected') targetList = rejected;
                
                if(targetList.length === 0) {
                    container.innerHTML = '<p style="text-align:center; padding:30px; color:#9CA3AF">موردی در این بخش وجود ندارد.</p>';
                } else {
                    targetList.forEach(a => container.appendChild(createArticleCard(a)));
                }
            }

            if (hasMoreArticles && currentFilter === 'all') {
                const btn = document.createElement('button');
                btn.className = 'btn-secondary';
                btn.innerHTML = '<span class="btn-text">بارگذاری بیشتر...</span>';
                btn.onclick = () => loadArticles(getStoredUser().nationalId, true);
                lmContainer.appendChild(btn);
            }
        }

        function renderGroup(title, list, container) {
            const h = document.createElement('h4'); h.className = 'article-group-title'; h.textContent = title;
            container.appendChild(h);
            list.forEach(a => container.appendChild(createArticleCard(a)));
        }

        function createArticleCard(article) {
            const card = document.createElement('div');
            card.className = 'article-card';
            card.dataset.id = article.articleId;

            // رنگ بردر سمت راست بر اساس وضعیت
            let borderColor = 'var(--info)';
            if (String(article.articleStatus) === '9') borderColor = '#9CA3AF'; // پیش نویس
            else if (String(article.articleStatus) === '5') borderColor = 'var(--success)'; // پذیرفته
            else if (['0', '10'].includes(String(article.articleStatus))) borderColor = 'var(--danger)'; // رد شده
            else if (['2'].includes(String(article.articleStatus))) borderColor = 'var(--warning)'; // نیازمند ویرایش

            card.style.borderRightColor = borderColor;

            const isDraft = String(article.articleStatus) === '9';
            const [statusText, statusColor] = getStatusInfo('article', article.articleStatus);
            
            // تعیین وضعیت استاد
            let supStatus = 'منتظر ارسال'; let supColor = '#6B7280';
            if(article.supervisorStatus == 5) { supStatus = article.supervisorName; supColor = '#10B981'; }
            else if(article.supervisorStatus == 1) { supStatus = 'بررسی توسط استاد'; supColor = '#F59E0B'; }
            else if(article.supervisorStatus == 0) { supStatus = 'عدم پذیرش استاد'; supColor = '#EF4444'; }

            // نوتیفیکیشن‌ها
            let notices = '';
            // 1. پیام رد یا اصلاح استاد/نشریه
            if ((['2', '10', '0'].includes(String(article.articleStatus))) && article.rejectionReason) {
                const type = ['0', '10'].includes(String(article.articleStatus)) ? 'danger' : 'warning';
                const title = String(article.articleStatus) === '2' ? 'پیام استاد:' : 'پیام نشریه:';
                notices += `<div class="notice-box ${type}"><i class="fas fa-exclamation-circle"></i><div><strong>${title}</strong> ${article.rejectionReason}</div></div>`;
            }
            // 2. انصراف استاد
            if (String(article.articleStatus) === '4') {
                notices += `<div class="notice-box warning"><i class="fas fa-user-slash"></i><div>استاد راهنما انصراف داده است. لطفاً استاد جدید انتخاب کنید.</div></div>`;
            }
             // 3. رد درخواست استاد
             if (String(article.supervisorStatus) === '0') {
                notices += `<div class="notice-box danger"><i class="fas fa-user-times"></i><div>استاد راهنما درخواست را نپذیرفت. لطفاً استاد دیگری انتخاب کنید.</div></div>`;
            }

            // دکمه‌ها
            const canEdit = isDraft || article.articleStatus == 4 || ['2', '10'].includes(String(article.articleStatus)) || (String(article.supervisorStatus) !== '5' && String(article.articleStatus) !== '0');
            const isReadOnly = [5, 6, 8, 11].includes(Number(article.articleStatus));
            const btnLabel = isDraft ? 'تکمیل پیش‌نویس' : (isReadOnly ? 'مشاهده کامل' : 'ویرایش مقاله');
            
            let actionButtons = '';
            
            // دکمه ارسال برای بررسی نهایی (فقط وقتی همه چیز تکمیل است و استاد تایید کرده)
            const isComplete = article.abstract && article.body; // چک ساده
            if (String(article.supervisorStatus) === '5' && String(article.articleStatus) !== '5' && !isReadOnly && isComplete) {
                actionButtons += `<button class="btn-success btn-send-final" onclick="event.stopPropagation(); handleSendForFinalReview('${article.articleId}', this)">ارسال نهایی</button>`;
            }
            
            // دکمه‌های خاص (PDF, بازنگری)
            if (String(article.articleStatus) === '5') actionButtons += `<button class="btn-info" onclick="event.stopPropagation(); generatePdf(allUserArticles.find(a=>a.articleId=='${article.articleId}'), this)"><i class="fas fa-file-pdf"></i> PDF</button>`;
            
            // دکمه اصلی (ویرایش/مشاهده) - ایونت در پایین ست می‌شود
            const mainActionBtn = `<button class="btn-primary btn-edit-action">${btnLabel}</button>`;
            
            // دکمه حذف
            const deleteBtn = (isDraft || String(article.supervisorStatus) !== '5') ? `<button class="btn-danger btn-icon" title="حذف" onclick="event.stopPropagation(); handleDeleteArticle('${article.articleId}')"><i class="fas fa-trash"></i></button>` : '';

            card.innerHTML = `
                <div class="article-header" onclick="this.parentElement.classList.toggle('expanded')">
                    <div style="flex:1">
                        <div class="article-title">${article.title}</div>
                        <div class="status-badges">
                            <span class="status-badge" style="background:${statusColor}">${statusText}</span>
                            ${!isDraft ? `<span class="status-badge" style="background:${supColor}; font-weight:400">${supStatus}</span>` : ''}
                        </div>
                    </div>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                ${notices}
                <div class="collapsible-details">
                    <div class="details-grid">
                        <div><strong>شناسه:</strong> <span>${article.articleId}</span></div>
                        <div><strong>تاریخ ثبت:</strong> <span>${new Date(article.requestDate).toLocaleDateString('fa-IR')}</span></div>
                        <div><strong>حیطه دانشی:</strong> <span>${article.knowledgeArea || '-'}</span></div>
                        <div><strong>استاد راهنما:</strong> <span>${article.supervisorName || '-'}</span></div>
                    </div>
                    <div class="article-actions">
                        ${actionButtons}
                        ${mainActionBtn}
                        <button class="btn-secondary btn-icon" title="تاریخچه" onclick="event.stopPropagation(); handleShowHistory('${article.articleId}', '${article.title}', this)"><i class="fas fa-history"></i></button>
                        ${deleteBtn}
                    </div>
                </div>
            `;

            // Bind Edit Action (دستور ششم: اتصال به ادیتور جدید)
            card.querySelector('.btn-edit-action').onclick = (e) => {
                e.stopPropagation();
                openSplitScreenEditor(article);
            };

            return card;
        }

        // --- دستور ششم: ویرایشگر تمام صفحه Split Screen ---
        
        let currentEditorArticle = null;
        
        function openSplitScreenEditor(article) {
            currentEditorArticle = article;
            const isReadOnly = [5, 6, 8, 11].includes(Number(article.articleStatus));
            
            // ایجاد ساختار HTML ادیتور به صورت پویا
            const overlay = document.createElement('div');
            overlay.className = 'editor-overlay';
            overlay.id = 'main-editor';
            
            overlay.innerHTML = `
                <div class="editor-header">
                    <div class="editor-title">
                        <i class="fas fa-edit" style="color:var(--primary)"></i>
                        <span>ویرایش مقاله: ${article.title.substring(0, 30)}...</span>
                        ${isReadOnly ? '<span class="status-badge" style="background:gray; margin-right:10px">فقط خواندنی</span>' : ''}
                    </div>
                    <button class="editor-close" onclick="closeEditor()"><i class="fas fa-times"></i></button>
                </div>
                <div class="editor-body">
                    <div class="editor-sidebar">
                        <div class="editor-nav-item active" onclick="switchSection('general', this)">
                            <span>اطلاعات کلی</span> <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="editor-nav-item" onclick="switchSection('abstract', this)">
                            <span>چکیده و کلیدواژه</span> <i class="nav-status-icon fas fa-circle ${article.abstract ? 'done' : 'warning'}"></i>
                        </div>
                        <div class="editor-nav-item" onclick="switchSection('intro', this)">
                            <span>مقدمه</span> <i class="nav-status-icon fas fa-circle ${article.introduction ? 'done' : 'warning'}"></i>
                        </div>
                        <div class="editor-nav-item" onclick="switchSection('body', this)">
                            <span>بدنه اصلی</span> <i class="nav-status-icon fas fa-circle ${article.body ? 'done' : 'warning'}"></i>
                        </div>
                        <div class="editor-nav-item" onclick="switchSection('conclusion', this)">
                            <span>نتیجه‌گیری</span> <i class="nav-status-icon fas fa-circle ${article.conclusion ? 'done' : 'warning'}"></i>
                        </div>
                        <div class="editor-nav-item" onclick="switchSection('refs', this)">
                            <span>منابع</span> <i class="fas fa-book"></i>
                        </div>
                    </div>
                    <div class="editor-content">
                        <div class="paper-sheet">
                            <!-- Section: General -->
                            <div id="sec-general" class="editor-section active">
                                <h2>اطلاعات کلی</h2>
                                <div class="form-group">
                                    <label>عنوان مقاله</label>
                                    <input type="text" id="ed-title" value="${article.title}" ${isReadOnly ? 'disabled' : ''}>
                                </div>
                                <div class="form-group">
                                    <label>وابستگی سازمانی (Affiliation)</label>
                                    <input type="text" id="ed-aff" value="${article.affiliation || ''}" ${isReadOnly ? 'disabled' : ''}>
                                </div>
                                <div class="form-group">
                                    <label>حیطه دانشی</label>
                                    <select id="ed-area" ${isReadOnly ? 'disabled' : ''}>${getKnowledgeAreaOptions(article.knowledgeArea)}</select>
                                </div>
                                <div class="form-group">
                                    <label>استاد راهنما</label>
                                    <div style="display:flex; gap:10px">
                                        <input type="text" id="ed-supervisor-name" value="${article.supervisorName || 'انتخاب نشده'}" disabled style="background:#f3f4f6">
                                        ${!isReadOnly ? `<button class="btn-info" onclick="showSupervisorModal('ed-supervisor-name', (s) => window.tempSup = s)">انتخاب</button>` : ''}
                                    </div>
                                </div>
                                ${!isReadOnly ? `<button class="btn-primary" onclick="saveGeneralInfo()">ذخیره اطلاعات کلی</button>` : ''}
                            </div>

                            <!-- Section: Abstract -->
                            <div id="sec-abstract" class="editor-section">
                                <h2>چکیده</h2>
                                <div class="form-group">
                                    <textarea id="ed-abstract" rows="10" ${isReadOnly ? 'disabled' : ''} oninput="checkWordCount(this, 'wc-abstract', 150, 300)">${article.abstract || ''}</textarea>
                                    <div class="word-count" id="wc-abstract">0 / 300 واژه (حداقل 150)</div>
                                </div>
                                <div class="form-group">
                                    <label>کلیدواژه‌ها (با کاما جدا کنید)</label>
                                    <input type="text" id="ed-keywords" value="${article.keywords || ''}" ${isReadOnly ? 'disabled' : ''}>
                                </div>
                                ${!isReadOnly ? `<button class="btn-primary" onclick="saveSection('keywords_abstract')">ذخیره چکیده</button>` : ''}
                            </div>

                            <!-- Section: Intro -->
                            <div id="sec-intro" class="editor-section">
                                <h2>مقدمه</h2>
                                <div class="form-group">
                                    <textarea id="ed-introduction" rows="15" ${isReadOnly ? 'disabled' : ''} oninput="checkWordCount(this, 'wc-intro', 350, 500)">${article.introduction || ''}</textarea>
                                    <div class="word-count" id="wc-intro">0 / 500 واژه (حداقل 350)</div>
                                </div>
                                ${!isReadOnly ? `<button class="btn-primary" onclick="saveSection('introduction')">ذخیره مقدمه</button>` : ''}
                            </div>

                            <!-- Section: Body -->
                            <div id="sec-body" class="editor-section">
                                <h2>بدنه اصلی</h2>
                                <div class="form-group">
                                    <textarea id="ed-body" rows="20" ${isReadOnly ? 'disabled' : ''} oninput="checkWordCount(this, 'wc-body', 700, 3000)">${article.body || ''}</textarea>
                                    <div class="word-count" id="wc-body">0 / 3000 واژه (حداقل 700)</div>
                                </div>
                                ${!isReadOnly ? `<button class="btn-primary" onclick="saveSection('body')">ذخیره بدنه</button>` : ''}
                            </div>

                            <!-- Section: Conclusion -->
                            <div id="sec-conclusion" class="editor-section">
                                <h2>نتیجه‌گیری</h2>
                                <div class="form-group">
                                    <textarea id="ed-conclusion" rows="10" ${isReadOnly ? 'disabled' : ''} oninput="checkWordCount(this, 'wc-concl', 100, 500)">${article.conclusion || ''}</textarea>
                                    <div class="word-count" id="wc-concl">0 / 500 واژه (حداقل 100)</div>
                                </div>
                                ${!isReadOnly ? `<button class="btn-primary" onclick="saveSection('conclusion')">ذخیره نتیجه‌گیری</button>` : ''}
                            </div>

                            <!-- Section: Refs -->
                            <div id="sec-refs" class="editor-section">
                                <h2>منابع</h2>
                                ${!isReadOnly ? `
                                <div style="background:#f9fafb; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #e5e7eb">
                                    <h5 style="margin:0 0 10px 0">افزودن منبع جدید</h5>
                                    <div class="form-group"><select id="ref-type-new"><option value="book">کتاب</option><option value="paper">مقاله</option></select></div>
                                    <div class="form-group"><input id="ref-text-new" placeholder="اطلاعات منبع را وارد کنید..."></div>
                                    <button class="btn-secondary" onclick="addRefToList()">افزودن</button>
                                </div>` : ''}
                                <div id="ref-list-display"></div>
                                <textarea id="ed-references-hidden" class="hidden">${article.references || ''}</textarea>
                                ${!isReadOnly ? `<button class="btn-primary" style="margin-top:20px" onclick="saveSection('references')">ذخیره منابع</button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Initial Word Counts logic
            setTimeout(() => {
                checkWordCount(document.getElementById('ed-abstract'), 'wc-abstract', 150, 300);
                checkWordCount(document.getElementById('ed-introduction'), 'wc-intro', 350, 500);
                checkWordCount(document.getElementById('ed-body'), 'wc-body', 700, 3000);
                checkWordCount(document.getElementById('ed-conclusion'), 'wc-concl', 100, 500);
                renderRefList();
            }, 100);
        }

        window.closeEditor = function() {
            document.getElementById('main-editor').remove();
            currentEditorArticle = null;
            window.tempSup = null;
            loadArticles(getStoredUser().nationalId, false); // رفرش لیست برای اعمال تغییرات
        }

        window.switchSection = function(secName, navItem) {
            document.querySelectorAll('.editor-section').forEach(el => el.classList.remove('active'));
            document.getElementById('sec-' + secName).classList.add('active');
            
            document.querySelectorAll('.editor-nav-item').forEach(el => el.classList.remove('active'));
            navItem.classList.add('active');
        }

        window.checkWordCount = function(el, counterId, min, max) {
            if(!el) return;
            const count = el.value.trim().split(/\s+/).filter(Boolean).length;
            const counter = document.getElementById(counterId);
            counter.textContent = `${count} / ${max} واژه (حداقل ${min})`;
            counter.className = (count < min || count > max) ? 'word-count invalid' : 'word-count';
        }

        // Logic for saving sections in new editor
        window.saveGeneralInfo = async function() {
            const btn = event.target;
            const details = {
                title: document.getElementById('ed-title').value,
                affiliation: document.getElementById('ed-aff').value,
                knowledgeArea: document.getElementById('ed-area').value,
                topicReason: currentEditorArticle.topicReason // نگه داشتن مقدار قبلی چون در این فرم نیست
            };
            if(window.tempSup) details.supervisor = window.tempSup;

            const res = await callApi('updateArticleDetails', { 
                nationalId: getStoredUser().nationalId, 
                articleId: currentEditorArticle.articleId, 
                details 
            }, btn);
            
            if (res?.status === 'success') showCustomAlert('اطلاعات ذخیره شد', 'success');
            else showCustomAlert('خطا در ذخیره', 'error');
        }

        window.saveSection = async function(section) {
            const btn = event.target;
            let content;
            if (section === 'keywords_abstract') {
                content = { 
                    abstract: document.getElementById('ed-abstract').value, 
                    keywords: document.getElementById('ed-keywords').value 
                };
            } else if (section === 'references') {
                content = document.getElementById('ed-references-hidden').value;
            } else {
                content = document.getElementById('ed-' + section).value;
            }

            const res = await callApi('updateArticleSection', { 
                nationalId: getStoredUser().nationalId, 
                articleId: currentEditorArticle.articleId, 
                section, content 
            }, btn);

            if (res?.status === 'success') {
                showCustomAlert('ذخیره شد', 'success');
                // Update local obj
                if(section === 'keywords_abstract') { currentEditorArticle.abstract = content.abstract; }
                else if(section === 'references') { currentEditorArticle.references = content; }
                else { currentEditorArticle[section] = content; }
            } else {
                showCustomAlert('خطا در ذخیره', 'error');
            }
        }

        // Ref Logic for Editor
        window.addRefToList = function() {
            const val = document.getElementById('ref-text-new').value;
            if(!val) return;
            const hidden = document.getElementById('ed-references-hidden');
            hidden.value = (hidden.value ? hidden.value + '\n' : '') + val;
            document.getElementById('ref-text-new').value = '';
            renderRefList();
        }
        window.renderRefList = function() {
            const hidden = document.getElementById('ed-references-hidden');
            const display = document.getElementById('ref-list-display');
            display.innerHTML = '';
            if(!hidden.value) return;
            hidden.value.split('\n').filter(Boolean).forEach((ref, idx) => {
                const div = document.createElement('div');
                div.className = 'ref-item';
                div.innerHTML = `<span>${ref}</span><button onclick="removeRef(${idx})"><i class="fas fa-trash"></i></button>`;
                display.appendChild(div);
            });
        }
        window.removeRef = function(idx) {
            const hidden = document.getElementById('ed-references-hidden');
            const arr = hidden.value.split('\n').filter(Boolean);
            arr.splice(idx, 1);
            hidden.value = arr.join('\n');
            renderRefList();
        }


        // --- Other Modal & Helpers ---

        function showNewArticleModal() {
            // استفاده از همان مودال قبلی اما استایل تمیزتر
            window.selectedSupervisor = null;
            const content = `
                <div class="modal-body">
                    <div style="padding:10px">
                        <h4 style="border-bottom:2px solid var(--primary); padding-bottom:10px; margin-bottom:20px">ثبت مقاله جدید</h4>
                        <div class="form-group"><label>عنوان مقاله</label><input id="new-title" required></div>
                        <div class="form-group"><label>حیطه دانشی</label><select id="new-area">${getKnowledgeAreaOptions()}</select></div>
                        <div class="form-group"><label>وابستگی سازمانی (Affiliation)</label><input id="new-aff" placeholder="مثال: سطح 3 حوزه..." required></div>
                        <div class="form-group"><label>دلیل انتخاب موضوع</label><textarea id="new-reason" rows="4"></textarea></div>
                        <div class="form-group">
                            <label>استاد راهنما (اختیاری برای پیش‌نویس)</label>
                            <button class="btn-secondary" style="width:100%" onclick="showSupervisorModal('new-sup-display', (s)=> window.selectedSupervisor=s)">جستجوی استاد</button>
                            <div id="new-sup-display" style="margin-top:5px; color:var(--primary); font-weight:bold"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="handleNewArticleSubmit(event, true)">ذخیره پیش‌نویس</button>
                    <button class="btn-success" onclick="handleNewArticleSubmit(event, false)">ثبت نهایی</button>
                </div>
            `;
            renderModal('', content, 'modal-sm'); // تایتل خالی چون داخل content گذاشتیم
        }

        async function handleNewArticleSubmit(e, isDraft) {
            if (!isDraft && !window.selectedSupervisor) return showCustomAlert('برای ثبت نهایی استاد الزامی است', 'error');
            const user = getStoredUser();
            const data = {
                researcherName: user.name, researcherId: user.nationalId,
                title: document.getElementById('new-title').value,
                affiliation: document.getElementById('new-aff').value,
                knowledgeArea: document.getElementById('new-area').value,
                topicReason: document.getElementById('new-reason').value,
                supervisor: isDraft ? null : window.selectedSupervisor
            };
            const res = await callApi('submitNewArticle', { data, isDraft }, e.target);
            if(res?.status === 'success') {
                closeAllModals();
                showCustomAlert(res.message, 'success');
                loadArticles(user.nationalId, false);
            } else {
                showCustomAlert(res?.message || 'خطا', 'error');
            }
        }

        function showSupervisorModal(targetId, cb) {
            const content = `
                <div class="modal-body">
                    <div class="search-field-wrapper" style="margin-bottom:15px">
                        <input id="sup-search" placeholder="نام استاد..." oninput="searchSupervisor(this.value)">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    <div id="sup-list" class="supervisor-list"></div>
                </div>`;
            renderModal('انتخاب استاد', content, 'modal-sm', true);
            searchSupervisor(''); // load initial
            window.selectSup = function(id, name) {
                cb({ nationalId: id, name: name });
                if(targetId && document.getElementById(targetId)) document.getElementById(targetId).textContent = name;
                if(targetId && document.getElementById(targetId).tagName === 'INPUT') document.getElementById(targetId).value = name;
                closeModalById('sub-modal');
            }
        }

        async function searchSupervisor(term) {
            const container = document.getElementById('sup-list');
            container.innerHTML = '<div class="content-loader-wrapper"><div class="status-loader"></div></div>';
            const res = await callApi('getSupervisors', { searchTerm: term, page: 1 });
            container.innerHTML = '';
            if(res?.status === 'success') {
                res.supervisors.forEach(s => {
                    const div = document.createElement('div');
                    div.className = `supervisor-list-item ${(!s.isActive || s.isFull) ? 'disabled' : ''}`;
                    div.innerHTML = `<div><strong>${s.name}</strong></div>`;
                    if(s.isActive && !s.isFull) div.onclick = () => window.selectSup(s.nationalId, s.name);
                    container.appendChild(div);
                });
            }
        }

        async function handleDeleteArticle(id) {
            showCustomConfirm('آیا مطمئن هستید؟', async (yes, btn, close) => {
                if(yes) {
                    const res = await callApi('deleteArticle', { articleId: id, nationalId: getStoredUser().nationalId });
                    close();
                    if(res?.status === 'success') { showCustomAlert('حذف شد', 'success'); loadArticles(getStoredUser().nationalId, false); }
                } else close();
            });
        }

        async function handleSendForFinalReview(id, btn) {
            showCustomConfirm('ارسال برای بررسی نهایی؟ دیگر قابل ویرایش نخواهد بود.', async (yes, b, c) => {
                if(yes) {
                    const res = await callApi('sendForFinalReview', { articleId: id, nationalId: getStoredUser().nationalId }, btn);
                    c();
                    if(res?.status === 'success') { showCustomAlert('ارسال شد', 'success'); loadArticles(getStoredUser().nationalId, false); }
                } else c();
            });
        }
        
        async function handleShowHistory(id, title, btn) {
            renderModal('تاریخچه: ' + title, '<div id="hist-content" class="modal-body"></div>', 'modal-sm');
            const res = await callApi('getArticleHistory', { nationalId: getStoredUser().nationalId, articleId: id }, btn);
            const div = document.getElementById('hist-content');
            if(res?.status === 'success') {
                div.innerHTML = `<ul class="history-timeline" style="list-style:none; padding:0">${res.history.map(h => 
                    `<li class="timeline-item" style="border-right:2px solid #ddd; padding-right:15px; margin-bottom:15px; position:relative">
                        <div style="font-weight:bold">${h.action}</div>
                        <small style="color:gray">${new Date(h.timestamp).toLocaleString('fa-IR')}</small>
                        <div>${h.details || ''}</div>
                    </li>`
                ).join('')}</ul>`;
            } else div.innerHTML = 'خطا در دریافت تاریخچه';
        }

        async function generatePdf(article, btn) {
            showCustomAlert('در حال تولید PDF...', 'info');
            const res = await callApi('generateArticlePdf', { nationalId: getStoredUser().nationalId, articleId: article.articleId }, btn);
            closeAllModals();
            if(res?.status === 'success') {
                 const link = document.createElement('a');
                 link.href = 'data:application/pdf;base64,' + res.data.content;
                 link.download = res.data.filename;
                 link.click();
            } else showCustomAlert('خطا در تولید PDF', 'error');
        }

        // --- Shared UI Helpers ---
        function renderModal(title, content, size, isSub = false) {
            const id = isSub ? 'sub-modal' : 'main-modal';
            const old = document.getElementById(id); if(old) old.remove();
            const wrapper = document.createElement('div');
            wrapper.id = id; wrapper.className = 'modal-overlay';
            wrapper.innerHTML = `
                <div class="modal-box ${size}">
                    <div class="modal-header"><h3>${title}</h3><button class="modal-close-btn" onclick="closeModalById('${id}')"><i class="fas fa-times"></i></button></div>
                    ${content}
                </div>`;
            modalContainer.appendChild(wrapper);
            setTimeout(() => wrapper.classList.add('visible'), 10);
        }
        function closeModalById(id) { document.getElementById(id)?.remove(); }
        function closeAllModals() { modalContainer.innerHTML = ''; }
        
        function showCustomAlert(msg, type) {
            const div = document.createElement('div');
            div.className = 'modal-overlay visible';
            div.style.zIndex = '5000';
            let icon = 'info-circle';
            if(type === 'success') icon = 'check-circle';
            if(type === 'error') icon = 'times-circle';
            
            div.innerHTML = `
                <div class="modal-box custom-alert-box">
                    <i class="fas fa-${icon} custom-alert-icon ${type}"></i>
                    <p class="custom-alert-message">${msg}</p>
                    <div class="custom-alert-actions"><button class="btn-primary" onclick="this.closest('.modal-overlay').remove()">باشه</button></div>
                </div>`;
            document.body.appendChild(div);
        }

        function showCustomConfirm(msg, cb) {
            const div = document.createElement('div');
            div.className = 'modal-overlay visible';
            div.style.zIndex = '5000';
            div.innerHTML = `
                <div class="modal-box custom-alert-box">
                    <i class="fas fa-question-circle custom-alert-icon confirm"></i>
                    <p class="custom-alert-message">${msg}</p>
                    <div class="custom-alert-actions">
                        <button class="btn-primary" id="confirm-yes">بله</button>
                        <button class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">خیر</button>
                    </div>
                </div>`;
            document.body.appendChild(div);
            document.getElementById('confirm-yes').onclick = function() { cb(true, this, () => div.remove()); };
        }

        function getKnowledgeAreaOptions(sel) {
            const opts = ["فقه", "اصول", "اخلاق", "کلام", "تفسیر", "ترجمه", "فلسفه", "عرفان", "حدیث", "رجال", "درایه", "نقدالحدیث", "صرف", "نحو", "بلاغت", "مشاوره", "تربیتی", "روانشناسی"];
            return opts.map(o => `<option value="${o}" ${sel === o ? 'selected' : ''}>${o}</option>`).join('');
        }
        
        function getStatusInfo(type, code) {
            const map = { '0': ['رد شده', '#EF4444'], '1': ['بررسی استاد', '#3B82F6'], '2': ['نیازمند ویرایش', '#F59E0B'], '4': ['انصراف استاد', '#F59E0B'], '5': ['پذیرفته شده', '#10B981'], '6': ['منتظر بررسی نهایی', '#3B82F6'], '9': ['پیش‌نویس', '#6B7280'], '10': ['اصلاح نهایی', '#EF4444'] };
            return map[String(code)] || ['نامشخص', 'gray'];
        }
    </script>
</body>
</html>
