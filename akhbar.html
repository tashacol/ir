<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>آخرین اخبار</title>
  <style>
    /* تنظیمات عمومی */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Tahoma', sans-serif;
      background: linear-gradient(135deg, #74ABE2, #5563DE);
    }
    /* استایل پنجره پاپ‌آپ چت */
    #popupModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.5s ease;
    }
    #popupContent {
      background: #fff;
      width: 90%;
      max-width: 600px;
      height: 80vh;
      border-radius: 10px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transform: translateY(-20px);
      animation: slideDown 0.5s ease forwards;
    }
    /* هدر پنجره چت */
    #popupHeader {
      background: linear-gradient(90deg, #5563DE, #74ABE2);
      padding: 15px;
      color: #fff;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    /* بدنه چت – دارای پس‌زمینه مدرن */
    #popupBody {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: url('https://www.transparenttextures.com/patterns/black-linen.png');
      position: relative;
    }
    /* فوتر */
    #popupFooter {
      padding: 10px;
      background: #eee;
      text-align: center;
    }
    #closeBtn {
      background: #dc3545;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 8px 16px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    #closeBtn:hover {
      background: #c82333;
    }
    /* استایل پیام‌های چت */
    .chat-message {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 15px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      animation: fadeInUp 0.5s ease;
    }
    /* قاب تصاویر با مرز رنگی (استوری مانند) */
    .story-border {
      display: inline-block;
      padding: 3px;
      border-radius: 50%;
      background: conic-gradient(from 0deg, #feda75, #d62976, #4f5bd5, #feda75);
      cursor: pointer;
    }
    /* اگر استوری مشاهده شده باشد، مرز به خاکستری تغییر کند */
    .story-border.viewed {
      background: #ccc;
    }
    .story-border img {
      display: block;
      border-radius: 50%;
      width: 60px;
      height: 60px;
    }
    .chat-message h3 {
      margin: 10px 0 5px;
      font-size: 18px;
      font-weight: bold;
      color: #333;
      text-align: center;
    }
    .chat-message p {
      margin: 0;
      font-size: 14px;
      color: #666;
      text-align: center;
      margin-bottom: 10px;
    }
    .chat-message .more-btn {
      align-self: center;
      background: #74ABE2;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .chat-message .more-btn:hover {
      background: #5a8bb5;
    }
    /* انیمیشن‌ها */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideDown {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    /* اسپینر لودینگ */
    #loadingSpinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #5563DE;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1100;
    }
    @keyframes spin {
      0% { transform: rotate(0deg) translate(-50%, -50%); }
      100% { transform: rotate(360deg) translate(-50%, -50%); }
    }
    /* استایل مدال استوری */
    #storyModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1200;
    }
    #storyContent {
      position: relative;
      max-width: 90%;
      max-height: 90%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #storyImage {
      max-width: 100%;
      max-height: 80vh;
      object-fit: contain;
      cursor: pointer;
    }
    #storyText {
      color: #fff;
      text-align: center;
      margin-top: 10px;
      font-family: sans-serif;
      padding: 0 10px;
    }
    #storyText h3 {
      margin: 0;
      font-size: 24px;
      font-weight: bold;
    }
    #storyText p {
      margin: 5px 0;
      font-size: 16px;
      line-height: 1.4;
    }
    /* لینک ادامه برای توضیحات طولانی */
    #readMore {
      color: #74ABE2;
      cursor: pointer;
      font-size: 16px;
      display: inline-block;
      margin-top: 5px;
    }
  </style>
</head>
<body>

  <!-- پنجره پاپ‌آپ چت -->
  <div id="popupModal">
    <div id="popupContent">
      <div id="popupHeader">آخرین اخبار</div>
      <div id="popupBody">
        <!-- اسپینر لودینگ قبل از بارگذاری اخبار -->
        <div id="loadingSpinner"></div>
        <!-- پیام‌های چت به‌صورت داینامیک اینجا قرار می‌گیرند -->
      </div>
      <div id="popupFooter">
        <button id="closeBtn">بستن پنجره</button>
      </div>
    </div>
  </div>

  <!-- مدال استوری (نمایش تصویر با کیفیت اصلی همراه عنوان و توضیحات) -->
  <div id="storyModal">
    <div id="storyContent">
      <img id="storyImage" src="" alt="">
      <div id="storyText">
        <h3 id="storyTitle"></h3>
        <p id="storyDescription"></p>
        <span id="readMore" style="display: none;">ادامه</span>
      </div>
    </div>
  </div>

  <!-- کتابخانه SheetJS جهت خواندن فایل اکسل -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // لینک مستقیم فایل اکسل
    const excelUrl = 'https://docs.google.com/spreadsheets/d/1il6IPfhfVjw8YJKD1_VkZOxGS0eqmgvO3Z8nfP-1MwA/export?format=xlsx';
    
    // آرایه برای ذخیره داده‌های استوری (اخبار)
    let stories = [];
    // اندیس استوری فعلی در مدال
    let currentStoryIndex = 0;
    let storyTimer = null;

    /**
     * دریافت و پردازش داده‌های اکسل
     */
    async function fetchExcelData() {
      try {
        const response = await fetch(excelUrl);
        if (!response.ok) {
          throw new Error('خطا در دریافت فایل اکسل');
        }
        const arrayBuffer = await response.arrayBuffer();
        const data = new Uint8Array(arrayBuffer);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        // تبدیل شیت به آرایه‌ای دوبعدی
        const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        // فیلتر ردیف‌هایی که حداقل ستون‌های A (عنوان)، B (توضیح) و C (لینک تصویری) را دارند
        const filteredRows = rows.filter(row => row && row.length >= 3 && row[0] && row[1] && row[2]);
        // انتخاب 10 ردیف آخر (در صورت وجود بیشتر)
        let lastTen = filteredRows;
        if (filteredRows.length > 10) {
          lastTen = filteredRows.slice(-10);
        }
        // معکوس آرایه تا پایین‌ترین ردیف (آخرین خبر) در ابتدا نمایش داده شود
        lastTen.reverse();
        return lastTen;
      } catch (error) {
        console.error('Error fetching Excel data:', error);
        return [];
      }
    }

    /**
     * ایجاد المان پیام چت از داده‌های هر ردیف
     * ستون‌ها:
     *   A: عنوان
     *   B: توضیح
     *   C: لینک تصویری
     *   D: لینک توضیحات بیشتر (اختیاری)
     */
    function createChatMessage(row, index) {
      const [title, description, imageUrl, moreLink] = row;
      // ذخیره داده‌ها در آرایه stories
      stories.push({ title, description, imageUrl, moreLink });

      const messageDiv = document.createElement('div');
      messageDiv.className = 'chat-message';

      // ایجاد قاب تصویر با مرز رنگی (استوری مانند)
      const borderDiv = document.createElement('div');
      borderDiv.className = 'story-border';
      // ذخیره اندیس استوری مربوطه در data attribute
      borderDiv.setAttribute('data-story-index', stories.length - 1);
      const img = document.createElement('img');
      // در پیام، تصویر با ابعاد کوچک نمایش داده می‌شود؛ در استوری، از همین لینک (کیفیت اصلی) استفاده می‌شود
      img.src = imageUrl;
      img.alt = title;
      borderDiv.appendChild(img);
      // رویداد کلیک برای باز کردن مدال استوری
      borderDiv.addEventListener('click', function(e) {
        const idx = parseInt(this.getAttribute('data-story-index'));
        openStoryModal(idx);
        e.stopPropagation();
      });
      messageDiv.appendChild(borderDiv);

      // عنوان پیام (به صورت بولد)
      const titleElem = document.createElement('h3');
      titleElem.textContent = title;
      messageDiv.appendChild(titleElem);

      // توضیحات پیام (متن کوچکتر)
      const descElem = document.createElement('p');
      descElem.textContent = description;
      messageDiv.appendChild(descElem);

      // دکمه «توضیحات بیشتر» در صورت وجود لینک در ستون D
      if (moreLink && moreLink.toString().trim() !== '') {
        const moreBtn = document.createElement('button');
        moreBtn.className = 'more-btn';
        moreBtn.textContent = 'توضیحات بیشتر';
        moreBtn.onclick = () => {
          window.open(moreLink, '_blank');
        };
        messageDiv.appendChild(moreBtn);
      }
      return messageDiv;
    }

    /**
     * راه‌اندازی و نمایش پیام‌های چت در پنجره پاپ‌آپ
     */
    async function initializeChat() {
      const data = await fetchExcelData();
      const chatBody = document.getElementById('popupBody');
      // حذف اسپینر لودینگ پس از دریافت داده‌ها
      const spinner = document.getElementById('loadingSpinner');
      if (spinner) {
        spinner.style.display = 'none';
      }
      if (data.length === 0) {
        chatBody.innerHTML = '<p style="text-align:center;color:#999;">هیچ اخباری موجود نیست.</p>';
        return;
      }
      // ایجاد پیام‌ها به صورت داینامیک
      data.forEach((row, index) => {
        const messageElem = createChatMessage(row, index);
        chatBody.appendChild(messageElem);
      });
    }

    // مدیریت localStorage برای ذخیره وضعیت استوری‌های مشاهده شده
    function markStoryViewed(imageUrl) {
      let viewed = JSON.parse(localStorage.getItem('viewedStories')) || [];
      if (!viewed.includes(imageUrl)) {
        viewed.push(imageUrl);
        localStorage.setItem('viewedStories', JSON.stringify(viewed));
      }
    }
    function isStoryViewed(imageUrl) {
      let viewed = JSON.parse(localStorage.getItem('viewedStories')) || [];
      return viewed.includes(imageUrl);
    }

    /**
     * باز کردن مدال استوری با اندیس مشخص
     */
    function openStoryModal(index) {
      currentStoryIndex = index;
      showStory(currentStoryIndex);
      document.getElementById('storyModal').style.display = 'flex';
    }

    /**
     * بستن مدال استوری
     */
    function closeStoryModal() {
      clearTimeout(storyTimer);
      document.getElementById('storyModal').style.display = 'none';
    }

    /**
     * نمایش استوری با اندیس داده شده
     */
    function showStory(index) {
      clearTimeout(storyTimer);
      const story = stories[index];
      if (!story) {
        closeStoryModal();
        return;
      }
      const storyImage = document.getElementById('storyImage');
      const storyTitle = document.getElementById('storyTitle');
      const storyDescription = document.getElementById('storyDescription');
      const readMore = document.getElementById('readMore');
      
      storyImage.src = story.imageUrl; // نمایش تصویر با کیفیت اصلی در استوری
      storyTitle.textContent = story.title;
      
      // اگر توضیحات طولانی است، تنها بخشی نمایش داده شود همراه با لینک «ادامه»
      const maxChars = 100;
      if (story.description.length > maxChars) {
        const shortText = story.description.substring(0, maxChars) + '...';
        storyDescription.textContent = shortText;
        readMore.style.display = 'inline-block';
        readMore.onclick = function(e) {
          storyDescription.textContent = story.description;
          readMore.style.display = 'none';
          e.stopPropagation();
        };
      } else {
        storyDescription.textContent = story.description;
        readMore.style.display = 'none';
      }
      
      // علامت‌گذاری استوری به عنوان مشاهده شده و به‌روزرسانی مرز تصویر در پیام چت
      markStoryViewed(story.imageUrl);
      updateChatMessageBorder(story.imageUrl);
      
      // تنظیم تایمر برای تغییر خودکار به استوری بعدی (مثلاً 5 ثانیه)
      storyTimer = setTimeout(() => {
        nextStory();
      }, 5000);
    }

    /**
     * رفتن به استوری بعدی
     */
    function nextStory() {
      currentStoryIndex++;
      if (currentStoryIndex >= stories.length) {
        closeStoryModal();
      } else {
        showStory(currentStoryIndex);
      }
    }

    /**
     * رفتن به استوری قبلی
     */
    function prevStory() {
      currentStoryIndex--;
      if (currentStoryIndex < 0) {
        currentStoryIndex = 0;
      }
      showStory(currentStoryIndex);
    }

    /**
     * به‌روزرسانی مرز تصاویر در پیام‌های چت؛ اگر استوری مشاهده شده باشد، مرز به رنگ خاکستری تغییر می‌کند
     */
    function updateChatMessageBorder(imageUrl) {
      const borders = document.querySelectorAll('.story-border');
      borders.forEach(border => {
        const idx = border.getAttribute('data-story-index');
        if (stories[idx] && stories[idx].imageUrl === imageUrl) {
          border.classList.add('viewed');
        }
      });
    }

    /* 
      رویدادهای مربوط به مدال استوری:
      – کلیک روی ناحیه‌ی محتوا (storyContent) جهت پیمایش دستی: 
         در صورت کلیک در نیمه سمت چپ، به استوری قبلی و در نیمه سمت راست، به استوری بعدی می‌رود.
      – کلیک روی پس‌زمینه مدال (خارج از محتوا) مدال بسته می‌شود.
    */
    document.getElementById('storyContent').addEventListener('click', function(e) {
      e.stopPropagation();
      const rect = this.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      if (clickX < rect.width / 2) {
        prevStory();
      } else {
        nextStory();
      }
    });
    document.getElementById('storyModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeStoryModal();
      }
    });

    // رویداد بستن پنجره چت
    document.getElementById('closeBtn').addEventListener('click', function() {
      document.getElementById('popupModal').style.display = 'none';
    });

    // راه‌اندازی پیام‌های چت پس از بارگذاری صفحه
    window.addEventListener('load', function() {
      initializeChat();
    });
  </script>
</body>
</html>
